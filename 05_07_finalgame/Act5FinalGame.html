<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 60-Year Journey</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --white: #f7f8fa;
            --light-grey: #d0d9e0;
            --mid-grey: #9babc2;
            --slate: #4a5d6b;
            --dark-slate: #364451;
            --deep-navy: #1f2937;
            --green: #92d050;
            --blue: #00b0f0;
            --orange: #cc5500;
            --red: #dc2626;
            --amber: #f59e0b;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--deep-navy);
            color: var(--light-grey);
        }
        
        /* ============================================
           CINEMATIC INTRO
           ============================================ */
        #cinematicIntro {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #000;
        }
        
        #cinematicIntro.hidden { display: none; }
        
        .intro-slide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        
        .intro-slide.active { opacity: 1; }
        
        .intro-slide .bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: brightness(0.35);
        }
        
        .intro-slide .bg.dark {
            background: linear-gradient(135deg, #0a1628, #1a2a3a, #0d1a2d);
            filter: none;
        }
        
        .intro-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 700px;
            padding: 40px;
        }
        
        .intro-logo img { max-width: 250px; margin-bottom: 30px; }
        .intro-company { color: var(--blue); text-transform: uppercase; letter-spacing: 4px; margin-bottom: 20px; }
        .intro-title { font-size: 3rem; color: var(--white); margin-bottom: 20px; }
        .intro-subtitle { font-size: 1.2rem; color: var(--light-grey); }
        
        .intro-text-box {
            background: rgba(31, 41, 55, 0.9);
            border-left: 4px solid var(--blue);
            padding: 30px;
            text-align: left;
            border-radius: 8px;
        }
        
        .intro-text-box p { margin-bottom: 15px; font-size: 1.1rem; line-height: 1.7; }
        .intro-text-box p:last-child { margin-bottom: 0; }
        .intro-text-box strong { color: var(--white); }
        .intro-text-box .highlight { color: var(--green); }
        
        .intro-year { font-size: 4rem; color: var(--blue); margin-bottom: 20px; }
        .intro-location { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        
        .intro-budget {
            display: inline-block;
            background: var(--green);
            color: var(--deep-navy);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 20px;
        }
        
        .intro-nav {
            position: absolute;
            bottom: 40px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }
        
        .intro-nav button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .intro-nav .btn-skip { background: transparent; color: var(--mid-grey); border: 1px solid var(--slate); }
        .intro-nav .btn-next { background: var(--blue); color: var(--deep-navy); }
        
        .intro-dots {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .intro-dot {
            width: 40px;
            height: 4px;
            background: var(--slate);
            border-radius: 2px;
            cursor: pointer;
        }
        
        .intro-dot.active { background: var(--blue); }
        .intro-dot.done { background: var(--green); }
        
        /* ============================================
           GAME LAYOUT
           ============================================ */
        #gameScreen {
            display: none;
            position: fixed;
            inset: 0;
            flex-direction: column;
        }
        
        #gameScreen.active { display: flex; }
        
        .top-bar {
            height: 60px;
            background: var(--deep-navy);
            border-bottom: 1px solid var(--dark-slate);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
        }
        
        .top-bar-logo img { height: 36px; }
        
        .top-bar-phase {
            background: var(--dark-slate);
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .top-bar-phase .year { color: var(--blue); }
        
        .top-bar-right { display: flex; align-items: center; gap: 15px; }
        
        .top-bar-stats { display: flex; gap: 20px; font-size: 0.9rem; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .stat-value { color: var(--white); font-weight: 600; }
        .stat-value.warning { color: var(--amber); }
        .stat-value.danger { color: var(--red); }
        
        .btn-next-stage {
            display: none;
            padding: 10px 20px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        .btn-next-stage.visible { display: block; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(146, 208, 80, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(146, 208, 80, 0); }
        }
        
        .progress-bar {
            height: 6px;
            background: var(--dark-slate);
            flex-shrink: 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue), var(--green));
            transition: width 0.5s ease;
        }
        
        .character-banner {
            display: none;
            align-items: center;
            gap: 15px;
            background: var(--dark-slate);
            padding: 12px 20px;
            border-left: 4px solid var(--orange);
            flex-shrink: 0;
        }
        
        .character-banner.visible { display: flex; }
        .character-banner.dave { border-color: var(--orange); }
        .character-banner.sarah { border-color: var(--blue); }
        .character-banner.mike { border-color: var(--green); }
        .character-banner.janet { border-color: var(--mid-grey); }
        
        .char-portrait {
            width: 50px; height: 50px;
            border-radius: 8px;
            background: var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; }
        .char-info h4 { color: var(--white); margin-bottom: 2px; }
        .char-role { font-size: 0.85rem; color: var(--mid-grey); }
        
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #1a1a2e;
        }
        
        .map-wrapper { position: relative; max-width: 100%; max-height: 100%; }
        
        .map-wrapper img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 180px);
            object-fit: contain;
        }
        
        .hotspot {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        
        .hotspot-dot {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: rgba(0, 176, 240, 0.3);
            border: 3px solid var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            animation: hotspotPulse 2s infinite;
        }
        
        .hotspot:hover .hotspot-dot {
            transform: scale(1.15);
            background: rgba(0, 176, 240, 0.5);
        }
        
        .hotspot-dot.done {
            background: rgba(146, 208, 80, 0.3);
            border-color: var(--green);
            animation: none;
        }
        
        .hotspot-dot.done::after {
            content: '‚úì';
            color: var(--green);
            font-weight: bold;
        }
        
        .hotspot-dot.warning {
            background: rgba(245, 158, 11, 0.3);
            border-color: var(--amber);
            animation: none;
        }
        
        .hotspot-dot.warning::after {
            content: '‚ö†';
            color: var(--amber);
        }
        
        .hotspot-dot.issue {
            background: rgba(220, 38, 38, 0.3);
            border-color: var(--red);
            animation: none;
        }
        
        .hotspot-dot.issue::after {
            content: '!';
            color: var(--red);
            font-weight: bold;
        }
        
        .hotspot-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .hotspot:hover .hotspot-label { opacity: 1; }
        
        @keyframes hotspotPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0); }
        }
        
        .bottom-bar {
            height: 50px;
            background: var(--deep-navy);
            border-top: 1px solid var(--dark-slate);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-shrink: 0;
        }
        
        .progress-dots { display: flex; gap: 8px; }
        
        .progress-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: var(--slate);
        }
        
        .progress-dot.done { background: var(--green); }
        .progress-dot.current { background: var(--blue); box-shadow: 0 0 0 3px rgba(0, 176, 240, 0.3); }
        
        .progress-label { color: var(--mid-grey); font-size: 0.9rem; }
        
        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--dark-slate);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--slate);
        }
        
        .modal-header h3 { color: var(--white); }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--mid-grey);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body { padding: 20px; }
        
        /* Situation description */
        .situation-box {
            background: var(--slate);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--blue);
        }
        
        .situation-box.warning { border-left-color: var(--amber); }
        .situation-box.danger { border-left-color: var(--red); }
        
        .situation-box p {
            color: var(--light-grey);
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .situation-box p:last-child { margin-bottom: 0; }
        .situation-box strong { color: var(--white); }
        .situation-box em { color: var(--amber); font-style: normal; }
        
        /* Character quote */
        .char-quote {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: var(--deep-navy);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .char-quote .char-portrait { width: 45px; height: 45px; flex-shrink: 0; }
        .char-quote-text { font-style: italic; color: var(--light-grey); line-height: 1.5; }
        .char-quote-name { color: var(--white); font-weight: 500; font-size: 0.85rem; margin-bottom: 5px; font-style: normal; }
        
        /* Options list */
        .options-list { display: flex; flex-direction: column; gap: 10px; }
        
        .option-card {
            background: var(--slate);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .option-card:hover { border-color: var(--blue); }
        .option-card.selected { border-color: var(--green); background: rgba(146, 208, 80, 0.1); }
        
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .option-name { color: var(--white); font-weight: 500; }
        
        .option-cost {
            background: var(--deep-navy);
            color: var(--amber);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .option-desc { color: var(--light-grey); font-size: 0.9rem; margin-bottom: 10px; }
        
        .option-impacts {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
        }
        
        .impact { display: flex; align-items: center; gap: 4px; }
        .impact.negative { color: var(--red); }
        .impact.positive { color: var(--green); }
        .impact.neutral { color: var(--mid-grey); }
        
        /* Design choice (Stage 1) */
        .choice-image {
            width: 100%;
            height: 60px;
            background: var(--deep-navy);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid-grey);
            font-size: 0.75rem;
        }
        
        /* Recall what was chosen */
        .design-recall {
            background: var(--deep-navy);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--mid-grey);
            margin-bottom: 15px;
        }
        
        .design-recall strong { color: var(--white); }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--slate);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary { background: var(--blue); color: var(--deep-navy); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn-secondary { background: var(--slate); color: var(--white); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* ============================================
           SCREENS (Transition, Summary, Results)
           ============================================ */
        .overlay-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 600;
            align-items: center;
            justify-content: center;
        }
        
        .overlay-screen.active { display: flex; }
        
        .overlay-content {
            text-align: center;
            max-width: 650px;
            padding: 40px;
        }
        
        .trans-years { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        .trans-year { font-size: 5rem; color: var(--white); margin-bottom: 30px; }
        
        .trans-text {
            background: var(--dark-slate);
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            margin-bottom: 30px;
        }
        
        .trans-text p { margin-bottom: 12px; line-height: 1.6; }
        .trans-text p:last-child { margin-bottom: 0; }
        
        .btn-continue {
            padding: 12px 30px;
            background: var(--blue);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Summary */
        .summary-title { font-size: 2rem; color: var(--white); margin-bottom: 10px; }
        .summary-subtitle { color: var(--mid-grey); margin-bottom: 25px; }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .summary-stat {
            background: var(--dark-slate);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-stat-icon { font-size: 1.3rem; margin-bottom: 5px; }
        .summary-stat-value { font-size: 1.2rem; font-weight: 600; color: var(--white); }
        .summary-stat-value.over { color: var(--red); }
        .summary-stat-label { font-size: 0.7rem; color: var(--mid-grey); text-transform: uppercase; margin-top: 3px; }
        
        .summary-decisions {
            background: var(--dark-slate);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .summary-decisions h4 { color: var(--white); margin-bottom: 12px; }
        
        .decision-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--slate);
            font-size: 0.9rem;
        }
        
        .decision-row:last-child { border-bottom: none; }
        .decision-element { color: var(--white); }
        
        .decision-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .decision-tag.good { background: var(--green); color: var(--deep-navy); }
        .decision-tag.ok { background: var(--amber); color: var(--deep-navy); }
        .decision-tag.poor { background: var(--red); color: var(--white); }
        
        .btn-next-phase {
            padding: 12px 30px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Results */
        .results-grade {
            font-size: 7rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .results-grade.A { color: var(--green); }
        .results-grade.B { color: var(--blue); }
        .results-grade.C { color: var(--amber); }
        .results-grade.D { color: var(--red); }
        
        .results-title { color: var(--white); margin-bottom: 20px; }
        .results-verdict { color: var(--light-grey); margin-bottom: 30px; font-size: 1.1rem; }
        
        .results-totals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: var(--dark-slate);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .results-total { text-align: center; }
        .results-total-value { font-size: 1.4rem; font-weight: 600; color: var(--white); }
        .results-total-label { font-size: 0.8rem; color: var(--mid-grey); }
        
        /* Mobile */
        @media (max-width: 600px) {
            .top-bar-stats { display: none; }
            .summary-stats, .results-totals { grid-template-columns: repeat(2, 1fr); }
            .intro-title { font-size: 2rem; }
        }
    </style>
</head>
<body>

<!-- CINEMATIC INTRO -->
<div id="cinematicIntro">
    <div class="intro-slide active" data-slide="1">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="The Nuclear House">
            </div>
            <p class="intro-company">Presents</p>
            <h1 class="intro-title">The 60-Year Journey</h1>
            <p class="intro-subtitle">An interactive experience in design for decommissioning</p>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="2">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <p class="intro-location">Somerset Coast, UK</p>
            <h2 class="intro-year">2025</h2>
            <div class="intro-text-box">
                <p><strong>Thornbury Point Nuclear Power Station.</strong></p>
                <p>Sixty years of operation ahead. And someone needs to design it right.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="3">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <div class="intro-text-box">
                <p>You've been assigned <span class="highlight">Section 4B</span>: Primary coolant system auxiliaries.</p>
                <p>Your design will be built, operated, inspected, and decommissioned over <strong>sixty years</strong>.</p>
                <p>Four people will inherit your choices. Their success depends on what you decide.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="4">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-text-box" style="text-align: center; border-left: none; border: 2px solid var(--blue);">
                <p><strong>Six design decisions. Each has consequences.</strong></p>
                <p>Budget, dose, time, plant health ‚Äî every choice matters.</p>
                <div class="intro-budget">Design Budget: ¬£800,000</div>
            </div>
        </div>
    </div>
    
    <div class="intro-dots">
        <div class="intro-dot active" data-dot="1"></div>
        <div class="intro-dot" data-dot="2"></div>
        <div class="intro-dot" data-dot="3"></div>
        <div class="intro-dot" data-dot="4"></div>
    </div>
    
    <div class="intro-nav">
        <button class="btn-skip" id="btnSkip">Skip</button>
        <button class="btn-next" id="btnIntroNext">Continue ‚Üí</button>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
    <div class="top-bar">
        <div class="top-bar-logo">
            <img src="../00_images/Logo_White_Nobackground.png" alt="Logo">
        </div>
        <div class="top-bar-phase">
            <span id="phaseName">STAGE 1: DESIGN</span> ‚Äî <span class="year" id="phaseYear">2025</span>
        </div>
        <div class="top-bar-right">
            <div class="top-bar-stats" id="topStats"></div>
            <button class="btn-next-stage" id="btnNextStage">Complete Stage ‚Üí</button>
        </div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="character-banner" id="characterBanner">
        <div class="char-portrait" id="charPortrait">üë∑</div>
        <div class="char-info">
            <h4 id="charName">Dave Morton</h4>
            <p class="char-role" id="charRole">Maintenance Supervisor</p>
        </div>
    </div>
    
    <div class="map-container">
        <div class="map-wrapper">
            <img src="images/gamebackground.png" alt="Section 4B">
            
            <div class="hotspot" data-element="pumpAccess" style="left: 18%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pump Access</span>
            </div>
            
            <div class="hotspot" data-element="weldClearance" style="left: 42%; top: 46%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Weld Clearance</span>
            </div>
            
            <div class="hotspot" data-element="controlPanel" style="left: 85%; top: 42%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Control Panel</span>
            </div>
            
            <div class="hotspot" data-element="pipeConnections" style="left: 56%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Connections</span>
            </div>
            
            <div class="hotspot" data-element="pipeRouting" style="left: 62%; top: 82%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Routing</span>
            </div>
            
            <div class="hotspot" data-element="materialSpec" style="left: 32%; top: 58%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Material Spec</span>
            </div>
        </div>
    </div>
    
    <div class="bottom-bar">
        <div class="progress-dots" id="progressDots">
            <div class="progress-dot current" data-stage="1"></div>
            <div class="progress-dot" data-stage="2"></div>
            <div class="progress-dot" data-stage="3"></div>
            <div class="progress-dot" data-stage="4"></div>
            <div class="progress-dot" data-stage="5"></div>
        </div>
        <span class="progress-label" id="progressLabel">0 of 6 complete</span>
    </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Element</h3>
            <button class="modal-close" id="modalClose">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- TRANSITION SCREEN -->
<div class="overlay-screen" id="transitionScreen">
    <div class="overlay-content">
        <p class="trans-years" id="transYears">15 YEARS LATER</p>
        <h2 class="trans-year" id="transYear">2040</h2>
        <div class="trans-text" id="transText"></div>
        <button class="btn-continue" id="btnTransContinue">Continue ‚Üí</button>
    </div>
</div>

<!-- SUMMARY SCREEN -->
<div class="overlay-screen" id="summaryScreen">
    <div class="overlay-content">
        <h2 class="summary-title" id="sumTitle">Stage Complete</h2>
        <p class="summary-subtitle" id="sumSubtitle"></p>
        <div class="summary-stats" id="sumStats"></div>
        <div class="summary-decisions" id="sumDecisions"></div>
        <button class="btn-next-phase" id="btnNextPhase">Next Stage ‚Üí</button>
    </div>
</div>

<!-- RESULTS SCREEN -->
<div class="overlay-screen" id="resultsScreen">
    <div class="overlay-content">
        <div class="results-grade" id="resGrade">B</div>
        <h2 class="results-title">60 Years Complete</h2>
        <p class="results-verdict" id="resVerdict">Competent Engineer</p>
        <div class="results-totals" id="resTotals"></div>
        <button class="btn-continue" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
// ============================================
// MASTER GAME DATA (from Logic Document)
// ============================================
const GAME_DATA = {
    stages: {
        1: { name: 'DESIGN', year: 2025, budget: 800000, time: null },
        2: { name: 'MAINTENANCE', year: 2040, budget: 400000, time: 30, char: 'dave' },
        3: { name: 'INSPECTION', year: 2055, budget: 250000, time: 21, char: 'sarah' },
        4: { name: 'OPERATIONS', year: 2070, budget: 200000, time: 7, char: 'mike' },
        5: { name: 'DECOMMISSIONING', year: 2085, budget: 1200000, time: 90, char: 'janet' }
    },
    
    characters: {
        dave: { name: 'Dave Morton', role: 'Maintenance Supervisor', portrait: 'images/dave.png', emoji: 'üë∑' },
        sarah: { name: 'Sarah Okonkwo', role: 'Principal Inspector', portrait: null, emoji: 'üîç' },
        mike: { name: 'Mike Brennan', role: 'Shift Operations Manager', portrait: null, emoji: 'üë®‚Äçüíº' },
        janet: { name: 'Janet Cole', role: 'Decommissioning Lead', portrait: 'images/janet.png', emoji: 'üë©‚Äçüîß' }
    },
    
    transitions: {
        2: {
            years: '15 YEARS LATER', year: '2040',
            text: ['Thornbury Point has been generating power for 14 years.', 'Your design drawings are yellowed paper in a filing cabinet.', 'It\'s time for the first major maintenance outage.']
        },
        3: {
            years: '15 YEARS LATER', year: '2055',
            text: ['Thirty years of operation.', 'Regulators want proof everything is still safe.', 'Time for detailed in-service inspection.']
        },
        4: {
            years: '15 YEARS LATER', year: '2070',
            text: ['Forty-five years. The plant is showing its age.', 'Tonight, alarms will test your control room design.']
        },
        5: {
            years: '15 YEARS LATER', year: '2085',
            text: ['Sixty years. The reactor is shut down for good.', 'Now comes the hard part: taking it all apart safely.', 'Every 2025 decision has led to this moment.']
        }
    },
    
    // ELEMENT DEFINITIONS WITH ALL STAGE DATA
    elements: {
        pumpAccess: {
            title: 'Pump Location/Access',
            // Stage 1: Design choices
            stage1: {
                description: 'How should the primary coolant pump be positioned within Section 4B?',
                options: [
                    { id: 'corner', name: 'Corner Position', desc: 'Pump tucked in corner to maximise floor space for other equipment.', cost: 120000, quality: 'poor' },
                    { id: 'openBay', name: 'Open Bay', desc: 'Pump in open bay with 2m clearance all sides, under crane rails.', cost: 150000, quality: 'good' },
                    { id: 'dedicated', name: 'Dedicated Shielded Room', desc: 'Pump in dedicated shielded room with airlock. Over-specified for this application.', cost: 290000, quality: 'wasteful' }
                ]
            },
            // Stage 2: Maintenance - depends on design choice
            stage2: {
                corner: {
                    type: 'decision',
                    situation: 'RCP seal replacement required. Pump must be removed from position. <strong>The gap between the structural beam and wall is 1.8m. The pump assembly is 2.1m wide.</strong>',
                    charQuote: "Who signed off on this? The pump's in a corner. What were they thinking?",
                    impossible: true,
                    options: [
                        { id: 'subcontract', name: 'Subcontract specialist rigging team', desc: 'Bring in experts with specialist equipment.', cost: 180000, time: 18, dose: 3, result: 'Task completed safely by specialists.' },
                        { id: 'force', name: 'Force it - attempt to tilt and squeeze', desc: 'Risky attempt to manoeuvre pump through gap.', cost: 40000, time: 5, dose: 6, risk: { success: 30, fail: 70 }, failResult: { cost: 220000, time: 8, dose: 8, injury: 25, desc: 'Pump casing cracked during removal.' } }
                    ]
                },
                openBay: {
                    type: 'text',
                    situation: 'RCP seal replacement required. Pump positioned in open bay with crane coverage.',
                    charQuote: 'Full crane coverage. Lovely. In and out, job done.',
                    result: 'Pump removed and replaced efficiently.',
                    cost: 0, time: 3, dose: 1
                },
                dedicated: {
                    type: 'text',
                    situation: 'RCP seal replacement required. Pump is accessible but the airlock system adds complexity.',
                    charQuote: 'Nice room, but did we really need all this for a standard pump?',
                    result: 'Task completed with additional airlock protocols.',
                    cost: 20000, time: 5, dose: 1.5
                }
            },
            // Stage 3: Inspection
            stage3: {
                corner: {
                    type: 'decision',
                    situation: 'Pump casing and mounting bolts require inspection. <strong>Inspector cannot access the pump casing for UT inspection. Clearance is insufficient for probe positioning.</strong>',
                    charQuote: "I cannot access the pump casing for UT inspection. The clearance is insufficient.",
                    options: [
                        { id: 'scaffold', name: 'Erect temporary scaffolding', desc: 'Use angled probes for partial coverage.', cost: 45000, time: 5, dose: 3, healthImpact: 0, result: 'Partial coverage achieved.' },
                        { id: 'accept', name: 'Accept inspection limitation', desc: 'Document as "inaccessible" in report.', cost: 0, time: 1, dose: 0.5, healthImpact: -10, trigger: 'pumpInspectionGap', result: 'Regulatory note on file. Plant health reduced.' },
                        { id: 'retrofit', name: 'Install permanent access platform', desc: 'Full inspection now and future.', cost: 120000, time: 12, dose: 2, healthImpact: 0, result: 'Full inspection achieved. Permanent improvement.' }
                    ]
                },
                openBay: {
                    type: 'text',
                    situation: 'Pump casing and mounting bolts require inspection.',
                    charQuote: 'Full access. This is how it should be done.',
                    result: 'Inspection completed on schedule. Full UT coverage. No defects.',
                    cost: 0, time: 2, dose: 1
                },
                dedicated: {
                    type: 'text',
                    situation: 'Pump casing inspection required. Airlock adds some complexity.',
                    charQuote: 'Good access, though the airlock slows things down.',
                    result: 'Inspection completed with additional decontamination protocols.',
                    cost: 15000, time: 3, dose: 1
                }
            },
            // Stage 4: Operations
            stage4: {
                corner: {
                    type: 'conditional',
                    trigger: 'pumpInspectionGap',
                    ifTriggered: {
                        type: 'decision',
                        situation: '<strong>Night shift. Pump vibration readings have been trending upward for 6 months. Tonight they spike.</strong> The area of concern is the uninspected section of the casing.',
                        charQuote: 'The vibrations are coming from the section we could never inspect properly.',
                        options: [
                            { id: 'shutdown', name: 'Emergency shutdown for inspection', desc: 'Stop and investigate properly.', cost: 150000, time: 5, dose: 2, healthImpact: 5, result: 'Problem identified and fixed.' },
                            { id: 'reduce', name: 'Reduce power and monitor', desc: 'Lower output, watch closely.', cost: 50000, time: 0, dose: 0, risk: { success: 50, fail: 50 }, failResult: { cost: 300000, time: 5, dose: 5, healthImpact: -15, injury: 10, desc: 'Pump failed catastrophically.' } },
                            { id: 'continue', name: 'Continue normal operation', desc: 'Hope for the best.', cost: 0, time: 0, dose: 0, risk: { success: 30, fail: 70 }, failResult: { cost: 300000, time: 5, dose: 5, healthImpact: -15, injury: 10, desc: 'Pump failed during operation.' } }
                        ]
                    },
                    ifNotTriggered: {
                        type: 'text',
                        situation: 'Year 45 operational review of pump systems.',
                        charQuote: 'Pump operating within normal parameters. Predictive maintenance indicates seals due at next outage.',
                        result: 'No action needed this stage.',
                        cost: 0, time: 0, dose: 0
                    }
                },
                openBay: {
                    type: 'text',
                    situation: 'Year 45 operational review of pump systems.',
                    charQuote: 'Pump operating within normal parameters. Good access for monitoring.',
                    result: 'No issues identified.',
                    cost: 0, time: 0, dose: 0
                },
                dedicated: {
                    type: 'text',
                    situation: 'Year 45 operational review.',
                    charQuote: 'Airlock is overkill but at least it\'s accessible.',
                    result: 'No issues identified.',
                    cost: 0, time: 0, dose: 0
                }
            },
            // Stage 5: Decommissioning
            stage5: {
                corner: {
                    type: 'decision',
                    situation: 'Remove pump for disposal/recycling. <strong>Pump removal requires structural modification. The access route designed in 2025 was never adequate.</strong>',
                    charQuote: 'Sixty years later, still paying for that corner position.',
                    options: [
                        { id: 'demolish', name: 'Demolish section of wall', desc: 'Create access by removing concrete.', cost: 80000, time: 15, dose: 4, wasteExtra: 5, result: 'Pump removed. Additional concrete waste created.' },
                        { id: 'cut', name: 'Cut pump into sections in-situ', desc: 'Manual cutting in confined space.', cost: 60000, time: 20, dose: 8, result: 'High dose work. Complex waste streams.' },
                        { id: 'robot', name: 'Robotic cutting and removal', desc: 'Expensive but lowest dose.', cost: 200000, time: 8, dose: 1, result: 'Clean removal with minimal dose.' }
                    ]
                },
                openBay: {
                    type: 'text',
                    situation: 'Standard pump removal. Reverse of installation.',
                    charQuote: 'Straight lift out. This is coming apart clean.',
                    result: 'Pump removed efficiently.',
                    cost: 20000, time: 3, dose: 1
                },
                dedicated: {
                    type: 'decision',
                    situation: 'Pump easily accessible, but the dedicated room\'s shielding and airlock must also be decommissioned.',
                    charQuote: 'Easy pump removal, but now we\'ve got this whole room to deal with.',
                    options: [
                        { id: 'fullDecom', name: 'Full room decommissioning', desc: 'Pump plus unnecessary room.', cost: 150000, time: 12, dose: 2, result: 'Unnecessary waste created by over-design.' }
                    ]
                }
            }
        },
        
        weldClearance: {
            title: 'Weld Access Clearance',
            stage1: {
                description: 'What clearance should be provided around pipe welds for inspection access?',
                options: [
                    { id: '50mm', name: '50mm (Code Minimum)', desc: 'Minimum clearance permitted by design code.', cost: 90000, quality: 'poor' },
                    { id: '150mm', name: '150mm Clearance', desc: 'Adequate clearance for all standard inspection probes.', cost: 95000, quality: 'good' },
                    { id: '300mm', name: '300mm + Scaffolding', desc: 'Maximum clearance with permanent scaffolding installation.', cost: 180000, quality: 'wasteful' }
                ]
            },
            stage2: {
                '50mm': {
                    type: 'decision',
                    situation: 'Weld defect identified during construction needs repair. <strong>Clearance is too tight for comfortable welding position.</strong>',
                    charQuote: "50mm clearance. Just because you can doesn't mean you should.",
                    options: [
                        { id: 'awkward', name: 'Proceed with awkward position', desc: 'Welder works in cramped space.', cost: 0, time: 4, dose: 4, risk: { success: 80, fail: 20 }, failResult: { healthImpact: -5, desc: 'Poor weld quality will cause issues later.' } },
                        { id: 'platform', name: 'Install temporary access platform', desc: 'Better position for quality work.', cost: 25000, time: 6, dose: 2, result: 'Proper repair completed.' },
                        { id: 'defer', name: 'Defer repair to next outage', desc: 'Leave it for now.', cost: 0, time: 0, dose: 0, healthImpact: -5, trigger: 'weldDeferred', result: 'Issue grows over time.' }
                    ]
                },
                '150mm': {
                    type: 'text',
                    situation: 'Weld defect needs repair. Standard clearance available.',
                    charQuote: 'Proper clearance. Makes the job straightforward.',
                    result: 'Weld repair completed in normal working position.',
                    cost: 0, time: 2, dose: 1
                },
                '300mm': {
                    type: 'decision',
                    situation: 'Weld repair needed. <strong>The permanent scaffolding has surface contamination and must be decontaminated first.</strong>',
                    charQuote: 'Plenty of room, but that scaffolding\'s got contamination now.',
                    options: [
                        { id: 'decon', name: 'Decontaminate scaffolding', desc: 'Clean it then do repair.', cost: 20000, time: 3, dose: 2, result: 'Repair completed after decon.' },
                        { id: 'remove', name: 'Remove scaffolding, work without', desc: 'Take it out entirely.', cost: 15000, time: 4, dose: 1, wasteExtra: 1, result: 'Scaffolding becomes waste.' }
                    ]
                }
            },
            stage3: {
                '50mm': {
                    type: 'decision',
                    situation: 'In-Service Inspection of primary system welds required. <strong>Probe requires 80mm clearance for proper angle. Available clearance is 50mm.</strong>',
                    charQuote: "I'm going to have to write 'limited coverage' on this report.",
                    impossible: true,
                    options: [
                        { id: 'partial', name: 'Accept partial inspection (60%)', desc: 'Document the limitation.', cost: 0, time: 3, dose: 3, healthImpact: -10, trigger: 'weldInspectionGap', result: 'Regulatory note. Trigger created.' },
                        { id: 'miniProbe', name: 'Use specialist miniature probe', desc: 'Reduced accuracy but better coverage.', cost: 40000, time: 5, dose: 4, healthImpact: -5, result: '80% coverage achieved.' },
                        { id: 'excavate', name: 'Excavate wall to create access', desc: 'Permanent improvement.', cost: 90000, time: 10, dose: 3, result: 'Full inspection achieved.' }
                    ]
                },
                '150mm': {
                    type: 'text',
                    situation: 'In-Service Inspection of welds. Full access available.',
                    charQuote: 'Adequate clearance. Full probe positioning. No issues.',
                    result: 'Full inspection coverage achieved.',
                    cost: 0, time: 2, dose: 1
                },
                '300mm': {
                    type: 'text',
                    situation: 'Weld inspection required. Scaffolding is in the way of some angles.',
                    charQuote: 'Easy access, but the scaffolding blocks some probe angles.',
                    result: 'Inspection completed, scaffolding survey added.',
                    cost: 10000, time: 4, dose: 2
                }
            },
            stage4: {
                '50mm': {
                    type: 'conditional',
                    trigger: 'weldInspectionGap',
                    ifTriggered: {
                        type: 'decision',
                        situation: '<strong>Small leak detected at weld location that could not be fully inspected. Activity detected in secondary system.</strong>',
                        charQuote: 'Leak at the exact spot we could never properly inspect. Surprise surprise.',
                        options: [
                            { id: 'shutdown', name: 'Immediate shutdown and repair', desc: 'Fix it properly.', cost: 200000, time: 14, dose: 5, healthImpact: 5, result: 'Problem fixed.' },
                            { id: 'seal', name: 'Online leak sealing (temporary)', desc: 'Quick fix, may not hold.', cost: 50000, time: 2, dose: 2, risk: { success: 60, fail: 40 }, failResult: { cost: 250000, time: 6, dose: 6, healthImpact: -10, desc: 'Seal failed. Forced shutdown.' } },
                            { id: 'monitor', name: 'Reduce power and monitor', desc: 'Live with it for now.', cost: 80000, time: 0, dose: 0, result: 'Leak stable but ongoing concern.' }
                        ]
                    },
                    ifNotTriggered: {
                        type: 'text',
                        situation: 'Welds inspected at Year 30 remain within criteria.',
                        charQuote: 'All welds behaving as expected.',
                        result: 'No action needed.',
                        cost: 0, time: 0, dose: 0
                    }
                },
                '150mm': {
                    type: 'text',
                    situation: 'Operational review of weld integrity.',
                    charQuote: 'All welds inspected properly, all behaving normally.',
                    result: 'No issues.',
                    cost: 0, time: 0, dose: 0
                },
                '300mm': {
                    type: 'text',
                    situation: 'Operational review.',
                    charQuote: 'Welds fine. Scaffolding still contaminated.',
                    result: 'No operational issues.',
                    cost: 0, time: 0, dose: 0
                }
            },
            stage5: {
                '50mm': {
                    type: 'decision',
                    situation: 'Cut welds to remove pipe sections. <strong>Limited space for cutting tool.</strong>',
                    charQuote: "Can't get proper cutting equipment in. Manual work required.",
                    options: [
                        { id: 'careful', name: 'Careful manual cutting', desc: 'Slow and precise.', cost: 30000, time: 5, dose: 3, risk: { success: 60, fail: 40 }, failResult: { cost: 80000, time: 10, dose: 5, desc: 'Contamination spread to concrete.' } },
                        { id: 'contractor', name: 'Specialist cutting contractor', desc: 'Guaranteed clean cuts.', cost: 100000, time: 3, dose: 1, result: 'Clean removal.' }
                    ]
                },
                '150mm': {
                    type: 'text',
                    situation: 'Standard weld cutting. Full access.',
                    charQuote: 'Standard job. Full access.',
                    result: 'Clean removal.',
                    cost: 25000, time: 3, dose: 1
                },
                '300mm': {
                    type: 'decision',
                    situation: '<strong>The permanent scaffolding is now ILW due to 30 years of contamination.</strong> Must be disposed as waste.',
                    charQuote: 'Scaffolding\'s been soaking up contamination for 30 years. It\'s ILW now.',
                    options: [
                        { id: 'dispose', name: 'Scaffolding + weld disposal', desc: 'Deal with unnecessary waste.', cost: 85000, time: 8, dose: 3, result: 'Wasteful design adds cost.' }
                    ]
                }
            }
        },
        
        controlPanel: {
            title: 'Control Panel Layout',
            stage1: {
                description: 'How should the Section 4B control panel be organised?',
                options: [
                    { id: 'system', name: 'System-Based Layout', desc: 'Controls grouped by system (all pump controls together, all valve controls together).', cost: 85000, quality: 'poor' },
                    { id: 'task', name: 'Task-Based Layout', desc: 'Controls grouped by operational sequence. Emergency sequence flows left-to-right.', cost: 95000, quality: 'good' },
                    { id: 'touch', name: 'Touchscreen Interface', desc: 'Modern touchscreen displays. Impressive in demonstrations.', cost: 180000, quality: 'poor' }
                ]
            },
            stage2: {
                system: {
                    type: 'decision',
                    situation: 'Operators have submitted <strong>15 "human factors concerns" reports</strong> in the past year. They report confusion during abnormal conditions.',
                    charQuote: 'The operators are complaining about the panel layout. Again.',
                    options: [
                        { id: 'redesign', name: 'Commission HF review and partial redesign', desc: 'Improve the layout.', cost: 60000, time: 0, dose: 0, setPanelImproved: true, result: 'Panel improved to medium difficulty.' },
                        { id: 'labels', name: 'Add additional labelling and procedures', desc: 'Cheap fix, minimal improvement.', cost: 15000, time: 0, dose: 0, result: 'No real improvement.' },
                        { id: 'nothing', name: 'Note concerns, no action', desc: 'Ignore the complaints.', cost: 0, time: 0, dose: 0, result: 'Operator frustration continues.' }
                    ]
                },
                task: {
                    type: 'text',
                    situation: 'Control room operating review.',
                    charQuote: 'Operators report intuitive layout. No issues.',
                    result: 'Panel working well.',
                    cost: 0, time: 0, dose: 0
                },
                touch: {
                    type: 'decision',
                    situation: 'Touchscreen system has <strong>experienced 3 failures</strong> in first 15 years. Operators report difficulty with gloved operations.',
                    charQuote: 'Touchscreens with gloves? In a nuclear plant? Brilliant.',
                    options: [
                        { id: 'backup', name: 'Install backup hardwired panel', desc: 'Safety backup available.', cost: 70000, time: 0, dose: 0, setBackupPanel: true, result: 'Backup installed. Primary still problematic.' },
                        { id: 'upgrade', name: 'Upgrade to industrial touchscreens', desc: 'Better but still touchscreen.', cost: 50000, time: 0, dose: 0, result: 'Reliability improved marginally.' },
                        { id: 'train', name: 'Train operators more', desc: 'Blame the users.', cost: 10000, time: 0, dose: 0, result: 'No real improvement.' }
                    ]
                }
            },
            stage3: {
                system: {
                    type: 'text',
                    situation: 'Control systems periodic safety review.',
                    charQuote: 'Functionality confirmed. Design still awkward.',
                    result: 'Standard review completed.',
                    cost: 5000, time: 1, dose: 0
                },
                task: {
                    type: 'text',
                    situation: 'Control systems periodic safety review.',
                    charQuote: 'Clear indication of system status. Good design.',
                    result: 'Standard review completed.',
                    cost: 5000, time: 1, dose: 0
                },
                touch: {
                    type: 'text',
                    situation: 'Control systems review. Display showing artifacts.',
                    charQuote: 'Software update needed. Again.',
                    result: 'Review completed with software issues noted.',
                    cost: 10000, time: 1, dose: 0
                }
            },
            stage4: {
                system: {
                    type: 'decision',
                    situation: '<strong>ALARMS: Multiple alarms sounding.</strong> Loss of Coolant indication. You must respond quickly. Controls are scattered across panel by system.',
                    charQuote: "3am, alarms everywhere, and I can't find the isolation valve!",
                    options: [
                        { id: 'struggle', name: 'Search for correct controls', desc: 'Try to manage the emergency.', cost: 0, time: 2, dose: 3, risk: { success: 40, fail: 60 }, failResult: { cost: 200000, time: 5, dose: 5, healthImpact: -20, desc: 'Delayed response. Regulatory investigation.' } },
                        { id: 'senior', name: 'Call senior operator', desc: 'Get help from experience.', cost: 0, time: 1, dose: 1, result: 'Event managed. Your failure recorded.' }
                    ],
                    checkImproved: true,
                    improvedOptions: [
                        { id: 'manage', name: 'Respond using improved panel', desc: 'Panel was upgraded in Stage 2.', cost: 0, time: 1, dose: 1, result: 'Event managed with minor delay.' }
                    ]
                },
                task: {
                    type: 'text',
                    situation: 'ALARMS: Loss of Coolant indication. Emergency response required.',
                    charQuote: 'Found the right controls immediately. That\'s what good design looks like.',
                    result: 'Textbook response. Event managed efficiently.',
                    cost: 0, time: 0, dose: 0.5
                },
                touch: {
                    type: 'decision',
                    situation: '<strong>ALARMS sounding. Touchscreen is lagging under processor load. Gloved fingers not registering.</strong> Screen glare from emergency lighting.',
                    charQuote: "Touchscreen's frozen! In the middle of an event!",
                    options: [
                        { id: 'persist', name: 'Keep trying touchscreen', desc: 'Tap harder, tap faster.', cost: 0, time: 3, dose: 4, risk: { success: 30, fail: 70 }, failResult: { cost: 150000, time: 3, dose: 4, healthImpact: -15, desc: 'System freeze during event.' } },
                        { id: 'backup', name: 'Switch to backup panel', desc: 'Use hardwired backup if installed.', cost: 0, time: 0, dose: 1, checkBackup: true, result: 'Event managed via backup.' }
                    ]
                }
            },
            stage5: {
                system: {
                    type: 'text',
                    situation: 'Control panel decommissioning.',
                    charQuote: 'Standard panel removal.',
                    result: 'Non-radiological waste.',
                    cost: 10000, time: 2, dose: 0.5
                },
                task: {
                    type: 'text',
                    situation: 'Control panel decommissioning.',
                    charQuote: 'Standard panel removal.',
                    result: 'Non-radiological waste.',
                    cost: 10000, time: 2, dose: 0.5
                },
                touch: {
                    type: 'text',
                    situation: 'Touchscreen system decommissioning.',
                    charQuote: 'Electronic waste. Special disposal required.',
                    result: 'E-waste stream.',
                    cost: 30000, time: 2, dose: 0
                }
            }
        },
        
        pipeConnections: {
            title: 'Pipe Connections',
            stage1: {
                description: 'How should pipe joints be designed?',
                options: [
                    { id: 'welded', name: 'All Welded Joints', desc: 'Continuous welded construction. Maximum integrity.', cost: 180000, quality: 'poor' },
                    { id: 'flanged', name: 'Flanged Connections', desc: 'Bolted flanges at all joints. Easy to disassemble.', cost: 160000, quality: 'good' },
                    { id: 'excessive', name: 'Flanges Everywhere', desc: 'Flanged connections every 2m. Maximum flexibility.', cost: 220000, quality: 'wasteful' }
                ]
            },
            stage2: {
                welded: {
                    type: 'decision',
                    situation: 'Section of pipe requires replacement due to erosion. <strong>No flanged joints available - must cut and re-weld.</strong>',
                    charQuote: "All welded. So we're cutting and re-welding then. Brilliant.",
                    options: [
                        { id: 'replace', name: 'Cut, replace section, re-weld', desc: 'Proper replacement.', cost: 65000, time: 8, dose: 5, result: 'Pipe replaced. New welds need future inspection.' },
                        { id: 'overlay', name: 'Weld overlay repair (temporary)', desc: 'Patch it for now.', cost: 25000, time: 3, dose: 3, healthImpact: -5, trigger: 'weldOverlay', result: 'Temporary fix. Revisit in 10 years.' }
                    ]
                },
                flanged: {
                    type: 'text',
                    situation: 'Pipe section requires replacement. Flanged connections available.',
                    charQuote: 'Flanged connections. Someone was thinking ahead.',
                    result: 'Section unbolted, replaced, reconnected.',
                    cost: 30000, time: 3, dose: 1.5
                },
                excessive: {
                    type: 'decision',
                    situation: '<strong>Three flange gaskets have failed</strong> in the past 5 years. More leak paths = more failures.',
                    charQuote: 'Too many flanges means too many gaskets to fail.',
                    options: [
                        { id: 'preventive', name: 'Replace all gaskets (preventive)', desc: 'Replace them all now.', cost: 45000, time: 5, dose: 2, result: 'Reliable for next period.' },
                        { id: 'reactive', name: 'Replace failed gaskets only', desc: 'Just fix what\'s broken.', cost: 15000, time: 2, dose: 1, healthImpact: -3, result: 'More failures likely.' }
                    ]
                }
            },
            stage3: {
                welded: {
                    type: 'decision',
                    situation: 'All welds require inspection. <strong>Large number of weld inspections required.</strong>',
                    charQuote: 'Every joint is a weld. Every weld needs inspection.',
                    options: [
                        { id: 'full', name: 'Full inspection programme', desc: 'Inspect all welds.', cost: 50000, time: 7, dose: 4, result: 'All welds verified.' },
                        { id: 'sample', name: 'Sample inspection (50%)', desc: 'Inspect half, hope for best.', cost: 25000, time: 4, dose: 2, healthImpact: -5, result: 'Risk of missed defect.' }
                    ]
                },
                flanged: {
                    type: 'text',
                    situation: 'Flanged connections visually inspected. Limited weld inspections needed.',
                    charQuote: 'Flanges to inspect, not welds to probe. Much easier.',
                    result: 'Inspection completed efficiently.',
                    cost: 20000, time: 3, dose: 1.5
                },
                excessive: {
                    type: 'text',
                    situation: 'All 47 flanged connections require bolt inspection and gasket assessment.',
                    charQuote: 'Forty-seven flanges. That\'s a lot of bolts to check.',
                    result: 'Time-consuming but thorough.',
                    cost: 35000, time: 5, dose: 2
                }
            },
            stage4: {
                welded: {
                    type: 'text',
                    situation: 'Piping system operational review.',
                    charQuote: 'Welds holding. No isolation flexibility though.',
                    result: 'No immediate issues.',
                    cost: 0, time: 0, dose: 0
                },
                flanged: {
                    type: 'text',
                    situation: 'Piping system operational review.',
                    charQuote: 'Quick isolation possible in emergencies. Good design.',
                    result: 'Operational flexibility confirmed.',
                    cost: 0, time: 0, dose: 0
                },
                excessive: {
                    type: 'text',
                    situation: 'Piping operational review. Two more gasket failures this period.',
                    charQuote: 'Another gasket gone. Too many joints.',
                    result: 'Ongoing maintenance burden.',
                    cost: 20000, time: 2, dose: 0.5
                }
            },
            stage5: {
                welded: {
                    type: 'decision',
                    situation: 'Disassemble pipe system. <strong>12 welds to cut. Each must be clean to avoid contamination spread.</strong>',
                    charQuote: 'Every joint needs cutting. This is going to take forever.',
                    options: [
                        { id: 'careful', name: 'Careful cutting in-house', desc: 'Do it ourselves, slowly.', cost: 80000, time: 15, dose: 8, risk: { success: 50, fail: 50 }, failResult: { cost: 140000, time: 22, dose: 12, desc: 'Contamination events during cutting.' } },
                        { id: 'specialist', name: 'Specialist cutting contractor', desc: 'Experts with proper equipment.', cost: 180000, time: 10, dose: 3, result: 'Clean cuts guaranteed.' }
                    ]
                },
                flanged: {
                    type: 'text',
                    situation: 'Unbolt flanges at connection points. Lift sections out.',
                    charQuote: 'Unbolt, remove, done. This is how it should be.',
                    result: 'Clean disassembly.',
                    cost: 40000, time: 6, dose: 2
                },
                excessive: {
                    type: 'text',
                    situation: '47 flanged connections to unbolt. None difficult, just many.',
                    charQuote: 'So many flanges. So many gaskets to dispose.',
                    result: 'Tedious but achievable.',
                    cost: 55000, time: 10, dose: 3
                }
            }
        },
        
        pipeRouting: {
            title: 'Pipe Routing',
            stage1: {
                description: 'How should pipes be routed through the concrete structure?',
                options: [
                    { id: 'embedded', name: 'Embedded in Concrete', desc: 'Pipes cast directly into structural concrete for "protection".', cost: 140000, quality: 'poor' },
                    { id: 'ducted', name: 'Accessible Ducts', desc: 'Pipes run through removable duct covers.', cost: 165000, quality: 'good' },
                    { id: 'tunnel', name: 'Walk-In Tunnel', desc: 'Large accessible tunnel for all services.', cost: 280000, quality: 'wasteful' }
                ]
            },
            stage2: {
                embedded: {
                    type: 'decision',
                    situation: '<strong>Suspected leak in embedded pipe section. Cannot be visually confirmed.</strong>',
                    charQuote: "Can't access these pipes. Hope nothing goes wrong. Oh wait, it did.",
                    options: [
                        { id: 'excavate', name: 'Excavate concrete to investigate', desc: 'Dig it out.', cost: 70000, time: 12, dose: 4, result: 'Leak found and repaired. Concrete damaged.' },
                        { id: 'bypass', name: 'Install bypass line', desc: 'Route around the problem.', cost: 90000, time: 8, dose: 2, result: 'Embedded section isolated and abandoned.' },
                        { id: 'defer', name: 'Increase monitoring, defer', desc: 'Watch and wait.', cost: 10000, time: 0, dose: 0, healthImpact: -10, trigger: 'embeddedLeak', result: 'Problem deferred. Risk increased.' }
                    ]
                },
                ducted: {
                    type: 'text',
                    situation: 'Minor leak at joint identified via duct access.',
                    charQuote: 'Duct covers off, full access. Proper design.',
                    result: 'Leak identified and repaired quickly.',
                    cost: 15000, time: 2, dose: 1
                },
                tunnel: {
                    type: 'text',
                    situation: 'Leak repaired easily. However, tunnel surfaces show contamination migration.',
                    charQuote: 'Walk-in access is nice, but did we need this much space?',
                    result: 'Repair done. Decontamination required.',
                    cost: 35000, time: 4, dose: 2
                }
            },
            stage3: {
                embedded: {
                    type: 'decision',
                    situation: '<strong>Embedded pipe sections cannot be inspected by conventional means.</strong>',
                    charQuote: 'Embedded in concrete. We\'re guessing what\'s in there.',
                    options: [
                        { id: 'accept', name: 'Accept inspection gap', desc: 'Document the risk.', cost: 0, time: 1, dose: 0, healthImpact: -10, trigger: 'embeddedInspectionGap', result: 'Regulatory concern noted.' },
                        { id: 'guided', name: 'Install guided wave UT', desc: 'Partial monitoring capability.', cost: 60000, time: 5, dose: 1, result: 'Some monitoring available.' },
                        { id: 'excavate', name: 'Excavate sample locations', desc: 'Dig out inspection points.', cost: 100000, time: 14, dose: 5, result: 'Limited inspection. Structural damage.' }
                    ]
                },
                ducted: {
                    type: 'text',
                    situation: 'Full inspection via duct access.',
                    charQuote: 'Full visual and probe access. No issues.',
                    result: 'Complete inspection achieved.',
                    cost: 15000, time: 3, dose: 1.5
                },
                tunnel: {
                    type: 'text',
                    situation: 'Tunnel surfaces contaminated. Full PPE required.',
                    charQuote: 'Tunnel surfaces contaminated. Workers need full suits.',
                    result: 'Inspection completed with higher dose.',
                    cost: 25000, time: 5, dose: 3
                }
            },
            stage4: {
                embedded: {
                    type: 'conditional',
                    trigger: 'embeddedLeak',
                    ifTriggered: {
                        type: 'decision',
                        situation: '<strong>Groundwater monitoring detects activity. Source traced to embedded pipe section.</strong>',
                        charQuote: 'Contamination in the groundwater. The leak we ignored.',
                        options: [
                            { id: 'emergency', name: 'Emergency excavation and repair', desc: 'Dig it out now.', cost: 200000, time: 21, dose: 8, result: 'Environmental report required. Fixed.' },
                            { id: 'treatment', name: 'Groundwater treatment + isolation', desc: 'Treat the water, abandon the pipe.', cost: 150000, time: 7, dose: 2, result: 'Pipe abandoned. Long-term monitoring.' }
                        ],
                        additionalCosts: { regulatory: 50000, environmental: 100000, healthImpact: -15 }
                    },
                    ifNotTriggered: {
                        type: 'text',
                        situation: 'Embedded sections monitored. No issues detected.',
                        charQuote: 'Monitoring shows nothing wrong. For now.',
                        result: 'No action needed.',
                        cost: 0, time: 0, dose: 0
                    }
                },
                ducted: {
                    type: 'text',
                    situation: 'Quick visual check via duct access.',
                    charQuote: 'Quick visual confirms system status.',
                    result: 'No issues.',
                    cost: 0, time: 0, dose: 0
                },
                tunnel: {
                    type: 'text',
                    situation: 'Tunnel walkthrough inspection.',
                    charQuote: 'Easy walkthrough. Tunnel still contaminated.',
                    result: 'No operational issues.',
                    cost: 0, time: 0, dose: 0
                }
            },
            stage5: {
                embedded: {
                    type: 'decision',
                    situation: '<strong>Pipes encased in concrete. Contamination has migrated into surrounding structure.</strong>',
                    charQuote: 'Embedded in concrete. That\'s another six months and half a million.',
                    options: [
                        { id: 'demolish', name: 'Full concrete excavation', desc: 'Break it all out.', cost: 350000, time: 40, dose: 20, result: 'Massive ILW concrete waste.' },
                        { id: 'specialist', name: 'Specialist demolition contractor', desc: 'Controlled demolition.', cost: 400000, time: 25, dose: 8, result: 'Controlled but still expensive.' }
                    ]
                },
                ducted: {
                    type: 'text',
                    situation: 'Remove duct covers, lift pipes from ducts.',
                    charQuote: 'Pull the covers, extract the pipes. Straightforward.',
                    result: 'Ducts can be demolished as clean concrete.',
                    cost: 50000, time: 8, dose: 2
                },
                tunnel: {
                    type: 'decision',
                    situation: 'Pipes easily removed, but <strong>tunnel itself is contaminated ILW. Large volume of waste.</strong>',
                    charQuote: 'Easy pipe removal. But now we\'ve got this huge tunnel to decontaminate.',
                    options: [
                        { id: 'full', name: 'Pipe removal + tunnel decom', desc: 'Deal with the whole thing.', cost: 220000, time: 25, dose: 8, result: 'Large ILW void to fill.' }
                    ]
                }
            }
        },
        
        materialSpec: {
            title: 'Material Specification',
            stage1: {
                description: 'What material for primary circuit pipework?',
                options: [
                    { id: 'standard', name: 'Standard Stainless Steel', desc: 'Type 304/316, ~2,500ppm cobalt. Industry standard.', cost: 200000, quality: 'poor' },
                    { id: 'lowCobalt', name: 'Low-Cobalt Stainless', desc: 'Cobalt below 500ppm. Reduces activation.', cost: 250000, quality: 'good' },
                    { id: 'exotic', name: 'Exotic Nickel Alloy', desc: 'High-performance nickel alloy. Premium specification.', cost: 400000, quality: 'poor' }
                ]
            },
            stage2: {
                standard: {
                    type: 'text',
                    situation: 'Maintenance in activated area. Standard steel dose rates.',
                    charQuote: 'Standard steel. Hot to work on but expected.',
                    result: 'Higher dose for all maintenance tasks.',
                    cost: 0, time: 2, dose: 3, isModifier: true
                },
                lowCobalt: {
                    type: 'text',
                    situation: 'Maintenance in activated area. Low dose rates.',
                    charQuote: 'Low-cobalt. Noticeably lower dose rates.',
                    result: 'Dose rates as predicted. Good ALARP.',
                    cost: 0, time: 0, dose: 0
                },
                exotic: {
                    type: 'text',
                    situation: 'Maintenance requires special procedures for exotic alloy.',
                    charQuote: 'Special procedures for this alloy. Slower work. Higher dose.',
                    result: 'Significantly higher dose rates.',
                    cost: 0, time: 4, dose: 5, isModifier: true
                }
            },
            stage3: {
                standard: {
                    type: 'text',
                    situation: 'Inspection in elevated dose rate area.',
                    charQuote: 'Standard material. Higher background.',
                    result: 'Extended stand-off techniques required.',
                    cost: 15000, time: 3, dose: 4, isModifier: true
                },
                lowCobalt: {
                    type: 'text',
                    situation: 'Inspection with manageable dose rates.',
                    charQuote: 'Clean material, easy to work around.',
                    result: 'Standard techniques applied.',
                    cost: 0, time: 0, dose: 0
                },
                exotic: {
                    type: 'text',
                    situation: 'Inspection requires shielded equipment.',
                    charQuote: 'Dose rates require specialist contractor.',
                    result: 'Specialist inspection required.',
                    cost: 40000, time: 5, dose: 6, isModifier: true
                }
            },
            stage4: {
                standard: {
                    type: 'decision',
                    situation: '<strong>Cumulative workforce dose approaching administrative limits.</strong>',
                    charQuote: 'Dose budget is tight. Standard steel not helping.',
                    options: [
                        { id: 'contractors', name: 'Bring in additional contractors', desc: 'More workers = more dose available.', cost: 80000, time: 0, dose: 0, result: 'Dose spread across more workers.' },
                        { id: 'shielding', name: 'Install temporary shielding', desc: 'One-time improvement.', cost: 50000, time: 5, dose: -2, result: 'Future task doses reduced.' },
                        { id: 'slow', name: 'Accept constraints, slow down', desc: 'Work proceeds slower.', cost: 0, time: 10, dose: 0, result: 'Schedule impact.' }
                    ]
                },
                lowCobalt: {
                    type: 'text',
                    situation: 'Dose rates remain low.',
                    charQuote: 'Low dose rates. Full operational flexibility.',
                    result: 'No dose constraints.',
                    cost: 0, time: 0, dose: 0
                },
                exotic: {
                    type: 'decision',
                    situation: '<strong>Dose rates severely limiting work time.</strong>',
                    charQuote: 'Nickel alloy activation is brutal.',
                    options: [
                        { id: 'contractors', name: 'Bring in additional contractors', desc: 'More workers needed.', cost: 100000, time: 0, dose: 0, result: 'Dose spread, expensive.' },
                        { id: 'remote', name: 'Remote operations where possible', desc: 'Minimise human proximity.', cost: 60000, time: 8, dose: -3, result: 'Reduced direct exposure.' }
                    ]
                }
            },
            stage5: {
                standard: {
                    type: 'decision',
                    situation: 'Components remain <strong>highly active after 5-year decay storage.</strong> Remote handling required.',
                    charQuote: '2,500 ppm cobalt. Waiting decades for it to cool down.',
                    options: [
                        { id: 'remote', name: 'Remote handling operations', desc: 'Difficult but manageable.', cost: 120000, time: 18, dose: 6, risk: { success: 70, fail: 30 }, failResult: { cost: 180000, time: 25, dose: 10, desc: 'Errors during remote handling.' } },
                        { id: 'specialist', name: 'Specialist remote handling contractor', desc: 'Expert operators.', cost: 200000, time: 12, dose: 2, result: 'Clean removal by experts.' }
                    ]
                },
                lowCobalt: {
                    type: 'text',
                    situation: 'After 5-year decay, dose rates allow hands-on work.',
                    charQuote: 'Low activation. Can handle it much sooner.',
                    result: 'LLW disposal possible for some items.',
                    cost: 60000, time: 8, dose: 2
                },
                exotic: {
                    type: 'decision',
                    situation: '<strong>Nickel-63 half-life is 100 years.</strong> Components will remain active for centuries.',
                    charQuote: 'This alloy will be hot for a hundred years.',
                    options: [
                        { id: 'extended', name: 'Extended remote operations', desc: 'Very difficult work.', cost: 250000, time: 30, dose: 15, result: 'Long-term storage required.' },
                        { id: 'specialist', name: 'Specialist + extended storage', desc: 'Experts plus waiting.', cost: 300000, time: 20, dose: 5, result: 'Still expensive.' }
                    ]
                }
            }
        }
    }
};

// ============================================
// GAME STATE
// ============================================
const STATE = {
    stage: 1,
    choices: {},           // Stage 1 design choices
    stageChoices: {},      // Choices made in stages 2-5
    completed: {},         // Completed elements per stage
    triggers: {},          // Active triggers
    flags: {},             // Special flags (panelImproved, backupPanel, etc.)
    totals: { cost: 0, dose: 0, time: 0 },
    stageTotals: {},
    plantHealth: 100,
    injuries: 0
};

// ============================================
// INTRO CONTROLLER
// ============================================
let currentSlide = 1;
const totalSlides = 4;

function updateIntroSlide() {
    document.querySelectorAll('.intro-slide').forEach(s => s.classList.remove('active'));
    document.querySelector(`.intro-slide[data-slide="${currentSlide}"]`).classList.add('active');
    document.querySelectorAll('.intro-dot').forEach((d, i) => {
        d.classList.remove('active', 'done');
        if (i + 1 === currentSlide) d.classList.add('active');
        else if (i + 1 < currentSlide) d.classList.add('done');
    });
    document.getElementById('btnIntroNext').textContent = currentSlide === totalSlides ? 'Begin ‚Üí' : 'Continue ‚Üí';
}

document.getElementById('btnIntroNext').onclick = () => {
    if (currentSlide < totalSlides) { currentSlide++; updateIntroSlide(); }
    else endIntro();
};
document.getElementById('btnSkip').onclick = endIntro;
document.querySelectorAll('.intro-dot').forEach(d => {
    d.onclick = () => { currentSlide = parseInt(d.dataset.dot); updateIntroSlide(); };
});

function endIntro() {
    document.getElementById('cinematicIntro').classList.add('hidden');
    document.getElementById('gameScreen').classList.add('active');
    startStage(1);
}

// ============================================
// STAGE MANAGEMENT
// ============================================
function startStage(stageNum) {
    STATE.stage = stageNum;
    STATE.completed[stageNum] = {};
    STATE.stageTotals[stageNum] = { cost: 0, dose: 0, time: 0 };
    
    const stage = GAME_DATA.stages[stageNum];
    
    // Update header
    document.getElementById('phaseName').textContent = `STAGE ${stageNum}: ${stage.name}`;
    document.getElementById('phaseYear').textContent = stage.year;
    
    // Update stats display
    updateStatsDisplay();
    
    // Character banner
    const banner = document.getElementById('characterBanner');
    if (stageNum > 1 && stage.char) {
        const char = GAME_DATA.characters[stage.char];
        banner.className = `character-banner visible ${stage.char}`;
        document.getElementById('charPortrait').innerHTML = char.portrait 
            ? `<img src="${char.portrait}" alt="${char.name}">` 
            : char.emoji;
        document.getElementById('charName').textContent = char.name;
        document.getElementById('charRole').textContent = char.role;
    } else {
        banner.classList.remove('visible');
    }
    
    // Reset hotspots
    document.querySelectorAll('.hotspot-dot').forEach(d => {
        d.classList.remove('done', 'warning', 'issue');
    });
    
    // Update progress
    document.querySelectorAll('.progress-dot').forEach((d, i) => {
        d.classList.remove('current', 'done');
        if (i + 1 === stageNum) d.classList.add('current');
        else if (i + 1 < stageNum) d.classList.add('done');
    });
    
    document.getElementById('progressFill').style.width = `${(stageNum - 1) * 25}%`;
    document.getElementById('btnNextStage').classList.remove('visible');
    
    updateProgressLabel();
}

function updateStatsDisplay() {
    const stage = GAME_DATA.stages[STATE.stage];
    let html = '';
    
    if (STATE.stage === 1) {
        const spent = STATE.totals.cost;
        const remaining = stage.budget - spent;
        html = `
            <div class="stat">üí∞ Remaining: <span class="stat-value ${remaining < 100000 ? 'warning' : ''}">${formatMoney(remaining)}</span></div>
        `;
    } else {
        const st = STATE.stageTotals[STATE.stage] || { cost: 0, dose: 0, time: 0 };
        html = `
            <div class="stat">üí∞ <span class="stat-value">${formatMoney(st.cost)}</span></div>
            <div class="stat">‚ò¢Ô∏è <span class="stat-value">${st.dose.toFixed(1)} mSv</span></div>
            <div class="stat">‚è±Ô∏è <span class="stat-value">${st.time} days</span></div>
            <div class="stat">‚ù§Ô∏è <span class="stat-value ${STATE.plantHealth < 60 ? 'danger' : ''}">${STATE.plantHealth}%</span></div>
        `;
    }
    
    document.getElementById('topStats').innerHTML = html;
}

function updateProgressLabel() {
    const done = Object.keys(STATE.completed[STATE.stage] || {}).length;
    document.getElementById('progressLabel').textContent = `${done} of 6 complete`;
    if (done === 6) {
        document.getElementById('btnNextStage').classList.add('visible');
    }
}

function formatMoney(amount) {
    return '¬£' + amount.toLocaleString();
}

// ============================================
// HOTSPOT CLICKS
// ============================================
document.querySelectorAll('.hotspot').forEach(h => {
    h.onclick = () => {
        const el = h.dataset.element;
        if (STATE.completed[STATE.stage]?.[el]) return;
        openElementModal(el);
    };
});

// ============================================
// MODAL SYSTEM
// ============================================
function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

document.getElementById('modalClose').onclick = closeModal;
document.getElementById('modalOverlay').onclick = (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
};

function openElementModal(elementId) {
    const element = GAME_DATA.elements[elementId];
    document.getElementById('modalTitle').textContent = element.title;
    
    if (STATE.stage === 1) {
        renderDesignChoiceModal(elementId, element);
    } else {
        renderStageInteractionModal(elementId, element);
    }
    
    openModal();
}

// ============================================
// STAGE 1: DESIGN CHOICES
// ============================================
function renderDesignChoiceModal(elementId, element) {
    const data = element.stage1;
    
    let html = `<div class="situation-box"><p>${data.description}</p></div>`;
    html += '<div class="options-list">';
    
    data.options.forEach(opt => {
        const selected = STATE.choices[elementId] === opt.id ? 'selected' : '';
        html += `
            <div class="option-card ${selected}" data-id="${opt.id}">
                <div class="choice-image">[Image: ${opt.name}]</div>
                <div class="option-header">
                    <span class="option-name">${opt.name}</span>
                    <span class="option-cost">${formatMoney(opt.cost)}</span>
                </div>
                <p class="option-desc">${opt.desc}</p>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = STATE.choices[elementId] || null;
    document.querySelectorAll('.option-card').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirm">Confirm Selection</button>';
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        confirmDesignChoice(elementId, element, selected);
    };
}

function confirmDesignChoice(elementId, element, choiceId) {
    const opt = element.stage1.options.find(o => o.id === choiceId);
    
    // Refund old choice if changing
    if (STATE.choices[elementId]) {
        const old = element.stage1.options.find(o => o.id === STATE.choices[elementId]);
        STATE.totals.cost -= old.cost;
    }
    
    STATE.choices[elementId] = choiceId;
    STATE.completed[1][elementId] = true;
    STATE.totals.cost += opt.cost;
    
    // Update hotspot
    const dot = document.querySelector(`[data-element="${elementId}"] .hotspot-dot`);
    dot.classList.add('done');
    
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}

// ============================================
// STAGES 2-5: INTERACTIONS
// ============================================
function renderStageInteractionModal(elementId, element) {
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.choices[elementId];
    let stageData = element[stageKey]?.[designChoice];
    
    if (!stageData) {
        // Fallback if no specific data
        document.getElementById('modalBody').innerHTML = '<p>No specific interaction for this element at this stage.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirm">Continue</button>';
        document.getElementById('btnConfirm').onclick = () => {
            STATE.completed[STATE.stage][elementId] = true;
            document.querySelector(`[data-element="${elementId}"] .hotspot-dot`).classList.add('done');
            updateProgressLabel();
            closeModal();
        };
        return;
    }
    
    // Handle conditional type
    if (stageData.type === 'conditional') {
        const triggerActive = STATE.triggers[stageData.trigger];
        stageData = triggerActive ? stageData.ifTriggered : stageData.ifNotTriggered;
    }
    
    const char = GAME_DATA.characters[GAME_DATA.stages[STATE.stage].char];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    
    if (stageData.type === 'text') {
        renderTextOutcome(elementId, stageData, char, designOpt);
    } else if (stageData.type === 'decision') {
        renderDecisionPoint(elementId, stageData, char, designOpt);
    }
}

function renderTextOutcome(elementId, data, char, designOpt) {
    let html = '';
    
    // Design recall
    html += `<div class="design-recall"><strong>Your 2025 choice:</strong> ${designOpt.name}</div>`;
    
    // Situation
    html += `<div class="situation-box"><p>${data.situation}</p></div>`;
    
    // Character quote
    html += `
        <div class="char-quote">
            <div class="char-portrait">${char.portrait ? `<img src="${char.portrait}">` : char.emoji}</div>
            <div>
                <div class="char-quote-name">${char.name}</div>
                <p class="char-quote-text">"${data.charQuote}"</p>
            </div>
        </div>
    `;
    
    // Result
    html += `<div class="situation-box" style="border-left-color: var(--green);"><p><strong>Result:</strong> ${data.result}</p></div>`;
    
    // Impacts preview
    html += `<div class="option-impacts" style="justify-content: center; padding: 10px 0;">`;
    if (data.cost) html += `<span class="impact negative">üí∞ ${formatMoney(data.cost)}</span>`;
    if (data.time) html += `<span class="impact negative">‚è±Ô∏è +${data.time} days</span>`;
    if (data.dose) html += `<span class="impact negative">‚ò¢Ô∏è +${data.dose} mSv</span>`;
    if (!data.cost && !data.time && !data.dose) html += `<span class="impact positive">No additional impact</span>`;
    html += `</div>`;
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirm">Continue</button>';
    
    document.getElementById('btnConfirm').onclick = () => {
        applyOutcome(elementId, data);
    };
}

function renderDecisionPoint(elementId, data, char, designOpt) {
    let html = '';
    
    // Design recall
    html += `<div class="design-recall"><strong>Your 2025 choice:</strong> ${designOpt.name}</div>`;
    
    // Situation
    const boxClass = data.impossible ? 'warning' : '';
    html += `<div class="situation-box ${boxClass}"><p>${data.situation}</p></div>`;
    
    // Character quote
    html += `
        <div class="char-quote">
            <div class="char-portrait">${char.portrait ? `<img src="${char.portrait}">` : char.emoji}</div>
            <div>
                <div class="char-quote-name">${char.name}</div>
                <p class="char-quote-text">"${data.charQuote}"</p>
            </div>
        </div>
    `;
    
    // Options
    let options = data.options;
    
    // Check for improved panel options
    if (data.checkImproved && STATE.flags.panelImproved) {
        options = data.improvedOptions;
    }
    
    html += '<div class="options-list">';
    options.forEach(opt => {
        html += `
            <div class="option-card" data-id="${opt.id}">
                <div class="option-header">
                    <span class="option-name">${opt.name}</span>
                    ${opt.cost ? `<span class="option-cost">${formatMoney(opt.cost)}</span>` : ''}
                </div>
                <p class="option-desc">${opt.desc}</p>
                <div class="option-impacts">
                    ${opt.cost ? `<span class="impact negative">üí∞ ${formatMoney(opt.cost)}</span>` : ''}
                    ${opt.time ? `<span class="impact negative">‚è±Ô∏è +${opt.time} days</span>` : ''}
                    ${opt.dose ? `<span class="impact ${opt.dose > 0 ? 'negative' : 'positive'}">‚ò¢Ô∏è ${opt.dose > 0 ? '+' : ''}${opt.dose} mSv</span>` : ''}
                    ${opt.healthImpact ? `<span class="impact ${opt.healthImpact > 0 ? 'positive' : 'negative'}">‚ù§Ô∏è ${opt.healthImpact > 0 ? '+' : ''}${opt.healthImpact}%</span>` : ''}
                    ${opt.risk ? `<span class="impact neutral">‚ö†Ô∏è ${opt.risk.success}% success</span>` : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = null;
    document.querySelectorAll('.option-card').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirm" disabled>Select an Option</button>';
    
    // Enable button when option selected
    const observer = new MutationObserver(() => {
        const hasSelection = document.querySelector('.option-card.selected');
        const btn = document.getElementById('btnConfirm');
        btn.disabled = !hasSelection;
        btn.textContent = hasSelection ? 'Confirm Decision' : 'Select an Option';
    });
    observer.observe(document.getElementById('modalBody'), { subtree: true, attributes: true, attributeFilter: ['class'] });
    
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        const opt = options.find(o => o.id === selected);
        
        // Handle risk
        if (opt.risk) {
            const roll = Math.random() * 100;
            if (roll > opt.risk.success) {
                // Failed!
                showRiskResult(elementId, opt, false);
                return;
            }
        }
        
        // Success
        applyDecision(elementId, opt, data);
    };
}

function showRiskResult(elementId, opt, success) {
    if (!success && opt.failResult) {
        const fail = opt.failResult;
        
        let html = `<div class="situation-box danger"><p><strong>Attempt Failed!</strong></p><p>${fail.desc}</p></div>`;
        
        html += `<div class="option-impacts" style="justify-content: center; padding: 15px 0; flex-wrap: wrap; gap: 10px;">`;
        if (fail.cost) html += `<span class="impact negative">üí∞ ${formatMoney(fail.cost)}</span>`;
        if (fail.time) html += `<span class="impact negative">‚è±Ô∏è +${fail.time} days</span>`;
        if (fail.dose) html += `<span class="impact negative">‚ò¢Ô∏è +${fail.dose} mSv</span>`;
        if (fail.healthImpact) html += `<span class="impact negative">‚ù§Ô∏è ${fail.healthImpact}%</span>`;
        if (fail.injury) html += `<span class="impact negative">üöë ${fail.injury}% injury risk</span>`;
        html += `</div>`;
        
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-danger" id="btnConfirm">Accept Consequences</button>';
        
        document.getElementById('btnConfirm').onclick = () => {
            // Apply failure consequences
            const outcome = {
                cost: fail.cost || 0,
                time: fail.time || 0,
                dose: fail.dose || 0,
                healthImpact: fail.healthImpact || 0
            };
            
            // Check for injury
            if (fail.injury && Math.random() * 100 < fail.injury) {
                STATE.injuries++;
                outcome.cost += 50000;
                outcome.time += 10;
            }
            
            applyOutcome(elementId, outcome, 'issue');
        };
    }
}

function applyDecision(elementId, opt, data) {
    // Set triggers
    if (opt.trigger) STATE.triggers[opt.trigger] = true;
    
    // Set flags
    if (opt.setPanelImproved) STATE.flags.panelImproved = true;
    if (opt.setBackupPanel) STATE.flags.backupPanel = true;
    
    // Apply outcome
    const outcome = {
        cost: opt.cost || 0,
        time: opt.time || 0,
        dose: opt.dose || 0,
        healthImpact: opt.healthImpact || 0,
        result: opt.result
    };
    
    // Add any additional costs from the data
    if (data.additionalCosts) {
        outcome.cost += (data.additionalCosts.regulatory || 0) + (data.additionalCosts.environmental || 0);
        if (data.additionalCosts.healthImpact) outcome.healthImpact += data.additionalCosts.healthImpact;
    }
    
    applyOutcome(elementId, outcome);
}

function applyOutcome(elementId, outcome, status = 'done') {
    // Apply to stage totals
    STATE.stageTotals[STATE.stage].cost += outcome.cost || 0;
    STATE.stageTotals[STATE.stage].dose += outcome.dose || 0;
    STATE.stageTotals[STATE.stage].time += outcome.time || 0;
    
    // Apply to overall totals
    STATE.totals.cost += outcome.cost || 0;
    STATE.totals.dose += outcome.dose || 0;
    STATE.totals.time += outcome.time || 0;
    
    // Apply health impact
    if (outcome.healthImpact) {
        STATE.plantHealth = Math.max(0, Math.min(100, STATE.plantHealth + outcome.healthImpact));
    }
    
    // Set triggers
    if (outcome.trigger) STATE.triggers[outcome.trigger] = true;
    
    // Mark complete
    STATE.completed[STATE.stage][elementId] = true;
    STATE.stageChoices[`${STATE.stage}_${elementId}`] = outcome;
    
    // Update hotspot visual
    const dot = document.querySelector(`[data-element="${elementId}"] .hotspot-dot`);
    dot.classList.add(status);
    
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}

// ============================================
// STAGE COMPLETION
// ============================================
document.getElementById('btnNextStage').onclick = showStageSummary;

function showStageSummary() {
    const stage = GAME_DATA.stages[STATE.stage];
    const st = STATE.stageTotals[STATE.stage];
    
    document.getElementById('sumTitle').textContent = `${stage.name} Complete`;
    document.getElementById('sumSubtitle').textContent = `Year ${stage.year}`;
    
    // Stats
    let statsHtml = '';
    if (STATE.stage === 1) {
        const budget = stage.budget;
        const spent = STATE.totals.cost;
        const over = spent > budget;
        statsHtml = `
            <div class="summary-stat"><div class="summary-stat-icon">üí∞</div><div class="summary-stat-value ${over ? 'over' : ''}">${formatMoney(spent)}</div><div class="summary-stat-label">Spent</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">üìä</div><div class="summary-stat-value">${formatMoney(budget)}</div><div class="summary-stat-label">Budget</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">üìã</div><div class="summary-stat-value">6</div><div class="summary-stat-label">Decisions</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ù§Ô∏è</div><div class="summary-stat-value">${STATE.plantHealth}%</div><div class="summary-stat-label">Health</div></div>
        `;
    } else {
        statsHtml = `
            <div class="summary-stat"><div class="summary-stat-icon">üí∞</div><div class="summary-stat-value">${formatMoney(st.cost)}</div><div class="summary-stat-label">Stage Cost</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ò¢Ô∏è</div><div class="summary-stat-value">${st.dose.toFixed(1)} mSv</div><div class="summary-stat-label">Dose</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚è±Ô∏è</div><div class="summary-stat-value">${st.time} days</div><div class="summary-stat-label">Time</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ù§Ô∏è</div><div class="summary-stat-value">${STATE.plantHealth}%</div><div class="summary-stat-label">Health</div></div>
        `;
    }
    document.getElementById('sumStats').innerHTML = statsHtml;
    
    // Decisions list
    let decHtml = '<h4>Decisions Made</h4>';
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const choice = STATE.choices[elId];
        const opt = el.stage1.options.find(o => o.id === choice);
        const tagClass = opt.quality === 'good' ? 'good' : opt.quality === 'ok' ? 'ok' : 'poor';
        decHtml += `
            <div class="decision-row">
                <span class="decision-element">${el.title}</span>
                <span class="decision-tag ${tagClass}">${opt.quality.toUpperCase()}</span>
            </div>
        `;
    });
    document.getElementById('sumDecisions').innerHTML = decHtml;
    
    // Button
    document.getElementById('btnNextPhase').textContent = STATE.stage === 5 ? 'View Final Results ‚Üí' : 'Next Stage ‚Üí';
    
    document.getElementById('summaryScreen').classList.add('active');
}

document.getElementById('btnNextPhase').onclick = () => {
    document.getElementById('summaryScreen').classList.remove('active');
    
    if (STATE.stage >= 5) {
        showFinalResults();
    } else {
        showTransition();
    }
};

function showTransition() {
    const nextStage = STATE.stage + 1;
    const trans = GAME_DATA.transitions[nextStage];
    
    document.getElementById('transYears').textContent = trans.years;
    document.getElementById('transYear').textContent = trans.year;
    document.getElementById('transText').innerHTML = trans.text.map(t => `<p>${t}</p>`).join('');
    
    document.getElementById('transitionScreen').classList.add('active');
}

document.getElementById('btnTransContinue').onclick = () => {
    document.getElementById('transitionScreen').classList.remove('active');
    startStage(STATE.stage + 1);
};

function showFinalResults() {
    // Calculate grade
    let good = 0;
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const opt = GAME_DATA.elements[elId].stage1.options.find(o => o.id === STATE.choices[elId]);
        if (opt.quality === 'good') good++;
    });
    
    let grade, verdict;
    if (good >= 5 && STATE.plantHealth >= 80 && STATE.totals.dose < 25) {
        grade = 'A'; verdict = 'Master Designer';
    } else if (good >= 4 && STATE.plantHealth >= 60) {
        grade = 'B'; verdict = 'Competent Engineer';
    } else if (good >= 2) {
        grade = 'C'; verdict = 'Needs Improvement';
    } else {
        grade = 'D'; verdict = 'Lessons to Learn';
    }
    
    document.getElementById('resGrade').textContent = grade;
    document.getElementById('resGrade').className = `results-grade ${grade}`;
    document.getElementById('resVerdict').textContent = verdict;
    
    document.getElementById('resTotals').innerHTML = `
        <div class="results-total"><div class="results-total-value">${formatMoney(STATE.totals.cost)}</div><div class="results-total-label">Total Cost</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.totals.dose.toFixed(1)} mSv</div><div class="results-total-label">Total Dose</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.totals.time} days</div><div class="results-total-label">Total Time</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.plantHealth}%</div><div class="results-total-label">Plant Health</div></div>
    `;
    
    document.getElementById('resultsScreen').classList.add('active');
}
</script>
</body>
</html>
