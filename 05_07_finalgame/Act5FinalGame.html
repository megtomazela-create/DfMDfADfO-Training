<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 60-Year Journey | The Nuclear House</title>
    <style>
        :root {
            --white: #f7f8fa;
            --light-grey: #d0d9e0;
            --mid-grey: #9babc2;
            --slate: #4a5d6b;
            --dark-slate: #364451;
            --deep-navy: #1f2937;
            --green: #92d050;
            --blue: #00b0f0;
            --orange: #cc5500;
            --red: #dc2626;
            --amber: #f59e0b;
            --dave-colour: #cc5500;
            --sarah-colour: #00b0f0;
            --mike-colour: #92d050;
            --janet-colour: #9babc2;
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --shadow-card: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-modal: 0 10px 25px rgba(0, 0, 0, 0.5);
            --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.4);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--deep-navy);
            color: var(--light-grey);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4 { color: var(--white); font-weight: 600; }
        button { font-family: inherit; cursor: pointer; border: none; transition: all var(--transition-fast); }
        button:focus-visible { outline: 2px solid var(--blue); outline-offset: 2px; }
        
        .app-container { display: flex; flex-direction: column; min-height: 100vh; }
        
        .header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: var(--deep-navy); border-bottom: 1px solid var(--dark-slate);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 var(--space-lg); z-index: 100;
        }
        
        .header-logo { display: flex; align-items: center; gap: var(--space-sm); color: var(--white); font-weight: 600; }
        .header-logo svg { width: 24px; height: 24px; fill: var(--blue); }
        .header-stage { font-size: 0.875rem; color: var(--mid-grey); text-transform: uppercase; letter-spacing: 0.5px; }
        .header-stage strong { color: var(--white); }
        
        .meters-bar { display: flex; gap: var(--space-lg); font-size: 0.875rem; }
        .meter { display: flex; align-items: center; gap: var(--space-xs); }
        .meter-value { color: var(--white); font-weight: 500; font-variant-numeric: tabular-nums; }
        .meter-value.good { color: var(--green); }
        .meter-value.warning { color: var(--amber); }
        .meter-value.critical { color: var(--red); }
        
        .mobile-menu-btn { display: none; background: transparent; color: var(--white); font-size: 1.5rem; padding: var(--space-sm); }
        
        .main-content { flex: 1; margin-top: 60px; padding: var(--space-xl); display: flex; flex-direction: column; align-items: center; }
        
        .screen { display: none; width: 100%; max-width: 1200px; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Title & Intro */
        .title-screen { text-align: center; padding: var(--space-2xl) 0; }
        .title-logo { margin-bottom: var(--space-xl); }
        .title-logo svg { width: 80px; height: 80px; fill: var(--blue); }
        .title-company { font-size: 0.875rem; text-transform: uppercase; letter-spacing: 2px; color: var(--mid-grey); margin-bottom: var(--space-sm); }
        .title-main { font-size: 2.5rem; color: var(--white); margin-bottom: var(--space-md); }
        .title-subtitle { font-size: 1.125rem; color: var(--light-grey); margin-bottom: var(--space-2xl); max-width: 500px; margin-left: auto; margin-right: auto; }
        
        .intro-screen { max-width: 700px; margin: 0 auto; text-align: center; }
        .intro-text { background: var(--dark-slate); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-xl); text-align: left; }
        .intro-text p { margin-bottom: var(--space-md); }
        .intro-text p:last-child { margin-bottom: 0; }
        .intro-budget { display: inline-block; background: var(--slate); padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); color: var(--green); font-weight: 600; font-size: 1.25rem; margin-top: var(--space-md); }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm); padding: var(--space-md) var(--space-xl); border-radius: var(--radius-md); font-size: 1rem; font-weight: 500; }
        .btn-primary { background: var(--blue); color: var(--deep-navy); }
        .btn-primary:hover { background: #33c0f5; box-shadow: var(--shadow-hover); transform: translateY(-1px); }
        .btn-secondary { background: var(--slate); color: var(--white); }
        .btn-secondary:hover { background: #5a6d7b; }
        .btn-success { background: var(--green); color: var(--deep-navy); }
        .btn-success:hover { background: #a2e060; }
        .btn-warning { background: var(--orange); color: var(--white); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* Design Screen */
        .design-screen { display: flex; flex-direction: column; gap: var(--space-xl); }
        .design-header { text-align: center; }
        .design-header h2 { margin-bottom: var(--space-sm); }
        
        .design-budget-bar { display: flex; justify-content: center; align-items: center; gap: var(--space-xl); background: var(--dark-slate); padding: var(--space-md) var(--space-xl); border-radius: var(--radius-md); margin-top: var(--space-md); }
        .budget-item { text-align: center; }
        .budget-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--mid-grey); }
        .budget-value { font-size: 1.5rem; font-weight: 600; color: var(--white); font-variant-numeric: tabular-nums; }
        .budget-value.remaining.good { color: var(--green); }
        .budget-value.remaining.warning { color: var(--amber); }
        .budget-value.remaining.critical { color: var(--red); }
        
        .plant-diagram { background: var(--dark-slate); border-radius: var(--radius-lg); overflow: hidden; position: relative; }
        .plant-image-wrapper { position: relative; width: 100%; }
        .plant-bg-image { width: 100%; height: auto; display: block; }
        
        .hotspot { position: absolute; cursor: pointer; transform: translate(-50%, -50%); z-index: 10; }
        .hotspot-marker { width: 48px; height: 48px; border-radius: 50%; background: rgba(0,176,240,0.25); border: 3px solid var(--blue); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; animation: hotspotPulse 2s infinite; }
        .hotspot-marker:hover { transform: scale(1.15); background: rgba(0,176,240,0.45); }
        .hotspot-marker.selected { background: rgba(146,208,80,0.35); border-color: var(--green); animation: none; }
        .hotspot-marker.selected::after { content: '‚úì'; color: var(--green); font-size: 1.2rem; font-weight: bold; }
        .hotspot-label { position: absolute; top: 54px; left: 50%; transform: translateX(-50%); background: rgba(31,41,55,0.95); color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; pointer-events: none; border: 1px solid var(--slate); }
        .hotspot-line { position: absolute; background: var(--blue); pointer-events: none; }
        .hotspot-line.selected { background: var(--green); }
        @keyframes hotspotPulse { 0%,100% { box-shadow: 0 0 0 0 rgba(0,176,240,0.4); } 50% { box-shadow: 0 0 0 14px rgba(0,176,240,0); } }
        
        .design-elements-list { display: none; flex-direction: column; gap: var(--space-md); }
        .design-element-card { background: var(--slate); border-radius: var(--radius-md); padding: var(--space-md); display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 2px solid transparent; }
        .design-element-card:hover { background: #5a6d7b; border-color: var(--blue); }
        .design-element-info { display: flex; align-items: center; gap: var(--space-md); }
        .design-element-status { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--mid-grey); display: flex; align-items: center; justify-content: center; font-size: 0.875rem; }
        .design-element-status.complete { background: var(--green); border-color: var(--green); color: var(--deep-navy); }
        .design-element-name { color: var(--white); font-weight: 500; }
        .design-element-cost { color: var(--mid-grey); font-size: 0.875rem; }
        .design-element-cost.set { color: var(--green); }
        
        .design-complete-section { text-align: center; padding: var(--space-xl) 0; }
        .design-progress { margin-bottom: var(--space-md); color: var(--mid-grey); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 200; align-items: center; justify-content: center; padding: var(--space-md); }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--dark-slate); border-radius: var(--radius-xl); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-modal); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--slate); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 1.25rem; }
        .modal-close { background: transparent; color: var(--mid-grey); font-size: 1.5rem; padding: var(--space-xs); line-height: 1; }
        .modal-close:hover { color: var(--white); }
        .modal-body { padding: var(--space-lg); }
        .modal-description { margin-bottom: var(--space-lg); color: var(--light-grey); }
        .modal-footer { padding: var(--space-lg); border-top: 1px solid var(--slate); display: flex; justify-content: flex-end; gap: var(--space-md); }
        
        .choice-cards { display: flex; flex-direction: column; gap: var(--space-md); }
        .choice-card { background: var(--slate); border-radius: var(--radius-md); padding: var(--space-md); cursor: pointer; border: 2px solid transparent; }
        .choice-card:hover { border-color: var(--blue); box-shadow: var(--shadow-hover); }
        .choice-card.selected { border-color: var(--green); background: rgba(146, 208, 80, 0.1); }
        .choice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-sm); }
        .choice-name { color: var(--white); font-weight: 500; }
        .choice-cost { background: var(--dark-slate); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); font-weight: 600; color: var(--amber); font-size: 0.875rem; }
        .choice-description { color: var(--light-grey); font-size: 0.875rem; margin-bottom: var(--space-sm); }
        .choice-tag { display: inline-block; padding: 2px var(--space-sm); border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .choice-tag.poor { background: var(--red); color: var(--white); }
        .choice-tag.good { background: var(--green); color: var(--deep-navy); }
        .choice-tag.wasteful { background: var(--orange); color: var(--white); }
        .choice-tag.ok { background: var(--amber); color: var(--deep-navy); }
        .choice-card:not(.revealed) .choice-tag { display: none; }
        
        /* Transition & Character */
        .transition-screen { text-align: center; padding: var(--space-2xl) 0; max-width: 600px; margin: 0 auto; }
        .transition-years { font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; color: var(--mid-grey); margin-bottom: var(--space-md); }
        .transition-year { font-size: 4rem; font-weight: 700; color: var(--white); margin-bottom: var(--space-xl); }
        .transition-text { background: var(--dark-slate); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-xl); text-align: left; }
        .transition-text p { margin-bottom: var(--space-md); }
        .transition-text p:last-child { margin-bottom: 0; }
        
        .character-intro { background: var(--dark-slate); border-radius: var(--radius-lg); padding: var(--space-xl); max-width: 700px; margin: 0 auto var(--space-xl); border-left: 4px solid var(--blue); }
        .character-header { display: flex; gap: var(--space-lg); margin-bottom: var(--space-lg); }
        .character-portrait { width: 80px; height: 80px; border-radius: var(--radius-md); background: var(--slate); display: flex; align-items: center; justify-content: center; font-size: 2rem; flex-shrink: 0; }
        .character-info h3 { margin-bottom: var(--space-xs); }
        .character-role { color: var(--mid-grey); font-size: 0.875rem; }
        .character-dialogue { font-size: 1.125rem; font-style: italic; color: var(--white); line-height: 1.7; }
        .character-dialogue::before { content: '"'; }
        .character-dialogue::after { content: '"'; }
        .character-intro.dave { border-left-color: var(--dave-colour); }
        
        /* Summary */
        .stage-summary { max-width: 700px; margin: 0 auto; text-align: center; }
        .summary-title { margin-bottom: var(--space-xl); }
        .summary-meters { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl); }
        .summary-meter { background: var(--dark-slate); border-radius: var(--radius-md); padding: var(--space-lg); }
        .summary-meter-icon { font-size: 1.5rem; margin-bottom: var(--space-sm); }
        .summary-meter-value { font-size: 1.5rem; font-weight: 600; color: var(--white); margin-bottom: var(--space-xs); }
        .summary-meter-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--mid-grey); }
        .summary-decisions { background: var(--dark-slate); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-xl); text-align: left; }
        .summary-decisions h4 { margin-bottom: var(--space-md); }
        .decision-list { list-style: none; }
        .decision-list li { display: flex; justify-content: space-between; padding: var(--space-sm) 0; border-bottom: 1px solid var(--slate); }
        .decision-list li:last-child { border-bottom: none; }
        .decision-name { color: var(--white); }
        .decision-choice { display: flex; align-items: center; gap: var(--space-sm); }
        .decision-choice .choice-tag { font-size: 0.625rem; }
        
        .stage-progress { display: flex; align-items: center; justify-content: center; gap: var(--space-sm); margin-bottom: var(--space-xl); }
        .stage-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--slate); }
        .stage-dot.completed { background: var(--green); }
        .stage-dot.current { background: var(--blue); box-shadow: 0 0 0 4px rgba(0, 176, 240, 0.3); }
        .stage-line { width: 40px; height: 2px; background: var(--slate); }
        .stage-line.completed { background: var(--green); }
        
        .plant-element { cursor: pointer; }
        .plant-element:hover { filter: brightness(1.2); }
        
        /* ============================================
           MINI-GAME STYLES
           ============================================ */
        .minigame-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .minigame-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }
        
        .minigame-header h2 { margin-bottom: var(--space-sm); }
        
        .minigame-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin-top: var(--space-md);
        }
        
        .minigame-stat {
            background: var(--dark-slate);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .minigame-stat-value {
            font-weight: 600;
            color: var(--white);
            font-size: 1.125rem;
        }
        
        .minigame-stat-value.warning { color: var(--amber); }
        .minigame-stat-value.danger { color: var(--red); }
        
        .minigame-area {
            background: var(--dark-slate);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            position: relative;
            overflow: hidden;
        }
        
        .minigame-canvas {
            width: 100%;
            height: 350px;
            background: #2d3a47;
            border-radius: var(--radius-md);
            position: relative;
            touch-action: none;
            user-select: none;
        }
        
        /* Pump Removal Game */
        .pump-game-svg {
            width: 100%;
            height: 100%;
        }
        
        .pump-draggable {
            cursor: grab;
            transition: filter 0.2s;
        }
        
        .pump-draggable:hover {
            filter: brightness(1.2);
        }
        
        .pump-draggable.dragging {
            cursor: grabbing;
        }
        
        .pump-target {
            stroke-dasharray: 8 4;
            animation: targetPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes targetPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .corridor-wall {
            fill: #5a5a5a;
        }
        
        .corridor-gap {
            fill: #3d4a57;
        }
        
        .corridor-label {
            fill: var(--mid-grey);
            font-size: 12px;
        }
        
        .obstacle {
            fill: var(--red);
            opacity: 0.3;
        }
        
        .obstacle.collision {
            opacity: 0.7;
            animation: collisionFlash 0.3s ease;
        }
        
        @keyframes collisionFlash {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Impossible State */
        .impossible-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(220, 38, 38, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
        }
        
        .impossible-icon {
            font-size: 4rem;
            margin-bottom: var(--space-md);
        }
        
        .impossible-text {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--red);
            margin-bottom: var(--space-sm);
        }
        
        .impossible-detail {
            color: var(--light-grey);
            text-align: center;
            max-width: 400px;
        }
        
        /* Decision Cards */
        .decision-panel {
            background: var(--dark-slate);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
        }
        
        .decision-panel h3 {
            margin-bottom: var(--space-md);
        }
        
        .decision-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .decision-option {
            background: var(--slate);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }
        
        .decision-option:hover {
            border-color: var(--blue);
            transform: translateX(4px);
        }
        
        .decision-option-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }
        
        .decision-option-title {
            color: var(--white);
            font-weight: 600;
            font-size: 1rem;
        }
        
        .decision-option-cost {
            background: var(--dark-slate);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-weight: 600;
            color: var(--amber);
            font-size: 0.875rem;
        }
        
        .decision-option-desc {
            color: var(--light-grey);
            font-size: 0.875rem;
            margin-bottom: var(--space-sm);
        }
        
        .decision-option-risk {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.8125rem;
        }
        
        .risk-indicator {
            padding: 2px var(--space-sm);
            border-radius: var(--radius-sm);
            font-weight: 500;
        }
        
        .risk-indicator.safe { background: var(--green); color: var(--deep-navy); }
        .risk-indicator.moderate { background: var(--amber); color: var(--deep-navy); }
        .risk-indicator.high { background: var(--orange); color: var(--white); }
        .risk-indicator.extreme { background: var(--red); color: var(--white); }
        
        /* Success/Failure screens */
        .outcome-screen {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .outcome-icon {
            font-size: 5rem;
            margin-bottom: var(--space-lg);
        }
        
        .outcome-title {
            font-size: 1.75rem;
            margin-bottom: var(--space-md);
        }
        
        .outcome-title.success { color: var(--green); }
        .outcome-title.failure { color: var(--red); }
        .outcome-title.partial { color: var(--amber); }
        
        .outcome-description {
            background: var(--dark-slate);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            text-align: left;
        }
        
        .outcome-description p {
            margin-bottom: var(--space-md);
        }
        
        .outcome-description p:last-child {
            margin-bottom: 0;
        }
        
        .outcome-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        
        .outcome-stat {
            background: var(--dark-slate);
            padding: var(--space-md);
            border-radius: var(--radius-md);
        }
        
        .outcome-stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--mid-grey);
            margin-bottom: var(--space-xs);
        }
        
        .outcome-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--white);
        }
        
        .outcome-stat-value.positive { color: var(--green); }
        .outcome-stat-value.negative { color: var(--red); }
        .outcome-stat-value.neutral { color: var(--amber); }
        
        /* Character comment box */
        .character-comment {
            background: var(--dark-slate);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            border-left: 4px solid var(--dave-colour);
            display: flex;
            gap: var(--space-md);
            align-items: flex-start;
        }
        
        .comment-portrait {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            background: var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .comment-content {
            flex: 1;
        }
        
        .comment-name {
            font-weight: 600;
            color: var(--white);
            margin-bottom: var(--space-xs);
        }
        
        .comment-text {
            font-style: italic;
            color: var(--light-grey);
        }
        
        /* Mobile meters dropdown */
        .mobile-meters-dropdown {
            display: none;
            position: fixed;
            top: 64px; left: 0; right: 0;
            background: var(--dark-slate);
            padding: var(--space-md);
            border-bottom: 1px solid var(--slate);
            z-index: 98;
        }
        
        .mobile-meters-dropdown.active { display: block; }
        .mobile-meters-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); }
        .mobile-meter { display: flex; align-items: center; gap: var(--space-sm); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { height: 48px; padding: 0 var(--space-md); }
            .header-logo span { display: none; }
            .meters-bar { display: none; }
            .mobile-menu-btn { display: block; }
            .main-content { margin-top: 48px; padding: var(--space-md); }
            .title-main { font-size: 1.75rem; }
            .plant-diagram { display: none; }
            .design-elements-list { display: flex; }
            .design-budget-bar { flex-wrap: wrap; gap: var(--space-md); }
            .minigame-canvas { height: 280px; }
            .minigame-stats { flex-wrap: wrap; }
            .character-header { flex-direction: column; align-items: center; text-align: center; }
            .character-comment { flex-direction: column; align-items: center; text-align: center; }
        }
        
        .text-muted { color: var(--mid-grey); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .mb-xl { margin-bottom: var(--space-xl); }
        .text-center { text-align: center; }
        
        /* Timeline Progress */
        .timeline-bar { position: fixed; top: 60px; left: 0; right: 0; height: 4px; background: var(--dark-slate); z-index: 99; }
        .timeline-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--green)); width: 0%; transition: width 0.5s ease; }
        .timeline-markers { position: absolute; top: 0; left: 0; right: 0; height: 100%; display: flex; justify-content: space-between; padding: 0 10%; }
        .timeline-marker { width: 12px; height: 12px; border-radius: 50%; background: var(--slate); border: 2px solid var(--dark-slate); transform: translateY(-4px); }
        .timeline-marker.active { background: var(--blue); border-color: var(--blue); }
        .timeline-marker.complete { background: var(--green); border-color: var(--green); }
        
        /* Hint System */
        .hint-btn { background: transparent; color: var(--amber); font-size: 1.25rem; padding: 4px 8px; border-radius: 4px; margin-left: 8px; }
        .hint-btn:hover { background: rgba(245,158,11,0.2); }
        .hint-panel { display: none; position: fixed; top: 74px; right: 20px; z-index: 150; animation: slideIn 0.3s ease; }
        .hint-panel.active { display: block; }
        .hint-content { background: var(--dark-slate); border: 1px solid var(--amber); border-radius: 12px; padding: 16px 20px; max-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .hint-content h4 { color: var(--amber); margin-bottom: 8px; font-size: 0.9rem; }
        .hint-content p { color: var(--light-grey); font-size: 0.9rem; line-height: 1.5; }
        .hint-close { position: absolute; top: 8px; right: 12px; background: transparent; color: var(--mid-grey); font-size: 1.2rem; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* Additional polish */
        .hotspot { transition: all 0.2s ease; }
        .screen { opacity: 0; animation: fadeIn 0.5s ease forwards; }
        .btn { position: relative; overflow: hidden; }
        .btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255,255,255,0.2); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.3s, height 0.3s; }
        .btn:active::after { width: 200px; height: 200px; }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-logo">
                <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg>
                <span>THE NUCLEAR HOUSE</span>
            </div>
            <div class="header-stage" id="headerStage"><strong>STAGE 1:</strong> DESIGN</div>
            <div class="meters-bar" id="metersBar">
                <div class="meter"><span>üí∞</span><span class="meter-value" id="meterBudget">¬£800,000</span></div>
                <div class="meter"><span>‚ò¢Ô∏è</span><span class="meter-value" id="meterDose">0 mSv</span></div>
                <div class="meter"><span>‚è±Ô∏è</span><span class="meter-value" id="meterTime">0 days</span></div>
                <div class="meter"><span>‚ù§Ô∏è</span><span class="meter-value" id="meterHealth">100%</span></div>
            </div>
            <button class="mobile-menu-btn" id="mobileMenuBtn">‚â°</button>
            <button class="hint-btn" id="hintBtn" title="Get a hint">üí°</button>
        </header>
        
        <!-- Hint Panel -->
        <div class="hint-panel" id="hintPanel">
            <div class="hint-content">
                <button class="hint-close" id="hintClose">√ó</button>
                <h4>üí° Design Tip</h4>
                <p id="hintText">Click on an element to make your design choice.</p>
            </div>
        </div>
        
        <div class="mobile-meters-dropdown" id="mobileMeters">
            <div class="mobile-meters-grid">
                <div class="mobile-meter"><span>üí∞</span><span id="mobileBudget">¬£800k</span></div>
                <div class="mobile-meter"><span>‚ò¢Ô∏è</span><span id="mobileDose">0 mSv</span></div>
                <div class="mobile-meter"><span>‚è±Ô∏è</span><span id="mobileTime">0 days</span></div>
                <div class="mobile-meter"><span>‚ù§Ô∏è</span><span id="mobileHealth">100%</span></div>
            </div>
        </div>
        
        <!-- Timeline Progress Bar -->
        <div class="timeline-bar" id="timelineBar">
            <div class="timeline-fill" id="timelineFill"></div>
            <div class="timeline-markers">
                <div class="timeline-marker active" title="2025 Design"></div>
                <div class="timeline-marker" title="2040 Maintenance"></div>
                <div class="timeline-marker" title="2055 Inspection"></div>
                <div class="timeline-marker" title="2070 Operations"></div>
                <div class="timeline-marker" title="2085 Decommissioning"></div>
            </div>
        </div>
        
        <main class="main-content" style="margin-top: 64px;">
            <!-- Title Screen -->
            <section class="screen title-screen active" id="screenTitle">
                <div class="title-logo"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg></div>
                <p class="title-company">The Nuclear House presents</p>
                <h1 class="title-main">The 60-Year Journey</h1>
                <p class="title-subtitle">An interactive experience in design for decommissioning. Your decisions today affect people for decades to come.</p>
                <button class="btn btn-primary" id="btnStart">Begin Journey</button>
            </section>
            
            <!-- Intro Screen -->
            <section class="screen intro-screen" id="screenIntro">
                <div class="intro-text">
                    <p><strong>Welcome to The Nuclear House.</strong></p>
                    <p>You've just been assigned your first major project: <strong>Section 4B</strong> of Thornbury Point Nuclear Power Station.</p>
                    <p>Primary coolant system auxiliaries. Pumps, pipes, welds, and a control room interface.</p>
                    <p>It's not glamorous. But it's important.</p>
                    <p>Your design will be built, operated, inspected, and eventually decommissioned over the next <strong>sixty years</strong>.</p>
                    <p>The decisions you make today will affect people you'll never meet, solving problems you can't yet imagine.</p>
                    <div class="intro-budget">Your budget: ¬£800,000</div>
                </div>
                <button class="btn btn-primary" id="btnBeginDesign">Begin Design ‚Üí</button>
            </section>
            
            <!-- Stage 1: Design Screen -->
            <section class="screen design-screen" id="screenDesign">
                <div class="design-header">
                    <h2>Section 4B Design Phase</h2>
                    <p class="text-muted">Click on each element to make your design selection</p>
                    <div class="design-budget-bar">
                        <div class="budget-item"><div class="budget-label">Total Budget</div><div class="budget-value">¬£800,000</div></div>
                        <div class="budget-item"><div class="budget-label">Spent</div><div class="budget-value" id="designSpent">¬£0</div></div>
                        <div class="budget-item"><div class="budget-label">Remaining</div><div class="budget-value remaining good" id="designRemaining">¬£800,000</div></div>
                    </div>
                </div>
                
                <div class="plant-diagram" id="plantDiagram">
                    <div class="plant-image-wrapper">
                        <img src="gamebackground.png" alt="Section 4B Layout" class="plant-bg-image">
                        
                        <!-- Pump Access - on the blue pump -->
                        <div class="hotspot" data-element="pumpAccess" style="left: 18%; top: 52%;">
                            <div class="hotspot-marker" id="markerPump"></div>
                            <span class="hotspot-label">Pump Access</span>
                        </div>
                        
                        <!-- Weld Clearance - at the orange glow weld -->
                        <div class="hotspot" data-element="weldClearance" style="left: 42%; top: 46%;">
                            <div class="hotspot-marker" id="markerWeld"></div>
                            <span class="hotspot-label">Weld Clearance</span>
                        </div>
                        
                        <!-- Control Panel - on the panel on right wall -->
                        <div class="hotspot" data-element="controlPanel" style="left: 85%; top: 42%;">
                            <div class="hotspot-marker" id="markerControl"></div>
                            <span class="hotspot-label">Control Panel</span>
                        </div>
                        
                        <!-- Pipe Connections - at the flanged joint -->
                        <div class="hotspot" data-element="pipeConnections" style="left: 56%; top: 52%;">
                            <div class="hotspot-marker" id="markerConnections"></div>
                            <span class="hotspot-label">Pipe Connections</span>
                        </div>
                        
                        <!-- Pipe Routing - at floor duct -->
                        <div class="hotspot" data-element="pipeRouting" style="left: 62%; top: 82%;">
                            <div class="hotspot-marker" id="markerRouting"></div>
                            <span class="hotspot-label">Pipe Routing</span>
                        </div>
                        
                        <!-- Material Spec - on pipe body -->
                        <div class="hotspot" data-element="materialSpec" style="left: 32%; top: 58%;">
                            <div class="hotspot-marker" id="markerMaterial"></div>
                            <span class="hotspot-label">Material Spec</span>
                        </div>
                    </div>
                </div>
                
                <div class="design-elements-list" id="designElementsList">
                    <div class="design-element-card" data-element="pumpAccess"><div class="design-element-info"><div class="design-element-status" id="listStatusPump"></div><span class="design-element-name">Pump Access</span></div><div class="design-element-cost" id="listCostPump">Not set</div></div>
                    <div class="design-element-card" data-element="weldClearance"><div class="design-element-info"><div class="design-element-status" id="listStatusWeld"></div><span class="design-element-name">Weld Clearance</span></div><div class="design-element-cost" id="listCostWeld">Not set</div></div>
                    <div class="design-element-card" data-element="controlPanel"><div class="design-element-info"><div class="design-element-status" id="listStatusControl"></div><span class="design-element-name">Control Panel Layout</span></div><div class="design-element-cost" id="listCostControl">Not set</div></div>
                    <div class="design-element-card" data-element="pipeConnections"><div class="design-element-info"><div class="design-element-status" id="listStatusConnections"></div><span class="design-element-name">Pipe Connections</span></div><div class="design-element-cost" id="listCostConnections">Not set</div></div>
                    <div class="design-element-card" data-element="pipeRouting"><div class="design-element-info"><div class="design-element-status" id="listStatusRouting"></div><span class="design-element-name">Pipe Routing</span></div><div class="design-element-cost" id="listCostRouting">Not set</div></div>
                    <div class="design-element-card" data-element="materialSpec"><div class="design-element-info"><div class="design-element-status" id="listStatusMaterial"></div><span class="design-element-name">Material Specification</span></div><div class="design-element-cost" id="listCostMaterial">Not set</div></div>
                </div>
                
                <div class="design-complete-section">
                    <p class="design-progress" id="designProgress">0 of 6 elements selected</p>
                    <button class="btn btn-success" id="btnCompleteDesign" disabled>Complete Design ‚Üí</button>
                </div>
            </section>
            
            <!-- Design Summary -->
            <section class="screen stage-summary" id="screenDesignSummary">
                <div class="stage-progress">
                    <div class="stage-dot completed"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div>
                </div>
                <h2 class="summary-title">Design Complete</h2>
                <div class="summary-meters">
                    <div class="summary-meter"><div class="summary-meter-icon">üí∞</div><div class="summary-meter-value" id="summaryBudgetSpent">¬£0</div><div class="summary-meter-label">Design Spend</div></div>
                    <div class="summary-meter"><div class="summary-meter-icon">üíµ</div><div class="summary-meter-value" id="summaryBudgetRemaining">¬£800,000</div><div class="summary-meter-label">Remaining</div></div>
                </div>
                <div class="summary-decisions"><h4>Your Design Decisions</h4><ul class="decision-list" id="decisionList"></ul></div>
                <p class="text-muted mb-lg">Your drawings have been submitted for approval. Construction will begin next year.</p>
                <button class="btn btn-primary" id="btnContinueTo2040">Continue to 2040 ‚Üí</button>
            </section>
            
            <!-- Transition Screen -->
            <section class="screen transition-screen" id="screenTransition">
                <p class="transition-years" id="transitionYears">15 YEARS LATER</p>
                <h2 class="transition-year" id="transitionYear">2040</h2>
                <div class="transition-text" id="transitionText"></div>
                <button class="btn btn-primary" id="btnContinueTransition">Continue ‚Üí</button>
            </section>
            
            <!-- Character Intro -->
            <section class="screen" id="screenCharacter">
                <div class="character-intro dave" id="characterIntro">
                    <div class="character-header">
                        <div class="character-portrait" id="characterPortrait">üë∑</div>
                        <div class="character-info"><h3 id="characterName">Dave Morton</h3><p class="character-role" id="characterRole">Maintenance Supervisor</p></div>
                    </div>
                    <p class="character-dialogue" id="characterDialogue">Right then. Section 4B. First major outage. Let's see what we're working with.</p>
                </div>
                <div class="text-center"><button class="btn btn-primary" id="btnBeginStage">Begin Stage ‚Üí</button></div>
            </section>
            
            <!-- Stage 2: Mini-game -->
            <section class="screen" id="screenMinigame">
                <div class="minigame-container">
                    <div class="minigame-header">
                        <h2 id="minigameTitle">Pump Removal</h2>
                        <p class="text-muted" id="minigameInstructions">Drag the pump through the corridor to the removal bay</p>
                        <div class="minigame-stats">
                            <div class="minigame-stat"><span>‚è±Ô∏è</span><span class="minigame-stat-value" id="minigameTimer">30s</span></div>
                            <div class="minigame-stat"><span>‚ò¢Ô∏è</span><span class="minigame-stat-value" id="minigameDose">+0.0 mSv</span></div>
                        </div>
                    </div>
                    
                    <div class="minigame-area">
                        <div class="minigame-canvas" id="minigameCanvas"></div>
                        <div class="impossible-overlay" id="impossibleOverlay" style="display: none;">
                            <div class="impossible-icon">üö´</div>
                            <div class="impossible-text">IMPOSSIBLE</div>
                            <div class="impossible-detail" id="impossibleDetail">The pump is 2.1m wide. The gap is only 1.8m. It physically cannot fit.</div>
                        </div>
                    </div>
                    
                    <div class="decision-panel" id="decisionPanel" style="display: none;">
                        <h3>What do you want to do?</h3>
                        <div class="decision-options" id="decisionOptions"></div>
                    </div>
                </div>
            </section>
            
            <!-- Outcome Screen -->
            <section class="screen outcome-screen" id="screenOutcome">
                <div class="outcome-icon" id="outcomeIcon">‚úì</div>
                <h2 class="outcome-title" id="outcomeTitle">Task Complete</h2>
                
                <div class="character-comment" id="outcomeComment">
                    <div class="comment-portrait">üë∑</div>
                    <div class="comment-content">
                        <div class="comment-name">Dave Morton</div>
                        <div class="comment-text" id="outcomeCommentText">Well, that went about as well as could be expected.</div>
                    </div>
                </div>
                
                <div class="outcome-description" id="outcomeDescription"></div>
                
                <div class="outcome-stats" id="outcomeStats"></div>
                
                <button class="btn btn-primary" id="btnContinueFromOutcome">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 2 Summary -->
            <section class="screen stage-summary" id="screenStage2Summary">
                <div class="stage-progress">
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div>
                </div>
                <h2 class="summary-title">Maintenance Complete</h2>
                <div class="summary-meters" id="stage2SummaryMeters"></div>
                <div class="summary-decisions" id="stage2Events"><h4>Stage Events</h4><ul class="decision-list" id="stage2EventList"></ul></div>
                <p class="text-muted mb-lg">The outage is complete. Section 4B returns to service.</p>
                <button class="btn btn-primary" id="btnContinueTo2055">Continue to 2055 ‚Üí</button>
            </section>
            
            <!-- Placeholder for future stages -->
            <section class="screen" id="screenPlaceholder">
                <div class="text-center">
                    <h2>Stage 3-5 Coming Soon</h2>
                    <p class="text-muted mb-xl">Inspection, Operations, and Decommissioning stages will be implemented in Phase 3.</p>
                    <button class="btn btn-secondary" id="btnRestart">‚Üê Restart Game</button>
                </div>
            </section>
            
            <!-- Stage 3: Transition to 2055 -->
            <section class="screen transition-screen" id="screenTransition3">
                <p class="transition-years">15 YEARS LATER</p>
                <h2 class="transition-year">2055</h2>
                <div class="transition-text">
                    <p>Thornbury Point is approaching mid-life.</p>
                    <p>Thirty years of neutron bombardment. Thermal cycles. Chemical exposure.</p>
                    <p>Time to look inside. Every weld. Every pressure boundary.</p>
                    <p>The in-service inspection campaign begins.</p>
                </div>
                <button class="btn btn-primary" id="btnContinueTransition3">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 3: Sarah Character -->
            <section class="screen" id="screenCharacter3">
                <div class="character-intro sarah" id="characterIntro3">
                    <div class="character-header">
                        <div class="character-portrait">üë©‚Äçüî¨</div>
                        <div class="character-info"><h3>Sarah Okonkwo</h3><p class="character-role">Principal Inspector</p></div>
                    </div>
                    <p class="character-dialogue" id="sarahDialogue">In-service inspection. Every weld, every pressure boundary. The safety case says we can reach them all. Let's find out.</p>
                </div>
                <div class="text-center"><button class="btn btn-primary" id="btnBeginStage3">Begin Inspection ‚Üí</button></div>
            </section>
            
            <!-- Stage 3: Mini-game -->
            <section class="screen" id="screenMinigame3">
                <div class="minigame-container">
                    <div class="minigame-header">
                        <h2>UT Weld Inspection</h2>
                        <p class="text-muted" id="minigame3Instructions">Trace the probe along the weld to achieve full coverage</p>
                        <div class="minigame-stats">
                            <div class="minigame-stat"><span>üìä</span><span class="minigame-stat-value" id="coverageDisplay">0%</span></div>
                            <div class="minigame-stat"><span>‚ò¢Ô∏è</span><span class="minigame-stat-value" id="minigame3Dose">+0.0 mSv</span></div>
                        </div>
                    </div>
                    <div class="minigame-area">
                        <div class="minigame-canvas" id="minigame3Canvas"></div>
                        <div class="impossible-overlay" id="impossibleOverlay3" style="display: none;">
                            <div class="impossible-icon">üö´</div>
                            <div class="impossible-text">INSUFFICIENT CLEARANCE</div>
                            <div class="impossible-detail" id="impossibleDetail3">The UT probe requires 80mm clearance. Only 50mm is available. Maximum achievable coverage: 60%.</div>
                        </div>
                    </div>
                    <div class="decision-panel" id="decisionPanel3" style="display: none;">
                        <h3>What do you want to do?</h3>
                        <div class="decision-options" id="decisionOptions3"></div>
                    </div>
                </div>
            </section>
            
            <!-- Stage 3: Outcome -->
            <section class="screen outcome-screen" id="screenOutcome3">
                <div class="outcome-icon" id="outcomeIcon3">‚úì</div>
                <h2 class="outcome-title" id="outcomeTitle3">Inspection Complete</h2>
                <div class="character-comment" style="border-color: var(--sarah-colour);">
                    <div class="comment-portrait">üë©‚Äçüî¨</div>
                    <div class="comment-content">
                        <div class="comment-name">Sarah Okonkwo</div>
                        <div class="comment-text" id="outcomeComment3">The welds are in acceptable condition.</div>
                    </div>
                </div>
                <div class="outcome-description" id="outcomeDescription3"></div>
                <div class="outcome-stats" id="outcomeStats3"></div>
                <button class="btn btn-primary" id="btnContinueFromOutcome3">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 3 Summary -->
            <section class="screen stage-summary" id="screenStage3Summary">
                <div class="stage-progress">
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div>
                </div>
                <h2 class="summary-title">Inspection Complete</h2>
                <div class="summary-meters" id="stage3SummaryMeters"></div>
                <div class="summary-decisions"><h4>Inspection Results</h4><ul class="decision-list" id="stage3EventList"></ul></div>
                <p class="text-muted mb-lg">The inspection campaign is complete. Plant returns to operation.</p>
                <button class="btn btn-primary" id="btnContinueTo2070">Continue to 2070 ‚Üí</button>
            </section>
            
            <!-- Stage 4: Transition to 2070 -->
            <section class="screen transition-screen" id="screenTransition4">
                <p class="transition-years">15 YEARS LATER</p>
                <h2 class="transition-year">2070</h2>
                <div class="transition-text">
                    <p>Forty-five years of operation.</p>
                    <p>The control room has seen hundreds of shift handovers. Thousands of routine checks.</p>
                    <p>Tonight is not routine.</p>
                    <p>An alarm sounds in Section 4B.</p>
                </div>
                <button class="btn btn-primary" id="btnContinueTransition4">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 4: Mike Character -->
            <section class="screen" id="screenCharacter4">
                <div class="character-intro mike" id="characterIntro4">
                    <div class="character-header">
                        <div class="character-portrait">üë®‚Äçüíº</div>
                        <div class="character-info"><h3>Mike Brennan</h3><p class="character-role">Shift Operations Manager</p></div>
                    </div>
                    <p class="character-dialogue" id="mikeDialogue">Alarm in Section 4B. Night shift, skeleton crew. Let's see what we're dealing with.</p>
                </div>
                <div class="text-center"><button class="btn btn-primary" id="btnBeginStage4">Begin Response ‚Üí</button></div>
            </section>
            
            <!-- Stage 4: Mini-game -->
            <section class="screen" id="screenMinigame4">
                <div class="minigame-container">
                    <div class="minigame-header">
                        <h2>Emergency Response</h2>
                        <p class="text-muted" id="minigame4Instructions">Find and activate the correct controls in sequence</p>
                        <div class="minigame-stats">
                            <div class="minigame-stat"><span>‚è±Ô∏è</span><span class="minigame-stat-value" id="minigame4Timer">60s</span></div>
                            <div class="minigame-stat"><span>üìã</span><span class="minigame-stat-value" id="sequenceProgress">0/4</span></div>
                        </div>
                    </div>
                    <div class="minigame-area">
                        <div class="minigame-canvas" id="minigame4Canvas"></div>
                    </div>
                    <div class="decision-panel" id="decisionPanel4" style="display: none;">
                        <h3>Time's up! What now?</h3>
                        <div class="decision-options" id="decisionOptions4"></div>
                    </div>
                </div>
            </section>
            
            <!-- Stage 4: Outcome -->
            <section class="screen outcome-screen" id="screenOutcome4">
                <div class="outcome-icon" id="outcomeIcon4">‚úì</div>
                <h2 class="outcome-title" id="outcomeTitle4">Event Resolved</h2>
                <div class="character-comment" style="border-color: var(--mike-colour);">
                    <div class="comment-portrait">üë®‚Äçüíº</div>
                    <div class="comment-content">
                        <div class="comment-name">Mike Brennan</div>
                        <div class="comment-text" id="outcomeComment4">That was close. But we handled it.</div>
                    </div>
                </div>
                <div class="outcome-description" id="outcomeDescription4"></div>
                <div class="outcome-stats" id="outcomeStats4"></div>
                <button class="btn btn-primary" id="btnContinueFromOutcome4">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 4 Summary -->
            <section class="screen stage-summary" id="screenStage4Summary">
                <div class="stage-progress">
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line"></div>
                    <div class="stage-dot"></div>
                </div>
                <h2 class="summary-title">Operations Complete</h2>
                <div class="summary-meters" id="stage4SummaryMeters"></div>
                <div class="summary-decisions"><h4>Stage Events</h4><ul class="decision-list" id="stage4EventList"></ul></div>
                <p class="text-muted mb-lg">The emergency is resolved. But the plant's days are numbered.</p>
                <button class="btn btn-primary" id="btnContinueTo2085">Continue to 2085 ‚Üí</button>
            </section>
            
            <!-- Stage 5: Transition to 2085 -->
            <section class="screen transition-screen" id="screenTransition5">
                <p class="transition-years">15 YEARS LATER</p>
                <h2 class="transition-year">2085</h2>
                <div class="transition-text">
                    <p>The reactor is shut down for the final time.</p>
                    <p>Sixty years of operation. Millions of megawatt-hours. Careers begun and ended.</p>
                    <p>Now comes the long task of putting it all back the way it was.</p>
                    <p>Decommissioning begins.</p>
                </div>
                <button class="btn btn-primary" id="btnContinueTransition5">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 5: Janet Character -->
            <section class="screen" id="screenCharacter5">
                <div class="character-intro janet" id="characterIntro5">
                    <div class="character-header">
                        <div class="character-portrait">üë©‚Äçüîß</div>
                        <div class="character-info"><h3>Janet Cole</h3><p class="character-role">Decommissioning Project Lead</p></div>
                    </div>
                    <p class="character-dialogue" id="janetDialogue">Sixty years. Let's see what 2025 left us. I've been doing this long enough to know what to expect.</p>
                </div>
                <div class="text-center"><button class="btn btn-primary" id="btnBeginStage5">Begin Decommissioning ‚Üí</button></div>
            </section>
            
            <!-- Stage 5: Mini-game (3 tasks) -->
            <section class="screen" id="screenMinigame5">
                <div class="minigame-container">
                    <div class="minigame-header">
                        <h2 id="minigame5Title">Pipe Disassembly</h2>
                        <p class="text-muted" id="minigame5Instructions">Remove the pipe connections</p>
                        <div class="minigame-stats">
                            <div class="minigame-stat"><span>üì¶</span><span class="minigame-stat-value" id="wasteGenerated">0 tonnes</span></div>
                            <div class="minigame-stat"><span>‚ò¢Ô∏è</span><span class="minigame-stat-value" id="minigame5Dose">+0.0 mSv</span></div>
                        </div>
                    </div>
                    <div class="minigame-area">
                        <div class="minigame-canvas" id="minigame5Canvas"></div>
                        <div class="impossible-overlay" id="impossibleOverlay5" style="display: none;">
                            <div class="impossible-icon">üö´</div>
                            <div class="impossible-text" id="impossibleText5">CANNOT PROCEED</div>
                            <div class="impossible-detail" id="impossibleDetail5"></div>
                        </div>
                    </div>
                    <div class="decision-panel" id="decisionPanel5" style="display: none;">
                        <h3 id="decision5Title">What do you want to do?</h3>
                        <div class="decision-options" id="decisionOptions5"></div>
                    </div>
                </div>
            </section>
            
            <!-- Stage 5: Outcome -->
            <section class="screen outcome-screen" id="screenOutcome5">
                <div class="outcome-icon" id="outcomeIcon5">‚úì</div>
                <h2 class="outcome-title" id="outcomeTitle5">Task Complete</h2>
                <div class="character-comment" style="border-color: var(--janet-colour);">
                    <div class="comment-portrait">üë©‚Äçüîß</div>
                    <div class="comment-content">
                        <div class="comment-name">Janet Cole</div>
                        <div class="comment-text" id="outcomeComment5">Another day, another piece of history dismantled.</div>
                    </div>
                </div>
                <div class="outcome-description" id="outcomeDescription5"></div>
                <div class="outcome-stats" id="outcomeStats5"></div>
                <button class="btn btn-primary" id="btnContinueFromOutcome5">Continue ‚Üí</button>
            </section>
            
            <!-- Stage 5 Summary -->
            <section class="screen stage-summary" id="screenStage5Summary">
                <div class="stage-progress">
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div><div class="stage-line completed"></div>
                    <div class="stage-dot completed"></div>
                </div>
                <h2 class="summary-title">Decommissioning Complete</h2>
                <div class="summary-meters" id="stage5SummaryMeters"></div>
                <div class="summary-decisions"><h4>Decommissioning Tasks</h4><ul class="decision-list" id="stage5EventList"></ul></div>
                <p class="text-muted mb-lg">Section 4B has been returned to greenfield status.</p>
                <button class="btn btn-primary" id="btnViewResults">View Final Results ‚Üí</button>
            </section>
            
            <!-- Final Results -->
            <section class="screen" id="screenResults">
                <div class="text-center">
                    <h2 class="mb-lg">The 60-Year Journey Complete</h2>
                    <div class="outcome-icon" id="resultsStars">‚≠ê‚≠ê‚≠ê</div>
                    <h3 id="resultsRating" style="margin-bottom: 24px;">Competent Engineer</h3>
                    
                    <div class="outcome-description">
                        <h4 style="margin-bottom: 16px;">Final Totals</h4>
                        <div class="outcome-stats" id="finalStats"></div>
                        <div id="resultsMessage" style="margin-top: 16px;"></div>
                    </div>
                    
                    <button class="btn btn-primary" id="btnPlayAgain" style="margin-top: 24px;">Play Again</button>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header"><h3 id="modalTitle">Pump Access</h3><button class="modal-close" id="modalClose">√ó</button></div>
            <div class="modal-body">
                <p class="modal-description" id="modalDescription"></p>
                <div class="choice-cards" id="choiceCards"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelChoice">Cancel</button>
                <button class="btn btn-primary" id="btnConfirmChoice" disabled>Confirm Selection</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GAME STATE
        // ============================================
        const GameState = {
            currentScreen: 'title',
            currentStage: 1,
            designChoices: { pumpAccess: null, weldClearance: null, controlPanel: null, pipeConnections: null, pipeRouting: null, materialSpec: null },
            meters: {
                budgetSpent: 0,
                stageBudgets: { design: 800000, maintenance: 400000, inspection: 250000, operations: 200000, decommissioning: 1200000 },
                dose: 0,
                time: 0,
                plantHealth: 100
            },
            stage2: { budgetUsed: 0, doseAccrued: 0, timeUsed: 0, events: [], outcome: null },
            stage3: { budgetUsed: 0, doseAccrued: 0, timeUsed: 0, events: [], coverage: 0 },
            stage4: { budgetUsed: 0, doseAccrued: 0, timeUsed: 0, events: [], responseTime: 0 },
            stage5: { budgetUsed: 0, doseAccrued: 0, wasteGenerated: 0, events: [], tasksCompleted: 0 },
            incidents: [],
            injuries: 0,
            fatalities: 0
        };
        
        // ============================================
        // DESIGN ELEMENTS DATA
        // ============================================
        const DesignElements = {
            pumpAccess: {
                title: 'Pump Access',
                description: 'How should the primary coolant pump be positioned within Section 4B?',
                options: [
                    { id: 'corner', name: 'Corner Position', description: 'Pump tucked in corner to maximise floor space. Gap between structural beam and wall is 1.8m.', cost: 120000, quality: 'poor', qualityLabel: 'POOR' },
                    { id: 'openBay', name: 'Open Bay', description: 'Pump in open bay with 2m clearance all sides, under crane rails. Full maintenance access.', cost: 150000, quality: 'good', qualityLabel: 'GOOD' },
                    { id: 'dedicatedRoom', name: 'Dedicated Shielded Room', description: 'Pump in dedicated shielded room with airlock. Over-specified for this application.', cost: 290000, quality: 'wasteful', qualityLabel: 'WASTEFUL' }
                ]
            },
            weldClearance: {
                title: 'Weld Clearance',
                description: 'What clearance should be provided around pipe welds for inspection access?',
                options: [
                    { id: '50mm', name: '50mm (Code Minimum)', description: 'Minimum clearance permitted by design code.', cost: 90000, quality: 'poor', qualityLabel: 'POOR' },
                    { id: '150mm', name: '150mm Clearance', description: 'Adequate clearance for all standard inspection probes.', cost: 95000, quality: 'good', qualityLabel: 'GOOD' },
                    { id: '300mm', name: '300mm + Scaffolding', description: 'Generous clearance with permanent scaffolding. Scaffolding becomes contaminated.', cost: 180000, quality: 'wasteful', qualityLabel: 'WASTEFUL' }
                ]
            },
            controlPanel: {
                title: 'Control Panel Layout',
                description: 'How should the Section 4B control panel be organised?',
                options: [
                    { id: 'systemBased', name: 'System-Based Layout', description: 'Controls grouped by system. Logical for engineers.', cost: 85000, quality: 'poor', qualityLabel: 'POOR' },
                    { id: 'taskBased', name: 'Task-Based Layout', description: 'Controls grouped by operator workflow. Emergency sequence flows left-to-right.', cost: 95000, quality: 'good', qualityLabel: 'GOOD' },
                    { id: 'touchscreen', name: 'Touchscreen Interface', description: 'Sleek touchscreen displays. Impressive in demonstrations.', cost: 180000, quality: 'poor', qualityLabel: 'POOR' }
                ]
            },
            pipeConnections: {
                title: 'Pipe Connections',
                description: 'How should pipe joints be designed?',
                options: [
                    { id: 'flanged', name: 'Flanged Connections', description: 'Bolted flanges at all joints. Easy to disassemble.', cost: 160000, quality: 'good', qualityLabel: 'GOOD' },
                    { id: 'mixed', name: 'Mixed Flanged/Welded', description: 'Flanges at accessible points, welded elsewhere.', cost: 170000, quality: 'ok', qualityLabel: 'OK' },
                    { id: 'welded', name: 'All Welded Joints', description: 'Continuous welded construction. Maximum integrity.', cost: 180000, quality: 'poor', qualityLabel: 'POOR' }
                ]
            },
            pipeRouting: {
                title: 'Pipe Routing',
                description: 'How should pipes be routed through the concrete structure?',
                options: [
                    { id: 'embedded', name: 'Embedded in Concrete', description: 'Pipes cast directly into structural concrete.', cost: 140000, quality: 'poor', qualityLabel: 'POOR' },
                    { id: 'ducted', name: 'Accessible Ducts', description: 'Pipes run through removable duct covers.', cost: 165000, quality: 'good', qualityLabel: 'GOOD' },
                    { id: 'tunnel', name: 'Walk-In Tunnel', description: 'Large accessible tunnel for all services.', cost: 280000, quality: 'wasteful', qualityLabel: 'WASTEFUL' }
                ]
            },
            materialSpec: {
                title: 'Material Specification',
                description: 'What material for primary circuit pipework?',
                options: [
                    { id: 'standardSS', name: 'Standard Stainless Steel', description: 'Type 304/316, ~2,500 ppm cobalt. Industry standard.', cost: 200000, quality: 'poor', qualityLabel: 'POOR' },
                    { id: 'lowCobalt', name: 'Low-Cobalt Stainless', description: 'Cobalt below 500 ppm. Reduces activation.', cost: 250000, quality: 'good', qualityLabel: 'GOOD' },
                    { id: 'exoticAlloy', name: 'Exotic Nickel Alloy', description: 'High-performance nickel alloy. Premium specification.', cost: 400000, quality: 'poor', qualityLabel: 'POOR' }
                ]
            }
        };
        
        // ============================================
        // DOM REFERENCES
        // ============================================
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatCurrency(n) { return '¬£' + n.toLocaleString('en-GB'); }
        
        function showScreen(id) {
            $$('.screen').forEach(s => s.classList.remove('active'));
            const el = $('screen' + id.charAt(0).toUpperCase() + id.slice(1));
            if (el) el.classList.add('active');
            GameState.currentScreen = id;
            updateTimeline(id);
        }
        
        function updateTimeline(screenId) {
            const markers = $$('.timeline-marker');
            const fill = $('timelineFill');
            let stage = 0;
            
            if (screenId.includes('design') || screenId === 'intro' || screenId === 'title') stage = 0;
            else if (screenId.includes('2') || screenId.includes('transition') && !screenId.includes('3')) stage = 1;
            else if (screenId.includes('3')) stage = 2;
            else if (screenId.includes('4')) stage = 3;
            else if (screenId.includes('5') || screenId === 'results') stage = 4;
            
            markers.forEach((m, i) => {
                m.classList.remove('active', 'complete');
                if (i < stage) m.classList.add('complete');
                else if (i === stage) m.classList.add('active');
            });
            
            fill.style.width = (stage * 25) + '%';
        }
        
        function updateMeters() {
            const designBudget = GameState.meters.stageBudgets.design;
            const spent = GameState.meters.budgetSpent;
            const remaining = designBudget - spent;
            
            $('designSpent').textContent = formatCurrency(spent);
            $('designRemaining').textContent = formatCurrency(remaining);
            $('designRemaining').classList.remove('good', 'warning', 'critical');
            $('designRemaining').classList.add(remaining < 0 ? 'critical' : remaining < designBudget * 0.2 ? 'warning' : 'good');
            
            $('meterBudget').textContent = formatCurrency(remaining);
            $('meterDose').textContent = GameState.meters.dose.toFixed(1) + ' mSv';
            $('meterTime').textContent = GameState.meters.time + ' days';
            $('meterHealth').textContent = GameState.meters.plantHealth + '%';
            
            // Mobile meters
            if ($('mobileBudget')) $('mobileBudget').textContent = formatCurrency(remaining);
            if ($('mobileDose')) $('mobileDose').textContent = GameState.meters.dose.toFixed(1) + ' mSv';
            if ($('mobileTime')) $('mobileTime').textContent = GameState.meters.time + ' days';
            if ($('mobileHealth')) $('mobileHealth').textContent = GameState.meters.plantHealth + '%';
        }
        
        function updateDesignProgress() {
            const count = Object.values(GameState.designChoices).filter(c => c).length;
            $('designProgress').textContent = `${count} of 6 elements selected`;
            $('btnCompleteDesign').disabled = count < 6;
        }
        
        function updateElementStatus(key, optionId) {
            const opt = DesignElements[key].options.find(o => o.id === optionId);
            const markerMap = { pumpAccess: 'markerPump', weldClearance: 'markerWeld', controlPanel: 'markerControl', pipeConnections: 'markerConnections', pipeRouting: 'markerRouting', materialSpec: 'markerMaterial' };
            const listStatusMap = { pumpAccess: 'listStatusPump', weldClearance: 'listStatusWeld', controlPanel: 'listStatusControl', pipeConnections: 'listStatusConnections', pipeRouting: 'listStatusRouting', materialSpec: 'listStatusMaterial' };
            const listCostMap = { pumpAccess: 'listCostPump', weldClearance: 'listCostWeld', controlPanel: 'listCostControl', pipeConnections: 'listCostConnections', pipeRouting: 'listCostRouting', materialSpec: 'listCostMaterial' };
            
            const markerEl = $(markerMap[key]);
            if (markerEl) { markerEl.classList.add('selected'); }
            
            const listEl = $(listStatusMap[key]);
            if (listEl) { listEl.classList.add('complete'); listEl.textContent = '‚úì'; }
            
            const costEl = $(listCostMap[key]);
            if (costEl) { costEl.textContent = formatCurrency(opt.cost); costEl.classList.add('set'); }
        }
        
        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        let currentElement = null, selectedOption = null;
        
        function openModal(key) {
            currentElement = key;
            selectedOption = GameState.designChoices[key];
            const el = DesignElements[key];
            
            $('modalTitle').textContent = el.title;
            $('modalDescription').textContent = el.description;
            $('choiceCards').innerHTML = '';
            
            el.options.forEach(opt => {
                const card = document.createElement('div');
                card.className = 'choice-card' + (selectedOption === opt.id ? ' selected revealed' : '');
                card.dataset.optionId = opt.id;
                card.innerHTML = `<div class="choice-header"><span class="choice-name">${opt.name}</span><span class="choice-cost">${formatCurrency(opt.cost)}</span></div><p class="choice-description">${opt.description}</p><span class="choice-tag ${opt.quality}">${opt.qualityLabel}</span>`;
                card.onclick = () => selectOption(opt.id);
                $('choiceCards').appendChild(card);
            });
            
            $('btnConfirmChoice').disabled = !selectedOption;
            $('modalOverlay').classList.add('active');
        }
        
        function closeModal() {
            $('modalOverlay').classList.remove('active');
            currentElement = selectedOption = null;
        }
        
        function selectOption(id) {
            selectedOption = id;
            $$('.choice-card').forEach(c => {
                c.classList.remove('selected');
                if (c.dataset.optionId === id) c.classList.add('selected', 'revealed');
            });
            $('btnConfirmChoice').disabled = false;
        }
        
        function confirmChoice() {
            if (!currentElement || !selectedOption) return;
            const el = DesignElements[currentElement];
            const opt = el.options.find(o => o.id === selectedOption);
            const prev = GameState.designChoices[currentElement];
            
            if (prev) {
                const prevOpt = el.options.find(o => o.id === prev);
                GameState.meters.budgetSpent -= prevOpt.cost;
            }
            
            GameState.designChoices[currentElement] = selectedOption;
            GameState.meters.budgetSpent += opt.cost;
            
            updateMeters();
            updateDesignProgress();
            updateElementStatus(currentElement, selectedOption);
            closeModal();
        }
        
        // ============================================
        // STAGE TRANSITIONS
        // ============================================
        function showDesignSummary() {
            const spent = GameState.meters.budgetSpent;
            const remaining = GameState.meters.stageBudgets.design - spent;
            
            $('summaryBudgetSpent').textContent = formatCurrency(spent);
            $('summaryBudgetRemaining').textContent = formatCurrency(remaining);
            
            const names = { pumpAccess: 'Pump Access', weldClearance: 'Weld Clearance', controlPanel: 'Control Panel', pipeConnections: 'Pipe Connections', pipeRouting: 'Pipe Routing', materialSpec: 'Material Specification' };
            $('decisionList').innerHTML = '';
            
            Object.keys(GameState.designChoices).forEach(key => {
                const choiceId = GameState.designChoices[key];
                const opt = DesignElements[key].options.find(o => o.id === choiceId);
                const li = document.createElement('li');
                li.innerHTML = `<span class="decision-name">${names[key]}</span><span class="decision-choice">${opt.name}<span class="choice-tag ${opt.quality}">${opt.qualityLabel}</span></span>`;
                $('decisionList').appendChild(li);
            });
            
            showScreen('designSummary');
        }
        
        function showTransition() {
            $('transitionYears').textContent = '15 YEARS LATER';
            $('transitionYear').textContent = '2040';
            $('transitionText').innerHTML = '<p>Thornbury Point has been generating power for 14 years.</p><p>Your design drawings are yellowed paper in a filing cabinet somewhere. Your name is in a title block nobody reads anymore.</p><p>But your decisions? Those are very much alive.</p><p>It\'s time for the first major maintenance outage.</p>';
            $('headerStage').innerHTML = '<strong>STAGE 2:</strong> MAINTENANCE';
            showScreen('transition');
        }
        
        function showCharacterIntro() {
            $('characterPortrait').textContent = 'üë∑';
            $('characterName').textContent = 'Dave Morton';
            $('characterRole').textContent = 'Maintenance Supervisor';
            
            const pumpChoice = GameState.designChoices.pumpAccess;
            let dialogue;
            if (pumpChoice === 'corner') {
                dialogue = "Right then. Section 4B. First major outage. Let's see what we're working with... Ah. Oh dear. Someone's put the pump in a corner. This should be interesting.";
            } else if (pumpChoice === 'openBay') {
                dialogue = "Right then. Section 4B. First major outage. Let's see what we're working with... Not bad. Pump's got good access. Crane rails above. Someone was thinking ahead.";
            } else {
                dialogue = "Right then. Section 4B. First major outage. Let's see what we're working with... A whole shielded room for one pump? Bit over the top, but at least we can get at it.";
            }
            $('characterDialogue').textContent = dialogue;
            showScreen('character');
        }
        
        // ============================================
        // MINI-GAME: PUMP REMOVAL
        // ============================================
        let gameState = { active: false, pump: null, target: null, timer: null, timeLeft: 30, dose: 0, dragging: false, offsetX: 0, offsetY: 0 };
        
        function startPumpGame() {
            const choice = GameState.designChoices.pumpAccess;
            const canvas = $('minigameCanvas');
            
            gameState = { active: true, timeLeft: 30, dose: 0, dragging: false };
            
            if (choice === 'corner') {
                // IMPOSSIBLE - show after brief attempt
                renderImpossibleGame(canvas);
            } else if (choice === 'openBay') {
                // EASY - straightforward drag
                renderEasyGame(canvas);
            } else {
                // WASTEFUL - works but with extra steps
                renderWastefulGame(canvas);
            }
            
            showScreen('minigame');
        }
        
        function renderImpossibleGame(canvas) {
            canvas.innerHTML = `
                <svg class="pump-game-svg" viewBox="0 0 700 300">
                    <!-- Corridor walls -->
                    <rect x="0" y="0" width="700" height="60" class="corridor-wall"/>
                    <rect x="0" y="240" width="700" height="60" class="corridor-wall"/>
                    
                    <!-- Narrow gap obstacle -->
                    <rect x="350" y="60" width="40" height="70" fill="#5a5a5a"/>
                    <rect x="350" y="170" width="40" height="70" fill="#5a5a5a"/>
                    
                    <!-- Gap measurement -->
                    <line x1="355" y1="130" x2="355" y2="170" stroke="#f59e0b" stroke-width="2"/>
                    <line x1="345" y1="130" x2="365" y2="130" stroke="#f59e0b" stroke-width="2"/>
                    <line x1="345" y1="170" x2="365" y2="170" stroke="#f59e0b" stroke-width="2"/>
                    <text x="320" y="155" fill="#f59e0b" font-size="12" font-weight="bold">1.8m</text>
                    
                    <!-- Pump -->
                    <g id="pumpDrag" class="pump-draggable" transform="translate(80, 110)">
                        <rect x="0" y="0" width="90" height="80" fill="#4a5d6b" stroke="#00b0f0" stroke-width="2" rx="4"/>
                        <circle cx="45" cy="40" r="25" fill="#364451" stroke="#00b0f0" stroke-width="2"/>
                        <text x="45" y="100" text-anchor="middle" fill="#9babc2" font-size="10">2.1m wide</text>
                    </g>
                    
                    <!-- Target -->
                    <rect x="550" y="100" width="100" height="100" fill="none" stroke="#92d050" stroke-width="2" class="pump-target" rx="4"/>
                    <text x="600" y="220" text-anchor="middle" fill="#92d050" font-size="11">REMOVAL BAY</text>
                </svg>
            `;
            
            $('minigameTitle').textContent = 'Pump Removal';
            $('minigameInstructions').textContent = 'Drag the pump through the corridor to the removal bay';
            
            // Setup drag
            const pump = canvas.querySelector('#pumpDrag');
            let pumpX = 80, pumpY = 110;
            
            const startDrag = (e) => {
                e.preventDefault();
                gameState.dragging = true;
                const pt = getEventPoint(e);
                gameState.offsetX = pt.x - pumpX;
                gameState.offsetY = pt.y - pumpY;
                pump.classList.add('dragging');
            };
            
            const doDrag = (e) => {
                if (!gameState.dragging) return;
                e.preventDefault();
                const pt = getEventPoint(e);
                pumpX = Math.max(0, Math.min(610, pt.x - gameState.offsetX));
                pumpY = Math.max(60, Math.min(160, pt.y - gameState.offsetY));
                pump.setAttribute('transform', `translate(${pumpX}, ${pumpY})`);
                
                // Check if hitting the gap
                if (pumpX > 260 && pumpX < 390) {
                    // Show impossible
                    setTimeout(() => {
                        gameState.active = false;
                        $('impossibleOverlay').style.display = 'flex';
                        $('impossibleDetail').textContent = 'The pump is 2.1m wide. The gap is only 1.8m. It physically cannot fit through.';
                        showImpossibleDecision();
                    }, 500);
                }
            };
            
            const endDrag = () => {
                gameState.dragging = false;
                pump.classList.remove('dragging');
            };
            
            pump.addEventListener('mousedown', startDrag);
            pump.addEventListener('touchstart', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            function getEventPoint(e) {
                const svg = canvas.querySelector('svg');
                const rect = svg.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) / rect.width * 700,
                    y: (clientY - rect.top) / rect.height * 300
                };
            }
            
            startTimer();
        }
        
        function renderEasyGame(canvas) {
            canvas.innerHTML = `
                <svg class="pump-game-svg" viewBox="0 0 700 300">
                    <!-- Open corridor -->
                    <rect x="0" y="0" width="700" height="40" class="corridor-wall"/>
                    <rect x="0" y="260" width="700" height="40" class="corridor-wall"/>
                    
                    <!-- Wide gap -->
                    <line x1="350" y1="50" x2="350" y2="80" stroke="#92d050" stroke-width="2" stroke-dasharray="4"/>
                    <line x1="350" y1="220" x2="350" y2="250" stroke="#92d050" stroke-width="2" stroke-dasharray="4"/>
                    <text x="360" y="70" fill="#92d050" font-size="10">2.5m clearance</text>
                    
                    <!-- Crane rails -->
                    <line x1="0" y1="50" x2="700" y2="50" stroke="#f59e0b" stroke-width="3"/>
                    <line x1="0" y1="250" x2="700" y2="250" stroke="#f59e0b" stroke-width="3"/>
                    
                    <!-- Pump -->
                    <g id="pumpDrag" class="pump-draggable" transform="translate(80, 110)">
                        <rect x="0" y="0" width="90" height="80" fill="#4a5d6b" stroke="#00b0f0" stroke-width="2" rx="4"/>
                        <circle cx="45" cy="40" r="25" fill="#364451" stroke="#00b0f0" stroke-width="2"/>
                    </g>
                    
                    <!-- Target -->
                    <rect x="550" y="100" width="100" height="100" fill="none" stroke="#92d050" stroke-width="2" class="pump-target" rx="4"/>
                    <text x="600" y="220" text-anchor="middle" fill="#92d050" font-size="11">REMOVAL BAY</text>
                </svg>
            `;
            
            $('minigameTitle').textContent = 'Pump Removal';
            $('minigameInstructions').textContent = 'Drag the pump through the corridor to the removal bay';
            
            const pump = canvas.querySelector('#pumpDrag');
            let pumpX = 80, pumpY = 110;
            
            const startDrag = (e) => {
                e.preventDefault();
                gameState.dragging = true;
                const pt = getEventPoint(e);
                gameState.offsetX = pt.x - pumpX;
                gameState.offsetY = pt.y - pumpY;
                pump.classList.add('dragging');
            };
            
            const doDrag = (e) => {
                if (!gameState.dragging) return;
                e.preventDefault();
                const pt = getEventPoint(e);
                pumpX = Math.max(0, Math.min(610, pt.x - gameState.offsetX));
                pumpY = Math.max(40, Math.min(180, pt.y - gameState.offsetY));
                pump.setAttribute('transform', `translate(${pumpX}, ${pumpY})`);
                
                // Check if reached target
                if (pumpX > 520 && pumpY > 80 && pumpY < 160) {
                    gameState.active = false;
                    clearInterval(gameState.timer);
                    gameState.dose = 0.5;
                    showEasySuccess();
                }
            };
            
            const endDrag = () => {
                gameState.dragging = false;
                pump.classList.remove('dragging');
            };
            
            pump.addEventListener('mousedown', startDrag);
            pump.addEventListener('touchstart', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            function getEventPoint(e) {
                const svg = canvas.querySelector('svg');
                const rect = svg.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) / rect.width * 700,
                    y: (clientY - rect.top) / rect.height * 300
                };
            }
            
            startTimer();
        }
        
        function renderWastefulGame(canvas) {
            // Similar to easy but with airlock message
            canvas.innerHTML = `
                <svg class="pump-game-svg" viewBox="0 0 700 300">
                    <!-- Shielded room walls -->
                    <rect x="0" y="0" width="700" height="40" class="corridor-wall"/>
                    <rect x="0" y="260" width="700" height="40" class="corridor-wall"/>
                    
                    <!-- Airlock indication -->
                    <rect x="200" y="40" width="60" height="220" fill="rgba(245, 158, 11, 0.2)" stroke="#f59e0b" stroke-width="2"/>
                    <text x="230" y="155" text-anchor="middle" fill="#f59e0b" font-size="10" transform="rotate(-90, 230, 155)">AIRLOCK</text>
                    
                    <!-- Pump -->
                    <g id="pumpDrag" class="pump-draggable" transform="translate(50, 110)">
                        <rect x="0" y="0" width="90" height="80" fill="#4a5d6b" stroke="#00b0f0" stroke-width="2" rx="4"/>
                        <circle cx="45" cy="40" r="25" fill="#364451" stroke="#00b0f0" stroke-width="2"/>
                    </g>
                    
                    <!-- Target -->
                    <rect x="550" y="100" width="100" height="100" fill="none" stroke="#92d050" stroke-width="2" class="pump-target" rx="4"/>
                    <text x="600" y="220" text-anchor="middle" fill="#92d050" font-size="11">REMOVAL BAY</text>
                </svg>
            `;
            
            $('minigameTitle').textContent = 'Pump Removal';
            $('minigameInstructions').textContent = 'Navigate through the airlock to the removal bay (extra time for decon)';
            
            const pump = canvas.querySelector('#pumpDrag');
            let pumpX = 50, pumpY = 110;
            
            const startDrag = (e) => {
                e.preventDefault();
                gameState.dragging = true;
                const pt = getEventPoint(e);
                gameState.offsetX = pt.x - pumpX;
                gameState.offsetY = pt.y - pumpY;
            };
            
            const doDrag = (e) => {
                if (!gameState.dragging) return;
                e.preventDefault();
                const pt = getEventPoint(e);
                pumpX = Math.max(0, Math.min(610, pt.x - gameState.offsetX));
                pumpY = Math.max(40, Math.min(180, pt.y - gameState.offsetY));
                pump.setAttribute('transform', `translate(${pumpX}, ${pumpY})`);
                
                if (pumpX > 520 && pumpY > 80 && pumpY < 160) {
                    gameState.active = false;
                    clearInterval(gameState.timer);
                    gameState.dose = 0.3;
                    showWastefulSuccess();
                }
            };
            
            const endDrag = () => { gameState.dragging = false; };
            
            pump.addEventListener('mousedown', startDrag);
            pump.addEventListener('touchstart', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            
            function getEventPoint(e) {
                const svg = canvas.querySelector('svg');
                const rect = svg.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: (clientX - rect.left) / rect.width * 700, y: (clientY - rect.top) / rect.height * 300 };
            }
            
            startTimer();
        }
        
        function startTimer() {
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                $('minigameTimer').textContent = gameState.timeLeft + 's';
                $('minigameDose').textContent = '+' + gameState.dose.toFixed(1) + ' mSv';
                
                if (gameState.timeLeft <= 10) {
                    $('minigameTimer').classList.add('warning');
                }
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    // Time ran out
                }
            }, 1000);
        }
        
        // ============================================
        // DECISION HANDLING
        // ============================================
        function showImpossibleDecision() {
            $('decisionPanel').style.display = 'block';
            $('decisionOptions').innerHTML = `
                <div class="decision-option" data-choice="subcontract">
                    <div class="decision-option-header">
                        <span class="decision-option-title">Call Specialist Contractor</span>
                        <span class="decision-option-cost">¬£180,000</span>
                    </div>
                    <p class="decision-option-desc">Bring in heavy lift specialists with cutting equipment. They'll remove the structural beam temporarily, extract the pump, then reinstate.</p>
                    <div class="decision-option-risk"><span class="risk-indicator safe">SAFE</span><span>+3 days, +1.5 mSv (contractor dose)</span></div>
                </div>
                <div class="decision-option" data-choice="force">
                    <div class="decision-option-header">
                        <span class="decision-option-title">Force It Through</span>
                        <span class="decision-option-cost">¬£0</span>
                    </div>
                    <p class="decision-option-desc">Jack up the beam, force the pump through the gap. Might work. Might damage the pump, the beam, or someone.</p>
                    <div class="decision-option-risk"><span class="risk-indicator extreme">EXTREME RISK</span><span>30% success, 70% failure + damage + injury risk</span></div>
                </div>
            `;
            
            $$('.decision-option').forEach(opt => {
                opt.onclick = () => handleImpossibleChoice(opt.dataset.choice);
            });
        }
        
        function handleImpossibleChoice(choice) {
            clearInterval(gameState.timer);
            
            if (choice === 'subcontract') {
                GameState.stage2.budgetUsed += 180000;
                GameState.stage2.doseAccrued += 1.5;
                GameState.stage2.timeUsed += 3;
                GameState.stage2.events.push({ type: 'subcontract', desc: 'Specialist contractor called for pump removal' });
                GameState.stage2.outcome = 'subcontract';
                
                showOutcome({
                    icon: '‚úì',
                    title: 'Task Complete',
                    titleClass: 'partial',
                    comment: "Aye, well. That's ¬£180k we didn't budget for. Specialist lads did a good job though. Beam's back in place, pump's out. But someone in 2025 could've saved us that with a bit of thought.",
                    description: '<p>The specialist contractor completed the work safely. The structural beam was temporarily removed using hydraulic jacks, the pump extracted, and the beam reinstated.</p><p>The additional cost and time were unavoidable given the original design constraints.</p>',
                    stats: [
                        { label: 'Cost', value: '¬£180,000', class: 'negative' },
                        { label: 'Dose', value: '+1.5 mSv', class: 'neutral' },
                        { label: 'Time', value: '+3 days', class: 'neutral' }
                    ]
                });
            } else {
                // Force it - random outcome
                const success = Math.random() < 0.3;
                
                if (success) {
                    GameState.stage2.doseAccrued += 2.0;
                    GameState.stage2.timeUsed += 1;
                    GameState.stage2.events.push({ type: 'forced_success', desc: 'Pump forced through gap (risky but succeeded)' });
                    GameState.stage2.outcome = 'forced_success';
                    
                    showOutcome({
                        icon: 'üò∞',
                        title: 'Scraped Through',
                        titleClass: 'partial',
                        comment: "Can't believe that worked. Don't ever ask me to do that again. The lads were terrified. I was terrified. But we got it out.",
                        description: '<p>Against the odds, the pump was forced through the gap. Some minor scraping to the pump casing, but no structural damage to the beam.</p><p>The team took elevated dose during the extended hands-on work.</p>',
                        stats: [
                            { label: 'Cost', value: '¬£0', class: 'positive' },
                            { label: 'Dose', value: '+2.0 mSv', class: 'negative' },
                            { label: 'Time', value: '+1 day', class: 'neutral' }
                        ]
                    });
                } else {
                    // Failure with consequences
                    const injury = Math.random() < 0.4;
                    GameState.stage2.budgetUsed += 280000;
                    GameState.stage2.doseAccrued += 3.5;
                    GameState.stage2.timeUsed += 7;
                    GameState.meters.plantHealth -= 5;
                    
                    if (injury) {
                        GameState.injuries++;
                        GameState.stage2.events.push({ type: 'injury', desc: 'Worker injured during forced pump removal' });
                        GameState.stage2.events.push({ type: 'forced_failure', desc: 'Pump extraction failed, beam damaged' });
                        GameState.stage2.outcome = 'forced_failure_injury';
                        
                        showOutcome({
                            icon: 'üö®',
                            title: 'Incident',
                            titleClass: 'failure',
                            comment: "One of my lads is in hospital. Beam shifted, pump dropped. We've got structural damage, a damaged pump, and a man with a broken leg. I hope whoever designed this is proud of themselves.",
                            description: '<p>The hydraulic jack slipped. The beam shifted unexpectedly. The pump dropped and struck a worker.</p><p>Emergency response was required. The pump is now damaged beyond local repair. A replacement will be needed.</p><p>Regulatory notification required for the injury.</p>',
                            stats: [
                                { label: 'Cost', value: '¬£280,000', class: 'negative' },
                                { label: 'Dose', value: '+3.5 mSv', class: 'negative' },
                                { label: 'Time', value: '+7 days', class: 'negative' },
                                { label: 'Injuries', value: '1', class: 'negative' }
                            ]
                        });
                    } else {
                        GameState.stage2.events.push({ type: 'forced_failure', desc: 'Pump extraction failed, equipment damaged' });
                        GameState.stage2.outcome = 'forced_failure';
                        
                        showOutcome({
                            icon: '‚ùå',
                            title: 'Failed',
                            titleClass: 'failure',
                            comment: "Well, that's torn it. Pump's jammed solid. Beam's cracked. We're going to have to call in the specialists anyway, and now we've got damage to repair on top.",
                            description: '<p>The pump became wedged in the gap. Further force cracked the structural beam.</p><p>Specialist contractors were called in anyway, now facing a more complex job. The damaged pump requires replacement.</p>',
                            stats: [
                                { label: 'Cost', value: '¬£280,000', class: 'negative' },
                                { label: 'Dose', value: '+3.5 mSv', class: 'negative' },
                                { label: 'Time', value: '+7 days', class: 'negative' },
                                { label: 'Plant Health', value: '-5%', class: 'negative' }
                            ]
                        });
                    }
                }
            }
        }
        
        function showEasySuccess() {
            GameState.stage2.doseAccrued += 0.5;
            GameState.stage2.timeUsed += 0.5;
            GameState.stage2.events.push({ type: 'success', desc: 'Pump removed smoothly' });
            GameState.stage2.outcome = 'easy_success';
            
            showOutcome({
                icon: '‚úì',
                title: 'Perfect',
                titleClass: 'success',
                comment: "Now that's how it should be done. Good access, crane rails right there, pump's out in half a day. Someone in 2025 knew what they were doing.",
                description: '<p>The pump was removed exactly as intended. The open bay design provided full crane access and clear egress routes.</p><p>Minimal dose to the team. On schedule. No complications.</p>',
                stats: [
                    { label: 'Cost', value: '¬£0', class: 'positive' },
                    { label: 'Dose', value: '+0.5 mSv', class: 'positive' },
                    { label: 'Time', value: '0.5 days', class: 'positive' }
                ]
            });
        }
        
        function showWastefulSuccess() {
            GameState.stage2.budgetUsed += 15000;
            GameState.stage2.doseAccrued += 0.3;
            GameState.stage2.timeUsed += 1;
            GameState.stage2.events.push({ type: 'success_wasteful', desc: 'Pump removed (extra airlock procedures)' });
            GameState.stage2.outcome = 'wasteful_success';
            
            showOutcome({
                icon: '‚úì',
                title: 'Complete',
                titleClass: 'success',
                comment: "Job done. Bit fussy with the airlock and all the decon steps, but we got there. Can't complain about the access. Just wonder if we really needed all this shielding for one auxiliary pump.",
                description: '<p>The pump was removed successfully. The dedicated shielded room provided excellent access but required additional airlock procedures.</p><p>Lower dose due to the shielding, but extra time for entry/exit protocols.</p>',
                stats: [
                    { label: 'Cost', value: '¬£15,000', class: 'neutral' },
                    { label: 'Dose', value: '+0.3 mSv', class: 'positive' },
                    { label: 'Time', value: '1 day', class: 'neutral' }
                ]
            });
        }
        
        function showOutcome(data) {
            $('outcomeIcon').textContent = data.icon;
            $('outcomeTitle').textContent = data.title;
            $('outcomeTitle').className = 'outcome-title ' + data.titleClass;
            $('outcomeCommentText').textContent = data.comment;
            $('outcomeDescription').innerHTML = data.description;
            
            $('outcomeStats').innerHTML = data.stats.map(s => 
                `<div class="outcome-stat"><div class="outcome-stat-label">${s.label}</div><div class="outcome-stat-value ${s.class}">${s.value}</div></div>`
            ).join('');
            
            showScreen('outcome');
        }
        
        function showStage2Summary() {
            GameState.meters.budgetSpent += GameState.stage2.budgetUsed;
            GameState.meters.dose += GameState.stage2.doseAccrued;
            GameState.meters.time += GameState.stage2.timeUsed;
            
            $('stage2SummaryMeters').innerHTML = `
                <div class="summary-meter"><div class="summary-meter-icon">üí∞</div><div class="summary-meter-value">${formatCurrency(GameState.stage2.budgetUsed)}</div><div class="summary-meter-label">Stage Cost</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">‚ò¢Ô∏è</div><div class="summary-meter-value">+${GameState.stage2.doseAccrued.toFixed(1)} mSv</div><div class="summary-meter-label">Dose Accrued</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">‚ù§Ô∏è</div><div class="summary-meter-value">${GameState.meters.plantHealth}%</div><div class="summary-meter-label">Plant Health</div></div>
            `;
            
            $('stage2EventList').innerHTML = GameState.stage2.events.map(e => `<li><span class="decision-name">${e.desc}</span></li>`).join('');
            updateMeters();
            $('headerStage').innerHTML = '<strong>STAGE 2:</strong> COMPLETE';
            showScreen('stage2Summary');
        }
        
        // ============================================
        // STAGE 3: INSPECTION (Sarah)
        // ============================================
        function startStage3() {
            $('headerStage').innerHTML = '<strong>STAGE 3:</strong> INSPECTION';
            const weldChoice = GameState.designChoices.weldClearance;
            let dialogue;
            if (weldChoice === '50mm') {
                dialogue = "In-service inspection. Every weld, every pressure boundary. The safety case says we can reach them all. But I'm looking at these drawings and... 50mm clearance? Someone's having a laugh.";
            } else if (weldChoice === '150mm') {
                dialogue = "In-service inspection. Every weld, every pressure boundary. Good clearances on the drawings. Let's see if reality matches the paperwork.";
            } else {
                dialogue = "In-service inspection. Every weld, every pressure boundary. 300mm clearance with permanent scaffolding? Generous. Though that scaffolding will be contaminated by now.";
            }
            $('sarahDialogue').textContent = dialogue;
            showScreen('character3');
        }
        
        function startInspectionGame() {
            const choice = GameState.designChoices.weldClearance;
            const canvas = $('minigame3Canvas');
            
            if (choice === '50mm') {
                canvas.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;"><p style="font-size:1.2rem;color:var(--amber);margin-bottom:16px;">Attempting inspection with 50mm clearance...</p><p style="color:var(--light-grey);">The UT probe requires 80mm. You can only achieve partial coverage.</p></div>';
                setTimeout(() => {
                    $('impossibleOverlay3').style.display = 'flex';
                    $('coverageDisplay').textContent = '60%';
                    $('coverageDisplay').classList.add('warning');
                    showInspectionDecision();
                }, 2000);
            } else if (choice === '150mm') {
                canvas.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;"><div style="width:80%;height:30px;background:var(--slate);border-radius:4px;overflow:hidden;"><div id="coverageBar" style="width:0%;height:100%;background:var(--green);transition:width 0.1s;"></div></div><p style="margin-top:12px;color:var(--light-grey);">Scanning weld...</p></div>';
                let coverage = 0;
                const interval = setInterval(() => {
                    coverage += 5;
                    $('coverageBar').style.width = coverage + '%';
                    $('coverageDisplay').textContent = coverage + '%';
                    if (coverage >= 100) {
                        clearInterval(interval);
                        GameState.stage3.coverage = 100;
                        GameState.stage3.doseAccrued = 0.8;
                        GameState.stage3.events.push({ desc: 'Full weld coverage achieved' });
                        showInspectionOutcome('success');
                    }
                }, 100);
            } else {
                canvas.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;"><p style="color:var(--amber);margin-bottom:16px;">Navigating contaminated scaffolding...</p><div style="width:80%;height:30px;background:var(--slate);border-radius:4px;overflow:hidden;"><div id="coverageBar" style="width:0%;height:100%;background:var(--green);transition:width 0.1s;"></div></div></div>';
                let coverage = 0;
                const interval = setInterval(() => {
                    coverage += 3;
                    $('coverageBar').style.width = coverage + '%';
                    $('coverageDisplay').textContent = coverage + '%';
                    $('minigame3Dose').textContent = '+' + (coverage * 0.02).toFixed(1) + ' mSv';
                    if (coverage >= 100) {
                        clearInterval(interval);
                        GameState.stage3.coverage = 100;
                        GameState.stage3.doseAccrued = 2.0;
                        GameState.stage3.budgetUsed = 25000;
                        GameState.stage3.events.push({ desc: 'Full coverage achieved (scaffolding decon required)' });
                        showInspectionOutcome('wasteful');
                    }
                }, 120);
            }
            showScreen('minigame3');
        }
        
        function showInspectionDecision() {
            $('decisionPanel3').style.display = 'block';
            $('decisionOptions3').innerHTML = `
                <div class="decision-option" data-choice="accept">
                    <div class="decision-option-header"><span class="decision-option-title">Accept Partial Coverage</span><span class="decision-option-cost">¬£0</span></div>
                    <p class="decision-option-desc">Document the limitation and accept 60% coverage. Note in the safety case.</p>
                    <div class="decision-option-risk"><span class="risk-indicator moderate">MODERATE RISK</span><span>Regulatory scrutiny possible</span></div>
                </div>
                <div class="decision-option" data-choice="specialist">
                    <div class="decision-option-header"><span class="decision-option-title">Specialist Flexible Probe</span><span class="decision-option-cost">¬£40,000</span></div>
                    <p class="decision-option-desc">Bring in specialist contractor with flexible phased-array probe.</p>
                    <div class="decision-option-risk"><span class="risk-indicator safe">SAFE</span><span>+2 days, achieves 95% coverage</span></div>
                </div>
            `;
            $$('#decisionOptions3 .decision-option').forEach(opt => {
                opt.onclick = () => handleInspectionChoice(opt.dataset.choice);
            });
        }
        
        function handleInspectionChoice(choice) {
            if (choice === 'accept') {
                GameState.stage3.coverage = 60;
                GameState.stage3.doseAccrued = 1.2;
                GameState.stage3.events.push({ desc: 'Partial coverage accepted (60%)' });
                GameState.incidents.push('Inspection limitation documented');
                showInspectionOutcome('partial');
            } else {
                GameState.stage3.coverage = 95;
                GameState.stage3.budgetUsed = 40000;
                GameState.stage3.doseAccrued = 1.5;
                GameState.stage3.events.push({ desc: 'Specialist contractor achieved 95% coverage' });
                showInspectionOutcome('specialist');
            }
        }
        
        function showInspectionOutcome(type) {
            const outcomes = {
                success: { icon: '‚úì', title: 'Full Coverage', titleClass: 'success', comment: "Textbook inspection. Good clearances, full coverage, minimal dose. Whoever designed this knew what they were doing.", stats: [{ label: 'Coverage', value: '100%', class: 'positive' }, { label: 'Dose', value: '+0.8 mSv', class: 'positive' }, { label: 'Cost', value: '¬£0', class: 'positive' }] },
                wasteful: { icon: '‚úì', title: 'Complete', titleClass: 'partial', comment: "Got full coverage, but that scaffolding was hot. My team took more dose than I'd like climbing around it. And we'll need to add decon costs.", stats: [{ label: 'Coverage', value: '100%', class: 'positive' }, { label: 'Dose', value: '+2.0 mSv', class: 'negative' }, { label: 'Cost', value: '¬£25,000', class: 'neutral' }] },
                partial: { icon: '‚ö†Ô∏è', title: 'Partial Coverage', titleClass: 'partial', comment: "60% coverage is what it is. I've documented the limitation. The regulator won't be happy, but we can't inspect what we can't reach.", stats: [{ label: 'Coverage', value: '60%', class: 'negative' }, { label: 'Dose', value: '+1.2 mSv', class: 'neutral' }, { label: 'Cost', value: '¬£0', class: 'positive' }] },
                specialist: { icon: '‚úì', title: 'Near-Full Coverage', titleClass: 'success', comment: "The specialist probe got us to 95%. Cost us time and money, but at least we can sign off the safety case properly.", stats: [{ label: 'Coverage', value: '95%', class: 'positive' }, { label: 'Dose', value: '+1.5 mSv', class: 'neutral' }, { label: 'Cost', value: '¬£40,000', class: 'negative' }] }
            };
            const o = outcomes[type];
            $('outcomeIcon3').textContent = o.icon;
            $('outcomeTitle3').textContent = o.title;
            $('outcomeTitle3').className = 'outcome-title ' + o.titleClass;
            $('outcomeComment3').textContent = o.comment;
            $('outcomeDescription3').innerHTML = '<p>The in-service inspection of Section 4B welds has been completed.</p>';
            $('outcomeStats3').innerHTML = o.stats.map(s => `<div class="outcome-stat"><div class="outcome-stat-label">${s.label}</div><div class="outcome-stat-value ${s.class}">${s.value}</div></div>`).join('');
            showScreen('outcome3');
        }
        
        function showStage3Summary() {
            GameState.meters.budgetSpent += GameState.stage3.budgetUsed;
            GameState.meters.dose += GameState.stage3.doseAccrued;
            $('stage3SummaryMeters').innerHTML = `
                <div class="summary-meter"><div class="summary-meter-icon">üìä</div><div class="summary-meter-value">${GameState.stage3.coverage}%</div><div class="summary-meter-label">Coverage</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">üí∞</div><div class="summary-meter-value">${formatCurrency(GameState.stage3.budgetUsed)}</div><div class="summary-meter-label">Cost</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">‚ò¢Ô∏è</div><div class="summary-meter-value">+${GameState.stage3.doseAccrued.toFixed(1)} mSv</div><div class="summary-meter-label">Dose</div></div>
            `;
            $('stage3EventList').innerHTML = GameState.stage3.events.map(e => `<li><span class="decision-name">${e.desc}</span></li>`).join('');
            updateMeters();
            $('headerStage').innerHTML = '<strong>STAGE 3:</strong> COMPLETE';
            showScreen('stage3Summary');
        }
        
        // ============================================
        // STAGE 4: OPERATIONS (Mike)
        // ============================================
        function startStage4() {
            $('headerStage').innerHTML = '<strong>STAGE 4:</strong> OPERATIONS';
            const panelChoice = GameState.designChoices.controlPanel;
            let dialogue;
            if (panelChoice === 'systemBased') {
                dialogue = "Alarm in Section 4B. Night shift, skeleton crew. Right, where's the... wait, why are the pump controls over here and the isolation valves over there? Who designed this panel?";
            } else if (panelChoice === 'taskBased') {
                dialogue = "Alarm in Section 4B. Night shift, skeleton crew. Let's work the procedure. Isolation valves, pump trip, vent sequence... all in order on the panel. Good.";
            } else {
                dialogue = "Alarm in Section 4B. Night shift, skeleton crew. Right, touch the screen to... wait, it's not responding. The screen's frozen. Someone get me a torch, I can't see the backup switches!";
            }
            $('mikeDialogue').textContent = dialogue;
            showScreen('character4');
        }
        
        function startControlRoomGame() {
            const choice = GameState.designChoices.controlPanel;
            const canvas = $('minigame4Canvas');
            
            if (choice === 'taskBased') {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--light-grey);">Execute emergency sequence: Click buttons 1‚Üí2‚Üí3‚Üí4</p><div style="display:flex;gap:12px;"><button class="seq-btn" data-seq="1" style="width:60px;height:60px;border-radius:8px;background:var(--slate);border:2px solid var(--blue);color:white;font-size:1.5rem;cursor:pointer;">1</button><button class="seq-btn" data-seq="2" style="width:60px;height:60px;border-radius:8px;background:var(--slate);border:2px solid var(--blue);color:white;font-size:1.5rem;cursor:pointer;">2</button><button class="seq-btn" data-seq="3" style="width:60px;height:60px;border-radius:8px;background:var(--slate);border:2px solid var(--blue);color:white;font-size:1.5rem;cursor:pointer;">3</button><button class="seq-btn" data-seq="4" style="width:60px;height:60px;border-radius:8px;background:var(--slate);border:2px solid var(--blue);color:white;font-size:1.5rem;cursor:pointer;">4</button></div></div>';
                let current = 1;
                canvas.querySelectorAll('.seq-btn').forEach(btn => {
                    btn.onclick = () => {
                        if (parseInt(btn.dataset.seq) === current) {
                            btn.style.background = 'var(--green)';
                            $('sequenceProgress').textContent = current + '/4';
                            if (current === 4) {
                                GameState.stage4.events.push({ desc: 'Emergency sequence completed successfully' });
                                GameState.stage4.doseAccrued = 0.2;
                                showControlOutcome('success');
                            }
                            current++;
                        }
                    };
                });
            } else if (choice === 'systemBased') {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--amber);">Controls scattered! Find sequence: 1‚Üí2‚Üí3‚Üí4</p><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;max-width:300px;"><button class="seq-btn" data-seq="3" style="width:50px;height:50px;border-radius:8px;background:var(--slate);border:2px solid var(--mid-grey);color:white;font-size:1.2rem;cursor:pointer;">?</button><button class="seq-btn" data-seq="1" style="width:50px;height:50px;border-radius:8px;background:var(--slate);border:2px solid var(--mid-grey);color:white;font-size:1.2rem;cursor:pointer;">?</button><button class="seq-btn" data-seq="4" style="width:50px;height:50px;border-radius:8px;background:var(--slate);border:2px solid var(--mid-grey);color:white;font-size:1.2rem;cursor:pointer;">?</button><button class="seq-btn" data-seq="2" style="width:50px;height:50px;border-radius:8px;background:var(--slate);border:2px solid var(--mid-grey);color:white;font-size:1.2rem;cursor:pointer;">?</button></div><p style="color:var(--red);font-size:0.9rem;">Timer running - find controls quickly!</p></div>';
                let current = 1, errors = 0, timer = 30;
                const timerInt = setInterval(() => {
                    timer--;
                    $('minigame4Timer').textContent = timer + 's';
                    if (timer <= 10) $('minigame4Timer').classList.add('warning');
                    if (timer <= 0) { clearInterval(timerInt); showControlDecision(); }
                }, 1000);
                canvas.querySelectorAll('.seq-btn').forEach(btn => {
                    btn.onclick = () => {
                        btn.textContent = btn.dataset.seq;
                        if (parseInt(btn.dataset.seq) === current) {
                            btn.style.background = 'var(--green)';
                            $('sequenceProgress').textContent = current + '/4';
                            if (current === 4) { clearInterval(timerInt); GameState.stage4.events.push({ desc: 'Sequence completed with difficulty' }); GameState.stage4.doseAccrued = 0.5; showControlOutcome('delayed'); }
                            current++;
                        } else { btn.style.background = 'var(--red)'; errors++; setTimeout(() => { btn.style.background = 'var(--slate)'; btn.textContent = '?'; }, 500); }
                    };
                });
            } else {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--red);">TOUCHSCREEN FROZEN</p><p style="color:var(--light-grey);">Backup switches unlabelled in the dark...</p><div style="background:var(--deep-navy);padding:20px;border-radius:8px;"><p style="color:var(--amber);">‚è±Ô∏è System unresponsive for 45 seconds...</p></div></div>';
                setTimeout(() => {
                    GameState.stage4.events.push({ desc: 'Touchscreen failure - delayed response' });
                    GameState.stage4.budgetUsed = 100000;
                    GameState.stage4.doseAccrued = 1.0;
                    GameState.meters.plantHealth -= 10;
                    showControlOutcome('failure');
                }, 3000);
            }
            showScreen('minigame4');
        }
        
        function showControlDecision() {
            $('decisionPanel4').style.display = 'block';
            $('decisionOptions4').innerHTML = `
                <div class="decision-option" data-choice="manual">
                    <div class="decision-option-header"><span class="decision-option-title">Manual Override</span><span class="decision-option-cost">+¬£50,000</span></div>
                    <p class="decision-option-desc">Send operator into Section 4B to manually isolate. Higher dose but controlled shutdown.</p>
                    <div class="decision-option-risk"><span class="risk-indicator moderate">MODERATE</span><span>+2.0 mSv to operator</span></div>
                </div>
            `;
            $$('#decisionOptions4 .decision-option').forEach(opt => {
                opt.onclick = () => { GameState.stage4.budgetUsed = 50000; GameState.stage4.doseAccrued = 2.0; GameState.stage4.events.push({ desc: 'Manual override required' }); showControlOutcome('manual'); };
            });
        }
        
        function showControlOutcome(type) {
            const outcomes = {
                success: { icon: '‚úì', title: 'Perfect Response', titleClass: 'success', comment: "Textbook. Sequence completed in good time, minimal fuss. That's what a well-designed panel gets you.", stats: [{ label: 'Response', value: 'Optimal', class: 'positive' }, { label: 'Dose', value: '+0.2 mSv', class: 'positive' }, { label: 'Plant', value: 'No damage', class: 'positive' }] },
                delayed: { icon: '‚ö†Ô∏è', title: 'Resolved', titleClass: 'partial', comment: "Got there in the end, but I shouldn't have to hunt for controls during an emergency. Wasted precious seconds.", stats: [{ label: 'Response', value: 'Delayed', class: 'neutral' }, { label: 'Dose', value: '+0.5 mSv', class: 'neutral' }, { label: 'Plant', value: 'No damage', class: 'positive' }] },
                manual: { icon: '‚ö†Ô∏è', title: 'Manual Override', titleClass: 'partial', comment: "Had to send someone in. They got dose they shouldn't have had to take. All because we couldn't find controls fast enough.", stats: [{ label: 'Response', value: 'Delayed', class: 'negative' }, { label: 'Dose', value: '+2.0 mSv', class: 'negative' }, { label: 'Cost', value: '¬£50,000', class: 'negative' }] },
                failure: { icon: '‚ùå', title: 'System Failure', titleClass: 'failure', comment: "Touchscreen died when we needed it most. Lost control for 45 seconds. Plant took damage. Unacceptable.", stats: [{ label: 'Response', value: 'Failed', class: 'negative' }, { label: 'Dose', value: '+1.0 mSv', class: 'negative' }, { label: 'Plant Health', value: '-10%', class: 'negative' }] }
            };
            const o = outcomes[type];
            $('outcomeIcon4').textContent = o.icon;
            $('outcomeTitle4').textContent = o.title;
            $('outcomeTitle4').className = 'outcome-title ' + o.titleClass;
            $('outcomeComment4').textContent = o.comment;
            $('outcomeDescription4').innerHTML = '<p>The emergency in Section 4B has been resolved.</p>';
            $('outcomeStats4').innerHTML = o.stats.map(s => `<div class="outcome-stat"><div class="outcome-stat-label">${s.label}</div><div class="outcome-stat-value ${s.class}">${s.value}</div></div>`).join('');
            showScreen('outcome4');
        }
        
        function showStage4Summary() {
            GameState.meters.budgetSpent += GameState.stage4.budgetUsed;
            GameState.meters.dose += GameState.stage4.doseAccrued;
            $('stage4SummaryMeters').innerHTML = `
                <div class="summary-meter"><div class="summary-meter-icon">üí∞</div><div class="summary-meter-value">${formatCurrency(GameState.stage4.budgetUsed)}</div><div class="summary-meter-label">Cost</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">‚ò¢Ô∏è</div><div class="summary-meter-value">+${GameState.stage4.doseAccrued.toFixed(1)} mSv</div><div class="summary-meter-label">Dose</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">‚ù§Ô∏è</div><div class="summary-meter-value">${GameState.meters.plantHealth}%</div><div class="summary-meter-label">Plant Health</div></div>
            `;
            $('stage4EventList').innerHTML = GameState.stage4.events.map(e => `<li><span class="decision-name">${e.desc}</span></li>`).join('');
            updateMeters();
            $('headerStage').innerHTML = '<strong>STAGE 4:</strong> COMPLETE';
            showScreen('stage4Summary');
        }
        
        // ============================================
        // STAGE 5: DECOMMISSIONING (Janet)
        // ============================================
        function startStage5() {
            $('headerStage').innerHTML = '<strong>STAGE 5:</strong> DECOMMISSIONING';
            const choices = GameState.designChoices;
            let dialogue = "Sixty years. Let's see what 2025 left us. ";
            if (choices.pipeConnections === 'welded') dialogue += "All welded joints? Going to be a lot of cutting. ";
            if (choices.pipeRouting === 'embedded') dialogue += "Pipes in concrete? That's going to hurt. ";
            if (choices.materialSpec === 'standardSS') dialogue += "Standard steel... high cobalt. We'll need remote handling. ";
            dialogue += "Right then. Let's get to work.";
            $('janetDialogue').textContent = dialogue;
            showScreen('character5');
        }
        
        function startDecommissioningGame() {
            runDecomTask1();
        }
        
        function runDecomTask1() {
            const choice = GameState.designChoices.pipeConnections;
            const canvas = $('minigame5Canvas');
            $('minigame5Title').textContent = 'Pipe Disassembly';
            
            if (choice === 'flanged') {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--light-grey);">Click bolts to remove flange</p><div style="display:flex;gap:8px;" id="bolts"></div></div>';
                const boltsDiv = canvas.querySelector('#bolts');
                for (let i = 0; i < 6; i++) { const b = document.createElement('button'); b.style.cssText = 'width:40px;height:40px;border-radius:50%;background:var(--slate);border:2px solid var(--mid-grey);cursor:pointer;'; b.onclick = () => { b.style.background = 'var(--green)'; b.disabled = true; if ([...boltsDiv.querySelectorAll('button')].every(x => x.disabled)) { GameState.stage5.events.push({ desc: 'Flanged pipes disassembled easily' }); GameState.stage5.doseAccrued += 0.5; setTimeout(runDecomTask2, 1000); } }; boltsDiv.appendChild(b); }
            } else if (choice === 'welded') {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--amber);">All welded joints - cutting required</p><p style="color:var(--light-grey);">This will take time and generate contaminated swarf...</p></div>';
                setTimeout(() => { GameState.stage5.events.push({ desc: 'Welded joints cut with plasma torch' }); GameState.stage5.doseAccrued += 2.0; GameState.stage5.budgetUsed += 80000; GameState.stage5.wasteGenerated += 2; runDecomTask2(); }, 2500);
            } else {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--light-grey);">Mixed connections - some bolts, some cutting</p></div>';
                setTimeout(() => { GameState.stage5.events.push({ desc: 'Mixed joints removed' }); GameState.stage5.doseAccrued += 1.0; GameState.stage5.budgetUsed += 30000; GameState.stage5.wasteGenerated += 1; runDecomTask2(); }, 2000);
            }
            showScreen('minigame5');
        }
        
        function runDecomTask2() {
            const choice = GameState.designChoices.pipeRouting;
            const canvas = $('minigame5Canvas');
            $('minigame5Title').textContent = 'Pipe Excavation';
            $('wasteGenerated').textContent = GameState.stage5.wasteGenerated + ' tonnes';
            $('minigame5Dose').textContent = '+' + GameState.stage5.doseAccrued.toFixed(1) + ' mSv';
            
            if (choice === 'ducted') {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--green);">Accessible ducts - lift covers and remove</p><button id="liftBtn" style="padding:12px 24px;background:var(--blue);color:white;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">Lift Cover</button></div>';
                canvas.querySelector('#liftBtn').onclick = () => { GameState.stage5.events.push({ desc: 'Pipes removed from accessible ducts' }); GameState.stage5.doseAccrued += 0.3; setTimeout(runDecomTask3, 1000); };
            } else if (choice === 'embedded') {
                $('impossibleOverlay5').style.display = 'flex';
                $('impossibleText5').textContent = 'PIPES EMBEDDED IN CONCRETE';
                $('impossibleDetail5').textContent = 'No record of exact pipe locations. Must chip concrete to find them. Massive waste generation.';
                $('decisionPanel5').style.display = 'block';
                $('decision5Title').textContent = 'How to proceed?';
                $('decisionOptions5').innerHTML = `
                    <div class="decision-option" data-choice="chip"><div class="decision-option-header"><span class="decision-option-title">Chip Concrete Manually</span><span class="decision-option-cost">+¬£200,000</span></div><p class="decision-option-desc">Slow, high dose, generates 15+ tonnes ILW</p><div class="decision-option-risk"><span class="risk-indicator extreme">HIGH DOSE</span><span>+8.0 mSv</span></div></div>
                    <div class="decision-option" data-choice="gpr"><div class="decision-option-header"><span class="decision-option-title">Ground Penetrating Radar</span><span class="decision-option-cost">+¬£400,000</span></div><p class="decision-option-desc">Locate pipes first, targeted removal, less waste</p><div class="decision-option-risk"><span class="risk-indicator moderate">MODERATE</span><span>+3.0 mSv, 8 tonnes ILW</span></div></div>
                `;
                $$('#decisionOptions5 .decision-option').forEach(opt => {
                    opt.onclick = () => {
                        $('impossibleOverlay5').style.display = 'none';
                        $('decisionPanel5').style.display = 'none';
                        if (opt.dataset.choice === 'chip') { GameState.stage5.budgetUsed += 200000; GameState.stage5.doseAccrued += 8.0; GameState.stage5.wasteGenerated += 15; GameState.stage5.events.push({ desc: 'Concrete chipped to find pipes (+15t ILW)' }); }
                        else { GameState.stage5.budgetUsed += 400000; GameState.stage5.doseAccrued += 3.0; GameState.stage5.wasteGenerated += 8; GameState.stage5.events.push({ desc: 'GPR used for targeted excavation' }); }
                        setTimeout(runDecomTask3, 1000);
                    };
                });
            } else {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--amber);">Walk-in tunnel - easy access but large void to fill</p></div>';
                setTimeout(() => { GameState.stage5.events.push({ desc: 'Pipes removed from tunnel (void backfill needed)' }); GameState.stage5.doseAccrued += 0.5; GameState.stage5.budgetUsed += 50000; runDecomTask3(); }, 2000);
            }
        }
        
        function runDecomTask3() {
            const choice = GameState.designChoices.materialSpec;
            const canvas = $('minigame5Canvas');
            $('minigame5Title').textContent = 'Final Handling';
            $('wasteGenerated').textContent = GameState.stage5.wasteGenerated + ' tonnes';
            $('minigame5Dose').textContent = '+' + GameState.stage5.doseAccrued.toFixed(1) + ' mSv';
            $('impossibleOverlay5').style.display = 'none';
            $('decisionPanel5').style.display = 'none';
            
            if (choice === 'lowCobalt') {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--green);">Low-cobalt steel - hands-on work possible</p><p>Direct handling for final sizing and packaging</p></div>';
                setTimeout(() => { GameState.stage5.events.push({ desc: 'Low-activity materials handled directly' }); GameState.stage5.doseAccrued += 0.5; GameState.stage5.wasteGenerated += 1; showDecomOutcome(); }, 2000);
            } else {
                canvas.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:16px;"><p style="color:var(--red);">High-activity material - remote handling required</p><p style="color:var(--amber);">Robot arms with 0.5s delay...</p></div>';
                setTimeout(() => {
                    if (choice === 'exoticAlloy') { GameState.stage5.events.push({ desc: 'Exotic alloy required specialist disposal' }); GameState.stage5.budgetUsed += 200000; GameState.stage5.doseAccrued += 1.5; }
                    else { GameState.stage5.events.push({ desc: 'High-cobalt steel required remote handling' }); GameState.stage5.budgetUsed += 150000; GameState.stage5.doseAccrued += 1.0; }
                    GameState.stage5.wasteGenerated += 3;
                    showDecomOutcome();
                }, 2500);
            }
        }
        
        function showDecomOutcome() {
            const totalWaste = GameState.stage5.wasteGenerated;
            const totalDose = GameState.stage5.doseAccrued;
            const totalCost = GameState.stage5.budgetUsed;
            let icon, title, titleClass, comment;
            
            if (totalDose < 5 && totalWaste < 10) { icon = '‚úì'; title = 'Excellent Work'; titleClass = 'success'; comment = "Smooth decommissioning. Good design choices sixty years ago made my life a lot easier. Wish they were all like this."; }
            else if (totalDose < 10 && totalWaste < 20) { icon = '‚ö†Ô∏è'; title = 'Completed'; titleClass = 'partial'; comment = "Got there in the end. Some frustrations, some extra costs, but nothing we couldn't handle. Could've been better, could've been worse."; }
            else { icon = '‚ùå'; title = 'Difficult'; titleClass = 'failure'; comment = "That was hard. Embedded pipes, high-activity materials, waste everywhere. Someone in 2025 made my job a nightmare. At least it's over."; }
            
            $('outcomeIcon5').textContent = icon;
            $('outcomeTitle5').textContent = title;
            $('outcomeTitle5').className = 'outcome-title ' + titleClass;
            $('outcomeComment5').textContent = comment;
            $('outcomeDescription5').innerHTML = '<p>Section 4B decommissioning tasks are complete.</p>';
            $('outcomeStats5').innerHTML = `
                <div class="outcome-stat"><div class="outcome-stat-label">Total Cost</div><div class="outcome-stat-value ${totalCost > 300000 ? 'negative' : 'neutral'}">${formatCurrency(totalCost)}</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Total Dose</div><div class="outcome-stat-value ${totalDose > 8 ? 'negative' : totalDose > 4 ? 'neutral' : 'positive'}">+${totalDose.toFixed(1)} mSv</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Waste Generated</div><div class="outcome-stat-value ${totalWaste > 15 ? 'negative' : totalWaste > 8 ? 'neutral' : 'positive'}">${totalWaste} tonnes</div></div>
            `;
            showScreen('outcome5');
        }
        
        function showStage5Summary() {
            GameState.meters.budgetSpent += GameState.stage5.budgetUsed;
            GameState.meters.dose += GameState.stage5.doseAccrued;
            $('stage5SummaryMeters').innerHTML = `
                <div class="summary-meter"><div class="summary-meter-icon">üí∞</div><div class="summary-meter-value">${formatCurrency(GameState.stage5.budgetUsed)}</div><div class="summary-meter-label">Cost</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">‚ò¢Ô∏è</div><div class="summary-meter-value">+${GameState.stage5.doseAccrued.toFixed(1)} mSv</div><div class="summary-meter-label">Dose</div></div>
                <div class="summary-meter"><div class="summary-meter-icon">üì¶</div><div class="summary-meter-value">${GameState.stage5.wasteGenerated}t</div><div class="summary-meter-label">Waste</div></div>
            `;
            $('stage5EventList').innerHTML = GameState.stage5.events.map(e => `<li><span class="decision-name">${e.desc}</span></li>`).join('');
            updateMeters();
            $('headerStage').innerHTML = '<strong>STAGE 5:</strong> COMPLETE';
            showScreen('stage5Summary');
        }
        
        // ============================================
        // FINAL RESULTS
        // ============================================
        function showFinalResults() {
            const totalBudget = 2850000;
            const spent = GameState.meters.budgetSpent;
            const dose = GameState.meters.dose;
            const health = GameState.meters.plantHealth;
            const injuries = GameState.injuries;
            const fatalities = GameState.fatalities || 0;
            const incidents = GameState.incidents.length;
            const waste = GameState.stage5.wasteGenerated || 0;
            
            // Rating calculation per spec
            let stars = 3, rating = 'Competent Engineer', message = '';
            
            if (fatalities > 0) {
                stars = 0; rating = 'Imprisoned';
                message = 'A worker died due to design decisions made in 2025. Criminal prosecution followed. This is not a game - these consequences are real.';
            } else if (injuries > 0 || dose > 40) {
                stars = 1; rating = 'Career Change Recommended';
                message = 'Major failures, worker injuries, regulatory investigation. The design choices made in 2025 caused preventable harm.';
            } else if (dose > 25 || spent > totalBudget * 1.4 || health < 40) {
                stars = 2; rating = 'Lessons to Learn';
                message = 'Significant cost overruns, elevated dose, multiple incidents. The design needed more consideration for the future.';
            } else if (dose > 15 || spent > totalBudget * 1.15 || health < 60 || incidents > 2) {
                stars = 3; rating = 'Needs Improvement';
                message = 'Over budget with elevated dose and some issues. Room for improvement in future designs.';
            } else if (dose <= 15 && spent <= totalBudget && health >= 60) {
                stars = 4; rating = 'Competent Engineer';
                message = 'Near budget, acceptable dose, good plant health. Solid design work with reasonable lifecycle outcomes.';
            }
            if (dose < 10 && spent < totalBudget * 0.9 && health > 80 && incidents === 0 && injuries === 0) {
                stars = 5; rating = 'Master Designer';
                message = 'Under budget, low dose, excellent plant health, no incidents. You demonstrated true design for decommissioning principles.';
            }
            
            $('resultsStars').textContent = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
            $('resultsRating').textContent = rating;
            $('finalStats').innerHTML = `
                <div class="outcome-stat"><div class="outcome-stat-label">Total Spent</div><div class="outcome-stat-value ${spent > totalBudget ? 'negative' : spent < totalBudget * 0.9 ? 'positive' : 'neutral'}">${formatCurrency(spent)}</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Lifecycle Budget</div><div class="outcome-stat-value">${formatCurrency(totalBudget)}</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Total Dose</div><div class="outcome-stat-value ${dose > 25 ? 'negative' : dose > 15 ? 'neutral' : 'positive'}">${dose.toFixed(1)} mSv</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Plant Health</div><div class="outcome-stat-value ${health < 60 ? 'negative' : health > 80 ? 'positive' : 'neutral'}">${health}%</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Waste Generated</div><div class="outcome-stat-value ${waste > 15 ? 'negative' : waste < 8 ? 'positive' : 'neutral'}">${waste} tonnes</div></div>
                <div class="outcome-stat"><div class="outcome-stat-label">Incidents</div><div class="outcome-stat-value ${incidents > 0 ? 'negative' : 'positive'}">${incidents}</div></div>
            `;
            $('resultsMessage').innerHTML = `<p><strong>The 60-Year Journey is complete.</strong></p><p>${message}</p><p>Every millimetre of clearance. Every material choice. Every access route. The future remembers.</p>`;
            $('headerStage').innerHTML = '<strong>COMPLETE</strong>';
            showScreen('results');
        }
        
        // ============================================
        // HINT SYSTEM
        // ============================================
        const Hints = {
            design: "Think about the future: How will workers access these components in 15, 30, 60 years? Cheap now often means expensive later.",
            pumpAccess: "A pump that can't be removed without cutting structures will cost hundreds of thousands to maintain.",
            weldClearance: "Inspectors need space for their probes. 50mm might fit a ruler, but not UT equipment.",
            controlPanel: "In an emergency at 3am, operators need to find controls instantly. Layout matters.",
            pipeConnections: "Welded joints are strong. But in 60 years, someone needs to take them apart.",
            pipeRouting: "Pipes in concrete? Good luck finding them in 2085.",
            materialSpec: "Low-cobalt steel costs more now, but it won't glow in the dark during decommissioning.",
            stage2: "Dave needs to remove equipment that was installed 15 years ago. Your design choices determine how hard that is.",
            stage3: "Sarah's inspection team needs clearance for their equipment. No clearance = no inspection = regulatory problems.",
            stage4: "When alarms sound at 3am, Mike's team needs to find controls fast. Panel design is life or death.",
            stage5: "Janet's dealing with everything you chose in 2025. Embedded pipes, welded joints, high-activity materials - it all comes home."
        };
        
        function showHint() {
            const screen = GameState.currentScreen;
            let hint = Hints.design;
            
            if (screen === 'design') {
                const incomplete = Object.entries(GameState.designChoices).find(([k, v]) => !v);
                hint = incomplete ? (Hints[incomplete[0]] || Hints.design) : "All elements selected. Review your choices before continuing.";
            } else if (screen.includes('minigame') || screen.includes('character')) {
                if (screen.includes('3')) hint = Hints.stage3;
                else if (screen.includes('4')) hint = Hints.stage4;
                else if (screen.includes('5')) hint = Hints.stage5;
                else hint = Hints.stage2;
            } else if (screen === 'transition' || screen === 'character') {
                hint = Hints.stage2;
            }
            
            $('hintText').textContent = hint;
            $('hintPanel').classList.add('active');
        }
        
        function closeHint() {
            $('hintPanel').classList.remove('active');
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        $('btnStart').onclick = () => showScreen('intro');
        $('btnBeginDesign').onclick = () => showScreen('design');
        $('btnCompleteDesign').onclick = showDesignSummary;
        $('btnContinueTo2040').onclick = showTransition;
        $('btnContinueTransition').onclick = showCharacterIntro;
        $('btnBeginStage').onclick = startPumpGame;
        $('btnContinueFromOutcome').onclick = showStage2Summary;
        $('btnContinueTo2055').onclick = () => showScreen('transition3');
        $('btnContinueTransition3').onclick = startStage3;
        $('btnBeginStage3').onclick = startInspectionGame;
        $('btnContinueFromOutcome3').onclick = showStage3Summary;
        $('btnContinueTo2070').onclick = () => showScreen('transition4');
        $('btnContinueTransition4').onclick = startStage4;
        $('btnBeginStage4').onclick = startControlRoomGame;
        $('btnContinueFromOutcome4').onclick = showStage4Summary;
        $('btnContinueTo2085').onclick = () => showScreen('transition5');
        $('btnContinueTransition5').onclick = startStage5;
        $('btnBeginStage5').onclick = startDecommissioningGame;
        $('btnContinueFromOutcome5').onclick = showStage5Summary;
        $('btnViewResults').onclick = showFinalResults;
        $('btnPlayAgain').onclick = () => location.reload();
        $('btnRestart').onclick = () => location.reload();
        
        $('modalClose').onclick = closeModal;
        $('btnCancelChoice').onclick = closeModal;
        $('btnConfirmChoice').onclick = confirmChoice;
        $('modalOverlay').onclick = e => { if (e.target === $('modalOverlay')) closeModal(); };
        
        $('mobileMenuBtn').onclick = () => $('mobileMeters').classList.toggle('active');
        $('hintBtn').onclick = showHint;
        $('hintClose').onclick = closeHint;
        
        $$('.hotspot').forEach(el => el.onclick = () => { if (el.dataset.element) openModal(el.dataset.element); });
        $$('.design-element-card').forEach(c => c.onclick = () => { if (c.dataset.element) openModal(c.dataset.element); });
        
        document.onkeydown = e => { if (e.key === 'Escape') { closeModal(); closeHint(); } };
        document.onclick = e => { if (!e.target.closest('.hint-panel') && !e.target.closest('.hint-btn')) closeHint(); };
        
        // Init
        updateMeters();
        updateDesignProgress();
    </script>
</body>
</html>
