<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 60-Year Journey</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --white: #f7f8fa;
            --light-grey: #d0d9e0;
            --mid-grey: #9babc2;
            --slate: #4a5d6b;
            --dark-slate: #364451;
            --deep-navy: #1f2937;
            --green: #92d050;
            --blue: #00b0f0;
            --orange: #cc5500;
            --red: #dc2626;
            --amber: #f59e0b;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--deep-navy);
            color: var(--light-grey);
        }
        
        /* Version tag */
        .version-tag {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: var(--mid-grey);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 9999;
        }
        
        /* ============================================
           CINEMATIC INTRO
           ============================================ */
        #cinematicIntro {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #000;
        }
        
        #cinematicIntro.hidden { display: none; }
        
        .intro-slide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        
        .intro-slide.active { opacity: 1; }
        
        .intro-slide .bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: brightness(0.35);
        }
        
        .intro-slide .bg.dark {
            background: linear-gradient(135deg, #0a1628, #1a2a3a, #0d1a2d);
            filter: none;
        }
        
        .intro-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 700px;
            padding: 40px;
        }
        
        .intro-logo img { max-width: 250px; margin-bottom: 30px; }
        .intro-company { color: var(--blue); text-transform: uppercase; letter-spacing: 4px; margin-bottom: 20px; }
        .intro-title { font-size: 3rem; color: var(--white); margin-bottom: 20px; }
        .intro-subtitle { font-size: 1.2rem; color: var(--light-grey); }
        
        .intro-text-box {
            background: rgba(31, 41, 55, 0.9);
            border-left: 4px solid var(--blue);
            padding: 30px;
            text-align: left;
            border-radius: 8px;
        }
        
        .intro-text-box p { margin-bottom: 15px; font-size: 1.1rem; line-height: 1.7; }
        .intro-text-box p:last-child { margin-bottom: 0; }
        .intro-text-box strong { color: var(--white); }
        .intro-text-box .highlight { color: var(--green); }
        
        .intro-year { font-size: 4rem; color: var(--blue); margin-bottom: 20px; }
        .intro-location { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        
        .intro-budget {
            display: inline-block;
            background: var(--green);
            color: var(--deep-navy);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 20px;
        }
        
        .intro-nav {
            position: absolute;
            bottom: 40px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }
        
        .intro-nav button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .intro-nav .btn-skip { background: transparent; color: var(--mid-grey); border: 1px solid var(--slate); }
        .intro-nav .btn-next { background: var(--blue); color: var(--deep-navy); }
        
        .intro-dots {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .intro-dot {
            width: 40px;
            height: 4px;
            background: var(--slate);
            border-radius: 2px;
            cursor: pointer;
        }
        
        .intro-dot.active { background: var(--blue); }
        .intro-dot.done { background: var(--green); }
        
        /* ============================================
           GAME LAYOUT
           ============================================ */
        #gameScreen {
            display: none;
            position: fixed;
            inset: 0;
            flex-direction: column;
        }
        
        #gameScreen.active { display: flex; }
        
        .top-bar {
            height: auto;
            background: var(--deep-navy);
            border-bottom: 1px solid var(--dark-slate);
            display: flex;
            flex-direction: column;
            padding: 10px 20px 0 20px;
            flex-shrink: 0;
        }
        
        .top-bar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .top-bar-logo img { height: 32px; }
        
        .top-bar-stats { display: flex; gap: 20px; font-size: 0.85rem; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .stat-value { color: var(--white); font-weight: 600; }
        .stat-value.warning { color: var(--amber); }
        .stat-value.danger { color: var(--red); }
        
        /* Timeline */
        .timeline-container {
            position: relative;
            padding: 0 40px 20px 40px;
        }
        
        .timeline-track {
            position: absolute;
            top: 24px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--slate);
            border-radius: 2px;
        }
        
        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--blue));
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .timeline-stages {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }
        
        .timeline-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .timeline-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--dark-slate);
            border: 3px solid var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .timeline-stage.completed .timeline-node {
            background: var(--green);
            border-color: var(--green);
            color: var(--deep-navy);
        }
        
        .timeline-stage.completed .timeline-node::after {
            content: '‚úì';
            position: absolute;
            font-size: 1.2rem;
        }
        
        .timeline-stage.current .timeline-node {
            background: var(--blue);
            border-color: var(--blue);
            color: var(--deep-navy);
            box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3);
            animation: currentPulse 2s infinite;
        }
        
        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0.1); }
        }
        
        .timeline-stage.future .timeline-node {
            background: var(--dark-slate);
            border-color: var(--slate);
            color: var(--slate);
        }
        
        .timeline-label {
            margin-top: 8px;
            text-align: center;
        }
        
        .timeline-year {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: color 0.3s;
        }
        
        .timeline-stage.completed .timeline-year,
        .timeline-stage.current .timeline-year {
            color: var(--white);
        }
        
        .timeline-name {
            font-size: 0.7rem;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            transition: color 0.3s;
        }
        
        .timeline-stage.current .timeline-name {
            color: var(--blue);
        }
        
        .timeline-stage.completed .timeline-name {
            color: var(--green);
        }
        
        .btn-next-stage {
            display: none;
            padding: 8px 16px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        .btn-next-stage.visible { display: block; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(146, 208, 80, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(146, 208, 80, 0); }
        }
        
        .character-banner {
            display: none;
            align-items: center;
            gap: 15px;
            background: var(--dark-slate);
            padding: 12px 20px;
            border-left: 4px solid var(--orange);
            flex-shrink: 0;
        }
        
        .character-banner.visible { display: flex; }
        .character-banner.dave { border-color: var(--orange); }
        .character-banner.sarah { border-color: var(--blue); }
        .character-banner.mike { border-color: var(--green); }
        .character-banner.janet { border-color: var(--mid-grey); }
        
        .char-portrait {
            width: 50px; height: 50px;
            border-radius: 8px;
            background: var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; }
        .char-info h4 { color: var(--white); margin-bottom: 2px; }
        .char-role { font-size: 0.85rem; color: var(--mid-grey); }
        
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #1a1a2e;
        }
        
        .map-wrapper { position: relative; max-width: 100%; max-height: 100%; }
        
        .map-wrapper img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 250px);
            object-fit: contain;
        }
        
        .hotspot {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        
        .hotspot-dot {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: rgba(0, 176, 240, 0.3);
            border: 3px solid var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            animation: hotspotPulse 2s infinite;
        }
        
        .hotspot:hover .hotspot-dot {
            transform: scale(1.15);
            background: rgba(0, 176, 240, 0.5);
        }
        
        .hotspot-dot.done {
            background: rgba(146, 208, 80, 0.3);
            border-color: var(--green);
            animation: none;
        }
        
        .hotspot-dot.done::after {
            content: '‚úì';
            color: var(--green);
            font-weight: bold;
        }
        
        .hotspot-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .hotspot:hover .hotspot-label { opacity: 1; }
        
        @keyframes hotspotPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0); }
        }
        
        .bottom-bar {
            height: 40px;
            background: var(--deep-navy);
            border-top: 1px solid var(--dark-slate);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .progress-label { color: var(--mid-grey); font-size: 0.85rem; }
        
        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--dark-slate);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--slate);
        }
        
        .modal-header h3 { color: var(--white); }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--mid-grey);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body { padding: 20px; }
        
        /* Situation description */
        .situation-box {
            background: var(--slate);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--blue);
        }
        
        .situation-box p {
            color: var(--light-grey);
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .situation-box p:last-child { margin-bottom: 0; }
        .situation-box strong { color: var(--white); }
        .situation-box em { color: var(--amber); font-style: normal; }
        
        /* Character quote */
        .char-quote {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: var(--deep-navy);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .char-quote .char-portrait { width: 45px; height: 45px; flex-shrink: 0; }
        .char-quote-text { font-style: italic; color: var(--light-grey); line-height: 1.5; }
        .char-quote-name { color: var(--white); font-weight: 500; font-size: 0.85rem; margin-bottom: 5px; font-style: normal; }
        
        /* Design recall */
        .design-recall {
            background: var(--deep-navy);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--mid-grey);
            margin-bottom: 15px;
        }
        
        .design-recall strong { color: var(--white); }
        
        /* Options list */
        .options-list { display: flex; flex-direction: column; gap: 10px; }
        
        .option-card {
            background: var(--slate);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .option-card:hover { border-color: var(--blue); }
        .option-card.selected { border-color: var(--green); background: rgba(146, 208, 80, 0.1); }
        .option-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: transparent;
        }
        .option-card.disabled:hover { border-color: transparent; }
        .option-card.disabled .option-cost { color: var(--red); }
        
        .disabled-reason {
            color: var(--red);
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .option-name { color: var(--white); font-weight: 500; }
        
        .option-cost {
            background: var(--deep-navy);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .option-cost.cheap { color: var(--green); }
        .option-cost.medium { color: var(--amber); }
        .option-cost.expensive { color: var(--red); }
        
        .option-desc { color: var(--light-grey); font-size: 0.9rem; margin-bottom: 10px; }
        
        .option-impacts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.8rem;
        }
        
        .impact { display: flex; align-items: center; gap: 4px; }
        .impact.negative { color: var(--red); }
        .impact.positive { color: var(--green); }
        .impact.neutral { color: var(--mid-grey); }
        
        /* Design choice (Stage 1) */
        .choice-image {
            width: 100%;
            height: 60px;
            background: var(--deep-navy);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid-grey);
            font-size: 0.75rem;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--slate);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary { background: var(--blue); color: var(--deep-navy); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn-secondary { background: var(--slate); color: var(--white); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* ============================================
           SCREENS (Transition, Summary, Results)
           ============================================ */
        .overlay-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 600;
            align-items: center;
            justify-content: center;
        }
        
        .overlay-screen.active { display: flex; }
        
        .overlay-content {
            text-align: center;
            max-width: 650px;
            padding: 40px;
        }
        
        .trans-years { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        .trans-year { font-size: 5rem; color: var(--white); margin-bottom: 30px; }
        
        .trans-text {
            background: var(--dark-slate);
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            margin-bottom: 30px;
        }
        
        .trans-text p { margin-bottom: 12px; line-height: 1.6; }
        .trans-text p:last-child { margin-bottom: 0; }
        
        .btn-continue {
            padding: 12px 30px;
            background: var(--blue);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Summary */
        .summary-title { font-size: 2rem; color: var(--white); margin-bottom: 10px; }
        .summary-subtitle { color: var(--mid-grey); margin-bottom: 25px; }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .summary-stat {
            background: var(--dark-slate);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-stat-icon { font-size: 1.3rem; margin-bottom: 5px; }
        .summary-stat-value { font-size: 1.2rem; font-weight: 600; color: var(--white); }
        .summary-stat-value.over { color: var(--red); }
        .summary-stat-label { font-size: 0.7rem; color: var(--mid-grey); text-transform: uppercase; margin-top: 3px; }
        
        .summary-decisions {
            background: var(--dark-slate);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .summary-decisions h4 { color: var(--white); margin-bottom: 12px; }
        
        .decision-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--slate);
            font-size: 0.9rem;
        }
        
        .decision-row:last-child { border-bottom: none; }
        .decision-element { color: var(--white); }
        
        .decision-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            max-width: 200px;
            text-align: right;
        }
        
        .decision-tag.good { background: var(--green); color: var(--deep-navy); }
        .decision-tag.ok { background: var(--amber); color: var(--deep-navy); }
        .decision-tag.poor { background: var(--red); color: var(--white); }
        
        .btn-next-phase {
            padding: 12px 30px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Results */
        .results-grade {
            font-size: 7rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .results-grade.A { color: var(--green); }
        .results-grade.B { color: var(--blue); }
        .results-grade.C { color: var(--amber); }
        .results-grade.D { color: var(--red); }
        
        .results-title { color: var(--white); margin-bottom: 20px; }
        .results-verdict { color: var(--light-grey); margin-bottom: 30px; font-size: 1.1rem; }
        
        .results-totals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: var(--dark-slate);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .results-total { text-align: center; }
        .results-total-value { font-size: 1.4rem; font-weight: 600; color: var(--white); }
        .results-total-label { font-size: 0.8rem; color: var(--mid-grey); }
        
        /* Mobile */
        @media (max-width: 768px) {
            .top-bar-stats { display: none; }
            .summary-stats, .results-totals { grid-template-columns: repeat(2, 1fr); }
            .intro-title { font-size: 2rem; }
            
            .timeline-container { padding: 0 10px 15px 10px; }
            .timeline-track { left: 30px; right: 30px; }
            .timeline-stage { min-width: 60px; }
            .timeline-node { width: 36px; height: 36px; font-size: 0.65rem; }
            .timeline-year { font-size: 0.8rem; }
            .timeline-name { font-size: 0.55rem; }
        }
        
        @media (max-width: 480px) {
            .timeline-name { display: none; }
            .timeline-node { width: 30px; height: 30px; font-size: 0.6rem; }
        }
    </style>
</head>
<body>

<!-- VERSION TAG -->
<div class="version-tag">v0.7</div>

<!-- CINEMATIC INTRO -->
<div id="cinematicIntro">
    <div class="intro-slide active" data-slide="1">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="The Nuclear House">
            </div>
            <p class="intro-company">Presents</p>
            <h1 class="intro-title">The 60-Year Journey</h1>
            <p class="intro-subtitle">An interactive experience in design for decommissioning</p>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="2">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <p class="intro-location">Somerset Coast, UK</p>
            <h2 class="intro-year">2025</h2>
            <div class="intro-text-box">
                <p><strong>Thornbury Point Nuclear Power Station.</strong></p>
                <p>Sixty years of operation ahead. Someone needs to design it right.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="3">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <div class="intro-text-box">
                <p>You've been assigned <span class="highlight">Section 4B</span>: Primary coolant system auxiliaries.</p>
                <p>Your design will be built, operated, inspected, and decommissioned over <strong>sixty years</strong>.</p>
                <p>Four people will inherit your choices. Their success depends on what you decide.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="4">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-text-box" style="text-align: center; border-left: none; border: 2px solid var(--blue);">
                <p><strong>Six design decisions. Each has consequences.</strong></p>
                <p>Good choices make future decisions easier and cheaper.<br>Poor choices force compromises for decades.</p>
                <div class="intro-budget">Design Budget: ¬£800,000</div>
            </div>
        </div>
    </div>
    
    <div class="intro-dots">
        <div class="intro-dot active" data-dot="1"></div>
        <div class="intro-dot" data-dot="2"></div>
        <div class="intro-dot" data-dot="3"></div>
        <div class="intro-dot" data-dot="4"></div>
    </div>
    
    <div class="intro-nav">
        <button class="btn-skip" id="btnSkip">Skip</button>
        <button class="btn-next" id="btnIntroNext">Continue ‚Üí</button>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
    <div class="top-bar">
        <div class="top-bar-header">
            <div class="top-bar-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="Logo">
            </div>
            <div class="top-bar-stats" id="topStats"></div>
            <button class="btn-next-stage" id="btnNextStage">Complete Stage ‚Üí</button>
        </div>
        <div class="timeline-container">
            <div class="timeline-track">
                <div class="timeline-progress" id="timelineProgress"></div>
            </div>
            <div class="timeline-stages" id="timelineStages">
                <div class="timeline-stage current" data-stage="1">
                    <div class="timeline-node">1</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2025</div>
                        <div class="timeline-name">Design</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="2">
                    <div class="timeline-node">2</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2040</div>
                        <div class="timeline-name">Maintenance</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="3">
                    <div class="timeline-node">3</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2055</div>
                        <div class="timeline-name">Inspection</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="4">
                    <div class="timeline-node">4</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2070</div>
                        <div class="timeline-name">Operations</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="5">
                    <div class="timeline-node">5</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2085</div>
                        <div class="timeline-name">Decommission</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="character-banner" id="characterBanner">
        <div class="char-portrait" id="charPortrait">üë∑</div>
        <div class="char-info">
            <h4 id="charName">Dave Morton</h4>
            <p class="char-role" id="charRole">Maintenance Supervisor</p>
        </div>
    </div>
    
    <div class="map-container">
        <div class="map-wrapper">
            <img src="images/gamebackground.png" alt="Section 4B">
            
            <div class="hotspot" data-element="pumpAccess" style="left: 18%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pump Access</span>
            </div>
            
            <div class="hotspot" data-element="weldClearance" style="left: 42%; top: 46%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Weld Clearance</span>
            </div>
            
            <div class="hotspot" data-element="controlPanel" style="left: 85%; top: 42%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Control Panel</span>
            </div>
            
            <div class="hotspot" data-element="pipeConnections" style="left: 56%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Connections</span>
            </div>
            
            <div class="hotspot" data-element="pipeRouting" style="left: 62%; top: 82%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Routing</span>
            </div>
            
            <div class="hotspot" data-element="materialSpec" style="left: 32%; top: 58%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Material Spec</span>
            </div>
        </div>
    </div>
    
    <div class="bottom-bar">
        <span class="progress-label" id="progressLabel">0 of 6 complete</span>
    </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Element</h3>
            <button class="modal-close" id="modalClose">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- TRANSITION SCREEN -->
<div class="overlay-screen" id="transitionScreen">
    <div class="overlay-content">
        <p class="trans-years" id="transYears">15 YEARS LATER</p>
        <h2 class="trans-year" id="transYear">2040</h2>
        <div class="trans-text" id="transText"></div>
        <button class="btn-continue" id="btnTransContinue">Continue ‚Üí</button>
    </div>
</div>

<!-- SUMMARY SCREEN -->
<div class="overlay-screen" id="summaryScreen">
    <div class="overlay-content">
        <h2 class="summary-title" id="sumTitle">Stage Complete</h2>
        <p class="summary-subtitle" id="sumSubtitle"></p>
        <div class="summary-stats" id="sumStats"></div>
        <div class="summary-decisions" id="sumDecisions"></div>
        <button class="btn-next-phase" id="btnNextPhase">Next Stage ‚Üí</button>
    </div>
</div>

<!-- RESULTS SCREEN -->
<div class="overlay-screen" id="resultsScreen">
    <div class="overlay-content">
        <div class="results-grade" id="resGrade">B</div>
        <h2 class="results-title">60 Years Complete</h2>
        <p class="results-verdict" id="resVerdict">Competent Engineer</p>
        <div class="results-totals" id="resTotals"></div>
        <button class="btn-continue" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
// ============================================
// GAME DATA - ALL STAGES HAVE DECISIONS
// Good design = easy/cheap options
// Poor design = hard/expensive options
// ============================================
const GAME_DATA = {
    stages: {
        1: { name: 'DESIGN', year: 2025, budget: 800000 },
        2: { name: 'MAINTENANCE', year: 2040, budget: 400000, time: 30, char: 'dave' },
        3: { name: 'INSPECTION', year: 2055, budget: 250000, time: 21, char: 'sarah' },
        4: { name: 'OPERATIONS', year: 2070, budget: 200000, time: 7, char: 'mike' },
        5: { name: 'DECOMMISSIONING', year: 2085, budget: 1200000, time: 90, char: 'janet' }
    },
    
    characters: {
        dave: { name: 'Dave Morton', role: 'Maintenance Supervisor', emoji: 'üë∑' },
        sarah: { name: 'Sarah Okonkwo', role: 'Principal Inspector', emoji: 'üîç' },
        mike: { name: 'Mike Brennan', role: 'Shift Operations Manager', emoji: 'üë®‚Äçüíº' },
        janet: { name: 'Janet Cole', role: 'Decommissioning Lead', emoji: 'üë©‚Äçüîß' }
    },
    
    transitions: {
        2: { years: '15 YEARS LATER', year: '2040', text: ['Thornbury Point has been generating power for 14 years.', 'Your design drawings are yellowed paper in a filing cabinet.', 'It\'s time for the first major maintenance outage.'] },
        3: { years: '15 YEARS LATER', year: '2055', text: ['Thirty years of operation.', 'Regulators want proof everything is still safe.', 'Every weld, every component needs inspection.'] },
        4: { years: '15 YEARS LATER', year: '2070', text: ['Forty-five years. The plant is showing its age.', 'Tonight, the alarms will test your control room design.'] },
        5: { years: '15 YEARS LATER', year: '2085', text: ['Sixty years. The reactor is shut down for good.', 'Now comes the hard part: taking it all apart safely.'] }
    },
    
    elements: {
        // ==========================================
        // ELEMENT 1: PUMP ACCESS
        // ==========================================
        pumpAccess: {
            title: 'Pump Location/Access',
            stage1: {
                description: 'How should the primary coolant pump be positioned?',
                options: [
                    { id: 'corner', name: 'Corner Position', desc: 'Tucked in corner to maximise floor space. 1.8m clearance.', cost: 80000, quality: 'poor' },
                    { id: 'openBay', name: 'Open Bay', desc: '2m clearance all sides, under crane rails.', cost: 120000, quality: 'good' },
                    { id: 'dedicated', name: 'Dedicated Shielded Room', desc: 'Separate room with airlock. Maximum protection.', cost: 200000, quality: 'wasteful' }
                ]
            },
            // STAGE 2: MAINTENANCE - Every design gets decisions, but difficulty varies
            stage2: {
                corner: {
                    situation: 'RCP seal replacement required. <strong>The pump is 2.1m wide. The gap to remove it is only 1.8m.</strong> It physically cannot fit through the access route.',
                    quote: "Who signed off on this? The pump doesn't fit through the gap!",
                    boxType: 'danger',
                    options: [
                        { id: 'subcontract', name: 'Hire specialist rigging team', desc: 'Experts with hydraulic jacks and custom rigging.', cost: 180000, time: 18, dose: 3 },
                        { id: 'force', name: 'Attempt to tilt and squeeze through', desc: 'Risky. May damage pump casing.', cost: 40000, time: 5, dose: 6, risk: 70 },
                        { id: 'modify', name: 'Cut access opening in wall', desc: 'Permanent structural modification.', cost: 120000, time: 14, dose: 4 }
                    ]
                },
                openBay: {
                    situation: 'RCP seal replacement required. Pump is positioned in open bay with full crane coverage.',
                    quote: 'Full crane access. Textbook lift. This is how it should be done.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard crane lift', desc: 'Routine operation. Lift, move, replace seals.', cost: 25000, time: 3, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced procedure with extra checks', desc: 'Additional inspections while pump is out.', cost: 40000, time: 4, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'RCP seal replacement required. Pump is accessible but airlock system adds complexity.',
                    quote: 'Nice room, but did we really need an airlock for this pump?',
                    boxType: 'warning',
                    options: [
                        { id: 'airlock', name: 'Full airlock protocol', desc: 'Follow all airlock procedures.', cost: 45000, time: 6, dose: 2 },
                        { id: 'bypass', name: 'Temporary airlock bypass', desc: 'Faster but creates contamination control paperwork.', cost: 35000, time: 4, dose: 2.5 }
                    ]
                }
            },
            // STAGE 3: INSPECTION
            stage3: {
                corner: {
                    situation: 'Pump casing and mounting bolts require UT inspection. <strong>Clearance is insufficient for standard probe positioning.</strong>',
                    quote: "I can't get the probe in at the right angle. Clearance is too tight.",
                    boxType: 'danger',
                    options: [
                        { id: 'scaffold', name: 'Erect scaffolding, use angled probes', desc: 'Partial coverage only. Document limitations.', cost: 45000, time: 5, dose: 3, trigger: 'pumpInspectionGap' },
                        { id: 'accept', name: 'Accept inspection limitation', desc: 'Mark as "inaccessible" in report. Regulatory note.', cost: 5000, time: 1, dose: 0.5, healthImpact: -10, trigger: 'pumpInspectionGap' },
                        { id: 'retrofit', name: 'Install permanent access platform', desc: 'Expensive but enables full inspection forever.', cost: 120000, time: 12, dose: 2 }
                    ]
                },
                openBay: {
                    situation: 'Pump casing and mounting bolts require UT inspection. Full access available.',
                    quote: 'Textbook access. Full probe coverage. No limitations.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard UT inspection', desc: 'Full coverage with standard equipment.', cost: 15000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced inspection with TOFD', desc: 'Additional technique for better defect sizing.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'Pump inspection required. Airlock protocols apply. Contamination controls add time.',
                    quote: 'Good access once you get in. The airlock just slows everything down.',
                    boxType: 'warning',
                    options: [
                        { id: 'standard', name: 'Standard inspection with airlock', desc: 'Follow full protocols.', cost: 25000, time: 4, dose: 1.5 },
                        { id: 'extended', name: 'Extended inspection during access', desc: 'Do extra work while in there to minimise entries.', cost: 35000, time: 5, dose: 2 }
                    ]
                }
            },
            // STAGE 4: OPERATIONS
            stage4: {
                corner: {
                    checkTrigger: 'pumpInspectionGap',
                    triggered: {
                        situation: '<strong>Night shift. Pump vibrations spiking.</strong> The problem is in the area that couldn\'t be inspected.',
                        quote: 'Vibrations from exactly where we couldn\'t inspect. What a surprise.',
                        boxType: 'danger',
                        options: [
                            { id: 'shutdown', name: 'Emergency shutdown for inspection', desc: 'Safe but expensive revenue loss.', cost: 150000, time: 5, dose: 2 },
                            { id: 'reduce', name: 'Reduce power to 50%', desc: 'Monitor closely. Hope it stabilises.', cost: 50000, time: 0, dose: 0, risk: 50, healthImpact: -5 },
                            { id: 'continue', name: 'Continue operation', desc: 'It might be fine. Or not.', cost: 0, time: 0, dose: 0, risk: 70, healthImpact: -15 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Pump operational review. Vibrations within normal range despite access limitations.',
                        quote: 'Running okay for now, but that corner position still worries me.',
                        boxType: 'warning',
                        options: [
                            { id: 'monitor', name: 'Enhanced monitoring programme', desc: 'Extra vibration sensors and analysis.', cost: 30000, time: 1, dose: 0 },
                            { id: 'continue', name: 'Standard monitoring', desc: 'Normal surveillance.', cost: 10000, time: 0, dose: 0 }
                        ]
                    }
                },
                openBay: {
                    situation: 'Pump operational review. All parameters nominal. Good access for any needed interventions.',
                    quote: 'Pump running like a dream. If we need to touch it, we can.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard monitoring', desc: 'Normal surveillance programme.', cost: 5000, time: 0, dose: 0 },
                        { id: 'predictive', name: 'Predictive maintenance analysis', desc: 'Advanced analytics to optimise next outage.', cost: 15000, time: 0, dose: 0 }
                    ]
                },
                dedicated: {
                    situation: 'Pump operational review. Running well but airlock maintenance is due.',
                    quote: 'Pump is fine. The airlock servicing is the headache.',
                    boxType: 'warning',
                    options: [
                        { id: 'service', name: 'Full airlock service', desc: 'Maintain the unnecessary system.', cost: 25000, time: 2, dose: 0.5 },
                        { id: 'defer', name: 'Defer airlock maintenance', desc: 'Not strictly required yet.', cost: 5000, time: 0, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            // STAGE 5: DECOMMISSIONING
            stage5: {
                corner: {
                    situation: 'Pump removal required. <strong>Same problem as 2040: it doesn\'t fit through the access route.</strong>',
                    quote: "Sixty years later and we're still dealing with that corner position.",
                    boxType: 'danger',
                    options: [
                        { id: 'demolish', name: 'Demolish wall section', desc: 'Create access by removing concrete.', cost: 80000, time: 15, dose: 4 },
                        { id: 'cut', name: 'Cut pump into pieces in-situ', desc: 'Manual cutting in confined space.', cost: 60000, time: 20, dose: 8 },
                        { id: 'robot', name: 'Robotic cutting and removal', desc: 'Expensive but minimises dose.', cost: 200000, time: 8, dose: 1 }
                    ]
                },
                openBay: {
                    situation: 'Pump removal. Reverse of installation. Full crane access.',
                    quote: 'Hook on, lift out, job done. This is how decommissioning should work.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard crane removal', desc: 'Lift and containerise.', cost: 20000, time: 3, dose: 1 },
                        { id: 'segmented', name: 'Segmented removal for recycling', desc: 'More work but enables material segregation.', cost: 35000, time: 5, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'Pump easily removed, but <strong>the entire shielded room must also be decommissioned.</strong>',
                    quote: 'Pump out in a day. Room decontamination? That\'s weeks.',
                    boxType: 'warning',
                    options: [
                        { id: 'full', name: 'Full room decommissioning', desc: 'Pump plus unnecessary room structures.', cost: 150000, time: 12, dose: 2 },
                        { id: 'seal', name: 'Remove pump, seal room for later', desc: 'Defer room work but creates future liability.', cost: 60000, time: 5, dose: 1, healthImpact: -5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 2: WELD CLEARANCE
        // ==========================================
        weldClearance: {
            title: 'Weld Access Clearance',
            stage1: {
                description: 'What clearance around pipe welds for inspection access?',
                options: [
                    { id: '50mm', name: '50mm (Code Minimum)', desc: 'Meets code but just barely.', cost: 60000, quality: 'poor' },
                    { id: '150mm', name: '150mm Clearance', desc: 'Adequate for all standard probes.', cost: 90000, quality: 'good' },
                    { id: '300mm', name: '300mm + Permanent Scaffolding', desc: 'Maximum clearance with fixed platforms.', cost: 160000, quality: 'wasteful' }
                ]
            },
            stage2: {
                '50mm': {
                    situation: 'Weld repair needed. <strong>50mm clearance too tight for comfortable welding position.</strong>',
                    quote: "50mm. The absolute minimum. And now we're paying for it.",
                    boxType: 'danger',
                    options: [
                        { id: 'awkward', name: 'Weld in awkward position', desc: 'Possible but poor quality risk.', cost: 15000, time: 4, dose: 4, risk: 20, healthImpact: -5 },
                        { id: 'platform', name: 'Install temporary platform', desc: 'Better position, better weld.', cost: 35000, time: 6, dose: 2 },
                        { id: 'defer', name: 'Defer repair to next outage', desc: 'Risk leaving defect in place.', cost: 0, time: 0, dose: 0, healthImpact: -5, trigger: 'weldDeferred' }
                    ]
                },
                '150mm': {
                    situation: 'Weld repair needed. Standard clearance available.',
                    quote: 'Proper clearance. Welder can get in comfortably.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard weld repair', desc: 'Normal procedure.', cost: 20000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced repair with PWHT', desc: 'Post-weld heat treatment for longevity.', cost: 30000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld repair needed. <strong>Permanent scaffolding has surface contamination.</strong>',
                    quote: 'Plenty of room, but that scaffolding is now contaminated.',
                    boxType: 'warning',
                    options: [
                        { id: 'decon', name: 'Decontaminate scaffolding first', desc: 'Clean before repair work.', cost: 30000, time: 4, dose: 2 },
                        { id: 'remove', name: 'Remove contaminated scaffolding', desc: 'Creates waste but clears the area.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                }
            },
            stage3: {
                '50mm': {
                    situation: 'In-Service Inspection required. <strong>UT probe needs 80mm clearance. You have 50mm.</strong>',
                    quote: "Can't get proper probe angle. I'll have to document 'limited coverage'.",
                    boxType: 'danger',
                    options: [
                        { id: 'partial', name: 'Accept 60% coverage', desc: 'Document limitation. Regulatory note.', cost: 5000, time: 3, dose: 3, healthImpact: -10, trigger: 'weldInspectionGap' },
                        { id: 'miniprobe', name: 'Specialist miniature probes', desc: 'Reduced accuracy but better coverage.', cost: 40000, time: 5, dose: 4, healthImpact: -5 },
                        { id: 'excavate', name: 'Excavate wall for access', desc: 'Permanent improvement.', cost: 90000, time: 10, dose: 3 }
                    ]
                },
                '150mm': {
                    situation: 'In-Service Inspection. Full probe access available.',
                    quote: 'Full coverage. Every weld scanned properly.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard UT examination', desc: '100% coverage achieved.', cost: 15000, time: 2, dose: 1 },
                        { id: 'phased', name: 'Phased array for enhanced detection', desc: 'Better defect characterisation.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld inspection. Scaffolding partially blocks some probe angles.',
                    quote: 'Scaffolding is in the way of some shots. We can work around it.',
                    boxType: 'warning',
                    options: [
                        { id: 'workaround', name: 'Work around scaffolding', desc: 'Some awkward angles but achievable.', cost: 20000, time: 4, dose: 2 },
                        { id: 'survey', name: 'Add scaffolding contamination survey', desc: 'Check the scaffolding condition too.', cost: 30000, time: 5, dose: 2.5 }
                    ]
                }
            },
            stage4: {
                '50mm': {
                    checkTrigger: 'weldInspectionGap',
                    triggered: {
                        situation: '<strong>Leak detected at weld location that couldn\'t be inspected.</strong> Activity in secondary system.',
                        quote: 'Leak exactly where we couldn\'t see. Who could have predicted this?',
                        boxType: 'danger',
                        options: [
                            { id: 'shutdown', name: 'Immediate shutdown and repair', desc: 'Fix it properly.', cost: 200000, time: 14, dose: 5 },
                            { id: 'seal', name: 'Online leak sealing', desc: 'Temporary fix. May not hold.', cost: 50000, time: 2, dose: 2, risk: 40, healthImpact: -10 },
                            { id: 'reduce', name: 'Reduce power and monitor', desc: 'Live with it until next outage.', cost: 80000, time: 0, dose: 0, healthImpact: -5 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Weld operational review. No indications from the areas that could be inspected.',
                        quote: 'What we could see looks fine. What we couldn\'t see... who knows.',
                        boxType: 'warning',
                        options: [
                            { id: 'monitor', name: 'Enhanced leak monitoring', desc: 'Extra detection equipment.', cost: 25000, time: 1, dose: 0 },
                            { id: 'standard', name: 'Standard monitoring', desc: 'Normal programme.', cost: 10000, time: 0, dose: 0 }
                        ]
                    }
                },
                '150mm': {
                    situation: 'Weld operational review. All welds fully inspected at Year 30. No concerns.',
                    quote: 'Full inspection history. Full confidence. No surprises.',
                    boxType: 'good',
                    options: [
                        { id: 'maintain', name: 'Maintain inspection programme', desc: 'Continue proven approach.', cost: 5000, time: 0, dose: 0 },
                        { id: 'extend', name: 'Extend to additional welds', desc: 'Broaden the programme.', cost: 15000, time: 1, dose: 0.5 }
                    ]
                },
                '300mm': {
                    situation: 'Welds fine. Scaffolding contamination increasing. Annual surveys required.',
                    quote: 'Welds okay. That scaffolding keeps getting hotter though.',
                    boxType: 'warning',
                    options: [
                        { id: 'survey', name: 'Annual scaffolding survey', desc: 'Track contamination build-up.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'remove', name: 'Remove scaffolding now', desc: 'Deal with it before it gets worse.', cost: 40000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                '50mm': {
                    situation: 'Weld cutting for pipe removal. <strong>No room for proper cutting equipment.</strong>',
                    quote: 'Tight clearance for cutting. Contamination spread is likely.',
                    boxType: 'danger',
                    options: [
                        { id: 'manual', name: 'Manual cutting in confined space', desc: 'High dose, contamination risk.', cost: 30000, time: 8, dose: 5, risk: 40 },
                        { id: 'specialist', name: 'Specialist confined space contractor', desc: 'Experts with proper equipment.', cost: 100000, time: 5, dose: 2 }
                    ]
                },
                '150mm': {
                    situation: 'Weld cutting for removal. Standard access.',
                    quote: 'Clean cuts. In and out. Professional job.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard cutting and removal', desc: 'Normal procedures.', cost: 25000, time: 3, dose: 1 },
                        { id: 'segregate', name: 'Cut with material segregation', desc: 'Separate for recycling.', cost: 35000, time: 4, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld cutting easy. <strong>Scaffolding is now ILW after 30 years of contamination.</strong>',
                    quote: 'Easy weld access. But now we have ILW scaffolding to dispose of.',
                    boxType: 'warning',
                    options: [
                        { id: 'both', name: 'Remove welds and scaffolding together', desc: 'Deal with unnecessary waste.', cost: 85000, time: 8, dose: 3 },
                        { id: 'defer', name: 'Welds now, scaffolding later', desc: 'Split the work but extends project.', cost: 50000, time: 5, dose: 2, healthImpact: -3 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 3: CONTROL PANEL
        // ==========================================
        controlPanel: {
            title: 'Control Panel Layout',
            stage1: {
                description: 'How should the control panel be organised?',
                options: [
                    { id: 'system', name: 'System-Based Layout', desc: 'Grouped by system (all pump controls together).', cost: 70000, quality: 'poor' },
                    { id: 'task', name: 'Task-Based Layout', desc: 'Grouped by workflow. Emergency sequence left-to-right.', cost: 100000, quality: 'good' },
                    { id: 'touch', name: 'Touchscreen Interface', desc: 'Modern digital displays. Impressive technology.', cost: 150000, quality: 'poor' }
                ]
            },
            stage2: {
                system: {
                    situation: 'Operators submitted <strong>15 "human factors concern" reports</strong> citing confusion during abnormal conditions.',
                    quote: 'The operators can\'t find controls during emergencies. That\'s a problem.',
                    boxType: 'danger',
                    options: [
                        { id: 'redesign', name: 'Commission HF review and redesign', desc: 'Fix the layout properly.', cost: 60000, time: 0, dose: 0, setFlag: 'panelRedesigned' },
                        { id: 'labels', name: 'Add labels and colour coding', desc: 'Cheap fix. Limited improvement.', cost: 15000, time: 0, dose: 0 },
                        { id: 'nothing', name: 'Issue reminder to operators', desc: 'Training will fix it. Maybe.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                task: {
                    situation: 'Control room operations review. Operators report intuitive layout.',
                    quote: 'Panel works well. Operators find what they need.',
                    boxType: 'good',
                    options: [
                        { id: 'maintain', name: 'Standard maintenance', desc: 'Keep it running.', cost: 10000, time: 0, dose: 0 },
                        { id: 'enhance', name: 'Add status display enhancements', desc: 'Minor improvements.', cost: 20000, time: 0, dose: 0 }
                    ]
                },
                touch: {
                    situation: '<strong>3 touchscreen failures</strong> in 15 years. Operators report issues with gloves and low-light.',
                    quote: 'Touchscreens in a control room. With gloves. Brilliant idea.',
                    boxType: 'danger',
                    options: [
                        { id: 'backup', name: 'Install hardwired backup panel', desc: 'Safety backup for when screens fail.', cost: 70000, time: 0, dose: 0, setFlag: 'backupPanel' },
                        { id: 'upgrade', name: 'Upgrade to industrial touchscreens', desc: 'Better screens. Still touchscreens.', cost: 50000, time: 0, dose: 0 },
                        { id: 'train', name: 'Additional operator training', desc: 'Train them to use broken equipment.', cost: 10000, time: 0, dose: 0 }
                    ]
                }
            },
            stage3: {
                system: {
                    situation: 'Control systems safety review. HMI assessment required.',
                    quote: 'The layout still causes confusion. Regulators are noting it.',
                    boxType: 'warning',
                    options: [
                        { id: 'review', name: 'Full HMI review with recommendations', desc: 'Detailed assessment.', cost: 20000, time: 2, dose: 0 },
                        { id: 'minimal', name: 'Minimal compliance review', desc: 'Do the minimum.', cost: 8000, time: 1, dose: 0 }
                    ]
                },
                task: {
                    situation: 'Control systems safety review. Good human factors ratings.',
                    quote: 'Operators rate the panel highly. No issues.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard review', desc: 'Confirm continued performance.', cost: 10000, time: 1, dose: 0 },
                        { id: 'benchmark', name: 'Benchmark against best practice', desc: 'Compare to industry leaders.', cost: 18000, time: 2, dose: 0 }
                    ]
                },
                touch: {
                    situation: 'Safety review. Display artifacts and software issues noted.',
                    quote: 'Software showing its age. More glitches every year.',
                    boxType: 'warning',
                    options: [
                        { id: 'software', name: 'Full software update', desc: 'Update the system.', cost: 35000, time: 2, dose: 0 },
                        { id: 'patch', name: 'Critical patches only', desc: 'Fix the worst bugs.', cost: 15000, time: 1, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                system: {
                    checkFlag: 'panelRedesigned',
                    hasFlag: {
                        situation: 'ALARMS: Loss of Coolant indication. Panel was redesigned - improved layout.',
                        quote: 'Found the controls. Good thing we fixed that panel.',
                        boxType: 'warning',
                        options: [
                            { id: 'respond', name: 'Respond using improved panel', desc: 'Minor delay but manageable.', cost: 20000, time: 1, dose: 1 },
                            { id: 'senior', name: 'Call shift supervisor backup', desc: 'Extra support for complex event.', cost: 5000, time: 1, dose: 0.5 }
                        ]
                    },
                    noFlag: {
                        situation: '<strong>ALARMS: Loss of Coolant indication.</strong> Controls scattered across panel. You can\'t find the isolation valve.',
                        quote: "3am, alarms everywhere, where's that valve?!",
                        boxType: 'danger',
                        options: [
                            { id: 'search', name: 'Search for correct controls', desc: 'Delayed response. Possible errors.', cost: 50000, time: 2, dose: 3, risk: 40, healthImpact: -10 },
                            { id: 'senior', name: 'Call senior operator immediately', desc: 'Get help. Your failure recorded.', cost: 10000, time: 1, dose: 1, trigger: 'operatorFailure' },
                            { id: 'procedure', name: 'Follow procedure step by step', desc: 'Slow but reduces error chance.', cost: 30000, time: 3, dose: 2 }
                        ]
                    }
                },
                task: {
                    situation: 'ALARMS: Loss of Coolant indication. Panel layout matches emergency procedure.',
                    quote: 'Reactor trip, safety injection, isolation. All in sequence. Perfect.',
                    boxType: 'good',
                    options: [
                        { id: 'respond', name: 'Follow emergency procedure', desc: 'Textbook response.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'verify', name: 'Respond with extra verification', desc: 'Additional checks.', cost: 8000, time: 0, dose: 0.5 }
                    ]
                },
                touch: {
                    checkFlag: 'backupPanel',
                    hasFlag: {
                        situation: 'ALARMS: Touchscreen lagging under load. Switch to backup panel.',
                        quote: 'Screen frozen again. Thank God for the backup.',
                        boxType: 'warning',
                        options: [
                            { id: 'backup', name: 'Use hardwired backup', desc: 'Reliable manual controls.', cost: 15000, time: 1, dose: 1 },
                            { id: 'wait', name: 'Wait for screen to recover', desc: 'Risky delay.', cost: 0, time: 2, dose: 0, risk: 30, healthImpact: -5 }
                        ]
                    },
                    noFlag: {
                        situation: '<strong>ALARMS: Touchscreen frozen.</strong> Gloved fingers not registering. No backup panel.',
                        quote: 'Screen\'s frozen! We have nothing else!',
                        boxType: 'danger',
                        options: [
                            { id: 'reboot', name: 'Attempt system reboot', desc: 'Fast but risky.', cost: 0, time: 2, dose: 0, risk: 50, healthImpact: -15 },
                            { id: 'manual', name: 'Manual field operation', desc: 'Send operators to local panels.', cost: 30000, time: 4, dose: 4 },
                            { id: 'scram', name: 'Manual reactor trip', desc: 'Safe shutdown. Full investigation.', cost: 100000, time: 5, dose: 1 }
                        ]
                    }
                }
            },
            stage5: {
                system: {
                    situation: 'Control panel decommissioning. Standard electrical removal.',
                    quote: 'Panel comes out. Wish the operators had had something better.',
                    boxType: 'neutral',
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'preserve', name: 'Preserve for training museum', desc: 'Educational purposes.', cost: 20000, time: 3, dose: 0.5 }
                    ]
                },
                task: {
                    situation: 'Control panel decommissioning. Well-designed panel served well.',
                    quote: 'Sixty years of good service. Panel did its job.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'document', name: 'Document as best practice example', desc: 'Capture lessons for future.', cost: 15000, time: 2, dose: 0.5 }
                    ]
                },
                touch: {
                    situation: 'Touchscreen decommissioning. Electronic waste requiring special disposal.',
                    quote: 'E-waste. Special handling. Of course.',
                    boxType: 'warning',
                    options: [
                        { id: 'ewaste', name: 'Specialist e-waste disposal', desc: 'Proper handling of electronics.', cost: 30000, time: 3, dose: 0 },
                        { id: 'strip', name: 'Strip valuable components first', desc: 'Recovery before disposal.', cost: 20000, time: 4, dose: 0.5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 4: PIPE CONNECTIONS
        // ==========================================
        pipeConnections: {
            title: 'Pipe Connections',
            stage1: {
                description: 'How should pipe joints be designed?',
                options: [
                    { id: 'welded', name: 'All Welded', desc: 'Continuous welds throughout. No break points.', cost: 100000, quality: 'poor' },
                    { id: 'flanged', name: 'Flanged at Strategic Points', desc: 'Bolted flanges every 6m and at components.', cost: 130000, quality: 'good' },
                    { id: 'excessive', name: 'Flanges Everywhere', desc: 'Flanged every 2m. Maximum flexibility.', cost: 180000, quality: 'wasteful' }
                ]
            },
            stage2: {
                welded: {
                    situation: 'Pipe section replacement needed. <strong>All welded - must cut and re-weld.</strong>',
                    quote: 'All welded. So we\'re cutting, grinding, and re-welding then.',
                    boxType: 'danger',
                    options: [
                        { id: 'replace', name: 'Cut, replace, re-weld', desc: 'Proper repair. High dose.', cost: 65000, time: 8, dose: 5 },
                        { id: 'overlay', name: 'Weld overlay repair', desc: 'Temporary patch. May need revisiting.', cost: 25000, time: 3, dose: 3, healthImpact: -5, trigger: 'weldOverlay' }
                    ]
                },
                flanged: {
                    situation: 'Pipe section replacement. Flanged connections available.',
                    quote: 'Unbolt, remove, replace. Someone thought ahead.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard flange replacement', desc: 'Unbolt and replace section.', cost: 30000, time: 3, dose: 1.5 },
                        { id: 'upgrade', name: 'Upgrade gaskets while open', desc: 'Better gasket material.', cost: 40000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: '<strong>Three gasket failures</strong> this outage. Too many flanges means too many leak paths.',
                    quote: 'Another gasket gone. That\'s the third this week.',
                    boxType: 'warning',
                    options: [
                        { id: 'replace', name: 'Replace all gaskets preventively', desc: 'Do them all now.', cost: 45000, time: 5, dose: 2 },
                        { id: 'reactive', name: 'Replace only failed gaskets', desc: 'Fix what\'s broken.', cost: 15000, time: 2, dose: 1, healthImpact: -3 }
                    ]
                }
            },
            stage3: {
                welded: {
                    situation: 'All welds require inspection. <strong>Large number of weld examinations.</strong>',
                    quote: 'Every joint is a weld. Every weld needs UT.',
                    boxType: 'warning',
                    options: [
                        { id: 'full', name: 'Full inspection programme', desc: 'Examine every weld.', cost: 50000, time: 7, dose: 4 },
                        { id: 'sample', name: 'Sample 50% of welds', desc: 'Risk missing defects.', cost: 25000, time: 4, dose: 2, healthImpact: -5 }
                    ]
                },
                flanged: {
                    situation: 'Limited weld inspections. Flanges visually checked.',
                    quote: 'Few welds to check. Flanges look fine.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard inspection programme', desc: 'Welds and flange checks.', cost: 20000, time: 3, dose: 1.5 },
                        { id: 'torque', name: 'Add bolt torque verification', desc: 'Extra flange checks.', cost: 28000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: '47 flanged connections to inspect. Many gaskets showing wear.',
                    quote: 'Forty-seven flanges. I\'ll be checking bolts all week.',
                    boxType: 'warning',
                    options: [
                        { id: 'all', name: 'Inspect all 47 connections', desc: 'Thorough but time-consuming.', cost: 35000, time: 6, dose: 2.5 },
                        { id: 'sample', name: 'Sample inspection', desc: 'Check high-risk locations.', cost: 20000, time: 3, dose: 1.5, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                welded: {
                    situation: 'Piping operational review. No isolation flexibility for online work.',
                    quote: 'Need to do online maintenance. Can\'t isolate without shutdown.',
                    boxType: 'warning',
                    options: [
                        { id: 'defer', name: 'Defer work to next outage', desc: 'Wait for full shutdown.', cost: 10000, time: 0, dose: 0 },
                        { id: 'partial', name: 'Partial shutdown for access', desc: 'Reduced power for maintenance.', cost: 40000, time: 2, dose: 1 }
                    ]
                },
                flanged: {
                    situation: 'Piping review. Quick isolation possible for online work.',
                    quote: 'Need to check that valve. No problem, we can isolate.',
                    boxType: 'good',
                    options: [
                        { id: 'online', name: 'Online maintenance', desc: 'Isolate and work at power.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'defer', name: 'Defer to outage', desc: 'Not urgent. Can wait.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                excessive: {
                    situation: 'Two more gasket failures this operating period.',
                    quote: 'More gaskets leaking. This is getting old.',
                    boxType: 'warning',
                    options: [
                        { id: 'repair', name: 'Repair during short outage', desc: 'Fix the leaks.', cost: 30000, time: 3, dose: 1 },
                        { id: 'monitor', name: 'Monitor and manage', desc: 'Live with minor seepage.', cost: 10000, time: 0, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage5: {
                welded: {
                    situation: '<strong>12 welds to cut for removal.</strong> Each cut risks contamination spread.',
                    quote: 'Cutting all day. Every joint needs the saw.',
                    boxType: 'danger',
                    options: [
                        { id: 'careful', name: 'Careful cutting programme', desc: 'Slow and controlled.', cost: 80000, time: 15, dose: 8, risk: 30 },
                        { id: 'specialist', name: 'Specialist cutting contractor', desc: 'Experts guarantee clean cuts.', cost: 180000, time: 10, dose: 3 }
                    ]
                },
                flanged: {
                    situation: 'Unbolt flanges. Lift sections out.',
                    quote: 'Unbolt, remove, done. Decommissioning the way it should be.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard disassembly', desc: 'Unbolt and remove.', cost: 40000, time: 6, dose: 2 },
                        { id: 'segregate', name: 'Segregate for recycling', desc: 'Separate materials.', cost: 55000, time: 8, dose: 2.5 }
                    ]
                },
                excessive: {
                    situation: '47 connections to unbolt. Many contaminated gaskets.',
                    quote: 'So many flanges. So many gaskets to dispose of.',
                    boxType: 'warning',
                    options: [
                        { id: 'full', name: 'Full disassembly', desc: 'All 47 connections.', cost: 55000, time: 10, dose: 3 },
                        { id: 'bulk', name: 'Cut into larger sections', desc: 'Fewer disconnections.', cost: 45000, time: 8, dose: 2.5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 5: PIPE ROUTING
        // ==========================================
        pipeRouting: {
            title: 'Pipe Routing',
            stage1: {
                description: 'How should pipes run through concrete structure?',
                options: [
                    { id: 'embedded', name: 'Embedded in Concrete', desc: 'Cast directly into structural concrete.', cost: 90000, quality: 'poor' },
                    { id: 'ducted', name: 'Accessible Ducts', desc: 'Removable duct covers for access.', cost: 130000, quality: 'good' },
                    { id: 'tunnel', name: 'Walk-In Tunnel', desc: 'Large accessible service tunnel.', cost: 220000, quality: 'wasteful' }
                ]
            },
            stage2: {
                embedded: {
                    situation: '<strong>Suspected leak in embedded section. Cannot visually confirm.</strong>',
                    quote: "There's a leak somewhere in that concrete. Good luck finding it.",
                    boxType: 'danger',
                    options: [
                        { id: 'excavate', name: 'Excavate concrete to find leak', desc: 'Dig until you find it.', cost: 70000, time: 12, dose: 4 },
                        { id: 'bypass', name: 'Install bypass line', desc: 'Route around the problem.', cost: 90000, time: 8, dose: 2 },
                        { id: 'defer', name: 'Increase monitoring, defer', desc: 'Hope it stabilises.', cost: 10000, time: 0, dose: 0, healthImpact: -10, trigger: 'embeddedLeak' }
                    ]
                },
                ducted: {
                    situation: 'Minor leak at joint. Visible through duct access.',
                    quote: 'Pulled the duct cover. There\'s the leak. Easy fix.',
                    boxType: 'good',
                    options: [
                        { id: 'repair', name: 'Standard repair', desc: 'Fix the joint.', cost: 15000, time: 2, dose: 1 },
                        { id: 'inspect', name: 'Repair and inspect neighbouring joints', desc: 'Check while you\'re there.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Leak repaired. <strong>Tunnel surfaces showing contamination migration.</strong>',
                    quote: 'Easy access for repair. But the tunnel walls are contaminated now.',
                    boxType: 'warning',
                    options: [
                        { id: 'repair', name: 'Repair and decontaminate', desc: 'Clean the surfaces.', cost: 35000, time: 4, dose: 2 },
                        { id: 'seal', name: 'Repair and seal contamination', desc: 'Contain it for now.', cost: 25000, time: 3, dose: 1.5, healthImpact: -3 }
                    ]
                }
            },
            stage3: {
                embedded: {
                    situation: '<strong>Embedded sections cannot be inspected by conventional means.</strong>',
                    quote: 'How do I inspect pipes inside concrete? I can\'t.',
                    boxType: 'danger',
                    options: [
                        { id: 'accept', name: 'Document inspection gap', desc: 'Accept the limitation.', cost: 5000, time: 1, dose: 0, healthImpact: -10, trigger: 'embeddedInspectionGap' },
                        { id: 'guided', name: 'Install guided wave monitoring', desc: 'Some detection capability.', cost: 60000, time: 5, dose: 1 },
                        { id: 'excavate', name: 'Excavate sample locations', desc: 'Physically expose sections.', cost: 100000, time: 14, dose: 5 }
                    ]
                },
                ducted: {
                    situation: 'Full pipe inspection via duct access.',
                    quote: 'Covers off, full access, complete inspection.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Visual and UT.', cost: 15000, time: 3, dose: 1.5 },
                        { id: 'coating', name: 'Inspect and assess coating', desc: 'Check protective layers.', cost: 22000, time: 4, dose: 2 }
                    ]
                },
                tunnel: {
                    situation: 'Pipe inspection in contaminated tunnel. Full PPE required.',
                    quote: 'Easy access but hot in here. Full suits required.',
                    boxType: 'warning',
                    options: [
                        { id: 'suited', name: 'Full inspection in PPE', desc: 'Longer due to suit restrictions.', cost: 25000, time: 5, dose: 3 },
                        { id: 'remote', name: 'Remote camera inspection', desc: 'Limited but lower dose.', cost: 30000, time: 4, dose: 1, healthImpact: -2 }
                    ]
                }
            },
            stage4: {
                embedded: {
                    checkTrigger: 'embeddedLeak',
                    triggered: {
                        situation: '<strong>Groundwater monitoring detects activity. Source: embedded pipe section.</strong>',
                        quote: 'Contamination in the groundwater. The leak we couldn\'t fix.',
                        boxType: 'danger',
                        additionalCosts: { regulatory: 50000, environmental: 100000, healthImpact: -15 },
                        options: [
                            { id: 'excavate', name: 'Emergency excavation', desc: 'Dig out and repair now.', cost: 200000, time: 21, dose: 8 },
                            { id: 'treat', name: 'Groundwater treatment + isolation', desc: 'Treat water, abandon pipe.', cost: 150000, time: 7, dose: 2 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Embedded section monitoring. No activity detected.',
                        quote: 'Monitoring shows nothing. For now.',
                        boxType: 'warning',
                        options: [
                            { id: 'maintain', name: 'Continue monitoring programme', desc: 'Keep watching.', cost: 15000, time: 0, dose: 0 },
                            { id: 'enhance', name: 'Enhanced groundwater monitoring', desc: 'More detection points.', cost: 30000, time: 1, dose: 0 }
                        ]
                    }
                },
                ducted: {
                    situation: 'Duct access enables quick visual checks during operation.',
                    quote: 'Quick look through the duct cover. All good.',
                    boxType: 'good',
                    options: [
                        { id: 'visual', name: 'Routine visual inspection', desc: 'Standard checks.', cost: 5000, time: 0, dose: 0 },
                        { id: 'thermal', name: 'Add thermal imaging', desc: 'Early leak detection.', cost: 15000, time: 1, dose: 0 }
                    ]
                },
                tunnel: {
                    situation: 'Tunnel access maintained. Contamination levels stable.',
                    quote: 'Tunnel still accessible. Still contaminated.',
                    boxType: 'warning',
                    options: [
                        { id: 'maintain', name: 'Routine monitoring', desc: 'Track contamination levels.', cost: 10000, time: 0, dose: 0.5 },
                        { id: 'decon', name: 'Partial decontamination', desc: 'Reduce hot spots.', cost: 35000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                embedded: {
                    situation: '<strong>Pipes encased in concrete. Contamination has migrated into structure.</strong>',
                    quote: 'Six months extra work. Half a million more. Thanks, 2025.',
                    boxType: 'danger',
                    options: [
                        { id: 'excavate', name: 'Full excavation programme', desc: 'Break out all concrete.', cost: 350000, time: 40, dose: 20 },
                        { id: 'specialist', name: 'Specialist demolition contractor', desc: 'Controlled approach.', cost: 400000, time: 25, dose: 8 }
                    ]
                },
                ducted: {
                    situation: 'Remove covers, lift pipes from ducts. Ducts remain clean.',
                    quote: 'Covers off, pipes out. Ducts can be demolished as clean concrete.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard duct removal', desc: 'Remove pipes, demolish clean ducts.', cost: 50000, time: 8, dose: 2 },
                        { id: 'reuse', name: 'Assess duct reuse', desc: 'Check if ducts can be kept.', cost: 40000, time: 6, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Pipes easy to remove. <strong>Tunnel is contaminated ILW. Large waste volume.</strong>',
                    quote: 'Pipes out quick. Tunnel decon? That\'s the real job.',
                    boxType: 'warning',
                    options: [
                        { id: 'full', name: 'Full tunnel decommissioning', desc: 'Decontaminate and demolish.', cost: 220000, time: 25, dose: 8 },
                        { id: 'fill', name: 'Grout fill and entomb', desc: 'Seal it in place.', cost: 150000, time: 15, dose: 4, healthImpact: -5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 6: MATERIAL SPEC
        // ==========================================
        materialSpec: {
            title: 'Material Specification',
            stage1: {
                description: 'What material for primary circuit pipework?',
                options: [
                    { id: 'standard', name: 'Standard Stainless Steel', desc: '304/316 with ~2,500ppm cobalt. Industry standard.', cost: 110000, quality: 'poor' },
                    { id: 'lowCobalt', name: 'Low-Cobalt Stainless', desc: 'Cobalt <500ppm. Reduced activation.', cost: 170000, quality: 'good' },
                    { id: 'exotic', name: 'Exotic Nickel Alloy', desc: 'Premium aerospace-grade alloy. Top specification.', cost: 250000, quality: 'poor' }
                ]
            },
            stage2: {
                standard: {
                    situation: '<strong>Dose rates higher than predicted.</strong> Maintenance taking longer due to ALARP controls.',
                    quote: 'Standard steel. Running hot. Every job takes longer.',
                    boxType: 'warning',
                    isModifier: true,
                    options: [
                        { id: 'accept', name: 'Accept higher doses', desc: 'Work with what we have.', cost: 0, time: 2, dose: 3 },
                        { id: 'shield', name: 'Install temporary shielding', desc: 'Reduce dose for this outage.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                lowCobalt: {
                    situation: 'Dose rates as predicted. ALARP working well.',
                    quote: 'Low-cobalt steel. Clean to work on. Makes everything easier.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard procedures', desc: 'Normal approach.', cost: 0, time: 0, dose: 0.5 },
                        { id: 'optimise', name: 'Optimise future dose budgets', desc: 'Bank the savings.', cost: 5000, time: 0, dose: 0.5 }
                    ]
                },
                exotic: {
                    situation: '<strong>Dose rates significantly higher than predicted.</strong> Nickel-63 creating problems.',
                    quote: 'Exotic alloy. Exotic dose rates. Should have stuck with normal steel.',
                    boxType: 'danger',
                    isModifier: true,
                    options: [
                        { id: 'accept', name: 'Work with enhanced controls', desc: 'More restrictions, slower work.', cost: 0, time: 4, dose: 5 },
                        { id: 'remote', name: 'Use remote tooling', desc: 'Reduce direct exposure.', cost: 40000, time: 5, dose: 3 }
                    ]
                }
            },
            stage3: {
                standard: {
                    situation: 'Elevated dose rates require stand-off techniques for inspection.',
                    quote: 'Need to keep distance. Limits what we can see.',
                    boxType: 'warning',
                    isModifier: true,
                    options: [
                        { id: 'standoff', name: 'Extended reach inspection', desc: 'Longer probes, less accuracy.', cost: 15000, time: 3, dose: 4 },
                        { id: 'shielded', name: 'Shielded inspection equipment', desc: 'Better but expensive.', cost: 35000, time: 4, dose: 2 }
                    ]
                },
                lowCobalt: {
                    situation: 'Manageable dose rates. Standard inspection techniques apply.',
                    quote: 'Clean material. Normal inspection. No drama.',
                    boxType: 'good',
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Normal techniques.', cost: 10000, time: 2, dose: 1 },
                        { id: 'baseline', name: 'Establish detailed baseline', desc: 'Reference for future.', cost: 18000, time: 3, dose: 1.5 }
                    ]
                },
                exotic: {
                    situation: 'Very high dose rates. <strong>Specialist contractor required.</strong>',
                    quote: 'Too hot for our teams. Need specialists.',
                    boxType: 'danger',
                    isModifier: true,
                    options: [
                        { id: 'specialist', name: 'Specialist inspection contractor', desc: 'Experts with special equipment.', cost: 50000, time: 5, dose: 3 },
                        { id: 'limited', name: 'Accept limited inspection', desc: 'Do what we can safely.', cost: 20000, time: 3, dose: 4, healthImpact: -5 }
                    ]
                }
            },
            stage4: {
                standard: {
                    situation: 'Cumulative workforce dose approaching limits. Scheduling constrained.',
                    quote: 'Running out of dose budget. Need more workers or less work.',
                    boxType: 'warning',
                    options: [
                        { id: 'contractors', name: 'Bring in additional contractors', desc: 'More workers to share dose.', cost: 80000, time: 0, dose: 0 },
                        { id: 'shielding', name: 'Install permanent shielding', desc: 'Long-term improvement.', cost: 50000, time: 5, dose: 0 },
                        { id: 'slow', name: 'Accept schedule extension', desc: 'Work slower, spread dose.', cost: 20000, time: 10, dose: 0 }
                    ]
                },
                lowCobalt: {
                    situation: 'Dose rates remain low. Full operational flexibility.',
                    quote: 'Plenty of dose budget. No constraints.',
                    boxType: 'good',
                    options: [
                        { id: 'maintain', name: 'Standard operations', desc: 'Continue normal approach.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'bank', name: 'Bank dose savings', desc: 'Reserve for contingencies.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                exotic: {
                    situation: '<strong>Severe dose constraints.</strong> Work significantly limited.',
                    quote: 'Can barely get near it. Work windows are minutes, not hours.',
                    boxType: 'danger',
                    options: [
                        { id: 'contractors', name: 'Large contractor team', desc: 'Many workers, short exposures.', cost: 120000, time: 5, dose: 0 },
                        { id: 'remote', name: 'Remote operations only', desc: 'No direct access.', cost: 80000, time: 8, dose: 0 },
                        { id: 'restrict', name: 'Severely restrict operations', desc: 'Accept limitations.', cost: 30000, time: 0, dose: 0, healthImpact: -10 }
                    ]
                }
            },
            stage5: {
                standard: {
                    situation: '<strong>Components still highly active after 5-year decay.</strong> Remote handling required.',
                    quote: '2,500 ppm cobalt. Still hot after 5 years. Decades to cool.',
                    boxType: 'danger',
                    options: [
                        { id: 'remote', name: 'Remote handling operations', desc: 'Difficult but necessary.', cost: 120000, time: 18, dose: 6, risk: 30 },
                        { id: 'specialist', name: 'Specialist remote contractor', desc: 'Expert operators.', cost: 200000, time: 12, dose: 2 }
                    ]
                },
                lowCobalt: {
                    situation: 'After 5-year decay, dose rates allow hands-on work with standard PPE.',
                    quote: 'Low activation. Can handle it now. Some LLW possible.',
                    boxType: 'good',
                    options: [
                        { id: 'handson', name: 'Hands-on removal', desc: 'Direct handling possible.', cost: 60000, time: 8, dose: 2 },
                        { id: 'segregate', name: 'Segregate for recycling', desc: 'Maximise material recovery.', cost: 80000, time: 10, dose: 2.5 }
                    ]
                },
                exotic: {
                    situation: '<strong>Nickel-63 half-life is 100 years.</strong> Components will be active for centuries.',
                    quote: 'Hundred-year half-life. This stuff will outlive everyone here.',
                    boxType: 'danger',
                    options: [
                        { id: 'extended', name: 'Extended remote operations', desc: 'Very difficult work.', cost: 250000, time: 30, dose: 15 },
                        { id: 'storage', name: 'Long-term interim storage', desc: 'Store and wait decades.', cost: 200000, time: 10, dose: 3 },
                        { id: 'specialist', name: 'Specialist handling + storage', desc: 'Experts plus waiting.', cost: 300000, time: 20, dose: 5 }
                    ]
                }
            }
        }
    }
};

// ============================================
// GAME STATE
// ============================================
const STATE = {
    stage: 1,
    designChoices: {},     // Stage 1 choices
    stageChoices: {},      // Choices per stage per element
    completed: {},         // Elements completed per stage
    triggers: {},          // Active triggers
    flags: {},             // Boolean flags
    totals: { cost: 0, dose: 0, time: 0 },
    stageTotals: {},
    plantHealth: 100,
    injuries: 0
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatMoney(n) { return '¬£' + n.toLocaleString(); }

function getCostClass(cost) {
    if (cost <= 20000) return 'cheap';
    if (cost <= 60000) return 'medium';
    return 'expensive';
}

function getRemainingBudget() {
    const stage = GAME_DATA.stages[STATE.stage];
    const stageBudget = stage.budget;
    
    if (STATE.stage === 1) {
        // Stage 1 uses totals.cost directly
        return stageBudget - STATE.totals.cost;
    } else {
        // Stages 2-5 use stageTotals
        const stageSpent = STATE.stageTotals[STATE.stage]?.cost || 0;
        return stageBudget - stageSpent;
    }
}

function canAfford(cost) {
    return cost <= getRemainingBudget();
}

// ============================================
// INTRO
// ============================================
let currentSlide = 1;
const totalSlides = 4;

function updateIntroSlide() {
    document.querySelectorAll('.intro-slide').forEach(s => s.classList.remove('active'));
    document.querySelector(`.intro-slide[data-slide="${currentSlide}"]`).classList.add('active');
    document.querySelectorAll('.intro-dot').forEach((d, i) => {
        d.classList.remove('active', 'done');
        if (i + 1 === currentSlide) d.classList.add('active');
        else if (i + 1 < currentSlide) d.classList.add('done');
    });
    document.getElementById('btnIntroNext').textContent = currentSlide === totalSlides ? 'Begin ‚Üí' : 'Continue ‚Üí';
}

document.getElementById('btnIntroNext').onclick = () => {
    if (currentSlide < totalSlides) { currentSlide++; updateIntroSlide(); }
    else endIntro();
};
document.getElementById('btnSkip').onclick = endIntro;
document.querySelectorAll('.intro-dot').forEach(d => {
    d.onclick = () => { currentSlide = parseInt(d.dataset.dot); updateIntroSlide(); };
});

function endIntro() {
    document.getElementById('cinematicIntro').classList.add('hidden');
    document.getElementById('gameScreen').classList.add('active');
    startStage(1);
}

// ============================================
// STAGE MANAGEMENT
// ============================================
function startStage(stageNum) {
    STATE.stage = stageNum;
    STATE.completed[stageNum] = {};
    STATE.stageTotals[stageNum] = { cost: 0, dose: 0, time: 0 };
    
    const stage = GAME_DATA.stages[stageNum];
    
    // Update timeline
    updateTimeline(stageNum);
    
    updateStatsDisplay();
    
    // Character banner
    const banner = document.getElementById('characterBanner');
    if (stageNum > 1 && stage.char) {
        const char = GAME_DATA.characters[stage.char];
        banner.className = `character-banner visible ${stage.char}`;
        document.getElementById('charPortrait').textContent = char.emoji;
        document.getElementById('charName').textContent = char.name;
        document.getElementById('charRole').textContent = char.role;
    } else {
        banner.classList.remove('visible');
    }
    
    // Reset hotspots
    document.querySelectorAll('.hotspot-dot').forEach(d => {
        d.classList.remove('done');
    });
    
    document.getElementById('btnNextStage').classList.remove('visible');
    
    updateProgressLabel();
}

function updateTimeline(currentStage) {
    document.querySelectorAll('.timeline-stage').forEach(stage => {
        const stageNum = parseInt(stage.dataset.stage);
        stage.classList.remove('completed', 'current', 'future');
        
        if (stageNum < currentStage) {
            stage.classList.add('completed');
        } else if (stageNum === currentStage) {
            stage.classList.add('current');
        } else {
            stage.classList.add('future');
        }
    });
    
    // Update progress bar (0% at stage 1, 100% at stage 5)
    const progressPercent = ((currentStage - 1) / 4) * 100;
    document.getElementById('timelineProgress').style.width = `${progressPercent}%`;
}

function updateStatsDisplay() {
    const stage = GAME_DATA.stages[STATE.stage];
    const remaining = getRemainingBudget();
    let html = '';
    
    if (STATE.stage === 1) {
        const cls = remaining < 100000 ? (remaining < 0 ? 'danger' : 'warning') : '';
        html = `<div class="stat">üí∞ Remaining: <span class="stat-value ${cls}">${formatMoney(remaining)}</span></div>`;
    } else {
        const st = STATE.stageTotals[STATE.stage] || { cost: 0, dose: 0, time: 0 };
        const budgetCls = remaining < 50000 ? (remaining < 0 ? 'danger' : 'warning') : '';
        html = `
            <div class="stat">üí∞ Left: <span class="stat-value ${budgetCls}">${formatMoney(remaining)}</span></div>
            <div class="stat">‚ò¢Ô∏è <span class="stat-value">${st.dose.toFixed(1)} mSv</span></div>
            <div class="stat">‚è±Ô∏è <span class="stat-value">${st.time} days</span></div>
            <div class="stat">‚ù§Ô∏è <span class="stat-value ${STATE.plantHealth < 60 ? 'danger' : ''}">${STATE.plantHealth}%</span></div>
        `;
    }
    document.getElementById('topStats').innerHTML = html;
}

function updateProgressLabel() {
    const done = Object.keys(STATE.completed[STATE.stage] || {}).length;
    document.getElementById('progressLabel').textContent = `${done} of 6 complete`;
    if (done === 6) {
        document.getElementById('btnNextStage').classList.add('visible');
    }
}

// ============================================
// HOTSPOT CLICKS
// ============================================
document.querySelectorAll('.hotspot').forEach(h => {
    h.onclick = () => {
        const elId = h.dataset.element;
        // Always allow opening - player can change their decision
        openElementModal(elId);
    };
});

// ============================================
// MODAL SYSTEM
// ============================================
function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

document.getElementById('modalClose').onclick = closeModal;
document.getElementById('modalOverlay').onclick = (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
};

function openElementModal(elId) {
    const element = GAME_DATA.elements[elId];
    document.getElementById('modalTitle').textContent = element.title;
    
    if (STATE.stage === 1) {
        renderDesignModal(elId, element);
    } else {
        renderDecisionModal(elId, element);
    }
    
    openModal();
}

// ============================================
// STAGE 1: DESIGN
// ============================================
function renderDesignModal(elId, element) {
    const data = element.stage1;
    const remaining = getRemainingBudget();
    
    // Calculate what we'd have if we refund current choice
    let availableBudget = remaining;
    if (STATE.designChoices[elId]) {
        const currentChoice = data.options.find(o => o.id === STATE.designChoices[elId]);
        availableBudget += currentChoice.cost;
    }
    
    let html = `<div class="situation-box"><p>${data.description}</p></div>`;
    html += `<div style="margin-bottom: 15px; padding: 10px; background: var(--deep-navy); border-radius: 6px; display: flex; justify-content: space-between;">
        <span>Remaining Budget:</span>
        <span class="stat-value ${availableBudget < 150000 ? 'warning' : ''}">${formatMoney(availableBudget)}</span>
    </div>`;
    html += '<div class="options-list">';
    
    data.options.forEach(opt => {
        const sel = STATE.designChoices[elId] === opt.id ? 'selected' : '';
        const affordable = opt.cost <= availableBudget;
        const disabledClass = affordable ? '' : 'disabled';
        
        html += `
            <div class="option-card ${sel} ${disabledClass}" data-id="${opt.id}" data-cost="${opt.cost}">
                <div class="choice-image">[Image: ${opt.name}]</div>
                <div class="option-header">
                    <span class="option-name">${opt.name}</span>
                    <span class="option-cost ${getCostClass(opt.cost)}">${formatMoney(opt.cost)}</span>
                </div>
                <p class="option-desc">${opt.desc}</p>
                ${!affordable ? '<div class="disabled-reason">‚ö†Ô∏è Insufficient budget</div>' : ''}
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = STATE.designChoices[elId] || null;
    document.querySelectorAll('.option-card:not(.disabled)').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    const hasExistingChoice = !!STATE.designChoices[elId];
    document.getElementById('modalFooter').innerHTML = `<button class="btn btn-primary" id="btnConfirm">${hasExistingChoice ? 'Update Selection' : 'Confirm Selection'}</button>`;
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        
        const opt = data.options.find(o => o.id === selected);
        
        // Refund old if changing
        if (STATE.designChoices[elId]) {
            const old = data.options.find(o => o.id === STATE.designChoices[elId]);
            STATE.totals.cost -= old.cost;
        }
        
        STATE.designChoices[elId] = selected;
        STATE.completed[1][elId] = true;
        STATE.totals.cost += opt.cost;
        
        document.querySelector(`[data-element="${elId}"] .hotspot-dot`).classList.add('done');
        
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}

// ============================================
// STAGES 2-5: DECISIONS
// ============================================
function renderDecisionModal(elId, element) {
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    
    let stageData = element[stageKey]?.[designChoice];
    
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    
    // Handle conditional (trigger-based or flag-based)
    if (stageData.checkTrigger) {
        stageData = STATE.triggers[stageData.checkTrigger] ? stageData.triggered : stageData.notTriggered;
    } else if (stageData.checkFlag) {
        stageData = STATE.flags[stageData.checkFlag] ? stageData.hasFlag : stageData.noFlag;
    }
    
    const char = GAME_DATA.characters[GAME_DATA.stages[STATE.stage].char];
    
    // Check if already completed - calculate available budget including potential refund
    const previousChoiceId = STATE.stageChoices[`${STATE.stage}_${elId}`];
    let previousChoice = null;
    let availableBudget = getRemainingBudget();
    
    if (previousChoiceId) {
        previousChoice = stageData.options.find(o => o.id === previousChoiceId);
        if (previousChoice) {
            availableBudget += (previousChoice.cost || 0);
        }
    }
    
    let html = '';
    
    // Design recall - just show what they chose, no judgment
    html += `
        <div class="design-recall">
            <strong>2025 Design:</strong> ${designOpt.name}
        </div>
    `;
    
    // Budget display
    html += `<div style="margin-bottom: 15px; padding: 10px; background: var(--deep-navy); border-radius: 6px; display: flex; justify-content: space-between;">
        <span>Stage Budget Remaining:</span>
        <span class="stat-value ${availableBudget < 50000 ? 'warning' : ''}">${formatMoney(availableBudget)}</span>
    </div>`;
    
    // Situation box - neutral styling, let content speak for itself
    html += `<div class="situation-box"><p>${stageData.situation}</p></div>`;
    
    // Character quote
    html += `
        <div class="char-quote">
            <div class="char-portrait">${char.emoji}</div>
            <div>
                <div class="char-quote-name">${char.name}</div>
                <p class="char-quote-text">"${stageData.quote}"</p>
            </div>
        </div>
    `;
    
    // Check if ANY option is affordable
    const hasAffordableOption = stageData.options.some(opt => (opt.cost || 0) <= availableBudget);
    
    // Options - no hints about which is "better"
    html += '<div class="options-list">';
    stageData.options.forEach(opt => {
        const cost = opt.cost || 0;
        const affordable = cost <= availableBudget;
        const disabledClass = affordable ? '' : 'disabled';
        const selectedClass = previousChoiceId === opt.id ? 'selected' : '';
        
        html += `
            <div class="option-card ${disabledClass} ${selectedClass}" data-id="${opt.id}" data-cost="${cost}">
                <div class="option-header">
                    <span class="option-name">${opt.name}</span>
                    <span class="option-cost ${getCostClass(cost)}">${formatMoney(cost)}</span>
                </div>
                <p class="option-desc">${opt.desc}</p>
                <div class="option-impacts">
                    ${opt.time ? `<span class="impact negative">‚è±Ô∏è +${opt.time} days</span>` : ''}
                    ${opt.dose ? `<span class="impact negative">‚ò¢Ô∏è +${opt.dose} mSv</span>` : ''}
                    ${opt.healthImpact ? `<span class="impact ${opt.healthImpact > 0 ? 'positive' : 'negative'}">‚ù§Ô∏è ${opt.healthImpact > 0 ? '+' : ''}${opt.healthImpact}%</span>` : ''}
                    ${opt.risk ? `<span class="impact neutral">‚ö†Ô∏è ${opt.risk}% failure risk</span>` : ''}
                </div>
                ${!affordable ? '<div class="disabled-reason">‚ö†Ô∏è Insufficient budget</div>' : ''}
            </div>
        `;
    });
    html += '</div>';
    
    // Warning if no affordable options
    if (!hasAffordableOption) {
        html += `<div style="margin-top: 15px; padding: 15px; background: rgba(220, 38, 38, 0.2); border: 1px solid var(--red); border-radius: 8px; text-align: center;">
            <strong style="color: var(--red);">‚ö†Ô∏è Budget Exhausted</strong>
            <p style="margin-top: 8px; color: var(--light-grey);">You cannot afford any option. The cheapest option will be forced.</p>
        </div>`;
    }
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = previousChoiceId || null;
    document.querySelectorAll('.option-card:not(.disabled)').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    // If no affordable options, auto-select the cheapest and show different button
    if (!hasAffordableOption) {
        const cheapest = stageData.options.reduce((min, opt) => (opt.cost || 0) < (min.cost || 0) ? opt : min);
        selected = cheapest.id;
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-danger" id="btnConfirm">Accept Forced Option</button>';
    } else {
        const btnText = previousChoiceId ? 'Update Decision' : 'Confirm Decision';
        document.getElementById('modalFooter').innerHTML = `<button class="btn btn-primary" id="btnConfirm">${btnText}</button>`;
    }
    
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        
        const opt = stageData.options.find(o => o.id === selected);
        
        // Handle risk
        if (opt.risk && Math.random() * 100 < opt.risk) {
            showFailure(elId, opt, stageData);
            return;
        }
        
        applyDecision(elId, opt, stageData, previousChoice);
    };
}

function showFailure(elId, opt, stageData) {
    let html = `
        <div class="situation-box danger">
            <p><strong>Attempt Failed!</strong></p>
            <p>The risky approach didn't work. Consequences apply.</p>
        </div>
    `;
    
    const extraCost = opt.cost || 0;
    const extraDose = (opt.dose || 0) + 2;
    const extraTime = (opt.time || 0) + 5;
    
    html += `
        <div class="option-impacts" style="justify-content: center; padding: 20px;">
            <span class="impact negative">üí∞ ${formatMoney(extraCost + 50000)}</span>
            <span class="impact negative">‚è±Ô∏è +${extraTime} days</span>
            <span class="impact negative">‚ò¢Ô∏è +${extraDose} mSv</span>
            <span class="impact negative">‚ù§Ô∏è -10%</span>
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-danger" id="btnConfirm">Accept Consequences</button>';
    
    document.getElementById('btnConfirm').onclick = () => {
        // Apply failure
        STATE.stageTotals[STATE.stage].cost += extraCost + 50000;
        STATE.stageTotals[STATE.stage].dose += extraDose;
        STATE.stageTotals[STATE.stage].time += extraTime;
        STATE.totals.cost += extraCost + 50000;
        STATE.totals.dose += extraDose;
        STATE.totals.time += extraTime;
        STATE.plantHealth = Math.max(0, STATE.plantHealth - 10);
        
        STATE.completed[STATE.stage][elId] = true;
        document.querySelector(`[data-element="${elId}"] .hotspot-dot`).classList.add('issue');
        
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}

function applyDecision(elId, opt, stageData, previousChoice = null) {
    const cost = opt.cost || 0;
    const dose = opt.dose || 0;
    const time = opt.time || 0;
    const healthImpact = opt.healthImpact || 0;
    
    // Refund previous choice if changing decision
    if (previousChoice) {
        STATE.stageTotals[STATE.stage].cost -= (previousChoice.cost || 0);
        STATE.stageTotals[STATE.stage].dose -= (previousChoice.dose || 0);
        STATE.stageTotals[STATE.stage].time -= (previousChoice.time || 0);
        STATE.totals.cost -= (previousChoice.cost || 0);
        STATE.totals.dose -= (previousChoice.dose || 0);
        STATE.totals.time -= (previousChoice.time || 0);
        
        // Reverse health impact
        if (previousChoice.healthImpact) {
            STATE.plantHealth = Math.max(0, Math.min(100, STATE.plantHealth - previousChoice.healthImpact));
        }
        
        // Remove previous triggers/flags
        if (previousChoice.trigger) delete STATE.triggers[previousChoice.trigger];
        if (previousChoice.setFlag) delete STATE.flags[previousChoice.setFlag];
    }
    
    // Additional costs from triggered scenarios
    if (stageData.additionalCosts && !previousChoice) {
        // Only apply additional costs on first decision, not when changing
        STATE.stageTotals[STATE.stage].cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        STATE.totals.cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        if (stageData.additionalCosts.healthImpact) {
            STATE.plantHealth = Math.max(0, STATE.plantHealth + stageData.additionalCosts.healthImpact);
        }
    }
    
    STATE.stageTotals[STATE.stage].cost += cost;
    STATE.stageTotals[STATE.stage].dose += dose;
    STATE.stageTotals[STATE.stage].time += time;
    STATE.totals.cost += cost;
    STATE.totals.dose += dose;
    STATE.totals.time += time;
    
    if (healthImpact) {
        STATE.plantHealth = Math.max(0, Math.min(100, STATE.plantHealth + healthImpact));
    }
    
    if (opt.trigger) STATE.triggers[opt.trigger] = true;
    if (opt.setFlag) STATE.flags[opt.setFlag] = true;
    
    STATE.completed[STATE.stage][elId] = true;
    STATE.stageChoices[`${STATE.stage}_${elId}`] = opt.id;
    
    // Mark hotspot as done - no judgment, just complete
    const dot = document.querySelector(`[data-element="${elId}"] .hotspot-dot`);
    dot.classList.add('done');
    
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}

// ============================================
// STAGE COMPLETION
// ============================================
document.getElementById('btnNextStage').onclick = showStageSummary;

function showStageSummary() {
    const stage = GAME_DATA.stages[STATE.stage];
    const st = STATE.stageTotals[STATE.stage];
    
    document.getElementById('sumTitle').textContent = `${stage.name} Complete`;
    document.getElementById('sumSubtitle').textContent = `Year ${stage.year}`;
    
    let statsHtml = '';
    if (STATE.stage === 1) {
        const spent = STATE.totals.cost;
        const over = spent > stage.budget;
        const remaining = stage.budget - spent;
        statsHtml = `
            <div class="summary-stat"><div class="summary-stat-icon">üí∞</div><div class="summary-stat-value ${over ? 'over' : ''}">${formatMoney(spent)}</div><div class="summary-stat-label">Spent</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">üìä</div><div class="summary-stat-value">${formatMoney(stage.budget)}</div><div class="summary-stat-label">Budget</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">${over ? '‚ö†Ô∏è' : '‚úì'}</div><div class="summary-stat-value ${over ? 'over' : ''}">${formatMoney(Math.abs(remaining))}</div><div class="summary-stat-label">${over ? 'Over Budget' : 'Remaining'}</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ù§Ô∏è</div><div class="summary-stat-value">${STATE.plantHealth}%</div><div class="summary-stat-label">Health</div></div>
        `;
    } else {
        const over = st.cost > stage.budget;
        statsHtml = `
            <div class="summary-stat"><div class="summary-stat-icon">üí∞</div><div class="summary-stat-value ${over ? 'over' : ''}">${formatMoney(st.cost)}</div><div class="summary-stat-label">Spent (of ${formatMoney(stage.budget)})</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ò¢Ô∏è</div><div class="summary-stat-value">${st.dose.toFixed(1)} mSv</div><div class="summary-stat-label">Dose</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚è±Ô∏è</div><div class="summary-stat-value">${st.time} days</div><div class="summary-stat-label">Time</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ù§Ô∏è</div><div class="summary-stat-value">${STATE.plantHealth}%</div><div class="summary-stat-label">Health</div></div>
        `;
    }
    document.getElementById('sumStats').innerHTML = statsHtml;
    
    // Decisions summary - just list choices, no quality judgment yet
    let decHtml = '<h4>Your 2025 Decisions</h4>';
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const choice = STATE.designChoices[elId];
        const opt = el.stage1.options.find(o => o.id === choice);
        decHtml += `
            <div class="decision-row">
                <span class="decision-element">${el.title}</span>
                <span style="color: var(--white);">${opt.name}</span>
            </div>
        `;
    });
    document.getElementById('sumDecisions').innerHTML = decHtml;
    
    document.getElementById('btnNextPhase').textContent = STATE.stage === 5 ? 'View Final Results ‚Üí' : 'Next Stage ‚Üí';
    document.getElementById('summaryScreen').classList.add('active');
}

document.getElementById('btnNextPhase').onclick = () => {
    document.getElementById('summaryScreen').classList.remove('active');
    if (STATE.stage >= 5) showFinalResults();
    else showTransition();
};

function showTransition() {
    const nextStage = STATE.stage + 1;
    const trans = GAME_DATA.transitions[nextStage];
    
    document.getElementById('transYears').textContent = trans.years;
    document.getElementById('transYear').textContent = trans.year;
    document.getElementById('transText').innerHTML = trans.text.map(t => `<p>${t}</p>`).join('');
    
    document.getElementById('transitionScreen').classList.add('active');
}

document.getElementById('btnTransContinue').onclick = () => {
    document.getElementById('transitionScreen').classList.remove('active');
    startStage(STATE.stage + 1);
};

function showFinalResults() {
    let good = 0;
    let lessonsHtml = '';
    
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const opt = el.stage1.options.find(o => o.id === STATE.designChoices[elId]);
        if (opt.quality === 'good') good++;
        
        // Build lessons learned
        let lessonClass = opt.quality === 'good' ? 'good' : (opt.quality === 'wasteful' ? 'ok' : 'poor');
        let lessonText = '';
        if (opt.quality === 'good') lessonText = 'Good choice - minimised lifecycle costs';
        else if (opt.quality === 'wasteful') lessonText = 'Over-specified - unnecessary expense';
        else lessonText = 'Poor choice - caused problems throughout';
        
        lessonsHtml += `
            <div class="decision-row">
                <span class="decision-element">${el.title}: ${opt.name}</span>
                <span class="decision-tag ${lessonClass}">${lessonText}</span>
            </div>
        `;
    });
    
    let grade, verdict;
    if (good >= 5 && STATE.plantHealth >= 80 && STATE.totals.dose < 30) {
        grade = 'A'; verdict = 'Master Designer - Your choices made life easier for everyone';
    } else if (good >= 4 && STATE.plantHealth >= 60) {
        grade = 'B'; verdict = 'Competent Engineer - Mostly good decisions';
    } else if (good >= 2 && STATE.plantHealth >= 40) {
        grade = 'C'; verdict = 'Needs Improvement - Several choices caused problems';
    } else {
        grade = 'D'; verdict = 'Lessons Learned - Your design created decades of difficulties';
    }
    
    document.getElementById('resGrade').textContent = grade;
    document.getElementById('resGrade').className = `results-grade ${grade}`;
    document.getElementById('resVerdict').textContent = verdict;
    
    document.getElementById('resTotals').innerHTML = `
        <div class="results-total"><div class="results-total-value">${formatMoney(STATE.totals.cost)}</div><div class="results-total-label">Total Cost</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.totals.dose.toFixed(1)} mSv</div><div class="results-total-label">Total Dose</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.totals.time} days</div><div class="results-total-label">Total Time</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.plantHealth}%</div><div class="results-total-label">Plant Health</div></div>
    `;
    
    // Add lessons learned section
    const lessonsSection = document.createElement('div');
    lessonsSection.className = 'summary-decisions';
    lessonsSection.innerHTML = '<h4>Lessons Learned</h4>' + lessonsHtml;
    document.getElementById('resTotals').after(lessonsSection);
    
    document.getElementById('resultsScreen').classList.add('active');
}
</script>
</body>
</html>
