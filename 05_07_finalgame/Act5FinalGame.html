<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 60-Year Journey</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --white: #f7f8fa;
            --light-grey: #d0d9e0;
            --mid-grey: #9babc2;
            --slate: #4a5d6b;
            --dark-slate: #364451;
            --deep-navy: #1f2937;
            --green: #92d050;
            --blue: #00b0f0;
            --orange: #cc5500;
            --red: #dc2626;
            --amber: #f59e0b;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--deep-navy);
            color: var(--light-grey);
        }
        
        /* Version tag */
        .version-tag {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: var(--mid-grey);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 9999;
        }
        
        /* ============================================
           CINEMATIC INTRO
           ============================================ */
        #cinematicIntro {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #000;
        }
        
        #cinematicIntro.hidden { display: none; }
        
        .intro-slide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        
        .intro-slide.active { opacity: 1; }
        
        .intro-slide .bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: brightness(0.35);
        }
        
        .intro-slide .bg.dark {
            background: linear-gradient(135deg, #0a1628, #1a2a3a, #0d1a2d);
            filter: none;
        }
        
        .intro-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 700px;
            padding: 40px;
        }
        
        .intro-logo img { max-width: 250px; margin-bottom: 30px; }
        .intro-company { color: var(--blue); text-transform: uppercase; letter-spacing: 4px; margin-bottom: 20px; }
        .intro-title { font-size: 3rem; color: var(--white); margin-bottom: 20px; }
        .intro-subtitle { font-size: 1.2rem; color: var(--light-grey); }
        
        .intro-text-box {
            background: rgba(31, 41, 55, 0.9);
            border-left: 4px solid var(--blue);
            padding: 30px;
            text-align: left;
            border-radius: 8px;
        }
        
        .intro-text-box p { margin-bottom: 15px; font-size: 1.1rem; line-height: 1.7; }
        .intro-text-box p:last-child { margin-bottom: 0; }
        .intro-text-box strong { color: var(--white); }
        .intro-text-box .highlight { color: var(--green); }
        
        .intro-year { font-size: 4rem; color: var(--blue); margin-bottom: 20px; }
        .intro-location { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        
        .intro-budget {
            display: inline-block;
            background: var(--green);
            color: var(--deep-navy);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 20px;
        }
        
        .intro-nav {
            position: absolute;
            bottom: 40px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }
        
        .intro-nav button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .intro-nav .btn-skip { background: transparent; color: var(--mid-grey); border: 1px solid var(--slate); }
        .intro-nav .btn-next { background: var(--blue); color: var(--deep-navy); }
        
        .intro-dots {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .intro-dot {
            width: 40px;
            height: 4px;
            background: var(--slate);
            border-radius: 2px;
            cursor: pointer;
        }
        
        .intro-dot.active { background: var(--blue); }
        .intro-dot.done { background: var(--green); }
        
        /* ============================================
           GAME LAYOUT
           ============================================ */
        #gameScreen {
            display: none;
            position: fixed;
            inset: 0;
            flex-direction: column;
        }
        
        #gameScreen.active { display: flex; }
        
        .top-bar {
            height: auto;
            background: var(--deep-navy);
            border-bottom: 1px solid var(--dark-slate);
            display: flex;
            flex-direction: column;
            padding: 10px 20px 0 20px;
            flex-shrink: 0;
        }
        
        .top-bar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .top-bar-logo img { height: 32px; }
        
        .top-bar-stats { display: flex; gap: 20px; font-size: 0.85rem; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .stat-value { color: var(--white); font-weight: 600; }
        .stat-value.warning { color: var(--amber); }
        .stat-value.danger { color: var(--red); }
        
        /* Timeline */
        .timeline-container {
            position: relative;
            padding: 0 40px 20px 40px;
        }
        
        .timeline-track {
            position: absolute;
            top: 24px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--slate);
            border-radius: 2px;
        }
        
        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--blue));
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .timeline-stages {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }
        
        .timeline-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .timeline-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--dark-slate);
            border: 3px solid var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .timeline-stage.completed .timeline-node {
            background: var(--green);
            border-color: var(--green);
            color: var(--deep-navy);
        }
        
        .timeline-stage.completed .timeline-node::after {
            content: '✓';
            position: absolute;
            font-size: 1.2rem;
        }
        
        .timeline-stage.current .timeline-node {
            background: var(--blue);
            border-color: var(--blue);
            color: var(--deep-navy);
            box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3);
            animation: currentPulse 2s infinite;
        }
        
        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0.1); }
        }
        
        .timeline-stage.future .timeline-node {
            background: var(--dark-slate);
            border-color: var(--slate);
            color: var(--slate);
        }
        
        .timeline-label {
            margin-top: 8px;
            text-align: center;
        }
        
        .timeline-year {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: color 0.3s;
        }
        
        .timeline-stage.completed .timeline-year,
        .timeline-stage.current .timeline-year {
            color: var(--white);
        }
        
        .timeline-name {
            font-size: 0.7rem;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            transition: color 0.3s;
        }
        
        .timeline-stage.current .timeline-name {
            color: var(--blue);
        }
        
        .timeline-stage.completed .timeline-name {
            color: var(--green);
        }
        
        .btn-next-stage {
            display: none;
            padding: 8px 16px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        .btn-next-stage.visible { display: block; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(146, 208, 80, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(146, 208, 80, 0); }
        }
        
        .character-banner {
            display: none;
            align-items: center;
            gap: 15px;
            background: var(--dark-slate);
            padding: 12px 20px;
            border-left: 4px solid var(--orange);
            flex-shrink: 0;
        }
        
        .character-banner.visible { display: flex; }
        .character-banner.dave { border-color: var(--orange); }
        .character-banner.sarah { border-color: var(--blue); }
        .character-banner.mike { border-color: var(--green); }
        .character-banner.janet { border-color: var(--mid-grey); }
        
        .char-portrait {
            width: 50px; height: 50px;
            border-radius: 8px;
            background: var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; }
        .char-info h4 { color: var(--white); margin-bottom: 2px; }
        .char-role { font-size: 0.85rem; color: var(--mid-grey); }
        
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #1a1a2e;
        }
        
        .map-wrapper { position: relative; max-width: 100%; max-height: 100%; }
        
        .map-wrapper img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 250px);
            object-fit: contain;
        }
        
        .hotspot {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        
        .hotspot-dot {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: rgba(0, 176, 240, 0.3);
            border: 3px solid var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            animation: hotspotPulse 2s infinite;
        }
        
        .hotspot:hover .hotspot-dot {
            transform: scale(1.15);
            background: rgba(0, 176, 240, 0.5);
        }
        
        .hotspot-dot.done {
            background: rgba(146, 208, 80, 0.3);
            border-color: var(--green);
            animation: none;
        }
        
        .hotspot-dot.done::after {
            content: '✓';
            color: var(--green);
            font-weight: bold;
        }
        
        .hotspot-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .hotspot:hover .hotspot-label { opacity: 1; }
        
        @keyframes hotspotPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0); }
        }
        
        .bottom-bar {
            height: 40px;
            background: var(--deep-navy);
            border-top: 1px solid var(--dark-slate);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .progress-label { color: var(--mid-grey); font-size: 0.85rem; }
        
        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: linear-gradient(180deg, #1a2634 0%, #0d1b2a 100%);
            border-radius: 16px;
            width: 100%;
            max-width: 750px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        /* Modal Header - Component Name prominent */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 16px 24px;
            border-bottom: none;
        }
        
        .modal-header h3 { 
            color: var(--white); 
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-header h3::before {
            content: '⚙️';
            font-size: 1.3rem;
        }
        
        .modal-close {
            background: var(--slate);
            border: none;
            color: var(--mid-grey);
            font-size: 1.2rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: var(--red);
            color: var(--white);
        }
        
        .modal-body { padding: 0 24px 24px 24px; }
        
        /* Context Bar - Design recall + Stage cost */
        .context-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--deep-navy);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }
        
        .context-design {
            color: var(--mid-grey);
        }
        
        .context-design strong {
            color: var(--amber);
            font-weight: 600;
        }
        
        .context-cost {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--blue);
            font-weight: 600;
        }
        
        /* Situation Panel - The main story */
        .situation-panel {
            background: linear-gradient(135deg, rgba(0, 176, 240, 0.1) 0%, rgba(0, 176, 240, 0.05) 100%);
            border: 1px solid rgba(0, 176, 240, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .situation-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--blue);
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .situation-text {
            color: var(--white);
            font-size: 1.05rem;
            line-height: 1.7;
        }
        
        /* Character Speech Bubble */
        .speech-bubble {
            position: relative;
            background: var(--slate);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            margin-left: 60px;
        }
        
        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 20px;
            border: 10px solid transparent;
            border-right-color: var(--slate);
            border-left: 0;
        }
        
        .speech-portrait {
            position: absolute;
            left: -60px;
            top: 0;
            width: 48px;
            height: 48px;
            background: var(--deep-navy);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--slate);
        }
        
        .speech-name {
            font-weight: 600;
            color: var(--green);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .speech-text {
            color: var(--light-grey);
            font-style: italic;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        /* Decision Section */
        .decision-section {
            margin-top: 24px;
        }
        
        .decision-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .decision-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--amber);
            font-weight: 700;
        }
        
        .decision-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--amber), transparent);
        }
        
        /* Option Cards - Grid of squares */
        .options-list { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .options-list.two-options {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .options-list.three-options {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .option-card {
            background: var(--dark-slate);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--slate);
            transition: all 0.25s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .option-card:hover { 
            border-color: var(--blue); 
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 176, 240, 0.25);
        }
        
        .option-card.selected { 
            border-color: var(--green); 
            background: var(--dark-slate);
            box-shadow: 0 0 0 3px rgba(146, 208, 80, 0.3);
            transform: translateY(-4px);
        }
        
        .option-card.selected .option-cost-badge {
            background: var(--green);
        }
        
        .option-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: var(--slate);
        }
        
        .option-card.disabled:hover { 
            border-color: var(--slate); 
            transform: none;
            box-shadow: none;
        }
        
        .option-cost-badge {
            background: var(--blue);
            color: var(--deep-navy);
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
        }
        
        .option-card.disabled .option-cost-badge {
            background: var(--red);
            color: var(--white);
        }
        
        .option-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .option-name { 
            color: var(--white); 
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .option-desc { 
            color: var(--mid-grey); 
            font-size: 0.85rem; 
            line-height: 1.5;
            flex: 1;
        }
        
        .option-impacts {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px 16px;
            background: var(--deep-navy);
            border-top: 1px solid var(--slate);
        }
        
        .impact { 
            display: flex; 
            align-items: center; 
            gap: 4px;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
        }
        
        .impact.negative { color: var(--red); }
        .impact.positive { color: var(--green); }
        .impact.neutral { color: var(--amber); }
        
        .disabled-reason {
            color: var(--red);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 8px 16px;
            background: rgba(220, 53, 69, 0.1);
            text-align: center;
        }
        
        @media (max-width: 600px) {
            .options-list, .options-list.two-options, .options-list.three-options {
                grid-template-columns: 1fr;
            }
        }
        
        /* Stage 1 Design Choice cards - Grid */
        .design-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        .design-card {
            background: var(--dark-slate);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--slate);
            transition: all 0.25s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .design-card:hover { 
            border-color: var(--blue); 
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 176, 240, 0.25);
        }
        
        .design-card.selected { 
            border-color: var(--green);
            box-shadow: 0 0 0 3px rgba(146, 208, 80, 0.3);
            transform: translateY(-4px);
        }
        
        .design-card.selected .design-card-cost {
            background: var(--green);
        }
        
        .design-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .design-card.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--slate);
        }
        
        .design-card-image {
            width: 100%;
            height: 70px;
            background: linear-gradient(135deg, var(--slate) 0%, var(--deep-navy) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid-grey);
            font-size: 0.65rem;
        }
        
        .design-card-cost {
            background: var(--blue);
            color: var(--deep-navy);
            padding: 10px;
            font-weight: 700;
            font-size: 1rem;
            text-align: center;
        }
        
        .design-card.disabled .design-card-cost {
            background: var(--red);
            color: var(--white);
        }
        
        .design-card-body {
            padding: 14px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .design-card-name {
            color: var(--white);
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .design-card-desc {
            color: var(--mid-grey);
            font-size: 0.8rem;
            line-height: 1.4;
            flex: 1;
        }
        
        @media (max-width: 600px) {
            .design-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Modal Footer */
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--slate);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--deep-navy);
        }
        
        .modal-footer .btn {
            padding: 12px 28px;
            font-size: 0.95rem;
        }
        
        /* Failure Panel */
        .failure-panel {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(220, 53, 69, 0.1) 100%);
            border: 2px solid var(--red);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 24px;
        }
        
        .failure-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .failure-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--red);
            margin-bottom: 10px;
        }
        
        .failure-text {
            color: var(--light-grey);
            line-height: 1.6;
        }
        
        .failure-impacts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .failure-impact {
            background: var(--dark-slate);
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
        }
        
        .failure-impact-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 8px;
        }
        
        .failure-impact-value {
            display: block;
            color: var(--red);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .failure-impact-label {
            font-size: 0.7rem;
            color: var(--mid-grey);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 500px) {
            .failure-impacts {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        }
        
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary { background: var(--blue); color: var(--deep-navy); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn-secondary { background: var(--slate); color: var(--white); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* ============================================
           SCREENS (Transition, Summary, Results)
           ============================================ */
        .overlay-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 600;
            align-items: center;
            justify-content: center;
        }
        
        .overlay-screen.active { display: flex; }
        
        .overlay-content {
            text-align: center;
            max-width: 650px;
            padding: 40px;
        }
        
        /* ========================================
           PHASE TRANSITION SCREEN (Time Skip)
           ======================================== */
        #transitionScreen .overlay-content {
            max-width: 100%;
            width: 100%;
            height: 100%;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: transparent;
        }
        
        .phase-intro {
            position: relative;
            width: 100%;
            max-width: 800px;
            padding: 40px;
        }
        
        .phase-years-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--mid-grey);
            margin-bottom: 16px;
        }
        
        .phase-year-big {
            font-size: 8rem;
            font-weight: 800;
            color: var(--white);
            line-height: 1;
            margin-bottom: 40px;
            text-shadow: 0 4px 30px rgba(0, 176, 240, 0.3);
        }
        
        .phase-visual {
            width: 100%;
            height: 200px;
            background: var(--dark-slate);
            border-radius: 16px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }
        
        .phase-visual::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,176,240,0.1) 0%, transparent 50%, rgba(146,208,80,0.1) 100%);
        }
        
        .phase-visual-icon {
            position: relative;
            z-index: 1;
        }
        
        .phase-context {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 40px;
        }
        
        .phase-context-line {
            font-size: 1.25rem;
            color: var(--light-grey);
            line-height: 1.6;
        }
        
        .phase-context-line:first-child {
            color: var(--white);
            font-weight: 600;
            font-size: 1.4rem;
        }
        
        .phase-name-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--blue) 0%, #0088cc 100%);
            color: var(--white);
            padding: 12px 32px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }
        
        /* ========================================
           STAGE SUMMARY SCREEN (End of Phase)
           ======================================== */
        #summaryScreen .overlay-content {
            max-width: 900px;
            width: 100%;
            text-align: left;
        }
        
        .summary-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .summary-phase-complete {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--green);
            margin-bottom: 12px;
        }
        
        .summary-title { 
            font-size: 2.5rem; 
            color: var(--white); 
            margin-bottom: 8px; 
        }
        
        .summary-subtitle { 
            color: var(--mid-grey); 
            margin-bottom: 0;
            font-size: 1.1rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }
        
        .summary-stat {
            background: var(--dark-slate);
            padding: 24px 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--slate);
            transition: transform 0.2s;
        }
        
        .summary-stat:hover {
            transform: translateY(-2px);
        }
        
        .summary-stat-icon { 
            font-size: 1.8rem; 
            margin-bottom: 10px; 
        }
        
        .summary-stat-value { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--white); 
        }
        
        .summary-stat-value.over { color: var(--red); }
        .summary-stat-value.good { color: var(--green); }
        
        .summary-stat-label { 
            font-size: 0.75rem; 
            color: var(--mid-grey); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-top: 6px; 
        }
        
        .summary-section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--amber);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .summary-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--amber), transparent);
        }
        
        .summary-decisions {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 30px;
            text-align: left;
            max-height: none;
            overflow: visible;
        }
        
        .summary-decisions h4 { 
            display: none; /* Using section title instead */
        }
        
        .decisions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .decision-card {
            background: var(--dark-slate);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--slate);
        }
        
        .decision-card.this-stage {
            border-left-color: var(--blue);
            background: linear-gradient(90deg, rgba(0,176,240,0.1) 0%, var(--dark-slate) 30%);
        }
        
        .decision-element { 
            color: var(--mid-grey);
            font-size: 0.85rem;
        }
        
        .decision-choice {
            color: var(--white);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .decision-cost {
            color: var(--amber);
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .summary-insight {
            background: linear-gradient(135deg, var(--dark-slate) 0%, rgba(0,176,240,0.1) 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--slate);
        }
        
        .insight-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }
        
        .insight-text {
            color: var(--light-grey);
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .insight-text strong {
            color: var(--white);
        }
        
        .summary-actions {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn-next-phase {
            padding: 16px 40px;
            background: linear-gradient(135deg, var(--green) 0%, #7bc050 100%);
            color: var(--deep-navy);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-next-phase:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(146, 208, 80, 0.3);
        }
        
        /* Legacy transition styles - keeping for compatibility */
        .trans-years { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        .trans-year { font-size: 5rem; color: var(--white); margin-bottom: 30px; }
        
        .trans-text {
            background: var(--dark-slate);
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            margin-bottom: 30px;
        }
        
        .trans-text p { margin-bottom: 12px; line-height: 1.6; }
        .trans-text p:last-child { margin-bottom: 0; }
        
        .btn-continue {
            padding: 14px 36px;
            background: var(--blue);
            color: var(--deep-navy);
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-continue:hover {
            transform: translateY(-2px);
        }
        
        @media (max-width: 600px) {
            .phase-year-big { font-size: 5rem; }
            .phase-visual { height: 150px; }
            .summary-stats { grid-template-columns: repeat(2, 1fr); }
            .decisions-grid { grid-template-columns: 1fr; }
        }
        
        /* Summary
        
        .btn-next-phase {
            padding: 12px 30px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Story Transition Screen */
        .story-transition {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--deep-navy) 0%, #0a1628 100%);
            z-index: 200;
            overflow-y: auto;
        }
        
        .story-transition.visible { display: block; }
        
        .story-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 30px;
        }
        
        .story-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .story-years {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--blue), var(--green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .story-title {
            font-size: 1.5rem;
            color: var(--white);
            font-weight: 600;
        }
        
        .story-narrative {
            background: var(--dark-slate);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            line-height: 1.7;
            color: var(--light-grey);
        }
        
        .story-narrative p { margin-bottom: 15px; }
        .story-narrative p:last-child { margin-bottom: 0; }
        
        .story-section { margin-bottom: 25px; }
        
        .story-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--blue);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .story-lessons {
            background: rgba(146, 208, 80, 0.1);
            border: 1px solid var(--green);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .story-lessons ul {
            margin: 0;
            padding-left: 20px;
            color: var(--light-grey);
        }
        
        .story-lessons li { margin-bottom: 8px; }
        .story-lessons li:last-child { margin-bottom: 0; }
        
        .story-regulatory {
            background: rgba(0, 176, 240, 0.1);
            border: 1px solid var(--blue);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .reg-reference {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--slate);
        }
        
        .reg-reference:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .reg-code {
            background: var(--blue);
            color: var(--deep-navy);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            height: fit-content;
        }
        
        .reg-text {
            color: var(--light-grey);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .story-foreshadow {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid var(--amber);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            color: var(--light-grey);
            font-style: italic;
        }
        
        .story-continue { text-align: center; }
        .story-continue .btn { padding: 15px 40px; font-size: 1.1rem; }
        
        /* Final Report Styles */
        #resultsScreen .overlay-content {
            max-width: 900px;
            text-align: left;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .results-grade {
            font-size: 6rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .results-grade.A { color: var(--green); }
        .results-grade.B { color: var(--blue); }
        .results-grade.C { color: var(--amber); }
        .results-grade.D { color: var(--red); }
        
        .results-title { color: var(--white); margin-bottom: 12px; }
        .results-verdict { color: var(--light-grey); margin-bottom: 0; font-size: 1.1rem; }
        
        .report-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            background: var(--dark-slate);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .comparison-box {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
        }
        
        .comparison-box.yours {
            background: rgba(255,255,255,0.05);
        }
        
        .comparison-box.optimal {
            background: rgba(146, 208, 80, 0.1);
            border: 1px solid var(--green);
        }
        
        .comparison-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mid-grey);
            margin-bottom: 8px;
        }
        
        .comparison-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--white);
        }
        
        .comparison-box.optimal .comparison-value {
            color: var(--green);
        }
        
        .comparison-vs {
            font-size: 1.2rem;
            color: var(--mid-grey);
            font-weight: 600;
        }
        
        .comparison-diff {
            font-size: 0.85rem;
            margin-top: 6px;
        }
        
        .comparison-diff.over { color: var(--red); }
        .comparison-diff.under { color: var(--green); }
        
        .report-section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--amber);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .report-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--amber), transparent);
        }
        
        /* Element Journey Cards */
        .element-journeys {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }
        
        .journey-card {
            background: var(--dark-slate);
            border-radius: 12px;
            overflow: hidden;
            border-left: 4px solid var(--slate);
        }
        
        .journey-card.good { border-left-color: var(--green); }
        .journey-card.wasteful { border-left-color: var(--amber); }
        .journey-card.poor { border-left-color: var(--red); }
        
        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .journey-header:hover {
            background: rgba(255,255,255,0.03);
        }
        
        .journey-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .journey-icon {
            font-size: 1.3rem;
        }
        
        .journey-name {
            font-weight: 600;
            color: var(--white);
            font-size: 0.95rem;
        }
        
        .journey-design {
            font-size: 0.8rem;
            color: var(--mid-grey);
        }
        
        .journey-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .journey-cost {
            text-align: right;
        }
        
        .journey-cost-value {
            font-weight: 600;
            color: var(--white);
        }
        
        .journey-cost-label {
            font-size: 0.7rem;
            color: var(--mid-grey);
        }
        
        .journey-verdict {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .journey-verdict.good { background: rgba(146,208,80,0.2); color: var(--green); }
        .journey-verdict.wasteful { background: rgba(255,193,7,0.2); color: var(--amber); }
        .journey-verdict.poor { background: rgba(220,53,69,0.2); color: var(--red); }
        
        .journey-expand {
            color: var(--mid-grey);
            font-size: 1rem;
            transition: transform 0.3s;
            margin-left: 8px;
        }
        
        .journey-card.expanded .journey-expand {
            transform: rotate(180deg);
        }
        
        .journey-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        
        .journey-card.expanded .journey-content {
            max-height: 800px;
        }
        
        .journey-timeline {
            padding: 16px 18px;
            background: var(--deep-navy);
        }
        
        .timeline-stage {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .timeline-stage:last-child {
            border-bottom: none;
        }
        
        .timeline-year {
            width: 70px;
            flex-shrink: 0;
        }
        
        .timeline-year-num {
            font-weight: 700;
            color: var(--blue);
            font-size: 1rem;
        }
        
        .timeline-year-phase {
            font-size: 0.65rem;
            color: var(--mid-grey);
            text-transform: uppercase;
        }
        
        .timeline-event {
            flex: 1;
            padding-right: 12px;
        }
        
        .timeline-decision {
            color: var(--white);
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .timeline-consequence {
            font-size: 0.8rem;
            color: var(--mid-grey);
            line-height: 1.4;
        }
        
        .timeline-cost {
            width: 80px;
            text-align: right;
            color: var(--amber);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .journey-lesson {
            padding: 14px 18px;
            border-top: 1px solid var(--slate);
        }
        
        .lesson-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--amber);
            margin-bottom: 6px;
        }
        
        .lesson-text {
            color: var(--light-grey);
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        /* Key Takeaways */
        .takeaways {
            background: var(--dark-slate);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .takeaway-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .takeaway-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .takeaway-item:first-child {
            padding-top: 0;
        }
        
        .takeaway-icon {
            font-size: 1.1rem;
        }
        
        .takeaway-text {
            color: var(--light-grey);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .takeaway-text strong {
            color: var(--white);
        }
        
        /* Report actions */
        .report-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 30px;
        }
        
        @media (max-width: 700px) {
            .report-comparison {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .comparison-vs { display: none; }
            .journey-right { flex-direction: column; gap: 8px; }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            .top-bar-stats { display: none; }
            .summary-stats, .results-totals { grid-template-columns: repeat(2, 1fr); }
            .intro-title { font-size: 2rem; }
            
            .timeline-container { padding: 0 10px 15px 10px; }
            .timeline-track { left: 30px; right: 30px; }
            .timeline-stage { min-width: 60px; }
            .timeline-node { width: 36px; height: 36px; font-size: 0.65rem; }
            .timeline-year { font-size: 0.8rem; }
            .timeline-name { font-size: 0.55rem; }
        }
        
        @media (max-width: 480px) {
            .timeline-name { display: none; }
            .timeline-node { width: 30px; height: 30px; font-size: 0.6rem; }
        }
    </style>
</head>
<body>

<!-- VERSION TAG -->
<div class="version-tag">v0.15</div>

<!-- CINEMATIC INTRO -->
<div id="cinematicIntro">
    <div class="intro-slide active" data-slide="1">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="The Nuclear House">
            </div>
            <p class="intro-company">Presents</p>
            <h1 class="intro-title">The 60-Year Journey</h1>
            <p class="intro-subtitle">An interactive experience in design for decommissioning</p>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="2">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <p class="intro-location">Somerset Coast, UK</p>
            <h2 class="intro-year">2025</h2>
            <div class="intro-text-box">
                <p><strong>Thornbury Point Nuclear Power Station.</strong></p>
                <p>Sixty years of operation ahead. Someone needs to design it right.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="3">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <div class="intro-text-box">
                <p>You've been assigned <span class="highlight">Section 4B</span>: Primary coolant system auxiliaries.</p>
                <p>Your design will be built, operated, inspected, and decommissioned over <strong>sixty years</strong>.</p>
                <p>Four people will inherit your choices. Their success depends on what you decide.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="4">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-text-box" style="text-align: center; border-left: none; border: 2px solid var(--blue);">
                <p><strong>Six design decisions. Each has consequences.</strong></p>
                <p>Good choices make future decisions easier and cheaper.<br>Poor choices force compromises for decades.</p>
                <div class="intro-budget">Design Budget: £800,000</div>
            </div>
        </div>
    </div>
    
    <div class="intro-dots">
        <div class="intro-dot active" data-dot="1"></div>
        <div class="intro-dot" data-dot="2"></div>
        <div class="intro-dot" data-dot="3"></div>
        <div class="intro-dot" data-dot="4"></div>
    </div>
    
    <div class="intro-nav">
        <button class="btn-skip" id="btnSkip">Skip</button>
        <button class="btn-next" id="btnIntroNext">Continue →</button>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
    <div class="top-bar">
        <div class="top-bar-header">
            <div class="top-bar-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="Logo">
            </div>
            <div class="top-bar-stats" id="topStats"></div>
            <button class="btn-next-stage" id="btnNextStage">Complete Stage →</button>
        </div>
        <div class="timeline-container">
            <div class="timeline-track">
                <div class="timeline-progress" id="timelineProgress"></div>
            </div>
            <div class="timeline-stages" id="timelineStages">
                <div class="timeline-stage current" data-stage="1">
                    <div class="timeline-node">1</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2025</div>
                        <div class="timeline-name">Design</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="2">
                    <div class="timeline-node">2</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2040</div>
                        <div class="timeline-name">Maintenance</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="3">
                    <div class="timeline-node">3</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2055</div>
                        <div class="timeline-name">Inspection</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="4">
                    <div class="timeline-node">4</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2070</div>
                        <div class="timeline-name">Operations</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="5">
                    <div class="timeline-node">5</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2085</div>
                        <div class="timeline-name">Decommission</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="character-banner" id="characterBanner">
        <div class="char-portrait" id="charPortrait">👷</div>
        <div class="char-info">
            <h4 id="charName">Dave Morton</h4>
            <p class="char-role" id="charRole">Maintenance Supervisor</p>
        </div>
    </div>
    
    <div class="map-container">
        <div class="map-wrapper">
            <img src="images/gamebackground.png" alt="Section 4B">
            
            <div class="hotspot" data-element="pumpAccess" style="left: 18%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pump Access</span>
            </div>
            
            <div class="hotspot" data-element="weldClearance" style="left: 42%; top: 46%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Weld Clearance</span>
            </div>
            
            <div class="hotspot" data-element="controlPanel" style="left: 85%; top: 42%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Control Panel</span>
            </div>
            
            <div class="hotspot" data-element="pipeConnections" style="left: 56%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Connections</span>
            </div>
            
            <div class="hotspot" data-element="pipeRouting" style="left: 62%; top: 82%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Routing</span>
            </div>
            
            <div class="hotspot" data-element="materialSpec" style="left: 32%; top: 58%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Material Spec</span>
            </div>
        </div>
    </div>
    
    <div class="bottom-bar">
        <span class="progress-label" id="progressLabel">0 of 6 complete</span>
    </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Element</h3>
            <button class="modal-close" id="modalClose">×</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- TRANSITION SCREEN (Phase Introduction) -->
<div class="overlay-screen" id="transitionScreen">
    <div class="overlay-content">
        <div class="phase-intro">
            <p class="phase-years-label" id="transYears">15 YEARS LATER</p>
            <h2 class="phase-year-big" id="transYear">2040</h2>
            <div class="phase-visual" id="transVisual">
                <span class="phase-visual-icon">🔧</span>
            </div>
            <div class="phase-name-badge" id="transPhaseName">MAINTENANCE</div>
            <div class="phase-context" id="transText"></div>
            <button class="btn-continue" id="btnTransContinue">Begin Phase →</button>
        </div>
    </div>
</div>

<!-- SUMMARY SCREEN (End of Phase) -->
<div class="overlay-screen" id="summaryScreen">
    <div class="overlay-content">
        <div class="summary-header">
            <p class="summary-phase-complete">✓ PHASE COMPLETE</p>
            <h2 class="summary-title" id="sumTitle">Stage Complete</h2>
            <p class="summary-subtitle" id="sumSubtitle"></p>
        </div>
        
        <div class="summary-stats" id="sumStats"></div>
        
        <div class="summary-section-title">Your Decisions This Phase</div>
        <div class="summary-decisions" id="sumDecisions"></div>
        
        <div class="summary-insight" id="sumInsight">
            <div class="insight-icon">💡</div>
            <div class="insight-text" id="insightText"></div>
        </div>
        
        <div class="summary-actions">
            <button class="btn-next-phase" id="btnNextPhase">Continue →</button>
        </div>
    </div>
</div>

<!-- STORY TRANSITION SCREEN -->
<div class="story-transition" id="storyTransition">
    <div class="story-content">
        <div class="story-header">
            <div class="story-years" id="storyYears">2025 → 2040</div>
            <div class="story-title" id="storyTitle">15 Years Pass...</div>
        </div>
        <div class="story-narrative" id="storyNarrative"></div>
        <div class="story-section">
            <div class="story-section-title">📚 Key Lessons</div>
            <div class="story-lessons" id="storyLessons"></div>
        </div>
        <div class="story-section">
            <div class="story-section-title">📋 Regulatory Framework</div>
            <div class="story-regulatory" id="storyRegulatory"></div>
        </div>
        <div class="story-foreshadow" id="storyForeshadow"></div>
        <div class="story-continue">
            <button class="btn btn-primary" id="btnStoryNext">Begin Stage →</button>
        </div>
    </div>
</div>

<!-- RESULTS SCREEN -->
<div class="overlay-screen" id="resultsScreen">
    <div class="overlay-content">
        <div id="finalReportContent"></div>
        <div class="report-actions">
            <button class="btn-continue" onclick="location.reload()">Play Again</button>
        </div>
    </div>
</div>

<script>
// ============================================
// GAME DATA - ALL STAGES HAVE DECISIONS
// Good design = easy/cheap options
// Poor design = hard/expensive options
// ============================================
const GAME_DATA = {
    stages: {
        1: { name: 'DESIGN', year: 2025, budget: 800000 },
        2: { name: 'MAINTENANCE', year: 2040, budget: 400000, time: 30, char: 'dave' },
        3: { name: 'INSPECTION', year: 2055, budget: 250000, time: 21, char: 'sarah' },
        4: { name: 'OPERATIONS', year: 2070, budget: 200000, time: 7, char: 'mike' },
        5: { name: 'DECOMMISSIONING', year: 2085, budget: 1200000, time: 90, char: 'janet' }
    },
    
    characters: {
        dave: { name: 'Dave Morton', role: 'Maintenance Supervisor', emoji: '👷' },
        sarah: { name: 'Sarah Okonkwo', role: 'Principal Inspector', emoji: '🔍' },
        mike: { name: 'Mike Brennan', role: 'Shift Operations Manager', emoji: '👨‍💼' },
        janet: { name: 'Janet Cole', role: 'Decommissioning Lead', emoji: '👩‍🔧' }
    },
    
    transitions: {
        2: { 
            years: '15 YEARS LATER', 
            year: '2040', 
            phaseName: 'MAINTENANCE',
            icon: '🔧',
            text: [
                'Thornbury Point has been generating power for 14 years.',
                'Your design drawings are yellowed paper in a filing cabinet.',
                'It\'s time for the first major maintenance outage.'
            ] 
        },
        3: { 
            years: '15 YEARS LATER', 
            year: '2055',
            phaseName: 'INSPECTION',
            icon: '🔍',
            text: [
                'Thirty years of operation.',
                'Regulators want proof everything is still safe.',
                'Every weld, every component needs inspection.'
            ] 
        },
        4: { 
            years: '15 YEARS LATER', 
            year: '2070',
            phaseName: 'OPERATIONS',
            icon: '⚡',
            text: [
                'Forty-five years. The plant is showing its age.',
                'Tonight, the alarms will test your control room design.',
                'How well did you plan for this moment?'
            ] 
        },
        5: { 
            years: '15 YEARS LATER', 
            year: '2085',
            phaseName: 'DECOMMISSIONING',
            icon: '🏗️',
            text: [
                'Sixty years. The reactor is shut down for good.',
                'Now comes the hard part: taking it all apart safely.',
                'Every design decision will be tested one final time.'
            ] 
        }
    },
    
    storyTransitions: {
        1: {
            yearsLabel: '2025',
            title: 'Design Phase Complete',
            narrative: [
                'Your design specifications have been approved and construction begins. Over the next decade, thousands of workers will transform your drawings into a functioning nuclear power station.',
                'The choices you made about pump positions, weld clearances, control panel layouts, pipe connections, pipe routing, and material specifications are now literally set in concrete.',
                'In 2026, Thornbury Point achieves first criticality. By 2027, it reaches full power operation and begins supplying electricity to millions of homes.',
                'For the next 14 years, the plant runs smoothly. Operators become familiar with the control room layout. Maintenance teams learn the quirks of accessing equipment. Your design decisions fade from memory - but they remain embedded in every wall, every pipe, every component.'
            ],
            lessons: [
                'Design decisions made today will affect workers for 60+ years',
                'Saving money during design often creates larger costs during operation',
                'Access for maintenance and inspection must be considered from day one',
                'Human factors in control room design can mean the difference between safe response and disaster',
                'Material specifications affect dose rates for the entire plant lifetime'
            ],
            regulatory: [
                { code: 'LC 14', text: 'Safety Case - The design must demonstrate that risks are reduced As Low As Reasonably Practicable (ALARP). Your design choices form the basis of the safety case.' },
                { code: 'LC 17', text: 'Quality Assurance - Design decisions must be documented and traceable. Future modifications will reference your original specifications.' },
                { code: 'SAP EKP.2', text: 'Defence in Depth - Multiple barriers and safety systems must be incorporated at the design stage. Retrofit is difficult and expensive.' },
                { code: 'SAP EHF.1', text: 'Human Factors Integration - The design must consider human capabilities and limitations throughout the facility lifecycle.' }
            ],
            foreshadow: 'It is now 2040. Dave Morton, Maintenance Supervisor, is preparing for the first major outage. He\'s about to discover whether your design choices made his job easy... or impossible.'
        },
        2: {
            yearsLabel: '2025 → 2040',
            title: '15 Years of Operation',
            narrative: [
                'The maintenance outage is complete. Dave Morton\'s team has replaced seals, repaired welds, and addressed 15 years of wear and tear.',
                'Some jobs went smoothly - equipment was accessible, clearances were adequate, work could proceed efficiently. Other jobs were nightmares - pumps that didn\'t fit through access routes, welds in positions too tight for proper technique, contaminated scaffolding that should never have been installed.',
                'The costs and doses from this outage are now part of the plant\'s permanent record. They will be reviewed by regulators, analysed by safety committees, and compared against predictions made during design.',
                'As the plant returns to power generation, another 15 years of operation begins. Components continue to age. Corrosion advances. Fatigue cycles accumulate.'
            ],
            lessons: [
                'Licence Condition 28 requires adequate arrangements for examination, inspection, and maintenance',
                'Access constraints identified during design become real obstacles during maintenance',
                'Dose expenditure during maintenance must be justified under ALARP principles',
                'Temporary fixes and deferred work create future technical debt',
                'Good design enables standard procedures; poor design forces expensive workarounds'
            ],
            regulatory: [
                { code: 'LC 28', text: 'Examination, Inspection, Maintenance & Testing - The licensee must make adequate arrangements. Your design choices directly affect what "adequate" means in practice.' },
                { code: 'LC 25', text: 'Operational Records - All maintenance work, dose uptake, and defects discovered must be recorded. These records inform future safety cases.' },
                { code: 'SAP EMT.1', text: 'Maintenance Strategy - Facilities should be designed so that structures, systems and components can be maintained to preserve their safety functions.' },
                { code: 'IRR17 Reg.9', text: 'Restriction of Exposure - Employers must ensure doses are kept As Low As Reasonably Practicable. Poor access = higher doses.' }
            ],
            foreshadow: 'It is now 2055. Sarah Okonkwo, Principal Inspector from ONR, is arriving for the 30-year Periodic Safety Review. She will examine every safety-critical component - if she can access them.'
        },
        3: {
            yearsLabel: '2040 → 2055',
            title: '30-Year Periodic Safety Review',
            narrative: [
                'The inspection programme is complete. Every pipe, weld, and component has been examined - or at least, every one that could be accessed.',
                'Sarah Okonkwo\'s report will determine whether Thornbury Point can continue operating. Where inspections achieved full coverage, there is confidence in continued safe operation. Where access limitations prevented complete examination, there are regulatory findings and operational restrictions.',
                'The inspection results reveal the true quality of your 2025 design. Good clearances enabled complete inspections. Embedded pipes and inadequate access have created zones of uncertainty that will require ongoing monitoring or costly retrofits.',
                'Regulators have noted every inspection gap. Some will require enhanced surveillance. Others may limit future operating parameters. The worst cases could force early shutdown.'
            ],
            lessons: [
                'In-Service Inspection requirements are defined by design codes and regulatory expectations',
                'Inspection gaps create uncertainty in safety cases and regulatory concern',
                'The Periodic Safety Review at 10-year intervals assesses continued safe operation',
                'Materials that cannot be inspected create ongoing liability',
                'Retrofitting access is extremely expensive compared to designing it correctly'
            ],
            regulatory: [
                { code: 'LC 28', text: 'ONR expects in-service inspection programmes to demonstrate continued structural integrity. Gaps in coverage must be justified.' },
                { code: 'SAP EAD.1', text: 'Ageing and Degradation - Structures, systems and components important to safety should be designed to minimise the effects of ageing and to facilitate inspection.' },
                { code: 'SAP EMT.6', text: 'Inspectability - All structures, systems and components important to safety should be designed and located so they can be adequately inspected.' },
                { code: 'NS-TAST-GD-026', text: 'ONR Technical Assessment Guide on In-Service Inspection - The design should ensure that ISI can be performed to relevant codes and standards.' }
            ],
            foreshadow: 'It is now 2070. Mike Brennan is the night Shift Operations Manager. At 3am, the alarms begin. Everything depends on whether operators can find the right controls, fast.'
        },
        4: {
            yearsLabel: '2055 → 2070',
            title: '45 Years: Operations Under Pressure',
            narrative: [
                'The emergency is over. Whether it was handled smoothly or chaotically depended on design decisions made 45 years ago.',
                'A well-designed control panel meant operators found the right controls instantly. A poorly designed panel meant confusion, delay, and near-misses during the most critical moments.',
                'The plant is now entering its final 15 years of operation. Equipment that has run for 45 years is showing its age. Dose rates from activated materials constrain work planning. Systems that were state-of-the-art in 2025 are now obsolete.',
                'Every decision made during design, maintenance, and inspection is now compounded. Good decisions have built a safe, efficient operation. Poor decisions have accumulated into operational constraints, regulatory scrutiny, and additional risk.'
            ],
            lessons: [
                'Human factors engineering in control rooms directly affects emergency response',
                'Operator confusion during emergencies can be fatal - design must support rapid, correct action',
                'Material activation affects operational flexibility for the entire plant life',
                'Deferred maintenance and inspection gaps can culminate in operational emergencies',
                'Long-term operation requires continuous demonstration that ageing is being managed'
            ],
            regulatory: [
                { code: 'LC 23', text: 'Operating Rules - Operations must be conducted within approved limits. Design constraints become operating rule requirements.' },
                { code: 'LC 24', text: 'Operating Instructions - Clear instructions must exist for all operations. Confusing control layouts make instructions harder to follow.' },
                { code: 'SAP EHF.5', text: 'Human Reliability - Design should reduce opportunities for human error, particularly during abnormal conditions and emergencies.' },
                { code: 'SAP SC.5', text: 'Safety Culture - A questioning attitude and conservative decision-making depend on operators having clear, unambiguous information.' }
            ],
            foreshadow: 'It is now 2085. The reactor is shut down for good. Janet Cole leads the decommissioning programme. Sixty years of neutron activation, contamination buildup, and ageing infrastructure await. The design choices of 2025 will determine whether decommissioning takes 10 years or 50.'
        },
        5: {
            yearsLabel: '2085',
            title: 'The 60-Year Journey Complete',
            narrative: [
                'Thornbury Point is being dismantled. The reactor that began as lines on your drawing board in 2025 is returning to the ground from which its materials came.',
                'Every decision you made during design echoed through six decades of operation. Some choices saved millions of pounds and countless worker-hours. Others created problems that compounded across maintenance outages, inspection campaigns, operational emergencies, and now decommissioning.',
                'The workers who lived with your decisions - Dave fixing pumps, Sarah inspecting welds, Mike responding to alarms, Janet cutting contaminated pipes - they all experienced the consequences of choices made before most of them were born.',
                'This is the reality of nuclear engineering. The decisions made today will affect workers, communities, and the environment for generations. There are no shortcuts, no quick fixes, and no second chances once the concrete is poured.'
            ],
            lessons: [
                'Nuclear facilities operate for 60+ years - design must consider the entire lifecycle',
                'Short-term savings often become long-term costs multiplied many times over',
                'Access, materials, and human factors affect every phase from construction to decommissioning',
                'Regulatory requirements exist because lessons were learned from past failures',
                'The true cost of design is not the construction budget - it is the total lifecycle cost'
            ],
            regulatory: [
                { code: 'ONR Purpose', text: 'The Office for Nuclear Regulation exists to protect society by securing safe nuclear operations. Your design choices directly affect their ability to do this.' },
                { code: 'ALARP', text: 'Risks must be reduced As Low As Reasonably Practicable. Good design makes ALARP achievable; poor design makes it expensive or impossible.' },
                { code: 'Lifecycle', text: 'Modern regulatory frameworks require consideration of the full facility lifecycle at the design stage - construction, operation, and decommissioning.' },
                { code: 'Future', text: 'Every new nuclear facility will face the same 60-year journey. The lessons from Thornbury Point should inform the designs of tomorrow.' }
            ],
            foreshadow: 'Your journey through 60 years of nuclear operations is complete. Let\'s see how your choices measured up across the full lifecycle of Thornbury Point.'
        }
    },
    
    elements: {
        // ==========================================
        // ELEMENT 1: PUMP ACCESS
        // ==========================================
        pumpAccess: {
            title: 'Pump Location/Access',
            stage1: {
                description: 'How should the primary coolant pump be positioned?',
                options: [
                    { id: 'corner', name: 'Corner Position', desc: 'Tucked in corner to maximise floor space. 1.8m clearance.', cost: 80000, quality: 'poor' },
                    { id: 'openBay', name: 'Open Bay', desc: '2m clearance all sides, under crane rails.', cost: 120000, quality: 'good' },
                    { id: 'dedicated', name: 'Dedicated Shielded Room', desc: 'Separate room with airlock. Maximum protection.', cost: 200000, quality: 'wasteful' }
                ]
            },
            // =====================================
            // STAGE 2: MAINTENANCE
            // =====================================
            stage2: {
                corner: {
                    situation: 'RCP seal replacement required. The pump is 2.1m wide but the corner position only provides 1.8m clearance. It physically cannot be removed through the access route.',
                    quote: "Boss, we've got a problem. That corner position from the 2025 design - the pump doesn't fit through the gap. Whoever signed off on 1.8m clearance for a 2.1m pump... anyway, what do you want us to do?",
                    options: [
                        { 
                            id: 'modify', 
                            name: 'Cut a larger access opening', 
                            desc: 'Permanently modify the wall structure to create adequate access. Fixes the problem for good.', 
                            cost: 120000, time: 14, dose: 4,
                            setState: { accessFixed: true }
                        },
                        { 
                            id: 'subcontract', 
                            name: 'Hire specialist rigging team', 
                            desc: 'Bring in experts with hydraulic jacks and custom rigging to work around the constraint. Problem remains for next time.', 
                            cost: 180000, time: 18, dose: 3,
                            setState: { workaroundUsed: true }
                        },
                        { 
                            id: 'force', 
                            name: 'Attempt to tilt and manoeuvre through', 
                            desc: 'Try to angle the pump through the gap. Risky - may damage pump casing.', 
                            cost: 40000, time: 5, dose: 6, risk: 70,
                            setState: { deteriorating: true },
                            failState: { deteriorating: true, damageCaused: true }
                        }
                    ]
                },
                openBay: {
                    situation: 'RCP seal replacement required. The pump is positioned in the open bay with 2m clearance and full crane coverage.',
                    quote: "Good news - that open bay layout from 2025 is paying off. We've got full crane access, plenty of clearance. Standard lift operation. Just need your sign-off on the approach.",
                    options: [
                        { id: 'standard', name: 'Standard crane lift', desc: 'Routine lift operation. Remove pump, replace seals, reinstall.', cost: 25000, time: 3, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced procedure with extra inspections', desc: 'While the pump is out, conduct additional inspections of the mounting and surrounding area.', cost: 40000, time: 4, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'RCP seal replacement required. The pump is in a dedicated shielded room with airlock system.',
                    quote: "The pump room from 2025 - it's accessible, but this airlock system adds a lot of complexity. We need full contamination protocols just to get in there. Did we really need all this shielding for a coolant pump?",
                    options: [
                        { 
                            id: 'airlock', 
                            name: 'Full airlock protocol', 
                            desc: 'Follow complete airlock entry and exit procedures as designed.', 
                            cost: 45000, time: 6, dose: 2,
                            setState: { airlockMaintained: true }
                        },
                        { 
                            id: 'bypass', 
                            name: 'Temporary airlock bypass', 
                            desc: 'Faster access but requires additional contamination control paperwork.', 
                            cost: 35000, time: 4, dose: 2.5,
                            setState: { airlockBypassed: true }
                        }
                    ]
                }
            },
            // =====================================
            // STAGE 3: INSPECTION - Checks Stage 2 state
            // =====================================
            stage3: {
                corner: {
                    checkElementState: true,
                    scenarios: {
                        // They fixed the access in 2040
                        accessFixed: {
                            situation: 'Pump casing and mounting bolts require ultrasonic inspection. The access opening you cut in 2040 provides adequate clearance for probe positioning.',
                            quote: "Good call cutting that access opening back in 2040. I can actually get my UT probes in at the right angles now. Full coverage is possible. What level of inspection do you want?",
                            options: [
                                { id: 'standard', name: 'Standard UT inspection', desc: 'Full coverage with standard equipment.', cost: 20000, time: 3, dose: 1.5 },
                                { id: 'enhanced', name: 'Enhanced inspection with TOFD', desc: 'Additional Time-of-Flight Diffraction for better defect sizing.', cost: 30000, time: 4, dose: 2 }
                            ]
                        },
                        // They used a workaround - problem remains
                        workaroundUsed: {
                            situation: 'Pump casing inspection required. The corner position from 2025 was never permanently fixed - the specialist rigging in 2040 was just a workaround. Access is still constrained.',
                            quote: "Same problem as 2040. That corner position was never properly fixed - we just worked around it. Now I can't get my probes in at the right angle. We need to decide: fix it now, or accept the gaps?",
                            options: [
                                { 
                                    id: 'platform', 
                                    name: 'Install permanent access platform', 
                                    desc: 'Finally fix the access problem. Enables full inspection coverage for remaining plant life.', 
                                    cost: 120000, time: 12, dose: 2,
                                    setState: { accessFixed: true }
                                },
                                { 
                                    id: 'partial', 
                                    name: 'Scaffold and use angled probes', 
                                    desc: 'Achieves ~60% coverage. Uninspected areas will need to be documented.', 
                                    cost: 45000, time: 5, dose: 3,
                                    setState: { inspectionGap: true }
                                },
                                { 
                                    id: 'accept', 
                                    name: 'Accept inspection limitation', 
                                    desc: 'Mark areas as "inaccessible" in report. Regulator will note this. Cheapest but riskiest.', 
                                    cost: 5000, time: 1, dose: 0.5, healthImpact: -10,
                                    setState: { inspectionGap: true }
                                }
                            ]
                        },
                        // They tried to force it and caused damage
                        deteriorating: {
                            situation: 'Pump inspection urgently required. The forced removal attempt in 2040 caused damage that has been worsening. Access remains impossible.',
                            quote: "This is getting serious. That forced removal in 2040 - we damaged something and it's been getting worse. Vibrations are up 40%. And we STILL can't get proper access because the corner position was never fixed. We need to act.",
                            options: [
                                { 
                                    id: 'emergency', 
                                    name: 'Emergency retrofit and repair', 
                                    desc: 'Cut new access, conduct full inspection, repair damage from 2040.', 
                                    cost: 180000, time: 20, dose: 5,
                                    setState: { accessFixed: true, deteriorating: false }
                                },
                                { 
                                    id: 'monitor', 
                                    name: 'Enhanced monitoring only', 
                                    desc: 'Install more sensors. Hope we catch problems before failure. Very risky.', 
                                    cost: 30000, time: 3, dose: 1, healthImpact: -15,
                                    setState: { inspectionGap: true }
                                }
                            ]
                        },
                        // Default if no specific state (shouldn't happen)
                        default: {
                            situation: 'Pump inspection required. The corner position continues to create access challenges.',
                            quote: "That corner position from 2025 - still causing headaches for inspection access. What's the plan?",
                            options: [
                                { id: 'scaffold', name: 'Erect scaffolding', desc: 'Partial coverage achievable.', cost: 45000, time: 5, dose: 3, setState: { inspectionGap: true } },
                                { id: 'retrofit', name: 'Install permanent platform', desc: 'Fix the access problem permanently.', cost: 120000, time: 12, dose: 2, setState: { accessFixed: true } }
                            ]
                        }
                    }
                },
                openBay: {
                    situation: 'Pump casing and mounting bolts require ultrasonic inspection. The open bay provides excellent access from all angles.',
                    quote: "That open bay design from 2025 - brilliant. I've got full access all around the pump. Can get my probes in at every angle needed. Standard inspection or do you want the enhanced coverage?",
                    options: [
                        { id: 'standard', name: 'Standard UT inspection', desc: 'Full coverage with standard equipment. Meets all requirements.', cost: 15000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced inspection with TOFD', desc: 'Additional Time-of-Flight Diffraction technique for better defect sizing.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                dedicated: {
                    checkElementState: true,
                    scenarios: {
                        airlockMaintained: {
                            situation: 'Pump inspection required. Good access once inside the room. Airlock system has been properly maintained.',
                            quote: "Pump room airlock is working properly - we've been following protocols since 2040. Good access once I'm inside. Standard inspection approach?",
                            options: [
                                { id: 'standard', name: 'Standard inspection with airlock', desc: 'Full entry/exit protocols.', cost: 25000, time: 4, dose: 1.5 },
                                { id: 'extended', name: 'Extended single-entry inspection', desc: 'Do more in one access to minimise entries.', cost: 35000, time: 5, dose: 2 }
                            ]
                        },
                        airlockBypassed: {
                            situation: 'Pump inspection required. The airlock was bypassed in 2040, and contamination controls have been compromised since.',
                            quote: "Remember that airlock bypass in 2040? The contamination has spread. Room's messier than it should be. My team will need extra protection. This is going to be slow and expensive.",
                            options: [
                                { 
                                    id: 'contaminated', 
                                    name: 'Inspection with enhanced protection', 
                                    desc: 'Full PPE and decon procedures due to contamination spread.', 
                                    cost: 55000, time: 7, dose: 4 
                                },
                                { 
                                    id: 'clean', 
                                    name: 'Clean room first, then inspect', 
                                    desc: 'Decontaminate the area before inspection. More expensive but safer long-term.', 
                                    cost: 85000, time: 10, dose: 2,
                                    setState: { airlockMaintained: true, airlockBypassed: false }
                                }
                            ]
                        },
                        default: {
                            situation: 'Pump inspection required in dedicated room.',
                            quote: "Pump room access - standard airlock protocols apply.",
                            options: [
                                { id: 'standard', name: 'Standard inspection', desc: 'Follow entry/exit protocols.', cost: 25000, time: 4, dose: 1.5 }
                            ]
                        }
                    }
                }
            },
            // =====================================
            // STAGE 4: OPERATIONS - Checks cumulative state
            // =====================================
            stage4: {
                corner: {
                    checkElementState: true,
                    scenarios: {
                        // Access was fixed at some point - things are okay
                        accessFixed: {
                            situation: 'Pump operational review. The access was eventually fixed, and full inspection records are available.',
                            quote: "Pump's running well. That access opening we cut - it's let us maintain proper inspection records ever since. We know exactly what condition the pump's in. Just confirming the monitoring approach.",
                            options: [
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 10000, time: 0, dose: 0 },
                                { id: 'predictive', name: 'Predictive maintenance analysis', desc: 'Use our good historical data to optimise future maintenance.', cost: 25000, time: 1, dose: 0 }
                            ]
                        },
                        // Never fixed AND have inspection gaps - crisis
                        inspectionGap: {
                            situation: 'ALARM: 3am. Pump vibrations spiking. The vibration is coming from exactly the areas we could never properly inspect due to the corner position that was never fixed.',
                            quote: "It's 3am and we've got a serious problem. Pump vibrations are off the chart - and it's coming from exactly where we couldn't inspect. That corner position was never fixed, we've been flying blind for 30 years. What's the call, boss?",
                            options: [
                                { 
                                    id: 'shutdown', 
                                    name: 'Emergency shutdown', 
                                    desc: 'Trip the reactor. Safe but massive revenue loss and investigation required.', 
                                    cost: 200000, time: 7, dose: 3,
                                    setState: { emergencyOccurred: true }
                                },
                                { 
                                    id: 'reduce', 
                                    name: 'Reduce power to 50%', 
                                    desc: 'Lower stress on the pump. Monitor closely. Might stabilise, might not.', 
                                    cost: 50000, time: 0, dose: 0, risk: 40, healthImpact: -5 
                                },
                                { 
                                    id: 'continue', 
                                    name: 'Continue and monitor', 
                                    desc: 'It might be fine. Or the pump might fail catastrophically.', 
                                    cost: 0, time: 0, dose: 0, risk: 70, healthImpact: -20 
                                }
                            ]
                        },
                        // Deteriorating from 2040 damage - worse crisis
                        deteriorating: {
                            situation: 'CRITICAL ALARM. The pump damage from 2040 has progressed to imminent failure. Vibrations are extreme.',
                            quote: "CRITICAL. That damage from 2040 - we should have fixed it then. The pump's about to fail. We have minutes to decide, not hours. Trip the reactor or risk a LOCA.",
                            options: [
                                { 
                                    id: 'trip', 
                                    name: 'Emergency reactor trip', 
                                    desc: 'Immediate shutdown. Only safe option at this point.', 
                                    cost: 300000, time: 10, dose: 5, healthImpact: -10,
                                    setState: { emergencyOccurred: true, deteriorating: false }
                                },
                                { 
                                    id: 'gamble', 
                                    name: 'Attempt controlled runback', 
                                    desc: 'Try to reduce power gradually. Extremely risky.', 
                                    cost: 50000, time: 0, dose: 0, risk: 85, healthImpact: -30 
                                }
                            ]
                        },
                        default: {
                            situation: 'Pump operational review. Corner position continues to limit options.',
                            quote: "That corner position from 2025 still limits our monitoring options. Vibrations are within range but I'm not confident in our coverage.",
                            options: [
                                { id: 'enhanced', name: 'Enhanced monitoring', desc: 'Install additional sensors.', cost: 30000, time: 1, dose: 0 },
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 10000, time: 0, dose: 0 }
                            ]
                        }
                    }
                },
                openBay: {
                    situation: 'Pump operational review. All parameters nominal. Full inspection history available from good access over the years.',
                    quote: "Pump running perfectly. That open bay design from 2025 has given us complete inspection records over the years - we know exactly what condition it's in. No concerns here. Just confirming the monitoring approach.",
                    options: [
                        { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance programme.', cost: 5000, time: 0, dose: 0 },
                        { id: 'predictive', name: 'Predictive maintenance analysis', desc: 'Use historical data to optimise timing of next maintenance.', cost: 15000, time: 0, dose: 0 }
                    ]
                },
                dedicated: {
                    checkElementState: true,
                    scenarios: {
                        airlockMaintained: {
                            situation: 'Pump operational review. Pump and airlock system both running well.',
                            quote: "Pump's fine, airlock's been properly maintained since 2040. Extra maintenance overhead but no issues. Standard checks?",
                            options: [
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 15000, time: 0, dose: 0 },
                                { id: 'service', name: 'Full airlock service', desc: 'Preventive maintenance on airlock seals.', cost: 35000, time: 2, dose: 0.5 }
                            ]
                        },
                        airlockBypassed: {
                            situation: 'Pump running but room contamination from 2040 bypass continues to cause problems.',
                            quote: "That bypass in 2040 keeps haunting us. The room's contamination makes every entry expensive. We should really sort this out before decommissioning.",
                            options: [
                                { 
                                    id: 'cleanup', 
                                    name: 'Major decontamination', 
                                    desc: 'Clean the room properly. High cost now, saves money later.', 
                                    cost: 100000, time: 8, dose: 3,
                                    setState: { airlockMaintained: true, airlockBypassed: false }
                                },
                                { id: 'defer', name: 'Defer to decommissioning', desc: 'Live with it until end of life.', cost: 20000, time: 1, dose: 1 }
                            ]
                        },
                        default: {
                            situation: 'Pump operational review in dedicated room.',
                            quote: "Pump room status check. Systems nominal.",
                            options: [
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 15000, time: 0, dose: 0 }
                            ]
                        }
                    }
                }
            },
            // =====================================
            // STAGE 5: DECOMMISSIONING - Final consequences
            // =====================================
            stage5: {
                corner: {
                    checkElementState: true,
                    scenarios: {
                        // Access was fixed - manageable
                        accessFixed: {
                            situation: 'Pump removal for decommissioning. The access opening cut earlier makes removal possible, though not as easy as proper design would have been.',
                            quote: "At least we fixed the access at some point. Not as clean as a proper open bay design would have been, but we can get the pump out through the modified opening. Options for removal?",
                            options: [
                                { id: 'standard', name: 'Standard removal via modified access', desc: 'Use the access opening to remove pump intact.', cost: 45000, time: 8, dose: 3 },
                                { id: 'segmented', name: 'Segment for easier handling', desc: 'Cut pump into sections for removal.', cost: 60000, time: 12, dose: 2 }
                            ]
                        },
                        // Never fixed, but no emergency - expensive removal
                        inspectionGap: {
                            situation: 'Pump removal for decommissioning. The corner position was never fixed - same problem as 2040, sixty years later.',
                            quote: "Sixty years and we're back to the same problem. Corner position, pump doesn't fit. We got away with it operationally, but now we have to get this thing out somehow.",
                            options: [
                                { id: 'demolish', name: 'Demolish wall section', desc: 'Remove the concrete to create access.', cost: 80000, time: 15, dose: 4 },
                                { id: 'cut', name: 'Cut pump in-situ', desc: 'Segment the pump in the confined space.', cost: 60000, time: 20, dose: 8 },
                                { id: 'robot', name: 'Robotic cutting system', desc: 'Remote cutting minimises dose but expensive.', cost: 200000, time: 10, dose: 1 }
                            ]
                        },
                        // Had an emergency - pump may already be damaged/isolated
                        emergencyOccurred: {
                            situation: 'Pump decommissioning following the operational emergency. The pump was isolated after the incident and has been sitting inactive.',
                            quote: "This pump's been sitting here since that emergency. Not sure what state it's in internally. We need to be careful - could be damaged, could be fine. Still got that access problem too.",
                            options: [
                                { 
                                    id: 'careful', 
                                    name: 'Careful characterisation first', 
                                    desc: 'Full assessment before removal. Slower but safer.', 
                                    cost: 100000, time: 18, dose: 3 
                                },
                                { id: 'remote', name: 'Full remote handling', desc: 'Assume worst case, use robotics throughout.', cost: 250000, time: 12, dose: 0.5 }
                            ]
                        },
                        // Catastrophic - major contamination
                        deteriorating: {
                            situation: 'Pump decommissioning following catastrophic failure. Major contamination in the area. Remote handling mandatory.',
                            quote: "That pump failure contaminated the whole area. We're in full remote handling territory. This is going to take years and cost a fortune. The 2025 corner position plus the 2040 damage plus 2070... it all adds up.",
                            options: [
                                { id: 'remote', name: 'Full remote decommissioning', desc: 'Robotics only. No personnel entry possible.', cost: 400000, time: 30, dose: 2, healthImpact: -10 },
                                { id: 'encapsulate', name: 'Encapsulate and defer', desc: 'Seal the area for future generations to deal with.', cost: 150000, time: 10, dose: 1, healthImpact: -20 }
                            ]
                        },
                        default: {
                            situation: 'Pump removal for decommissioning. Corner access remains a challenge.',
                            quote: "That corner position from 2025 - still causing problems even at decommissioning. Pump doesn't fit through.",
                            options: [
                                { id: 'demolish', name: 'Demolish wall', desc: 'Create access by removing structure.', cost: 80000, time: 15, dose: 4 },
                                { id: 'cut', name: 'Cut in-situ', desc: 'Segment the pump in place.', cost: 60000, time: 20, dose: 8 }
                            ]
                        }
                    }
                },
                openBay: {
                    situation: 'Pump removal for decommissioning. Full crane access available - reverse of original installation.',
                    quote: "This is how decommissioning should work. That open bay from 2025 - crane hooks on, pump lifts out. Exactly like the installation but in reverse. Clean and simple. Sixty years of good design paying off one final time.",
                    options: [
                        { id: 'standard', name: 'Standard crane removal', desc: 'Lift and containerise in one operation.', cost: 20000, time: 3, dose: 1 },
                        { id: 'segmented', name: 'Segmented removal for recycling', desc: 'Additional cutting to enable material segregation.', cost: 35000, time: 5, dose: 1.5 }
                    ]
                },
                dedicated: {
                    checkElementState: true,
                    scenarios: {
                        airlockMaintained: {
                            situation: 'Pump removal straightforward, but the entire dedicated room must also be decommissioned. Airlock is in good condition.',
                            quote: "Pump comes out easily - that's not the issue. But that entire shielded room from 2025? The walls, the airlock - all unnecessary and all has to come out. At least it's clean.",
                            options: [
                                { id: 'full', name: 'Full room decommissioning', desc: 'Remove pump and all room structures.', cost: 120000, time: 10, dose: 2 },
                                { id: 'phased', name: 'Phased approach', desc: 'Pump first, room structure later.', cost: 140000, time: 14, dose: 2.5 }
                            ]
                        },
                        airlockBypassed: {
                            situation: 'Pump and room decommissioning complicated by contamination spread from the 2040 airlock bypass.',
                            quote: "That 2040 bypass decision - it's made this whole room a contamination problem. Pump removal is secondary to cleaning up the mess that's spread over 45 years. This is expensive.",
                            options: [
                                { id: 'full', name: 'Full decontamination and removal', desc: 'Clean everything, then remove.', cost: 200000, time: 18, dose: 4 },
                                { id: 'remote', name: 'Remote handling throughout', desc: 'Treat as high-contamination from the start.', cost: 280000, time: 15, dose: 1 }
                            ]
                        },
                        default: {
                            situation: 'Pump and dedicated room decommissioning.',
                            quote: "Pump room decommissioning. Standard approach.",
                            options: [
                                { id: 'full', name: 'Full decommissioning', desc: 'Remove everything.', cost: 150000, time: 12, dose: 2 }
                            ]
                        }
                    }
                }
            }
        },
        
        // ==========================================
        // ELEMENT 2: WELD CLEARANCE
        // ==========================================
        weldClearance: {
            title: 'Weld Access Clearance',
            stage1: {
                description: 'What clearance around pipe welds for inspection access?',
                options: [
                    { id: '50mm', name: '50mm (Code Minimum)', desc: 'Meets code but just barely.', cost: 60000, quality: 'poor' },
                    { id: '150mm', name: '150mm Clearance', desc: 'Adequate for all standard probes.', cost: 90000, quality: 'good' },
                    { id: '300mm', name: '300mm + Permanent Scaffolding', desc: 'Maximum clearance with fixed platforms.', cost: 160000, quality: 'wasteful' }
                ]
            },
            stage2: {
                '50mm': {
                    situation: 'Weld repair needed on a pipe section. The 50mm code-minimum clearance from the 2025 design makes welding positions extremely awkward.',
                    quote: "We've got a weld that needs repair, but that 50mm clearance from 2025 - it's the absolute minimum and now we're paying for it. My welder can barely get in there. How do you want to handle this?",
                    options: [
                        { id: 'awkward', name: 'Weld in awkward position', desc: 'Attempt the repair in constrained space. Risk of poor weld quality.', cost: 15000, time: 4, dose: 4, risk: 20, healthImpact: -5 },
                        { id: 'platform', name: 'Install temporary access platform', desc: 'Better working position, better quality weld.', cost: 35000, time: 6, dose: 2 },
                        { id: 'defer', name: 'Defer repair to next outage', desc: 'Leave the defect and monitor. Risk of progression.', cost: 0, time: 0, dose: 0, healthImpact: -5, trigger: 'weldDeferred' }
                    ]
                },
                '150mm': {
                    situation: 'Weld repair needed on a pipe section. The 150mm clearance specified in 2025 provides adequate working room.',
                    quote: "Found a weld that needs attention. Good news is that 150mm clearance from 2025 - my welder can get in there comfortably. Standard repair or do you want the enhanced treatment?",
                    options: [
                        { id: 'standard', name: 'Standard weld repair', desc: 'Normal repair procedure with good access.', cost: 20000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced repair with PWHT', desc: 'Post-weld heat treatment for maximum longevity.', cost: 30000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld repair needed. Plenty of clearance, but the permanent scaffolding installed in 2025 has surface contamination.',
                    quote: "The 300mm clearance is great for access, but that permanent scaffolding from 2025? It's picked up contamination over 15 years. We need to deal with that before we can work on the weld.",
                    options: [
                        { id: 'decon', name: 'Decontaminate scaffolding first', desc: 'Clean the scaffolding surfaces before repair work.', cost: 30000, time: 4, dose: 2 },
                        { id: 'remove', name: 'Remove contaminated scaffolding sections', desc: 'Take out the affected sections. Creates waste but clears the area.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                }
            },
            stage3: {
                '50mm': {
                    situation: 'In-Service Inspection of pipe welds required. The UT probe needs 80mm minimum clearance - you only have 50mm.',
                    quote: "In-service inspection time. That 50mm clearance from 2025 - my probe needs 80mm to get the right angle. I physically cannot achieve full coverage. What do you want me to do?",
                    options: [
                        { id: 'partial', name: 'Accept 60% coverage', desc: 'Document the limitation. Regulator will note the gap.', cost: 5000, time: 3, dose: 3, healthImpact: -10, trigger: 'weldInspectionGap' },
                        { id: 'miniprobe', name: 'Use specialist miniature probes', desc: 'Smaller probes give better access but reduced accuracy.', cost: 40000, time: 5, dose: 4, healthImpact: -5 },
                        { id: 'excavate', name: 'Excavate wall for permanent access', desc: 'Create the clearance that should have been there from the start.', cost: 90000, time: 10, dose: 3 }
                    ]
                },
                '150mm': {
                    situation: 'In-Service Inspection of pipe welds required. The 150mm clearance provides full probe access.',
                    quote: "Weld inspections due. That 150mm clearance from 2025 - exactly what I need. Full coverage, all angles. Just need to know if you want standard or the enhanced approach.",
                    options: [
                        { id: 'standard', name: 'Standard UT examination', desc: '100% coverage achieved with standard equipment.', cost: 15000, time: 2, dose: 1 },
                        { id: 'phased', name: 'Phased array for enhanced detection', desc: 'Better defect characterisation and sizing.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld inspection required. The permanent scaffolding from 2025 partially blocks some probe angles.',
                    quote: "Good clearance overall, but that permanent scaffolding from 2025 is in my way for some of the shots. I can work around it, but it adds time. Or we can survey the scaffolding condition too while we're here.",
                    options: [
                        { id: 'workaround', name: 'Work around scaffolding', desc: 'Some awkward angles but achievable.', cost: 20000, time: 4, dose: 2 },
                        { id: 'survey', name: 'Include scaffolding contamination survey', desc: 'Check the scaffolding condition while doing the inspection.', cost: 30000, time: 5, dose: 2.5 }
                    ]
                }
            },
            stage4: {
                '50mm': {
                    checkTrigger: 'weldInspectionGap',
                    triggered: {
                        situation: 'Leak detected at a weld location. It is in the area that could not be fully inspected in 2055 due to the 50mm clearance limitation.',
                        quote: "We've got a leak - and it's at exactly the weld location we couldn't properly inspect in 2055 because of that 50mm clearance. If we'd had proper access, we'd have caught this developing. What now?",
                        options: [
                            { id: 'shutdown', name: 'Immediate shutdown and repair', desc: 'Fix it properly. Significant outage required.', cost: 200000, time: 14, dose: 5 },
                            { id: 'seal', name: 'Online leak sealing', desc: 'Temporary clamp seal. May not hold long-term.', cost: 50000, time: 2, dose: 2, risk: 40, healthImpact: -10 },
                            { id: 'reduce', name: 'Reduce power and monitor', desc: 'Lower pressure may slow the leak. Live with it until planned outage.', cost: 80000, time: 0, dose: 0, healthImpact: -5 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Weld operational review. No leaks detected, but the areas with limited inspection coverage remain a concern.',
                        quote: "No leaks yet, but that 50mm clearance from 2025 still limits what we could see in inspections. We're monitoring the areas we could check - but what we couldn't see still worries me.",
                        options: [
                            { id: 'monitor', name: 'Enhanced leak detection', desc: 'Additional monitoring equipment on high-risk areas.', cost: 25000, time: 1, dose: 0 },
                            { id: 'standard', name: 'Standard monitoring', desc: 'Continue with normal programme.', cost: 10000, time: 0, dose: 0 }
                        ]
                    }
                },
                '150mm': {
                    situation: 'Weld operational review. All welds were fully inspected at the 30-year mark. No concerns.',
                    quote: "All those welds we inspected properly in 2055 because of the 150mm clearance? Complete records, no surprises. Full confidence in the system. Just confirming monitoring approach.",
                    options: [
                        { id: 'maintain', name: 'Maintain inspection programme', desc: 'Continue the proven approach.', cost: 5000, time: 0, dose: 0 },
                        { id: 'extend', name: 'Extend coverage to additional welds', desc: 'Broaden the surveillance programme.', cost: 15000, time: 1, dose: 0.5 }
                    ]
                },
                '300mm': {
                    situation: 'Welds are fine but the permanent scaffolding contamination levels are increasing each year. Annual surveys now required.',
                    quote: "Welds are all okay, but that scaffolding from 2025 - the contamination keeps building up. We're now doing annual surveys just to track how hot it's getting. Want to deal with it now or keep monitoring?",
                    options: [
                        { id: 'survey', name: 'Continue annual scaffolding surveys', desc: 'Track the contamination build-up.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'remove', name: 'Remove scaffolding now', desc: 'Deal with it before it becomes ILW.', cost: 40000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                '50mm': {
                    situation: 'Pipe cutting required for removal. The 50mm clearance leaves no room for standard cutting equipment.',
                    quote: "Time to cut these pipes out. That 50mm clearance from 2025 - no room for our normal cutting gear. We're going to be doing this the hard way. Confined space work or bring in specialists?",
                    options: [
                        { id: 'manual', name: 'Manual cutting in confined space', desc: 'High dose, slow progress, contamination risk.', cost: 30000, time: 8, dose: 5, risk: 40 },
                        { id: 'specialist', name: 'Specialist confined-space contractor', desc: 'Experts with proper equipment for tight access.', cost: 100000, time: 5, dose: 2 }
                    ]
                },
                '150mm': {
                    situation: 'Pipe cutting for removal. Good access for standard cutting equipment.',
                    quote: "That 150mm clearance from 2025 - still paying dividends at the end. Standard cutting gear fits perfectly. Clean cuts, professional job. What's the approach?",
                    options: [
                        { id: 'standard', name: 'Standard cutting and removal', desc: 'Normal decommissioning procedures.', cost: 25000, time: 3, dose: 1 },
                        { id: 'segregate', name: 'Cut with material segregation', desc: 'Additional effort to separate materials for recycling.', cost: 35000, time: 4, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld cutting is easy with the clearance, but the permanent scaffolding has become ILW after 30 years of contamination accumulation.',
                    quote: "Easy access for the welds - that's the good news. The bad news? That scaffolding from 2025 has been accumulating activity for 60 years. It's now intermediate level waste. Another disposal headache.",
                    options: [
                        { id: 'both', name: 'Remove welds and scaffolding together', desc: 'Deal with the additional waste now.', cost: 85000, time: 8, dose: 3 },
                        { id: 'defer', name: 'Welds now, scaffolding later', desc: 'Split the work. Extends overall project.', cost: 50000, time: 5, dose: 2, healthImpact: -3 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 3: CONTROL PANEL
        // ==========================================
        controlPanel: {
            title: 'Control Panel Layout',
            stage1: {
                description: 'How should the control panel be organised?',
                options: [
                    { id: 'system', name: 'System-Based Layout', desc: 'Grouped by system (all pump controls together).', cost: 70000, quality: 'poor' },
                    { id: 'task', name: 'Task-Based Layout', desc: 'Grouped by workflow. Emergency sequence left-to-right.', cost: 100000, quality: 'good' },
                    { id: 'touch', name: 'Touchscreen Interface', desc: 'Modern digital displays. Impressive technology.', cost: 150000, quality: 'poor' }
                ]
            },
            stage2: {
                system: {
                    situation: 'Operators have submitted 15 human factors concern reports in 15 years. The system-based layout causes confusion during abnormal conditions - controls for related actions are scattered across different panels.',
                    quote: "We've had 15 formal complaints about the control panel since 2025. The system-based layout - when things go wrong, operators can't find what they need quickly. Controls for emergency sequences are all over the place. How do you want to address this?",
                    options: [
                        { id: 'redesign', name: 'Commission HF review and redesign', desc: 'Proper human factors assessment and panel modifications.', cost: 60000, time: 0, dose: 0, setFlag: 'panelRedesigned' },
                        { id: 'labels', name: 'Add labels and colour coding', desc: 'Cheap visual improvements. Limited real benefit.', cost: 15000, time: 0, dose: 0 },
                        { id: 'nothing', name: 'Issue training reminder', desc: 'Tell operators to try harder.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                task: {
                    situation: 'Control room operations review. The task-based layout from 2025 is working well - operators report intuitive workflow during both normal and abnormal conditions.',
                    quote: "The operators love the panel layout from 2025. Task-based design - emergency sequences flow left to right, everything's where they expect it. Just needs standard maintenance. Any enhancements you want to add?",
                    options: [
                        { id: 'maintain', name: 'Standard maintenance', desc: 'Keep it running as designed.', cost: 10000, time: 0, dose: 0 },
                        { id: 'enhance', name: 'Add status display enhancements', desc: 'Minor improvements to status indicators.', cost: 20000, time: 0, dose: 0 }
                    ]
                },
                touch: {
                    situation: 'Three touchscreen failures in 15 years. Operators report issues with gloves, low-light conditions, and response lag during high-activity periods.',
                    quote: "That touchscreen system from 2025 - we've had three complete failures already. Operators can't use it with gloves, it's hard to see in emergency lighting, and it lags when they need it most. I'm concerned about the next emergency. What do you want to do?",
                    options: [
                        { id: 'backup', name: 'Install hardwired backup panel', desc: 'Physical buttons as safety backup.', cost: 70000, time: 0, dose: 0, setFlag: 'backupPanel' },
                        { id: 'upgrade', name: 'Upgrade to industrial touchscreens', desc: 'Better screens, but still touchscreens.', cost: 50000, time: 0, dose: 0 },
                        { id: 'train', name: 'Additional operator training', desc: 'Train them to work around the limitations.', cost: 10000, time: 0, dose: 0 }
                    ]
                }
            },
            stage3: {
                system: {
                    situation: 'Regulatory safety review of control systems. Human-Machine Interface assessment is part of the inspection programme.',
                    quote: "Regulator is here for the HMI assessment. That system-based layout from 2025 - they're going to note the operator complaints. We should have the review documentation ready. How thorough do you want us to be?",
                    options: [
                        { id: 'review', name: 'Full HMI review with action plan', desc: 'Comprehensive assessment and improvement recommendations.', cost: 20000, time: 2, dose: 0 },
                        { id: 'minimal', name: 'Minimal compliance documentation', desc: 'Meet the minimum requirements.', cost: 8000, time: 1, dose: 0 }
                    ]
                },
                task: {
                    situation: 'Regulatory safety review of control systems. The task-based panel from 2025 receives consistently high human factors ratings.',
                    quote: "Regulator's reviewing our control systems. That task-based layout from 2025? Operators score it highly, incident response times are good. We're in good shape. Standard review or go above and beyond?",
                    options: [
                        { id: 'standard', name: 'Standard review', desc: 'Confirm continued good performance.', cost: 10000, time: 1, dose: 0 },
                        { id: 'benchmark', name: 'Benchmark against industry best practice', desc: 'Compare to leading facilities worldwide.', cost: 18000, time: 2, dose: 0 }
                    ]
                },
                touch: {
                    situation: 'Safety review identifies display artefacts and intermittent software glitches in the touchscreen system. System is showing its age.',
                    quote: "The touchscreens from 2025 - they're 30 years old and the software is getting flaky. Display glitches, slow response. The regulator wants to see our maintenance plan. What level of fix are we looking at?",
                    options: [
                        { id: 'software', name: 'Full software update and hardware refresh', desc: 'Comprehensive system update.', cost: 35000, time: 2, dose: 0 },
                        { id: 'patch', name: 'Critical patches only', desc: 'Fix the worst bugs. Hope for the best.', cost: 15000, time: 1, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                system: {
                    checkFlag: 'panelRedesigned',
                    hasFlag: {
                        situation: 'ALARM: Loss of Coolant Flow indication. The panel was redesigned after the 2040 review - improved layout helps operator response.',
                        quote: "LOCA indication! Good news - we fixed that panel layout after 2040. Operators are finding controls faster than before. Still not as good as it could have been from the start, but better. What's your call on the response?",
                        options: [
                            { id: 'respond', name: 'Standard emergency response', desc: 'Follow procedure with improved panel.', cost: 20000, time: 1, dose: 1 },
                            { id: 'senior', name: 'Call shift supervisor for support', desc: 'Extra verification for complex event.', cost: 5000, time: 1, dose: 0.5 }
                        ]
                    },
                    noFlag: {
                        situation: 'ALARM: Loss of Coolant Flow indication. The system-based panel layout from 2025 was never fixed. Operators are struggling to locate the correct controls.',
                        quote: "LOCA indication at 3am! Operators can't find the isolation valves - that system-based layout from 2025 has controls scattered everywhere. We never fixed it after the complaints. This is exactly the scenario we worried about!",
                        options: [
                            { id: 'search', name: 'Search for correct controls', desc: 'Delayed response while operators hunt for switches.', cost: 50000, time: 2, dose: 3, risk: 40, healthImpact: -10 },
                            { id: 'senior', name: 'Immediately call senior operator', desc: 'Get experienced help. Your failure is on record.', cost: 10000, time: 1, dose: 1, trigger: 'operatorFailure' },
                            { id: 'procedure', name: 'Follow procedure step by step', desc: 'Slow but systematic reduces error chance.', cost: 30000, time: 3, dose: 2 }
                        ]
                    }
                },
                task: {
                    situation: 'ALARM: Loss of Coolant Flow indication. The task-based panel layout from 2025 means emergency controls are exactly where operators expect them.',
                    quote: "LOCA indication - but watch this. Task-based layout from 2025: reactor trip here, safety injection there, isolation valves in sequence. Operators are executing the response exactly as trained. Textbook.",
                    options: [
                        { id: 'respond', name: 'Execute standard emergency response', desc: 'Smooth response using well-designed panel.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'verify', name: 'Execute with additional verification', desc: 'Extra checks at each step.', cost: 8000, time: 0, dose: 0.5 }
                    ]
                },
                touch: {
                    checkFlag: 'backupPanel',
                    hasFlag: {
                        situation: 'ALARM: System transient. Touchscreens are lagging under heavy demand, but the backup hardwired panel installed after 2040 is available.',
                        quote: "Transient in progress - touchscreens are struggling with the load. But that backup panel we installed after 2040 is right there. Physical switches, instant response. Thank God we put that in. Switching over?",
                        options: [
                            { id: 'backup', name: 'Switch to hardwired backup', desc: 'Reliable physical controls.', cost: 15000, time: 1, dose: 1 },
                            { id: 'wait', name: 'Wait for touchscreens to recover', desc: 'They might speed up. Risky delay.', cost: 0, time: 2, dose: 0, risk: 30, healthImpact: -5 }
                        ]
                    },
                    noFlag: {
                        situation: 'ALARM: System transient. Touchscreens are frozen. Gloved fingers not registering. No backup panel available.',
                        quote: "Touchscreens are frozen solid! Operators can't get any response - gloves don't work, the screens have locked up. We never installed that backup panel after 2040. We have no control interface. What do we do?!",
                        options: [
                            { id: 'reboot', name: 'Emergency system reboot', desc: 'Fast but everything goes dark during restart.', cost: 0, time: 2, dose: 0, risk: 50, healthImpact: -15 },
                            { id: 'manual', name: 'Send operators to local panels', desc: 'Manual operation from field locations.', cost: 30000, time: 4, dose: 4 },
                            { id: 'scram', name: 'Manual reactor trip', desc: 'Safe shutdown. Major investigation follows.', cost: 100000, time: 5, dose: 1 }
                        ]
                    }
                }
            },
            stage5: {
                system: {
                    situation: 'Control panel decommissioning. Standard electrical equipment removal.',
                    quote: "Taking out the control panels. That system-based layout from 2025 caused headaches for 60 years - at least it comes out easily. Standard removal or do you want it preserved for lessons learned?",
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning procedure.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'preserve', name: 'Preserve as training example', desc: 'Document what not to do for future projects.', cost: 20000, time: 3, dose: 0.5 }
                    ]
                },
                task: {
                    situation: 'Control panel decommissioning. The well-designed panel served operators well for 60 years.',
                    quote: "End of the line for the control panel. That task-based design from 2025 served us well - 60 years of reliable operation, operators loved it. Any interest in documenting this as a best practice example?",
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning procedure.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'document', name: 'Document as best practice', desc: 'Capture the design principles for future projects.', cost: 15000, time: 2, dose: 0.5 }
                    ]
                },
                touch: {
                    situation: 'Touchscreen system decommissioning. Electronic waste requires specialist disposal.',
                    quote: "The touchscreen system from 2025 - finally taking it out. E-waste disposal requirements for all this electronics. Plus the usual radioactive contamination on the surfaces. Specialist handling needed.",
                    options: [
                        { id: 'ewaste', name: 'Specialist e-waste disposal', desc: 'Proper handling of contaminated electronics.', cost: 30000, time: 3, dose: 0 },
                        { id: 'strip', name: 'Strip valuable components first', desc: 'Recover materials before disposal.', cost: 20000, time: 4, dose: 0.5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 4: PIPE CONNECTIONS
        // ==========================================
        pipeConnections: {
            title: 'Pipe Connections',
            stage1: {
                description: 'How should pipe joints be designed?',
                options: [
                    { id: 'welded', name: 'All Welded', desc: 'Continuous welds throughout. No break points. More welding labour.', cost: 140000, quality: 'poor' },
                    { id: 'flanged', name: 'Flanged at Strategic Points', desc: 'Bolted flanges every 6m and at components. Optimised design.', cost: 100000, quality: 'good' },
                    { id: 'excessive', name: 'Flanges Everywhere', desc: 'Flanged every 2m. Maximum flexibility but many potential leak paths.', cost: 180000, quality: 'wasteful' }
                ]
            },
            stage2: {
                welded: {
                    situation: 'A pipe section needs replacement. The all-welded design from 2025 means there are no break points - must cut and re-weld.',
                    quote: "Need to replace a section of pipe. That all-welded design from 2025 - cost more in welding labour AND there's nowhere to unbolt. We have to cut it out and weld in the replacement. Time-consuming and high dose. How do you want to proceed?",
                    options: [
                        { id: 'replace', name: 'Cut, replace, and re-weld', desc: 'Proper repair but significant work.', cost: 65000, time: 8, dose: 5 },
                        { id: 'overlay', name: 'Weld overlay repair', desc: 'Temporary fix. Will need revisiting eventually.', cost: 25000, time: 3, dose: 3, healthImpact: -5, trigger: 'weldOverlay' }
                    ]
                },
                flanged: {
                    situation: 'A pipe section needs replacement. The flanged connections from the 2025 design allow easy section removal.',
                    quote: "Pipe section needs replacing. Those flanged connections from 2025 - cheapest option AND the smartest. Just unbolt, remove the section, and bolt in the new one. Clean and simple. Standard replacement or should we upgrade the gaskets while we're there?",
                    options: [
                        { id: 'standard', name: 'Standard flange replacement', desc: 'Unbolt, replace section, re-bolt.', cost: 30000, time: 3, dose: 1.5 },
                        { id: 'upgrade', name: 'Replace with upgraded gaskets', desc: 'Better gasket material for longer life.', cost: 40000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: 'Three gasket failures this outage. With flanges every 2m from the 2025 design, there are 47 potential leak paths.',
                    quote: "Third gasket failure this week. That design from 2025 with flanges every 2m - 47 flanges means 47 places to leak. We're chasing gaskets constantly. Do you want to replace all of them preventively or keep playing whack-a-mole?",
                    options: [
                        { id: 'replace', name: 'Replace all gaskets preventively', desc: 'Do them all now. No more surprises this outage.', cost: 45000, time: 5, dose: 2 },
                        { id: 'reactive', name: 'Keep replacing as they fail', desc: 'Fix what breaks. Hope it holds.', cost: 15000, time: 2, dose: 1, healthImpact: -3 }
                    ]
                }
            },
            stage3: {
                welded: {
                    situation: 'All welds require inspection. The all-welded design from 2025 means a large number of weld examinations are needed.',
                    quote: "Inspection programme time. That all-welded design from 2025 - every joint is a weld, every weld needs examining. It's a lot of coverage. Full programme or sample-based approach?",
                    options: [
                        { id: 'full', name: 'Full inspection of all welds', desc: 'Examine every weld in the system.', cost: 50000, time: 7, dose: 4 },
                        { id: 'sample', name: 'Sample 50% of welds', desc: 'Risk-based selection. May miss developing defects.', cost: 25000, time: 4, dose: 2, healthImpact: -5 }
                    ]
                },
                flanged: {
                    situation: 'Limited number of welds to inspect. Flanged joints from 2025 require visual and torque checks.',
                    quote: "Inspection time. That flanged design from 2025 means fewer welds to examine. Just need to UT the welds we have and verify the flange bolt torques. Straightforward. Any extras you want?",
                    options: [
                        { id: 'standard', name: 'Standard inspection programme', desc: 'UT on welds, visual and torque on flanges.', cost: 20000, time: 3, dose: 1.5 },
                        { id: 'torque', name: 'Add detailed bolt torque analysis', desc: 'Extra verification of flange integrity.', cost: 28000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: '47 flanged connections to inspect. Many gaskets from 2025 are showing wear after 30 years.',
                    quote: "47 flanges to check from that 2025 design. I'll be verifying bolts and gaskets all week. Some of these gaskets are 30 years old and looking tired. Full coverage or prioritise high-risk locations?",
                    options: [
                        { id: 'all', name: 'Inspect all 47 connections', desc: 'Thorough but time-consuming.', cost: 35000, time: 6, dose: 2.5 },
                        { id: 'sample', name: 'Prioritise high-risk locations', desc: 'Focus on problem areas. May miss issues elsewhere.', cost: 20000, time: 3, dose: 1.5, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                welded: {
                    situation: 'Online maintenance needed but the all-welded design from 2025 provides no isolation points.',
                    quote: "We need to do some maintenance, but that all-welded design from 2025 - there's nowhere to isolate. Can't do it online. We either wait for the outage or take a partial shutdown. Your call.",
                    options: [
                        { id: 'defer', name: 'Defer to next scheduled outage', desc: 'Wait for full shutdown. Work accumulates.', cost: 10000, time: 0, dose: 0 },
                        { id: 'partial', name: 'Partial shutdown for access', desc: 'Reduce power to create safe work window.', cost: 40000, time: 2, dose: 1 }
                    ]
                },
                flanged: {
                    situation: 'Online maintenance needed. The flanged design from 2025 allows isolation and work at power.',
                    quote: "Valve needs attention. That flanged design from 2025 - saved money upfront AND we can isolate the section and work while the plant runs. No shutdown needed. Do it now or schedule for the outage?",
                    options: [
                        { id: 'online', name: 'Isolate and work at power', desc: 'Use the flexibility of flanged design.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'defer', name: 'Defer to outage', desc: 'Not urgent. Can wait.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                excessive: {
                    situation: 'Two more gasket failures during this operating period. The 47-flange design from 2025 continues to cause problems.',
                    quote: "Two more gaskets gone. That 47-flange design from 2025 - we're still fighting it 45 years later. Every flange is an opportunity for a leak. Fix them during a mini-outage or try to manage through?",
                    options: [
                        { id: 'repair', name: 'Short outage to repair leakers', desc: 'Fix the immediate problems.', cost: 30000, time: 3, dose: 1 },
                        { id: 'monitor', name: 'Manage leakage and monitor', desc: 'Live with minor seepage. Not ideal.', cost: 10000, time: 0, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage5: {
                welded: {
                    situation: 'Pipe removal for decommissioning. The all-welded design from 2025 means 12 welds to cut. Each cut risks contamination spread.',
                    quote: "Time to take these pipes out. That all-welded design from 2025 means 12 cuts to make. Each one sprays contamination if we're not careful. Slow and steady, or bring in the specialists?",
                    options: [
                        { id: 'careful', name: 'Careful in-house cutting programme', desc: 'Slow and controlled. Higher dose.', cost: 80000, time: 15, dose: 8, risk: 30 },
                        { id: 'specialist', name: 'Specialist cutting contractor', desc: 'Experts with containment equipment.', cost: 180000, time: 10, dose: 3 }
                    ]
                },
                flanged: {
                    situation: 'Pipe removal for decommissioning. The flanged design from 2025 means unbolt and remove in sections.',
                    quote: "Decommissioning the pipework. That flanged design from 2025 - cheapest to build and cheapest to remove. Unbolt the flanges, lift out the sections. No cutting, minimal contamination. Standard removal or segregate for recycling?",
                    options: [
                        { id: 'standard', name: 'Standard flange disassembly', desc: 'Unbolt and remove. Clean and simple.', cost: 40000, time: 6, dose: 2 },
                        { id: 'segregate', name: 'Segregate materials for recycling', desc: 'Extra effort to separate materials.', cost: 55000, time: 8, dose: 2.5 }
                    ]
                },
                excessive: {
                    situation: '47 flange connections to disconnect. Many contaminated gaskets to dispose of as waste.',
                    quote: "47 flanges from that 2025 design - at least they unbolt easily. But every one of those gaskets is contaminated waste now. Lots of small waste packages. Deal with it systematically or cut corners?",
                    options: [
                        { id: 'full', name: 'Full systematic disassembly', desc: 'All 47 connections done properly.', cost: 55000, time: 10, dose: 3 },
                        { id: 'bulk', name: 'Cut into larger sections instead', desc: 'Fewer disconnections but larger packages.', cost: 45000, time: 8, dose: 2.5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 5: PIPE ROUTING
        // ==========================================
        pipeRouting: {
            title: 'Pipe Routing',
            stage1: {
                description: 'How should pipes run through concrete structure?',
                options: [
                    { id: 'embedded', name: 'Embedded in Concrete', desc: 'Cast directly into structural concrete.', cost: 90000, quality: 'poor' },
                    { id: 'ducted', name: 'Accessible Ducts', desc: 'Removable duct covers for access.', cost: 130000, quality: 'good' },
                    { id: 'tunnel', name: 'Walk-In Tunnel', desc: 'Large accessible service tunnel.', cost: 220000, quality: 'wasteful' }
                ]
            },
            stage2: {
                embedded: {
                    situation: 'Suspected leak somewhere in an embedded pipe section. The pipes are cast into concrete from the 2025 design - cannot visually confirm location.',
                    quote: "We've got activity readings suggesting a leak, but those embedded pipes from 2025 - they're buried in the concrete. I can't see where it's coming from. We either dig until we find it, route around it, or hope it stabilises. Your call.",
                    options: [
                        { id: 'excavate', name: 'Excavate concrete to find leak', desc: 'Dig until we locate the source.', cost: 70000, time: 12, dose: 4 },
                        { id: 'bypass', name: 'Install bypass line around section', desc: 'Route around the problem entirely.', cost: 90000, time: 8, dose: 2 },
                        { id: 'defer', name: 'Increase monitoring and defer', desc: 'Hope it stabilises. Monitor closely.', cost: 10000, time: 0, dose: 0, healthImpact: -10, trigger: 'embeddedLeak' }
                    ]
                },
                ducted: {
                    situation: 'Minor leak detected at a pipe joint. The accessible ducts from the 2025 design allow easy location and access.',
                    quote: "Found a small leak - pulled off the duct cover from that 2025 design and there it is, plain as day. Easy to see, easy to fix. Standard repair or should I check the neighbouring joints while I'm here?",
                    options: [
                        { id: 'repair', name: 'Standard repair', desc: 'Fix the leaking joint.', cost: 15000, time: 2, dose: 1 },
                        { id: 'inspect', name: 'Repair and inspect neighbours', desc: 'Check adjacent joints while access is open.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Leak repaired easily with walk-in access. However, the tunnel surfaces from 2025 are showing contamination migration.',
                    quote: "Easy access through the tunnel to fix the leak - that 2025 design makes repairs simple. But the tunnel walls themselves are picking up contamination. We should deal with that while we're here. Clean it or seal it?",
                    options: [
                        { id: 'repair', name: 'Repair and decontaminate tunnel', desc: 'Fix leak and clean surfaces.', cost: 35000, time: 4, dose: 2 },
                        { id: 'seal', name: 'Repair and seal contamination', desc: 'Contain it for now. Defer full decon.', cost: 25000, time: 3, dose: 1.5, healthImpact: -3 }
                    ]
                }
            },
            stage3: {
                embedded: {
                    situation: 'In-Service Inspection required. The embedded pipes from 2025 cannot be examined by conventional ultrasonic or visual methods.',
                    quote: "How do I inspect pipes that are buried in concrete from 2025? The short answer is: I can't. Not with conventional methods. We can document the limitation, try guided wave technology, or excavate samples. What's the approach?",
                    options: [
                        { id: 'accept', name: 'Document inspection gap', desc: 'Accept and document the limitation.', cost: 5000, time: 1, dose: 0, healthImpact: -10, trigger: 'embeddedInspectionGap' },
                        { id: 'guided', name: 'Install guided wave monitoring', desc: 'Some detection capability through concrete.', cost: 60000, time: 5, dose: 1 },
                        { id: 'excavate', name: 'Excavate sample locations', desc: 'Physically expose sections for examination.', cost: 100000, time: 14, dose: 5 }
                    ]
                },
                ducted: {
                    situation: 'Full pipe inspection via removable duct covers from the 2025 design. Complete access available.',
                    quote: "Inspection time. Those duct covers from 2025 - lift them off and I've got full access to every inch of pipe. Complete coverage, no limitations. Standard inspection or add coating condition assessment?",
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Full visual and UT coverage.', cost: 15000, time: 3, dose: 1.5 },
                        { id: 'coating', name: 'Include coating condition assessment', desc: 'Check protective coating integrity.', cost: 22000, time: 4, dose: 2 }
                    ]
                },
                tunnel: {
                    situation: 'Pipe inspection in the walk-in tunnel. Good access but the tunnel from 2025 is now contaminated, requiring full PPE.',
                    quote: "Easy pipe access through the tunnel, but 30 years of operation means it's contaminated now. Full suits required just to get in there. That 2025 tunnel design - easy access comes with dose penalty. Full inspection or remote camera?",
                    options: [
                        { id: 'suited', name: 'Full hands-on inspection in PPE', desc: 'Complete coverage but slower in suits.', cost: 25000, time: 5, dose: 3 },
                        { id: 'remote', name: 'Remote camera inspection', desc: 'Limited contact but lower dose.', cost: 30000, time: 4, dose: 1, healthImpact: -2 }
                    ]
                }
            },
            stage4: {
                embedded: {
                    checkTrigger: 'embeddedLeak',
                    triggered: {
                        situation: 'Groundwater monitoring detects radioactive contamination. The source is the embedded pipe leak that was deferred in 2040.',
                        quote: "Remember that leak we couldn't find in 2040? The one in the embedded pipes from 2025 that we decided to monitor? It's been leaking into the groundwater for 30 years. Environmental regulator is involved. This is serious.",
                        additionalCosts: { regulatory: 50000, environmental: 100000, healthImpact: -15 },
                        options: [
                            { id: 'excavate', name: 'Emergency excavation and repair', desc: 'Dig out the embedded section and fix it.', cost: 200000, time: 21, dose: 8 },
                            { id: 'treat', name: 'Groundwater treatment and isolation', desc: 'Treat the water, abandon the pipe section.', cost: 150000, time: 7, dose: 2 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Monitoring of embedded pipe sections continues. No activity detected in groundwater so far.',
                        quote: "Still monitoring those embedded pipes from 2025. Groundwater sampling shows nothing... yet. But we're flying blind on actual pipe condition. Continue monitoring or enhance detection capability?",
                        options: [
                            { id: 'maintain', name: 'Continue current monitoring', desc: 'Keep watching the groundwater.', cost: 15000, time: 0, dose: 0 },
                            { id: 'enhance', name: 'Enhanced monitoring network', desc: 'More sampling points, faster detection.', cost: 30000, time: 1, dose: 0 }
                        ]
                    }
                },
                ducted: {
                    situation: 'Quick operational checks through duct access. The 2025 design continues to provide excellent accessibility.',
                    quote: "Running operational checks. That ducted design from 2025 - I can pop the covers and do a visual check in minutes. Want the standard check or add thermal imaging for early leak detection?",
                    options: [
                        { id: 'visual', name: 'Routine visual inspection', desc: 'Quick visual through duct covers.', cost: 5000, time: 0, dose: 0 },
                        { id: 'thermal', name: 'Add thermal imaging survey', desc: 'Infrared check for developing leaks.', cost: 15000, time: 1, dose: 0 }
                    ]
                },
                tunnel: {
                    situation: 'Tunnel access maintained. Contamination levels stable but requiring ongoing control.',
                    quote: "Tunnel from 2025 - still accessible, still contaminated. We're maintaining the contamination controls but it's an ongoing burden. Status quo or invest in reducing the source term?",
                    options: [
                        { id: 'maintain', name: 'Continue routine monitoring', desc: 'Maintain current controls.', cost: 10000, time: 0, dose: 0.5 },
                        { id: 'decon', name: 'Partial decontamination campaign', desc: 'Reduce hotspots in the tunnel.', cost: 35000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                embedded: {
                    situation: 'Pipes cast into concrete from 2025 require major excavation. Contamination has migrated into the concrete matrix itself.',
                    quote: "The embedded pipes from 2025 - now the contamination has soaked into the surrounding concrete over 60 years. We're not just removing pipes, we're removing contaminated structural concrete. Huge job. In-house or specialists?",
                    options: [
                        { id: 'excavate', name: 'Full in-house excavation', desc: 'Our teams break out all the concrete.', cost: 350000, time: 40, dose: 20 },
                        { id: 'specialist', name: 'Specialist demolition contractor', desc: 'Controlled demolition with contamination management.', cost: 400000, time: 25, dose: 8 }
                    ]
                },
                ducted: {
                    situation: 'Pipe removal via duct access. The ducts from 2025 remain uncontaminated and can be demolished as clean concrete.',
                    quote: "Best news I've had all project. Those duct covers from 2025 - lift them off, pull out the pipes, and the duct structures themselves are clean concrete. Standard demolition for the ducts. Want to assess if they could be kept for other use?",
                    options: [
                        { id: 'standard', name: 'Standard pipe and duct removal', desc: 'Remove pipes, demolish clean ducts.', cost: 50000, time: 8, dose: 2 },
                        { id: 'reuse', name: 'Assess duct structures for reuse', desc: 'Check if ducts can serve future purpose.', cost: 40000, time: 6, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Pipes removed easily, but the tunnel from 2025 is contaminated infrastructure requiring disposal as intermediate level waste.',
                    quote: "Pipes came out clean - the tunnel gave us easy access right to the end. But the tunnel itself? 60 years of contamination buildup. It's ILW now. Large volume, complex disposal. Full decon or grout and entomb?",
                    options: [
                        { id: 'full', name: 'Full tunnel decommissioning', desc: 'Decontaminate and demolish.', cost: 220000, time: 25, dose: 8 },
                        { id: 'fill', name: 'Grout fill and entombment', desc: 'Seal in place with grout.', cost: 150000, time: 15, dose: 4, healthImpact: -5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 6: MATERIAL SPEC
        // ==========================================
        materialSpec: {
            title: 'Material Specification',
            stage1: {
                description: 'What material for primary circuit pipework?',
                options: [
                    { id: 'standard', name: 'Standard Stainless Steel', desc: '304/316 with ~2,500ppm cobalt. Industry standard.', cost: 110000, quality: 'poor' },
                    { id: 'lowCobalt', name: 'Low-Cobalt Stainless', desc: 'Cobalt <500ppm. Reduced activation.', cost: 170000, quality: 'good' },
                    { id: 'exotic', name: 'Exotic Nickel Alloy', desc: 'Premium aerospace-grade alloy. Top specification.', cost: 250000, quality: 'poor' }
                ]
            },
            stage2: {
                standard: {
                    situation: 'Dose rates around the primary circuit are higher than predicted. The standard stainless steel from 2025 contains ~2,500ppm cobalt, which is activating under neutron flux.',
                    quote: "Dose rates are running hot. That standard stainless from 2025 - 2,500ppm cobalt content. It's activating and making every maintenance job take longer because of ALARP controls. How do you want to approach this outage?",
                    isModifier: true,
                    options: [
                        { id: 'accept', name: 'Accept higher dose rates', desc: 'Work with what we have. Jobs take longer.', cost: 0, time: 2, dose: 3 },
                        { id: 'shield', name: 'Install temporary shielding', desc: 'Reduce dose exposure for this outage.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                lowCobalt: {
                    situation: 'Dose rates as predicted in the design basis. The low-cobalt stainless from 2025 is performing as expected with minimal activation.',
                    quote: "Dose rates exactly where we predicted. That low-cobalt steel from 2025 - worth every penny. Work areas are clean, jobs go smoothly. Just confirming the maintenance approach.",
                    options: [
                        { id: 'standard', name: 'Standard maintenance procedures', desc: 'Normal approach - no special measures needed.', cost: 0, time: 0, dose: 0.5 },
                        { id: 'optimise', name: 'Optimise future dose budgets', desc: 'Bank the dose savings for contingencies.', cost: 5000, time: 0, dose: 0.5 }
                    ]
                },
                exotic: {
                    situation: 'Dose rates significantly higher than predicted. The exotic nickel alloy from 2025 contains Nickel-59 which is creating unexpected activation products.',
                    quote: "Big problem. That exotic alloy from 2025 - it looked great on paper, but the nickel content is activating badly. Dose rates are twice what we planned for. Every job is a challenge. What's the strategy?",
                    isModifier: true,
                    options: [
                        { id: 'accept', name: 'Accept enhanced dose controls', desc: 'More restrictions, slower work, higher doses.', cost: 0, time: 4, dose: 5 },
                        { id: 'remote', name: 'Invest in remote tooling', desc: 'Reduce direct worker exposure.', cost: 40000, time: 5, dose: 3 }
                    ]
                }
            },
            stage3: {
                standard: {
                    situation: 'Elevated dose rates require stand-off inspection techniques. The activated standard steel from 2025 limits close-approach work.',
                    quote: "Inspection time, but that standard steel from 2025 is running hot. I need to keep my distance, which limits probe positioning. Extended reach equipment or accept the limitations?",
                    isModifier: true,
                    options: [
                        { id: 'standoff', name: 'Extended reach inspection', desc: 'Longer probe extensions, some accuracy loss.', cost: 15000, time: 3, dose: 4 },
                        { id: 'shielded', name: 'Invest in shielded inspection equipment', desc: 'Better equipment for close-approach work.', cost: 35000, time: 4, dose: 2 }
                    ]
                },
                lowCobalt: {
                    situation: 'Manageable dose rates allow standard inspection approaches. The low-cobalt specification from 2025 continues to pay dividends.',
                    quote: "Inspection programme running smoothly. That low-cobalt steel from 2025 - dose rates are low enough for normal close-approach work. No special equipment needed. Standard or enhanced baseline?",
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Normal techniques, full coverage.', cost: 10000, time: 2, dose: 1 },
                        { id: 'baseline', name: 'Establish detailed baseline', desc: 'Extra measurements for future reference.', cost: 18000, time: 3, dose: 1.5 }
                    ]
                },
                exotic: {
                    situation: 'Very high dose rates make inspection extremely challenging. The exotic alloy from 2025 requires specialist contractors with high-dose experience.',
                    quote: "That exotic alloy from 2025 - it's so hot now our regular teams can't get near it safely. We need specialists who handle high-dose work. Or we accept limited inspection coverage.",
                    isModifier: true,
                    options: [
                        { id: 'specialist', name: 'Hire specialist high-dose contractor', desc: 'Experts with special shielding and experience.', cost: 50000, time: 5, dose: 3 },
                        { id: 'limited', name: 'Accept limited inspection coverage', desc: 'Do what we can safely. Document gaps.', cost: 20000, time: 3, dose: 4, healthImpact: -5 }
                    ]
                }
            },
            stage4: {
                standard: {
                    situation: 'Cumulative workforce dose approaching annual limits. The activated standard steel from 2025 constrains operational flexibility.',
                    quote: "We're running into dose limit problems. That standard steel from 2025 - 45 years of activation means we're burning through dose budget fast. Need to bring in more workers or slow down.",
                    options: [
                        { id: 'contractors', name: 'Bring in additional contractors', desc: 'More workers to share the dose burden.', cost: 80000, time: 0, dose: 0 },
                        { id: 'shielding', name: 'Install permanent shielding', desc: 'Long-term dose reduction investment.', cost: 50000, time: 5, dose: 0 },
                        { id: 'slow', name: 'Accept schedule extension', desc: 'Work slower to spread dose over time.', cost: 20000, time: 10, dose: 0 }
                    ]
                },
                lowCobalt: {
                    situation: 'Dose rates remain low. Full operational flexibility maintained thanks to the low-cobalt specification from 2025.',
                    quote: "Dose budgets looking healthy. That low-cobalt decision in 2025 gives us complete flexibility - no constraints on work planning, no limit problems. How do you want to manage the surplus?",
                    options: [
                        { id: 'maintain', name: 'Standard operations', desc: 'Continue normal working.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'bank', name: 'Bank dose margin for contingencies', desc: 'Reserve capacity for unexpected work.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                exotic: {
                    situation: 'Severe dose constraints limit work. The exotic alloy from 2025 has created extreme activation levels after 45 years.',
                    quote: "We can barely get near the primary circuit. That exotic alloy from 2025 - after 45 years of activation, work windows are measured in minutes. Major operational constraints. How do we manage this?",
                    options: [
                        { id: 'contractors', name: 'Rotating contractor teams', desc: 'Many workers, very short exposures each.', cost: 120000, time: 5, dose: 0 },
                        { id: 'remote', name: 'Remote operations only', desc: 'No direct human access to affected areas.', cost: 80000, time: 8, dose: 0 },
                        { id: 'restrict', name: 'Severely restrict operations', desc: 'Accept major operational limitations.', cost: 30000, time: 0, dose: 0, healthImpact: -10 }
                    ]
                }
            },
            stage5: {
                standard: {
                    situation: 'After the 5-year decay period, components with standard steel remain highly active. Remote handling required for most work.',
                    quote: "Five years of decay storage and that standard steel from 2025 is still too hot for hands-on work. 2,500ppm cobalt means decades more before it cools. Remote handling for everything. In-house or specialist?",
                    options: [
                        { id: 'remote', name: 'In-house remote handling', desc: 'Our teams with manipulators. Learning curve.', cost: 120000, time: 18, dose: 6, risk: 30 },
                        { id: 'specialist', name: 'Specialist remote handling contractor', desc: 'Experienced operators, proven techniques.', cost: 200000, time: 12, dose: 2 }
                    ]
                },
                lowCobalt: {
                    situation: 'After 5-year decay, the low-cobalt materials from 2025 allow hands-on work with standard PPE. Some components may qualify as LLW.',
                    quote: "Five years decay and that low-cobalt steel from 2025 is cool enough for hands-on work. Some of it might even go as low-level waste instead of ILW. This is exactly what we hoped for.",
                    options: [
                        { id: 'handson', name: 'Hands-on removal and segregation', desc: 'Direct handling with standard PPE.', cost: 60000, time: 8, dose: 2 },
                        { id: 'segregate', name: 'Detailed segregation for waste minimisation', desc: 'Maximum effort to classify materials correctly.', cost: 80000, time: 10, dose: 2.5 }
                    ]
                },
                exotic: {
                    situation: 'The exotic nickel alloy from 2025 contains Nickel-63 with a 100-year half-life. These components will remain highly active for centuries.',
                    quote: "That exotic alloy from 2025 - Nickel-63 has a hundred-year half-life. Five years of decay makes no difference. This stuff will be active long after everyone here is dead. Long-term storage or extreme remote handling?",
                    options: [
                        { id: 'extended', name: 'Extended remote decommissioning', desc: 'Very slow, very careful, very expensive.', cost: 250000, time: 30, dose: 15 },
                        { id: 'storage', name: 'Long-term interim storage', desc: 'Store for decades. Wait for decay. Pass to future.', cost: 200000, time: 10, dose: 3 },
                        { id: 'specialist', name: 'Specialist handling plus storage', desc: 'Expert removal then long-term storage.', cost: 300000, time: 20, dose: 5 }
                    ]
                }
            }
        }
    }
};

// ============================================
// GAME STATE
// ============================================
const STATE = {
    stage: 1,
    designChoices: {},     // Stage 1 choices
    stageChoices: {},      // Choices per stage per element
    completed: {},         // Elements completed per stage
    triggers: {},          // Active triggers
    flags: {},             // Boolean flags
    totals: { cost: 0, dose: 0, time: 0 },
    stageTotals: {},
    plantHealth: 100,
    injuries: 0,
    // Element-specific state for compounding consequences
    elementState: {
        pumpAccess: {
            accessFixed: false,
            workaroundUsed: false,
            inspectionGap: false,
            deteriorating: false
        },
        weldClearance: {},
        controlPanel: {},
        pipeConnections: {},
        pipeRouting: {},
        materialSpec: {}
    }
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatMoney(n) { return '£' + n.toLocaleString(); }

function getRemainingBudget() {
    // Only used for Stage 1
    const stage = GAME_DATA.stages[STATE.stage];
    return stage.budget - STATE.totals.cost;
}

// ============================================
// INTRO
// ============================================
let currentSlide = 1;
const totalSlides = 4;

function updateIntroSlide() {
    document.querySelectorAll('.intro-slide').forEach(s => s.classList.remove('active'));
    document.querySelector(`.intro-slide[data-slide="${currentSlide}"]`).classList.add('active');
    document.querySelectorAll('.intro-dot').forEach((d, i) => {
        d.classList.remove('active', 'done');
        if (i + 1 === currentSlide) d.classList.add('active');
        else if (i + 1 < currentSlide) d.classList.add('done');
    });
    document.getElementById('btnIntroNext').textContent = currentSlide === totalSlides ? 'Begin →' : 'Continue →';
}

document.getElementById('btnIntroNext').onclick = () => {
    if (currentSlide < totalSlides) { currentSlide++; updateIntroSlide(); }
    else endIntro();
};
document.getElementById('btnSkip').onclick = endIntro;
document.querySelectorAll('.intro-dot').forEach(d => {
    d.onclick = () => { currentSlide = parseInt(d.dataset.dot); updateIntroSlide(); };
});

function endIntro() {
    document.getElementById('cinematicIntro').classList.add('hidden');
    document.getElementById('gameScreen').classList.add('active');
    startStage(1);
}

// ============================================
// STAGE MANAGEMENT
// ============================================
function startStage(stageNum) {
    STATE.stage = stageNum;
    STATE.completed[stageNum] = {};
    STATE.stageTotals[stageNum] = { cost: 0, dose: 0, time: 0 };
    
    const stage = GAME_DATA.stages[stageNum];
    
    // Update timeline
    updateTimeline(stageNum);
    
    updateStatsDisplay();
    
    // Character banner
    const banner = document.getElementById('characterBanner');
    if (stageNum > 1 && stage.char) {
        const char = GAME_DATA.characters[stage.char];
        banner.className = `character-banner visible ${stage.char}`;
        document.getElementById('charPortrait').textContent = char.emoji;
        document.getElementById('charName').textContent = char.name;
        document.getElementById('charRole').textContent = char.role;
    } else {
        banner.classList.remove('visible');
    }
    
    // Reset hotspots
    document.querySelectorAll('.hotspot-dot').forEach(d => {
        d.classList.remove('done');
    });
    
    document.getElementById('btnNextStage').classList.remove('visible');
    
    updateProgressLabel();
}

function updateTimeline(currentStage) {
    document.querySelectorAll('.timeline-stage').forEach(stage => {
        const stageNum = parseInt(stage.dataset.stage);
        stage.classList.remove('completed', 'current', 'future');
        
        if (stageNum < currentStage) {
            stage.classList.add('completed');
        } else if (stageNum === currentStage) {
            stage.classList.add('current');
        } else {
            stage.classList.add('future');
        }
    });
    
    // Update progress bar (0% at stage 1, 100% at stage 5)
    const progressPercent = ((currentStage - 1) / 4) * 100;
    document.getElementById('timelineProgress').style.width = `${progressPercent}%`;
}

function updateStatsDisplay() {
    const stage = GAME_DATA.stages[STATE.stage];
    const remaining = getRemainingBudget();
    let html = '';
    
    if (STATE.stage === 1) {
        // Stage 1: Show remaining design budget
        const cls = remaining < 100000 ? (remaining < 0 ? 'danger' : 'warning') : '';
        html = `<div class="stat">💰 Design Budget: <span class="stat-value ${cls}">${formatMoney(remaining)}</span></div>`;
    } else {
        // Stages 2-5: Show accumulated costs
        const st = STATE.stageTotals[STATE.stage] || { cost: 0, dose: 0, time: 0 };
        html = `
            <div class="stat">💰 Cost: <span class="stat-value" style="color: var(--blue);">${formatMoney(st.cost)}</span></div>
            <div class="stat">☢️ <span class="stat-value">${st.dose.toFixed(1)} mSv</span></div>
            <div class="stat">⏱️ <span class="stat-value">${st.time} days</span></div>
            <div class="stat">❤️ <span class="stat-value ${STATE.plantHealth < 60 ? 'danger' : ''}">${STATE.plantHealth}%</span></div>
        `;
    }
    document.getElementById('topStats').innerHTML = html;
}

function updateProgressLabel() {
    const done = Object.keys(STATE.completed[STATE.stage] || {}).length;
    document.getElementById('progressLabel').textContent = `${done} of 6 complete`;
    if (done === 6) {
        document.getElementById('btnNextStage').classList.add('visible');
    }
}

// ============================================
// HOTSPOT CLICKS
// ============================================
document.querySelectorAll('.hotspot').forEach(h => {
    h.onclick = () => {
        const elId = h.dataset.element;
        
        // In Stage 1, can always click (to change decision)
        // In Stages 2-5, can only click if not completed (decisions are final)
        if (STATE.stage > 1 && STATE.completed[STATE.stage]?.[elId]) {
            return; // Decision already made, can't change
        }
        
        openElementModal(elId);
    };
});

// ============================================
// MODAL SYSTEM
// ============================================
function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

document.getElementById('modalClose').onclick = closeModal;
document.getElementById('modalOverlay').onclick = (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
};

function openElementModal(elId) {
    const element = GAME_DATA.elements[elId];
    document.getElementById('modalTitle').textContent = element.title;
    
    if (STATE.stage === 1) {
        renderDesignModal(elId, element);
    } else {
        renderDecisionModal(elId, element);
    }
    
    openModal();
}

// ============================================
// STAGE 1: DESIGN
// ============================================
function renderDesignModal(elId, element) {
    const data = element.stage1;
    const remaining = getRemainingBudget();
    
    // Calculate what we'd have if we refund current choice
    let availableBudget = remaining;
    if (STATE.designChoices[elId]) {
        const currentChoice = data.options.find(o => o.id === STATE.designChoices[elId]);
        availableBudget += currentChoice.cost;
    }
    
    let html = '';
    
    // Context bar with budget
    html += `
        <div class="context-bar">
            <span class="context-design">📅 Year 2025 · Design Phase</span>
            <span class="context-cost">💰 Budget: ${formatMoney(availableBudget)}</span>
        </div>
    `;
    
    // Situation panel - the question
    html += `
        <div class="situation-panel">
            <div class="situation-label">Design Decision Required</div>
            <div class="situation-text">${data.description}</div>
        </div>
    `;
    
    // Decision section header
    html += `
        <div class="decision-section">
            <div class="decision-header">
                <span class="decision-label">Choose Your Approach</span>
                <div class="decision-line"></div>
            </div>
            <div class="design-cards-grid">
    `;
    
    data.options.forEach(opt => {
        const sel = STATE.designChoices[elId] === opt.id ? 'selected' : '';
        const affordable = opt.cost <= availableBudget;
        const disabledClass = affordable ? '' : 'disabled';
        
        html += `
            <div class="design-card ${sel} ${disabledClass}" data-id="${opt.id}" data-cost="${opt.cost}">
                <div class="design-card-image">[${opt.name}]</div>
                <div class="design-card-cost">${formatMoney(opt.cost)}</div>
                <div class="design-card-body">
                    <div class="design-card-name">${opt.name}</div>
                    <p class="design-card-desc">${opt.desc}</p>
                    ${!affordable ? '<div class="disabled-reason">⚠️ Insufficient budget</div>' : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = STATE.designChoices[elId] || null;
    document.querySelectorAll('.design-card:not(.disabled)').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.design-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    const hasExistingChoice = !!STATE.designChoices[elId];
    document.getElementById('modalFooter').innerHTML = `<button class="btn btn-primary" id="btnConfirm">${hasExistingChoice ? 'Update Selection' : 'Confirm Selection'}</button>`;
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        
        const opt = data.options.find(o => o.id === selected);
        
        // Refund old if changing
        if (STATE.designChoices[elId]) {
            const old = data.options.find(o => o.id === STATE.designChoices[elId]);
            STATE.totals.cost -= old.cost;
        }
        
        STATE.designChoices[elId] = selected;
        STATE.completed[1][elId] = true;
        STATE.totals.cost += opt.cost;
        
        document.querySelector(`[data-element="${elId}"] .hotspot-dot`).classList.add('done');
        
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}

// ============================================
// STAGES 2-5: DECISIONS (No budget, decisions are final)
// ============================================
function renderDecisionModal(elId, element) {
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    const stage = GAME_DATA.stages[STATE.stage];
    
    let stageData = element[stageKey]?.[designChoice];
    
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    
    // Handle element state-based scenarios (new compounding system)
    if (stageData.checkElementState && stageData.scenarios) {
        const elState = STATE.elementState[elId] || {};
        
        // Check states in priority order (most specific first)
        if (elState.deteriorating && stageData.scenarios.deteriorating) {
            stageData = stageData.scenarios.deteriorating;
        } else if (elState.emergencyOccurred && stageData.scenarios.emergencyOccurred) {
            stageData = stageData.scenarios.emergencyOccurred;
        } else if (elState.inspectionGap && stageData.scenarios.inspectionGap) {
            stageData = stageData.scenarios.inspectionGap;
        } else if (elState.accessFixed && stageData.scenarios.accessFixed) {
            stageData = stageData.scenarios.accessFixed;
        } else if (elState.workaroundUsed && stageData.scenarios.workaroundUsed) {
            stageData = stageData.scenarios.workaroundUsed;
        } else if (elState.airlockBypassed && stageData.scenarios.airlockBypassed) {
            stageData = stageData.scenarios.airlockBypassed;
        } else if (elState.airlockMaintained && stageData.scenarios.airlockMaintained) {
            stageData = stageData.scenarios.airlockMaintained;
        } else {
            stageData = stageData.scenarios.default || stageData.scenarios[Object.keys(stageData.scenarios)[0]];
        }
    }
    // Handle old trigger-based system (for backwards compatibility)
    else if (stageData.checkTrigger) {
        stageData = STATE.triggers[stageData.checkTrigger] ? stageData.triggered : stageData.notTriggered;
    } else if (stageData.checkFlag) {
        stageData = STATE.flags[stageData.checkFlag] ? stageData.hasFlag : stageData.noFlag;
    }
    
    const char = GAME_DATA.characters[stage.char];
    const stageCost = STATE.stageTotals[STATE.stage]?.cost || 0;
    
    let html = '';
    
    // Context bar - year, design choice, stage cost
    html += `
        <div class="context-bar">
            <span class="context-design">📅 Year ${stage.year} · 2025 Design: <strong>${designOpt.name}</strong></span>
            <span class="context-cost">💰 Stage Cost: ${formatMoney(stageCost)}</span>
        </div>
    `;
    
    // Situation panel - the main story
    html += `
        <div class="situation-panel">
            <div class="situation-label">Current Situation</div>
            <div class="situation-text">${stageData.situation}</div>
        </div>
    `;
    
    // Character speech bubble
    html += `
        <div class="speech-bubble">
            <div class="speech-portrait">${char.emoji}</div>
            <div class="speech-name">${char.name}, ${char.role}</div>
            <div class="speech-text">"${stageData.quote}"</div>
        </div>
    `;
    
    // Decision section
    const numOptions = stageData.options.length;
    const gridClass = numOptions === 2 ? 'two-options' : (numOptions === 3 ? 'three-options' : '');
    
    html += `
        <div class="decision-section">
            <div class="decision-header">
                <span class="decision-label">Your Decision</span>
                <div class="decision-line"></div>
            </div>
            <div class="options-list ${gridClass}">
    `;
    
    stageData.options.forEach(opt => {
        const cost = opt.cost || 0;
        const hasImpacts = opt.time || opt.dose || opt.healthImpact || opt.risk;
        
        html += `
            <div class="option-card" data-id="${opt.id}">
                <div class="option-cost-badge">${formatMoney(cost)}</div>
                <div class="option-content">
                    <div class="option-name">${opt.name}</div>
                    <div class="option-desc">${opt.desc}</div>
                </div>
                ${hasImpacts ? `
                <div class="option-impacts">
                    ${opt.time ? `<span class="impact negative">⏱️ +${opt.time}d</span>` : ''}
                    ${opt.dose ? `<span class="impact negative">☢️ +${opt.dose}mSv</span>` : ''}
                    ${opt.healthImpact ? `<span class="impact ${opt.healthImpact > 0 ? 'positive' : 'negative'}">❤️ ${opt.healthImpact > 0 ? '+' : ''}${opt.healthImpact}%</span>` : ''}
                    ${opt.risk ? `<span class="impact neutral">⚠️ ${opt.risk}%</span>` : ''}
                </div>
                ` : ''}
            </div>
        `;
    });
    
    html += '</div></div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = null;
    document.querySelectorAll('.option-card').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirm" disabled>Select an Option</button>';
    
    const observer = new MutationObserver(() => {
        const hasSelection = document.querySelector('.option-card.selected');
        const btn = document.getElementById('btnConfirm');
        if (btn) {
            btn.disabled = !hasSelection;
            btn.textContent = hasSelection ? 'Confirm Decision' : 'Select an Option';
        }
    });
    observer.observe(document.getElementById('modalBody'), { subtree: true, attributes: true, attributeFilter: ['class'] });
    
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        
        const opt = stageData.options.find(o => o.id === selected);
        
        // Handle risk
        if (opt.risk && Math.random() * 100 < opt.risk) {
            showFailure(elId, opt, stageData);
            return;
        }
        
        applyDecision(elId, opt, stageData, null);
    };
}

function showFailure(elId, opt, stageData) {
    const extraCost = opt.cost || 0;
    const extraDose = (opt.dose || 0) + 2;
    const extraTime = (opt.time || 0) + 5;
    
    let html = `
        <div class="failure-panel">
            <div class="failure-icon">⚠️</div>
            <div class="failure-title">Attempt Failed!</div>
            <div class="failure-text">The risky approach didn't work. The situation has gotten worse and you must deal with the consequences.</div>
        </div>
        <div class="failure-impacts">
            <div class="failure-impact">
                <span class="failure-impact-icon">💰</span>
                <span class="failure-impact-value">${formatMoney(extraCost + 50000)}</span>
                <span class="failure-impact-label">Emergency Costs</span>
            </div>
            <div class="failure-impact">
                <span class="failure-impact-icon">⏱️</span>
                <span class="failure-impact-value">+${extraTime} days</span>
                <span class="failure-impact-label">Delays</span>
            </div>
            <div class="failure-impact">
                <span class="failure-impact-icon">☢️</span>
                <span class="failure-impact-value">+${extraDose} mSv</span>
                <span class="failure-impact-label">Dose Uptake</span>
            </div>
            <div class="failure-impact">
                <span class="failure-impact-icon">❤️</span>
                <span class="failure-impact-value">-10%</span>
                <span class="failure-impact-label">Plant Health</span>
            </div>
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-danger" id="btnConfirm">Accept Consequences</button>';
    
    document.getElementById('btnConfirm').onclick = () => {
        // Apply failure costs
        STATE.stageTotals[STATE.stage].cost += extraCost + 50000;
        STATE.stageTotals[STATE.stage].dose += extraDose;
        STATE.stageTotals[STATE.stage].time += extraTime;
        STATE.totals.cost += extraCost + 50000;
        STATE.totals.dose += extraDose;
        STATE.totals.time += extraTime;
        STATE.plantHealth = Math.max(0, STATE.plantHealth - 10);
        
        // Apply failState if specified, otherwise use setState
        if (!STATE.elementState[elId]) STATE.elementState[elId] = {};
        const stateToApply = opt.failState || opt.setState || { failureOccurred: true };
        Object.keys(stateToApply).forEach(key => {
            STATE.elementState[elId][key] = stateToApply[key];
        });
        console.log(`Failure state for ${elId}:`, STATE.elementState[elId]);
        
        STATE.completed[STATE.stage][elId] = true;
        document.querySelector(`[data-element="${elId}"] .hotspot-dot`).classList.add('done');
        
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}

function applyDecision(elId, opt, stageData, previousChoice = null) {
    const cost = opt.cost || 0;
    const dose = opt.dose || 0;
    const time = opt.time || 0;
    const healthImpact = opt.healthImpact || 0;
    
    // Additional costs from triggered scenarios (e.g., environmental cleanup)
    if (stageData.additionalCosts) {
        STATE.stageTotals[STATE.stage].cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        STATE.totals.cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        if (stageData.additionalCosts.healthImpact) {
            STATE.plantHealth = Math.max(0, STATE.plantHealth + stageData.additionalCosts.healthImpact);
        }
    }
    
    STATE.stageTotals[STATE.stage].cost += cost;
    STATE.stageTotals[STATE.stage].dose += dose;
    STATE.stageTotals[STATE.stage].time += time;
    STATE.totals.cost += cost;
    STATE.totals.dose += dose;
    STATE.totals.time += time;
    
    if (healthImpact) {
        STATE.plantHealth = Math.max(0, Math.min(100, STATE.plantHealth + healthImpact));
    }
    
    // Handle old trigger/flag system
    if (opt.trigger) STATE.triggers[opt.trigger] = true;
    if (opt.setFlag) STATE.flags[opt.setFlag] = true;
    
    // Handle new element state system for compounding consequences
    if (opt.setState) {
        if (!STATE.elementState[elId]) STATE.elementState[elId] = {};
        Object.keys(opt.setState).forEach(key => {
            STATE.elementState[elId][key] = opt.setState[key];
        });
        console.log(`State updated for ${elId}:`, STATE.elementState[elId]);
    }
    
    STATE.completed[STATE.stage][elId] = true;
    STATE.stageChoices[`${STATE.stage}_${elId}`] = opt.id;
    
    // Mark hotspot as done
    const dot = document.querySelector(`[data-element="${elId}"] .hotspot-dot`);
    dot.classList.add('done');
    
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}

// ============================================
// STAGE COMPLETION
// ============================================
document.getElementById('btnNextStage').onclick = showStageSummary;

// Insights for each stage
const STAGE_INSIGHTS = {
    1: "Your design is now locked in. Over the next 60 years, every maintenance worker, inspector, and operator will work with the consequences of today's decisions. <strong>Construction is cheap compared to retrofitting.</strong>",
    2: "First major outage complete. Did your design make this easier or harder? <strong>Access constraints compound over time</strong> - every workaround creates the next problem.",
    3: "Regulators now have decades of data. Inspection gaps become safety case issues. <strong>If you can't inspect it, you can't prove it's safe.</strong>",
    4: "45 years of operation tests every design decision. Control room layout matters when alarms are screaming at 3am. <strong>Good design becomes invisible; bad design becomes crisis.</strong>",
    5: "Decommissioning reveals the true lifecycle cost. What seemed like savings in 2025 may have cost millions more across 60 years. <strong>The plant's final lesson is written in the total cost.</strong>"
};

function showStageSummary() {
    const stage = GAME_DATA.stages[STATE.stage];
    const st = STATE.stageTotals[STATE.stage];
    
    document.getElementById('sumTitle').textContent = `${stage.name}`;
    document.getElementById('sumSubtitle').textContent = `Year ${stage.year} Complete`;
    
    let statsHtml = '';
    if (STATE.stage === 1) {
        const spent = STATE.totals.cost;
        const over = spent > stage.budget;
        const remaining = stage.budget - spent;
        statsHtml = `
            <div class="summary-stat">
                <div class="summary-stat-icon">💰</div>
                <div class="summary-stat-value">${formatMoney(spent)}</div>
                <div class="summary-stat-label">Design Cost</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">📊</div>
                <div class="summary-stat-value">${formatMoney(stage.budget)}</div>
                <div class="summary-stat-label">Budget</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">${over ? '⚠️' : '✅'}</div>
                <div class="summary-stat-value ${over ? 'over' : 'good'}">${formatMoney(Math.abs(remaining))}</div>
                <div class="summary-stat-label">${over ? 'Over Budget' : 'Remaining'}</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">❤️</div>
                <div class="summary-stat-value">${STATE.plantHealth}%</div>
                <div class="summary-stat-label">Plant Health</div>
            </div>
        `;
    } else {
        statsHtml = `
            <div class="summary-stat">
                <div class="summary-stat-icon">💰</div>
                <div class="summary-stat-value">${formatMoney(st.cost)}</div>
                <div class="summary-stat-label">Stage Cost</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">☢️</div>
                <div class="summary-stat-value">${st.dose.toFixed(1)} mSv</div>
                <div class="summary-stat-label">Dose</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">⏱️</div>
                <div class="summary-stat-value">${st.time} days</div>
                <div class="summary-stat-label">Time</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">❤️</div>
                <div class="summary-stat-value">${STATE.plantHealth}%</div>
                <div class="summary-stat-label">Plant Health</div>
            </div>
        `;
    }
    document.getElementById('sumStats').innerHTML = statsHtml;
    
    // Decisions - show as grid cards
    let decHtml = '<div class="decisions-grid">';
    
    if (STATE.stage === 1) {
        // Stage 1: Show design choices
        Object.keys(GAME_DATA.elements).forEach(elId => {
            const el = GAME_DATA.elements[elId];
            const choice = STATE.designChoices[elId];
            const opt = el.stage1.options.find(o => o.id === choice);
            decHtml += `
                <div class="decision-card this-stage">
                    <div>
                        <div class="decision-element">${el.title}</div>
                        <div class="decision-choice">${opt.name}</div>
                    </div>
                    <div class="decision-cost">${formatMoney(opt.cost)}</div>
                </div>
            `;
        });
    } else {
        // Stages 2-5: Show this stage's decisions
        Object.keys(GAME_DATA.elements).forEach(elId => {
            const el = GAME_DATA.elements[elId];
            const choiceId = STATE.stageChoices[`${STATE.stage}_${elId}`];
            const designChoice = STATE.designChoices[elId];
            
            if (choiceId) {
                // Find the option that was chosen
                const stageData = el[`stage${STATE.stage}`];
                let chosenOption = null;
                let optionCost = 0;
                
                if (stageData && stageData[designChoice]) {
                    let sd = stageData[designChoice];
                    
                    if (sd.scenarios) {
                        Object.values(sd.scenarios).forEach(scenario => {
                            if (scenario.options) {
                                const found = scenario.options.find(o => o.id === choiceId);
                                if (found) chosenOption = found;
                            }
                        });
                    } else if (sd.options) {
                        chosenOption = sd.options.find(o => o.id === choiceId);
                    } else if (sd.triggered || sd.notTriggered) {
                        const opts = [...(sd.triggered?.options || []), ...(sd.notTriggered?.options || [])];
                        chosenOption = opts.find(o => o.id === choiceId);
                    }
                }
                
                if (chosenOption) {
                    decHtml += `
                        <div class="decision-card this-stage">
                            <div>
                                <div class="decision-element">${el.title}</div>
                                <div class="decision-choice">${chosenOption.name}</div>
                            </div>
                            <div class="decision-cost">${formatMoney(chosenOption.cost || 0)}</div>
                        </div>
                    `;
                }
            }
        });
    }
    
    decHtml += '</div>';
    document.getElementById('sumDecisions').innerHTML = decHtml;
    
    // Insight for this stage
    document.getElementById('insightText').innerHTML = STAGE_INSIGHTS[STATE.stage];
    
    // Button text
    if (STATE.stage >= 5) {
        document.getElementById('btnNextPhase').textContent = 'View Final Report →';
    } else {
        document.getElementById('btnNextPhase').textContent = 'Continue →';
    }
    
    document.getElementById('summaryScreen').classList.add('active');
}

document.getElementById('btnNextPhase').onclick = () => {
    document.getElementById('summaryScreen').classList.remove('active');
    showStoryTransition();
};

function showStoryTransition() {
    const currentStage = STATE.stage;
    const story = GAME_DATA.storyTransitions[currentStage];
    
    // Header
    document.getElementById('storyYears').textContent = story.yearsLabel;
    document.getElementById('storyTitle').textContent = story.title;
    
    // Narrative paragraphs
    document.getElementById('storyNarrative').innerHTML = story.narrative.map(p => `<p>${p}</p>`).join('');
    
    // Lessons
    document.getElementById('storyLessons').innerHTML = '<ul>' + story.lessons.map(l => `<li>${l}</li>`).join('') + '</ul>';
    
    // Regulatory references
    document.getElementById('storyRegulatory').innerHTML = story.regulatory.map(r => `
        <div class="reg-reference">
            <span class="reg-code">${r.code}</span>
            <span class="reg-text">${r.text}</span>
        </div>
    `).join('');
    
    // Foreshadow
    document.getElementById('storyForeshadow').innerHTML = story.foreshadow;
    
    // Button text
    if (currentStage >= 5) {
        document.getElementById('btnStoryNext').textContent = 'View Final Results →';
    } else {
        const nextStage = GAME_DATA.stages[currentStage + 1];
        document.getElementById('btnStoryNext').textContent = `Begin ${nextStage.year}: ${nextStage.name} →`;
    }
    
    document.getElementById('storyTransition').classList.add('visible');
}

document.getElementById('btnStoryNext').onclick = () => {
    document.getElementById('storyTransition').classList.remove('visible');
    if (STATE.stage >= 5) {
        showFinalResults();
    } else {
        showTransition();
    }
};

function showTransition() {
    const nextStage = STATE.stage + 1;
    const trans = GAME_DATA.transitions[nextStage];
    
    document.getElementById('transYears').textContent = trans.years;
    document.getElementById('transYear').textContent = trans.year;
    document.getElementById('transVisual').innerHTML = `<span class="phase-visual-icon">${trans.icon}</span>`;
    document.getElementById('transPhaseName').textContent = trans.phaseName;
    document.getElementById('transText').innerHTML = trans.text.map(t => `<p class="phase-context-line">${t}</p>`).join('');
    document.getElementById('btnTransContinue').textContent = `Begin ${trans.phaseName} →`;
    
    document.getElementById('transitionScreen').classList.add('active');
}

document.getElementById('btnTransContinue').onclick = () => {
    document.getElementById('transitionScreen').classList.remove('active');
    startStage(STATE.stage + 1);
};

function showFinalResults() {
    // Calculate grades and totals
    let good = 0;
    let elementReports = [];
    
    // Optimal costs - if you made all good choices
    const OPTIMAL_COSTS = {
        pumpAccess: { design: 120000, lifecycle: 65000 },      // Open Bay + standard ops
        weldClearance: { design: 130000, lifecycle: 50000 },   // 600mm gaps + standard
        controlPanel: { design: 120000, lifecycle: 40000 },    // System-based + standard
        pipeConnections: { design: 100000, lifecycle: 45000 }, // Flanged + standard
        pipeRouting: { design: 100000, lifecycle: 50000 },     // Service tunnel + standard
        materialSpec: { design: 140000, lifecycle: 40000 }     // Duplex + standard
    };
    
    const ELEMENT_ICONS = {
        pumpAccess: '⚙️',
        weldClearance: '🔧',
        controlPanel: '🎛️',
        pipeConnections: '🔗',
        pipeRouting: '📐',
        materialSpec: '🧪'
    };
    
    const ELEMENT_LESSONS = {
        pumpAccess: {
            good: "The open bay design demonstrates the value of considering the full lifecycle. Spending £40k extra upfront saved hundreds of thousands in maintenance and gave certainty at every stage.",
            wasteful: "The dedicated room provided excellent access but the airlock complexity added cost at every maintenance intervention. Good access, excessive containment.",
            poor: "The corner position saved £40k in 2025 but created problems at every subsequent stage. Access constraints compound - each workaround creates the next problem."
        },
        weldClearance: {
            good: "600mm clearance allowed standard tooling throughout the lifecycle. Welds were accessible for inspection, repair, and eventual cutting during decommissioning.",
            wasteful: "800mm was more than needed. The extra space was never utilised and added unnecessary structural cost.",
            poor: "400mm seemed adequate on paper but real-world tooling needs more space. Restricted access meant specialists, adapters, and compromises at every intervention."
        },
        controlPanel: {
            good: "System-based grouping meant operators and maintainers could find what they needed quickly. Logical layout reduces human error and training time.",
            wasteful: "Separate rooms provided isolation but the walking distances and duplication added cost. Maintenance required covering more ground.",
            poor: "The crowded layout saved space initially but created a maze. Finding the right control during an incident is harder. Modifications require relocating existing equipment."
        },
        pipeConnections: {
            good: "Flanged connections at strategic points allowed sections to be isolated and removed without cutting. Faster maintenance, less dose, easier decommissioning.",
            wasteful: "Excessive flanges meant more potential leak points and more bolts to manage. Some connections never needed to be broken.",
            poor: "All-welded seemed simpler but every intervention required cutting and re-welding. More dose, more time, more cost throughout the lifecycle."
        },
        pipeRouting: {
            good: "The service tunnel provided walk-in access for all pipe maintenance. Inspectors and maintainers could work in comfort with good lighting and minimal dose.",
            wasteful: "The walk-in tunnel was oversized for the actual pipe runs. Construction cost was high for the access frequency needed.",
            poor: "The cable tray route saved construction cost but every pipe inspection required removing cable covers first. Two jobs became interlinked."
        },
        materialSpec: {
            good: "Duplex stainless provided the right balance of corrosion resistance and cost. It performed well throughout the lifecycle with predictable degradation.",
            wasteful: "Super duplex was overspecified for this application. The premium paid in 2025 never delivered additional value.",
            poor: "Standard stainless seemed adequate but corrosion appeared earlier than expected. Repairs and early replacements added up over 60 years."
        }
    };
    
    // Calculate per-element costs and build reports
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const designChoice = STATE.designChoices[elId];
        const designOpt = el.stage1.options.find(o => o.id === designChoice);
        
        if (designOpt.quality === 'good') good++;
        
        // Calculate this element's total cost across all stages
        let elementCost = designOpt.cost;
        for (let s = 2; s <= 5; s++) {
            const choiceId = STATE.stageChoices[`${s}_${elId}`];
            if (choiceId) {
                // Find the option cost - need to navigate the data structure
                const stageData = el[`stage${s}`];
                if (stageData) {
                    let options;
                    if (stageData[designChoice]) {
                        let sd = stageData[designChoice];
                        // Handle state-based scenarios
                        if (sd.scenarios) {
                            // Just get cost from stored choice
                            const flatOptions = Object.values(sd.scenarios).flatMap(s => s.options || []);
                            const opt = flatOptions.find(o => o.id === choiceId);
                            if (opt) elementCost += opt.cost || 0;
                        } else if (sd.options) {
                            const opt = sd.options.find(o => o.id === choiceId);
                            if (opt) elementCost += opt.cost || 0;
                        } else if (sd.triggered || sd.notTriggered) {
                            const opts = [...(sd.triggered?.options || []), ...(sd.notTriggered?.options || [])];
                            const opt = opts.find(o => o.id === choiceId);
                            if (opt) elementCost += opt.cost || 0;
                        }
                    }
                }
            }
        }
        
        const optimalCost = OPTIMAL_COSTS[elId].design + OPTIMAL_COSTS[elId].lifecycle;
        
        elementReports.push({
            id: elId,
            title: el.title,
            icon: ELEMENT_ICONS[elId],
            designChoice: designOpt.name,
            quality: designOpt.quality,
            totalCost: elementCost,
            optimalCost: optimalCost,
            lesson: ELEMENT_LESSONS[elId][designOpt.quality]
        });
    });
    
    // Calculate totals
    const totalOptimal = Object.values(OPTIMAL_COSTS).reduce((sum, el) => sum + el.design + el.lifecycle, 0);
    const costDiff = STATE.totals.cost - totalOptimal;
    
    // Determine grade
    let grade, verdict, gradeExplanation;
    if (good >= 5 && STATE.plantHealth >= 80 && STATE.totals.dose < 30) {
        grade = 'A'; 
        verdict = 'Master Designer';
        gradeExplanation = 'Your design choices considered the full 60-year lifecycle. Every stage benefited from your foresight.';
    } else if (good >= 4 && STATE.plantHealth >= 60) {
        grade = 'B'; 
        verdict = 'Competent Engineer';
        gradeExplanation = 'Most of your design choices served the plant well, though some areas caused unnecessary difficulty.';
    } else if (good >= 2 && STATE.plantHealth >= 40) {
        grade = 'C'; 
        verdict = 'Room for Improvement';
        gradeExplanation = 'Several design choices created problems that compounded over the decades. The plant operated, but at higher cost.';
    } else {
        grade = 'D'; 
        verdict = 'Lessons Learned';
        gradeExplanation = 'Your design created ongoing challenges throughout the plant\'s life. Future generations paid for initial savings.';
    }
    
    // Build the HTML
    let html = '';
    
    // Header with grade
    html += `
        <div class="report-header">
            <div class="results-grade ${grade}">${grade}</div>
            <h2 class="results-title">60 Years Complete</h2>
            <p class="results-verdict">${verdict} — ${gradeExplanation}</p>
        </div>
    `;
    
    // Cost comparison
    html += `
        <div class="report-comparison">
            <div class="comparison-box yours">
                <div class="comparison-label">Your Total Cost</div>
                <div class="comparison-value">${formatMoney(STATE.totals.cost)}</div>
                <div class="comparison-diff ${costDiff > 0 ? 'over' : 'under'}">
                    ${costDiff > 0 ? '+' : ''}${formatMoney(costDiff)} vs optimal
                </div>
            </div>
            <div class="comparison-vs">vs</div>
            <div class="comparison-box optimal">
                <div class="comparison-label">Optimal Path</div>
                <div class="comparison-value">${formatMoney(totalOptimal)}</div>
                <div class="comparison-diff">All good choices</div>
            </div>
        </div>
    `;
    
    // Element journeys
    html += `<div class="report-section-title">Your 60-Year Journey by Element</div>`;
    html += `<div class="element-journeys">`;
    
    elementReports.forEach(report => {
        const verdictText = report.quality === 'good' ? 'Good Design' : 
                           (report.quality === 'wasteful' ? 'Over-specified' : 'Problematic');
        
        html += `
            <div class="journey-card ${report.quality}" data-element="${report.id}">
                <div class="journey-header" onclick="toggleJourney('${report.id}')">
                    <div class="journey-title">
                        <span class="journey-icon">${report.icon}</span>
                        <div>
                            <div class="journey-name">${report.title}</div>
                            <div class="journey-design">2025 Design: ${report.designChoice}</div>
                        </div>
                    </div>
                    <div class="journey-right">
                        <div class="journey-cost">
                            <div class="journey-cost-value">${formatMoney(report.totalCost)}</div>
                            <div class="journey-cost-label">60-year cost</div>
                        </div>
                        <span class="journey-verdict ${report.quality}">${verdictText}</span>
                        <span class="journey-expand">▼</span>
                    </div>
                </div>
                <div class="journey-content">
                    <div class="journey-timeline">
                        ${buildTimelineHTML(report.id)}
                    </div>
                    <div class="journey-lesson">
                        <div class="lesson-label">Key Lesson</div>
                        <div class="lesson-text">${report.lesson}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    
    // Key takeaways
    html += `<div class="report-section-title">Key Takeaways</div>`;
    html += `<div class="takeaways">`;
    
    const takeaways = [
        { icon: '💡', text: `<strong>Design decisions echo for decades.</strong> What seems like a small saving in 2025 can multiply into major costs across maintenance, inspection, operations, and decommissioning.` },
        { icon: '🔄', text: `<strong>Access drives everything.</strong> If you can't reach it, you can't inspect it. If you can't inspect it, you can't prove it's safe. If you can't prove it's safe, the regulator won't let you operate.` },
        { icon: '📊', text: `<strong>The cheapest option is rarely the best.</strong> But the most expensive isn't either. The "good" choice balances initial cost against 60 years of consequences.` },
        { icon: '⚠️', text: `<strong>Problems compound.</strong> A workaround in 2040 becomes a constraint in 2055 becomes a crisis in 2070. Each deferred fix makes the next intervention harder.` }
    ];
    
    takeaways.forEach(t => {
        html += `
            <div class="takeaway-item">
                <span class="takeaway-icon">${t.icon}</span>
                <span class="takeaway-text">${t.text}</span>
            </div>
        `;
    });
    
    html += `</div>`;
    
    document.getElementById('finalReportContent').innerHTML = html;
    document.getElementById('resultsScreen').classList.add('active');
}

function buildTimelineHTML(elId) {
    const el = GAME_DATA.elements[elId];
    const designChoice = STATE.designChoices[elId];
    const designOpt = el.stage1.options.find(o => o.id === designChoice);
    
    let html = '';
    
    // Stage 1 - Design
    html += `
        <div class="timeline-stage">
            <div class="timeline-year">
                <div class="timeline-year-num">2025</div>
                <div class="timeline-year-phase">Design</div>
            </div>
            <div class="timeline-event">
                <div class="timeline-decision">${designOpt.name}</div>
                <div class="timeline-consequence">${designOpt.desc}</div>
            </div>
            <div class="timeline-cost">${formatMoney(designOpt.cost)}</div>
        </div>
    `;
    
    // Stages 2-5
    const stageInfo = [
        { num: 2, year: 2040, phase: 'Maintenance' },
        { num: 3, year: 2055, phase: 'Inspection' },
        { num: 4, year: 2070, phase: 'Operations' },
        { num: 5, year: 2085, phase: 'Decommission' }
    ];
    
    stageInfo.forEach(stage => {
        const choiceId = STATE.stageChoices[`${stage.num}_${elId}`];
        if (choiceId) {
            const stageData = el[`stage${stage.num}`];
            if (stageData && stageData[designChoice]) {
                let sd = stageData[designChoice];
                let chosenOption = null;
                let situation = '';
                
                // Navigate the data structure to find the chosen option
                if (sd.scenarios) {
                    Object.values(sd.scenarios).forEach(scenario => {
                        if (scenario.options) {
                            const found = scenario.options.find(o => o.id === choiceId);
                            if (found) {
                                chosenOption = found;
                                situation = scenario.situation || '';
                            }
                        }
                    });
                } else if (sd.options) {
                    chosenOption = sd.options.find(o => o.id === choiceId);
                    situation = sd.situation || '';
                } else if (sd.triggered || sd.notTriggered) {
                    const triggeredOpt = sd.triggered?.options?.find(o => o.id === choiceId);
                    const notTriggeredOpt = sd.notTriggered?.options?.find(o => o.id === choiceId);
                    chosenOption = triggeredOpt || notTriggeredOpt;
                    situation = triggeredOpt ? sd.triggered.situation : sd.notTriggered?.situation || '';
                }
                
                if (chosenOption) {
                    // Create a brief consequence description
                    let consequence = chosenOption.desc;
                    if (consequence.length > 100) {
                        consequence = consequence.substring(0, 100) + '...';
                    }
                    
                    html += `
                        <div class="timeline-stage">
                            <div class="timeline-year">
                                <div class="timeline-year-num">${stage.year}</div>
                                <div class="timeline-year-phase">${stage.phase}</div>
                            </div>
                            <div class="timeline-event">
                                <div class="timeline-decision">${chosenOption.name}</div>
                                <div class="timeline-consequence">${consequence}</div>
                            </div>
                            <div class="timeline-cost">${formatMoney(chosenOption.cost || 0)}</div>
                        </div>
                    `;
                }
            }
        }
    });
    
    return html;
}

function toggleJourney(elId) {
    const card = document.querySelector(`.journey-card[data-element="${elId}"]`);
    card.classList.toggle('expanded');
}
</script>
</body>
</html>
