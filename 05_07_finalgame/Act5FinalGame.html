<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 60-Year Journey</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --white: #f7f8fa;
            --light-grey: #d0d9e0;
            --mid-grey: #9babc2;
            --slate: #4a5d6b;
            --dark-slate: #364451;
            --deep-navy: #1f2937;
            --green: #92d050;
            --blue: #00b0f0;
            --orange: #cc5500;
            --red: #dc2626;
            --amber: #f59e0b;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--deep-navy);
            color: var(--light-grey);
        }
        /* Version tag */
        .version-tag {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: var(--mid-grey);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 9999;
        }
        /* ============================================
           CINEMATIC INTRO
           ============================================ */
        #cinematicIntro {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #000;
        }
        #cinematicIntro.hidden { display: none; }
        .intro-slide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        .intro-slide.active { opacity: 1; }
        .intro-slide .bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: brightness(0.35);
        }
        .intro-slide .bg.dark {
            background: linear-gradient(135deg, #0a1628, #1a2a3a, #0d1a2d);
            filter: none;
        }
        .intro-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 700px;
            padding: 40px;
        }
        .intro-logo img { max-width: 250px; margin-bottom: 30px; }
        .intro-company { color: var(--blue); text-transform: uppercase; letter-spacing: 4px; margin-bottom: 20px; }
        .intro-title { font-size: 3rem; color: var(--white); margin-bottom: 20px; }
        .intro-subtitle { font-size: 1.2rem; color: var(--light-grey); }
        /* Enhanced intro - lifecycle phases */
        .intro-phases {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 30px 0 20px;
            flex-wrap: wrap;
        }
        .intro-phase {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--mid-grey);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .intro-phase-icon {
            font-size: 1rem;
        }
        .intro-phase-connector {
            color: var(--slate);
            font-size: 0.8rem;
        }
        .intro-tagline {
            font-size: 1.1rem;
            color: var(--light-grey);
            margin-top: 10px;
            font-style: italic;
        }
        .intro-tagline strong {
            color: var(--amber);
            font-style: normal;
        }
        /* Animated timeline preview */
        .intro-timeline-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin: 25px 0 15px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .intro-timeline-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: var(--dark-slate);
            border: 2px solid var(--slate);
            transition: all 0.3s ease;
        }
        .intro-timeline-node.active {
            border-color: var(--blue);
            background: rgba(0, 176, 240, 0.15);
            animation: nodePulse 2s ease-in-out infinite;
        }
        @keyframes nodePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(0, 176, 240, 0); }
        }
        .intro-timeline-line {
            width: 30px;
            height: 2px;
            background: var(--slate);
        }
        .intro-timeline-label {
            font-size: 0.65rem;
            color: var(--mid-grey);
            margin-top: 6px;
            text-align: center;
        }
        .intro-timeline-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .intro-stakes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .intro-stake {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .intro-stake-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        .intro-stake-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mid-grey);
            margin-bottom: 4px;
        }
        .intro-stake-value {
            font-size: 1rem;
            color: var(--white);
            font-weight: 600;
        }
        .intro-text-box {
            background: rgba(31, 41, 55, 0.9);
            border-left: 4px solid var(--blue);
            padding: 30px;
            text-align: left;
            border-radius: 8px;
        }
        .intro-text-box p { margin-bottom: 15px; font-size: 1.1rem; line-height: 1.7; }
        .intro-text-box p:last-child { margin-bottom: 0; }
        .intro-text-box strong { color: var(--white); }
        .intro-text-box .highlight { color: var(--green); }
        .intro-year { font-size: 4rem; color: var(--blue); margin-bottom: 20px; }
        .intro-location { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        .intro-budget {
            display: inline-block;
            background: var(--green);
            color: var(--deep-navy);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 20px;
        }
        .intro-nav {
            position: absolute;
            bottom: 40px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }
        .intro-nav button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .intro-nav .btn-skip { background: transparent; color: var(--mid-grey); border: 1px solid var(--slate); }
        .intro-nav .btn-next { background: var(--blue); color: var(--deep-navy); }
        .intro-dots {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .intro-dot {
            width: 40px;
            height: 4px;
            background: var(--slate);
            border-radius: 2px;
            cursor: pointer;
        }
        .intro-dot.active { background: var(--blue); }
        .intro-dot.done { background: var(--green); }
        /* ============================================
           GAME LAYOUT
           ============================================ */
        #gameScreen {
            display: none;
            position: fixed;
            inset: 0;
            flex-direction: column;
        }
        #gameScreen.active { display: flex; }
        .top-bar {
            height: auto;
            background: var(--deep-navy);
            border-bottom: 1px solid var(--dark-slate);
            display: flex;
            flex-direction: column;
            padding: 10px 20px 0 20px;
            flex-shrink: 0;
        }
        .top-bar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .top-bar-logo img { height: 32px; }
        .top-bar-stats { display: flex; gap: 20px; font-size: 0.85rem; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .stat-value { color: var(--white); font-weight: 600; }
        .stat-value.warning { color: var(--amber); }
        .stat-value.danger { color: var(--red); }
        /* Timeline */
        .timeline-container {
            position: relative;
            padding: 0 40px 20px 40px;
        }
        .timeline-track {
            position: absolute;
            top: 24px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--slate);
            border-radius: 2px;
        }
        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--blue));
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        .timeline-stages {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }
        .timeline-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        .timeline-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--dark-slate);
            border: 3px solid var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: all 0.3s ease;
            position: relative;
        }
        .timeline-stage.completed .timeline-node {
            background: var(--green);
            border-color: var(--green);
            color: var(--deep-navy);
        }
        .timeline-stage.completed .timeline-node::after {
            content: '✓';
            position: absolute;
            font-size: 1.2rem;
        }
        .timeline-stage.current .timeline-node {
            background: var(--blue);
            border-color: var(--blue);
            color: var(--deep-navy);
            box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3);
            animation: currentPulse 2s infinite;
        }
        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0.1); }
        }
        .timeline-stage.future .timeline-node {
            background: var(--dark-slate);
            border-color: var(--slate);
            color: var(--slate);
        }
        .timeline-label {
            margin-top: 8px;
            text-align: center;
        }
        .timeline-year {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: color 0.3s;
        }
        .timeline-stage.completed .timeline-year,
        .timeline-stage.current .timeline-year {
            color: var(--white);
        }
        .timeline-name {
            font-size: 0.7rem;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            transition: color 0.3s;
        }
        .timeline-stage.current .timeline-name {
            color: var(--blue);
        }
        .timeline-stage.completed .timeline-name {
            color: var(--green);
        }
        .btn-next-stage {
            display: none;
            padding: 8px 16px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        .btn-next-stage.visible { display: block; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(146, 208, 80, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(146, 208, 80, 0); }
        }
        .character-banner {
            display: none;
            align-items: center;
            gap: 15px;
            background: var(--dark-slate);
            padding: 12px 20px;
            border-left: 4px solid var(--orange);
            flex-shrink: 0;
        }
        .character-banner.visible { display: flex; }
        .character-banner.dave { border-color: var(--orange); }
        .character-banner.sarah { border-color: var(--blue); }
        .character-banner.mike { border-color: var(--green); }
        .character-banner.janet { border-color: var(--mid-grey); }
        .char-portrait {
            width: 50px; height: 50px;
            border-radius: 8px;
            background: var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
        }
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; }
        .char-info h4 { color: var(--white); margin-bottom: 2px; }
        .char-role { font-size: 0.85rem; color: var(--mid-grey); }
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #1a1a2e;
        }
        .map-wrapper { position: relative; max-width: 100%; max-height: 100%; }
        .map-wrapper img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 250px);
            object-fit: contain;
        }
        .hotspot {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        .hotspot-square {
            width: 120px;
            height: 120px;
            background: rgba(0, 176, 240, 0.05);
            border: 2px dashed rgba(0, 176, 240, 0.4);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }
        .hotspot:hover .hotspot-square {
            background: rgba(0, 176, 240, 0.15);
            border-color: var(--blue);
            box-shadow: 0 0 25px rgba(0, 176, 240, 0.3);
            transform: scale(1.03);
        }
        .hotspot-square.selected {
            background: rgba(146, 208, 80, 0.1);
            border: 2px solid rgba(146, 208, 80, 0.6);
        }
        .hotspot-square.selected:hover {
            background: rgba(146, 208, 80, 0.15);
            border-color: var(--green);
            box-shadow: 0 0 25px rgba(146, 208, 80, 0.3);
        }
        .hotspot-square-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            text-align: center;
            padding: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        .hotspot-square.selected .hotspot-square-label {
            color: var(--green);
            font-weight: 600;
        }
        .hotspot-square img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0.9;
        }
        .hotspot-square.selected img + .hotspot-square-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: var(--green);
            padding: 4px;
            font-size: 0.65rem;
        }
        /* Completed state for Stage 2+ */
        .hotspot-square.done {
            background: rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.7);
        }
        .hotspot-square.done:hover {
            background: rgba(245, 158, 11, 0.25);
            border-color: var(--amber);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.3);
        }
        .hotspot-square.done .hotspot-square-label {
            color: var(--amber);
        }
        .hotspot-square.done::after {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 1rem;
            color: var(--amber);
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }
        @keyframes hotspotPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0); }
        }
        .bottom-bar {
            height: 40px;
            background: var(--deep-navy);
            border-top: 1px solid var(--dark-slate);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .progress-label { color: var(--mid-grey); font-size: 0.85rem; }
        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: linear-gradient(180deg, #1a2634 0%, #0d1b2a 100%);
            border-radius: 16px;
            width: 100%;
            max-width: 750px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        /* Modal Header - Component Name prominent */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 16px 24px;
            border-bottom: none;
        }
        .modal-header h3 { 
            color: var(--white); 
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header h3::before {
            content: '⚙️';
            font-size: 1.3rem;
        }
        .modal-close {
            background: var(--slate);
            border: none;
            color: var(--mid-grey);
            font-size: 1.2rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: var(--red);
            color: var(--white);
        }
        .modal-body { padding: 0 24px 24px 24px; }
        /* Context Bar - Design recall + Stage cost */
        .context-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--deep-navy);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }
        .context-design {
            color: var(--mid-grey);
        }
        .context-design strong {
            color: var(--amber);
            font-weight: 600;
        }
        .context-cost {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--blue);
            font-weight: 600;
        }
        /* Situation Panel - The main story */
        .situation-panel {
            background: linear-gradient(135deg, rgba(0, 176, 240, 0.1) 0%, rgba(0, 176, 240, 0.05) 100%);
            border: 1px solid rgba(0, 176, 240, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .situation-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--blue);
            font-weight: 600;
            margin-bottom: 10px;
        }
        .situation-text {
            color: var(--white);
            font-size: 1.05rem;
            line-height: 1.7;
        }
        /* Character Speech Bubble */
        .speech-bubble {
            position: relative;
            background: var(--slate);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            margin-left: 60px;
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 20px;
            border: 10px solid transparent;
            border-right-color: var(--slate);
            border-left: 0;
        }
        .speech-portrait {
            position: absolute;
            left: -60px;
            top: 0;
            width: 48px;
            height: 48px;
            background: var(--deep-navy);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid var(--slate);
            overflow: hidden;
        }
        .speech-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .speech-name {
            font-weight: 600;
            color: var(--green);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .speech-text {
            color: var(--light-grey);
            font-style: italic;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        /* Decision Section */
        .decision-section {
            margin-top: 24px;
        }
        .decision-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .decision-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--amber);
            font-weight: 700;
        }
        .decision-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--amber), transparent);
        }
        /* Option Cards - Grid of squares */
        .options-list { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        .options-list.two-options {
            grid-template-columns: repeat(2, 1fr);
        }
        .options-list.three-options {
            grid-template-columns: repeat(3, 1fr);
        }
        .option-card {
            background: var(--dark-slate);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--slate);
            transition: all 0.25s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .option-card:hover { 
            border-color: var(--blue); 
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 176, 240, 0.25);
        }
        .option-card.selected { 
            border-color: var(--green); 
            background: var(--dark-slate);
            box-shadow: 0 0 0 3px rgba(146, 208, 80, 0.3);
            transform: translateY(-4px);
        }
        .option-card.selected .option-cost-badge {
            background: var(--green);
        }
        .option-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: var(--slate);
        }
        .option-card.disabled:hover { 
            border-color: var(--slate); 
            transform: none;
            box-shadow: none;
        }
        .option-header {
            padding: 16px 16px 12px;
        }
        .option-header .option-name {
            margin-bottom: 12px;
        }
        .option-cost-badge {
            background: var(--blue);
            color: var(--deep-navy);
            padding: 10px 16px;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
        }
        .option-header .option-cost-badge {
            border-radius: 6px;
        }
        .option-card.disabled .option-cost-badge {
            background: var(--red);
            color: var(--white);
        }
        .option-content {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .option-name { 
            color: var(--white); 
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        .option-card > .option-header + p.option-desc {
            padding: 0 16px 16px;
            margin: 0;
        }
        .option-desc { 
            color: var(--mid-grey); 
            font-size: 0.85rem; 
            line-height: 1.5;
            flex: 1;
        }
        .option-impacts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: var(--deep-navy);
            border-top: 1px solid var(--slate);
            margin-top: auto;
        }
        .impact { 
            display: flex; 
            align-items: center; 
            gap: 4px;
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 4px;
            background: rgba(255,255,255,0.08);
        }
        .impact.negative { color: var(--red); }
        .impact.positive { color: var(--green); }
        .impact.neutral { color: var(--amber); }
        .impact.bad { color: var(--red); }
        .disabled-reason {
            color: var(--red);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 8px 16px;
            background: rgba(220, 53, 69, 0.1);
            text-align: center;
        }
        @media (max-width: 600px) {
            .options-list, .options-list.two-options, .options-list.three-options {
                grid-template-columns: 1fr;
            }
        }
        /* Stage 1 Design Choice cards - Grid */
        .design-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .design-card {
            background: var(--dark-slate);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--slate);
            transition: all 0.25s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .design-card:hover { 
            border-color: var(--blue); 
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 176, 240, 0.25);
        }
        .design-card.selected { 
            border-color: var(--green);
            box-shadow: 0 0 0 3px rgba(146, 208, 80, 0.3);
            transform: translateY(-4px);
        }
        .design-card.selected .design-card-cost {
            background: var(--green);
        }
        .design-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .design-card.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--slate);
        }
        .design-card-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: linear-gradient(135deg, var(--slate) 0%, var(--deep-navy) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid-grey);
            font-size: 0.65rem;
            overflow: hidden;
        }
        .design-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .design-card-cost {
            background: var(--blue);
            color: var(--deep-navy);
            padding: 10px;
            font-weight: 700;
            font-size: 1rem;
            text-align: center;
        }
        .design-card.disabled .design-card-cost {
            background: var(--red);
            color: var(--white);
        }
        .design-card-body {
            padding: 14px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .design-card-name {
            color: var(--white);
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .design-card-desc {
            color: var(--mid-grey);
            font-size: 0.8rem;
            line-height: 1.4;
            flex: 1;
        }
        @media (max-width: 600px) {
            .design-cards-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Modal Footer */
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--slate);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--deep-navy);
        }
        .modal-footer .btn {
            padding: 12px 28px;
            font-size: 0.95rem;
        }
        /* Failure Panel */
        .failure-panel {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(220, 53, 69, 0.1) 100%);
            border: 2px solid var(--red);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 24px;
        }
        .failure-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        .failure-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--red);
            margin-bottom: 10px;
        }
        .failure-text {
            color: var(--light-grey);
            line-height: 1.6;
        }
        .failure-impacts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .failure-impact {
            background: var(--dark-slate);
            border-radius: 8px;
            padding: 16px 12px;
            text-align: center;
        }
        .failure-impact-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 8px;
        }
        .failure-impact-value {
            display: block;
            color: var(--red);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .failure-impact-label {
            font-size: 0.7rem;
            color: var(--mid-grey);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        @media (max-width: 500px) {
            .failure-impacts {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        }
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary { background: var(--blue); color: var(--deep-navy); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn-secondary { background: var(--slate); color: var(--white); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        /* ============================================
           SCREENS (Transition, Summary, Results)
           ============================================ */
        .overlay-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 600;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            padding: 40px 20px;
        }
        .overlay-screen.active { display: flex; }
        .overlay-content {
            text-align: center;
            max-width: 650px;
            padding: 40px;
        }
        /* ========================================
           PHASE TRANSITION SCREEN (Time Skip)
           ======================================== */
        #transitionScreen {
            align-items: center;
            padding: 0;
        }
        #transitionScreen .overlay-content {
            max-width: 100%;
            width: 100%;
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: transparent;
        }
        .phase-intro {
            position: relative;
            width: 100%;
            max-width: 800px;
            padding: 40px;
        }
        .phase-years-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--mid-grey);
            margin-bottom: 16px;
        }
        .phase-year-big {
            font-size: 8rem;
            font-weight: 800;
            color: var(--white);
            line-height: 1;
            margin-bottom: 40px;
            text-shadow: 0 4px 30px rgba(0, 176, 240, 0.3);
        }
        .phase-visual {
            width: 100%;
            height: 200px;
            background: var(--dark-slate);
            border-radius: 16px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            position: relative;
            overflow: hidden;
        }
        .phase-visual::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,176,240,0.1) 0%, transparent 50%, rgba(146,208,80,0.1) 100%);
        }
        .phase-visual-icon {
            position: relative;
            z-index: 1;
        }
        .phase-context {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 40px;
        }
        .phase-context-line {
            font-size: 1.25rem;
            color: var(--light-grey);
            line-height: 1.6;
        }
        .phase-context-line:first-child {
            color: var(--white);
            font-weight: 600;
            font-size: 1.4rem;
        }
        .phase-name-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--blue) 0%, #0088cc 100%);
            color: var(--white);
            padding: 12px 32px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 30px;
        }
        /* ========================================
           STAGE SUMMARY SCREEN (End of Phase)
           ======================================== */
        #summaryScreen .overlay-content {
            max-width: 900px;
            width: 100%;
            text-align: left;
        }
        .summary-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .summary-phase-complete {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--green);
            margin-bottom: 12px;
        }
        .summary-title { 
            font-size: 2.5rem; 
            color: var(--white); 
            margin-bottom: 8px; 
        }
        .summary-subtitle { 
            color: var(--mid-grey); 
            margin-bottom: 0;
            font-size: 1.1rem;
        }
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }
        .summary-stat {
            background: var(--dark-slate);
            padding: 24px 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--slate);
            transition: transform 0.2s;
        }
        .summary-stat:hover {
            transform: translateY(-2px);
        }
        .summary-stat-icon { 
            font-size: 1.8rem; 
            margin-bottom: 10px; 
        }
        .summary-stat-value { 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--white); 
        }
        .summary-stat-value.over { color: var(--red); }
        .summary-stat-value.good { color: var(--green); }
        .summary-stat-label { 
            font-size: 0.75rem; 
            color: var(--mid-grey); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-top: 6px; 
        }
        .summary-section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--amber);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .summary-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--amber), transparent);
        }
        .summary-decisions {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-bottom: 30px;
            text-align: left;
            max-height: none;
            overflow: visible;
        }
        .summary-decisions h4 { 
            display: none; /* Using section title instead */
        }
        .decisions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .decision-card {
            background: var(--dark-slate);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--slate);
        }
        .decision-card.this-stage {
            border-left-color: var(--blue);
            background: linear-gradient(90deg, rgba(0,176,240,0.1) 0%, var(--dark-slate) 30%);
        }
        .decision-element { 
            color: var(--mid-grey);
            font-size: 0.85rem;
        }
        .decision-choice {
            color: var(--white);
            font-weight: 600;
            font-size: 0.95rem;
        }
        .decision-cost {
            color: var(--amber);
            font-size: 0.85rem;
            font-weight: 600;
        }
        .summary-insight {
            background: linear-gradient(135deg, var(--dark-slate) 0%, rgba(0,176,240,0.1) 100%);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--slate);
        }
        .insight-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }
        .insight-text {
            color: var(--light-grey);
            font-size: 1rem;
            line-height: 1.6;
        }
        .insight-text strong {
            color: var(--white);
        }
        .summary-actions {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }
        .btn-next-phase {
            padding: 16px 40px;
            background: linear-gradient(135deg, var(--green) 0%, #7bc050 100%);
            color: var(--deep-navy);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-next-phase:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(146, 208, 80, 0.3);
        }
        /* Legacy transition styles - keeping for compatibility */
        .trans-years { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        .trans-year { font-size: 5rem; color: var(--white); margin-bottom: 30px; }
        .trans-text {
            background: var(--dark-slate);
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            margin-bottom: 30px;
        }
        .trans-text p { margin-bottom: 12px; line-height: 1.6; }
        .trans-text p:last-child { margin-bottom: 0; }
        .btn-continue {
            padding: 14px 36px;
            background: var(--blue);
            color: var(--deep-navy);
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-continue:hover {
            transform: translateY(-2px);
        }
        @media (max-width: 600px) {
            .phase-year-big { font-size: 5rem; }
            .phase-visual { height: 150px; }
            .summary-stats { grid-template-columns: repeat(2, 1fr); }
            .decisions-grid { grid-template-columns: 1fr; }
        }
        /* Summary
        .btn-next-phase {
            padding: 12px 30px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        /* Story Transition Screen */
        .story-transition {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #0a1628 0%, #0d1f3c 50%, #0a1628 100%);
            z-index: 200;
            overflow-y: auto;
        }
        .story-transition.visible { 
            display: block; 
            animation: storyFadeIn 0.5s ease-out;
        }
        @keyframes storyFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .story-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 30px 60px;
        }
        /* Hero Header */
        .story-hero {
            text-align: center;
            padding: 40px 20px 50px;
            margin-bottom: 40px;
            position: relative;
        }
        .story-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--blue), transparent);
        }
        .story-hero::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--slate), transparent);
        }
        .story-phase-complete {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--green);
            margin-bottom: 15px;
            font-weight: 600;
        }
        .story-title {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--white) 0%, var(--blue) 50%, var(--green) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        .story-years {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
            color: var(--mid-grey);
        }
        .story-years .year {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
        }
        .story-years .arrow {
            color: var(--blue);
            font-size: 1.5rem;
        }
        /* Narrative Panel */
        .story-narrative {
            position: relative;
            background: linear-gradient(135deg, rgba(0, 176, 240, 0.08) 0%, rgba(146, 208, 80, 0.05) 100%);
            border: 1px solid rgba(0, 176, 240, 0.2);
            border-radius: 16px;
            padding: 30px 35px;
            margin-bottom: 40px;
            line-height: 1.8;
            color: var(--light-grey);
            font-size: 1.05rem;
        }
        .story-narrative::before {
            content: '"';
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 4rem;
            color: var(--blue);
            opacity: 0.3;
            font-family: Georgia, serif;
            line-height: 1;
        }
        .story-narrative p { 
            margin-bottom: 18px; 
            position: relative;
            z-index: 1;
        }
        .story-narrative p:last-child { margin-bottom: 0; }
        /* Section Styling */
        .story-section { 
            margin-bottom: 35px;
        }
        .story-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .story-section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .story-section-icon.lessons {
            background: linear-gradient(135deg, var(--green), #5fa349);
        }
        .story-section-icon.regulatory {
            background: linear-gradient(135deg, var(--blue), #0088cc);
        }
        .story-section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--white);
            margin: 0;
        }
        /* Lessons Grid */
        .story-lessons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .lesson-card {
            background: linear-gradient(135deg, rgba(146, 208, 80, 0.1) 0%, rgba(146, 208, 80, 0.02) 100%);
            border: 1px solid rgba(146, 208, 80, 0.25);
            border-radius: 12px;
            padding: 18px 20px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            transition: all 0.3s ease;
        }
        .lesson-card:hover {
            border-color: var(--green);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(146, 208, 80, 0.15);
        }
        .lesson-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(146, 208, 80, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .lesson-text {
            color: var(--light-grey);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        /* Regulatory Cards */
        .story-regulatory {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .reg-card {
            background: linear-gradient(135deg, rgba(0, 176, 240, 0.08) 0%, rgba(0, 176, 240, 0.02) 100%);
            border: 1px solid rgba(0, 176, 240, 0.2);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            transition: all 0.3s ease;
        }
        .reg-card:hover {
            border-color: var(--blue);
            background: linear-gradient(135deg, rgba(0, 176, 240, 0.12) 0%, rgba(0, 176, 240, 0.04) 100%);
        }
        .reg-badge {
            background: linear-gradient(135deg, var(--blue), #0088cc);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .reg-content {
            flex: 1;
        }
        .reg-title {
            color: var(--white);
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }
        .reg-desc {
            color: var(--mid-grey);
            font-size: 0.85rem;
            line-height: 1.5;
        }
        /* Foreshadow Panel */
        .story-foreshadow {
            position: relative;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.04) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            padding: 25px 30px;
            margin-bottom: 40px;
            color: var(--light-grey);
            font-size: 1.1rem;
            line-height: 1.7;
            font-style: italic;
            text-align: center;
        }
        .story-foreshadow::before {
            content: '⚡';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--deep-navy);
            padding: 5px 15px;
            font-size: 1.2rem;
            font-style: normal;
        }
        /* Continue Button */
        .story-continue { 
            text-align: center; 
            padding-top: 10px;
        }
        .story-continue .btn { 
            padding: 18px 50px; 
            font-size: 1.15rem;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--blue), #0088cc);
            border: none;
            box-shadow: 0 4px 20px rgba(0, 176, 240, 0.3);
            transition: all 0.3s ease;
        }
        .story-continue .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 176, 240, 0.4);
        }
        /* Final Report Styles */
        #resultsScreen .overlay-content {
            max-width: 900px;
            text-align: left;
        }
        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .results-grade {
            font-size: 6rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .results-grade.A { color: var(--green); }
        .results-grade.B { color: var(--blue); }
        .results-grade.C { color: var(--amber); }
        .results-grade.D { color: var(--red); }
        .results-title { color: var(--white); margin-bottom: 12px; }
        .results-verdict { color: var(--light-grey); margin-bottom: 0; font-size: 1.1rem; }
        .report-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            background: var(--dark-slate);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .comparison-box {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
        }
        .comparison-box.yours {
            background: rgba(255,255,255,0.05);
        }
        .comparison-box.optimal {
            background: rgba(146, 208, 80, 0.1);
            border: 1px solid var(--green);
        }
        .comparison-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mid-grey);
            margin-bottom: 8px;
        }
        .comparison-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--white);
        }
        .comparison-box.optimal .comparison-value {
            color: var(--green);
        }
        .comparison-vs {
            font-size: 1.2rem;
            color: var(--mid-grey);
            font-weight: 600;
        }
        .comparison-diff {
            font-size: 0.85rem;
            margin-top: 6px;
        }
        .comparison-diff.over { color: var(--red); }
        .comparison-diff.under { color: var(--green); }
        .report-section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--amber);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .report-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--amber), transparent);
        }
        /* Element Journey Cards */
        .element-journeys {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 30px;
        }
        .journey-card {
            background: var(--dark-slate);
            border-radius: 12px;
            overflow: hidden;
            border-left: 4px solid var(--slate);
        }
        .journey-card.good { border-left-color: var(--green); }
        .journey-card.wasteful { border-left-color: var(--amber); }
        .journey-card.poor { border-left-color: var(--red); }
        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .journey-header:hover {
            background: rgba(255,255,255,0.03);
        }
        .journey-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .journey-icon {
            font-size: 1.3rem;
        }
        .journey-name {
            font-weight: 600;
            color: var(--white);
            font-size: 0.95rem;
        }
        .journey-design {
            font-size: 0.8rem;
            color: var(--mid-grey);
        }
        .journey-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .journey-cost {
            text-align: right;
        }
        .journey-cost-value {
            font-weight: 600;
            color: var(--white);
        }
        .journey-cost-label {
            font-size: 0.7rem;
            color: var(--mid-grey);
        }
        .journey-verdict {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .journey-verdict.good { background: rgba(146,208,80,0.2); color: var(--green); }
        .journey-verdict.wasteful { background: rgba(255,193,7,0.2); color: var(--amber); }
        .journey-verdict.poor { background: rgba(220,53,69,0.2); color: var(--red); }
        .journey-expand {
            color: var(--mid-grey);
            font-size: 1rem;
            transition: transform 0.3s;
            margin-left: 8px;
        }
        .journey-card.expanded .journey-expand {
            transform: rotate(180deg);
        }
        .journey-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        .journey-card.expanded .journey-content {
            max-height: 800px;
        }
        .journey-timeline {
            padding: 16px 18px;
            background: var(--deep-navy);
            text-align: left;
        }
        .journey-stage {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            text-align: left;
        }
        .journey-stage:last-child {
            border-bottom: none;
        }
        .journey-stage-year {
            width: 70px;
            flex-shrink: 0;
            text-align: center;
        }
        .journey-stage-year-num {
            font-weight: 700;
            color: var(--blue);
            font-size: 1rem;
        }
        .journey-stage-year-phase {
            font-size: 0.65rem;
            color: var(--mid-grey);
            text-transform: uppercase;
        }
        .journey-stage-event {
            flex: 1;
            padding-right: 12px;
            text-align: left;
        }
        .journey-stage-decision {
            color: var(--white);
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 4px;
            text-align: left;
        }
        .journey-stage-consequence {
            font-size: 0.8rem;
            color: var(--mid-grey);
            line-height: 1.4;
            text-align: left;
        }
        .journey-stage-cost {
            width: 80px;
            text-align: right;
            color: var(--amber);
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .journey-lesson {
            padding: 14px 18px;
            border-top: 1px solid var(--slate);
        }
        .lesson-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--amber);
            margin-bottom: 6px;
        }
        .lesson-text {
            color: var(--light-grey);
            font-size: 0.85rem;
            line-height: 1.5;
        }
        /* Key Takeaways */
        .takeaways {
            background: var(--dark-slate);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .takeaway-item {
            display: flex;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .takeaway-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .takeaway-item:first-child {
            padding-top: 0;
        }
        .takeaway-icon {
            font-size: 1.1rem;
        }
        .takeaway-text {
            color: var(--light-grey);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .takeaway-text strong {
            color: var(--white);
        }
        /* Lifecycle Summary Panel */
        .lifecycle-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }
        .lifecycle-stat {
            background: var(--dark-slate);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--slate);
        }
        .lifecycle-stat.warning {
            border-color: var(--amber);
            background: rgba(255, 193, 7, 0.05);
        }
        .lifecycle-stat.danger {
            border-color: var(--red);
            background: rgba(220, 53, 69, 0.05);
        }
        .lifecycle-stat.good {
            border-color: var(--green);
            background: rgba(146, 208, 80, 0.05);
        }
        .lifecycle-stat-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        .lifecycle-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 4px;
        }
        .lifecycle-stat.warning .lifecycle-stat-value { color: var(--amber); }
        .lifecycle-stat.danger .lifecycle-stat-value { color: var(--red); }
        .lifecycle-stat.good .lifecycle-stat-value { color: var(--green); }
        .lifecycle-stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mid-grey);
            margin-bottom: 6px;
        }
        .lifecycle-stat-context {
            font-size: 0.8rem;
            color: var(--light-grey);
        }
        /* Safety & Regulatory Record */
        .record-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }
        .record-card {
            background: var(--dark-slate);
            border-radius: 12px;
            padding: 20px;
            border-left: 3px solid var(--slate);
        }
        .record-card.issues { border-left-color: var(--red); }
        .record-card.concerns { border-left-color: var(--amber); }
        .record-card.clean { border-left-color: var(--green); }
        .record-card-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mid-grey);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .record-card-title span {
            font-size: 1rem;
        }
        .record-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .record-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--light-grey);
        }
        .record-item-icon {
            width: 20px;
            text-align: center;
        }
        .record-item.bad .record-item-icon { color: var(--red); }
        .record-item.warning .record-item-icon { color: var(--amber); }
        .record-item.good .record-item-icon { color: var(--green); }
        .record-card-summary {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
            color: var(--light-grey);
            font-style: italic;
        }
        @media (max-width: 700px) {
            .lifecycle-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .record-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Report actions */
        .report-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 30px;
        }
        @media (max-width: 700px) {
            .report-comparison {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .comparison-vs { display: none; }
            .journey-right { flex-direction: column; gap: 8px; }
        }
        /* Mobile */
        @media (max-width: 768px) {
            .top-bar-stats { display: none; }
            .summary-stats, .results-totals { grid-template-columns: repeat(2, 1fr); }
            .intro-title { font-size: 2rem; }
            .timeline-container { padding: 0 10px 15px 10px; }
            .timeline-track { left: 30px; right: 30px; }
            .timeline-stage { min-width: 60px; }
            .timeline-node { width: 36px; height: 36px; font-size: 0.65rem; }
            .timeline-year { font-size: 0.8rem; }
            .timeline-name { font-size: 0.55rem; }
        }
        @media (max-width: 480px) {
            .timeline-name { display: none; }
            .timeline-node { width: 30px; height: 30px; font-size: 0.6rem; }
        }
        /* ============================================
           PIPE ROUTING MINI-GAME
           ============================================ */
        .pipe-game-container {
            background: #0a1628;
            border: 1px solid #2d4a6f;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }
        .pipe-game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid #2d4a6f;
        }
        .pipe-game-title {
            color: var(--blue);
            font-size: 0.85rem;
            font-weight: 600;
        }
        .pipe-game-cost {
            color: var(--amber);
            font-size: 0.8rem;
        }
        .pipe-game-tabs {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.2);
        }
        .pipe-game-tab {
            flex: 1;
            padding: 10px 15px;
            background: #1a2d42;
            border: 2px solid #2d4a6f;
            border-radius: 6px;
            color: var(--light-grey);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .pipe-game-tab:hover {
            border-color: var(--blue);
            background: #1f3a52;
        }
        .pipe-game-tab.active {
            border-color: var(--blue);
            background: var(--blue);
            color: #000;
        }
        .pipe-game-tab.completed {
            border-color: var(--green);
        }
        .pipe-game-tab.completed::after {
            content: ' ✓';
            color: var(--green);
        }
        .pipe-game-tab.active.completed::after {
            color: #000;
        }
        .pipe-game-tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pipe-game-tab.disabled:hover {
            border-color: #2d4a6f;
            background: #1a2d42;
        }
        .pipe-game-tab-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .pipe-game-tab-cost {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .pipe-game-view {
            position: relative;
            height: 220px;
            background: linear-gradient(180deg, #0d1a2d 0%, #0a1420 100%);
            border-top: 1px solid #1a3050;
        }
        .pipe-game-labels {
            position: absolute;
            top: 8px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #5a7a9a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .pipe-game-floor {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: #2d3e50;
            border-top: 2px solid #4a6785;
        }
        .pipe-game-floor-label {
            position: absolute;
            bottom: 5px;
            left: 15px;
            font-size: 0.6rem;
            color: #5a7a9a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .pipe-game-walls {
            position: absolute;
            top: 30px;
            bottom: 25px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        .pipe-game-wall {
            width: 30px;
            background: linear-gradient(90deg, #3d4a5a 0%, #2d3e50 100%);
            border: 1px solid #4a6785;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pipe-game-wall.right {
            background: linear-gradient(90deg, #2d3e50 0%, #3d4a5a 100%);
        }
        .pipe-game-wall-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.55rem;
            color: #6a8aaa;
            letter-spacing: 1px;
        }
        .pipe-game-area {
            position: absolute;
            top: 30px;
            bottom: 25px;
            left: 50px;
            right: 50px;
            overflow: hidden;
        }
        .pipe-game-message {
            padding: 12px 15px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid #2d4a6f;
            font-size: 0.8rem;
            color: var(--light-grey);
            min-height: 60px;
        }
        .pipe-game-message-title {
            color: var(--amber);
            font-weight: 600;
            margin-bottom: 5px;
        }
        .pipe-game-message.success .pipe-game-message-title { color: var(--green); }
        .pipe-game-message.warning .pipe-game-message-title { color: var(--red); }
        /* Embedded game - concrete grid */
        .concrete-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 3px;
            padding: 8px;
        }
        .concrete-block {
            background: linear-gradient(135deg, #4a5568 0%, #3d4a5a 50%, #2d3e50 100%);
            border: 1px solid #5a6a7a;
            border-radius: 2px;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><text y="18" font-size="18">🔨</text></svg>') 4 4, pointer;
            transition: all 0.15s;
            position: relative;
        }
        .concrete-block:hover:not(.broken) {
            background: linear-gradient(135deg, #5a6878 0%, #4d5a6a 50%, #3d4e60 100%);
            border-color: #7a8a9a;
        }
        .concrete-block.broken {
            background: #1a2535;
            border-color: #2a3545;
            cursor: default;
        }
        .concrete-block.has-pipe.broken::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -2px;
            right: -2px;
            height: 10px;
            transform: translateY(-50%);
            background: linear-gradient(180deg, #00b0f0 0%, #0088cc 50%, #006699 100%);
            border-radius: 5px;
            box-shadow: 0 0 8px rgba(0, 176, 240, 0.5);
        }
        .concrete-block.hit {
            animation: blockHit 0.15s ease-out;
        }
        @keyframes blockHit {
            0% { transform: scale(1); }
            50% { transform: scale(0.92); }
            100% { transform: scale(1); }
        }
        .embedded-stats {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .embedded-stat {
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .embedded-stat.cost { color: #ffc107; border: 1px solid #ffc107; }
        .embedded-stat.found { color: #00b0f0; border: 1px solid #00b0f0; }
        /* Ducted game */
        .ducts-container {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .duct-section {
            position: relative;
            height: 70px;
            flex: 1;
            max-width: 90px;
            background: #1a2d42;
            border: 2px solid #2d4a6f;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .duct-section:hover:not(.open) {
            border-color: #00b0f0;
            box-shadow: 0 0 10px rgba(0, 176, 240, 0.3);
        }
        .duct-section.open {
            background: #0d1f33;
            border-color: #92d050;
            cursor: default;
        }
        .duct-cover {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 16px;
            background: linear-gradient(180deg, #3d5a80 0%, #2d4a6f 100%);
            border-radius: 2px 2px 0 0;
            transition: all 0.4s ease;
            transform-origin: top center;
        }
        .duct-section.open .duct-cover {
            transform: rotateX(-100deg);
            opacity: 0.4;
        }
        .duct-cover-handle {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 4px;
            background: #4a6785;
            border-radius: 2px;
        }
        .duct-pipe {
            position: absolute;
            top: 26px;
            left: 6px;
            right: 6px;
            height: 16px;
            background: linear-gradient(180deg, #00b0f0 0%, #0088cc 50%, #006699 100%);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 6px rgba(0, 176, 240, 0.4);
        }
        .duct-section.open .duct-pipe { opacity: 1; }
        .duct-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.5rem;
            color: #4a6785;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .duct-section.open .duct-label {
            opacity: 1;
            color: #92d050;
        }
        .duct-click-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.55rem;
            color: #6a8aaa;
            text-align: center;
            pointer-events: none;
        }
        .duct-section.open .duct-click-hint { opacity: 0; }
        .duct-progress {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.7);
            padding: 5px 12px;
            border-radius: 4px;
        }
        .duct-progress-bar {
            width: 100px;
            height: 6px;
            background: #1a2d42;
            border-radius: 3px;
            overflow: hidden;
        }
        .duct-progress-fill {
            height: 100%;
            background: var(--green);
            width: 0;
            transition: width 0.3s;
        }
        .duct-progress-text {
            font-size: 0.7rem;
            color: var(--light-grey);
        }
        /* Tunnel game */
        .tunnel-interior {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            background: #0a1628;
            border: 1px solid #1a3a5c;
            border-radius: 4px;
            overflow: hidden;
        }
        .tunnel-pipe {
            position: absolute;
            height: 20px;
            background: linear-gradient(180deg, #00b0f0 0%, #0088cc 50%, #006699 100%);
            border-radius: 10px;
            top: 15px;
            left: 15px;
            right: 15px;
            box-shadow: 0 2px 8px rgba(0, 176, 240, 0.4);
        }
        .tunnel-pipe-supports {
            position: absolute;
            top: 35px;
            left: 15px;
            right: 15px;
            height: 25px;
            display: flex;
            justify-content: space-between;
        }
        .tunnel-pipe-support {
            width: 5px;
            height: 25px;
            background: #4a6785;
            border-radius: 2px;
        }
        .tunnel-floor {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: #2d3e50;
            border-top: 2px solid #4a6785;
        }
        .tunnel-worker {
            position: absolute;
            bottom: 20px;
            left: 15px;
            width: 20px;
            height: 38px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: left 0.08s, bottom 0.08s;
            z-index: 10;
        }
        .tunnel-worker-head {
            width: 14px;
            height: 14px;
            background: #ffc107;
            border-radius: 50%;
            border: 2px solid #e6ac00;
        }
        .tunnel-worker-body {
            width: 16px;
            height: 24px;
            background: #ff6b35;
            border-radius: 4px 4px 2px 2px;
            margin-top: -2px;
            border: 2px solid #e55a25;
        }
        .tunnel-worker.contaminated .tunnel-worker-head,
        .tunnel-worker.contaminated .tunnel-worker-body {
            animation: contamFlash 0.2s infinite;
        }
        @keyframes contamFlash {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.5) hue-rotate(60deg); }
        }
        .tunnel-goal {
            position: absolute;
            right: 10px;
            bottom: 20px;
            width: 25px;
            height: 45px;
            background: linear-gradient(90deg, transparent 0%, rgba(146, 208, 80, 0.3) 100%);
            border-right: 3px solid #92d050;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tunnel-goal-arrow {
            color: #92d050;
            font-size: 1rem;
            animation: goalPulse 1s infinite;
        }
        @keyframes goalPulse {
            0%, 100% { opacity: 0.5; transform: translateX(0); }
            50% { opacity: 1; transform: translateX(2px); }
        }
        .radiation-cloud {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 193, 7, 0.7) 0%, rgba(255, 193, 7, 0.3) 40%, rgba(255, 193, 7, 0) 70%);
            pointer-events: none;
            z-index: 5;
        }
        .radiation-cloud::before {
            content: '☢';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            opacity: 0.8;
        }
        .radiation-cloud.barrier {
            background: radial-gradient(circle, rgba(255, 100, 50, 0.8) 0%, rgba(255, 193, 7, 0.5) 40%, rgba(255, 193, 7, 0) 70%);
            animation: barrierPulse 1.5s ease-in-out infinite;
        }
        .radiation-cloud.moving {
            animation: cloudDrift 3s ease-in-out infinite alternate;
        }
        .radiation-cloud.pulsing {
            animation: cloudPulse 2s ease-in-out infinite;
        }
        @keyframes barrierPulse {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        @keyframes cloudDrift {
            0% { transform: translateX(0) translateY(0); }
            100% { transform: translateX(20px) translateY(-8px); }
        }
        @keyframes cloudPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        .tunnel-dose-counter {
            position: absolute;
            top: 6px;
            right: 8px;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #dc3545;
            z-index: 20;
        }
        .tunnel-dose-counter.warning {
            animation: doseWarning 0.5s infinite;
        }
        @keyframes doseWarning {
            0%, 100% { background: rgba(220, 53, 69, 0.2); }
            50% { background: rgba(220, 53, 69, 0.5); }
        }
        .tunnel-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }
        .tunnel-key {
            display: inline-block;
            background: #2d4a6f;
            color: #00b0f0;
            padding: 3px 7px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.7rem;
        }
        .tunnel-controls-text {
            font-size: 0.75rem;
            color: #8899a6;
        }
        /* ========================================
           WELD INSPECTION GAME CSS
           ======================================== */
        .weld-game-container {
            background: linear-gradient(135deg, #0d1a2d 0%, #1a2a3a 100%);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }
        .weld-game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--slate);
        }
        .weld-game-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--blue);
        }
        .weld-game-stats {
            display: flex;
            gap: 15px;
        }
        .weld-stat {
            font-size: 0.8rem;
            color: var(--light-grey);
        }
        .weld-stat-value {
            font-weight: 600;
            color: var(--white);
        }
        .weld-viewport {
            position: relative;
            background: #0a1424;
            border-radius: 8px;
            height: 320px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .weld-wall {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, #4a5568 0%, #374151 80%, #2d3748 100%);
            border-right: 3px solid #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width 0.4s ease, opacity 0.4s ease;
        }
        .weld-wall-label {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            color: var(--mid-grey);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .weld-wall-dim {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            background: var(--slate);
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.6rem;
            color: var(--amber);
            white-space: nowrap;
        }
        .weld-scaffold-rail {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 10px;
            background: repeating-linear-gradient(0deg, #f59e0b 0px, #f59e0b 3px, #1a1a1a 3px, #1a1a1a 6px);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .weld-scaffold-rail.left { left: 20px; }
        .weld-scaffold-rail.right { right: 20px; }
        .weld-scaffold-rail.visible { opacity: 1; }
        .weld-scaffold-label {
            position: absolute;
            top: 10px;
            font-size: 0.6rem;
            color: var(--amber);
            text-transform: uppercase;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .weld-scaffold-label.left { left: 8px; }
        .weld-scaffold-label.right { right: 8px; }
        .weld-scaffold-label.visible { opacity: 1; }
        .weld-robot-badge {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--green), #6ab04c);
            color: var(--deep-navy);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 15;
        }
        .weld-robot-badge.visible { opacity: 1; }
        .weld-pipe-section {
            position: absolute;
            width: 200px;
            height: 200px;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.4s ease;
        }
        .weld-pipe-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 50%, #1a202c 100%);
            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.3);
        }
        .weld-pipe-inner {
            position: absolute;
            width: 50%;
            height: 50%;
            left: 25%;
            top: 25%;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a202c 0%, #0d1a2d 100%);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .weld-pipe-inner-label {
            color: var(--mid-grey);
            font-size: 0.55rem;
            text-transform: uppercase;
            text-align: center;
        }
        .weld-ring {
            position: absolute;
            width: 78%;
            height: 78%;
            left: 11%;
            top: 11%;
            border-radius: 50%;
            border: 3px solid var(--red);
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
        }
        .weld-ring-label {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-slate);
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.6rem;
            color: var(--red);
            white-space: nowrap;
            border: 1px solid var(--red);
        }
        .weld-point {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            z-index: 5;
        }
        .weld-point.pending {
            background: rgba(100, 116, 139, 0.5);
            border: 2px solid var(--mid-grey);
            color: var(--mid-grey);
        }
        .weld-point.pending:hover {
            background: rgba(0, 176, 240, 0.4);
            border-color: var(--blue);
            color: var(--white);
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 15px rgba(0, 176, 240, 0.5);
        }
        .weld-point.complete {
            background: rgba(146, 208, 80, 0.4);
            border: 2px solid var(--green);
            color: var(--green);
        }
        .weld-point.blocked {
            background: rgba(220, 53, 69, 0.4);
            border: 2px solid var(--red);
            color: var(--red);
            cursor: not-allowed;
        }
        .weld-point.scanning {
            animation: weldScanPulse 0.4s ease;
            background: rgba(0, 176, 240, 0.5);
            border-color: var(--blue);
            color: var(--white);
        }
        @keyframes weldScanPulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.7); }
            100% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0); }
        }
        .weld-probe {
            position: absolute;
            width: 70px;
            transition: all 0.35s ease;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
        }
        .weld-probe img {
            width: 100%;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
            transform: scaleX(-1);
        }
        .weld-probe.blocked {
            animation: weldProbeBlocked 0.4s ease;
        }
        @keyframes weldProbeBlocked {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(12px); }
            40% { transform: translateX(-10px); }
            60% { transform: translateX(6px); }
            80% { transform: translateX(-3px); }
        }
        .weld-blocked-msg {
            position: absolute;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 20;
            white-space: nowrap;
        }
        .weld-blocked-msg.visible { opacity: 1; }
        .weld-coverage-panel {
            background: var(--slate);
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 12px;
        }
        .weld-coverage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .weld-coverage-label {
            font-size: 0.8rem;
            color: var(--light-grey);
        }
        .weld-coverage-value {
            font-size: 1.1rem;
            font-weight: 700;
        }
        .weld-coverage-value.full { color: var(--green); }
        .weld-coverage-value.partial { color: var(--amber); }
        .weld-coverage-value.poor { color: var(--red); }
        .weld-coverage-bar {
            height: 6px;
            background: var(--dark-slate);
            border-radius: 3px;
            overflow: hidden;
        }
        .weld-coverage-fill {
            height: 100%;
            background: var(--green);
            transition: width 0.4s ease, background 0.3s;
            border-radius: 3px;
        }
        .weld-coverage-fill.partial { background: var(--amber); }
        .weld-coverage-fill.poor { background: var(--red); }
        .weld-coverage-detail {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--mid-grey);
        }
        .weld-coverage-detail span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .weld-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .weld-dot.complete { background: var(--green); }
        .weld-dot.blocked { background: var(--red); }
        .weld-dot.pending { background: var(--mid-grey); }
        .weld-status-msg {
            text-align: center;
            padding: 10px;
            background: rgba(0, 176, 240, 0.1);
            border: 1px solid rgba(0, 176, 240, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--light-grey);
        }
        .weld-status-msg.warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        .weld-status-msg.error {
            background: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
        }
        .weld-status-msg.success {
            background: rgba(146, 208, 80, 0.1);
            border-color: rgba(146, 208, 80, 0.3);
        }
        
        /* ============================================
           EMERGENCY TRIP GAME STYLES
           ============================================ */
        .trip-game-container {
            padding: 0;
        }
        .trip-emergency-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(90deg, rgba(100, 100, 100, 0.2), transparent);
            border-left: 4px solid var(--mid-grey);
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .trip-emergency-header.active {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.3), transparent);
            border-left-color: var(--red);
            animation: tripEmergencyPulse 0.5s ease infinite;
        }
        @keyframes tripEmergencyPulse {
            0%, 100% { background: linear-gradient(90deg, rgba(220, 53, 69, 0.2), transparent); }
            50% { background: linear-gradient(90deg, rgba(220, 53, 69, 0.4), rgba(220, 53, 69, 0.1)); }
        }
        .trip-emergency-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mid-grey);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s;
        }
        .trip-emergency-header.active .trip-emergency-title {
            color: var(--red);
        }
        .trip-emergency-title .trip-icon {
            font-size: 1.2rem;
        }
        .trip-emergency-header.active .trip-icon {
            animation: tripAlarmBlink 0.3s ease infinite;
        }
        @keyframes tripAlarmBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .trip-timer-display {
            font-size: 1.6rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--mid-grey);
            background: #000;
            padding: 6px 16px;
            border-radius: 6px;
            border: 2px solid #333;
            transition: all 0.3s;
        }
        .trip-timer-display.active {
            color: var(--white);
            border-color: var(--amber);
        }
        .trip-timer-display.slow { color: var(--amber); }
        .trip-timer-display.veryslow { color: var(--red); }
        
        .trip-panel-viewport {
            position: relative;
            background: #1a1a1a;
            border-radius: 10px;
            height: 320px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 3px solid #333;
        }
        .trip-panel-viewport.alarm {
            animation: tripViewportAlarm 0.5s ease infinite;
        }
        @keyframes tripViewportAlarm {
            0%, 100% { border-color: #333; }
            50% { border-color: var(--red); }
        }
        .trip-panel-header {
            background: linear-gradient(180deg, #2a2a2a, #1a1a1a);
            padding: 6px 12px;
            border-bottom: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trip-panel-label {
            font-size: 0.65rem;
            color: var(--mid-grey);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .trip-status-lights {
            display: flex;
            gap: 6px;
        }
        .trip-status-light {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }
        .trip-status-light.red { background: var(--red); box-shadow: 0 0 6px var(--red); }
        .trip-status-light.amber { background: var(--amber); box-shadow: 0 0 5px var(--amber); }
        .trip-status-light.green { background: var(--green); box-shadow: 0 0 5px var(--green); }
        
        /* Compact Panel - Circular Buttons */
        .trip-compact-panel {
            padding: 12px 8px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px 4px;
            height: calc(100% - 32px);
            align-content: start;
            background: linear-gradient(180deg, #2a2a2a, #1f1f1f);
        }
        .trip-compact-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            justify-self: center;
            font-size: 0.35rem;
            font-weight: 700;
            color: transparent;
            text-align: center;
            line-height: 1.1;
            padding: 2px;
            text-transform: uppercase;
        }
        .trip-compact-btn:active { transform: translateY(2px); }
        .trip-compact-btn.btn-red {
            background: linear-gradient(180deg, #8b3a3a, #5a2020);
            border: 2px solid #aa4444;
            box-shadow: 0 2px 0 #2a1010, 0 3px 6px rgba(0,0,0,0.4), inset 0 -2px 4px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,100,100,0.2);
        }
        .trip-compact-btn.btn-green {
            background: linear-gradient(180deg, #3a6b3a, #205020);
            border: 2px solid #4a8b4a;
            box-shadow: 0 2px 0 #102a10, 0 3px 6px rgba(0,0,0,0.4), inset 0 -2px 4px rgba(0,0,0,0.3), inset 0 2px 4px rgba(100,255,100,0.2);
        }
        .trip-compact-btn.btn-yellow {
            background: linear-gradient(180deg, #7b6b2a, #504510);
            border: 2px solid #9b8b3a;
            box-shadow: 0 2px 0 #2a2510, 0 3px 6px rgba(0,0,0,0.4), inset 0 -2px 4px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,100,0.2);
        }
        .trip-compact-btn.btn-blue {
            background: linear-gradient(180deg, #3a4a6b, #202a50);
            border: 2px solid #4a5a8b;
            box-shadow: 0 2px 0 #101a2a, 0 3px 6px rgba(0,0,0,0.4), inset 0 -2px 4px rgba(0,0,0,0.3), inset 0 2px 4px rgba(100,150,255,0.2);
        }
        .trip-compact-panel.revealed .trip-compact-btn {
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Ergonomic Panel - Task Based */
        .trip-ergo-panel {
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 140px 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            height: calc(100% - 32px);
            background: linear-gradient(180deg, #252525, #1a1a1a);
        }
        .trip-ergo-section {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #333;
        }
        .trip-ergo-label {
            font-size: 0.5rem;
            color: var(--mid-grey);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .trip-ergo-panel.revealed .trip-ergo-label { opacity: 1; }
        .trip-ergo-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            justify-items: center;
        }
        .trip-ergo-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.35rem;
            font-weight: 700;
            color: transparent;
            text-transform: uppercase;
        }
        .trip-ergo-btn:active { transform: translateY(2px); }
        .trip-ergo-btn.ind-green {
            background: linear-gradient(180deg, #2d5a3d, #1a3a25);
            border: 2px solid #3d7a4d;
            box-shadow: 0 2px 0 #0a1a10, 0 3px 6px rgba(0,0,0,0.4), inset 0 2px 6px rgba(80,200,100,0.15);
        }
        .trip-ergo-btn.ind-amber {
            background: linear-gradient(180deg, #6a5a2a, #4a3a15);
            border: 2px solid #8a7a3a;
            box-shadow: 0 2px 0 #2a2010, 0 3px 6px rgba(0,0,0,0.4), inset 0 2px 6px rgba(255,200,80,0.15);
        }
        .trip-ergo-btn.ind-blue {
            background: linear-gradient(180deg, #2a3a5a, #15253a);
            border: 2px solid #3a4a7a;
            box-shadow: 0 2px 0 #0a1020, 0 3px 6px rgba(0,0,0,0.4), inset 0 2px 6px rgba(80,150,255,0.15);
        }
        .trip-ergo-btn.ind-red {
            background: linear-gradient(180deg, #5a2a2a, #3a1515);
            border: 2px solid #7a3a3a;
            box-shadow: 0 2px 0 #200a0a, 0 3px 6px rgba(0,0,0,0.4), inset 0 2px 6px rgba(255,80,80,0.15);
        }
        .trip-ergo-panel.revealed .trip-ergo-btn {
            color: rgba(255,255,255,0.85);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .trip-trip-section {
            grid-column: 2;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #111;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 12px;
            position: relative;
            overflow: hidden;
        }
        .trip-cover-plate {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, #3a3a3a, #2a2a2a);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.5s ease, opacity 0.5s ease;
            z-index: 10;
        }
        .trip-cover-plate .cover-icon { font-size: 1.5rem; color: #555; }
        .trip-cover-plate .cover-text { font-size: 0.55rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .trip-ergo-panel.revealed .trip-cover-plate {
            transform: translateY(-100%);
            opacity: 0;
        }
        .trip-ergo-panel.revealed .trip-trip-section {
            border-color: var(--red);
            background: linear-gradient(180deg, #1a0a0a, #0a0505);
        }
        .trip-trip-label {
            font-size: 0.6rem;
            color: var(--red);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.5s ease 0.2s;
        }
        .trip-ergo-panel.revealed .trip-trip-label { opacity: 1; }
        .trip-big-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(180deg, #ff4444, #cc0000);
            border: 4px solid #990000;
            box-shadow: 0 4px 0 #660000, 0 6px 15px rgba(0,0,0,0.5), inset 0 -4px 15px rgba(0,0,0,0.3), inset 0 4px 15px rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 2px 3px rgba(0,0,0,0.5);
            opacity: 0;
            transform: scale(0.5);
        }
        .trip-ergo-panel.revealed .trip-big-btn {
            opacity: 1;
            transform: scale(1);
            transition: all 0.4s ease 0.3s;
        }
        .trip-big-btn:hover { background: linear-gradient(180deg, #ff5555, #dd1111); transform: scale(1.05) !important; }
        .trip-big-btn:active { transform: scale(0.95) translateY(3px) !important; }
        .trip-trip-sublabel {
            margin-top: 8px;
            font-size: 0.45rem;
            color: var(--mid-grey);
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease 0.4s;
        }
        .trip-ergo-panel.revealed .trip-trip-sublabel { opacity: 1; }
        
        /* LCD Touch Panel */
        .trip-lcd-panel {
            padding: 8px;
            height: calc(100% - 32px);
            display: flex;
            flex-direction: column;
            background: #050505;
        }
        .trip-lcd-screen {
            flex: 1;
            background: linear-gradient(180deg, #0a1820, #051015);
            border: 3px solid #1a3040;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 20px rgba(0, 100, 150, 0.1);
        }
        .trip-lcd-title-bar {
            background: linear-gradient(180deg, #1a3040, #0f2027);
            padding: 5px 10px;
            border-bottom: 1px solid #2a4050;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .trip-lcd-title {
            font-size: 0.6rem;
            color: var(--blue);
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .trip-lcd-panel.revealed .trip-lcd-title { opacity: 1; }
        .trip-lcd-breadcrumb {
            font-size: 0.5rem;
            color: #4a6a7a;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .trip-lcd-panel.revealed .trip-lcd-breadcrumb { opacity: 1; }
        .trip-lcd-content {
            flex: 1;
            padding: 8px;
            position: relative;
            min-height: 0;
        }
        .trip-lcd-layer {
            position: absolute;
            top: 8px; left: 8px; right: 8px; bottom: 8px;
            display: none;
            flex-direction: column;
            gap: 6px;
        }
        .trip-lcd-layer.active { display: flex; }
        .trip-lcd-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            flex: 1;
        }
        .trip-lcd-btn {
            background: linear-gradient(180deg, #1a3040, #0f2030);
            border: 1px solid #2a4050;
            border-radius: 4px;
            padding: 8px 4px;
            font-size: 0.55rem;
            color: transparent;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .trip-lcd-btn:hover {
            background: linear-gradient(180deg, #2a4050, #1a3040);
            border-color: var(--blue);
            box-shadow: 0 0 8px rgba(0, 176, 240, 0.3);
        }
        .trip-lcd-btn:active { transform: scale(0.97); }
        .trip-lcd-panel.revealed .trip-lcd-btn { color: var(--light-grey); }
        .trip-lcd-back-btn {
            background: linear-gradient(180deg, #1a2030, #0f1520);
            border: 1px solid #2a3040;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.5rem;
            color: transparent;
            cursor: pointer;
            transition: all 0.15s;
            align-self: flex-start;
            flex-shrink: 0;
        }
        .trip-lcd-back-btn:hover { border-color: #4a5060; }
        .trip-lcd-panel.revealed .trip-lcd-back-btn { color: #6a7a8a; }
        
        /* Trip Result Overlay */
        .trip-result-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }
        .trip-result-overlay.visible { display: flex; }
        .trip-result-icon { font-size: 3rem; }
        .trip-result-title { font-size: 1.3rem; font-weight: 700; }
        .trip-result-title.success { color: var(--green); }
        .trip-result-title.slow { color: var(--amber); }
        .trip-result-title.veryslow { color: var(--red); }
        .trip-result-time { font-size: 1rem; color: var(--light-grey); }
        .trip-result-message {
            max-width: 280px;
            text-align: center;
            color: var(--mid-grey);
            line-height: 1.4;
            font-size: 0.8rem;
        }
        
        /* Trip consequence display */
        .trip-consequence {
            margin-top: 10px;
            padding: 10px;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 6px;
            text-align: center;
        }
        .trip-consequence.good {
            background: rgba(146, 208, 80, 0.1);
            border-color: rgba(146, 208, 80, 0.3);
        }
        .trip-consequence-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--red);
            margin-bottom: 5px;
        }
        .trip-consequence.good .trip-consequence-title { color: var(--green); }
        .trip-consequence-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.7rem;
            color: var(--light-grey);
        }
        .trip-consequence-stat span { font-weight: 600; }
    </style>
</head>
<body>
<!-- VERSION TAG -->
<div class="version-tag">v0.51</div>
<!-- CINEMATIC INTRO -->
<div id="cinematicIntro">
    <div class="intro-slide active" data-slide="1">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="The Nuclear House">
            </div>
            <p class="intro-company">Presents</p>
            <h1 class="intro-title">The 60-Year Journey</h1>
            <div class="intro-phases">
                <span class="intro-phase"><span class="intro-phase-icon">📐</span> Design</span>
                <span class="intro-phase-connector">→</span>
                <span class="intro-phase"><span class="intro-phase-icon">🔧</span> Operations</span>
                <span class="intro-phase-connector">→</span>
                <span class="intro-phase"><span class="intro-phase-icon">🔍</span> Inspection</span>
                <span class="intro-phase-connector">→</span>
                <span class="intro-phase"><span class="intro-phase-icon">🏗️</span> Decommissioning</span>
            </div>
            <p class="intro-tagline">Every decision you make today will be <strong>lived with for decades</strong></p>
        </div>
    </div>
    <div class="intro-slide" data-slide="2">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <p class="intro-location">Somerset Coast, UK</p>
            <h2 class="intro-year">2025</h2>
            <div class="intro-text-box">
                <p><strong>Thornbury Point Nuclear Power Station.</strong></p>
                <p>Construction begins. Sixty years of operation, maintenance, inspection, and eventual decommissioning lie ahead.</p>
                <p>Someone needs to design it right — that someone is you.</p>
            </div>
        </div>
    </div>
    <div class="intro-slide" data-slide="3">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <div class="intro-text-box">
                <p>You've been assigned <span class="highlight">Section 4B</span>: Primary coolant system auxiliaries.</p>
                <p>Your choices will affect <strong>maintenance access</strong>, <strong>inspection coverage</strong>, <strong>dose uptake</strong>, and <strong>regulatory compliance</strong> — right through to final site clearance.</p>
                <div class="intro-timeline-preview">
                    <div class="intro-timeline-wrapper">
                        <div class="intro-timeline-node active">📐</div>
                        <div class="intro-timeline-label">2025</div>
                    </div>
                    <div class="intro-timeline-line"></div>
                    <div class="intro-timeline-wrapper">
                        <div class="intro-timeline-node">⚡</div>
                        <div class="intro-timeline-label">2040</div>
                    </div>
                    <div class="intro-timeline-line"></div>
                    <div class="intro-timeline-wrapper">
                        <div class="intro-timeline-node">🔍</div>
                        <div class="intro-timeline-label">2055</div>
                    </div>
                    <div class="intro-timeline-line"></div>
                    <div class="intro-timeline-wrapper">
                        <div class="intro-timeline-node">⚠️</div>
                        <div class="intro-timeline-label">2070</div>
                    </div>
                    <div class="intro-timeline-line"></div>
                    <div class="intro-timeline-wrapper">
                        <div class="intro-timeline-node">🏗️</div>
                        <div class="intro-timeline-label">2085</div>
                    </div>
                </div>
                <p style="text-align: center; color: var(--mid-grey); font-size: 0.9rem;">Four people will inherit your decisions. Their success depends on what you choose.</p>
            </div>
        </div>
    </div>
    <div class="intro-slide" data-slide="4">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-text-box" style="text-align: center; border-left: none; border: 2px solid var(--blue);">
                <p><strong>Six design decisions. Sixty years of consequences.</strong></p>
                <p>Good choices enable safe operations and straightforward decommissioning.<br>Poor choices create workarounds that compound into crises.</p>
                <div class="intro-stakes">
                    <div class="intro-stake">
                        <div class="intro-stake-icon">💷</div>
                        <div class="intro-stake-label">Lifecycle Cost</div>
                        <div class="intro-stake-value">£1M – £3M+</div>
                    </div>
                    <div class="intro-stake">
                        <div class="intro-stake-icon">☢️</div>
                        <div class="intro-stake-label">Dose Uptake</div>
                        <div class="intro-stake-value">Your choices</div>
                    </div>
                    <div class="intro-stake">
                        <div class="intro-stake-icon">📋</div>
                        <div class="intro-stake-label">Regulatory Record</div>
                        <div class="intro-stake-value">At stake</div>
                    </div>
                </div>
                <div class="intro-budget">Design Budget: £800,000</div>
            </div>
        </div>
    </div>
    <div class="intro-dots">
        <div class="intro-dot active" data-dot="1"></div>
        <div class="intro-dot" data-dot="2"></div>
        <div class="intro-dot" data-dot="3"></div>
        <div class="intro-dot" data-dot="4"></div>
    </div>
    <div class="intro-nav">
        <button class="btn-skip" id="btnSkip">Skip</button>
        <button class="btn-next" id="btnIntroNext">Continue →</button>
    </div>
</div>
<!-- GAME SCREEN -->
<div id="gameScreen">
    <div class="top-bar">
        <div class="top-bar-header">
            <div class="top-bar-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="Logo">
            </div>
            <div class="top-bar-stats" id="topStats"></div>
            <button class="btn-next-stage" id="btnNextStage">Complete Stage →</button>
        </div>
        <div class="timeline-container">
            <div class="timeline-track">
                <div class="timeline-progress" id="timelineProgress"></div>
            </div>
            <div class="timeline-stages" id="timelineStages">
                <div class="timeline-stage current" data-stage="1">
                    <div class="timeline-node">1</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2025</div>
                        <div class="timeline-name">Design</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="2">
                    <div class="timeline-node">2</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2040</div>
                        <div class="timeline-name">Maintenance</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="3">
                    <div class="timeline-node">3</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2055</div>
                        <div class="timeline-name">Inspection</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="4">
                    <div class="timeline-node">4</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2070</div>
                        <div class="timeline-name">Operations</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="5">
                    <div class="timeline-node">5</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2085</div>
                        <div class="timeline-name">Decommission</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="character-banner" id="characterBanner">
        <div class="char-portrait" id="charPortrait">👷</div>
        <div class="char-info">
            <h4 id="charName">Dave Morton</h4>
            <p class="char-role" id="charRole">Maintenance Supervisor</p>
        </div>
    </div>
    <div class="map-container" id="mapContainer">
        <div class="map-wrapper">
            <img src="images/gamebackground.png" alt="Section 4B">
            <div class="hotspot" data-element="pumpAccess" style="left: 31.2805%; top: 36.4431%;">
                <div class="hotspot-square" id="square-pumpAccess">
                    <span class="hotspot-square-label">Pump Access</span>
                </div>
            </div>
            <div class="hotspot" data-element="weldClearance" style="left: 45.9839%; top: 23.9149%;">
                <div class="hotspot-square" id="square-weldClearance">
                    <span class="hotspot-square-label">Weld Clearance</span>
                </div>
            </div>
            <div class="hotspot" data-element="controlPanel" style="left: 80.1562%; top: 45.332%;">
                <div class="hotspot-square" id="square-controlPanel">
                    <span class="hotspot-square-label">Control Panel</span>
                </div>
            </div>
            <div class="hotspot" data-element="pipeConnections" style="left: 46.156%; top: 56.1654%;">
                <div class="hotspot-square" id="square-pipeConnections">
                    <span class="hotspot-square-label">Pipe Connections</span>
                </div>
            </div>
            <div class="hotspot" data-element="pipeRouting" style="left: 56.4526%; top: 80.332%;">
                <div class="hotspot-square" id="square-pipeRouting">
                    <span class="hotspot-square-label">Pipe Routing</span>
                </div>
            </div>
            <div class="hotspot" data-element="materialSpec" style="left: 65.2808%; top: 40.4991%;">
                <div class="hotspot-square" id="square-materialSpec">
                    <span class="hotspot-square-label">Material Spec</span>
                </div>
            </div>
        </div>
    </div>
    <div class="bottom-bar">
        <span class="progress-label" id="progressLabel">0 of 6 complete</span>
    </div>
</div>
<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Element</h3>
            <button class="modal-close" id="modalClose">×</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>
<!-- TRANSITION SCREEN (Phase Introduction) -->
<div class="overlay-screen" id="transitionScreen">
    <div class="overlay-content">
        <div class="phase-intro">
            <p class="phase-years-label" id="transYears">15 YEARS LATER</p>
            <h2 class="phase-year-big" id="transYear">2040</h2>
            <div class="phase-visual" id="transVisual">
                <span class="phase-visual-icon">🔧</span>
            </div>
            <div class="phase-name-badge" id="transPhaseName">MAINTENANCE</div>
            <div class="phase-context" id="transText"></div>
            <button class="btn-continue" id="btnTransContinue">Begin Phase →</button>
        </div>
    </div>
</div>
<!-- SUMMARY SCREEN (End of Phase) -->
<div class="overlay-screen" id="summaryScreen">
    <div class="overlay-content">
        <div class="summary-header">
            <p class="summary-phase-complete">✓ PHASE COMPLETE</p>
            <h2 class="summary-title" id="sumTitle">Stage Complete</h2>
            <p class="summary-subtitle" id="sumSubtitle"></p>
        </div>
        <div class="summary-stats" id="sumStats"></div>
        <div class="summary-section-title">Your Decisions This Phase</div>
        <div class="summary-decisions" id="sumDecisions"></div>
        <div class="summary-insight" id="sumInsight">
            <div class="insight-icon">💡</div>
            <div class="insight-text" id="insightText"></div>
        </div>
        <div class="summary-actions">
            <button class="btn-next-phase" id="btnNextPhase">Continue →</button>
        </div>
    </div>
</div>
<!-- STORY TRANSITION SCREEN -->
<div class="story-transition" id="storyTransition">
    <div class="story-content">
        <div class="story-hero">
            <div class="story-phase-complete" id="storyPhaseLabel">Design Phase Complete</div>
            <div class="story-title" id="storyTitle">Your Designs Are Now Set In Concrete</div>
            <div class="story-years">
                <span class="year" id="storyYearFrom">2025</span>
                <span class="arrow">→</span>
                <span class="year" id="storyYearTo">2040</span>
            </div>
        </div>
        <div class="story-narrative" id="storyNarrative"></div>
        <div class="story-section">
            <div class="story-section-header">
                <div class="story-section-icon lessons">📚</div>
                <div class="story-section-title">Key Lessons</div>
            </div>
            <div class="story-lessons" id="storyLessons"></div>
        </div>
        <div class="story-section">
            <div class="story-section-header">
                <div class="story-section-icon regulatory">📋</div>
                <div class="story-section-title">Regulatory Framework</div>
            </div>
            <div class="story-regulatory" id="storyRegulatory"></div>
        </div>
        <div class="story-foreshadow" id="storyForeshadow"></div>
        <div class="story-continue">
            <button class="btn btn-primary" id="btnStoryNext">Begin 2040: MAINTENANCE →</button>
        </div>
    </div>
</div>
<!-- RESULTS SCREEN -->
<div class="overlay-screen" id="resultsScreen">
    <div class="overlay-content">
        <div id="finalReportContent"></div>
        <div class="report-actions">
            <button class="btn-continue" onclick="location.reload()">Play Again</button>
        </div>
    </div>
</div>
<script>
// ============================================
// GAME DATA - ALL STAGES HAVE DECISIONS
// Good design = easy/cheap options
// Poor design = hard/expensive options
// ============================================
const GAME_DATA = {
    stages: {
        1: { name: 'DESIGN', year: 2025, budget: 800000, bg: 'images/bg_design.png' },
        2: { name: 'MAINTENANCE', year: 2040, budget: 400000, time: 30, char: 'dave', bg: 'images/bg_maintenance.png' },
        3: { name: 'INSPECTION', year: 2055, budget: 250000, time: 21, char: 'sarah', bg: 'images/bg_inspection.png' },
        4: { name: 'OPERATIONS', year: 2070, budget: 200000, time: 7, char: 'mike', bg: 'images/bg_operations.png' },
        5: { name: 'DECOMMISSIONING', year: 2085, budget: 1200000, time: 90, char: 'janet', bg: 'images/bg_decom.png' }
    },
    characters: {
        dave: { name: 'Dave Morton', role: 'Maintenance Supervisor', emoji: '👷', image: 'images/dave.png' },
        sarah: { name: 'Sarah Okonkwo', role: 'Principal Inspector', emoji: '🔍', image: 'images/sarah.png' },
        mike: { name: 'Mike Brennan', role: 'Shift Operations Manager', emoji: '👨‍💼', image: 'images/mike.png' },
        janet: { name: 'Janet Cole', role: 'Decommissioning Lead', emoji: '👩‍🔧', image: 'images/janet.png' }
    },
    transitions: {
        2: { 
            years: '15 YEARS LATER', 
            year: '2040', 
            phaseName: 'MAINTENANCE',
            icon: '🔧',
            text: [
                'Thornbury Point has been generating power for 14 years.',
                'Your design drawings are yellowed paper in a filing cabinet.',
                'It\'s time for the first major maintenance outage.'
            ] 
        },
        3: { 
            years: '15 YEARS LATER', 
            year: '2055',
            phaseName: 'INSPECTION',
            icon: '🔍',
            text: [
                'Thirty years of operation.',
                'Regulators want proof everything is still safe.',
                'Every weld, every component needs inspection.'
            ] 
        },
        4: { 
            years: '15 YEARS LATER', 
            year: '2070',
            phaseName: 'OPERATIONS',
            icon: '⚡',
            text: [
                'Forty-five years. The plant is showing its age.',
                'Tonight, the alarms will test your control room design.',
                'How well did you plan for this moment?'
            ] 
        },
        5: { 
            years: '15 YEARS LATER', 
            year: '2085',
            phaseName: 'DECOMMISSIONING',
            icon: '🏗️',
            text: [
                'Sixty years. The reactor is shut down for good.',
                'Now comes the hard part: taking it all apart safely.',
                'Every design decision will be tested one final time.'
            ] 
        }
    },
    storyTransitions: {
        1: {
            yearsLabel: '2025',
            title: 'Design Phase Complete',
            narrative: [
                'Your design specifications have been approved and construction begins. Over the next decade, thousands of workers will transform your drawings into a functioning nuclear power station.',
                'The choices you made about pump positions, weld clearances, control panel layouts, pipe connections, pipe routing, and material specifications are now literally set in concrete.',
                'In 2026, Thornbury Point achieves first criticality. By 2027, it reaches full power operation and begins supplying electricity to millions of homes.',
                'For the next 14 years, the plant runs smoothly. Operators become familiar with the control room layout. Maintenance teams learn the quirks of accessing equipment. Your design decisions fade from memory - but they remain embedded in every wall, every pipe, every component.'
            ],
            lessons: [
                'Design decisions made today will affect workers for 60+ years',
                'Saving money during design often creates larger costs during operation',
                'Access for maintenance and inspection must be considered from day one — Davis-Besse (2002) showed how inspection access limitations allowed undetected corrosion to nearly breach the reactor vessel head',
                'Human factors in control room design can mean the difference between safe response and disaster',
                'Material specifications affect dose rates for the entire plant lifetime',
                'Radiological zoning decisions at design stage affect dose uptake, PPE requirements, and waste classification for the entire plant lifecycle — separating clean and controlled areas is far cheaper during design than retrofit'
            ],
            regulatory: [
                { code: 'LC 14', text: 'Safety Case - The design must demonstrate that risks are reduced As Low As Reasonably Practicable (ALARP). Your design choices form the basis of the safety case.' },
                { code: 'LC 17', text: 'Quality Assurance - Design decisions must be documented and traceable. Future modifications will reference your original specifications.' },
                { code: 'SAP EKP.2', text: 'Defence in Depth - Multiple barriers and safety systems must be incorporated at the design stage. Retrofit is difficult and expensive.' },
                { code: 'SAP EHF.1', text: 'Human Factors Integration - The design must consider human capabilities and limitations throughout the facility lifecycle.' }
            ],
            foreshadow: 'It is now 2040. Dave Morton, Maintenance Supervisor, is preparing for the first major outage. He\'s about to discover whether your design choices made his job easy... or impossible.'
        },
        2: {
            yearsLabel: '2025 → 2040',
            title: '15 Years of Operation',
            narrative: [
                'The maintenance outage is complete. Dave Morton\'s team has replaced seals, repaired welds, and addressed 15 years of wear and tear.',
                'Some jobs went smoothly - equipment was accessible, clearances were adequate, work could proceed efficiently. Other jobs were nightmares - pumps that didn\'t fit through access routes, welds in positions too tight for proper technique, contaminated scaffolding that should never have been installed.',
                'The costs and doses from this outage are now part of the plant\'s permanent record. They will be reviewed by regulators, analysed by safety committees, and compared against predictions made during design.',
                'As the plant returns to power generation, another 15 years of operation begins. Components continue to age. Corrosion advances. Fatigue cycles accumulate.'
            ],
            lessons: [
                'Licence Condition 28 requires adequate arrangements for examination, inspection, and maintenance',
                'Access constraints identified during design become real obstacles during maintenance',
                'Dose expenditure during maintenance must be justified under ALARP principles',
                'Temporary fixes and deferred work create future technical debt',
                'Good design enables standard procedures; poor design forces expensive workarounds'
            ],
            regulatory: [
                { code: 'LC 28', text: 'Examination, Inspection, Maintenance & Testing - The licensee must make adequate arrangements for regular and systematic examination, inspection, maintenance and testing of all plant. Your design choices directly affect what "adequate" means in practice.' },
                { code: 'LC 25', text: 'Operational Records - All maintenance work, dose uptake, and defects discovered must be recorded. These records inform future safety cases.' },
                { code: 'SAP EMT.1', text: 'Maintenance Strategy - Facilities should be designed so that structures, systems and components can be maintained to preserve their safety functions.' },
                { code: 'IRR17 Reg.9', text: 'Restriction of Exposure - Employers must ensure doses are kept As Low As Reasonably Practicable. Poor access = higher doses.' }
            ],
            foreshadow: 'It is now 2055. Sarah Okonkwo, Principal Inspector from ONR, is arriving for the 30-year Periodic Safety Review. She will examine every safety-critical component - if she can access them.'
        },
        3: {
            yearsLabel: '2040 → 2055',
            title: '30-Year Periodic Safety Review',
            narrative: [
                'The inspection programme is complete. Every pipe, weld, and component has been examined - or at least, every one that could be accessed.',
                'Sarah Okonkwo\'s report will determine whether Thornbury Point can continue operating. Where inspections achieved full coverage, there is confidence in continued safe operation. Where access limitations prevented complete examination, there are regulatory findings and operational restrictions.',
                'The inspection results reveal the true quality of your 2025 design. Good clearances enabled complete inspections. Embedded pipes and inadequate access have created zones of uncertainty that will require ongoing monitoring or costly retrofits.',
                'Regulators have noted every inspection gap. Some will require enhanced surveillance. Others may limit future operating parameters. The worst cases could force early shutdown.'
            ],
            lessons: [
                'In-Service Inspection requirements are defined by design codes and regulatory expectations',
                'Inspection gaps create uncertainty in safety cases and regulatory concern — regulators require positive evidence of safety, not absence of observed failure',
                'The Periodic Safety Review at 10-year intervals assesses continued safe operation',
                'Materials that cannot be inspected create ongoing liability',
                'Retrofitting access is extremely expensive compared to designing it correctly',
                'Sellafield legacy facilities demonstrate how embedded services and inaccessible areas create decommissioning challenges lasting decades beyond operational life'
            ],
            regulatory: [
                { code: 'LC 28', text: 'ONR expects in-service inspection programmes to demonstrate continued structural integrity through regular and systematic examination. Gaps in coverage must be justified in the safety case.' },
                { code: 'SAP EAD.1', text: 'Ageing and Degradation - Structures, systems and components important to safety should be designed to minimise the effects of ageing and to facilitate inspection.' },
                { code: 'SAP EMT.6', text: 'Inspectability - All structures, systems and components important to safety should be designed and located so they can be adequately inspected throughout operational life and during decommissioning.' },
                { code: 'NS-TAST-GD-026', text: 'ONR Technical Assessment Guide on In-Service Inspection - The design should ensure that ISI can be performed to relevant codes and standards.' }
            ],
            foreshadow: 'It is now 2070. Mike Brennan is the night Shift Operations Manager. At 3am, the alarms begin. Everything depends on whether operators can find the right controls, fast.'
        },
        4: {
            yearsLabel: '2055 → 2070',
            title: '45 Years: Operations Under Pressure',
            narrative: [
                'The emergency is over. Whether it was handled smoothly or chaotically depended on design decisions made 45 years ago.',
                'A well-designed control panel meant operators found the right controls instantly. A poorly designed panel meant confusion, delay, and near-misses during the most critical moments.',
                'The plant is now entering its final 15 years of operation. Equipment that has run for 45 years is showing its age. Dose rates from activated materials constrain work planning. Systems that were state-of-the-art in 2025 are now obsolete.',
                'Every decision made during design, maintenance, and inspection is now compounded. Good decisions have built a safe, efficient operation. Poor decisions have accumulated into operational constraints, regulatory scrutiny, and additional risk.'
            ],
            lessons: [
                'Human factors engineering in control rooms directly affects emergency response',
                'Operator confusion during emergencies can be fatal — TMI-2 (1979) demonstrated how ambiguous valve status indication and poor panel layout contributed to operators misdiagnosing plant conditions for hours',
                'Material activation affects operational flexibility for the entire plant life',
                'Deferred maintenance and inspection gaps can culminate in operational emergencies',
                'Long-term operation requires continuous demonstration that ageing is being managed'
            ],
            regulatory: [
                { code: 'LC 23', text: 'Operating Rules - Operations must be conducted within approved limits. Design constraints become operating rule requirements.' },
                { code: 'LC 24', text: 'Operating Instructions - Clear instructions must exist for all operations. Confusing control layouts make instructions harder to follow.' },
                { code: 'SAP EHF.5', text: 'Human Reliability - Design should reduce opportunities for human error, particularly during abnormal conditions and emergencies.' },
                { code: 'SAP SC.5', text: 'Safety Culture - A questioning attitude and conservative decision-making depend on operators having clear, unambiguous information.' }
            ],
            foreshadow: 'It is now 2085. The reactor is shut down for good. Janet Cole leads the decommissioning programme. Sixty years of neutron activation, contamination buildup, and ageing infrastructure await. The design choices of 2025 will determine whether decommissioning takes 10 years or 50.'
        },
        5: {
            yearsLabel: '2085',
            title: 'The 60-Year Journey Complete',
            narrative: [
                'Thornbury Point is being dismantled. The reactor that began as lines on your drawing board in 2025 is returning to the ground from which its materials came.',
                'Every decision you made during design echoed through six decades of operation. Some choices saved millions of pounds and countless worker-hours. Others created problems that compounded across maintenance outages, inspection campaigns, operational emergencies, and now decommissioning.',
                'The workers who lived with your decisions - Dave fixing pumps, Sarah inspecting welds, Mike responding to alarms, Janet cutting contaminated pipes - they all experienced the consequences of choices made before most of them were born.',
                'This is the reality of nuclear engineering. The decisions made today will affect workers, communities, and the environment for generations. There are no shortcuts, no quick fixes, and no second chances once the concrete is poured.'
            ],
            lessons: [
                'Nuclear facilities operate for 60+ years - design must consider the entire lifecycle',
                'Short-term savings often become long-term costs multiplied many times over',
                'Access, materials, and human factors affect every phase from construction to decommissioning',
                'Regulatory requirements exist because lessons were learned from past failures',
                'The true cost of design is not the construction budget - it is the total lifecycle cost'
            ],
            regulatory: [
                { code: 'ONR Purpose', text: 'The Office for Nuclear Regulation exists to protect society by securing safe nuclear operations. Your design choices directly affect their ability to do this.' },
                { code: 'ALARP', text: 'Risks must be reduced As Low As Reasonably Practicable. Good design makes ALARP achievable; poor design makes it expensive or impossible.' },
                { code: 'Lifecycle', text: 'Modern regulatory frameworks require consideration of the full facility lifecycle at the design stage - construction, operation, and decommissioning.' },
                { code: 'Future', text: 'Every new nuclear facility will face the same 60-year journey. The lessons from Thornbury Point should inform the designs of tomorrow.' }
            ],
            foreshadow: 'Your journey through 60 years of nuclear operations is complete. Let\'s see how your choices measured up across the full lifecycle of Thornbury Point.'
        }
    },
    elements: {
        // ==========================================
        // ELEMENT 1: PUMP ACCESS
        // ==========================================
        pumpAccess: {
            title: 'Pump Location/Access',
            stage1: {
                description: 'How should the primary coolant pump be positioned?',
                options: [
                    { id: 'corner', name: 'Corner Position', desc: 'Tucked in corner to maximise floor space. 1.8m clearance — insufficient for pump plus rigging tackle and lifting equipment.', cost: 80000, quality: 'poor', image: 'images/01_Pump_01.png' },
                    { id: 'openBay', name: 'Open Bay', desc: 'Industry standard: 2m clearance all sides accounts for rigging equipment and lifting tackle, not just pump dimensions. Under crane rails.', cost: 120000, quality: 'good', image: 'images/01_Pump_02.png' },
                    { id: 'dedicated', name: 'Dedicated Shielded Room', desc: 'Separate room with airlock. Extra structure must also be decommissioned later.', cost: 200000, quality: 'wasteful', image: 'images/01_Pump_03.png' }
                ]
            },
            // =====================================
            // STAGE 2: MAINTENANCE
            // =====================================
            stage2: {
                corner: {
                    situation: 'RCP seal replacement required. The pump is 2.1m wide but the corner position only provides 1.8m clearance. It physically cannot be removed through the access route.',
                    quote: "Boss, we've got a problem. That corner position from the 2025 design - the pump doesn't fit through the gap. Whoever signed off on 1.8m clearance for a 2.1m pump... anyway, what do you want us to do?",
                    options: [
                        { 
                            id: 'modify', 
                            name: 'Cut a larger access opening', 
                            desc: 'Permanently modify the wall structure to create adequate access. Fixes the problem for good.', 
                            cost: 120000, time: 14, dose: 4,
                            setState: { accessFixed: true }
                        },
                        { 
                            id: 'subcontract', 
                            name: 'Hire specialist rigging team', 
                            desc: 'Bring in experts with hydraulic jacks and custom rigging to work around the constraint. Problem remains for next time.', 
                            cost: 180000, time: 18, dose: 3,
                            setState: { workaroundUsed: true }
                        },
                        { 
                            id: 'force', 
                            name: 'Attempt to tilt and manoeuvre through', 
                            desc: 'Try to angle the pump through the gap. Risky - may damage pump casing.', 
                            cost: 40000, time: 5, dose: 6, risk: 70,
                            setState: { deteriorating: true },
                            failState: { deteriorating: true, damageCaused: true }
                        }
                    ]
                },
                openBay: {
                    situation: 'RCP seal replacement required. The pump is positioned in the open bay with 2m clearance and full crane coverage.',
                    quote: "Good news - that open bay layout from 2025 is paying off. We've got full crane access, plenty of clearance. Standard lift operation. Just need your sign-off on the approach.",
                    options: [
                        { id: 'standard', name: 'Standard crane lift', desc: 'Routine lift operation. Remove pump, replace seals, reinstall.', cost: 25000, time: 3, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced procedure with extra inspections', desc: 'While the pump is out, conduct additional inspections of the mounting and surrounding area.', cost: 40000, time: 4, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'RCP seal replacement required. The pump is in a dedicated shielded room with airlock system.',
                    quote: "The pump room from 2025 - it's accessible, but this airlock system adds a lot of complexity. We need full contamination protocols just to get in there. Did we really need all this shielding for a coolant pump?",
                    options: [
                        { 
                            id: 'airlock', 
                            name: 'Full airlock protocol', 
                            desc: 'Follow complete airlock entry and exit procedures as designed.', 
                            cost: 45000, time: 6, dose: 2,
                            setState: { airlockMaintained: true }
                        },
                        { 
                            id: 'bypass', 
                            name: 'Temporary airlock bypass', 
                            desc: 'Faster access but requires additional contamination control paperwork.', 
                            cost: 35000, time: 4, dose: 2.5,
                            setState: { airlockBypassed: true }
                        }
                    ]
                }
            },
            // =====================================
            // STAGE 3: INSPECTION - Checks Stage 2 state
            // =====================================
            stage3: {
                corner: {
                    checkElementState: true,
                    scenarios: {
                        // They fixed the access in 2040
                        accessFixed: {
                            situation: 'Pump casing and mounting bolts require ultrasonic inspection. The access opening you cut in 2040 provides adequate clearance for probe positioning.',
                            quote: "Good call cutting that access opening back in 2040. I can actually get my UT probes in at the right angles now. Full coverage is possible. What level of inspection do you want?",
                            options: [
                                { id: 'standard', name: 'Standard UT inspection', desc: 'Full coverage with standard equipment.', cost: 20000, time: 3, dose: 1.5 },
                                { id: 'enhanced', name: 'Enhanced inspection with TOFD', desc: 'Additional Time-of-Flight Diffraction for better defect sizing.', cost: 30000, time: 4, dose: 2 }
                            ]
                        },
                        // They used a workaround - problem remains
                        workaroundUsed: {
                            situation: 'Pump casing inspection required. The corner position from 2025 was never permanently fixed - the specialist rigging in 2040 was just a workaround. Access is still constrained.',
                            quote: "Same problem as 2040. That corner position was never properly fixed - we just worked around it. Now I can't get my probes in at the right angle. We need to decide: fix it now, or accept the gaps?",
                            options: [
                                { 
                                    id: 'platform', 
                                    name: 'Install permanent access platform', 
                                    desc: 'Finally fix the access problem. Enables full inspection coverage for remaining plant life.', 
                                    cost: 120000, time: 12, dose: 2,
                                    setState: { accessFixed: true }
                                },
                                { 
                                    id: 'partial', 
                                    name: 'Scaffold and use angled probes', 
                                    desc: 'Achieves ~60% coverage. Uninspected areas must be justified in the safety case — regulators require positive evidence of safety.', 
                                    cost: 45000, time: 5, dose: 3,
                                    setState: { inspectionGap: true }
                                },
                                { 
                                    id: 'accept', 
                                    name: 'Accept inspection limitation', 
                                    desc: 'Mark areas as "inaccessible" in report. Inspection gaps must be justified in safety case — absence of observed failure is not evidence of safety.', 
                                    cost: 5000, time: 1, dose: 0.5, healthImpact: -10,
                                    setState: { inspectionGap: true }
                                }
                            ]
                        },
                        // They tried to force it and caused damage
                        deteriorating: {
                            situation: 'Pump inspection urgently required. The forced removal attempt in 2040 caused damage that has been worsening. Access remains impossible.',
                            quote: "This is getting serious. That forced removal in 2040 - we damaged something and it's been getting worse. Vibrations are up 40%. And we STILL can't get proper access because the corner position was never fixed. We need to act.",
                            options: [
                                { 
                                    id: 'emergency', 
                                    name: 'Emergency retrofit and repair', 
                                    desc: 'Cut new access, conduct full inspection, repair damage from 2040.', 
                                    cost: 180000, time: 20, dose: 5,
                                    setState: { accessFixed: true, deteriorating: false }
                                },
                                { 
                                    id: 'monitor', 
                                    name: 'Enhanced monitoring only', 
                                    desc: 'Install more sensors. Hope we catch problems before failure. Very risky.', 
                                    cost: 30000, time: 3, dose: 1, healthImpact: -15,
                                    setState: { inspectionGap: true }
                                }
                            ]
                        },
                        // Default if no specific state (shouldn't happen)
                        default: {
                            situation: 'Pump inspection required. The corner position continues to create access challenges.',
                            quote: "That corner position from 2025 - still causing headaches for inspection access. What's the plan?",
                            options: [
                                { id: 'scaffold', name: 'Erect scaffolding', desc: 'Partial coverage achievable.', cost: 45000, time: 5, dose: 3, setState: { inspectionGap: true } },
                                { id: 'retrofit', name: 'Install permanent platform', desc: 'Fix the access problem permanently.', cost: 120000, time: 12, dose: 2, setState: { accessFixed: true } }
                            ]
                        }
                    }
                },
                openBay: {
                    situation: 'Pump casing and mounting bolts require ultrasonic inspection. The open bay provides excellent access from all angles.',
                    quote: "That open bay design from 2025 - brilliant. I've got full access all around the pump. Can get my probes in at every angle needed. Standard inspection or do you want the enhanced coverage?",
                    options: [
                        { id: 'standard', name: 'Standard UT inspection', desc: 'Full coverage with standard equipment. Meets all requirements.', cost: 15000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced inspection with TOFD', desc: 'Additional Time-of-Flight Diffraction technique for better defect sizing.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                dedicated: {
                    checkElementState: true,
                    scenarios: {
                        airlockMaintained: {
                            situation: 'Pump inspection required. Good access once inside the room. Airlock system has been properly maintained.',
                            quote: "Pump room airlock is working properly - we've been following protocols since 2040. Good access once I'm inside. Standard inspection approach?",
                            options: [
                                { id: 'standard', name: 'Standard inspection with airlock', desc: 'Full entry/exit protocols.', cost: 25000, time: 4, dose: 1.5 },
                                { id: 'extended', name: 'Extended single-entry inspection', desc: 'Do more in one access to minimise entries.', cost: 35000, time: 5, dose: 2 }
                            ]
                        },
                        airlockBypassed: {
                            situation: 'Pump inspection required. The airlock was bypassed in 2040, and contamination controls have been compromised since.',
                            quote: "Remember that airlock bypass in 2040? The contamination has spread. Room's messier than it should be. My team will need extra protection. This is going to be slow and expensive.",
                            options: [
                                { 
                                    id: 'contaminated', 
                                    name: 'Inspection with enhanced protection', 
                                    desc: 'Full PPE and decon procedures due to contamination spread.', 
                                    cost: 55000, time: 7, dose: 4 
                                },
                                { 
                                    id: 'clean', 
                                    name: 'Clean room first, then inspect', 
                                    desc: 'Decontaminate the area before inspection. More expensive but safer long-term.', 
                                    cost: 85000, time: 10, dose: 2,
                                    setState: { airlockMaintained: true, airlockBypassed: false }
                                }
                            ]
                        },
                        default: {
                            situation: 'Pump inspection required in dedicated room.',
                            quote: "Pump room access - standard airlock protocols apply.",
                            options: [
                                { id: 'standard', name: 'Standard inspection', desc: 'Follow entry/exit protocols.', cost: 25000, time: 4, dose: 1.5 }
                            ]
                        }
                    }
                }
            },
            // =====================================
            // STAGE 4: OPERATIONS - Checks cumulative state
            // =====================================
            stage4: {
                corner: {
                    checkElementState: true,
                    scenarios: {
                        // Access was fixed at some point - things are okay
                        accessFixed: {
                            situation: 'Pump operational review. The access was eventually fixed, and full inspection records are available.',
                            quote: "Pump's running well. That access opening we cut - it's let us maintain proper inspection records ever since. We know exactly what condition the pump's in. Just confirming the monitoring approach.",
                            options: [
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 10000, time: 0, dose: 0 },
                                { id: 'predictive', name: 'Predictive maintenance analysis', desc: 'Use our good historical data to optimise future maintenance.', cost: 25000, time: 1, dose: 0 }
                            ]
                        },
                        // Never fixed AND have inspection gaps - crisis
                        inspectionGap: {
                            situation: 'ALARM: 3am. Pump vibrations spiking. The vibration is coming from exactly the areas we could never properly inspect due to the corner position that was never fixed.',
                            quote: "It's 3am and we've got a serious problem. Pump vibrations are off the chart - and it's coming from exactly where we couldn't inspect. That corner position was never fixed, we've been flying blind for 30 years. What's the call, boss?",
                            options: [
                                { 
                                    id: 'shutdown', 
                                    name: 'Emergency shutdown', 
                                    desc: 'Trip the reactor. Safe but massive revenue loss and investigation required.', 
                                    cost: 200000, time: 7, dose: 3,
                                    setState: { emergencyOccurred: true }
                                },
                                { 
                                    id: 'reduce', 
                                    name: 'Reduce power to 50%', 
                                    desc: 'Lower stress on the pump. Monitor closely. Might stabilise, might not.', 
                                    cost: 50000, time: 0, dose: 0, risk: 40, healthImpact: -5 
                                },
                                { 
                                    id: 'continue', 
                                    name: 'Continue and monitor', 
                                    desc: 'It might be fine. Or the pump might fail catastrophically.', 
                                    cost: 0, time: 0, dose: 0, risk: 70, healthImpact: -20 
                                }
                            ]
                        },
                        // Deteriorating from 2040 damage - worse crisis
                        deteriorating: {
                            situation: 'CRITICAL ALARM. The pump damage from 2040 has progressed to imminent failure. Vibrations are extreme.',
                            quote: "CRITICAL. That damage from 2040 - we should have fixed it then. The pump's about to fail. We have minutes to decide, not hours. Trip the reactor or risk a LOCA.",
                            options: [
                                { 
                                    id: 'trip', 
                                    name: 'Emergency reactor trip', 
                                    desc: 'Immediate shutdown. Only safe option at this point.', 
                                    cost: 300000, time: 10, dose: 5, healthImpact: -10,
                                    setState: { emergencyOccurred: true, deteriorating: false }
                                },
                                { 
                                    id: 'gamble', 
                                    name: 'Attempt controlled runback', 
                                    desc: 'Try to reduce power gradually. Extremely risky.', 
                                    cost: 50000, time: 0, dose: 0, risk: 85, healthImpact: -30 
                                }
                            ]
                        },
                        default: {
                            situation: 'Pump operational review. Corner position continues to limit options.',
                            quote: "That corner position from 2025 still limits our monitoring options. Vibrations are within range but I'm not confident in our coverage.",
                            options: [
                                { id: 'enhanced', name: 'Enhanced monitoring', desc: 'Install additional sensors.', cost: 30000, time: 1, dose: 0 },
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 10000, time: 0, dose: 0 }
                            ]
                        }
                    }
                },
                openBay: {
                    situation: 'Pump operational review. All parameters nominal. Full inspection history available from good access over the years.',
                    quote: "Pump running perfectly. That open bay design from 2025 has given us complete inspection records over the years - we know exactly what condition it's in. No concerns here. Just confirming the monitoring approach.",
                    options: [
                        { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance programme.', cost: 5000, time: 0, dose: 0 },
                        { id: 'predictive', name: 'Predictive maintenance analysis', desc: 'Use historical data to optimise timing of next maintenance.', cost: 15000, time: 0, dose: 0 }
                    ]
                },
                dedicated: {
                    checkElementState: true,
                    scenarios: {
                        airlockMaintained: {
                            situation: 'Pump operational review. Pump and airlock system both running well.',
                            quote: "Pump's fine, airlock's been properly maintained since 2040. Extra maintenance overhead but no issues. Standard checks?",
                            options: [
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 15000, time: 0, dose: 0 },
                                { id: 'service', name: 'Full airlock service', desc: 'Preventive maintenance on airlock seals.', cost: 35000, time: 2, dose: 0.5 }
                            ]
                        },
                        airlockBypassed: {
                            situation: 'Pump running but room contamination from 2040 bypass continues to cause problems.',
                            quote: "That bypass in 2040 keeps haunting us. The room's contamination makes every entry expensive. We should really sort this out before decommissioning.",
                            options: [
                                { 
                                    id: 'cleanup', 
                                    name: 'Major decontamination', 
                                    desc: 'Clean the room properly. High cost now, saves money later.', 
                                    cost: 100000, time: 8, dose: 3,
                                    setState: { airlockMaintained: true, airlockBypassed: false }
                                },
                                { id: 'defer', name: 'Defer to decommissioning', desc: 'Live with it until end of life.', cost: 20000, time: 1, dose: 1 }
                            ]
                        },
                        default: {
                            situation: 'Pump operational review in dedicated room.',
                            quote: "Pump room status check. Systems nominal.",
                            options: [
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance.', cost: 15000, time: 0, dose: 0 }
                            ]
                        }
                    }
                }
            },
            // =====================================
            // STAGE 5: DECOMMISSIONING - Final consequences
            // =====================================
            stage5: {
                corner: {
                    checkElementState: true,
                    scenarios: {
                        // Access was fixed - manageable
                        accessFixed: {
                            situation: 'Pump removal for decommissioning. The access opening cut earlier makes removal possible, though not as easy as proper design would have been.',
                            quote: "At least we fixed the access at some point. Not as clean as a proper open bay design would have been, but we can get the pump out through the modified opening. Options for removal?",
                            options: [
                                { id: 'standard', name: 'Standard removal via modified access', desc: 'Use the access opening to remove pump intact.', cost: 45000, time: 8, dose: 3 },
                                { id: 'segmented', name: 'Segment for easier handling', desc: 'Cut pump into sections for removal.', cost: 60000, time: 12, dose: 2 }
                            ]
                        },
                        // Never fixed, but no emergency - expensive removal
                        inspectionGap: {
                            situation: 'Pump removal for decommissioning. The corner position was never fixed - same problem as 2040, sixty years later.',
                            quote: "Sixty years and we're back to the same problem. Corner position, pump doesn't fit. We got away with it operationally, but now we have to get this thing out somehow.",
                            options: [
                                { id: 'demolish', name: 'Demolish wall section', desc: 'Remove the concrete to create access.', cost: 115000, time: 18, dose: 5 },
                                { id: 'cut', name: 'Cut pump in-situ', desc: 'Segment the pump in the confined space.', cost: 90000, time: 25, dose: 10 },
                                { id: 'robot', name: 'Robotic cutting system', desc: 'Remote cutting minimises dose but expensive.', cost: 280000, time: 12, dose: 1.5 }
                            ]
                        },
                        // Had an emergency - pump may already be damaged/isolated
                        emergencyOccurred: {
                            situation: 'Pump decommissioning following the operational emergency. The pump was isolated after the incident and has been sitting inactive.',
                            quote: "This pump's been sitting here since that emergency. Not sure what state it's in internally. We need to be careful - could be damaged, could be fine. Still got that access problem too.",
                            options: [
                                { 
                                    id: 'careful', 
                                    name: 'Careful characterisation first', 
                                    desc: 'Full assessment before removal. Slower but safer.', 
                                    cost: 145000, time: 22, dose: 4 
                                },
                                { id: 'remote', name: 'Full remote handling', desc: 'Assume worst case, use robotics throughout.', cost: 360000, time: 15, dose: 0.5 }
                            ]
                        },
                        // Catastrophic - major contamination
                        deteriorating: {
                            situation: 'Pump decommissioning following catastrophic failure. Major contamination in the area. Remote handling mandatory.',
                            quote: "That pump failure contaminated the whole area. We're in full remote handling territory. This is going to take years and cost a fortune. The 2025 corner position plus the 2040 damage plus 2070... it all adds up.",
                            options: [
                                { id: 'remote', name: 'Full remote decommissioning', desc: 'Robotics only. No personnel entry possible.', cost: 580000, time: 36, dose: 2, healthImpact: -10 },
                                { id: 'encapsulate', name: 'Encapsulate and defer', desc: 'Seal the area for future generations to deal with.', cost: 220000, time: 12, dose: 1, healthImpact: -20 }
                            ]
                        },
                        default: {
                            situation: 'Pump removal for decommissioning. Corner access remains a challenge - inadequate clearance for lift-out.',
                            quote: "Industry guidance is clear: provide adequate clearance and crane access for component removal. That corner position from 2025 ignored it. Now we're paying - literally - for that decision.",
                            options: [
                                { id: 'demolish', name: 'Demolish wall', desc: 'Create access by removing structure.', cost: 115000, time: 18, dose: 5 },
                                { id: 'cut', name: 'Cut in-situ', desc: 'Segment the pump in confined space.', cost: 90000, time: 25, dose: 10 }
                            ]
                        }
                    }
                },
                openBay: {
                    situation: 'Pump removal for decommissioning. Full crane access available - exactly as industry guidance recommends.',
                    quote: "This is textbook decommissioning. Open bay layout, crane rails overhead, adequate clearance - the 2025 design followed OECD best practice. Crane hooks on, pump lifts out. Sixty years later, it works exactly as intended.",
                    options: [
                        { id: 'standard', name: 'Standard crane removal', desc: 'Lift and containerise in one operation. Industry standard approach.', cost: 20000, time: 3, dose: 1 },
                        { id: 'segmented', name: 'Segmented removal for recycling', desc: 'Additional cutting to enable material segregation.', cost: 35000, time: 5, dose: 1.5 }
                    ]
                },
                dedicated: {
                    checkElementState: true,
                    scenarios: {
                        airlockMaintained: {
                            situation: 'Pump removal is straightforward, but the entire dedicated room structure must also be decommissioned - walls, airlock, shielding.',
                            quote: "The pump? Easy - lifts right out. But look at all this extra structure from 2025. Shielded walls, airlock, the lot. Industry guidance says minimise waste quantities - this room IS waste now. All of it has to come out, be characterised, disposed of. The pump didn't need this level of containment.",
                            options: [
                                { id: 'full', name: 'Full room decommissioning', desc: 'Remove pump and all unnecessary room structures.', cost: 120000, time: 10, dose: 2 },
                                { id: 'phased', name: 'Phased approach', desc: 'Pump first, room structure later.', cost: 140000, time: 14, dose: 2.5 }
                            ]
                        },
                        airlockBypassed: {
                            situation: 'Pump and room decommissioning complicated by contamination spread from the 2040 airlock bypass.',
                            quote: "That 2040 bypass spread contamination through the whole room. Now we're decommissioning contaminated structure that shouldn't have been there in the first place. Over-engineering created extra surfaces to contaminate.",
                            options: [
                                { id: 'full', name: 'Full decontamination and removal', desc: 'Clean everything, then remove.', cost: 200000, time: 18, dose: 4 },
                                { id: 'remote', name: 'Remote handling throughout', desc: 'Treat as high-contamination from the start.', cost: 280000, time: 15, dose: 1 }
                            ]
                        },
                        default: {
                            situation: 'Pump and dedicated room decommissioning. Extra structure creates additional waste.',
                            quote: "The pump is fine, but we've got all this unnecessary structure to deal with. That's the problem with over-engineering - it all becomes waste eventually.",
                            options: [
                                { id: 'full', name: 'Full decommissioning', desc: 'Remove pump and all room structures.', cost: 150000, time: 12, dose: 2 }
                            ]
                        }
                    }
                }
            }
        },
        // ==========================================
        // ELEMENT 2: WELD CLEARANCE
        // ==========================================
        weldClearance: {
            title: 'Weld Access Clearance',
            stage1: {
                description: 'What clearance around pipe welds for inspection access?',
                options: [
                    { id: '50mm', name: '50mm (Code Minimum)', desc: 'Meets code but just barely.', cost: 60000, quality: 'poor', image: 'images/03_Weld_01.png' },
                    { id: '150mm', name: '150mm Clearance', desc: 'Adequate for all standard probes.', cost: 90000, quality: 'good', image: 'images/03_Weld_02.png' },
                    { id: '300mm', name: '300mm + Permanent Scaffolding', desc: 'Maximum clearance with fixed platforms.', cost: 160000, quality: 'wasteful', image: 'images/03_Weld_03.png' }
                ]
            },
            stage2: {
                '50mm': {
                    situation: 'Weld W-247 shows crack indications. Your welder needs to grind out the defect, but standard grinder heads are 75mm diameter - they won\'t fit in the 50mm clearance from the 2025 design.',
                    quote: "Boss, we've got a problem with weld W-247. I need to grind out this crack, but my grinder head is 75mm and we've only got 50mm clearance. Can't get the angle for a proper prep. We need to think about this.",
                    options: [
                        { 
                            id: 'miniature', 
                            name: 'Procure miniature tooling', 
                            desc: 'Specialist 40mm grinder heads. Longer job, higher cost, but proper weld prep achievable.', 
                            cost: 65000, time: 8, dose: 3,
                            setState: { specialToolingUsed: true }
                        },
                        { 
                            id: 'platform', 
                            name: 'Install temporary access platform', 
                            desc: 'Create better working angle from above. Adds clearance for standard tools.', 
                            cost: 35000, time: 6, dose: 2,
                            setState: { clearanceImproved: true }
                        },
                        { 
                            id: 'overlay', 
                            name: 'Weld overlay from accessible side only', 
                            desc: 'Skip the grind-out. Overlay weld covers the defect but doesn\'t remove it. ASME Section XI allows this for limited situations, but 40% chance of rejection at next inspection.', 
                            cost: 25000, time: 3, dose: 4, risk: 40, healthImpact: -5,
                            setState: { deteriorating: true }
                        }
                    ]
                },
                '150mm': {
                    situation: 'Weld repair needed on pipe section. The 150mm clearance specified in 2025 provides adequate room for standard tooling per ASME Section XI access requirements.',
                    quote: "Found a weld that needs attention - small indication in W-312. Good news is that 150mm clearance from 2025 - exactly what the codes recommend. My grinder fits, I can get proper probe angles. Standard repair or enhanced treatment?",
                    options: [
                        { id: 'standard', name: 'Standard weld repair', desc: 'Grind out, re-weld, UT verify. Normal ASME Section XI procedure.', cost: 20000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced repair with PWHT', desc: 'Post-weld heat treatment reduces residual stress. Better long-term performance.', cost: 30000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld repair needed. Plenty of clearance from the 2025 design, but the permanent scaffolding installed has accumulated surface contamination over 15 years.',
                    quote: "The 300mm clearance is great - plenty of room for any tooling. But that permanent scaffolding from 2025? It's picked up contamination. Surfaces reading 50 µSv/hr. We need to deal with that before working on the weld.",
                    options: [
                        { id: 'decon', name: 'Decontaminate scaffolding first', desc: 'Clean the surfaces to reduce dose during repair work.', cost: 30000, time: 4, dose: 2 },
                        { id: 'remove', name: 'Remove contaminated scaffolding sections', desc: 'Take out affected sections as LLW. Creates waste but clears the area.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                }
            },
            stage3: {
                '50mm': {
                    checkElementState: true,
                    scenarios: {
                        // They improved clearance in 2040
                        clearanceImproved: {
                            situation: 'In-Service Inspection of pipe welds due per ASME Section XI. The access platform installed in 2040 provides adequate probe positioning.',
                            quote: "That platform we put in during 2040 makes all the difference. I can position my 60° and 70° probes properly now - full volumetric coverage on all welds. Standard ISI or enhanced baseline?",
                            options: [
                                { id: 'standard', name: 'Standard UT examination', desc: 'Full coverage per ASME Section XI requirements.', cost: 18000, time: 3, dose: 1.5 },
                                { id: 'enhanced', name: 'Enhanced with phased array', desc: 'PAUT gives better defect characterisation. Worth the investment at midlife.', cost: 28000, time: 4, dose: 2 }
                            ]
                        },
                        // They used specialist tooling but didn't fix access
                        specialToolingUsed: {
                            situation: 'In-Service Inspection due. The miniature tooling in 2040 got the repair done, but the 50mm clearance remains - standard UT probes need 80mm minimum.',
                            quote: "Same clearance problem as 2040. My standard UT probe needs 80mm to get the refracted beam angles right - I've only got 50mm. I can use miniature phased array, but coverage will be limited. What's the call?",
                            options: [
                                { 
                                    id: 'miniprobe', 
                                    name: 'Miniature phased array inspection', 
                                    desc: 'Smaller 20mm aperture probes. Achieves ~70% coverage. Document limitations per ONR expectations.', 
                                    cost: 45000, time: 5, dose: 3,
                                    setState: { inspectionLimited: true }
                                },
                                { 
                                    id: 'excavate', 
                                    name: 'Create permanent access opening', 
                                    desc: 'Cut structural access that should have been designed in from the start. Full coverage thereafter.', 
                                    cost: 95000, time: 12, dose: 3,
                                    setState: { clearanceImproved: true, inspectionLimited: false }
                                },
                                { 
                                    id: 'accept', 
                                    name: 'Accept 50% coverage with standard probes', 
                                    desc: 'Document gaps in safety case. ONR will note this as deviation from EMT principles.', 
                                    cost: 8000, time: 2, dose: 2, healthImpact: -10,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        },
                        // They did the overlay weld - now it's deteriorating
                        deteriorating: {
                            situation: 'URGENT: The weld overlay from 2040 is showing indications. The underlying defect was never removed - it\'s grown. And you still can\'t get proper access.',
                            quote: "That overlay weld from 2040 - the one where we couldn't grind out the defect properly? It's showing crack growth. The original flaw is propagating under the overlay. We're in trouble and we STILL have only 50mm clearance.",
                            options: [
                                { 
                                    id: 'emergency', 
                                    name: 'Emergency cut-out and replacement', 
                                    desc: 'Remove entire weld section. Replace with new material. Create proper access while there.', 
                                    cost: 150000, time: 16, dose: 6,
                                    setState: { clearanceImproved: true, deteriorating: false }
                                },
                                { 
                                    id: 'second_overlay', 
                                    name: 'Second overlay and enhanced monitoring', 
                                    desc: 'Another band-aid. Install continuous acoustic monitoring. Regulatory pushback likely.', 
                                    cost: 40000, time: 4, dose: 4, healthImpact: -15,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        },
                        // Default if no specific state
                        default: {
                            situation: 'In-Service Inspection required. The 50mm clearance from 2025 limits UT probe positioning per ASME Section XI requirements.',
                            quote: "Standard probe needs 80mm minimum clearance for proper beam angles. We've got 50mm. I can try miniature equipment or we excavate for proper access.",
                            options: [
                                { id: 'miniprobe', name: 'Use miniature probes', desc: 'Limited coverage but achievable. Gaps must be justified in safety case.', cost: 40000, time: 5, dose: 3, setState: { inspectionLimited: true } },
                                { id: 'excavate', name: 'Create permanent access', desc: 'Fix the problem properly.', cost: 90000, time: 10, dose: 3, setState: { clearanceImproved: true } }
                            ]
                        }
                    }
                },
                '150mm': {
                    situation: 'In-Service Inspection of pipe welds per ASME Section XI. The 150mm clearance provides full probe access - exactly what the industry guidance recommends.',
                    quote: "Weld inspections due. That 150mm clearance from 2025 - textbook. I can position 45°, 60°, and 70° probes with full skip coverage. 100% volumetric examination achievable. Standard or enhanced?",
                    options: [
                        { id: 'standard', name: 'Standard UT examination', desc: '100% coverage with conventional UT per Section XI.', cost: 15000, time: 2, dose: 1 },
                        { id: 'phased', name: 'Phased array for enhanced detection', desc: 'PAUT with sector scanning. Better defect sizing and characterisation.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld inspection required. The permanent scaffolding from 2025 provides 360° access around the pipe - perfect for deploying robotic inspection equipment.',
                    quote: "This is the payoff from that 2025 investment. The scaffolding gives us full robot access - I can deploy the automated UT scanner and it'll do the whole circumference in one pass. Minimal dose to personnel, quick turnaround. Standard robot scan or comprehensive deep analysis?",
                    options: [
                        { id: 'robot_standard', name: 'Robotic Standard Inspection', desc: 'Automated 360° UT scan. Full coverage with minimal human exposure.', cost: 8000, time: 0.5, dose: 0.1 },
                        { id: 'robot_comprehensive', name: 'Robotic Deep Analysis', desc: 'Comprehensive volumetric scan with advanced defect characterisation.', cost: 15000, time: 1, dose: 0.2 }
                    ]
                }
            },
            stage4: {
                '50mm': {
                    checkElementState: true,
                    scenarios: {
                        // Inspection was limited - now we have a leak in an uninspected area
                        inspectionLimited: {
                            situation: '⚠️ LEAK ALARM: Weld W-247 - the location where inspection coverage was limited due to 50mm clearance. The area you couldn\'t fully examine is now leaking.',
                            quote: "Control room, 0300 hours. Leak alarm on W-247 - that's the weld we could only get 50-70% coverage on because of the 50mm clearance from 2025. If we'd had proper access, we'd have caught this developing. What's the call?",
                            options: [
                                { 
                                    id: 'shutdown', 
                                    name: 'Immediate shutdown for repair', 
                                    desc: 'Safe shutdown, proper repair. Significant outage and regulatory scrutiny.', 
                                    cost: 200000, time: 14, dose: 5,
                                    setState: { leakOccurred: true }
                                },
                                { 
                                    id: 'seal', 
                                    name: 'Online leak sealing clamp', 
                                    desc: 'Mechanical clamp over the leak. May hold, may not. 40% chance of escalation.', 
                                    cost: 50000, time: 2, dose: 2, risk: 40, healthImpact: -10,
                                    setState: { leakOccurred: true }
                                },
                                { 
                                    id: 'reduce', 
                                    name: 'Power reduction to 50%', 
                                    desc: 'Lower pressure reduces leak rate. Limp through to planned outage.', 
                                    cost: 80000, time: 0, dose: 1, healthImpact: -5,
                                    setState: { leakOccurred: true }
                                }
                            ]
                        },
                        // Clearance was improved - smooth operation
                        clearanceImproved: {
                            situation: 'Operational review of weld condition. The access improvements made earlier allow full monitoring capability.',
                            quote: "Good news from the weld monitoring programme. That access opening we cut - full inspection coverage means we know exactly what condition everything is in. No surprises. Just confirming your monitoring strategy.",
                            options: [
                                { id: 'standard', name: 'Standard surveillance', desc: 'Continue proven monitoring approach.', cost: 10000, time: 1, dose: 0.5 },
                                { id: 'enhanced', name: 'Enhanced end-of-life monitoring', desc: 'Extra vigilance as plant ages.', cost: 20000, time: 2, dose: 1 }
                            ]
                        },
                        // Deteriorating weld that was never fixed properly
                        deteriorating: {
                            situation: '⚠️ CRITICAL: The deteriorating weld from earlier failures is now showing active crack propagation on acoustic monitoring.',
                            quote: "The weld we've been worried about - acoustic monitors are picking up active crack growth. This is what happens when you can't properly repair or inspect because of access constraints. We need to act NOW.",
                            options: [
                                { 
                                    id: 'emergency', 
                                    name: 'Emergency shutdown and section replacement', 
                                    desc: 'No more half-measures. Replace the entire section.', 
                                    cost: 280000, time: 21, dose: 8,
                                    setState: { leakOccurred: true, deteriorating: false }
                                },
                                { 
                                    id: 'limit', 
                                    name: 'Operating restrictions', 
                                    desc: 'Reduced power, enhanced monitoring. Hope it holds.', 
                                    cost: 100000, time: 0, dose: 0, healthImpact: -15,
                                    setState: { leakOccurred: true }
                                }
                            ]
                        },
                        // Default - no crisis but ongoing concerns
                        default: {
                            situation: 'Weld operational review. No leaks detected, but areas with limited inspection coverage remain a concern.',
                            quote: "No leaks yet. But that 50mm clearance from 2025 still limits what we can see. We're monitoring what we can access, but the gaps in coverage worry me.",
                            options: [
                                { id: 'monitor', name: 'Enhanced leak detection', desc: 'Additional acoustic monitoring on high-risk areas.', cost: 25000, time: 1, dose: 0 },
                                { id: 'standard', name: 'Standard monitoring', desc: 'Continue existing programme.', cost: 10000, time: 0, dose: 0 }
                            ]
                        }
                    }
                },
                '150mm': {
                    situation: 'Weld operational review. All welds were fully inspected at the 30-year mark with 100% coverage. Complete confidence in condition.',
                    quote: "All those welds we inspected properly in 2055 because of the 150mm clearance? Complete records, full coverage, no surprises. This is what good design enables. Confirming monitoring approach.",
                    options: [
                        { id: 'maintain', name: 'Maintain inspection programme', desc: 'Continue the proven approach.', cost: 5000, time: 0, dose: 0 },
                        { id: 'extend', name: 'Extend to adjacent systems', desc: 'Apply same rigour to connected pipework.', cost: 15000, time: 1, dose: 0.5 }
                    ]
                },
                '300mm': {
                    situation: 'Welds are fine but the permanent scaffolding contamination levels are increasing. Annual ALARA surveys now required.',
                    quote: "Welds are all in good condition - the clearance helps. But that scaffolding from 2025 - contamination keeps building. Now requiring annual surveys per ALARA principles. Deal with it now or keep monitoring?",
                    options: [
                        { id: 'survey', name: 'Continue annual scaffolding surveys', desc: 'Track the contamination build-up.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'remove', name: 'Remove scaffolding now', desc: 'Deal with it as LLW before it becomes ILW.', cost: 40000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                '50mm': {
                    checkElementState: true,
                    scenarios: {
                        // Had a leak - contamination complicates cutting
                        leakOccurred: {
                            situation: 'Pipe cutting for removal. The leak that occurred complicated things - contamination spread to surrounding structures. Plus the 50mm clearance still restricts equipment access.',
                            quote: "That leak we had - contamination migrated into the concrete. Now I'm cutting pipes AND dealing with contaminated aggregate. The 50mm clearance from 2025 means confined space work in a contaminated zone. This is as bad as it gets.",
                            options: [
                                { 
                                    id: 'full', 
                                    name: 'Full specialist decommissioning', 
                                    desc: 'Robotic cutting where possible, manual confined space with full containment. Concrete remediation.', 
                                    cost: 180000, time: 20, dose: 8 
                                },
                                { 
                                    id: 'encapsulate', 
                                    name: 'Cut and encapsulate in-situ', 
                                    desc: 'Segment pipes, grout in place. Leaves contamination contained but not removed.', 
                                    cost: 100000, time: 12, dose: 4, healthImpact: -5 
                                }
                            ]
                        },
                        // Clearance was improved at some point
                        clearanceImproved: {
                            situation: 'Pipe cutting for removal. The access improvements made during operations help - but original constrained sections remain in some areas.',
                            quote: "That access opening we cut - makes some of this easier. But there are still tight spots from the original 50mm design. Mixed approach needed.",
                            options: [
                                { id: 'mixed', name: 'Combined robotic and manual cutting', desc: 'Use robots where we have access, manual in tight spots.', cost: 60000, time: 10, dose: 3 },
                                { id: 'demolish', name: 'Demolish surrounding structure', desc: 'Create access by removing walls. More waste, easier cutting.', cost: 80000, time: 8, dose: 2 }
                            ]
                        },
                        // Default - original 50mm, no improvements
                        default: {
                            situation: 'Pipe cutting required for removal. The 50mm clearance from 2025 leaves no room for standard cutting equipment - plasma torches need 100mm minimum.',
                            quote: "Time to cut these pipes out. That 50mm clearance from 2025 - no room for plasma cutting gear. We're doing this in confined space with hand tools, or bringing in robotic systems. Either way, the 2025 design decision costs us at the end.",
                            options: [
                                { id: 'manual', name: 'Manual cutting in confined space', desc: 'Reciprocating saws, high dose, slow progress. Contamination control challenging.', cost: 45000, time: 10, dose: 6 },
                                { id: 'robotic', name: 'Robotic cutting systems', desc: 'Snake-arm robots designed for confined space. Expensive but lower dose.', cost: 120000, time: 7, dose: 2 }
                            ]
                        }
                    }
                },
                '150mm': {
                    situation: 'Pipe cutting for removal. The 150mm clearance from 2025 accommodates standard decommissioning equipment - exactly as design guidance recommends.',
                    quote: "That 150mm clearance from 2025 - still paying dividends 60 years later. Standard plasma cutting gear fits, clean cuts, good contamination control. This is what proper design-for-decommissioning looks like.",
                    options: [
                        { id: 'standard', name: 'Standard cutting and removal', desc: 'Normal decommissioning procedures. Efficient and controlled.', cost: 25000, time: 4, dose: 1.5 },
                        { id: 'segregate', name: 'Cut with material segregation', desc: 'Additional effort to separate materials. Some may qualify as LLW instead of ILW.', cost: 35000, time: 5, dose: 2 }
                    ]
                },
                '300mm': {
                    situation: 'Pipe cutting is straightforward with the clearance, but the permanent scaffolding has become ILW after 60 years of activation.',
                    quote: "Easy access for the pipe cutting - 300mm is plenty. But that scaffolding from 2025 has been accumulating activation and contamination for 60 years. It's ILW now - significant additional waste volume to dispose of.",
                    options: [
                        { id: 'both', name: 'Remove pipes and scaffolding together', desc: 'Deal with all the waste in one campaign.', cost: 85000, time: 8, dose: 3 },
                        { id: 'defer', name: 'Pipes now, scaffolding deferred', desc: 'Two-phase approach. Extends project timeline.', cost: 55000, time: 5, dose: 2, healthImpact: -3 }
                    ]
                }
            }
        },
        // ==========================================
        // ELEMENT 3: CONTROL PANEL
        // ==========================================
        controlPanel: {
            title: 'Control Panel Layout',
            stage1: {
                description: 'How should the control panel be organised?',
                options: [
                    { id: 'task', name: 'Task-Based Layout', desc: 'Controls grouped by operator workflow. Emergency sequences flow left-to-right. Matches mental model.', cost: 120000, quality: 'good', image: 'images/06_Control_01.png' },
                    { id: 'system', name: 'System-Based Layout', desc: 'Controls grouped by physical system (all pump controls together). Logical to engineers, confusing to operators.', cost: 80000, quality: 'poor', image: 'images/06_Control_02.png' },
                    { id: 'digital', name: 'Software-Based Interface', desc: 'Modern touchscreens with configurable displays. Impressive technology, unproven in emergencies.', cost: 160000, quality: 'wasteful', image: 'images/06_Control_03.png' }
                ]
            },
            stage2: {
                task: {
                    situation: 'Control room operations review. The task-based layout from 2025 is working well - operators report intuitive workflow during both normal and abnormal conditions.',
                    quote: "The operators love this panel layout. Task-based design from 2025 - emergency sequences flow left to right, everything's where they expect it. Response times are 40% faster than industry average. Just needs standard maintenance.",
                    options: [
                        { id: 'maintain', name: 'Standard maintenance', desc: 'Keep it running as designed. It\'s working.', cost: 10000, time: 0, dose: 0 },
                        { id: 'enhance', name: 'Add status display enhancements', desc: 'Additional trending displays for early warning.', cost: 25000, time: 0, dose: 0 }
                    ]
                },
                system: {
                    situation: 'Operators have submitted 18 human factors concern reports since 2025. The system-based layout causes confusion during abnormal conditions - controls for emergency response are scattered across different panels.',
                    quote: "We've had 18 formal HF complaints about this panel. System-based layout from 2025 - when something goes wrong, operators can't find controls quickly. The PORV isolation is on Panel 3, but the status indicator is on Panel 7. It's like the lessons from Three Mile Island were ignored.",
                    options: [
                        { 
                            id: 'redesign', 
                            name: 'Commission HF review and partial redesign', 
                            desc: 'Human factors assessment per ONR TAG NS-TAST-GD-058. Relocate critical emergency controls.', 
                            cost: 80000, time: 0, dose: 0,
                            setState: { layoutModified: true }
                        },
                        { 
                            id: 'decision_support', 
                            name: 'Install decision support system', 
                            desc: 'Computerised system guides operators to correct controls. Band-aid but better than nothing.', 
                            cost: 50000, time: 0, dose: 0,
                            setState: { backupInstalled: true }
                        },
                        { 
                            id: 'training', 
                            name: 'Enhanced operator training', 
                            desc: 'More simulator time. Operators learn to work around the poor design.', 
                            cost: 25000, time: 0, dose: 0,
                            setState: { trainingEnhanced: true }
                        }
                    ]
                },
                digital: {
                    situation: 'Three touchscreen failures in 15 years. Operators report issues with gloved hands, low-light conditions, and response lag during high-activity periods. No haptic feedback like physical switches.',
                    quote: "That touchscreen system from 2025 - we've had three complete failures. Operators can't use it with gloves, screens wash out in emergency lighting, and it lags when they need it most. During the last transient, an operator was jabbing the screen trying to get a response. No tactile confirmation like physical buttons.",
                    options: [
                        { 
                            id: 'backup', 
                            name: 'Install hardwired backup panel', 
                            desc: 'Physical buttons for safety-critical functions. This Diverse Actuation System (DAS) approach is now standard practice for software-based control systems.', 
                            cost: 90000, time: 0, dose: 0,
                            setState: { backupInstalled: true }
                        },
                        { 
                            id: 'upgrade', 
                            name: 'Upgrade to industrial-grade touchscreens', 
                            desc: 'Better screens with improved response. Still touchscreens.', 
                            cost: 60000, time: 0, dose: 0 
                        },
                        { 
                            id: 'train', 
                            name: 'Additional operator training', 
                            desc: 'Train them to work around the limitations.', 
                            cost: 15000, time: 0, dose: 0,
                            setState: { trainingEnhanced: true }
                        }
                    ]
                }
            },
            stage3: {
                task: {
                    situation: 'Regulatory human factors review per ONR expectations. The task-based panel from 2025 receives consistently high ratings from independent assessors.',
                    quote: "Regulator's HF team reviewing our control room. That task-based layout from 2025? They're impressed. Operator response times are excellent, error rates are low. We're being cited as good practice. Standard documentation or go further?",
                    options: [
                        { id: 'standard', name: 'Standard review documentation', desc: 'Confirm continued good performance.', cost: 10000, time: 1, dose: 0 },
                        { id: 'benchmark', name: 'Full NUREG-0700 benchmark', desc: 'Compare against latest international HF guidance. Demonstrate excellence.', cost: 22000, time: 2, dose: 0 }
                    ]
                },
                system: {
                    checkElementState: true,
                    scenarios: {
                        layoutModified: {
                            situation: 'Regulatory human factors review. The 2040 modifications improved critical control placement. Assessors note the improvement.',
                            quote: "HF review time. They're looking at our modifications from 2040 - relocating those emergency controls helped. Still not as good as if we'd designed it right in 2025, but better than it was. Standard review?",
                            options: [
                                { id: 'review', name: 'Standard review with improvement documentation', desc: 'Show the journey from poor design to improved state.', cost: 15000, time: 2, dose: 0 },
                                { id: 'benchmark', name: 'Benchmark against original design', desc: 'Quantify the improvement for lessons learned.', cost: 25000, time: 3, dose: 0 }
                            ]
                        },
                        backupInstalled: {
                            situation: 'Regulatory review of control systems. The decision support system helps, but fundamental layout issues remain.',
                            quote: "HF assessors are here. That decision support system from 2040 helps operators find controls faster, but they're still noting the underlying layout problems from 2025. It's documented as \'managed weakness\'.",
                            options: [
                                { id: 'document', name: 'Document compensatory measures', desc: 'Show how decision support mitigates design weaknesses.', cost: 18000, time: 2, dose: 0 },
                                { id: 'enhance', name: 'Propose layout improvements', desc: 'Commit to further modifications.', cost: 30000, time: 2, dose: 0, setState: { layoutModified: true } }
                            ]
                        },
                        trainingEnhanced: {
                            situation: 'Regulatory human factors audit. Enhanced training helps but assessors note operators are compensating for poor design.',
                            quote: "The HF auditors are concerned. Our operators perform well in simulators because of the extra training, but they're documenting that we're relying on human adaptation rather than good design. That's exactly what TMI taught us NOT to do.",
                            options: [
                                { id: 'accept', name: 'Accept findings with action plan', desc: 'Acknowledge the gap. Commit to improvements.', cost: 12000, time: 1, dose: 0 },
                                { id: 'redesign', name: 'Commission proper redesign', desc: 'Finally fix the underlying problem.', cost: 80000, time: 3, dose: 0, setState: { layoutModified: true } }
                            ]
                        },
                        default: {
                            situation: 'Regulatory human factors audit. The system-based layout from 2025 receives critical findings.',
                            quote: "HF audit results are in. That system-based layout from 2025 - they've cited us for poor emergency control accessibility. Response times 40% slower than task-based designs. We need an action plan.",
                            options: [
                                { id: 'minimal', name: 'Minimal compliance response', desc: 'Promise improvements. Hope they accept.', cost: 10000, time: 1, dose: 0, healthImpact: -5 },
                                { id: 'comprehensive', name: 'Comprehensive improvement plan', desc: 'Detailed roadmap to address all findings.', cost: 35000, time: 2, dose: 0 }
                            ]
                        }
                    }
                },
                digital: {
                    situation: 'Safety review identifies display artefacts, software glitches, and cybersecurity concerns in the 30-year-old touchscreen system.',
                    quote: "The touchscreens from 2025 - they're 30 years old. Software is showing its age, screens have burn-in, and the assessors are asking about cybersecurity. 2025 systems weren't designed with modern threat awareness. What level of fix?",
                    options: [
                        { id: 'comprehensive', name: 'Full software update, hardware refresh, cyber review', desc: 'Comprehensive modernisation. Address all concerns.', cost: 55000, time: 3, dose: 0 },
                        { id: 'patch', name: 'Critical patches and cyber hardening only', desc: 'Fix the worst issues. Accept residual risk.', cost: 25000, time: 2, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                task: {
                    situation: '⚠️ ALARM: Loss of Coolant Flow indication at 0300 hours. The task-based panel layout means emergency controls are exactly where operators expect them.',
                    quote: "LOCA indication at 3am - but watch this. Task-based layout from 2025: reactor trip button here, safety injection there, isolation valves in sequence left-to-right. Operators executing the response exactly as trained. This is what good HF design delivers.",
                    options: [
                        { id: 'respond', name: 'Execute standard emergency response', desc: 'Smooth response using well-designed panel.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'verify', name: 'Execute with enhanced verification', desc: 'Extra peer-checks at each step. Conservative approach.', cost: 8000, time: 0, dose: 0.5 }
                    ]
                },
                system: {
                    checkElementState: true,
                    scenarios: {
                        layoutModified: {
                            situation: '⚠️ ALARM: Loss of Coolant indication. The 2040 panel modifications help - emergency controls are now grouped together.',
                            quote: "LOCA at 0300! The panel modifications from 2040 are helping - emergency controls are grouped now. Still not perfect, but operators are finding things faster than before. Executing response.",
                            options: [
                                { id: 'respond', name: 'Standard emergency response', desc: 'Modified panel enables adequate response.', cost: 15000, time: 1, dose: 1 },
                                { id: 'senior', name: 'Call shift supervisor for verification', desc: 'Extra verification given panel history.', cost: 8000, time: 1, dose: 0.5 }
                            ]
                        },
                        backupInstalled: {
                            situation: '⚠️ ALARM: Loss of Coolant indication. Decision support system guiding operators to correct controls.',
                            quote: "LOCA indication! That decision support system from 2040 is flashing - guiding operators to the isolation valves. They're still hunting across panels, but at least the computer is telling them where to look.",
                            options: [
                                { id: 'follow', name: 'Follow decision support guidance', desc: 'Let the computer guide the response.', cost: 20000, time: 1, dose: 1 },
                                { id: 'manual', name: 'Experienced operators from memory', desc: 'Senior operators know this panel despite the layout.', cost: 10000, time: 1, dose: 1, risk: 20 }
                            ]
                        },
                        trainingEnhanced: {
                            situation: '⚠️ ALARM: Loss of Coolant indication. Enhanced training being tested - operators must remember where scattered controls are located.',
                            quote: "LOCA at 3am! Operators searching for controls - the training helps but under stress they're reverting to instinct. PORV isolation is... wait, which panel? The system-based layout is fighting them.",
                            options: [
                                { 
                                    id: 'systematic', 
                                    name: 'Systematic procedure-driven response', 
                                    desc: 'Slow and methodical. Follow procedures exactly.', 
                                    cost: 35000, time: 2, dose: 2
                                },
                                { 
                                    id: 'senior', 
                                    name: 'Call all senior operators to control room', 
                                    desc: 'Get everyone who knows this panel layout.', 
                                    cost: 15000, time: 1, dose: 1,
                                    setState: { operatorError: true }
                                }
                            ]
                        },
                        default: {
                            situation: '⚠️ ALARM: Loss of Coolant indication at 0300 hours. The system-based panel layout from 2025 was never improved. Operators struggling to locate correct controls.',
                            quote: "LOCA indication at 3am! Operators can't find the isolation valves quickly - that system-based layout from 2025 has controls scattered across four panels. This is exactly what happened at TMI - poor HF design failing when it matters most!",
                            options: [
                                { 
                                    id: 'search', 
                                    name: 'Search for correct controls', 
                                    desc: 'Delayed response while operators hunt for switches. Time is critical.', 
                                    cost: 60000, time: 2, dose: 3, risk: 40, healthImpact: -10,
                                    setState: { operatorError: true }
                                },
                                { 
                                    id: 'procedure', 
                                    name: 'Slow procedural response', 
                                    desc: 'Read each step aloud, locate controls methodically. Slower but fewer errors.', 
                                    cost: 40000, time: 3, dose: 2,
                                    setState: { operatorError: true }
                                },
                                { 
                                    id: 'scram', 
                                    name: 'Immediate reactor trip', 
                                    desc: 'If in doubt, shut it down. Safe but conservative. Full investigation follows.', 
                                    cost: 100000, time: 1, dose: 0.5
                                }
                            ]
                        }
                    }
                },
                digital: {
                    checkElementState: true,
                    scenarios: {
                        backupInstalled: {
                            situation: '⚠️ ALARM: System transient. Touchscreens lagging under demand, but hardwired backup panel from 2040 is available.',
                            quote: "Transient in progress - touchscreens struggling with the update rate. But that backup panel we installed after 2040? Physical switches, instant response. No lag, no gloves problem. Switching to backup.",
                            options: [
                                { id: 'backup', name: 'Switch to hardwired backup', desc: 'Reliable physical controls with haptic feedback.', cost: 15000, time: 1, dose: 0.5 },
                                { id: 'wait', name: 'Wait for touchscreens to recover', desc: 'They might speed up once the transient stabilises.', cost: 0, time: 2, dose: 0, risk: 30, healthImpact: -5 }
                            ]
                        },
                        default: {
                            situation: '⚠️ ALARM: System transient. Touchscreens frozen. Gloved fingers not registering. No backup panel available.',
                            quote: "Touchscreens are frozen solid! Operators jabbing at the screen - gloves don't register, system locked up. We never installed that backup panel after 2040. We have NO control interface. This is a design failure!",
                            options: [
                                { 
                                    id: 'reboot', 
                                    name: 'Emergency system reboot', 
                                    desc: 'Power cycle the displays. Everything goes dark during restart.', 
                                    cost: 0, time: 2, dose: 0, risk: 50, healthImpact: -15,
                                    setState: { operatorError: true }
                                },
                                { 
                                    id: 'local', 
                                    name: 'Send operators to local panels', 
                                    desc: 'Manual operation from field locations. High dose, communication challenges.', 
                                    cost: 35000, time: 4, dose: 4,
                                    setState: { operatorError: true }
                                },
                                { 
                                    id: 'scram', 
                                    name: 'Manual reactor trip', 
                                    desc: 'The big red button still works. Safe shutdown. Major investigation.', 
                                    cost: 120000, time: 1, dose: 0.5
                                }
                            ]
                        }
                    }
                }
            },
            stage5: {
                task: {
                    situation: 'Control panel decommissioning. The well-designed panel served operators well for 60 years.',
                    quote: "End of the line for the control room. That task-based design from 2025 served us well - 60 years of reliable operation, operators loved it, response times were excellent. Worth documenting as industry best practice.",
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning procedure.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'document', name: 'Document as HF case study', desc: 'Capture the design principles for future projects and training.', cost: 18000, time: 3, dose: 0.5 }
                    ]
                },
                system: {
                    checkElementState: true,
                    scenarios: {
                        operatorError: {
                            situation: 'Control panel decommissioning. The poor HF design contributed to the incident during operations - now part of lessons learned.',
                            quote: "Taking out this panel that caused us problems. That system-based layout from 2025 - remember the night of the incident? Operators searching for controls... This needs to be preserved as a training example of what not to do.",
                            options: [
                                { id: 'preserve', name: 'Preserve panel as training example', desc: 'Document the HF failures for future designers.', cost: 25000, time: 4, dose: 0.5 },
                                { id: 'standard', name: 'Standard removal with documentation', desc: 'Photographs and reports, then dispose.', cost: 12000, time: 2, dose: 0.5 }
                            ]
                        },
                        default: {
                            situation: 'Control panel decommissioning. The system-based layout caused frustration but no major incidents.',
                            quote: "Taking out the control panels. That system-based layout from 2025 caused headaches for 60 years - operators always complained, HF auditors always noted it. At least it comes out easily. Lessons learned documentation?",
                            options: [
                                { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning procedure.', cost: 10000, time: 2, dose: 0.5 },
                                { id: 'document', name: 'Document HF lessons learned', desc: 'Record what not to do for future projects.', cost: 15000, time: 3, dose: 0.5 }
                            ]
                        }
                    }
                },
                digital: {
                    situation: 'Touchscreen system decommissioning. Electronic waste with potential radioactive contamination requires specialist disposal.',
                    quote: "The touchscreen system from 2025 - finally removing it. E-waste disposal requirements for all this electronics, plus surface contamination on the screens and cabinets. The technology that was \'cutting edge\' in 2025 is now hazardous waste.",
                    options: [
                        { id: 'ewaste', name: 'Specialist e-waste disposal', desc: 'Proper handling of contaminated electronics per regulations.', cost: 35000, time: 4, dose: 0.5 },
                        { id: 'separate', name: 'Separate electronic and radioactive disposal', desc: 'Decontaminate first, then e-waste. More handling but cleaner streams.', cost: 45000, time: 5, dose: 1 }
                    ]
                }
            }
        },
        // ==========================================
        // ELEMENT 4: PIPE CONNECTIONS
        // ==========================================
        pipeConnections: {
            title: 'Pipe Connections',
            stage1: {
                description: 'How should pipe joints be designed?',
                options: [
                    { id: 'welded', name: 'All Welded', desc: 'Continuous welds throughout. No break points. More welding labour.', cost: 140000, quality: 'poor', image: 'images/04_Pipe_01.png' },
                    { id: 'flanged', name: 'Flanged at Strategic Points', desc: 'Bolted flanges every 6m and at components. Optimised design.', cost: 100000, quality: 'good', image: 'images/04_Pipe_02.png' },
                    { id: 'excessive', name: 'Flanges Everywhere', desc: 'Flanged every 2m. Maximum flexibility but many potential leak paths.', cost: 180000, quality: 'wasteful', image: 'images/04_Pipe_03.png' }
                ]
            },
            stage2: {
                welded: {
                    situation: 'A pipe section needs replacement. The all-welded design from 2025 means there are no break points - must cut and re-weld.',
                    quote: "Need to replace a section of pipe. That all-welded design from 2025 - cost more in welding labour AND there's nowhere to unbolt. We have to cut it out and weld in the replacement. Time-consuming and high dose. How do you want to proceed?",
                    options: [
                        { 
                            id: 'replace', 
                            name: 'Cut, replace, and re-weld', 
                            desc: 'Proper repair but significant work. Add a flange for future access.', 
                            cost: 65000, time: 8, dose: 5,
                            setState: { flangingAdded: true }
                        },
                        { 
                            id: 'overlay', 
                            name: 'Weld overlay repair', 
                            desc: 'Temporary fix. Will need revisiting eventually.', 
                            cost: 25000, time: 3, dose: 3, healthImpact: -5,
                            setState: { deteriorating: true }
                        },
                        {
                            id: 'minimal',
                            name: 'Minimum cut and re-weld',
                            desc: 'Just the damaged section. No design improvement.',
                            cost: 45000, time: 6, dose: 4,
                            setState: { weldCutMade: true }
                        }
                    ]
                },
                flanged: {
                    situation: 'A pipe section needs replacement. The flanged connections from the 2025 design allow easy section removal.',
                    quote: "Pipe section needs replacing. Those flanged connections from 2025 - cheapest option AND the smartest. Just unbolt, remove the section, and bolt in the new one. Clean and simple. Standard replacement or should we upgrade the gaskets while we're there?",
                    options: [
                        { id: 'standard', name: 'Standard flange replacement', desc: 'Unbolt, replace section, re-bolt.', cost: 30000, time: 3, dose: 1.5 },
                        { id: 'upgrade', name: 'Replace with upgraded gaskets', desc: 'Better gasket material for longer life.', cost: 40000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: 'Three gasket failures this outage. With flanges every 2m from the 2025 design, there are 47 potential leak paths.',
                    quote: "Third gasket failure this week. That design from 2025 with flanges every 2m - 47 flanges means 47 places to leak. We're chasing gaskets constantly. Do you want to replace all of them preventively or keep playing whack-a-mole?",
                    options: [
                        { 
                            id: 'replace', 
                            name: 'Replace all gaskets preventively', 
                            desc: 'Do them all now. No more surprises this outage.', 
                            cost: 45000, time: 5, dose: 2 
                        },
                        { 
                            id: 'reactive', 
                            name: 'Keep replacing as they fail', 
                            desc: 'Fix what breaks. Hope it holds.', 
                            cost: 15000, time: 2, dose: 1, healthImpact: -3,
                            setState: { leakHistory: true }
                        }
                    ]
                }
            },
            stage3: {
                welded: {
                    checkElementState: true,
                    scenarios: {
                        flangingAdded: {
                            situation: 'In-Service Inspection time. The flange you added in 2040 provides a break point, making some sections easier to examine.',
                            quote: "Good call adding that flange in 2040. At least I have one break point now. Still a lot of welds to examine from the original all-welded design, but it's not quite as bad. Full programme or sample?",
                            options: [
                                { id: 'full', name: 'Full inspection programme', desc: 'Examine all welds thoroughly.', cost: 40000, time: 6, dose: 3.5 },
                                { id: 'sample', name: 'Risk-based sample approach', desc: 'Focus on highest-risk welds.', cost: 22000, time: 3, dose: 2 }
                            ]
                        },
                        deteriorating: {
                            situation: '⚠️ URGENT: The weld overlay from 2040 is showing crack indications. The underlying defect appears to be propagating.',
                            quote: "That overlay we did in 2040 instead of proper repair? It's cracking. I can see indications propagating into the base metal. The temporary fix is becoming a permanent problem. We need to act.",
                            options: [
                                { 
                                    id: 'replace', 
                                    name: 'Emergency section replacement', 
                                    desc: 'Cut out the entire affected section. Proper fix finally.', 
                                    cost: 95000, time: 10, dose: 6,
                                    setState: { flangingAdded: true, deteriorating: false }
                                },
                                { 
                                    id: 'monitor', 
                                    name: 'Enhanced monitoring and operate', 
                                    desc: 'Frequent inspection, plan replacement for next outage.', 
                                    cost: 25000, time: 2, dose: 2,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        },
                        weldCutMade: {
                            situation: 'Full weld inspection required. The all-welded design from 2025 plus the 2040 repair weld means many examination points.',
                            quote: "All-welded system from 2025, plus that repair weld from 2040. Every joint needs examining. No shortcuts available - it's a lot of welds. Full coverage or prioritise?",
                            options: [
                                { id: 'full', name: 'Full weld examination', desc: 'UT every weld in the system.', cost: 50000, time: 7, dose: 4 },
                                { 
                                    id: 'sample', 
                                    name: 'Sample 50% of welds', 
                                    desc: 'Risk-based selection. May miss developing issues.', 
                                    cost: 25000, time: 4, dose: 2, healthImpact: -5,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        },
                        default: {
                            situation: 'All welds require inspection. The all-welded design from 2025 means a large number of weld examinations are needed.',
                            quote: "Inspection programme time. That all-welded design from 2025 - every joint is a weld, every weld needs examining. It's a lot of coverage. Full programme or sample-based approach?",
                            options: [
                                { id: 'full', name: 'Full inspection of all welds', desc: 'Examine every weld in the system.', cost: 50000, time: 7, dose: 4 },
                                { 
                                    id: 'sample', 
                                    name: 'Sample 50% of welds', 
                                    desc: 'Risk-based selection. May miss developing defects.', 
                                    cost: 25000, time: 4, dose: 2, healthImpact: -5,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        }
                    }
                },
                flanged: {
                    situation: 'Limited number of welds to inspect. Flanged joints from 2025 require visual and torque checks.',
                    quote: "Inspection time. That flanged design from 2025 means fewer welds to examine. Just need to UT the welds we have and verify the flange bolt torques. Straightforward. Any extras you want?",
                    options: [
                        { id: 'standard', name: 'Standard inspection programme', desc: 'UT on welds, visual and torque on flanges.', cost: 20000, time: 3, dose: 1.5 },
                        { id: 'torque', name: 'Add detailed bolt torque analysis', desc: 'Extra verification of flange integrity.', cost: 28000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    checkElementState: true,
                    scenarios: {
                        leakHistory: {
                            situation: 'Ongoing gasket issues from the reactive approach in 2040. Several flanges showing signs of distortion from repeated thermal cycling.',
                            quote: "Those gaskets we kept replacing as they failed in 2040? Some of the flanges are showing distortion now - thermal cycling with leaking gaskets causes problems. I'm seeing bolt stretch too. Comprehensive check or focus on the worst ones?",
                            options: [
                                { 
                                    id: 'comprehensive', 
                                    name: 'Full flange condition assessment', 
                                    desc: 'Check all 47 for distortion, bolt condition, and gasket seating.', 
                                    cost: 55000, time: 8, dose: 4,
                                    setState: { boltDegradation: true }
                                },
                                { 
                                    id: 'worst', 
                                    name: 'Focus on known problem flanges', 
                                    desc: 'Address the worst ones. Others may develop issues.', 
                                    cost: 30000, time: 4, dose: 2,
                                    setState: { boltDegradation: true, inspectionLimited: true }
                                }
                            ]
                        },
                        default: {
                            situation: '47 flanged connections to inspect. Many gaskets from 2025 are showing wear after 30 years.',
                            quote: "47 flanges to check from that 2025 design. I'll be verifying bolts and gaskets all week. Some of these gaskets are 30 years old and looking tired. Full coverage or prioritise high-risk locations?",
                            options: [
                                { id: 'all', name: 'Inspect all 47 connections', desc: 'Thorough but time-consuming.', cost: 35000, time: 6, dose: 2.5 },
                                { 
                                    id: 'sample', 
                                    name: 'Prioritise high-risk locations', 
                                    desc: 'Focus on problem areas. May miss issues elsewhere.', 
                                    cost: 20000, time: 3, dose: 1.5, healthImpact: -3,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        }
                    }
                }
            },
            stage4: {
                welded: {
                    checkElementState: true,
                    scenarios: {
                        flangingAdded: {
                            situation: 'Online maintenance needed. The flange added in 2040 provides an isolation point - a small improvement to the original all-welded design.',
                            quote: "Need to do some valve work. Remember that flange we added in 2040? It's paying off now - I can isolate that section and work online. The rest is still all-welded, but at least we have one break point.",
                            options: [
                                { id: 'online', name: 'Use new isolation point', desc: 'Work at power using the added flange.', cost: 20000, time: 2, dose: 1 },
                                { id: 'defer', name: 'Defer to outage anyway', desc: 'Conservative approach.', cost: 5000, time: 0, dose: 0 }
                            ]
                        },
                        deteriorating: {
                            situation: '⚠️ LEAK ALARM: The 2040 weld overlay is leaking. The "temporary" fix has failed after 30 years.',
                            quote: "That overlay from 2040 - it's leaking now. We always knew it was temporary but kept hoping. Thirty years later, we're paying for the shortcut. Emergency repair or try to nurse it to the outage?",
                            options: [
                                { 
                                    id: 'emergency', 
                                    name: 'Emergency shutdown and repair', 
                                    desc: 'Fix it properly this time.', 
                                    cost: 120000, time: 12, dose: 7,
                                    setState: { leakHistory: true, deteriorating: false }
                                },
                                { 
                                    id: 'manage', 
                                    name: 'Manage leakage to outage', 
                                    desc: 'Contain and monitor. Risky.', 
                                    cost: 25000, time: 1, dose: 2, risk: 35, healthImpact: -8,
                                    setState: { leakHistory: true }
                                }
                            ]
                        },
                        inspectionLimited: {
                            situation: '⚠️ WELD FAILURE: A weld in the uninspected sample has failed. The gap in the 2055 inspection has caught up with us.',
                            quote: "Weld failure - and it's one we didn't examine in 2055. That sample-based approach saved money then, but this weld was developing a defect we never saw. Now it's leaking.",
                            options: [
                                { 
                                    id: 'repair', 
                                    name: 'Repair failed weld', 
                                    desc: 'Fix this one and inspect the others we missed.', 
                                    cost: 85000, time: 8, dose: 5,
                                    setState: { leakHistory: true }
                                },
                                { 
                                    id: 'temporary', 
                                    name: 'Temporary clamp repair', 
                                    desc: 'Quick fix. Proper repair at outage.', 
                                    cost: 35000, time: 2, dose: 2,
                                    setState: { leakHistory: true }
                                }
                            ]
                        },
                        default: {
                            situation: 'Online maintenance needed but the all-welded design from 2025 provides no isolation points.',
                            quote: "We need to do some maintenance, but that all-welded design from 2025 - there's nowhere to isolate. Can't do it online. We either wait for the outage or take a partial shutdown. Your call.",
                            options: [
                                { id: 'defer', name: 'Defer to next scheduled outage', desc: 'Wait for full shutdown. Work accumulates.', cost: 10000, time: 0, dose: 0 },
                                { id: 'partial', name: 'Partial shutdown for access', desc: 'Reduce power to create safe work window.', cost: 40000, time: 2, dose: 1 }
                            ]
                        }
                    }
                },
                flanged: {
                    situation: 'Online maintenance needed. The flanged design from 2025 allows isolation and work at power.',
                    quote: "Valve needs attention. That flanged design from 2025 - saved money upfront AND we can isolate the section and work while the plant runs. No shutdown needed. Do it now or schedule for the outage?",
                    options: [
                        { id: 'online', name: 'Isolate and work at power', desc: 'Use the flexibility of flanged design.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'defer', name: 'Defer to outage', desc: 'Not urgent. Can wait.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                excessive: {
                    checkElementState: true,
                    scenarios: {
                        boltDegradation: {
                            situation: '⚠️ FLANGE FAILURE: Bolt failure on flange F-23. The degradation identified in 2055 has progressed to failure.',
                            quote: "Bolt sheared on F-23 - that's one of the flanges we identified as degraded in 2055. The thermal cycling and gasket leaks have taken their toll. We've got a proper leak now.",
                            options: [
                                { 
                                    id: 'replace', 
                                    name: 'Replace flange assembly', 
                                    desc: 'New bolts, new gasket, proper fix.', 
                                    cost: 45000, time: 4, dose: 2,
                                    setState: { leakHistory: true }
                                },
                                { 
                                    id: 'repair', 
                                    name: 'Emergency bolt replacement', 
                                    desc: 'Replace just the failed bolts. Others may follow.', 
                                    cost: 20000, time: 2, dose: 1.5,
                                    setState: { leakHistory: true }
                                }
                            ]
                        },
                        leakHistory: {
                            situation: 'More gasket failures. The pattern from 2040 continues - 47 flanges means constant vigilance.',
                            quote: "Two more leakers. That 47-flange design from 2025 keeps us busy. Every outage we're chasing gaskets. It never ends. Fix them now or accept minor seepage?",
                            options: [
                                { 
                                    id: 'fix', 
                                    name: 'Fix leaking flanges', 
                                    desc: 'Replace gaskets on problem flanges.', 
                                    cost: 35000, time: 3, dose: 1.5 
                                },
                                { 
                                    id: 'accept', 
                                    name: 'Accept minor seepage', 
                                    desc: 'Containment in place. Monitor closely.', 
                                    cost: 8000, time: 0, dose: 0, healthImpact: -5 
                                }
                            ]
                        },
                        default: {
                            situation: 'Two more gasket failures during this operating period. The 47-flange design from 2025 continues to cause problems.',
                            quote: "Two more gaskets gone. That 47-flange design from 2025 - we're still fighting it 45 years later. Every flange is an opportunity for a leak. Fix them during a mini-outage or try to manage through?",
                            options: [
                                { id: 'repair', name: 'Short outage to repair leakers', desc: 'Fix the immediate problems.', cost: 30000, time: 3, dose: 1 },
                                { 
                                    id: 'monitor', 
                                    name: 'Manage leakage and monitor', 
                                    desc: 'Live with minor seepage. Not ideal.', 
                                    cost: 10000, time: 0, dose: 0, healthImpact: -3,
                                    setState: { leakHistory: true }
                                }
                            ]
                        }
                    }
                }
            },
            stage5: {
                welded: {
                    checkElementState: true,
                    scenarios: {
                        flangingAdded: {
                            situation: 'Pipe removal for decommissioning. The flange added in 2040 provides one break point, but most of the system is still all-welded.',
                            quote: "Decommissioning time. That flange we added in 2040 gives us one clean break point, but the rest is still all-welded from 2025. 11 cuts to make instead of 12. Every little helps. In-house or specialists?",
                            options: [
                                { id: 'inhouse', name: 'In-house cutting with flange break', desc: 'Use the flange point to reduce cutting.', cost: 70000, time: 12, dose: 6 },
                                { id: 'specialist', name: 'Specialist cutting contractor', desc: 'Full containment cutting programme.', cost: 160000, time: 9, dose: 3 }
                            ]
                        },
                        leakHistory: {
                            situation: 'Pipe removal complicated by historical contamination spread. The leaks over the years have contaminated surrounding areas.',
                            quote: "That leak history from 2070 - the contamination spread beyond the pipes into the support steelwork and floor. We're not just removing pipes now, we're dealing with secondary contamination. Extended scope needed.",
                            options: [
                                { id: 'extended', name: 'Extended decontamination scope', desc: 'Address all contaminated areas.', cost: 150000, time: 20, dose: 10 },
                                { id: 'pipes', name: 'Pipes only - defer surroundings', desc: 'Remove pipes, document surrounding contamination for later.', cost: 90000, time: 12, dose: 6, healthImpact: -5 }
                            ]
                        },
                        default: {
                            situation: 'Pipe removal for decommissioning. The all-welded design from 2025 means 12 welds to cut. Each cut risks contamination spread.',
                            quote: "Time to take these pipes out. That all-welded design from 2025 means 12 cuts to make. Each one sprays contamination if we're not careful. Slow and steady, or bring in the specialists?",
                            options: [
                                { id: 'careful', name: 'Careful in-house cutting programme', desc: 'Slow and controlled. Higher dose.', cost: 80000, time: 15, dose: 8, risk: 30 },
                                { id: 'specialist', name: 'Specialist cutting contractor', desc: 'Experts with containment equipment.', cost: 180000, time: 10, dose: 3 }
                            ]
                        }
                    }
                },
                flanged: {
                    situation: 'Pipe removal for decommissioning. The flanged design from 2025 means unbolt and remove in sections.',
                    quote: "Decommissioning the pipework. That flanged design from 2025 - cheapest to build and cheapest to remove. Unbolt the flanges, lift out the sections. No cutting, minimal contamination. Standard removal or segregate for recycling?",
                    options: [
                        { id: 'standard', name: 'Standard flange disassembly', desc: 'Unbolt and remove. Clean and simple.', cost: 40000, time: 6, dose: 2 },
                        { id: 'segregate', name: 'Segregate materials for recycling', desc: 'Extra effort to separate materials.', cost: 55000, time: 8, dose: 2.5 }
                    ]
                },
                excessive: {
                    checkElementState: true,
                    scenarios: {
                        boltDegradation: {
                            situation: 'Flange disassembly complicated by bolt degradation. Many seized and corroded from 60 years of thermal cycling and the problems identified in 2055.',
                            quote: "Those degraded bolts we found in 2055 - 60 years of service hasn't improved them. Half of these are seized solid. Can't just unbolt them, we'll have to cut some off. Slows everything down.",
                            options: [
                                { id: 'systematic', name: 'Systematic bolt-by-bolt removal', desc: 'Careful approach to each connection.', cost: 75000, time: 14, dose: 4 },
                                { id: 'cut', name: 'Cut through seized flanges', desc: 'Faster but generates more waste.', cost: 60000, time: 10, dose: 3.5 }
                            ]
                        },
                        leakHistory: {
                            situation: 'Flange removal with historical contamination issues. The gasket leak history means contamination has spread to bolt threads and surrounding areas.',
                            quote: "All those gasket leaks over the years - the contamination soaked into everything. Bolt threads are contaminated, flange faces are activated. More waste classification headaches than a clean system would have.",
                            options: [
                                { id: 'full', name: 'Full systematic disassembly', desc: 'All connections done properly, full waste characterisation.', cost: 70000, time: 12, dose: 4 },
                                { id: 'segregate', name: 'Segregate by contamination level', desc: 'Sort clean from contaminated as we go.', cost: 60000, time: 11, dose: 3.5 }
                            ]
                        },
                        default: {
                            situation: '47 flange connections to disconnect. Many contaminated gaskets to dispose of as waste.',
                            quote: "47 flanges from that 2025 design - at least they unbolt easily. But every one of those gaskets is contaminated waste now. Lots of small waste packages. Deal with it systematically or cut corners?",
                            options: [
                                { id: 'full', name: 'Full systematic disassembly', desc: 'All 47 connections done properly.', cost: 55000, time: 10, dose: 3 },
                                { id: 'bulk', name: 'Cut into larger sections instead', desc: 'Fewer disconnections but larger packages.', cost: 45000, time: 8, dose: 2.5 }
                            ]
                        }
                    }
                }
            }
        },
        // ==========================================
        // ELEMENT 5: PIPE ROUTING
        // ==========================================
        pipeRouting: {
            title: 'Pipe Routing',
            stage1: {
                description: 'How should pipes run through concrete structure?',
                options: [
                    { id: 'embedded', name: 'Embedded in Concrete', desc: 'Cast directly into structural concrete.', cost: 90000, quality: 'poor', image: 'images/05_Route_01.png' },
                    { id: 'ducted', name: 'Accessible Ducts', desc: 'Removable duct covers for access.', cost: 130000, quality: 'good', image: 'images/05_Route_02.png' },
                    { id: 'tunnel', name: 'Walk-In Tunnel', desc: 'Large accessible service tunnel.', cost: 220000, quality: 'wasteful', image: 'images/05_Route_03.png' }
                ]
            },
            stage2: {
                embedded: {
                    situation: 'Suspected leak somewhere in an embedded pipe section. The pipes are cast into concrete from the 2025 design - cannot visually confirm location.',
                    quote: "We've got activity readings suggesting a leak, but those embedded pipes from 2025 - they're buried in the concrete. I can't see where it's coming from. We either dig until we find it, route around it, or hope it stabilises. Your call.",
                    options: [
                        { 
                            id: 'excavate', 
                            name: 'Excavate concrete to find leak', 
                            desc: 'Dig until we locate the source. Create permanent access point.', 
                            cost: 70000, time: 12, dose: 4,
                            setState: { accessCreated: true }
                        },
                        { 
                            id: 'bypass', 
                            name: 'Install bypass line around section', 
                            desc: 'Route around the problem entirely. Original section abandoned.', 
                            cost: 90000, time: 8, dose: 2,
                            setState: { accessCreated: true }
                        },
                        { 
                            id: 'defer', 
                            name: 'Increase monitoring and defer', 
                            desc: 'Hope it stabilises. Monitor closely.', 
                            cost: 10000, time: 0, dose: 0, healthImpact: -10,
                            setState: { contaminationSpread: true }
                        }
                    ]
                },
                ducted: {
                    situation: 'Minor leak detected at a pipe joint. The accessible ducts from the 2025 design allow easy location and access.',
                    quote: "Found a small leak - pulled off the duct cover from that 2025 design and there it is, plain as day. Easy to see, easy to fix. Standard repair or should I check the neighbouring joints while I'm here?",
                    options: [
                        { id: 'repair', name: 'Standard repair', desc: 'Fix the leaking joint.', cost: 15000, time: 2, dose: 1 },
                        { id: 'inspect', name: 'Repair and inspect neighbours', desc: 'Check adjacent joints while access is open.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Leak repaired easily with walk-in access. However, the tunnel surfaces from 2025 are showing contamination migration.',
                    quote: "Easy access through the tunnel to fix the leak - that 2025 design makes repairs simple. But the tunnel walls themselves are picking up contamination. We should deal with that while we're here. Clean it or seal it?",
                    options: [
                        { id: 'repair', name: 'Repair and decontaminate tunnel', desc: 'Fix leak and clean surfaces.', cost: 35000, time: 4, dose: 2 },
                        { 
                            id: 'seal', 
                            name: 'Repair and seal contamination', 
                            desc: 'Contain it for now. Defer full decon.', 
                            cost: 25000, time: 3, dose: 1.5, healthImpact: -3,
                            setState: { contaminationSpread: true }
                        }
                    ]
                }
            },
            stage3: {
                embedded: {
                    checkElementState: true,
                    scenarios: {
                        accessCreated: {
                            situation: 'In-Service Inspection time. The excavation or bypass from 2040 created some access points, improving the situation slightly.',
                            quote: "Those embedded pipes from 2025 are still mostly buried, but the work we did in 2040 gave us a couple of access points. I can at least examine some sections now. Still limited though. What's the approach?",
                            options: [
                                { id: 'maximise', name: 'Maximise inspection at access points', desc: 'Full examination where we can reach.', cost: 35000, time: 5, dose: 2 },
                                { 
                                    id: 'extend', 
                                    name: 'Extend access and install monitoring', 
                                    desc: 'Create more access points and add guided wave sensors.', 
                                    cost: 80000, time: 10, dose: 3 
                                }
                            ]
                        },
                        contaminationSpread: {
                            situation: '⚠️ CONTAMINATION DETECTED: The leak deferred in 2040 has been spreading. Groundwater monitoring shows elevated activity levels.',
                            quote: "That leak we couldn't find in 2040 and decided to monitor? The groundwater results are in - activity spreading into the soil. We can't inspect the pipes but we can see where the contamination's going. This needs addressing.",
                            options: [
                                { 
                                    id: 'excavate', 
                                    name: 'Emergency excavation programme', 
                                    desc: 'Find and fix the source. Major work.', 
                                    cost: 150000, time: 18, dose: 8,
                                    setState: { accessCreated: true, contaminationSpread: false }
                                },
                                { 
                                    id: 'contain', 
                                    name: 'Groundwater containment and monitoring', 
                                    desc: 'Install barrier, treat water. Source remains.', 
                                    cost: 80000, time: 6, dose: 2,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        },
                        default: {
                            situation: 'In-Service Inspection required. The embedded pipes from 2025 cannot be examined by conventional ultrasonic or visual methods.',
                            quote: "How do I inspect pipes that are buried in concrete from 2025? The short answer is: I can't. Not with conventional methods. We can document the limitation, try guided wave technology, or excavate samples. What's the approach?",
                            options: [
                                { 
                                    id: 'accept', 
                                    name: 'Document inspection gap', 
                                    desc: 'Accept and document the limitation.', 
                                    cost: 5000, time: 1, dose: 0, healthImpact: -10,
                                    setState: { inspectionLimited: true }
                                },
                                { 
                                    id: 'guided', 
                                    name: 'Install guided wave monitoring', 
                                    desc: 'Some detection capability through concrete.', 
                                    cost: 60000, time: 5, dose: 1 
                                },
                                { 
                                    id: 'excavate', 
                                    name: 'Excavate sample locations', 
                                    desc: 'Physically expose sections for examination.', 
                                    cost: 100000, time: 14, dose: 5,
                                    setState: { accessCreated: true }
                                }
                            ]
                        }
                    }
                },
                ducted: {
                    situation: 'Full pipe inspection via removable duct covers from the 2025 design. Complete access available.',
                    quote: "Inspection time. Those duct covers from 2025 - lift them off and I've got full access to every inch of pipe. Complete coverage, no limitations. Standard inspection or add coating condition assessment?",
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Full visual and UT coverage.', cost: 15000, time: 3, dose: 1.5 },
                        { id: 'coating', name: 'Include coating condition assessment', desc: 'Check protective coating integrity.', cost: 22000, time: 4, dose: 2 }
                    ]
                },
                tunnel: {
                    checkElementState: true,
                    scenarios: {
                        contaminationSpread: {
                            situation: 'Tunnel inspection complicated by the contamination sealed in 2040. Sealed areas are now showing breakthrough.',
                            quote: "Remember sealing that contamination in 2040 instead of decontaminating? It's breaking through the sealant now. The tunnel's getting hotter. We need to deal with this properly or accept higher dose for all tunnel work.",
                            options: [
                                { id: 'decon', name: 'Full decontamination campaign', desc: 'Strip and clean all contaminated surfaces.', cost: 60000, time: 8, dose: 5 },
                                { 
                                    id: 'accept', 
                                    name: 'Accept elevated dose rates', 
                                    desc: 'Work in higher dose environment.', 
                                    cost: 15000, time: 4, dose: 4, healthImpact: -5 
                                }
                            ]
                        },
                        default: {
                            situation: 'Pipe inspection in the walk-in tunnel. Good access but the tunnel from 2025 is now contaminated, requiring full PPE.',
                            quote: "Easy pipe access through the tunnel, but 30 years of operation means it's contaminated now. Full suits required just to get in there. That 2025 tunnel design - easy access comes with dose penalty. Full inspection or remote camera?",
                            options: [
                                { id: 'suited', name: 'Full hands-on inspection in PPE', desc: 'Complete coverage but slower in suits.', cost: 25000, time: 5, dose: 3 },
                                { 
                                    id: 'remote', 
                                    name: 'Remote camera inspection', 
                                    desc: 'Limited contact but lower dose.', 
                                    cost: 30000, time: 4, dose: 1, healthImpact: -2,
                                    setState: { inspectionLimited: true }
                                }
                            ]
                        }
                    }
                }
            },
            stage4: {
                embedded: {
                    checkElementState: true,
                    scenarios: {
                        contaminationSpread: {
                            situation: '⚠️ ENVIRONMENTAL INCIDENT: Groundwater monitoring detects radioactive contamination. The embedded pipe leak has been spreading for decades.',
                            quote: "Remember that leak we couldn't find in 2040? The one in the embedded pipes from 2025 that we decided to monitor? It's been leaking into the groundwater for 30 years. Environmental regulator is involved. This is serious.",
                            additionalCosts: { regulatory: 50000, environmental: 100000, healthImpact: -15 },
                            options: [
                                { 
                                    id: 'excavate', 
                                    name: 'Emergency excavation and repair', 
                                    desc: 'Dig out the embedded section and fix it.', 
                                    cost: 200000, time: 21, dose: 8,
                                    setState: { accessCreated: true, contaminationSpread: false }
                                },
                                { id: 'treat', name: 'Groundwater treatment and isolation', desc: 'Treat the water, abandon the pipe section.', cost: 150000, time: 7, dose: 2 }
                            ]
                        },
                        inspectionLimited: {
                            situation: 'Operating with documented inspection gaps. The uninspected embedded sections are an ongoing concern.',
                            quote: "Those embedded pipes from 2025 that we documented as uninspectable in 2055 - we're still flying blind. Groundwater monitoring shows nothing abnormal... yet. But it's a known unknown. What's the approach?",
                            options: [
                                { id: 'continue', name: 'Continue monitoring regime', desc: 'Maintain current approach.', cost: 15000, time: 0, dose: 0 },
                                { 
                                    id: 'invest', 
                                    name: 'Invest in advanced monitoring', 
                                    desc: 'Deploy latest guided wave technology.', 
                                    cost: 45000, time: 3, dose: 1 
                                }
                            ]
                        },
                        accessCreated: {
                            situation: 'The access points created in previous work allow some monitoring of embedded sections.',
                            quote: "Those excavation points from earlier - they're proving useful. I can at least see into some of the embedded sections from 2025. Not complete coverage but better than nothing. Continue monitoring or extend access?",
                            options: [
                                { id: 'monitor', name: 'Monitor at existing access points', desc: 'Use what we have.', cost: 12000, time: 1, dose: 0.5 },
                                { id: 'extend', name: 'Extend access for better coverage', desc: 'Create additional inspection points.', cost: 50000, time: 6, dose: 2 }
                            ]
                        },
                        default: {
                            situation: 'Monitoring of embedded pipe sections continues. No activity detected in groundwater so far.',
                            quote: "Still monitoring those embedded pipes from 2025. Groundwater sampling shows nothing... yet. But we're flying blind on actual pipe condition. Continue monitoring or enhance detection capability?",
                            options: [
                                { id: 'maintain', name: 'Continue current monitoring', desc: 'Keep watching the groundwater.', cost: 15000, time: 0, dose: 0 },
                                { id: 'enhance', name: 'Enhanced monitoring network', desc: 'More sampling points, faster detection.', cost: 30000, time: 1, dose: 0 }
                            ]
                        }
                    }
                },
                ducted: {
                    situation: 'Quick operational checks through duct access. The 2025 design continues to provide excellent accessibility.',
                    quote: "Running operational checks. That ducted design from 2025 - I can pop the covers and do a visual check in minutes. Want the standard check or add thermal imaging for early leak detection?",
                    options: [
                        { id: 'visual', name: 'Routine visual inspection', desc: 'Quick visual through duct covers.', cost: 5000, time: 0, dose: 0 },
                        { id: 'thermal', name: 'Add thermal imaging survey', desc: 'Infrared check for developing leaks.', cost: 15000, time: 1, dose: 0 }
                    ]
                },
                tunnel: {
                    checkElementState: true,
                    scenarios: {
                        contaminationSpread: {
                            situation: 'Tunnel contamination has worsened. The sealed areas from 2055 have spread to previously clean sections.',
                            quote: "The contamination in that tunnel from 2025 has spread. Those areas we sealed years ago - breakthrough into new sections. The whole tunnel's getting hotter. We need a proper strategy now.",
                            options: [
                                { 
                                    id: 'major', 
                                    name: 'Major decontamination campaign', 
                                    desc: 'Full strip and clean of tunnel surfaces.', 
                                    cost: 80000, time: 10, dose: 6,
                                    setState: { contaminationSpread: false }
                                },
                                { id: 'manage', name: 'Enhanced contamination controls', desc: 'More frequent monitoring and local fixes.', cost: 30000, time: 3, dose: 2 }
                            ]
                        },
                        inspectionLimited: {
                            situation: 'Remote inspection regime continues. Camera coverage provides some assurance but isn\'t as good as hands-on examination.',
                            quote: "Still using remote cameras in the tunnel from that 2025 design. It's keeping dose down but I'm not as confident in the inspection quality. Any indication of developing issues?",
                            options: [
                                { id: 'continue', name: 'Continue remote approach', desc: 'Cameras only. Minimal dose.', cost: 15000, time: 2, dose: 0.5 },
                                { id: 'hands', name: 'Supplement with hands-on inspection', desc: 'Send team in for detailed checks.', cost: 30000, time: 4, dose: 3 }
                            ]
                        },
                        default: {
                            situation: 'Tunnel access maintained. Contamination levels stable but requiring ongoing control.',
                            quote: "Tunnel from 2025 - still accessible, still contaminated. We're maintaining the contamination controls but it's an ongoing burden. Status quo or invest in reducing the source term?",
                            options: [
                                { id: 'maintain', name: 'Continue routine monitoring', desc: 'Maintain current controls.', cost: 10000, time: 0, dose: 0.5 },
                                { id: 'decon', name: 'Partial decontamination campaign', desc: 'Reduce hotspots in the tunnel.', cost: 35000, time: 3, dose: 2 }
                            ]
                        }
                    }
                }
            },
            stage5: {
                embedded: {
                    checkElementState: true,
                    scenarios: {
                        contaminationSpread: {
                            situation: 'Catastrophic contamination situation. The embedded pipe leaks have contaminated a large volume of concrete and soil over decades.',
                            quote: "That embedded pipe design from 2025 combined with all those years of uncontrolled leakage - we're looking at hundreds of cubic metres of contaminated concrete and soil. The regulatory implications are severe. This is a major remediation project.",
                            options: [
                                { id: 'full', name: 'Full remediation programme', desc: 'Remove all contaminated material. Massive project.', cost: 850000, time: 72, dose: 30, healthImpact: -10 },
                                { id: 'contain', name: 'Engineered containment', desc: 'Barrier system and long-term monitoring. Cheaper but institutionally controlled.', cost: 500000, time: 36, dose: 12, healthImpact: -15 }
                            ]
                        },
                        accessCreated: {
                            situation: 'Mixed situation. Some access points were created, but significant concrete excavation still required.',
                            quote: "Those access points we created over the years help a bit - at least we know what we're dealing with in some sections. But most of the embedded pipes from 2025 are still buried. Major excavation still required, just with better knowledge.",
                            options: [
                                { id: 'targeted', name: 'Targeted excavation programme', desc: 'Focus on known problem areas first.', cost: 400000, time: 36, dose: 15 },
                                { id: 'specialist', name: 'Full specialist demolition', desc: 'Bring in experts for complete removal.', cost: 540000, time: 26, dose: 8 }
                            ]
                        },
                        default: {
                            situation: 'Pipes cast into concrete from 2025 require major excavation. Contamination has migrated into the concrete matrix itself.',
                            quote: "The embedded pipes from 2025 - now the contamination has soaked into the surrounding concrete over 60 years. We're not just removing pipes, we're removing contaminated structural concrete. Huge job. In-house or specialists?",
                            options: [
                                { id: 'excavate', name: 'Full in-house excavation', desc: 'Our teams break out all the concrete.', cost: 500000, time: 48, dose: 25 },
                                { id: 'specialist', name: 'Specialist demolition contractor', desc: 'Controlled demolition with contamination management.', cost: 570000, time: 30, dose: 10 }
                            ]
                        }
                    }
                },
                ducted: {
                    situation: 'Pipe removal via duct access. The ducts from 2025 remain uncontaminated and can be demolished as clean concrete.',
                    quote: "Best news I've had all project. Those duct covers from 2025 - lift them off, pull out the pipes, and the duct structures themselves are clean concrete. Standard demolition for the ducts. Want to assess if they could be kept for other use?",
                    options: [
                        { id: 'standard', name: 'Standard pipe and duct removal', desc: 'Remove pipes, demolish clean ducts.', cost: 50000, time: 8, dose: 2 },
                        { id: 'reuse', name: 'Assess duct structures for reuse', desc: 'Check if ducts can serve future purpose.', cost: 40000, time: 6, dose: 1.5 }
                    ]
                },
                tunnel: {
                    checkElementState: true,
                    scenarios: {
                        contaminationSpread: {
                            situation: 'The tunnel is heavily contaminated after years of contamination spread. ILW classification for the entire structure.',
                            quote: "That tunnel from 2025 - it's severely contaminated now after all those years of spread. Full ILW classification for the entire structure. We're looking at major disposal costs. Full strip-out or entombment?",
                            options: [
                                { id: 'strip', name: 'Full strip-out and disposal', desc: 'Remove everything. High volume ILW.', cost: 320000, time: 35, dose: 12 },
                                { id: 'entomb', name: 'Grout and entomb in place', desc: 'Seal forever. Cheaper but sterilises the site.', cost: 180000, time: 18, dose: 5, healthImpact: -8 }
                            ]
                        },
                        inspectionLimited: {
                            situation: 'Tunnel decommissioning with some unknown areas due to remote-only inspection history.',
                            quote: "The tunnel from 2025 needs to come out, but those areas we only ever inspected remotely - we don't know exactly what we're dealing with. Some surprises possible. Careful approach or accept uncertainty?",
                            options: [
                                { id: 'careful', name: 'Careful characterisation first', desc: 'Survey everything before removal.', cost: 250000, time: 28, dose: 9 },
                                { id: 'proceed', name: 'Proceed with contingency', desc: 'Start work, deal with surprises.', cost: 200000, time: 22, dose: 8, risk: 25 }
                            ]
                        },
                        default: {
                            situation: 'Pipes removed easily, but the tunnel from 2025 is contaminated infrastructure requiring disposal as intermediate level waste.',
                            quote: "Pipes came out clean - the tunnel gave us easy access right to the end. But the tunnel itself? 60 years of contamination buildup. It's ILW now. Large volume, complex disposal. Full decon or grout and entomb?",
                            options: [
                                { id: 'full', name: 'Full tunnel decommissioning', desc: 'Decontaminate and demolish.', cost: 220000, time: 25, dose: 8 },
                                { id: 'fill', name: 'Grout fill and entombment', desc: 'Seal in place with grout.', cost: 150000, time: 15, dose: 4, healthImpact: -5 }
                            ]
                        }
                    }
                }
            }
        },
        // ==========================================
        // ELEMENT 6: MATERIAL SPEC
        // ==========================================
        materialSpec: {
            title: 'Material Specification',
            stage1: {
                description: 'What material for primary circuit pipework?',
                options: [
                    { id: 'standard', name: 'Standard Stainless (Type 304)', desc: 'Industry standard austenitic. Susceptible to sensitization and IGSCC in BWR environments. ~2,500ppm cobalt.', cost: 100000, quality: 'poor', image: 'images/02_Pipe_01.png' },
                    { id: 'duplex', name: 'Duplex Stainless Steel', desc: 'Better resistance to stress corrosion cracking. Low cobalt (<500ppm). Slightly harder to weld.', cost: 140000, quality: 'good', image: 'images/02_Pipe_02.png' },
                    { id: 'exotic', name: 'Super Duplex / Nickel Alloy', desc: 'Premium corrosion resistance. Expensive, difficult fabrication. May contain problematic activation elements.', cost: 220000, quality: 'wasteful', image: 'images/02_Pipe_03.png' }
                ]
            },
            stage2: {
                standard: {
                    situation: 'Routine weld inspection reveals intergranular attack at heat-affected zones. Type 304 from 2025 is showing signs of sensitization - chromium depletion at grain boundaries.',
                    quote: "We've found intergranular corrosion starting at the HAZ of weld W-156. That Type 304 from 2025 - classic sensitization problem. Chromium is depleting at grain boundaries. This is exactly what the IGSCC literature warns about. We need to address it now.",
                    options: [
                        { 
                            id: 'treatment', 
                            name: 'Solution heat treatment of affected welds', 
                            desc: 'Restore chromium distribution. Delays sensitization progression.', 
                            cost: 45000, time: 6, dose: 3,
                            setState: { corrosionDetected: true }
                        },
                        { 
                            id: 'replace', 
                            name: 'Replace affected section with duplex', 
                            desc: 'Cut out sensitized material, weld in duplex section. Permanent fix.', 
                            cost: 95000, time: 12, dose: 5,
                            setState: { earlyReplacement: true }
                        },
                        { 
                            id: 'monitor', 
                            name: 'Enhanced monitoring only', 
                            desc: 'Document and watch. Hope the operating chemistry controls slow progression.', 
                            cost: 20000, time: 2, dose: 1, healthImpact: -5,
                            setState: { corrosionDetected: true }
                        }
                    ]
                },
                duplex: {
                    situation: 'Material examination shows excellent corrosion resistance. The duplex stainless from 2025 shows no sensitization or IGSCC initiation. Dose rates are manageable.',
                    quote: "Material condition looks excellent. That duplex steel from 2025 - no intergranular attack, no sensitization, dose rates as predicted. The extra cost in 2025 is paying off. Just confirming the maintenance approach.",
                    options: [
                        { id: 'standard', name: 'Standard maintenance procedures', desc: 'Normal approach - material is performing well.', cost: 15000, time: 2, dose: 1 },
                        { id: 'baseline', name: 'Detailed corrosion baseline', desc: 'Establish reference data for future comparison.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                exotic: {
                    situation: 'Dose rates significantly higher than predicted. The exotic nickel alloy from 2025 contains Ni-58 and Co-59 which activate under neutron flux to produce Ni-59 (76,000-year half-life), Ni-63 (100-year half-life), and Co-60 — activation products underestimated at design stage.',
                    quote: "Major problem. That exotic alloy looked great for corrosion resistance, but it's activating badly under neutron flux. Ni-59 has a 76,000 year half-life and we're making it by the gram. Plus the cobalt impurities are creating Co-60. Dose rates are double prediction.",
                    isModifier: true,
                    options: [
                        { 
                            id: 'accept', 
                            name: 'Accept enhanced ALARP controls', 
                            desc: 'Stricter dose restrictions, shorter work windows, more personnel rotation.', 
                            cost: 10000, time: 4, dose: 5,
                            setState: { doseConstraints: true }
                        },
                        { 
                            id: 'shield', 
                            name: 'Install permanent shielding', 
                            desc: 'Lead blankets and shadow shields on hot spots. Reduces dose but adds complexity.', 
                            cost: 55000, time: 6, dose: 3,
                            setState: { shieldingAdded: true }
                        },
                        { 
                            id: 'remote', 
                            name: 'Develop remote tooling capability', 
                            desc: 'Invest in manipulators and remote inspection. Long-term dose reduction.', 
                            cost: 80000, time: 8, dose: 4,
                            setState: { remoteTooling: true }
                        }
                    ]
                }
            },
            stage3: {
                standard: {
                    checkElementState: true,
                    scenarios: {
                        // Early replacement with duplex means no ongoing issues
                        earlyReplacement: {
                            situation: 'In-service inspection of pipework. The duplex sections installed in 2040 are performing excellently. Original 304 sections remain under surveillance.',
                            quote: "Good news on the duplex sections we installed in 2040 - no issues, excellent corrosion resistance. The original 304 areas need careful monitoring but we've addressed the worst spots. Standard ISI or enhanced scope?",
                            options: [
                                { id: 'standard', name: 'Standard in-service inspection', desc: 'Normal UT and visual per ASME XI.', cost: 20000, time: 3, dose: 1.5 },
                                { id: 'enhanced', name: 'Enhanced surveillance on remaining 304', desc: 'Extra attention to sensitized-prone areas.', cost: 35000, time: 5, dose: 2 }
                            ]
                        },
                        // Corrosion detected and only monitored - getting worse
                        corrosionDetected: {
                            situation: 'URGENT: Intergranular corrosion has progressed. Wall thickness measurements show thinning approaching minimum. IGSCC cracks detected at multiple welds.',
                            quote: "That sensitization we saw in 2040 - it's progressed exactly as the literature predicted. Wall thickness at 3 locations is approaching code minimum. We've got IGSCC cracks growing. The Type 304 from 2025 is failing. This needs major intervention.",
                            options: [
                                { 
                                    id: 'replace', 
                                    name: 'Major piping replacement campaign', 
                                    desc: 'Replace all affected 304 sections with duplex. Significant outage but permanent fix.', 
                                    cost: 200000, time: 18, dose: 8,
                                    setState: { earlyReplacement: true, corrosionDetected: false }
                                },
                                { 
                                    id: 'overlay', 
                                    name: 'Weld overlay reinforcement', 
                                    desc: 'Add material over thin areas. Buys time but doesn\'t fix root cause.', 
                                    cost: 80000, time: 8, dose: 5,
                                    setState: { doseConstraints: true }
                                },
                                { 
                                    id: 'chemistry', 
                                    name: 'Modified water chemistry controls', 
                                    desc: 'Hydrogen water chemistry to slow IGSCC. Industry standard mitigation.', 
                                    cost: 45000, time: 3, dose: 2, healthImpact: -5
                                }
                            ]
                        },
                        // Default - 304 showing age
                        default: {
                            situation: 'In-service inspection reveals elevated dose rates limiting close-approach work. The activated standard steel from 2025 constrains inspection techniques.',
                            quote: "Inspection time, but that standard 304 from 2025 is running hot - 15 years of Co-60 buildup. I need to keep my distance, which affects probe positioning. Extended reach equipment or accept constraints?",
                            isModifier: true,
                            options: [
                                { 
                                    id: 'standoff', 
                                    name: 'Extended reach inspection', 
                                    desc: 'Longer probe extensions, some accuracy loss.', 
                                    cost: 18000, time: 4, dose: 4,
                                    setState: { doseConstraints: true }
                                },
                                { 
                                    id: 'shielded', 
                                    name: 'Invest in shielded inspection equipment', 
                                    desc: 'Better equipment for close-approach work in hot areas.', 
                                    cost: 40000, time: 5, dose: 2,
                                    setState: { shieldingAdded: true }
                                }
                            ]
                        }
                    }
                },
                duplex: {
                    situation: 'In-service inspection shows excellent material condition. The duplex stainless from 2025 has no IGSCC susceptibility and low activation. Straightforward ISI.',
                    quote: "Material examination going smoothly. That duplex specification from 2025 - no sensitization issues, no IGSCC concerns, dose rates manageable. The premium specification is proving its worth. Standard ISI or detailed baseline?",
                    options: [
                        { id: 'standard', name: 'Standard in-service inspection', desc: 'Normal techniques, full coverage. Easy access due to low dose rates.', cost: 12000, time: 2, dose: 1 },
                        { id: 'baseline', name: 'Detailed condition baseline', desc: 'Extra measurements for future trending.', cost: 20000, time: 3, dose: 1.5 }
                    ]
                },
                exotic: {
                    checkElementState: true,
                    scenarios: {
                        remoteTooling: {
                            situation: 'Inspection using remote systems developed in 2040. The exotic alloy remains extremely active but we can work around it.',
                            quote: "That remote inspection kit we bought in 2040 is earning its keep. The exotic alloy is still extremely hot, but I can get full coverage without exceeding dose limits. Technology compensating for poor material choice.",
                            options: [
                                { id: 'remote', name: 'Full remote inspection campaign', desc: 'Complete ISI using manipulators and robots.', cost: 35000, time: 4, dose: 1 },
                                { id: 'hybrid', name: 'Hybrid remote/manual approach', desc: 'Remote for hot spots, hands-on elsewhere.', cost: 25000, time: 3, dose: 2 }
                            ]
                        },
                        shieldingAdded: {
                            situation: 'Inspection behind permanent shielding. Access is constrained but dose rates are manageable.',
                            quote: "Working behind the shielding we installed in 2040. The exotic alloy would kill dose budgets otherwise. Some access constraints from the lead blankets but we can get the job done.",
                            options: [
                                { id: 'careful', name: 'Careful inspection around shielding', desc: 'Work within the constraints.', cost: 30000, time: 5, dose: 2 },
                                { id: 'temporary', name: 'Temporarily remove shielding for full access', desc: 'Better inspection but higher dose.', cost: 25000, time: 4, dose: 4 }
                            ]
                        },
                        default: {
                            situation: 'Extremely high dose rates make inspection challenging. The exotic alloy from 2025 requires specialist high-dose contractors.',
                            quote: "That exotic alloy from 2025 - it's so hot now our regular inspection teams can't get near it safely. Specialist contractors needed, or we accept limited coverage.",
                            isModifier: true,
                            options: [
                                { 
                                    id: 'specialist', 
                                    name: 'Hire specialist high-dose contractor', 
                                    desc: 'Experts with special shielding and experience.', 
                                    cost: 60000, time: 6, dose: 3,
                                    setState: { doseConstraints: true }
                                },
                                { 
                                    id: 'limited', 
                                    name: 'Accept limited inspection coverage', 
                                    desc: 'Do what we can safely. Document gaps.', 
                                    cost: 25000, time: 3, dose: 4, healthImpact: -5,
                                    setState: { doseConstraints: true }
                                }
                            ]
                        }
                    }
                }
            },
            stage4: {
                standard: {
                    checkElementState: true,
                    scenarios: {
                        earlyReplacement: {
                            situation: 'Operations running smoothly. The 2055 replacement campaign eliminated the worst IGSCC-susceptible material. Remaining 304 is stable.',
                            quote: "That replacement campaign in 2055 was the right call. The new duplex sections are performing perfectly, and the remaining original 304 has stabilised with the chemistry controls. No operational constraints.",
                            options: [
                                { id: 'maintain', name: 'Maintain current approach', desc: 'Continue with proven strategy.', cost: 10000, time: 0, dose: 0.5 },
                                { id: 'extend', name: 'Extend replacement to additional sections', desc: 'Proactive replacement before problems develop.', cost: 45000, time: 5, dose: 2 }
                            ]
                        },
                        doseConstraints: {
                            situation: 'Cumulative workforce dose approaching annual limits. The activated standard steel from 2025 constrains operational flexibility. Dose budgets are tight.',
                            quote: "We're running into dose limit problems. That Type 304 from 2025 with all its cobalt - 45 years of activation means we're burning through dose budget fast. Every job is a dose planning exercise.",
                            options: [
                                { id: 'contractors', name: 'Bring in additional contractors', desc: 'More workers to share the dose burden.', cost: 90000, time: 0, dose: 0 },
                                { id: 'permanent_shield', name: 'Install permanent walk-in shielding', desc: 'Major investment but long-term dose reduction.', cost: 70000, time: 8, dose: 0 },
                                { id: 'extend', name: 'Accept extended work schedules', desc: 'Spread dose over more time. Delays projects.', cost: 30000, time: 12, dose: 0 }
                            ]
                        },
                        default: {
                            situation: 'Operations constrained by dose rates from activated 304 stainless steel. The 2025 material choice affecting daily work even 45 years later.',
                            quote: "Every time we need work done in that area, it's a dose planning headache. The Type 304 from 2025 has been accumulating Co-60 for 45 years. We're constantly rotating workers to stay under limits.",
                            options: [
                                { id: 'manage', name: 'Continue dose management programme', desc: 'Keep rotating workers, planning around hot spots.', cost: 25000, time: 2, dose: 0 },
                                { id: 'invest', name: 'Invest in permanent dose reduction', desc: 'Shielding and remote access improvements.', cost: 80000, time: 6, dose: 0 }
                            ]
                        }
                    }
                },
                duplex: {
                    situation: 'Full operational flexibility maintained. Dose rates remain low thanks to the low-cobalt duplex specification from 2025.',
                    quote: "Dose budgets looking healthy even at 45 years. That duplex decision in 2025 gives us complete flexibility - no constraints on work planning, no limit problems. This is how it should be.",
                    options: [
                        { id: 'maintain', name: 'Standard operations', desc: 'Continue normal working.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'bank', name: 'Bank dose margin for contingencies', desc: 'Reserve capacity for unexpected work.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                exotic: {
                    checkElementState: true,
                    scenarios: {
                        remoteTooling: {
                            situation: 'Operations only possible with remote systems. The exotic alloy from 2025 creates extreme activation but remote capabilities allow continued operation.',
                            quote: "That remote investment in 2040 - we'd be shut down without it. The exotic alloy areas are essentially no-go zones for humans now. But the robots don't care about dose rates.",
                            options: [
                                { id: 'continue', name: 'Continue remote-only operations', desc: 'Maintain current remote capability.', cost: 45000, time: 2, dose: 0 },
                                { id: 'expand', name: 'Expand remote operational capability', desc: 'More tasks remotely. Less human involvement.', cost: 80000, time: 5, dose: 0 }
                            ]
                        },
                        default: {
                            situation: 'Severe dose constraints limit all work. The exotic nickel alloy from 2025 has created extreme activation levels after 45 years.',
                            quote: "We can barely get near the primary circuit. That exotic alloy from 2025 - after 45 years of activation, work windows are measured in minutes. Major operational constraints affecting availability.",
                            options: [
                                { id: 'rotating', name: 'Rotating contractor teams', desc: 'Many workers, very short exposures each.', cost: 130000, time: 6, dose: 0 },
                                { id: 'restrict', name: 'Severely restrict operations', desc: 'Accept major operational limitations.', cost: 40000, time: 0, dose: 0, healthImpact: -10 }
                            ]
                        }
                    }
                }
            },
            stage5: {
                standard: {
                    checkElementState: true,
                    scenarios: {
                        earlyReplacement: {
                            situation: 'Decommissioning with mixed materials. Duplex replacement sections can potentially be hands-on. Original 304 sections require careful characterisation.',
                            quote: "Mixed picture for decommissioning. The duplex sections we installed are manageable - might even be LLW after decay storage. The original 304 from 2025 is still too active for hands-on work. Two-stream approach needed.",
                            options: [
                                { id: 'segregate', name: 'Material-segregated decommissioning', desc: 'Handle duplex and 304 separately. Optimise waste routing.', cost: 90000, time: 12, dose: 3 },
                                { id: 'combined', name: 'Combined removal approach', desc: 'Treat everything as higher category waste. Simpler but more expensive disposal.', cost: 120000, time: 10, dose: 4 }
                            ]
                        },
                        default: {
                            situation: 'After 5-year decay storage, components with standard 304 steel remain highly active from Co-60. Remote handling required for most work.',
                            quote: "Five years of decay storage and that Type 304 from 2025 is still too hot for hands-on work. 2,500ppm cobalt means decades more before it cools to manageable levels. Full remote handling required.",
                            options: [
                                { id: 'remote', name: 'In-house remote handling', desc: 'Our teams with manipulators. Learning curve but we have time.', cost: 140000, time: 20, dose: 6 },
                                { id: 'specialist', name: 'Specialist remote handling contractor', desc: 'Experienced operators, proven techniques, faster completion.', cost: 220000, time: 14, dose: 2 }
                            ]
                        }
                    }
                },
                duplex: {
                    situation: 'After 5-year decay, the low-cobalt duplex materials from 2025 allow hands-on work with standard PPE. Some components may qualify as LLW.',
                    quote: "Five years decay and that duplex steel from 2025 is cool enough for hands-on work. The low cobalt specification - some of this might even qualify as LLW instead of ILW. Major cost saving at the end.",
                    options: [
                        { id: 'handson', name: 'Hands-on removal and characterisation', desc: 'Direct handling with standard PPE. Efficient and controlled.', cost: 65000, time: 10, dose: 2 },
                        { id: 'optimise', name: 'Detailed waste characterisation for LLW', desc: 'Maximum effort to classify as lower category waste.', cost: 85000, time: 12, dose: 2.5 }
                    ]
                },
                exotic: {
                    situation: 'The exotic nickel alloy from 2025 contains Ni-63 with a 100-year half-life. These components will remain highly active for centuries.',
                    quote: "That exotic alloy from 2025 - the Nickel-63 has a 100-year half-life. Five years of decay makes essentially no difference. This material will be highly active long after we're all dead. Century-scale storage required.",
                    options: [
                        { id: 'extended', name: 'Extended remote decommissioning', desc: 'Very slow, very careful, very expensive. Minimise secondary waste.', cost: 400000, time: 45, dose: 18 },
                        { id: 'storage', name: 'Long-term interim storage', desc: 'Store for decades, let decay reduce activity. Pass the problem to the future.', cost: 320000, time: 15, dose: 5 },
                        { id: 'specialist', name: 'Specialist handling plus GDF disposal', desc: 'Expert removal, direct to geological disposal. Expensive but final.', cost: 500000, time: 30, dose: 7 }
                    ]
                }
            }
        }
    }
};
// ============================================
// GAME STATE
// ============================================
const STATE = {
    stage: 1,
    designChoices: {},     // Stage 1 choices
    stageChoices: {},      // Choices per stage per element
    completed: {},         // Elements completed per stage
    triggers: {},          // Active triggers
    flags: {},             // Boolean flags
    totals: { cost: 0, dose: 0, time: 0 },
    stageTotals: {},
    plantHealth: 100,
    injuries: 0,
    // Element-specific state for compounding consequences
    elementState: {
        pumpAccess: {
            accessFixed: false,
            workaroundUsed: false,
            inspectionGap: false,
            deteriorating: false
        },
        weldClearance: {
            clearanceImproved: false,
            specialToolingUsed: false,
            inspectionLimited: false,
            deteriorating: false,
            leakOccurred: false
        },
        controlPanel: {
            layoutModified: false,
            backupInstalled: false,
            trainingEnhanced: false,
            operatorError: false
        },
        pipeConnections: {
            flangingAdded: false,
            weldCutMade: false,
            inspectionLimited: false,
            boltDegradation: false,
            leakHistory: false,
            deteriorating: false
        },
        pipeRouting: {
            accessCreated: false,
            cableConflict: false,
            contaminationSpread: false,
            inspectionLimited: false
        },
        materialSpec: {
            corrosionDetected: false,
            earlyReplacement: false,
            shieldingAdded: false,
            remoteTooling: false,
            doseConstraints: false
        }
    }
};
// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatMoney(n) { return '£' + n.toLocaleString(); }
function getRemainingBudget() {
    // Only used for Stage 1
    const stage = GAME_DATA.stages[STATE.stage];
    return stage.budget - STATE.totals.cost;
}
// ============================================
// INTRO
// ============================================
let currentSlide = 1;
const totalSlides = 4;
function updateIntroSlide() {
    document.querySelectorAll('.intro-slide').forEach(s => s.classList.remove('active'));
    document.querySelector(`.intro-slide[data-slide="${currentSlide}"]`).classList.add('active');
    document.querySelectorAll('.intro-dot').forEach((d, i) => {
        d.classList.remove('active', 'done');
        if (i + 1 === currentSlide) d.classList.add('active');
        else if (i + 1 < currentSlide) d.classList.add('done');
    });
    document.getElementById('btnIntroNext').textContent = currentSlide === totalSlides ? 'Begin →' : 'Continue →';
}
document.getElementById('btnIntroNext').onclick = () => {
    if (currentSlide < totalSlides) { currentSlide++; updateIntroSlide(); }
    else endIntro();
};
document.getElementById('btnSkip').onclick = endIntro;
document.querySelectorAll('.intro-dot').forEach(d => {
    d.onclick = () => { currentSlide = parseInt(d.dataset.dot); updateIntroSlide(); };
});
function endIntro() {
    document.getElementById('cinematicIntro').classList.add('hidden');
    document.getElementById('gameScreen').classList.add('active');
    startStage(1);
}
// ============================================
// STAGE MANAGEMENT
// ============================================
function startStage(stageNum) {
    STATE.stage = stageNum;
    STATE.completed[stageNum] = {};
    STATE.stageTotals[stageNum] = { cost: 0, dose: 0, time: 0 };
    const stage = GAME_DATA.stages[stageNum];
    // Update timeline
    updateTimeline(stageNum);
    updateStatsDisplay();
    // Update squares to show selected designs
    updateHotspotSquares();
    // Character banner
    const banner = document.getElementById('characterBanner');
    if (stageNum > 1 && stage.char) {
        const char = GAME_DATA.characters[stage.char];
        banner.className = `character-banner visible ${stage.char}`;
        const portrait = document.getElementById('charPortrait');
        if (char.image) {
            portrait.innerHTML = `<img src="${char.image}" alt="${char.name}">`;
        } else {
            portrait.textContent = char.emoji;
        }
        document.getElementById('charName').textContent = char.name;
        document.getElementById('charRole').textContent = char.role;
    } else {
        banner.classList.remove('visible');
    }
    // Reset hotspot squares for new stage - remove done state
    document.querySelectorAll('.hotspot-square').forEach(sq => {
        sq.classList.remove('done');
    });
    document.getElementById('btnNextStage').classList.remove('visible');
    updateProgressLabel();
}
function updateTimeline(currentStage) {
    document.querySelectorAll('.timeline-stage').forEach(stage => {
        const stageNum = parseInt(stage.dataset.stage);
        stage.classList.remove('completed', 'current', 'future');
        if (stageNum < currentStage) {
            stage.classList.add('completed');
        } else if (stageNum === currentStage) {
            stage.classList.add('current');
        } else {
            stage.classList.add('future');
        }
    });
    // Update progress bar (0% at stage 1, 100% at stage 5)
    const progressPercent = ((currentStage - 1) / 4) * 100;
    document.getElementById('timelineProgress').style.width = `${progressPercent}%`;
}
function updateStatsDisplay() {
    const stage = GAME_DATA.stages[STATE.stage];
    const remaining = getRemainingBudget();
    let html = '';
    if (STATE.stage === 1) {
        // Stage 1: Show remaining design budget
        const cls = remaining < 100000 ? (remaining < 0 ? 'danger' : 'warning') : '';
        html = `<div class="stat">💰 Design Budget: <span class="stat-value ${cls}">${formatMoney(remaining)}</span></div>`;
    } else {
        // Stages 2-5: Show accumulated costs
        const st = STATE.stageTotals[STATE.stage] || { cost: 0, dose: 0, time: 0 };
        html = `
            <div class="stat">💰 Cost: <span class="stat-value" style="color: var(--blue);">${formatMoney(st.cost)}</span></div>
            <div class="stat">☢️ <span class="stat-value">${st.dose.toFixed(1)} mSv</span></div>
            <div class="stat">⏱️ <span class="stat-value">${st.time} days</span></div>
            <div class="stat">❤️ <span class="stat-value ${STATE.plantHealth < 60 ? 'danger' : ''}">${STATE.plantHealth}%</span></div>
        `;
    }
    document.getElementById('topStats').innerHTML = html;
}
function updateProgressLabel() {
    const done = Object.keys(STATE.completed[STATE.stage] || {}).length;
    document.getElementById('progressLabel').textContent = `${done} of 6 complete`;
    if (done === 6) {
        document.getElementById('btnNextStage').classList.add('visible');
    }
}
// ============================================
// HOTSPOT CLICKS
// ============================================
document.querySelectorAll('.hotspot').forEach(h => {
    h.onclick = () => {
        const elId = h.dataset.element;
        // In Stage 1, can always click (to change decision)
        // In Stages 2-5, can only click if not completed (decisions are final)
        if (STATE.stage > 1 && STATE.completed[STATE.stage]?.[elId]) {
            return; // Decision already made, can't change
        }
        openElementModal(elId);
    };
});
// ============================================
// HOTSPOT SQUARE UPDATE
// ============================================
function updateHotspotSquares() {
    const elements = ['pumpAccess', 'weldClearance', 'controlPanel', 'pipeConnections', 'pipeRouting', 'materialSpec'];
    elements.forEach(elId => {
        const square = document.getElementById(`square-${elId}`);
        if (!square) return;
        const label = square.querySelector('.hotspot-square-label');
        const choice = STATE.designChoices[elId];
        if (choice) {
            const element = GAME_DATA.elements[elId];
            const opt = element.stage1.options.find(o => o.id === choice);
            square.classList.add('selected');
            // Show image if available
            if (opt.image) {
                // Remove existing image if any
                const existingImg = square.querySelector('img');
                if (existingImg) existingImg.remove();
                const img = document.createElement('img');
                img.src = opt.image;
                img.alt = opt.name;
                square.insertBefore(img, label);
            }
            // Update label
            if (label) label.textContent = opt.name;
        } else {
            square.classList.remove('selected');
            const existingImg = square.querySelector('img');
            if (existingImg) existingImg.remove();
            const element = GAME_DATA.elements[elId];
            if (label) label.textContent = element.title;
        }
    });
}
// ============================================
// MODAL SYSTEM
// ============================================
function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { 
    document.getElementById('modalOverlay').classList.remove('active');
    // Clean up pipe routing game if active
    if (typeof pipeGameState !== 'undefined') {
        if (pipeGameState.tunnelInterval) {
            clearInterval(pipeGameState.tunnelInterval);
            pipeGameState.tunnelInterval = null;
        }
        pipeGameState.tunnelActive = false;
        if (typeof handleTunnelKeyPress === 'function') {
            document.removeEventListener('keydown', handleTunnelKeyPress);
        }
    }
}
document.getElementById('modalClose').onclick = closeModal;
document.getElementById('modalOverlay').onclick = (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
};
function openElementModal(elId) {
    const element = GAME_DATA.elements[elId];
    document.getElementById('modalTitle').textContent = element.title;
    if (STATE.stage === 1) {
        renderDesignModal(elId, element);
    } else {
        renderDecisionModal(elId, element);
    }
    openModal();
}
// ============================================
// STAGE 1: DESIGN
// ============================================
function renderDesignModal(elId, element) {
    const data = element.stage1;
    const remaining = getRemainingBudget();
    // Calculate what we'd have if we refund current choice
    let availableBudget = remaining;
    if (STATE.designChoices[elId]) {
        const currentChoice = data.options.find(o => o.id === STATE.designChoices[elId]);
        availableBudget += currentChoice.cost;
    }
    let html = '';
    // Context bar with budget
    html += `
        <div class="context-bar">
            <span class="context-design">📅 Year 2025 · Design Phase</span>
            <span class="context-cost">💰 Budget: ${formatMoney(availableBudget)}</span>
        </div>
    `;
    // Situation panel - the question
    html += `
        <div class="situation-panel">
            <div class="situation-label">Design Decision Required</div>
            <div class="situation-text">${data.description}</div>
        </div>
    `;
    // Decision section header
    html += `
        <div class="decision-section">
            <div class="decision-header">
                <span class="decision-label">Choose Your Approach</span>
                <div class="decision-line"></div>
            </div>
            <div class="design-cards-grid">
    `;
    // Sort options by cost (cheapest first)
    const sortedOptions = [...data.options].sort((a, b) => a.cost - b.cost);
    sortedOptions.forEach(opt => {
        const sel = STATE.designChoices[elId] === opt.id ? 'selected' : '';
        const affordable = opt.cost <= availableBudget;
        const disabledClass = affordable ? '' : 'disabled';
        // Use actual image if available, otherwise show placeholder
        const imageContent = opt.image 
            ? `<img src="${opt.image}" alt="${opt.name}" onerror="this.parentElement.innerHTML='[${opt.name}]'">`
            : `[${opt.name}]`;
        html += `
            <div class="design-card ${sel} ${disabledClass}" data-id="${opt.id}" data-cost="${opt.cost}">
                <div class="design-card-image">${imageContent}</div>
                <div class="design-card-cost">${formatMoney(opt.cost)}</div>
                <div class="design-card-body">
                    <div class="design-card-name">${opt.name}</div>
                    <p class="design-card-desc">${opt.desc}</p>
                    ${!affordable ? '<div class="disabled-reason">⚠️ Insufficient budget</div>' : ''}
                </div>
            </div>
        `;
    });
    html += '</div></div>';
    document.getElementById('modalBody').innerHTML = html;
    const hasExistingChoice = !!STATE.designChoices[elId];
    const btnText = hasExistingChoice ? 'Update Selection' : 'Confirm Selection';
    const btnDisabled = hasExistingChoice ? '' : 'disabled';
    document.getElementById('modalFooter').innerHTML = `<button class="btn btn-primary" id="btnConfirmDesign" ${btnDisabled}>${hasExistingChoice ? btnText : 'Select an Option'}</button>`;
    // Store options for lookup
    const designOptionsArray = sortedOptions;
    let selectedDesignId = STATE.designChoices[elId] || null;
    const designCards = document.querySelectorAll('.design-card:not(.disabled)');
    const designBtn = document.getElementById('btnConfirmDesign');
    for (let i = 0; i < designCards.length; i++) {
        designCards[i].onclick = function() {
            for (let j = 0; j < designCards.length; j++) {
                designCards[j].classList.remove('selected');
            }
            this.classList.add('selected');
            selectedDesignId = this.getAttribute('data-id');
            designBtn.disabled = false;
            designBtn.textContent = 'Confirm Selection';
        };
    }
    designBtn.onclick = function() {
        if (!selectedDesignId) return;
        let opt = null;
        for (let i = 0; i < designOptionsArray.length; i++) {
            if (designOptionsArray[i].id === selectedDesignId) {
                opt = designOptionsArray[i];
                break;
            }
        }
        if (!opt) {
            console.error('Design option not found:', selectedDesignId);
            return;
        }
        // Refund old if changing
        if (STATE.designChoices[elId]) {
            let oldOpt = null;
            for (let i = 0; i < designOptionsArray.length; i++) {
                if (designOptionsArray[i].id === STATE.designChoices[elId]) {
                    oldOpt = designOptionsArray[i];
                    break;
                }
            }
            if (oldOpt) STATE.totals.cost -= oldOpt.cost;
        }
        STATE.designChoices[elId] = selectedDesignId;
        STATE.completed[1][elId] = true;
        STATE.totals.cost += opt.cost;
        updateHotspotSquares();
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}
// ============================================
// WELD INSPECTION MINI-GAME (Stage 3 - Weld Clearance)
// ============================================
let weldGameState = {
    variant: null,
    totalPoints: 8,
    scannedPoints: [],
    blockedPoints: [],
    isAnimating: false,
    roboticInspection: false,
    currentStageData: null,
    currentElId: null,
    currentElement: null
};

const WELD_POINT_ANGLES = [
    { id: 'A', angle: 180 },
    { id: 'B', angle: 225 },
    { id: 'C', angle: 270 },
    { id: 'D', angle: 315 },
    { id: 'E', angle: 0 },
    { id: 'F', angle: 45 },
    { id: 'G', angle: 90 },
    { id: 'H', angle: 135 }
];

const WELD_VARIANTS = {
    '50mm': {
        wallWidth: 150,
        pipeLeft: 220,
        blockedPoints: ['A', 'B', 'H'],
        useScaffolding: false,
        roboticInspection: false
    },
    '150mm': {
        wallWidth: 80,
        pipeLeft: 180,
        blockedPoints: [],
        useScaffolding: false,
        roboticInspection: false
    },
    '300mm': {
        wallWidth: 0,
        pipeLeft: 250,
        blockedPoints: [],
        useScaffolding: true,
        roboticInspection: true
    }
};

function renderWeldInspectionGame(elId, element) {
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    const stage = GAME_DATA.stages[STATE.stage];
    let stageData = element[stageKey]?.[designChoice];
    
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element at this stage.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    
    // Handle element state-based scenarios
    if (stageData.checkElementState && stageData.scenarios) {
        const elState = STATE.elementState[elId] || {};
        const statePriority = [
            'deteriorating', 'inspectionLimited', 'clearanceImproved', 'specialToolingUsed'
        ];
        let matchedScenario = null;
        for (const state of statePriority) {
            if (elState[state] && stageData.scenarios[state]) {
                matchedScenario = stageData.scenarios[state];
                break;
            }
        }
        if (!matchedScenario) {
            matchedScenario = stageData.scenarios.default || stageData.scenarios[Object.keys(stageData.scenarios)[0]];
        }
        stageData = matchedScenario;
    }
    
    // Store for later
    weldGameState.currentStageData = stageData;
    weldGameState.currentElId = elId;
    weldGameState.currentElement = element;
    
    const variantConfig = WELD_VARIANTS[designChoice] || WELD_VARIANTS['150mm'];
    weldGameState.variant = designChoice;
    weldGameState.scannedPoints = [];
    weldGameState.blockedPoints = [...variantConfig.blockedPoints];
    weldGameState.isAnimating = false;
    weldGameState.roboticInspection = variantConfig.roboticInspection;
    
    const char = GAME_DATA.characters[stage.char];
    const stageCost = STATE.stageTotals[STATE.stage]?.cost || 0;
    
    let html = `
        <div class="context-bar">
            <span class="context-design">📅 Year ${stage.year} · 2025 Design: <strong>${designOpt.name}</strong></span>
            <span class="context-cost">💰 Stage Cost: ${formatMoney(stageCost)}</span>
        </div>
        <div class="situation-panel">
            <div class="situation-label">Current Situation</div>
            <div class="situation-text">${stageData.situation}</div>
        </div>
        <div class="weld-game-container">
            <div class="weld-game-header">
                <span class="weld-game-title">🔬 Ultrasonic Weld Inspection</span>
                <div class="weld-game-stats">
                    <div class="weld-stat">📐 Clearance: <span class="weld-stat-value">${designChoice}</span></div>
                    <div class="weld-stat">🎯 Scanned: <span class="weld-stat-value" id="weldPointsValue">0 / 8</span></div>
                </div>
            </div>
            <div class="weld-viewport" id="weldViewport">
                <div class="weld-wall" id="weldWall" style="width: ${variantConfig.wallWidth}px;">
                    <span class="weld-wall-label">Concrete Wall</span>
                    ${variantConfig.wallWidth > 0 ? `<span class="weld-wall-dim">Gap: ${designChoice}</span>` : ''}
                </div>
                <div class="weld-scaffold-rail left ${variantConfig.useScaffolding ? 'visible' : ''}" id="weldScaffoldL"></div>
                <div class="weld-scaffold-rail right ${variantConfig.useScaffolding ? 'visible' : ''}" id="weldScaffoldR"></div>
                <span class="weld-scaffold-label left ${variantConfig.useScaffolding ? 'visible' : ''}">◀ Scaffold</span>
                <span class="weld-scaffold-label right ${variantConfig.useScaffolding ? 'visible' : ''}">Scaffold ▶</span>
                <div class="weld-robot-badge" id="weldRobotBadge">🤖 ROBOTIC INSPECTION ENABLED</div>
                <div class="weld-blocked-msg" id="weldBlockedMsg">⚠️ ACCESS BLOCKED</div>
                <div class="weld-pipe-section" id="weldPipeSection" style="left: ${variantConfig.pipeLeft}px;">
                    <div class="weld-pipe-outer"></div>
                    <div class="weld-ring">
                        <span class="weld-ring-label">WELD SEAM</span>
                    </div>
                    <div class="weld-pipe-inner">
                        <span class="weld-pipe-inner-label">Pipe<br>Interior</span>
                    </div>
                    <div id="weldPoints"></div>
                </div>
                <div class="weld-probe" id="weldProbe">
                    <img src="images/prop_probe.png" alt="UT Probe">
                </div>
            </div>
            <div class="weld-coverage-panel">
                <div class="weld-coverage-header">
                    <span class="weld-coverage-label">Weld Coverage</span>
                    <span class="weld-coverage-value" id="weldCoverageValue">0%</span>
                </div>
                <div class="weld-coverage-bar">
                    <div class="weld-coverage-fill" id="weldCoverageFill" style="width: 0%"></div>
                </div>
                <div class="weld-coverage-detail">
                    <span><span class="weld-dot complete"></span> Scanned: <span id="weldScannedCount">0</span></span>
                    <span><span class="weld-dot blocked"></span> Blocked: <span id="weldBlockedCount">${variantConfig.blockedPoints.length}</span></span>
                    <span><span class="weld-dot pending"></span> Remaining: <span id="weldRemainingCount">${8 - variantConfig.blockedPoints.length}</span></span>
                </div>
            </div>
            <div class="weld-status-msg" id="weldStatusMsg">Click inspection points (A-H) around the weld to scan each location.</div>
        </div>
        <div class="speech-bubble">
            <div class="speech-portrait">${char.image ? `<img src="${char.image}" alt="${char.name}">` : char.emoji}</div>
            <div class="speech-name">${char.name}, ${char.role}</div>
            <div class="speech-text">"${stageData.quote}"</div>
        </div>
        <div id="weldDecisionArea" style="display: none;"></div>
    `;
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<div id="weldGameFooter"></div>';
    
    createWeldInspectionPoints();
    
    // Show probe
    const probe = document.getElementById('weldProbe');
    probe.style.opacity = '1';
    probe.style.right = '20px';
    probe.style.top = '140px';
    probe.style.transform = 'rotate(180deg)';
}

function createWeldInspectionPoints() {
    const container = document.getElementById('weldPoints');
    const radius = 82;
    const centerX = 100;
    const centerY = 100;
    
    container.innerHTML = WELD_POINT_ANGLES.map(point => {
        const angleRad = (point.angle * Math.PI) / 180;
        const x = centerX + radius * Math.cos(angleRad);
        const y = centerY + radius * Math.sin(angleRad);
        const isBlocked = weldGameState.blockedPoints.includes(point.id);
        const statusClass = isBlocked ? 'blocked' : 'pending';
        
        return `
            <div class="weld-point ${statusClass}" 
                 id="weldPoint-${point.id}"
                 data-id="${point.id}"
                 data-angle="${point.angle}"
                 style="left: ${x}px; top: ${y}px;"
                 onclick="inspectWeldPoint('${point.id}')">
                ${point.id}
            </div>
        `;
    }).join('');
}

function inspectWeldPoint(pointId) {
    if (weldGameState.isAnimating) return;
    if (weldGameState.scannedPoints.includes(pointId)) return;
    
    // Robotic inspection - scan all points automatically
    if (weldGameState.roboticInspection) {
        performRoboticWeldInspection(pointId);
        return;
    }
    
    const point = document.getElementById(`weldPoint-${pointId}`);
    const pointData = WELD_POINT_ANGLES.find(p => p.id === pointId);
    const viewport = document.getElementById('weldViewport');
    const pipeSection = document.getElementById('weldPipeSection');
    const probe = document.getElementById('weldProbe');
    const blockedMsg = document.getElementById('weldBlockedMsg');
    
    const viewportRect = viewport.getBoundingClientRect();
    const pointRect = point.getBoundingClientRect();
    
    const pointCenterX = pointRect.left - viewportRect.left + pointRect.width / 2;
    const pointCenterY = pointRect.top - viewportRect.top + pointRect.height / 2;
    
    let probeRotation = pointData.angle + 180;
    const offsetDistance = 45;
    const angleRad = (pointData.angle * Math.PI) / 180;
    const probeX = pointCenterX + Math.cos(angleRad) * offsetDistance - 35;
    const probeY = pointCenterY + Math.sin(angleRad) * offsetDistance - 20;
    
    weldGameState.isAnimating = true;
    
    probe.style.left = probeX + 'px';
    probe.style.right = 'auto';
    probe.style.top = probeY + 'px';
    probe.style.transform = `rotate(${probeRotation}deg)`;
    
    if (weldGameState.blockedPoints.includes(pointId)) {
        setTimeout(() => {
            probe.classList.add('blocked');
            blockedMsg.style.left = (pointCenterX - 70) + 'px';
            blockedMsg.style.top = (pointCenterY - 35) + 'px';
            blockedMsg.classList.add('visible');
            updateWeldStatus(`⚠️ Point ${pointId} is BLOCKED! Probe cannot fit.`, 'error');
            
            setTimeout(() => {
                probe.classList.remove('blocked');
                blockedMsg.classList.remove('visible');
                weldGameState.isAnimating = false;
                checkWeldCompletion();
            }, 1000);
        }, 350);
    } else {
        setTimeout(() => {
            point.classList.remove('pending');
            point.classList.add('scanning');
            
            setTimeout(() => {
                point.classList.remove('scanning');
                point.classList.add('complete');
                weldGameState.scannedPoints.push(pointId);
                updateWeldCoverage();
                
                const remaining = weldGameState.totalPoints - weldGameState.scannedPoints.length - weldGameState.blockedPoints.length;
                if (remaining > 0) {
                    updateWeldStatus(`✓ Point ${pointId} scanned! ${remaining} point(s) remaining.`, 'success');
                }
                
                weldGameState.isAnimating = false;
                checkWeldCompletion();
            }, 350);
        }, 350);
    }
}

function performRoboticWeldInspection(triggerPointId) {
    weldGameState.isAnimating = true;
    
    document.getElementById('weldProbe').style.opacity = '0';
    document.getElementById('weldRobotBadge').classList.add('visible');
    
    updateWeldStatus('🤖 Deploying robotic inspection system... Full 360° automated scan!', 'success');
    
    const allPoints = WELD_POINT_ANGLES.map(p => p.id);
    let scanIndex = 0;
    
    const scanNextPoint = () => {
        if (scanIndex >= allPoints.length) {
            setTimeout(() => {
                updateWeldStatus('🤖 Robotic inspection complete! 100% coverage achieved in record time.', 'success');
                weldGameState.isAnimating = false;
                checkWeldCompletion();
            }, 200);
            return;
        }
        
        const pointId = allPoints[scanIndex];
        const point = document.getElementById(`weldPoint-${pointId}`);
        
        if (!weldGameState.scannedPoints.includes(pointId)) {
            point.classList.remove('pending');
            point.classList.add('scanning');
            
            setTimeout(() => {
                point.classList.remove('scanning');
                point.classList.add('complete');
                weldGameState.scannedPoints.push(pointId);
                updateWeldCoverage();
                
                scanIndex++;
                scanNextPoint();
            }, 120);
        } else {
            scanIndex++;
            scanNextPoint();
        }
    };
    
    setTimeout(scanNextPoint, 400);
}

function updateWeldCoverage() {
    const scanned = weldGameState.scannedPoints.length;
    const blocked = weldGameState.blockedPoints.length;
    const total = weldGameState.totalPoints;
    const remaining = total - scanned - blocked;
    const coverage = Math.round((scanned / total) * 100);
    
    document.getElementById('weldScannedCount').textContent = scanned;
    document.getElementById('weldBlockedCount').textContent = blocked;
    document.getElementById('weldRemainingCount').textContent = remaining;
    document.getElementById('weldPointsValue').textContent = `${scanned} / ${total}`;
    
    const coverageValue = document.getElementById('weldCoverageValue');
    const coverageFill = document.getElementById('weldCoverageFill');
    
    coverageValue.textContent = coverage + '%';
    coverageFill.style.width = coverage + '%';
    
    if (coverage === 100) {
        coverageValue.className = 'weld-coverage-value full';
        coverageFill.className = 'weld-coverage-fill';
    } else if (coverage >= 60) {
        coverageValue.className = 'weld-coverage-value partial';
        coverageFill.className = 'weld-coverage-fill partial';
    } else {
        coverageValue.className = 'weld-coverage-value poor';
        coverageFill.className = 'weld-coverage-fill poor';
    }
}

function checkWeldCompletion() {
    const scanned = weldGameState.scannedPoints.length;
    const blocked = weldGameState.blockedPoints.length;
    const accessible = weldGameState.totalPoints - blocked;
    
    if (scanned === accessible) {
        showWeldDecisionOptions();
    }
}

function showWeldDecisionOptions() {
    const stageData = weldGameState.currentStageData;
    const elId = weldGameState.currentElId;
    const coverage = Math.round((weldGameState.scannedPoints.length / weldGameState.totalPoints) * 100);
    
    let decisionTitle = coverage === 100 
        ? '✓ 100% Coverage — Select Report Type' 
        : `⚠️ ${weldGameState.blockedPoints.length} Point(s) Inaccessible — ${coverage}% Coverage`;
    
    const numOptions = stageData.options.length;
    const gridClass = numOptions === 2 ? 'two-options' : (numOptions === 3 ? 'three-options' : '');
    const sortedOpts = [...stageData.options].sort((a, b) => (a.cost || 0) - (b.cost || 0));
    
    let html = `
        <div class="decision-section">
            <div class="decision-header">
                <span class="decision-label">${decisionTitle}</span>
                <div class="decision-line"></div>
            </div>
            <div class="options-list ${gridClass}">
    `;
    
    sortedOpts.forEach(opt => {
        const cost = opt.cost || 0;
        const hasImpacts = opt.time || opt.dose || opt.healthImpact || opt.risk;
        html += `
            <div class="option-card" data-id="${opt.id}">
                <div class="option-header">
                    <div class="option-name">${opt.name}</div>
                    <div class="option-cost-badge">${formatMoney(cost)}</div>
                </div>
                <p class="option-desc">${opt.desc}</p>
                ${hasImpacts ? `
                <div class="option-impacts">
                    ${opt.time ? `<span class="impact negative">⏱️ ${opt.time}d</span>` : ''}
                    ${opt.dose ? `<span class="impact negative">☢️ ${opt.dose}mSv</span>` : ''}
                    ${opt.healthImpact ? `<span class="impact negative">❤️ ${opt.healthImpact}%</span>` : ''}
                    ${opt.risk ? `<span class="impact neutral">⚠️ ${opt.risk}%</span>` : ''}
                </div>
                ` : ''}
            </div>
        `;
    });
    
    html += '</div></div>';
    
    document.getElementById('weldDecisionArea').innerHTML = html;
    document.getElementById('weldDecisionArea').style.display = 'block';
    document.getElementById('weldGameFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirmWeldDecision" disabled>Select an Option</button>';
    
    const weldOptionsArray = sortedOpts;
    let selectedWeldOptId = null;
    const weldCards = document.querySelectorAll('#weldDecisionArea .option-card');
    const weldBtn = document.getElementById('btnConfirmWeldDecision');
    
    for (let i = 0; i < weldCards.length; i++) {
        weldCards[i].onclick = function() {
            for (let j = 0; j < weldCards.length; j++) {
                weldCards[j].classList.remove('selected');
            }
            this.classList.add('selected');
            selectedWeldOptId = this.getAttribute('data-id');
            weldBtn.disabled = false;
            weldBtn.textContent = 'Confirm Decision';
        };
    }
    
    weldBtn.onclick = function() {
        if (!selectedWeldOptId) return;
        let opt = null;
        for (let i = 0; i < weldOptionsArray.length; i++) {
            if (weldOptionsArray[i].id === selectedWeldOptId) {
                opt = weldOptionsArray[i];
                break;
            }
        }
        if (!opt) return;
        applyDecision(elId, opt, stageData);
    };
}

function updateWeldStatus(message, type) {
    const el = document.getElementById('weldStatusMsg');
    el.textContent = message;
    el.className = 'weld-status-msg' + (type ? ' ' + type : '');
}

// ============================================
// EMERGENCY TRIP GAME (Stage 4 Operations)
// ============================================
let tripGameState = {
    variant: null,
    phase: 'waiting',
    startTime: null,
    timerInterval: null,
    elapsed: 0,
    clickCount: 0,
    lcdLayer: 0,
    lcdMaxDepth: 0,
    currentStageData: null,
    currentElId: null,
    currentElement: null
};

const TRIP_COMPACT_BUTTONS = [
    { label: 'AUX 1', color: 'green' }, { label: 'AUX 2', color: 'green' },
    { label: 'PUMP A', color: 'blue' }, { label: 'PUMP B', color: 'blue' },
    { label: 'VALVE 1', color: 'yellow' }, { label: 'VALVE 2', color: 'yellow' },
    { label: 'COOL A', color: 'blue' }, { label: 'COOL B', color: 'blue' },
    { label: 'FAN 1', color: 'green' }, { label: 'FAN 2', color: 'green' },
    { label: 'HTR 1', color: 'red' }, { label: 'HTR 2', color: 'red' },
    { label: 'PRESS', color: 'yellow' }, { label: 'TEMP', color: 'red' },
    { label: 'FLOW A', color: 'blue' }, { label: 'FLOW B', color: 'blue' },
    { label: 'TRIP', color: 'red', isTrip: true }, { label: 'RESET', color: 'red' },
    { label: 'ACK', color: 'yellow' }, { label: 'SILENCE', color: 'yellow' },
    { label: 'TEST', color: 'green' }, { label: 'LAMP', color: 'yellow' },
    { label: 'AUTO', color: 'green' }, { label: 'MAN', color: 'red' },
    { label: 'START', color: 'green' }, { label: 'STOP', color: 'red' },
    { label: 'EMRG', color: 'red' }, { label: 'NORM', color: 'green' },
    { label: 'HIGH', color: 'red' }, { label: 'LOW', color: 'yellow' },
    { label: 'OPEN', color: 'green' }, { label: 'CLOSE', color: 'red' },
    { label: 'ISO 1', color: 'yellow' }, { label: 'ISO 2', color: 'yellow' },
    { label: 'VENT', color: 'blue' }, { label: 'DRAIN', color: 'blue' },
    { label: 'FILL', color: 'blue' }, { label: 'LEVEL', color: 'green' },
    { label: 'CHEM', color: 'yellow' }, { label: 'RAD', color: 'red' }
];

function renderTripGame(elId, element) {
    const stageKey = 'stage' + STATE.stage;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(function(o) { return o.id === designChoice; });
    const stage = GAME_DATA.stages[STATE.stage];
    let stageData = element[stageKey] ? element[stageKey][designChoice] : null;
    
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element at this stage.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    
    // Handle checkElementState scenarios
    if (stageData.checkElementState && stageData.scenarios) {
        const elState = STATE.elementState[elId] || {};
        let matchedScenario = null;
        const states = ['layoutModified', 'backupInstalled', 'trainingEnhanced', 'operatorError'];
        for (let i = 0; i < states.length; i++) {
            if (elState[states[i]] && stageData.scenarios[states[i]]) {
                matchedScenario = stageData.scenarios[states[i]];
                break;
            }
        }
        if (!matchedScenario) {
            matchedScenario = stageData.scenarios.default || stageData.scenarios[Object.keys(stageData.scenarios)[0]];
        }
        stageData = matchedScenario;
    }
    
    tripGameState.currentStageData = stageData;
    tripGameState.currentElId = elId;
    tripGameState.currentElement = element;
    tripGameState.variant = designChoice;
    tripGameState.phase = 'ready';
    tripGameState.elapsed = 0;
    tripGameState.clickCount = 0;
    tripGameState.lcdLayer = 0;
    tripGameState.lcdMaxDepth = 0;
    
    // Map design choice to panel type
    let panelType = 'system'; // default
    if (designChoice === 'task') panelType = 'task';
    else if (designChoice === 'digital') panelType = 'digital';
    
    const panelLabels = {
        task: 'Task-Based Panel',
        system: 'System-Based Panel',
        digital: 'LCD Touch Panel'
    };
    
    const char = GAME_DATA.characters[stage.char];
    
    let html = '<div class="trip-game-container">';
    
    // Emergency header
    html += '<div class="trip-emergency-header" id="tripEmergencyHeader">';
    html += '<div class="trip-emergency-title"><span class="trip-icon">🔔</span><span id="tripEmergencyText">READY — Press Start when prepared</span></div>';
    html += '<div class="trip-timer-display" id="tripTimerDisplay">0.0</div>';
    html += '</div>';
    
    // Situation text
    html += '<div class="situation-panel"><div class="situation-text">' + stageData.situation + '</div></div>';
    
    // Panel viewport
    html += '<div class="trip-panel-viewport" id="tripPanelViewport">';
    html += '<div class="trip-panel-header">';
    html += '<span class="trip-panel-label">' + panelLabels[panelType] + '</span>';
    html += '<div class="trip-status-lights"><div class="trip-status-light" id="tripLightRed"></div><div class="trip-status-light" id="tripLightAmber"></div><div class="trip-status-light green" id="tripLightGreen"></div></div>';
    html += '</div>';
    html += '<div id="tripPanelContent"></div>';
    html += '<div class="trip-result-overlay" id="tripResultOverlay">';
    html += '<div class="trip-result-icon" id="tripResultIcon">✅</div>';
    html += '<div class="trip-result-title" id="tripResultTitle">TRIP SUCCESSFUL</div>';
    html += '<div class="trip-result-time" id="tripResultTime">Response time: 0.0 seconds</div>';
    html += '<div class="trip-result-message" id="tripResultMessage"></div>';
    html += '</div>';
    html += '</div>';
    
    // Consequence area (shown after completion)
    html += '<div id="tripConsequenceArea"></div>';
    
    // Character speech
    html += '<div class="modal-speech"><div class="speech-portrait">';
    if (char && char.image) {
        html += '<img src="' + char.image + '" alt="' + char.name + '">';
    } else if (char) {
        html += '<span class="portrait-emoji">' + char.emoji + '</span>';
    }
    html += '</div><div class="speech-bubble"><div class="speech-text">"' + stageData.quote + '"</div></div></div>';
    
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="tripStartBtn" onclick="startTripEmergency()">🚨 Start Emergency Drill</button>';
    
    // Render the appropriate panel
    renderTripPanel(panelType);
}

function renderTripPanel(panelType) {
    const content = document.getElementById('tripPanelContent');
    if (panelType === 'task') {
        renderTripErgoPanel(content);
    } else if (panelType === 'system') {
        renderTripCompactPanel(content);
    } else if (panelType === 'digital') {
        renderTripLCDPanel(content);
    }
}

function renderTripCompactPanel(container) {
    const shuffled = TRIP_COMPACT_BUTTONS.slice().sort(function() { return Math.random() - 0.5; });
    let html = '<div class="trip-compact-panel" id="tripCompactPanel">';
    for (let i = 0; i < shuffled.length; i++) {
        const btn = shuffled[i];
        const action = btn.isTrip ? 'trip' : 'wrong';
        html += '<button class="trip-compact-btn btn-' + btn.color + '" data-action="' + action + '">' + btn.label + '</button>';
    }
    html += '</div>';
    container.innerHTML = html;
    
    const buttons = container.querySelectorAll('.trip-compact-btn');
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function() {
            if (tripGameState.phase !== 'active') return;
            tripGameState.clickCount++;
            if (this.getAttribute('data-action') === 'trip') {
                endTripGame();
            }
        });
    }
}

function renderTripErgoPanel(container) {
    let html = '<div class="trip-ergo-panel" id="tripErgoPanel">';
    html += '<div class="trip-ergo-section"><div class="trip-ergo-label">Cooling</div><div class="trip-ergo-buttons">';
    html += '<button class="trip-ergo-btn ind-blue" data-action="wrong">PUMP A</button>';
    html += '<button class="trip-ergo-btn ind-blue" data-action="wrong">PUMP B</button>';
    html += '<button class="trip-ergo-btn ind-green" data-action="wrong">FAN 1</button>';
    html += '<button class="trip-ergo-btn ind-green" data-action="wrong">FAN 2</button>';
    html += '</div></div>';
    
    html += '<div class="trip-trip-section">';
    html += '<div class="trip-cover-plate"><div class="cover-icon">🔒</div><div class="cover-text">Emergency</div><div class="cover-text" style="font-size:0.45rem;color:#555;">Opens on alarm</div></div>';
    html += '<div class="trip-trip-label">⚠️ TRIP ⚠️</div>';
    html += '<button class="trip-big-btn" id="tripBigBtn">TRIP</button>';
    html += '<div class="trip-trip-sublabel">Emergency<br>Shutdown</div>';
    html += '</div>';
    
    html += '<div class="trip-ergo-section"><div class="trip-ergo-label">Auxiliary</div><div class="trip-ergo-buttons">';
    html += '<button class="trip-ergo-btn ind-green" data-action="wrong">AUX 1</button>';
    html += '<button class="trip-ergo-btn ind-green" data-action="wrong">AUX 2</button>';
    html += '<button class="trip-ergo-btn ind-amber" data-action="wrong">VENT</button>';
    html += '<button class="trip-ergo-btn ind-blue" data-action="wrong">DRAIN</button>';
    html += '</div></div>';
    
    html += '<div class="trip-ergo-section"><div class="trip-ergo-label">Monitor</div><div class="trip-ergo-buttons">';
    html += '<button class="trip-ergo-btn ind-red" data-action="wrong">TEMP</button>';
    html += '<button class="trip-ergo-btn ind-amber" data-action="wrong">PRESS</button>';
    html += '<button class="trip-ergo-btn ind-blue" data-action="wrong">FLOW</button>';
    html += '<button class="trip-ergo-btn ind-green" data-action="wrong">LEVEL</button>';
    html += '</div></div>';
    
    html += '<div class="trip-ergo-section"><div class="trip-ergo-label">Alarms</div><div class="trip-ergo-buttons">';
    html += '<button class="trip-ergo-btn ind-amber" data-action="wrong">ACK</button>';
    html += '<button class="trip-ergo-btn ind-red" data-action="wrong">RESET</button>';
    html += '<button class="trip-ergo-btn ind-amber" data-action="wrong">SILENCE</button>';
    html += '<button class="trip-ergo-btn ind-green" data-action="wrong">TEST</button>';
    html += '</div></div>';
    html += '</div>';
    
    container.innerHTML = html;
    
    const buttons = container.querySelectorAll('.trip-ergo-btn');
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function() {
            if (tripGameState.phase !== 'active') return;
            tripGameState.clickCount++;
        });
    }
    
    document.getElementById('tripBigBtn').addEventListener('click', function() {
        if (tripGameState.phase !== 'active') return;
        tripGameState.clickCount++;
        endTripGame();
    });
}

function renderTripLCDPanel(container) {
    let html = '<div class="trip-lcd-panel" id="tripLCDPanel">';
    html += '<div class="trip-lcd-screen">';
    html += '<div class="trip-lcd-title-bar"><span class="trip-lcd-title" id="tripLCDTitle">MAIN MENU</span><span class="trip-lcd-breadcrumb" id="tripLCDBreadcrumb">Home</span></div>';
    html += '<div class="trip-lcd-content">';
    
    // Layer 0: Main Menu
    html += '<div class="trip-lcd-layer active" id="tripLCDLayer0"><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="1" data-title="MONITOR" data-crumb="Monitor">MONITOR</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="2" data-title="ALARMS" data-crumb="Alarms">ALARMS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="3" data-title="SYSTEMS" data-crumb="Systems">SYSTEMS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="4" data-title="REPORTS" data-crumb="Reports">REPORTS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="5" data-title="CONFIG" data-crumb="Config">CONFIG</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="6" data-title="HELP" data-crumb="Help">HELP</button>';
    html += '</div></div>';
    
    // Layer 1: Monitor (dead end)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer1"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="TEMPS" data-crumb="Monitor→Temps">TEMPS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="PRESSURE" data-crumb="Monitor→Press">PRESSURE</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="FLOW" data-crumb="Monitor→Flow">FLOW</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="LEVELS" data-crumb="Monitor→Levels">LEVELS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="POWER" data-crumb="Monitor→Power">POWER</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="RADS" data-crumb="Monitor→Rads">RADS</button>';
    html += '</div></div>';
    
    // Layer 2: Alarms (dead end)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer2"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="ACTIVE" data-crumb="Alarms→Active">ACTIVE</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="HISTORY" data-crumb="Alarms→History">HISTORY</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="SILENCE" data-crumb="Alarms→Silence">SILENCE</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="ACK ALL" data-crumb="Alarms→Ack">ACK ALL</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="PRIORITY" data-crumb="Alarms→Priority">PRIORITY</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="SETTINGS" data-crumb="Alarms→Settings">SETTINGS</button>';
    html += '</div></div>';
    
    // Layer 3: Systems (correct path)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer3"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="COOLING" data-crumb="Systems→Cooling">COOLING</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="POWER" data-crumb="Systems→Power">POWER</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="7" data-title="SAFETY" data-crumb="Systems→Safety">SAFETY</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="FUEL" data-crumb="Systems→Fuel">FUEL</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="WASTE" data-crumb="Systems→Waste">WASTE</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="HVAC" data-crumb="Systems→HVAC">HVAC</button>';
    html += '</div></div>';
    
    // Layer 4: Reports (dead end)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer4"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="DAILY" data-crumb="Reports→Daily">DAILY</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="WEEKLY" data-crumb="Reports→Weekly">WEEKLY</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="EVENTS" data-crumb="Reports→Events">EVENTS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="EXPORT" data-crumb="Reports→Export">EXPORT</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="PRINT" data-crumb="Reports→Print">PRINT</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="ARCHIVE" data-crumb="Reports→Archive">ARCHIVE</button>';
    html += '</div></div>';
    
    // Layer 5: Config (dead end)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer5"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="DISPLAY" data-crumb="Config→Display">DISPLAY</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="NETWORK" data-crumb="Config→Network">NETWORK</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="USERS" data-crumb="Config→Users">USERS</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="BACKUP" data-crumb="Config→Backup">BACKUP</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="TIME" data-crumb="Config→Time">TIME</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="ABOUT" data-crumb="Config→About">ABOUT</button>';
    html += '</div></div>';
    
    // Layer 6: Help (dead end)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer6"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="MANUAL" data-crumb="Help→Manual">MANUAL</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="TRAINING" data-crumb="Help→Training">TRAINING</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="CONTACT" data-crumb="Help→Contact">CONTACT</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="FAQ" data-crumb="Help→FAQ">FAQ</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="UPDATES" data-crumb="Help→Updates">UPDATES</button>';
    html += '<button class="trip-lcd-btn" data-action="nav" data-target="10" data-title="LICENSE" data-crumb="Help→License">LICENSE</button>';
    html += '</div></div>';
    
    // Layer 7: Safety (correct - has TRIP)
    html += '<div class="trip-lcd-layer" id="tripLCDLayer7"><button class="trip-lcd-back-btn" data-action="back" data-target="3">← BACK</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="wrong">ISOLATE</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">VENT</button>';
    html += '<button class="trip-lcd-btn" data-action="trip">TRIP</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">SCRAM</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">CONTAIN</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">PURGE</button>';
    html += '</div></div>';
    
    // Layer 10: Dead end
    html += '<div class="trip-lcd-layer" id="tripLCDLayer10"><button class="trip-lcd-back-btn" data-action="back" data-target="0">← BACK TO MAIN</button><div class="trip-lcd-grid">';
    html += '<button class="trip-lcd-btn" data-action="wrong">VIEW</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">EXPORT</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">PRINT</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">GRAPH</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">FILTER</button>';
    html += '<button class="trip-lcd-btn" data-action="wrong">SEARCH</button>';
    html += '</div></div>';
    
    html += '</div></div></div>';
    container.innerHTML = html;
    
    // Attach event listeners
    const buttons = container.querySelectorAll('.trip-lcd-btn, .trip-lcd-back-btn');
    for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener('click', function() {
            if (tripGameState.phase !== 'active') return;
            
            const action = this.getAttribute('data-action');
            const target = this.getAttribute('data-target');
            const title = this.getAttribute('data-title') || '';
            const crumb = this.getAttribute('data-crumb') || '';
            
            tripGameState.clickCount++;
            
            if (action === 'nav' || action === 'back') {
                const layers = document.querySelectorAll('.trip-lcd-layer');
                for (let j = 0; j < layers.length; j++) {
                    layers[j].classList.remove('active');
                }
                document.getElementById('tripLCDLayer' + target).classList.add('active');
                tripGameState.lcdLayer = parseInt(target);
                
                if (action === 'nav') {
                    document.getElementById('tripLCDTitle').textContent = title;
                    document.getElementById('tripLCDBreadcrumb').textContent = crumb;
                } else {
                    const titles = { 0: 'MAIN MENU', 1: 'MONITOR', 2: 'ALARMS', 3: 'SYSTEMS', 4: 'REPORTS', 5: 'CONFIG', 6: 'HELP', 7: 'SAFETY' };
                    const crumbs = { 0: 'Home', 1: 'Monitor', 2: 'Alarms', 3: 'Systems', 4: 'Reports', 5: 'Config', 6: 'Help', 7: 'Systems→Safety' };
                    document.getElementById('tripLCDTitle').textContent = titles[target] || 'MENU';
                    document.getElementById('tripLCDBreadcrumb').textContent = crumbs[target] || 'Home';
                }
            } else if (action === 'trip') {
                endTripGame();
            }
        });
    }
}

function startTripEmergency() {
    if (tripGameState.phase !== 'ready') return;
    
    tripGameState.phase = 'active';
    tripGameState.startTime = Date.now();
    tripGameState.elapsed = 0;
    tripGameState.clickCount = 0;
    
    document.getElementById('tripEmergencyHeader').classList.add('active');
    document.getElementById('tripPanelViewport').classList.add('alarm');
    document.getElementById('tripEmergencyText').innerHTML = '<strong>⚠️ EMERGENCY — TRIP THE REACTOR!</strong>';
    document.getElementById('tripTimerDisplay').classList.add('active');
    document.getElementById('tripLightRed').classList.add('red');
    document.getElementById('tripLightAmber').classList.add('amber');
    document.getElementById('tripLightGreen').classList.remove('green');
    
    document.getElementById('tripStartBtn').style.display = 'none';
    
    // Reveal button labels
    const compact = document.getElementById('tripCompactPanel');
    const ergo = document.getElementById('tripErgoPanel');
    const lcd = document.getElementById('tripLCDPanel');
    if (compact) compact.classList.add('revealed');
    if (ergo) ergo.classList.add('revealed');
    if (lcd) lcd.classList.add('revealed');
    
    tripGameState.timerInterval = setInterval(updateTripTimer, 100);
}

function updateTripTimer() {
    tripGameState.elapsed = (Date.now() - tripGameState.startTime) / 1000;
    
    const display = document.getElementById('tripTimerDisplay');
    display.textContent = tripGameState.elapsed.toFixed(1);
    
    if (tripGameState.elapsed >= 8) {
        display.classList.add('veryslow');
        display.classList.remove('slow');
    } else if (tripGameState.elapsed >= 4) {
        display.classList.add('slow');
        display.classList.remove('veryslow');
    }
}

function endTripGame() {
    tripGameState.phase = 'complete';
    
    clearInterval(tripGameState.timerInterval);
    
    const elapsed = tripGameState.elapsed;
    const elapsedStr = elapsed.toFixed(1);
    
    document.getElementById('tripEmergencyHeader').classList.remove('active');
    document.getElementById('tripPanelViewport').classList.remove('alarm');
    
    // Determine result
    let resultClass = 'success';
    let resultText = 'EXCELLENT!';
    let resultIcon = '✅';
    
    if (elapsed >= 8) {
        resultClass = 'veryslow';
        resultText = 'TOO SLOW!';
        resultIcon = '⚠️';
    } else if (elapsed >= 4) {
        resultClass = 'slow';
        resultText = 'TRIP ACTIVATED';
        resultIcon = '⏱️';
    }
    
    document.getElementById('tripResultIcon').textContent = resultIcon;
    document.getElementById('tripResultTitle').textContent = resultText;
    document.getElementById('tripResultTitle').className = 'trip-result-title ' + resultClass;
    document.getElementById('tripResultTime').textContent = 'Response time: ' + elapsedStr + ' seconds';
    
    let message = '';
    const variant = tripGameState.variant;
    if (variant === 'task') {
        message = 'The prominent trip button made this instant. Good ergonomic design saves lives in emergencies.';
    } else if (variant === 'system') {
        if (elapsed < 4) {
            message = 'You found TRIP quickly among ' + TRIP_COMPACT_BUTTONS.length + ' buttons. But under real stress, operators often take longer.';
        } else {
            message = 'It took ' + elapsedStr + 's to find TRIP among identical buttons. Those seconds of delay increase radiation exposure.';
        }
    } else if (variant === 'digital') {
        if (tripGameState.clickCount > 5) {
            message = 'It took ' + tripGameState.clickCount + ' taps navigating menus. The "premium" touchscreen is dangerous in emergencies.';
        } else {
            message = 'You found it in ' + tripGameState.clickCount + ' taps. But most operators go down wrong paths under stress.';
        }
    }
    document.getElementById('tripResultMessage').textContent = message;
    document.getElementById('tripResultOverlay').classList.add('visible');
    
    // Calculate consequences based on response time
    let extraDose = 0;
    let extraCost = 0;
    let healthImpact = 0;
    
    if (elapsed < 3) {
        extraDose = 0.5;
        extraCost = 5000;
        healthImpact = 0;
    } else if (elapsed < 6) {
        extraDose = 1.5;
        extraCost = 25000;
        healthImpact = -5;
    } else if (elapsed < 10) {
        extraDose = 3;
        extraCost = 60000;
        healthImpact = -10;
    } else {
        extraDose = 5;
        extraCost = 100000;
        healthImpact = -15;
    }
    
    // Show consequences
    const consArea = document.getElementById('tripConsequenceArea');
    const isGood = elapsed < 4;
    consArea.innerHTML = '<div class="trip-consequence ' + (isGood ? 'good' : '') + '">' +
        '<div class="trip-consequence-title">' + (isGood ? 'Minimal Impact' : 'Delayed Response Consequences') + '</div>' +
        '<div class="trip-consequence-stats">' +
        '<div>Dose: <span>' + extraDose.toFixed(1) + ' mSv</span></div>' +
        '<div>Cost: <span>£' + extraCost.toLocaleString() + '</span></div>' +
        (healthImpact < 0 ? '<div>Safety: <span>' + healthImpact + '</span></div>' : '') +
        '</div></div>';
    
    // Store consequences for when player confirms
    tripGameState.consequences = {
        dose: extraDose,
        cost: extraCost,
        healthImpact: healthImpact,
        time: elapsed
    };
    
    // Show confirm button
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="confirmTripResult()">Continue</button>';
}

function confirmTripResult() {
    const cons = tripGameState.consequences;
    const elId = tripGameState.currentElId;
    
    // Apply consequences to game state
    STATE.totals.dose += cons.dose;
    STATE.totals.cost += cons.cost;
    STATE.stageTotals[STATE.stage].dose += cons.dose;
    STATE.stageTotals[STATE.stage].cost += cons.cost;
    
    if (cons.healthImpact < 0) {
        STATE.plantHealth = Math.max(0, STATE.plantHealth + cons.healthImpact);
    }
    
    // Mark as complete
    STATE.completed[STATE.stage][elId] = true;
    
    // Set operator error state if slow
    if (cons.time >= 6) {
        if (!STATE.elementState[elId]) STATE.elementState[elId] = {};
        STATE.elementState[elId].operatorError = true;
    }
    
    // Mark hotspot square as done
    const square = document.getElementById('square-' + elId);
    if (square) {
        square.classList.add('done');
    }
    
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}

// ============================================
// PIPE ROUTING MINI-GAME (Stage 2+ Consequence Illustration)
// ============================================
let pipeGameState = {
    embeddedCost: 0,
    embeddedFound: 0,
    embeddedPipeRow: 1,
    embeddedGameOver: false,
    ductsOpened: 0,
    tunnelWorkerX: 15,
    tunnelWorkerY: 20,
    tunnelDose: 0,
    tunnelActive: false,
    tunnelInterval: null,
    tunnelCooldown: false,
    gameCompleted: false,
    currentStageData: null,
    currentElId: null,
    currentElement: null
};
function renderPipeRoutingDecision(elId, element) {
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    const stage = GAME_DATA.stages[STATE.stage];
    let stageData = element[stageKey]?.[designChoice];
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element at this stage.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    // Handle element state-based scenarios
    if (stageData.checkElementState && stageData.scenarios) {
        const elState = STATE.elementState[elId] || {};
        const statePriority = [
            'emergencyOccurred', 'leakOccurred', 'operatorError', 'contaminationSpread',
            'deteriorating', 'corrosionDetected', 'doseConstraints',
            'inspectionGap', 'inspectionLimited', 'cableConflict', 'boltDegradation',
            'accessFixed', 'clearanceImproved', 'layoutModified', 'earlyReplacement',
            'workaroundUsed', 'specialToolingUsed', 'backupInstalled', 'trainingEnhanced',
            'shieldingAdded', 'remoteTooling', 'accessCreated', 'flangingAdded',
            'airlockBypassed', 'airlockMaintained', 'weldCutMade', 'leakHistory'
        ];
        let matchedScenario = null;
        for (const state of statePriority) {
            if (elState[state] && stageData.scenarios[state]) {
                matchedScenario = stageData.scenarios[state];
                break;
            }
        }
        if (!matchedScenario) {
            matchedScenario = stageData.scenarios.default || stageData.scenarios[Object.keys(stageData.scenarios)[0]];
        }
        stageData = matchedScenario;
    }
    // Store for later use when game completes
    pipeGameState.currentStageData = stageData;
    pipeGameState.currentElId = elId;
    pipeGameState.currentElement = element;
    pipeGameState.gameCompleted = false;
    const char = GAME_DATA.characters[stage.char];
    const stageCost = STATE.stageTotals[STATE.stage]?.cost || 0;
    let html = `
        <div class="context-bar">
            <span class="context-design">📅 Year ${stage.year} · 2025 Design: <strong>${designOpt.name}</strong></span>
            <span class="context-cost">💰 Stage Cost: ${formatMoney(stageCost)}</span>
        </div>
        <div class="situation-panel">
            <div class="situation-label">Current Situation</div>
            <div class="situation-text">${stageData.situation}</div>
        </div>
        <div class="pipe-game-container">
            <div class="pipe-game-header">
                <span class="pipe-game-title">📐 Experience the Consequence</span>
                <span class="pipe-game-cost">${designOpt.name}</span>
            </div>
            <div class="pipe-game-view" id="pipeGameView">
                <div class="pipe-game-labels">
                    <span>REACTOR BUILDING</span>
                    <span>AUXILIARY BUILDING</span>
                </div>
                <div class="pipe-game-walls">
                    <div class="pipe-game-wall"><span class="pipe-game-wall-label">CONTAINMENT</span></div>
                    <div class="pipe-game-wall right"><span class="pipe-game-wall-label">AUX SYSTEMS</span></div>
                </div>
                <div class="pipe-game-area" id="pipeGameArea"></div>
                <div class="pipe-game-floor">
                    <span class="pipe-game-floor-label">FOUNDATION SLAB</span>
                </div>
            </div>
            <div class="pipe-game-message" id="pipeGameMessage"></div>
        </div>
        <div class="speech-bubble">
            <div class="speech-portrait">${char.image ? `<img src="${char.image}" alt="${char.name}">` : char.emoji}</div>
            <div class="speech-name">${char.name}, ${char.role}</div>
            <div class="speech-text">"${stageData.quote}"</div>
        </div>
        <div id="pipeDecisionArea" style="display: none;"></div>
    `;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<div id="pipeGameFooter"></div>';
    // Start the appropriate game based on design choice
    if (designChoice === 'embedded') {
        startEmbeddedGame();
    } else if (designChoice === 'ducted') {
        startDuctedGame();
    } else if (designChoice === 'tunnel') {
        startTunnelGame();
    }
}
function showPipeDecisionOptions() {
    const stageData = pipeGameState.currentStageData;
    const elId = pipeGameState.currentElId;
    const numOptions = stageData.options.length;
    const gridClass = numOptions === 2 ? 'two-options' : (numOptions === 3 ? 'three-options' : '');
    // Sort options by cost (cheapest first)
    const sortedPipeOpts = [...stageData.options].sort((a, b) => (a.cost || 0) - (b.cost || 0));
    let html = `
        <div class="decision-section">
            <div class="decision-header">
                <span class="decision-label">Your Decision</span>
                <div class="decision-line"></div>
            </div>
            <div class="options-list ${gridClass}">
    `;
    sortedPipeOpts.forEach(opt => {
        const cost = opt.cost || 0;
        const hasImpacts = opt.time || opt.dose || opt.healthImpact || opt.risk;
        html += `
            <div class="option-card" data-id="${opt.id}">
                <div class="option-header">
                    <div class="option-name">${opt.name}</div>
                    <div class="option-cost-badge">${formatMoney(cost)}</div>
                </div>
                <p class="option-desc">${opt.desc}</p>
                ${hasImpacts ? `
                    <div class="option-impacts">
                        ${opt.time ? `<span class="impact negative">⏱️ ${opt.time}d</span>` : ''}
                        ${opt.dose ? `<span class="impact negative">☢️ ${opt.dose}mSv</span>` : ''}
                        ${opt.healthImpact ? `<span class="impact negative">❤️ ${opt.healthImpact}%</span>` : ''}
                        ${opt.risk ? `<span class="impact neutral">⚠️ Risk</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    });
    html += '</div></div>';
    document.getElementById('pipeDecisionArea').innerHTML = html;
    document.getElementById('pipeDecisionArea').style.display = 'block';
    document.getElementById('pipeGameFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirmPipeDecision" disabled>Select an Option</button>';
    // Store options for lookup
    const pipeOptionsArray = sortedPipeOpts;
    let selectedPipeOptId = null;
    const pipeCards = document.querySelectorAll('#pipeDecisionArea .option-card');
    const pipeBtn = document.getElementById('btnConfirmPipeDecision');
    for (let i = 0; i < pipeCards.length; i++) {
        pipeCards[i].onclick = function() {
            for (let j = 0; j < pipeCards.length; j++) {
                pipeCards[j].classList.remove('selected');
            }
            this.classList.add('selected');
            selectedPipeOptId = this.getAttribute('data-id');
            pipeBtn.disabled = false;
            pipeBtn.textContent = 'Confirm Decision';
        };
    }
    pipeBtn.onclick = function() {
        if (!selectedPipeOptId) return;
        let opt = null;
        for (let i = 0; i < pipeOptionsArray.length; i++) {
            if (pipeOptionsArray[i].id === selectedPipeOptId) {
                opt = pipeOptionsArray[i];
                break;
            }
        }
        if (!opt) {
            console.error('Pipe option not found:', selectedPipeOptId);
            return;
        }
        applyDecision(elId, opt, stageData);
    };
}
// EMBEDDED GAME - Find the leak
function startEmbeddedGame() {
    pipeGameState.embeddedCost = 0;
    pipeGameState.embeddedFound = 0;
    pipeGameState.embeddedGameOver = false;
    pipeGameState.embeddedPipeRow = 1 + Math.floor(Math.random() * 2);
    const gameArea = document.getElementById('pipeGameArea');
    let gridHTML = `
        <div class="embedded-stats">
            <div class="embedded-stat cost">💰 £<span id="embeddedCost">0</span>k</div>
            <div class="embedded-stat found">🔧 <span id="embeddedFound">0</span>/8</div>
        </div>
        <div class="concrete-grid">
    `;
    for (let r = 0; r < 4; r++) {
        for (let c = 0; c < 8; c++) {
            const hasPipe = (r === pipeGameState.embeddedPipeRow);
            gridHTML += `<div class="concrete-block${hasPipe ? ' has-pipe' : ''}" onclick="breakConcreteBlock(this)"></div>`;
        }
    }
    gridHTML += '</div>';
    gameArea.innerHTML = gridHTML;
    document.getElementById('pipeGameMessage').innerHTML = `
        <div class="pipe-game-message-title">🔨 Find the Leak</div>
        <div>The pipe is embedded in concrete. Click to excavate blocks (£10k each) and locate the leak source.</div>
    `;
    document.getElementById('pipeGameFooter').innerHTML = '';
}
function breakConcreteBlock(element) {
    if (element.classList.contains('broken') || pipeGameState.embeddedGameOver) return;
    element.classList.add('hit');
    setTimeout(() => element.classList.remove('hit'), 150);
    element.classList.add('broken');
    pipeGameState.embeddedCost += 10;
    document.getElementById('embeddedCost').textContent = pipeGameState.embeddedCost;
    if (element.classList.contains('has-pipe')) {
        pipeGameState.embeddedFound++;
        document.getElementById('embeddedFound').textContent = pipeGameState.embeddedFound;
        if (pipeGameState.embeddedFound === 8) {
            completeEmbeddedGame(true);
        }
    }
    if (pipeGameState.embeddedCost >= 80 && pipeGameState.embeddedFound < 8) {
        completeEmbeddedGame(false);
    }
}
function completeEmbeddedGame(success) {
    pipeGameState.embeddedGameOver = true;
    pipeGameState.gameCompleted = true;
    const msgArea = document.getElementById('pipeGameMessage');
    msgArea.className = 'pipe-game-message warning';
    if (success) {
        msgArea.innerHTML = `
            <div class="pipe-game-message-title">🔍 Leak Located — At Great Cost</div>
            <div>You spent <strong>£${pipeGameState.embeddedCost},000</strong> in excavation just to find it. This is reality with embedded pipes.</div>
        `;
    } else {
        msgArea.innerHTML = `
            <div class="pipe-game-message-title">💸 Excavation Budget Exceeded</div>
            <div>£${pipeGameState.embeddedCost},000 spent, only ${pipeGameState.embeddedFound}/8 sections found. The pipe location remains uncertain.</div>
        `;
    }
    showPipeDecisionOptions();
}
// DUCTED GAME - Easy inspection
function startDuctedGame() {
    pipeGameState.ductsOpened = 0;
    const gameArea = document.getElementById('pipeGameArea');
    let html = '<div class="ducts-container">';
    for (let i = 0; i < 5; i++) {
        html += `
            <div class="duct-section" onclick="openDuctSection(this, ${i})">
                <div class="duct-cover"><div class="duct-cover-handle"></div></div>
                <div class="duct-pipe"></div>
                <div class="duct-label">Section ${i + 1} ✓</div>
                <div class="duct-click-hint">Click</div>
            </div>
        `;
    }
    html += `
        </div>
        <div class="duct-progress">
            <div class="duct-progress-bar"><div class="duct-progress-fill" id="ductProgressFill"></div></div>
            <span class="duct-progress-text"><span id="ductProgressText">0</span>/5</span>
        </div>
    `;
    gameArea.innerHTML = html;
    document.getElementById('pipeGameMessage').innerHTML = `
        <div class="pipe-game-message-title">🔍 Inspect the Accessible Ducts</div>
        <div>Click each duct cover to open it and locate the leak. Quick and straightforward.</div>
    `;
    document.getElementById('pipeGameFooter').innerHTML = '';
}
function openDuctSection(element, index) {
    if (element.classList.contains('open')) return;
    element.classList.add('open');
    pipeGameState.ductsOpened++;
    document.getElementById('ductProgressFill').style.width = (pipeGameState.ductsOpened / 5 * 100) + '%';
    document.getElementById('ductProgressText').textContent = pipeGameState.ductsOpened;
    if (pipeGameState.ductsOpened === 5) {
        completeDuctedGame();
    }
}
function completeDuctedGame() {
    pipeGameState.gameCompleted = true;
    const msgArea = document.getElementById('pipeGameMessage');
    msgArea.className = 'pipe-game-message success';
    msgArea.innerHTML = `
        <div class="pipe-game-message-title">✅ Leak Located Quickly</div>
        <div>Full visibility, easy access. The 2025 design choice pays off — simple inspection, minimal cost.</div>
    `;
    showPipeDecisionOptions();
}
// TUNNEL GAME - Navigate radiation
function startTunnelGame() {
    pipeGameState.tunnelWorkerX = 15;
    pipeGameState.tunnelWorkerY = 20;
    pipeGameState.tunnelDose = 0;
    pipeGameState.tunnelActive = true;
    pipeGameState.tunnelCooldown = false;
    const gameArea = document.getElementById('pipeGameArea');
    gameArea.innerHTML = `
        <div class="tunnel-interior">
            <div class="tunnel-dose-counter" id="tunnelDose">Dose: 0 mSv</div>
            <div class="tunnel-pipe"></div>
            <div class="tunnel-pipe-supports">
                <div class="tunnel-pipe-support"></div>
                <div class="tunnel-pipe-support"></div>
                <div class="tunnel-pipe-support"></div>
                <div class="tunnel-pipe-support"></div>
                <div class="tunnel-pipe-support"></div>
            </div>
            <div class="tunnel-floor"></div>
            <div class="tunnel-goal"><span class="tunnel-goal-arrow">→</span></div>
            <div class="tunnel-worker" id="tunnelWorker">
                <div class="tunnel-worker-head"></div>
                <div class="tunnel-worker-body"></div>
            </div>
            <div class="radiation-cloud barrier" id="tcloud1" style="width: 60px; height: 100px; bottom: 18px; left: 70px;"></div>
            <div class="radiation-cloud moving" id="tcloud2" style="width: 45px; height: 40px; bottom: 50px; left: 160px;"></div>
            <div class="radiation-cloud barrier" id="tcloud3" style="width: 70px; height: 110px; bottom: 15px; left: 240px;"></div>
            <div class="radiation-cloud pulsing" id="tcloud4" style="width: 55px; height: 60px; bottom: 22px; left: 340px;"></div>
        </div>
    `;
    document.getElementById('pipeGameMessage').innerHTML = `
        <div class="pipe-game-message-title">🎮 Navigate to the Leak</div>
        <div>Use arrow keys to move the worker through the tunnel. Avoid the radiation clouds!</div>
        <div class="tunnel-controls">
            <span class="tunnel-key">←</span><span class="tunnel-key">→</span><span class="tunnel-key">↑</span><span class="tunnel-key">↓</span>
            <span class="tunnel-controls-text">Move worker</span>
        </div>
    `;
    document.getElementById('pipeGameFooter').innerHTML = '';
    document.addEventListener('keydown', handleTunnelKeyPress);
    if (pipeGameState.tunnelInterval) clearInterval(pipeGameState.tunnelInterval);
    pipeGameState.tunnelInterval = setInterval(checkTunnelCollisions, 50);
}
function handleTunnelKeyPress(e) {
    if (!pipeGameState.tunnelActive) return;
    const step = 8;
    const gameArea = document.getElementById('pipeGameArea');
    if (!gameArea) return;
    const maxX = gameArea.offsetWidth - 70;
    const maxY = 90;
    switch(e.key) {
        case 'ArrowLeft':
            pipeGameState.tunnelWorkerX = Math.max(10, pipeGameState.tunnelWorkerX - step);
            e.preventDefault();
            break;
        case 'ArrowRight':
            pipeGameState.tunnelWorkerX = Math.min(maxX, pipeGameState.tunnelWorkerX + step);
            e.preventDefault();
            break;
        case 'ArrowUp':
            pipeGameState.tunnelWorkerY = Math.min(maxY, pipeGameState.tunnelWorkerY + step);
            e.preventDefault();
            break;
        case 'ArrowDown':
            pipeGameState.tunnelWorkerY = Math.max(20, pipeGameState.tunnelWorkerY - step);
            e.preventDefault();
            break;
    }
    const worker = document.getElementById('tunnelWorker');
    if (worker) {
        worker.style.left = pipeGameState.tunnelWorkerX + 'px';
        worker.style.bottom = pipeGameState.tunnelWorkerY + 'px';
    }
    // Check if reached goal
    const gameWidth = gameArea.offsetWidth || 400;
    if (pipeGameState.tunnelWorkerX > gameWidth - 80) {
        completeTunnelGame();
    }
}
function checkTunnelCollisions() {
    if (!pipeGameState.tunnelActive || pipeGameState.tunnelCooldown) return;
    const worker = document.getElementById('tunnelWorker');
    if (!worker) return;
    const workerRect = worker.getBoundingClientRect();
    for (let i = 1; i <= 4; i++) {
        const cloud = document.getElementById(`tcloud${i}`);
        if (!cloud) continue;
        const cloudRect = cloud.getBoundingClientRect();
        const padding = 8;
        const overlap = !(
            workerRect.right < cloudRect.left + padding ||
            workerRect.left > cloudRect.right - padding ||
            workerRect.bottom < cloudRect.top + padding ||
            workerRect.top > cloudRect.bottom - padding
        );
        if (overlap) {
            triggerTunnelContamination();
            break;
        }
    }
}
function triggerTunnelContamination() {
    if (pipeGameState.tunnelCooldown) return;
    pipeGameState.tunnelCooldown = true;
    pipeGameState.tunnelDose += 1.0;
    const counter = document.getElementById('tunnelDose');
    if (counter) {
        counter.textContent = `Dose: ${pipeGameState.tunnelDose.toFixed(1)} mSv`;
        counter.classList.add('warning');
    }
    const worker = document.getElementById('tunnelWorker');
    if (worker) worker.classList.add('contaminated');
    const msgArea = document.getElementById('pipeGameMessage');
    msgArea.className = 'pipe-game-message warning';
    msgArea.innerHTML = `
        <div class="pipe-game-message-title">☢️ Worker Contaminated!</div>
        <div>Dose: <strong>+1.0 mSv</strong>. Total: <strong>${pipeGameState.tunnelDose.toFixed(1)} mSv</strong>. The contamination is unavoidable.</div>
        <div class="tunnel-controls">
            <span class="tunnel-key">←</span><span class="tunnel-key">→</span><span class="tunnel-key">↑</span><span class="tunnel-key">↓</span>
            <span class="tunnel-controls-text">Move worker</span>
        </div>
    `;
    setTimeout(() => {
        pipeGameState.tunnelCooldown = false;
        if (worker) worker.classList.remove('contaminated');
        if (pipeGameState.tunnelDose >= 2) {
            completeTunnelGame();
        }
    }, 500);
}
function completeTunnelGame() {
    pipeGameState.tunnelActive = false;
    pipeGameState.gameCompleted = true;
    if (pipeGameState.tunnelInterval) {
        clearInterval(pipeGameState.tunnelInterval);
        pipeGameState.tunnelInterval = null;
    }
    document.removeEventListener('keydown', handleTunnelKeyPress);
    const msgArea = document.getElementById('pipeGameMessage');
    msgArea.className = 'pipe-game-message warning';
    const doseMsg = pipeGameState.tunnelDose > 0 
        ? `Worker accumulated <strong>${pipeGameState.tunnelDose.toFixed(1)} mSv</strong> crossing once.`
        : `Easy access, but contamination covers every surface.`;
    msgArea.innerHTML = `
        <div class="pipe-game-message-title">☢️ The Tunnel Problem</div>
        <div>${doseMsg} Over 60 years, contamination builds everywhere. The entire tunnel becomes <strong>ILW</strong> at decommissioning.</div>
    `;
    showPipeDecisionOptions();
}
// ============================================
// STAGES 2-5: DECISIONS (No budget, decisions are final)
// ============================================
function renderDecisionModal(elId, element) {
    // Stage 2 + pipeRouting = show the pipe game
    if (STATE.stage === 2 && elId === 'pipeRouting') {
        renderPipeRoutingDecision(elId, element);
        return;
    }
    // Stage 3 + weldClearance = show weld inspection game
    if (STATE.stage === 3 && elId === 'weldClearance') {
        renderWeldInspectionGame(elId, element);
        return;
    }
    // Stage 4 + controlPanel = show emergency trip game
    if (STATE.stage === 4 && elId === 'controlPanel') {
        renderTripGame(elId, element);
        return;
    }
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    const stage = GAME_DATA.stages[STATE.stage];
    let stageData = element[stageKey]?.[designChoice];
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    // Handle element state-based scenarios (compounding consequences system)
    if (stageData.checkElementState && stageData.scenarios) {
        const elState = STATE.elementState[elId] || {};
        // Priority order for state checks - most severe/specific first
        const statePriority = [
            // Crisis states (highest priority)
            'emergencyOccurred', 'leakOccurred', 'operatorError', 'contaminationSpread',
            // Deterioration states
            'deteriorating', 'corrosionDetected', 'doseConstraints',
            // Limitation states
            'inspectionGap', 'inspectionLimited', 'cableConflict', 'boltDegradation',
            // Fixed/improved states
            'accessFixed', 'clearanceImproved', 'layoutModified', 'earlyReplacement',
            // Mitigation states
            'workaroundUsed', 'specialToolingUsed', 'backupInstalled', 'trainingEnhanced',
            'shieldingAdded', 'remoteTooling', 'accessCreated', 'flangingAdded',
            // Specific equipment states
            'airlockBypassed', 'airlockMaintained', 'weldCutMade', 'leakHistory'
        ];
        let matchedScenario = null;
        // Check states in priority order
        for (const state of statePriority) {
            if (elState[state] && stageData.scenarios[state]) {
                matchedScenario = stageData.scenarios[state];
                break;
            }
        }
        // Fall back to default or first available scenario
        if (!matchedScenario) {
            matchedScenario = stageData.scenarios.default || stageData.scenarios[Object.keys(stageData.scenarios)[0]];
        }
        stageData = matchedScenario;
    }
    // Handle old trigger-based system (for backwards compatibility)
    else if (stageData.checkTrigger) {
        stageData = STATE.triggers[stageData.checkTrigger] ? stageData.triggered : stageData.notTriggered;
    } else if (stageData.checkFlag) {
        stageData = STATE.flags[stageData.checkFlag] ? stageData.hasFlag : stageData.noFlag;
    }
    const char = GAME_DATA.characters[stage.char];
    const stageCost = STATE.stageTotals[STATE.stage]?.cost || 0;
    let html = '';
    // Context bar - year, design choice, stage cost
    html += `
        <div class="context-bar">
            <span class="context-design">📅 Year ${stage.year} · 2025 Design: <strong>${designOpt.name}</strong></span>
            <span class="context-cost">💰 Stage Cost: ${formatMoney(stageCost)}</span>
        </div>
    `;
    // Situation panel - the main story
    html += `
        <div class="situation-panel">
            <div class="situation-label">Current Situation</div>
            <div class="situation-text">${stageData.situation}</div>
        </div>
    `;
    // Character speech bubble
    html += `
        <div class="speech-bubble">
            <div class="speech-portrait">${char.image ? `<img src="${char.image}" alt="${char.name}">` : char.emoji}</div>
            <div class="speech-name">${char.name}, ${char.role}</div>
            <div class="speech-text">"${stageData.quote}"</div>
        </div>
    `;
    // Decision section
    const numOptions = stageData.options.length;
    const gridClass = numOptions === 2 ? 'two-options' : (numOptions === 3 ? 'three-options' : '');
    // Sort options by cost (cheapest first)
    const sortedDecisionOpts = [...stageData.options].sort((a, b) => (a.cost || 0) - (b.cost || 0));
    html += `
        <div class="decision-section">
            <div class="decision-header">
                <span class="decision-label">Your Decision</span>
                <div class="decision-line"></div>
            </div>
            <div class="options-list ${gridClass}">
    `;
    sortedDecisionOpts.forEach(opt => {
        const cost = opt.cost || 0;
        const hasImpacts = opt.time || opt.dose || opt.healthImpact || opt.risk;
        html += `
            <div class="option-card" data-id="${opt.id}">
                <div class="option-header">
                    <div class="option-name">${opt.name}</div>
                    <div class="option-cost-badge">${formatMoney(cost)}</div>
                </div>
                <p class="option-desc">${opt.desc}</p>
                ${hasImpacts ? `
                <div class="option-impacts">
                    ${opt.time ? `<span class="impact negative">⏱️ ${opt.time}d</span>` : ''}
                    ${opt.dose ? `<span class="impact negative">☢️ ${opt.dose}mSv</span>` : ''}
                    ${opt.healthImpact ? `<span class="impact ${opt.healthImpact > 0 ? 'positive' : 'negative'}">❤️ ${opt.healthImpact > 0 ? '+' : ''}${opt.healthImpact}%</span>` : ''}
                    ${opt.risk ? `<span class="impact neutral">⚠️ ${opt.risk}%</span>` : ''}
                </div>
                ` : ''}
            </div>
        `;
    });
    html += '</div></div>';
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirmDecision" disabled>Select an Option</button>';
    // Store the options array for lookup
    const optionsArray = sortedDecisionOpts;
    let selectedOptId = null;
    // Get fresh references after DOM update
    const allCards = document.querySelectorAll('#modalBody .option-card');
    const btn = document.getElementById('btnConfirmDecision');
    // Card click handlers
    for (let i = 0; i < allCards.length; i++) {
        allCards[i].onclick = function() {
            // Remove selected from all
            for (let j = 0; j < allCards.length; j++) {
                allCards[j].classList.remove('selected');
            }
            // Add selected to clicked
            this.classList.add('selected');
            selectedOptId = this.getAttribute('data-id');
            btn.disabled = false;
            btn.textContent = 'Confirm Decision';
        };
    }
    // Confirm button handler
    btn.onclick = function() {
        if (!selectedOptId) {
            return;
        }
        // Find in the options array
        let opt = null;
        for (let i = 0; i < optionsArray.length; i++) {
            if (optionsArray[i].id === selectedOptId) {
                opt = optionsArray[i];
                break;
            }
        }
        if (!opt) {
            console.error('Option not found:', selectedOptId);
            return;
        }
        // Handle risk
        if (opt.risk && Math.random() * 100 < opt.risk) {
            showFailure(elId, opt, stageData);
            return;
        }
        applyDecision(elId, opt, stageData, null);
    };
}
function showFailure(elId, opt, stageData) {
    const extraCost = opt.cost || 0;
    const extraDose = (opt.dose || 0) + 2;
    const extraTime = (opt.time || 0) + 5;
    let html = `
        <div class="failure-panel">
            <div class="failure-icon">⚠️</div>
            <div class="failure-title">Attempt Failed!</div>
            <div class="failure-text">The risky approach didn't work. The situation has gotten worse and you must deal with the consequences.</div>
        </div>
        <div class="failure-impacts">
            <div class="failure-impact">
                <span class="failure-impact-icon">💰</span>
                <span class="failure-impact-value">${formatMoney(extraCost + 50000)}</span>
                <span class="failure-impact-label">Emergency Costs</span>
            </div>
            <div class="failure-impact">
                <span class="failure-impact-icon">⏱️</span>
                <span class="failure-impact-value">+${extraTime} days</span>
                <span class="failure-impact-label">Delays</span>
            </div>
            <div class="failure-impact">
                <span class="failure-impact-icon">☢️</span>
                <span class="failure-impact-value">+${extraDose} mSv</span>
                <span class="failure-impact-label">Dose Uptake</span>
            </div>
            <div class="failure-impact">
                <span class="failure-impact-icon">❤️</span>
                <span class="failure-impact-value">-10%</span>
                <span class="failure-impact-label">Plant Health</span>
            </div>
        </div>
    `;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-danger" id="btnConfirm">Accept Consequences</button>';
    document.getElementById('btnConfirm').onclick = () => {
        // Apply failure costs
        STATE.stageTotals[STATE.stage].cost += extraCost + 50000;
        STATE.stageTotals[STATE.stage].dose += extraDose;
        STATE.stageTotals[STATE.stage].time += extraTime;
        STATE.totals.cost += extraCost + 50000;
        STATE.totals.dose += extraDose;
        STATE.totals.time += extraTime;
        STATE.plantHealth = Math.max(0, STATE.plantHealth - 10);
        // Apply failState if specified, otherwise use setState
        if (!STATE.elementState[elId]) STATE.elementState[elId] = {};
        const stateToApply = opt.failState || opt.setState || { failureOccurred: true };
        Object.keys(stateToApply).forEach(key => {
            STATE.elementState[elId][key] = stateToApply[key];
        });
        STATE.completed[STATE.stage][elId] = true;
        // Mark hotspot square as done for Stage 2+
        if (STATE.stage > 1) {
            const square = document.getElementById(`square-${elId}`);
            if (square) {
                square.classList.add('done');
            }
        }
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}
function applyDecision(elId, opt, stageData, previousChoice = null) {
    const cost = opt.cost || 0;
    const dose = opt.dose || 0;
    const time = opt.time || 0;
    const healthImpact = opt.healthImpact || 0;
    // Additional costs from triggered scenarios (e.g., environmental cleanup)
    if (stageData.additionalCosts) {
        STATE.stageTotals[STATE.stage].cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        STATE.totals.cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        if (stageData.additionalCosts.healthImpact) {
            STATE.plantHealth = Math.max(0, STATE.plantHealth + stageData.additionalCosts.healthImpact);
        }
    }
    STATE.stageTotals[STATE.stage].cost += cost;
    STATE.stageTotals[STATE.stage].dose += dose;
    STATE.stageTotals[STATE.stage].time += time;
    STATE.totals.cost += cost;
    STATE.totals.dose += dose;
    STATE.totals.time += time;
    if (healthImpact) {
        STATE.plantHealth = Math.max(0, Math.min(100, STATE.plantHealth + healthImpact));
    }
    // Handle old trigger/flag system
    if (opt.trigger) STATE.triggers[opt.trigger] = true;
    if (opt.setFlag) STATE.flags[opt.setFlag] = true;
    // Handle new element state system for compounding consequences
    if (opt.setState) {
        if (!STATE.elementState[elId]) STATE.elementState[elId] = {};
        Object.keys(opt.setState).forEach(key => {
            STATE.elementState[elId][key] = opt.setState[key];
        });
    }
    STATE.completed[STATE.stage][elId] = true;
    STATE.stageChoices[`${STATE.stage}_${elId}`] = opt.id;
    // Mark hotspot square as done for Stage 2+
    if (STATE.stage > 1) {
        const square = document.getElementById(`square-${elId}`);
        if (square) {
            square.classList.add('done');
        }
    }
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}
// ============================================
// STAGE COMPLETION
// ============================================
document.getElementById('btnNextStage').onclick = showStageSummary;
// Insights for each stage
const STAGE_INSIGHTS = {
    1: "Your design is now locked in. Over the next 60 years, every maintenance worker, inspector, and operator will work with the consequences of today's decisions. <strong>Construction is cheap compared to retrofitting.</strong>",
    2: "First major outage complete. Did your design make this easier or harder? <strong>Access constraints compound over time</strong> - every workaround creates the next problem.",
    3: "Regulators now have decades of data. Inspection gaps become safety case issues. <strong>If you can't inspect it, you can't prove it's safe.</strong>",
    4: "45 years of operation tests every design decision. Control room layout matters when alarms are screaming at 3am. <strong>Good design becomes invisible; bad design becomes crisis.</strong>",
    5: "Decommissioning reveals the true lifecycle cost. What seemed like savings in 2025 may have cost millions more across 60 years. <strong>The plant's final lesson is written in the total cost.</strong>"
};
function showStageSummary() {
    const stage = GAME_DATA.stages[STATE.stage];
    const st = STATE.stageTotals[STATE.stage];
    document.getElementById('sumTitle').textContent = `${stage.name}`;
    document.getElementById('sumSubtitle').textContent = `Year ${stage.year} Complete`;
    let statsHtml = '';
    if (STATE.stage === 1) {
        const spent = STATE.totals.cost;
        const over = spent > stage.budget;
        const remaining = stage.budget - spent;
        statsHtml = `
            <div class="summary-stat">
                <div class="summary-stat-icon">💰</div>
                <div class="summary-stat-value">${formatMoney(spent)}</div>
                <div class="summary-stat-label">Design Cost</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">📊</div>
                <div class="summary-stat-value">${formatMoney(stage.budget)}</div>
                <div class="summary-stat-label">Budget</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">${over ? '⚠️' : '✅'}</div>
                <div class="summary-stat-value ${over ? 'over' : 'good'}">${formatMoney(Math.abs(remaining))}</div>
                <div class="summary-stat-label">${over ? 'Over Budget' : 'Remaining'}</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">❤️</div>
                <div class="summary-stat-value">${STATE.plantHealth}%</div>
                <div class="summary-stat-label">Plant Health</div>
            </div>
        `;
    } else {
        statsHtml = `
            <div class="summary-stat">
                <div class="summary-stat-icon">💰</div>
                <div class="summary-stat-value">${formatMoney(st.cost)}</div>
                <div class="summary-stat-label">Stage Cost</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">☢️</div>
                <div class="summary-stat-value">${st.dose.toFixed(1)} mSv</div>
                <div class="summary-stat-label">Dose</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">⏱️</div>
                <div class="summary-stat-value">${st.time} days</div>
                <div class="summary-stat-label">Time</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-icon">❤️</div>
                <div class="summary-stat-value">${STATE.plantHealth}%</div>
                <div class="summary-stat-label">Plant Health</div>
            </div>
        `;
    }
    document.getElementById('sumStats').innerHTML = statsHtml;
    // Decisions - show as grid cards
    let decHtml = '<div class="decisions-grid">';
    if (STATE.stage === 1) {
        // Stage 1: Show design choices
        Object.keys(GAME_DATA.elements).forEach(elId => {
            const el = GAME_DATA.elements[elId];
            const choice = STATE.designChoices[elId];
            const opt = el.stage1.options.find(o => o.id === choice);
            decHtml += `
                <div class="decision-card this-stage">
                    <div>
                        <div class="decision-element">${el.title}</div>
                        <div class="decision-choice">${opt.name}</div>
                    </div>
                    <div class="decision-cost">${formatMoney(opt.cost)}</div>
                </div>
            `;
        });
    } else {
        // Stages 2-5: Show this stage's decisions
        Object.keys(GAME_DATA.elements).forEach(elId => {
            const el = GAME_DATA.elements[elId];
            const choiceId = STATE.stageChoices[`${STATE.stage}_${elId}`];
            const designChoice = STATE.designChoices[elId];
            if (choiceId) {
                // Find the option that was chosen
                const stageData = el[`stage${STATE.stage}`];
                let chosenOption = null;
                let optionCost = 0;
                if (stageData && stageData[designChoice]) {
                    let sd = stageData[designChoice];
                    if (sd.scenarios) {
                        Object.values(sd.scenarios).forEach(scenario => {
                            if (scenario.options) {
                                const found = scenario.options.find(o => o.id === choiceId);
                                if (found) chosenOption = found;
                            }
                        });
                    } else if (sd.options) {
                        chosenOption = sd.options.find(o => o.id === choiceId);
                    } else if (sd.triggered || sd.notTriggered) {
                        const opts = [...(sd.triggered?.options || []), ...(sd.notTriggered?.options || [])];
                        chosenOption = opts.find(o => o.id === choiceId);
                    }
                }
                if (chosenOption) {
                    decHtml += `
                        <div class="decision-card this-stage">
                            <div>
                                <div class="decision-element">${el.title}</div>
                                <div class="decision-choice">${chosenOption.name}</div>
                            </div>
                            <div class="decision-cost">${formatMoney(chosenOption.cost || 0)}</div>
                        </div>
                    `;
                }
            }
        });
    }
    decHtml += '</div>';
    document.getElementById('sumDecisions').innerHTML = decHtml;
    // Insight for this stage
    document.getElementById('insightText').innerHTML = STAGE_INSIGHTS[STATE.stage];
    // Button text
    if (STATE.stage >= 5) {
        document.getElementById('btnNextPhase').textContent = 'View Final Report →';
    } else {
        document.getElementById('btnNextPhase').textContent = 'Continue →';
    }
    document.getElementById('summaryScreen').classList.add('active');
}
document.getElementById('btnNextPhase').onclick = () => {
    document.getElementById('summaryScreen').classList.remove('active');
    showStoryTransition();
};
function showStoryTransition() {
    const currentStage = STATE.stage;
    const story = GAME_DATA.storyTransitions[currentStage];
    const currentStageData = GAME_DATA.stages[currentStage];
    // Hero section
    document.getElementById('storyPhaseLabel').textContent = `${currentStageData.name} Phase Complete`;
    document.getElementById('storyTitle').textContent = story.title;
    document.getElementById('storyYearFrom').textContent = currentStageData.year;
    const nextStage = currentStage < 5 ? GAME_DATA.stages[currentStage + 1] : null;
    document.getElementById('storyYearTo').textContent = nextStage ? nextStage.year : '2085+';
    // Narrative paragraphs
    document.getElementById('storyNarrative').innerHTML = story.narrative.map(p => `<p>${p}</p>`).join('');
    // Lessons as cards with icons
    const lessonIcons = ['💡', '⚙️', '🔧', '📊', '🎯', '⚠️', '✅', '📐'];
    document.getElementById('storyLessons').innerHTML = story.lessons.map((l, i) => `
        <div class="lesson-card">
            <div class="lesson-icon">${lessonIcons[i % lessonIcons.length]}</div>
            <div class="lesson-text">${l}</div>
        </div>
    `).join('');
    // Regulatory references as cards
    document.getElementById('storyRegulatory').innerHTML = story.regulatory.map(r => {
        // Extract title from text if it follows "Title - Description" pattern
        let title = r.title || '';
        let desc = r.text;
        if (!title && r.text.includes(' - ')) {
            const parts = r.text.split(' - ');
            title = parts[0];
            desc = parts.slice(1).join(' - ');
        }
        return `
            <div class="reg-card">
                <div class="reg-badge">${r.code}</div>
                <div class="reg-content">
                    ${title ? `<div class="reg-title">${title}</div>` : ''}
                    <div class="reg-desc">${desc}</div>
                </div>
            </div>
        `;
    }).join('');
    // Foreshadow
    document.getElementById('storyForeshadow').innerHTML = story.foreshadow;
    // Button text
    if (currentStage >= 5) {
        document.getElementById('btnStoryNext').textContent = 'View Final Results →';
    } else {
        document.getElementById('btnStoryNext').textContent = `Begin ${nextStage.year}: ${nextStage.name} →`;
    }
    document.getElementById('storyTransition').classList.add('visible');
}
document.getElementById('btnStoryNext').onclick = () => {
    document.getElementById('storyTransition').classList.remove('visible');
    if (STATE.stage >= 5) {
        showFinalResults();
    } else {
        showTransition();
    }
};
function showTransition() {
    const nextStage = STATE.stage + 1;
    const trans = GAME_DATA.transitions[nextStage];
    const nextStageData = GAME_DATA.stages[nextStage];
    document.getElementById('transYears').textContent = trans.years;
    document.getElementById('transYear').textContent = trans.year;
    document.getElementById('transVisual').innerHTML = `<span class="phase-visual-icon">${trans.icon}</span>`;
    document.getElementById('transPhaseName').textContent = trans.phaseName;
    document.getElementById('transText').innerHTML = trans.text.map(t => `<p class="phase-context-line">${t}</p>`).join('');
    document.getElementById('btnTransContinue').textContent = `Begin ${trans.phaseName} →`;
    // Set background image for the stage
    const transScreen = document.getElementById('transitionScreen');
    if (nextStageData.bg) {
        transScreen.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.85)), url('${nextStageData.bg}')`;
        transScreen.style.backgroundSize = 'cover';
        transScreen.style.backgroundPosition = 'center';
    }
    transScreen.classList.add('active');
}
document.getElementById('btnTransContinue').onclick = () => {
    document.getElementById('transitionScreen').classList.remove('active');
    startStage(STATE.stage + 1);
};
function showFinalResults() {
    // Calculate grades and totals
    let good = 0;
    let elementReports = [];
    // Optimal costs - if you made all good choices
    const OPTIMAL_COSTS = {
        pumpAccess: { design: 120000, lifecycle: 65000 },      // Open Bay + standard ops
        weldClearance: { design: 90000, lifecycle: 55000 },    // 150mm clearance + standard
        controlPanel: { design: 120000, lifecycle: 45000 },    // Task-based + standard
        pipeConnections: { design: 100000, lifecycle: 45000 }, // Flanged + standard
        pipeRouting: { design: 100000, lifecycle: 50000 },     // Ducted + standard
        materialSpec: { design: 140000, lifecycle: 50000 }     // Duplex + standard
    };
    const ELEMENT_ICONS = {
        pumpAccess: '⚙️',
        weldClearance: '🔧',
        controlPanel: '🎛️',
        pipeConnections: '🔗',
        pipeRouting: '📐',
        materialSpec: '🧪'
    };
    const ELEMENT_LESSONS = {
        pumpAccess: {
            good: "The open bay design demonstrates the value of considering the full lifecycle. Spending £40k extra upfront saved hundreds of thousands in maintenance and gave certainty at every stage.",
            wasteful: "The dedicated room provided excellent access but the airlock complexity added cost at every maintenance intervention. Good access, excessive containment.",
            poor: "The corner position saved £40k in 2025 but created problems at every subsequent stage. Access constraints compound - each workaround creates the next problem."
        },
        weldClearance: {
            good: "150mm clearance allowed standard UT probes and welding equipment throughout the lifecycle. Full ASME Section XI inspection coverage achievable at every ISI.",
            wasteful: "300mm with permanent scaffolding was more than needed. The scaffolding accumulated contamination and became ILW - adding waste volume at decommissioning.",
            poor: "50mm met code minimum but real UT probes need 80mm for proper beam angles. Limited inspection coverage meant inspection gaps, and gaps became leaks."
        },
        controlPanel: {
            good: "Task-based layout matches operator mental model. Emergency controls flow left-to-right as trained. Post-TMI human factors principles applied correctly - response times 40% faster than industry average.",
            wasteful: "Software-based touchscreens offered flexibility but failed when needed most. No haptic feedback, glove incompatibility, and 30-year software obsolescence. Defence in depth requires physical backup.",
            poor: "System-based layout is logical to engineers but confusing to operators under stress. Controls for emergency sequences scattered across panels - exactly the TMI lesson we should have learned."
        },
        pipeConnections: {
            good: "Flanged connections at strategic points allowed sections to be isolated and removed without cutting. Faster maintenance, less dose, easier decommissioning.",
            wasteful: "Excessive flanges meant more potential leak points and 47 bolted connections to maintain. Gasket failures accumulated over 60 years.",
            poor: "All-welded seemed simpler but every intervention required cutting and re-welding. No isolation points for online maintenance. More dose, more time, more cost throughout the lifecycle."
        },
        pipeRouting: {
            good: "Ducted routing with removable covers provided easy access while controlling contamination spread. Clean decommissioning - ducts remained as clean concrete.",
            wasteful: "The walk-in tunnel provided excellent access but accumulated contamination over 60 years, becoming ILW and a major disposal volume.",
            poor: "Embedded pipes created inspection gaps that regulators could not accept — you cannot claim safety without evidence. Leaks migrated contamination into concrete matrix over decades, turning routine decommissioning into £500k+ remediation projects extending timelines by years."
        },
        materialSpec: {
            good: "Duplex stainless (~300ppm cobalt) provided the right balance - no IGSCC susceptibility, low cobalt activation producing manageable Co-60 levels. Predictable performance and hands-on decommissioning achievable after 5-year decay.",
            wasteful: "Super duplex/exotic nickel alloy had excellent corrosion resistance but contained Ni-58 and Co-59 which activated to produce Ni-59 (76,000-year half-life), Ni-63 (100-year half-life), and high Co-60 — decommissioning timelines extended by decades.",
            poor: "Type 304 (~2,500ppm cobalt) sensitizes at 450-850°C creating chromium-depleted grain boundaries. IGSCC then propagates along these boundaries in BWR environments. The mechanism was well-documented since the 1970s. High cobalt content meant Co-60 dominated dose rates for 60 years, constraining all work planning."
        }
    };
    // Calculate per-element costs and build reports
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const designChoice = STATE.designChoices[elId];
        const designOpt = el.stage1.options.find(o => o.id === designChoice);
        if (designOpt.quality === 'good') good++;
        // Calculate this element's total cost across all stages
        let elementCost = designOpt.cost;
        for (let s = 2; s <= 5; s++) {
            const choiceId = STATE.stageChoices[`${s}_${elId}`];
            if (choiceId) {
                // Find the option cost - need to navigate the data structure
                const stageData = el[`stage${s}`];
                if (stageData) {
                    let options;
                    if (stageData[designChoice]) {
                        let sd = stageData[designChoice];
                        // Handle state-based scenarios
                        if (sd.scenarios) {
                            // Just get cost from stored choice
                            const flatOptions = Object.values(sd.scenarios).flatMap(s => s.options || []);
                            const opt = flatOptions.find(o => o.id === choiceId);
                            if (opt) elementCost += opt.cost || 0;
                        } else if (sd.options) {
                            const opt = sd.options.find(o => o.id === choiceId);
                            if (opt) elementCost += opt.cost || 0;
                        } else if (sd.triggered || sd.notTriggered) {
                            const opts = [...(sd.triggered?.options || []), ...(sd.notTriggered?.options || [])];
                            const opt = opts.find(o => o.id === choiceId);
                            if (opt) elementCost += opt.cost || 0;
                        }
                    }
                }
            }
        }
        const optimalCost = OPTIMAL_COSTS[elId].design + OPTIMAL_COSTS[elId].lifecycle;
        elementReports.push({
            id: elId,
            title: el.title,
            icon: ELEMENT_ICONS[elId],
            designChoice: designOpt.name,
            quality: designOpt.quality,
            totalCost: elementCost,
            optimalCost: optimalCost,
            lesson: ELEMENT_LESSONS[elId][designOpt.quality]
        });
    });
    // Calculate totals
    const totalOptimal = Object.values(OPTIMAL_COSTS).reduce((sum, el) => sum + el.design + el.lifecycle, 0);
    const costDiff = STATE.totals.cost - totalOptimal;
    // Determine grade
    let grade, verdict, gradeExplanation;
    if (good >= 5 && STATE.plantHealth >= 80 && STATE.totals.dose < 30) {
        grade = 'A'; 
        verdict = 'Master Designer';
        gradeExplanation = 'Your design choices considered the full 60-year lifecycle. Every stage benefited from your foresight.';
    } else if (good >= 4 && STATE.plantHealth >= 60) {
        grade = 'B'; 
        verdict = 'Competent Engineer';
        gradeExplanation = 'Most of your design choices served the plant well, though some areas caused unnecessary difficulty.';
    } else if (good >= 2 && STATE.plantHealth >= 40) {
        grade = 'C'; 
        verdict = 'Room for Improvement';
        gradeExplanation = 'Several design choices created problems that compounded over the decades. The plant operated, but at higher cost.';
    } else {
        grade = 'D'; 
        verdict = 'Lessons Learned';
        gradeExplanation = 'Your design created ongoing challenges throughout the plant\'s life. Future generations paid for initial savings.';
    }
    // Build the HTML
    let html = '';
    // Header with grade
    html += `
        <div class="report-header">
            <div class="results-grade ${grade}">${grade}</div>
            <h2 class="results-title">60 Years Complete</h2>
            <p class="results-verdict">${verdict} — ${gradeExplanation}</p>
        </div>
    `;
    // Cost comparison
    html += `
        <div class="report-comparison">
            <div class="comparison-box yours">
                <div class="comparison-label">Your Total Cost</div>
                <div class="comparison-value">${formatMoney(STATE.totals.cost)}</div>
                <div class="comparison-diff ${costDiff > 0 ? 'over' : 'under'}">
                    ${costDiff > 0 ? '+' : ''}${formatMoney(costDiff)} vs optimal
                </div>
            </div>
            <div class="comparison-vs">vs</div>
            <div class="comparison-box optimal">
                <div class="comparison-label">Optimal Path</div>
                <div class="comparison-value">${formatMoney(totalOptimal)}</div>
                <div class="comparison-diff">All good choices</div>
            </div>
        </div>
    `;
    
    // Calculate lifecycle metrics
    const totalDose = STATE.totals.dose;
    const plantHealth = STATE.plantHealth;
    const totalTime = STATE.totals.time;
    
    // Analyse element states for issues
    const elState = STATE.elementState;
    let inspectionGaps = 0;
    let operatorErrors = 0;
    let contaminationEvents = 0;
    let deterioratingItems = 0;
    let leakEvents = 0;
    
    if (elState.pumpAccess.inspectionGap) inspectionGaps++;
    if (elState.pumpAccess.deteriorating) deterioratingItems++;
    if (elState.weldClearance.inspectionLimited) inspectionGaps++;
    if (elState.weldClearance.deteriorating) deterioratingItems++;
    if (elState.weldClearance.leakOccurred) leakEvents++;
    if (elState.controlPanel.operatorError) operatorErrors++;
    if (elState.pipeConnections.inspectionLimited) inspectionGaps++;
    if (elState.pipeConnections.boltDegradation) deterioratingItems++;
    if (elState.pipeConnections.leakHistory) leakEvents++;
    if (elState.pipeConnections.deteriorating) deterioratingItems++;
    if (elState.pipeRouting.contaminationSpread) contaminationEvents++;
    if (elState.pipeRouting.inspectionLimited) inspectionGaps++;
    if (elState.materialSpec.corrosionDetected) deterioratingItems++;
    if (elState.materialSpec.doseConstraints) operatorErrors++;
    
    // Determine status classes
    const doseClass = totalDose < 25 ? 'good' : (totalDose < 50 ? 'warning' : 'danger');
    const healthClass = plantHealth >= 80 ? 'good' : (plantHealth >= 50 ? 'warning' : 'danger');
    const doseContext = totalDose < 25 ? 'Well managed' : (totalDose < 50 ? 'Above target' : 'Regulatory concern');
    const healthContext = plantHealth >= 80 ? 'Strong record' : (plantHealth >= 50 ? 'Some incidents' : 'Significant issues');
    
    // Calculate decommissioning complexity
    let decommComplexity = 'Standard';
    let decommYears = '10-15';
    let decommClass = 'good';
    if (contaminationEvents > 0 || deterioratingItems >= 3) {
        decommComplexity = 'Complex';
        decommYears = '20-30';
        decommClass = 'danger';
    } else if (inspectionGaps >= 2 || deterioratingItems >= 1) {
        decommComplexity = 'Extended';
        decommYears = '15-20';
        decommClass = 'warning';
    }
    
    // Lifecycle Summary Panel
    html += `<div class="report-section-title">Plant Lifecycle Summary</div>`;
    html += `
        <div class="lifecycle-summary">
            <div class="lifecycle-stat ${doseClass}">
                <div class="lifecycle-stat-icon">☢️</div>
                <div class="lifecycle-stat-value">${totalDose.toFixed(1)} mSv</div>
                <div class="lifecycle-stat-label">Collective Dose</div>
                <div class="lifecycle-stat-context">${doseContext}</div>
            </div>
            <div class="lifecycle-stat ${healthClass}">
                <div class="lifecycle-stat-icon">🏥</div>
                <div class="lifecycle-stat-value">${plantHealth}%</div>
                <div class="lifecycle-stat-label">Safety Record</div>
                <div class="lifecycle-stat-context">${healthContext}</div>
            </div>
            <div class="lifecycle-stat">
                <div class="lifecycle-stat-icon">📋</div>
                <div class="lifecycle-stat-value">${inspectionGaps}</div>
                <div class="lifecycle-stat-label">Inspection Gaps</div>
                <div class="lifecycle-stat-context">${inspectionGaps === 0 ? 'Full coverage' : 'Safety case gaps'}</div>
            </div>
            <div class="lifecycle-stat ${decommClass}">
                <div class="lifecycle-stat-icon">🏗️</div>
                <div class="lifecycle-stat-value">${decommYears} yrs</div>
                <div class="lifecycle-stat-label">Decommissioning</div>
                <div class="lifecycle-stat-context">${decommComplexity}</div>
            </div>
        </div>
    `;
    
    // Safety & Regulatory Record
    html += `<div class="report-section-title">Safety & Regulatory Record</div>`;
    html += `<div class="record-grid">`;
    
    // Safety Record Card
    let safetyItems = [];
    if (operatorErrors > 0) safetyItems.push({ icon: '⚠️', text: `${operatorErrors} operator error event(s) during emergencies`, class: 'bad' });
    if (leakEvents > 0) safetyItems.push({ icon: '💧', text: `${leakEvents} leak event(s) requiring intervention`, class: 'warning' });
    if (deterioratingItems > 0) safetyItems.push({ icon: '📉', text: `${deterioratingItems} component(s) in degraded condition`, class: 'warning' });
    if (contaminationEvents > 0) safetyItems.push({ icon: '☢️', text: `Contamination spread event(s) — environmental impact`, class: 'bad' });
    if (safetyItems.length === 0) safetyItems.push({ icon: '✓', text: 'No significant safety events recorded', class: 'good' });
    
    const safetyClass = contaminationEvents > 0 || operatorErrors > 0 ? 'issues' : (deterioratingItems > 0 || leakEvents > 0 ? 'concerns' : 'clean');
    html += `
        <div class="record-card ${safetyClass}">
            <div class="record-card-title"><span>🛡️</span> Safety Events</div>
            <div class="record-items">
                ${safetyItems.map(item => `
                    <div class="record-item ${item.class}">
                        <span class="record-item-icon">${item.icon}</span>
                        <span>${item.text}</span>
                    </div>
                `).join('')}
            </div>
            <div class="record-card-summary">
                ${safetyClass === 'clean' ? 'Clean operational record — design supported safe operations throughout.' : 
                  safetyClass === 'concerns' ? 'Some concerns arose — design choices contributed to operational challenges.' :
                  'Significant events occurred — design limitations manifested as safety issues.'}
            </div>
        </div>
    `;
    
    // Regulatory Record Card
    let regItems = [];
    if (inspectionGaps > 0) regItems.push({ icon: '🔍', text: `${inspectionGaps} area(s) with limited inspection access — safety case gaps`, class: 'bad' });
    if (elState.pipeRouting.contaminationSpread) regItems.push({ icon: '📄', text: 'Environmental permit breach — regulatory investigation', class: 'bad' });
    if (plantHealth < 60) regItems.push({ icon: '⚖️', text: 'Enhanced regulatory scrutiny applied', class: 'warning' });
    if (deterioratingItems >= 2) regItems.push({ icon: '📝', text: 'Licence conditions imposed on degraded components', class: 'warning' });
    if (regItems.length === 0) regItems.push({ icon: '✓', text: 'Full regulatory compliance maintained', class: 'good' });
    
    const regClass = inspectionGaps >= 2 || contaminationEvents > 0 ? 'issues' : (inspectionGaps > 0 || plantHealth < 70 ? 'concerns' : 'clean');
    html += `
        <div class="record-card ${regClass}">
            <div class="record-card-title"><span>📜</span> Regulatory Standing</div>
            <div class="record-items">
                ${regItems.map(item => `
                    <div class="record-item ${item.class}">
                        <span class="record-item-icon">${item.icon}</span>
                        <span>${item.text}</span>
                    </div>
                `).join('')}
            </div>
            <div class="record-card-summary">
                ${regClass === 'clean' ? 'Strong regulatory relationship — design enabled full compliance with LC 28 inspection requirements.' : 
                  regClass === 'concerns' ? 'Some regulatory findings — inspection limitations required safety case justification.' :
                  'Regulatory challenges — design choices created ongoing compliance burden.'}
            </div>
        </div>
    `;
    html += `</div>`;
    
    // Element journeys
    html += `<div class="report-section-title">Your 60-Year Journey by Element</div>`;
    html += `<div class="element-journeys">`;
    elementReports.forEach(report => {
        const verdictText = report.quality === 'good' ? 'Good Design' : 
                           (report.quality === 'wasteful' ? 'Over-specified' : 'Problematic');
        html += `
            <div class="journey-card ${report.quality}" data-element="${report.id}">
                <div class="journey-header" onclick="toggleJourney('${report.id}')">
                    <div class="journey-title">
                        <span class="journey-icon">${report.icon}</span>
                        <div>
                            <div class="journey-name">${report.title}</div>
                            <div class="journey-design">2025 Design: ${report.designChoice}</div>
                        </div>
                    </div>
                    <div class="journey-right">
                        <div class="journey-cost">
                            <div class="journey-cost-value">${formatMoney(report.totalCost)}</div>
                            <div class="journey-cost-label">60-year cost</div>
                        </div>
                        <span class="journey-verdict ${report.quality}">${verdictText}</span>
                        <span class="journey-expand">▼</span>
                    </div>
                </div>
                <div class="journey-content">
                    <div class="journey-timeline">
                        ${buildTimelineHTML(report.id)}
                    </div>
                    <div class="journey-lesson">
                        <div class="lesson-label">Key Lesson</div>
                        <div class="lesson-text">${report.lesson}</div>
                    </div>
                </div>
            </div>
        `;
    });
    html += `</div>`;
    // Key takeaways
    html += `<div class="report-section-title">Key Takeaways</div>`;
    html += `<div class="takeaways">`;
    const takeaways = [
        { icon: '💡', text: `<strong>Design decisions echo for decades.</strong> What seems like a small saving in 2025 can multiply into major costs across maintenance, inspection, operations, and decommissioning.` },
        { icon: '🔄', text: `<strong>Access drives everything.</strong> If you can't reach it, you can't inspect it. If you can't inspect it, you can't prove it's safe. If you can't prove it's safe, the regulator won't let you operate.` },
        { icon: '📊', text: `<strong>The cheapest option is rarely the best.</strong> But the most expensive isn't either. The "good" choice balances initial cost against 60 years of consequences.` },
        { icon: '⚠️', text: `<strong>Problems compound.</strong> A workaround in 2040 becomes a constraint in 2055 becomes a crisis in 2070. Each deferred fix makes the next intervention harder.` }
    ];
    takeaways.forEach(t => {
        html += `
            <div class="takeaway-item">
                <span class="takeaway-icon">${t.icon}</span>
                <span class="takeaway-text">${t.text}</span>
            </div>
        `;
    });
    html += `</div>`;
    document.getElementById('finalReportContent').innerHTML = html;
    // Set results background
    const resultsScreen = document.getElementById('resultsScreen');
    resultsScreen.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('images/bg_results.png')`;
    resultsScreen.style.backgroundSize = 'cover';
    resultsScreen.style.backgroundPosition = 'center';
    resultsScreen.classList.add('active');
}
function buildTimelineHTML(elId) {
    const el = GAME_DATA.elements[elId];
    const designChoice = STATE.designChoices[elId];
    const designOpt = el.stage1.options.find(o => o.id === designChoice);
    let html = '';
    // Stage 1 - Design
    html += `
        <div class="journey-stage">
            <div class="journey-stage-year">
                <div class="journey-stage-year-num">2025</div>
                <div class="journey-stage-year-phase">Design</div>
            </div>
            <div class="journey-stage-event">
                <div class="journey-stage-decision">${designOpt.name}</div>
                <div class="journey-stage-consequence">${designOpt.desc}</div>
            </div>
            <div class="journey-stage-cost">${formatMoney(designOpt.cost)}</div>
        </div>
    `;
    // Stages 2-5
    const stageInfo = [
        { num: 2, year: 2040, phase: 'Maintenance' },
        { num: 3, year: 2055, phase: 'Inspection' },
        { num: 4, year: 2070, phase: 'Operations' },
        { num: 5, year: 2085, phase: 'Decommission' }
    ];
    stageInfo.forEach(stage => {
        const choiceId = STATE.stageChoices[`${stage.num}_${elId}`];
        if (choiceId) {
            const stageData = el[`stage${stage.num}`];
            if (stageData && stageData[designChoice]) {
                let sd = stageData[designChoice];
                let chosenOption = null;
                let situation = '';
                // Navigate the data structure to find the chosen option
                if (sd.scenarios) {
                    Object.values(sd.scenarios).forEach(scenario => {
                        if (scenario.options) {
                            const found = scenario.options.find(o => o.id === choiceId);
                            if (found) {
                                chosenOption = found;
                                situation = scenario.situation || '';
                            }
                        }
                    });
                } else if (sd.options) {
                    chosenOption = sd.options.find(o => o.id === choiceId);
                    situation = sd.situation || '';
                } else if (sd.triggered || sd.notTriggered) {
                    const triggeredOpt = sd.triggered?.options?.find(o => o.id === choiceId);
                    const notTriggeredOpt = sd.notTriggered?.options?.find(o => o.id === choiceId);
                    chosenOption = triggeredOpt || notTriggeredOpt;
                    situation = triggeredOpt ? sd.triggered.situation : sd.notTriggered?.situation || '';
                }
                if (chosenOption) {
                    // Create a brief consequence description
                    let consequence = chosenOption.desc;
                    if (consequence.length > 100) {
                        consequence = consequence.substring(0, 100) + '...';
                    }
                    html += `
                        <div class="journey-stage">
                            <div class="journey-stage-year">
                                <div class="journey-stage-year-num">${stage.year}</div>
                                <div class="journey-stage-year-phase">${stage.phase}</div>
                            </div>
                            <div class="journey-stage-event">
                                <div class="journey-stage-decision">${chosenOption.name}</div>
                                <div class="journey-stage-consequence">${consequence}</div>
                            </div>
                            <div class="journey-stage-cost">${formatMoney(chosenOption.cost || 0)}</div>
                        </div>
                    `;
                }
            }
        }
    });
    return html;
}
function toggleJourney(elId) {
    const card = document.querySelector(`.journey-card[data-element="${elId}"]`);
    card.classList.toggle('expanded');
}
</script>
</body>
</html>
