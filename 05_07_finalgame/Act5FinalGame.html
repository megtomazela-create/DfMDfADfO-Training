<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The 60-Year Journey</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --white: #f7f8fa;
            --light-grey: #d0d9e0;
            --mid-grey: #9babc2;
            --slate: #4a5d6b;
            --dark-slate: #364451;
            --deep-navy: #1f2937;
            --green: #92d050;
            --blue: #00b0f0;
            --orange: #cc5500;
            --red: #dc2626;
            --amber: #f59e0b;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--deep-navy);
            color: var(--light-grey);
        }
        
        /* Version tag */
        .version-tag {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: var(--mid-grey);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            z-index: 9999;
        }
        
        /* ============================================
           CINEMATIC INTRO
           ============================================ */
        #cinematicIntro {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #000;
        }
        
        #cinematicIntro.hidden { display: none; }
        
        .intro-slide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }
        
        .intro-slide.active { opacity: 1; }
        
        .intro-slide .bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: brightness(0.35);
        }
        
        .intro-slide .bg.dark {
            background: linear-gradient(135deg, #0a1628, #1a2a3a, #0d1a2d);
            filter: none;
        }
        
        .intro-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 700px;
            padding: 40px;
        }
        
        .intro-logo img { max-width: 250px; margin-bottom: 30px; }
        .intro-company { color: var(--blue); text-transform: uppercase; letter-spacing: 4px; margin-bottom: 20px; }
        .intro-title { font-size: 3rem; color: var(--white); margin-bottom: 20px; }
        .intro-subtitle { font-size: 1.2rem; color: var(--light-grey); }
        
        .intro-text-box {
            background: rgba(31, 41, 55, 0.9);
            border-left: 4px solid var(--blue);
            padding: 30px;
            text-align: left;
            border-radius: 8px;
        }
        
        .intro-text-box p { margin-bottom: 15px; font-size: 1.1rem; line-height: 1.7; }
        .intro-text-box p:last-child { margin-bottom: 0; }
        .intro-text-box strong { color: var(--white); }
        .intro-text-box .highlight { color: var(--green); }
        
        .intro-year { font-size: 4rem; color: var(--blue); margin-bottom: 20px; }
        .intro-location { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        
        .intro-budget {
            display: inline-block;
            background: var(--green);
            color: var(--deep-navy);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 20px;
        }
        
        .intro-nav {
            position: absolute;
            bottom: 40px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }
        
        .intro-nav button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .intro-nav .btn-skip { background: transparent; color: var(--mid-grey); border: 1px solid var(--slate); }
        .intro-nav .btn-next { background: var(--blue); color: var(--deep-navy); }
        
        .intro-dots {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .intro-dot {
            width: 40px;
            height: 4px;
            background: var(--slate);
            border-radius: 2px;
            cursor: pointer;
        }
        
        .intro-dot.active { background: var(--blue); }
        .intro-dot.done { background: var(--green); }
        
        /* ============================================
           GAME LAYOUT
           ============================================ */
        #gameScreen {
            display: none;
            position: fixed;
            inset: 0;
            flex-direction: column;
        }
        
        #gameScreen.active { display: flex; }
        
        .top-bar {
            height: auto;
            background: var(--deep-navy);
            border-bottom: 1px solid var(--dark-slate);
            display: flex;
            flex-direction: column;
            padding: 10px 20px 0 20px;
            flex-shrink: 0;
        }
        
        .top-bar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .top-bar-logo img { height: 32px; }
        
        .top-bar-stats { display: flex; gap: 20px; font-size: 0.85rem; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .stat-value { color: var(--white); font-weight: 600; }
        .stat-value.warning { color: var(--amber); }
        .stat-value.danger { color: var(--red); }
        
        /* Timeline */
        .timeline-container {
            position: relative;
            padding: 0 40px 20px 40px;
        }
        
        .timeline-track {
            position: absolute;
            top: 24px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: var(--slate);
            border-radius: 2px;
        }
        
        .timeline-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, var(--green), var(--blue));
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .timeline-stages {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }
        
        .timeline-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }
        
        .timeline-node {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--dark-slate);
            border: 3px solid var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .timeline-stage.completed .timeline-node {
            background: var(--green);
            border-color: var(--green);
            color: var(--deep-navy);
        }
        
        .timeline-stage.completed .timeline-node::after {
            content: '‚úì';
            position: absolute;
            font-size: 1.2rem;
        }
        
        .timeline-stage.current .timeline-node {
            background: var(--blue);
            border-color: var(--blue);
            color: var(--deep-navy);
            box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3);
            animation: currentPulse 2s infinite;
        }
        
        @keyframes currentPulse {
            0%, 100% { box-shadow: 0 0 0 6px rgba(0, 176, 240, 0.3); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0.1); }
        }
        
        .timeline-stage.future .timeline-node {
            background: var(--dark-slate);
            border-color: var(--slate);
            color: var(--slate);
        }
        
        .timeline-label {
            margin-top: 8px;
            text-align: center;
        }
        
        .timeline-year {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mid-grey);
            transition: color 0.3s;
        }
        
        .timeline-stage.completed .timeline-year,
        .timeline-stage.current .timeline-year {
            color: var(--white);
        }
        
        .timeline-name {
            font-size: 0.7rem;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            transition: color 0.3s;
        }
        
        .timeline-stage.current .timeline-name {
            color: var(--blue);
        }
        
        .timeline-stage.completed .timeline-name {
            color: var(--green);
        }
        
        .btn-next-stage {
            display: none;
            padding: 8px 16px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        .btn-next-stage.visible { display: block; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(146, 208, 80, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(146, 208, 80, 0); }
        }
        
        .character-banner {
            display: none;
            align-items: center;
            gap: 15px;
            background: var(--dark-slate);
            padding: 12px 20px;
            border-left: 4px solid var(--orange);
            flex-shrink: 0;
        }
        
        .character-banner.visible { display: flex; }
        .character-banner.dave { border-color: var(--orange); }
        .character-banner.sarah { border-color: var(--blue); }
        .character-banner.mike { border-color: var(--green); }
        .character-banner.janet { border-color: var(--mid-grey); }
        
        .char-portrait {
            width: 50px; height: 50px;
            border-radius: 8px;
            background: var(--slate);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
        }
        
        .char-portrait img { width: 100%; height: 100%; object-fit: cover; }
        .char-info h4 { color: var(--white); margin-bottom: 2px; }
        .char-role { font-size: 0.85rem; color: var(--mid-grey); }
        
        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #1a1a2e;
        }
        
        .map-wrapper { position: relative; max-width: 100%; max-height: 100%; }
        
        .map-wrapper img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 250px);
            object-fit: contain;
        }
        
        .hotspot {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        
        .hotspot-dot {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: rgba(0, 176, 240, 0.3);
            border: 3px solid var(--blue);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            animation: hotspotPulse 2s infinite;
        }
        
        .hotspot:hover .hotspot-dot {
            transform: scale(1.15);
            background: rgba(0, 176, 240, 0.5);
        }
        
        .hotspot-dot.done {
            background: rgba(146, 208, 80, 0.3);
            border-color: var(--green);
            animation: none;
        }
        
        .hotspot-dot.done::after {
            content: '‚úì';
            color: var(--green);
            font-weight: bold;
        }
        
        .hotspot-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .hotspot:hover .hotspot-label { opacity: 1; }
        
        @keyframes hotspotPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 176, 240, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(0, 176, 240, 0); }
        }
        
        .bottom-bar {
            height: 40px;
            background: var(--deep-navy);
            border-top: 1px solid var(--dark-slate);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .progress-label { color: var(--mid-grey); font-size: 0.85rem; }
        
        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--dark-slate);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--slate);
        }
        
        .modal-header h3 { color: var(--white); }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--mid-grey);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body { padding: 20px; }
        
        /* Situation description */
        .situation-box {
            background: var(--slate);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--blue);
        }
        
        .situation-box p {
            color: var(--light-grey);
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .situation-box p:last-child { margin-bottom: 0; }
        .situation-box strong { color: var(--white); }
        .situation-box em { color: var(--amber); font-style: normal; }
        
        /* Character quote */
        .char-quote {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: var(--deep-navy);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .char-quote .char-portrait { width: 45px; height: 45px; flex-shrink: 0; }
        .char-quote-text { font-style: italic; color: var(--light-grey); line-height: 1.5; }
        .char-quote-name { color: var(--white); font-weight: 500; font-size: 0.85rem; margin-bottom: 5px; font-style: normal; }
        
        /* Design recall */
        .design-recall {
            background: var(--deep-navy);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--mid-grey);
            margin-bottom: 15px;
        }
        
        .design-recall strong { color: var(--white); }
        
        /* Options list */
        .options-list { display: flex; flex-direction: column; gap: 10px; }
        
        .option-card {
            background: var(--slate);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .option-card:hover { border-color: var(--blue); }
        .option-card.selected { border-color: var(--green); background: rgba(146, 208, 80, 0.1); }
        .option-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: transparent;
        }
        .option-card.disabled:hover { border-color: transparent; }
        .option-card.disabled .option-cost { color: var(--red); }
        
        .disabled-reason {
            color: var(--red);
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .option-name { color: var(--white); font-weight: 500; }
        
        .option-cost {
            background: var(--deep-navy);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--blue);
        }
        
        .option-desc { color: var(--light-grey); font-size: 0.9rem; margin-bottom: 10px; }
        
        .option-impacts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.8rem;
        }
        
        .impact { display: flex; align-items: center; gap: 4px; }
        .impact.negative { color: var(--red); }
        .impact.positive { color: var(--green); }
        .impact.neutral { color: var(--mid-grey); }
        
        /* Design choice (Stage 1) */
        .choice-image {
            width: 100%;
            height: 60px;
            background: var(--deep-navy);
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mid-grey);
            font-size: 0.75rem;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--slate);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary { background: var(--blue); color: var(--deep-navy); }
        .btn-danger { background: var(--red); color: var(--white); }
        .btn-secondary { background: var(--slate); color: var(--white); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* ============================================
           SCREENS (Transition, Summary, Results)
           ============================================ */
        .overlay-screen {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 600;
            align-items: center;
            justify-content: center;
        }
        
        .overlay-screen.active { display: flex; }
        
        .overlay-content {
            text-align: center;
            max-width: 650px;
            padding: 40px;
        }
        
        .trans-years { color: var(--mid-grey); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; }
        .trans-year { font-size: 5rem; color: var(--white); margin-bottom: 30px; }
        
        .trans-text {
            background: var(--dark-slate);
            padding: 25px;
            border-radius: 10px;
            text-align: left;
            margin-bottom: 30px;
        }
        
        .trans-text p { margin-bottom: 12px; line-height: 1.6; }
        .trans-text p:last-child { margin-bottom: 0; }
        
        .btn-continue {
            padding: 12px 30px;
            background: var(--blue);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Summary */
        .summary-title { font-size: 2rem; color: var(--white); margin-bottom: 10px; }
        .summary-subtitle { color: var(--mid-grey); margin-bottom: 25px; }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .summary-stat {
            background: var(--dark-slate);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-stat-icon { font-size: 1.3rem; margin-bottom: 5px; }
        .summary-stat-value { font-size: 1.2rem; font-weight: 600; color: var(--white); }
        .summary-stat-value.over { color: var(--red); }
        .summary-stat-label { font-size: 0.7rem; color: var(--mid-grey); text-transform: uppercase; margin-top: 3px; }
        
        .summary-decisions {
            background: var(--dark-slate);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .summary-decisions h4 { color: var(--white); margin-bottom: 12px; }
        
        .decision-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--slate);
            font-size: 0.9rem;
        }
        
        .decision-row:last-child { border-bottom: none; }
        .decision-element { color: var(--white); }
        
        .decision-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            max-width: 200px;
            text-align: right;
        }
        
        .decision-tag.good { background: var(--green); color: var(--deep-navy); }
        .decision-tag.ok { background: var(--amber); color: var(--deep-navy); }
        .decision-tag.poor { background: var(--red); color: var(--white); }
        
        .btn-next-phase {
            padding: 12px 30px;
            background: var(--green);
            color: var(--deep-navy);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Results */
        .results-grade {
            font-size: 7rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .results-grade.A { color: var(--green); }
        .results-grade.B { color: var(--blue); }
        .results-grade.C { color: var(--amber); }
        .results-grade.D { color: var(--red); }
        
        .results-title { color: var(--white); margin-bottom: 20px; }
        .results-verdict { color: var(--light-grey); margin-bottom: 30px; font-size: 1.1rem; }
        
        .results-totals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            background: var(--dark-slate);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .results-total { text-align: center; }
        .results-total-value { font-size: 1.4rem; font-weight: 600; color: var(--white); }
        .results-total-label { font-size: 0.8rem; color: var(--mid-grey); }
        
        /* Mobile */
        @media (max-width: 768px) {
            .top-bar-stats { display: none; }
            .summary-stats, .results-totals { grid-template-columns: repeat(2, 1fr); }
            .intro-title { font-size: 2rem; }
            
            .timeline-container { padding: 0 10px 15px 10px; }
            .timeline-track { left: 30px; right: 30px; }
            .timeline-stage { min-width: 60px; }
            .timeline-node { width: 36px; height: 36px; font-size: 0.65rem; }
            .timeline-year { font-size: 0.8rem; }
            .timeline-name { font-size: 0.55rem; }
        }
        
        @media (max-width: 480px) {
            .timeline-name { display: none; }
            .timeline-node { width: 30px; height: 30px; font-size: 0.6rem; }
        }
    </style>
</head>
<body>

<!-- VERSION TAG -->
<div class="version-tag">v0.9</div>

<!-- CINEMATIC INTRO -->
<div id="cinematicIntro">
    <div class="intro-slide active" data-slide="1">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="The Nuclear House">
            </div>
            <p class="intro-company">Presents</p>
            <h1 class="intro-title">The 60-Year Journey</h1>
            <p class="intro-subtitle">An interactive experience in design for decommissioning</p>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="2">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <p class="intro-location">Somerset Coast, UK</p>
            <h2 class="intro-year">2025</h2>
            <div class="intro-text-box">
                <p><strong>Thornbury Point Nuclear Power Station.</strong></p>
                <p>Sixty years of operation ahead. Someone needs to design it right.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="3">
        <div class="bg" style="background-image: url('images/gamebackground.png');"></div>
        <div class="intro-content">
            <div class="intro-text-box">
                <p>You've been assigned <span class="highlight">Section 4B</span>: Primary coolant system auxiliaries.</p>
                <p>Your design will be built, operated, inspected, and decommissioned over <strong>sixty years</strong>.</p>
                <p>Four people will inherit your choices. Their success depends on what you decide.</p>
            </div>
        </div>
    </div>
    
    <div class="intro-slide" data-slide="4">
        <div class="bg dark"></div>
        <div class="intro-content">
            <div class="intro-text-box" style="text-align: center; border-left: none; border: 2px solid var(--blue);">
                <p><strong>Six design decisions. Each has consequences.</strong></p>
                <p>Good choices make future decisions easier and cheaper.<br>Poor choices force compromises for decades.</p>
                <div class="intro-budget">Design Budget: ¬£800,000</div>
            </div>
        </div>
    </div>
    
    <div class="intro-dots">
        <div class="intro-dot active" data-dot="1"></div>
        <div class="intro-dot" data-dot="2"></div>
        <div class="intro-dot" data-dot="3"></div>
        <div class="intro-dot" data-dot="4"></div>
    </div>
    
    <div class="intro-nav">
        <button class="btn-skip" id="btnSkip">Skip</button>
        <button class="btn-next" id="btnIntroNext">Continue ‚Üí</button>
    </div>
</div>

<!-- GAME SCREEN -->
<div id="gameScreen">
    <div class="top-bar">
        <div class="top-bar-header">
            <div class="top-bar-logo">
                <img src="../00_images/Logo_White_Nobackground.png" alt="Logo">
            </div>
            <div class="top-bar-stats" id="topStats"></div>
            <button class="btn-next-stage" id="btnNextStage">Complete Stage ‚Üí</button>
        </div>
        <div class="timeline-container">
            <div class="timeline-track">
                <div class="timeline-progress" id="timelineProgress"></div>
            </div>
            <div class="timeline-stages" id="timelineStages">
                <div class="timeline-stage current" data-stage="1">
                    <div class="timeline-node">1</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2025</div>
                        <div class="timeline-name">Design</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="2">
                    <div class="timeline-node">2</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2040</div>
                        <div class="timeline-name">Maintenance</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="3">
                    <div class="timeline-node">3</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2055</div>
                        <div class="timeline-name">Inspection</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="4">
                    <div class="timeline-node">4</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2070</div>
                        <div class="timeline-name">Operations</div>
                    </div>
                </div>
                <div class="timeline-stage future" data-stage="5">
                    <div class="timeline-node">5</div>
                    <div class="timeline-label">
                        <div class="timeline-year">2085</div>
                        <div class="timeline-name">Decommission</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="character-banner" id="characterBanner">
        <div class="char-portrait" id="charPortrait">üë∑</div>
        <div class="char-info">
            <h4 id="charName">Dave Morton</h4>
            <p class="char-role" id="charRole">Maintenance Supervisor</p>
        </div>
    </div>
    
    <div class="map-container">
        <div class="map-wrapper">
            <img src="images/gamebackground.png" alt="Section 4B">
            
            <div class="hotspot" data-element="pumpAccess" style="left: 18%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pump Access</span>
            </div>
            
            <div class="hotspot" data-element="weldClearance" style="left: 42%; top: 46%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Weld Clearance</span>
            </div>
            
            <div class="hotspot" data-element="controlPanel" style="left: 85%; top: 42%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Control Panel</span>
            </div>
            
            <div class="hotspot" data-element="pipeConnections" style="left: 56%; top: 52%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Connections</span>
            </div>
            
            <div class="hotspot" data-element="pipeRouting" style="left: 62%; top: 82%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Pipe Routing</span>
            </div>
            
            <div class="hotspot" data-element="materialSpec" style="left: 32%; top: 58%;">
                <div class="hotspot-dot"></div>
                <span class="hotspot-label">Material Spec</span>
            </div>
        </div>
    </div>
    
    <div class="bottom-bar">
        <span class="progress-label" id="progressLabel">0 of 6 complete</span>
    </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">Element</h3>
            <button class="modal-close" id="modalClose">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<!-- TRANSITION SCREEN -->
<div class="overlay-screen" id="transitionScreen">
    <div class="overlay-content">
        <p class="trans-years" id="transYears">15 YEARS LATER</p>
        <h2 class="trans-year" id="transYear">2040</h2>
        <div class="trans-text" id="transText"></div>
        <button class="btn-continue" id="btnTransContinue">Continue ‚Üí</button>
    </div>
</div>

<!-- SUMMARY SCREEN -->
<div class="overlay-screen" id="summaryScreen">
    <div class="overlay-content">
        <h2 class="summary-title" id="sumTitle">Stage Complete</h2>
        <p class="summary-subtitle" id="sumSubtitle"></p>
        <div class="summary-stats" id="sumStats"></div>
        <div class="summary-decisions" id="sumDecisions"></div>
        <button class="btn-next-phase" id="btnNextPhase">Next Stage ‚Üí</button>
    </div>
</div>

<!-- RESULTS SCREEN -->
<div class="overlay-screen" id="resultsScreen">
    <div class="overlay-content">
        <div class="results-grade" id="resGrade">B</div>
        <h2 class="results-title">60 Years Complete</h2>
        <p class="results-verdict" id="resVerdict">Competent Engineer</p>
        <div class="results-totals" id="resTotals"></div>
        <button class="btn-continue" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
// ============================================
// GAME DATA - ALL STAGES HAVE DECISIONS
// Good design = easy/cheap options
// Poor design = hard/expensive options
// ============================================
const GAME_DATA = {
    stages: {
        1: { name: 'DESIGN', year: 2025, budget: 800000 },
        2: { name: 'MAINTENANCE', year: 2040, budget: 400000, time: 30, char: 'dave' },
        3: { name: 'INSPECTION', year: 2055, budget: 250000, time: 21, char: 'sarah' },
        4: { name: 'OPERATIONS', year: 2070, budget: 200000, time: 7, char: 'mike' },
        5: { name: 'DECOMMISSIONING', year: 2085, budget: 1200000, time: 90, char: 'janet' }
    },
    
    characters: {
        dave: { name: 'Dave Morton', role: 'Maintenance Supervisor', emoji: 'üë∑' },
        sarah: { name: 'Sarah Okonkwo', role: 'Principal Inspector', emoji: 'üîç' },
        mike: { name: 'Mike Brennan', role: 'Shift Operations Manager', emoji: 'üë®‚Äçüíº' },
        janet: { name: 'Janet Cole', role: 'Decommissioning Lead', emoji: 'üë©‚Äçüîß' }
    },
    
    transitions: {
        2: { years: '15 YEARS LATER', year: '2040', text: ['Thornbury Point has been generating power for 14 years.', 'Your design drawings are yellowed paper in a filing cabinet.', 'It\'s time for the first major maintenance outage.'] },
        3: { years: '15 YEARS LATER', year: '2055', text: ['Thirty years of operation.', 'Regulators want proof everything is still safe.', 'Every weld, every component needs inspection.'] },
        4: { years: '15 YEARS LATER', year: '2070', text: ['Forty-five years. The plant is showing its age.', 'Tonight, the alarms will test your control room design.'] },
        5: { years: '15 YEARS LATER', year: '2085', text: ['Sixty years. The reactor is shut down for good.', 'Now comes the hard part: taking it all apart safely.'] }
    },
    
    elements: {
        // ==========================================
        // ELEMENT 1: PUMP ACCESS
        // ==========================================
        pumpAccess: {
            title: 'Pump Location/Access',
            stage1: {
                description: 'How should the primary coolant pump be positioned?',
                options: [
                    { id: 'corner', name: 'Corner Position', desc: 'Tucked in corner to maximise floor space. 1.8m clearance.', cost: 80000, quality: 'poor' },
                    { id: 'openBay', name: 'Open Bay', desc: '2m clearance all sides, under crane rails.', cost: 120000, quality: 'good' },
                    { id: 'dedicated', name: 'Dedicated Shielded Room', desc: 'Separate room with airlock. Maximum protection.', cost: 200000, quality: 'wasteful' }
                ]
            },
            // STAGE 2: MAINTENANCE - Every design gets decisions, but difficulty varies
            stage2: {
                corner: {
                    situation: 'RCP seal replacement required. The pump is 2.1m wide but the corner position only provides 1.8m clearance. It physically cannot be removed through the access route.',
                    quote: "Boss, we've got a problem. That corner position from the 2025 design - the pump doesn't fit through the gap. Whoever signed off on 1.8m clearance for a 2.1m pump... anyway, what do you want us to do?",
                    options: [
                        { id: 'subcontract', name: 'Hire specialist rigging team', desc: 'Bring in experts with hydraulic jacks and custom rigging to work around the constraint.', cost: 180000, time: 18, dose: 3 },
                        { id: 'force', name: 'Attempt to tilt and manoeuvre through', desc: 'Try to angle the pump through the gap. Risky - may damage pump casing.', cost: 40000, time: 5, dose: 6, risk: 70 },
                        { id: 'modify', name: 'Cut a larger access opening', desc: 'Permanently modify the wall structure to create adequate access.', cost: 120000, time: 14, dose: 4 }
                    ]
                },
                openBay: {
                    situation: 'RCP seal replacement required. The pump is positioned in the open bay with 2m clearance and full crane coverage.',
                    quote: "Good news - that open bay layout from 2025 is paying off. We've got full crane access, plenty of clearance. Standard lift operation. Just need your sign-off on the approach.",
                    options: [
                        { id: 'standard', name: 'Standard crane lift', desc: 'Routine lift operation. Remove pump, replace seals, reinstall.', cost: 25000, time: 3, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced procedure with extra inspections', desc: 'While the pump is out, conduct additional inspections of the mounting and surrounding area.', cost: 40000, time: 4, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'RCP seal replacement required. The pump is in a dedicated shielded room with airlock system.',
                    quote: "The pump room from 2025 - it's accessible, but this airlock system adds a lot of complexity. We need full contamination protocols just to get in there. Did we really need all this shielding for a coolant pump?",
                    options: [
                        { id: 'airlock', name: 'Full airlock protocol', desc: 'Follow complete airlock entry and exit procedures as designed.', cost: 45000, time: 6, dose: 2 },
                        { id: 'bypass', name: 'Temporary airlock bypass', desc: 'Faster access but requires additional contamination control paperwork.', cost: 35000, time: 4, dose: 2.5 }
                    ]
                }
            },
            // STAGE 3: INSPECTION
            stage3: {
                corner: {
                    situation: 'Pump casing and mounting bolts require ultrasonic inspection. The corner position provides insufficient clearance for standard probe positioning.',
                    quote: "Remember that corner position from 2025? Now I can't get my UT probe in at the correct angle. The clearance is too tight for proper inspection coverage. How do you want me to handle this?",
                    options: [
                        { id: 'scaffold', name: 'Erect scaffolding and use angled probes', desc: 'Partial coverage achievable. Will need to document limitations in the report.', cost: 45000, time: 5, dose: 3, trigger: 'pumpInspectionGap' },
                        { id: 'accept', name: 'Accept the inspection limitation', desc: 'Mark areas as "inaccessible" in the inspection report. Regulator will note this.', cost: 5000, time: 1, dose: 0.5, healthImpact: -10, trigger: 'pumpInspectionGap' },
                        { id: 'retrofit', name: 'Install permanent access platform', desc: 'Expensive now, but enables full inspection coverage for remaining plant life.', cost: 120000, time: 12, dose: 2 }
                    ]
                },
                openBay: {
                    situation: 'Pump casing and mounting bolts require ultrasonic inspection. The open bay provides excellent access from all angles.',
                    quote: "That open bay design from 2025 - brilliant. I've got full access all around the pump. Can get my probes in at every angle needed. Standard inspection or do you want the enhanced coverage?",
                    options: [
                        { id: 'standard', name: 'Standard UT inspection', desc: 'Full coverage with standard equipment. Meets all requirements.', cost: 15000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced inspection with TOFD', desc: 'Additional Time-of-Flight Diffraction technique for better defect sizing.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'Pump inspection required. Good access once inside the room, but airlock protocols apply.',
                    quote: "The pump room - good access once I'm inside, but these airlock protocols from the 2025 design slow everything down. Every entry and exit is a procedure. What's the priority here?",
                    options: [
                        { id: 'standard', name: 'Standard inspection with airlock', desc: 'Follow full entry/exit protocols for each inspection task.', cost: 25000, time: 4, dose: 1.5 },
                        { id: 'extended', name: 'Extended single-entry inspection', desc: 'Minimise entries by doing extra work during each access.', cost: 35000, time: 5, dose: 2 }
                    ]
                }
            },
            // STAGE 4: OPERATIONS
            stage4: {
                corner: {
                    checkTrigger: 'pumpInspectionGap',
                    triggered: {
                        situation: 'Night shift. Pump vibrations spiking. The vibration is coming from the area that could not be inspected in 2055 due to access limitations.',
                        quote: "It's 3am and we've got a problem. Pump vibrations are spiking - and it's coming from exactly the area we couldn't inspect back in 2055 because of that corner position. We're flying blind here. What's the call?",
                        options: [
                            { id: 'shutdown', name: 'Emergency shutdown for inspection', desc: 'Safe option but significant revenue loss and investigation required.', cost: 150000, time: 5, dose: 2 },
                            { id: 'reduce', name: 'Reduce power to 50%', desc: 'Lower the stress on the pump. Monitor closely and hope it stabilises.', cost: 50000, time: 0, dose: 0, risk: 50, healthImpact: -5 },
                            { id: 'continue', name: 'Continue and monitor', desc: 'It might be fine. Or it might not.', cost: 0, time: 0, dose: 0, risk: 70, healthImpact: -15 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Pump operational review. Despite the corner position, vibrations are within normal range.',
                        quote: "Pump review time. That corner position still makes me nervous - we got lucky on the inspection coverage. Vibrations are okay for now, but I'd recommend enhanced monitoring. Your call.",
                        options: [
                            { id: 'monitor', name: 'Enhanced monitoring programme', desc: 'Install additional vibration sensors and analysis equipment.', cost: 30000, time: 1, dose: 0 },
                            { id: 'continue', name: 'Standard monitoring', desc: 'Continue with normal surveillance programme.', cost: 10000, time: 0, dose: 0 }
                        ]
                    }
                },
                openBay: {
                    situation: 'Pump operational review. All parameters nominal. Full inspection history available from good access in previous years.',
                    quote: "Pump running perfectly. That open bay design from 2025 has given us complete inspection records over the years - we know exactly what condition it's in. No concerns here. Just confirming the monitoring approach.",
                    options: [
                        { id: 'standard', name: 'Standard monitoring', desc: 'Continue normal surveillance programme.', cost: 5000, time: 0, dose: 0 },
                        { id: 'predictive', name: 'Predictive maintenance analysis', desc: 'Use historical data to optimise timing of next maintenance.', cost: 15000, time: 0, dose: 0 }
                    ]
                },
                dedicated: {
                    situation: 'Pump operational review. Pump running well but the airlock system requires its own maintenance.',
                    quote: "Pump's fine, but that dedicated room from 2025 - now the airlock seals need servicing. We're maintaining equipment just to maintain other equipment. What's your priority?",
                    options: [
                        { id: 'service', name: 'Full airlock service', desc: 'Complete maintenance of the airlock system.', cost: 25000, time: 2, dose: 0.5 },
                        { id: 'defer', name: 'Defer airlock maintenance', desc: 'Not critical yet. Can wait until next outage.', cost: 5000, time: 0, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            // STAGE 5: DECOMMISSIONING
            stage5: {
                corner: {
                    situation: 'Pump removal for decommissioning. The same access problem from 2040 remains - the pump still does not fit through the corner access route.',
                    quote: "Sixty years later and we're right back where we were in 2040. That corner position - pump still doesn't fit through the gap. We've got three options, none of them cheap.",
                    options: [
                        { id: 'demolish', name: 'Demolish wall section', desc: 'Remove the concrete wall to create adequate access.', cost: 80000, time: 15, dose: 4 },
                        { id: 'cut', name: 'Cut pump into pieces in-situ', desc: 'Segment the pump for removal. Manual cutting in confined space.', cost: 60000, time: 20, dose: 8 },
                        { id: 'robot', name: 'Robotic cutting system', desc: 'Remote cutting minimises dose but requires specialist equipment.', cost: 200000, time: 8, dose: 1 }
                    ]
                },
                openBay: {
                    situation: 'Pump removal for decommissioning. Full crane access available - reverse of original installation.',
                    quote: "This is how decommissioning should work. That open bay from 2025 - crane hooks on, pump lifts out. Exactly like the installation but in reverse. Clean and simple. How do you want it handled?",
                    options: [
                        { id: 'standard', name: 'Standard crane removal', desc: 'Lift and containerise in one operation.', cost: 20000, time: 3, dose: 1 },
                        { id: 'segmented', name: 'Segmented removal for recycling', desc: 'Additional cutting to enable material segregation and recycling.', cost: 35000, time: 5, dose: 1.5 }
                    ]
                },
                dedicated: {
                    situation: 'Pump removal straightforward, but the entire dedicated shielded room must also be decommissioned.',
                    quote: "Pump comes out in a day - that's not the problem. But that whole shielded room from 2025? The walls, the airlock, all the unnecessary structure - it all has to come out too. Major extra work.",
                    options: [
                        { id: 'full', name: 'Full room decommissioning', desc: 'Remove pump and all associated room structures.', cost: 150000, time: 12, dose: 2 },
                        { id: 'seal', name: 'Remove pump, seal room for later', desc: 'Defer the room decommissioning. Creates future liability.', cost: 60000, time: 5, dose: 1, healthImpact: -5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 2: WELD CLEARANCE
        // ==========================================
        weldClearance: {
            title: 'Weld Access Clearance',
            stage1: {
                description: 'What clearance around pipe welds for inspection access?',
                options: [
                    { id: '50mm', name: '50mm (Code Minimum)', desc: 'Meets code but just barely.', cost: 60000, quality: 'poor' },
                    { id: '150mm', name: '150mm Clearance', desc: 'Adequate for all standard probes.', cost: 90000, quality: 'good' },
                    { id: '300mm', name: '300mm + Permanent Scaffolding', desc: 'Maximum clearance with fixed platforms.', cost: 160000, quality: 'wasteful' }
                ]
            },
            stage2: {
                '50mm': {
                    situation: 'Weld repair needed on a pipe section. The 50mm code-minimum clearance from the 2025 design makes welding positions extremely awkward.',
                    quote: "We've got a weld that needs repair, but that 50mm clearance from 2025 - it's the absolute minimum and now we're paying for it. My welder can barely get in there. How do you want to handle this?",
                    options: [
                        { id: 'awkward', name: 'Weld in awkward position', desc: 'Attempt the repair in constrained space. Risk of poor weld quality.', cost: 15000, time: 4, dose: 4, risk: 20, healthImpact: -5 },
                        { id: 'platform', name: 'Install temporary access platform', desc: 'Better working position, better quality weld.', cost: 35000, time: 6, dose: 2 },
                        { id: 'defer', name: 'Defer repair to next outage', desc: 'Leave the defect and monitor. Risk of progression.', cost: 0, time: 0, dose: 0, healthImpact: -5, trigger: 'weldDeferred' }
                    ]
                },
                '150mm': {
                    situation: 'Weld repair needed on a pipe section. The 150mm clearance specified in 2025 provides adequate working room.',
                    quote: "Found a weld that needs attention. Good news is that 150mm clearance from 2025 - my welder can get in there comfortably. Standard repair or do you want the enhanced treatment?",
                    options: [
                        { id: 'standard', name: 'Standard weld repair', desc: 'Normal repair procedure with good access.', cost: 20000, time: 2, dose: 1 },
                        { id: 'enhanced', name: 'Enhanced repair with PWHT', desc: 'Post-weld heat treatment for maximum longevity.', cost: 30000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld repair needed. Plenty of clearance, but the permanent scaffolding installed in 2025 has surface contamination.',
                    quote: "The 300mm clearance is great for access, but that permanent scaffolding from 2025? It's picked up contamination over 15 years. We need to deal with that before we can work on the weld.",
                    options: [
                        { id: 'decon', name: 'Decontaminate scaffolding first', desc: 'Clean the scaffolding surfaces before repair work.', cost: 30000, time: 4, dose: 2 },
                        { id: 'remove', name: 'Remove contaminated scaffolding sections', desc: 'Take out the affected sections. Creates waste but clears the area.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                }
            },
            stage3: {
                '50mm': {
                    situation: 'In-Service Inspection of pipe welds required. The UT probe needs 80mm minimum clearance - you only have 50mm.',
                    quote: "In-service inspection time. That 50mm clearance from 2025 - my probe needs 80mm to get the right angle. I physically cannot achieve full coverage. What do you want me to do?",
                    options: [
                        { id: 'partial', name: 'Accept 60% coverage', desc: 'Document the limitation. Regulator will note the gap.', cost: 5000, time: 3, dose: 3, healthImpact: -10, trigger: 'weldInspectionGap' },
                        { id: 'miniprobe', name: 'Use specialist miniature probes', desc: 'Smaller probes give better access but reduced accuracy.', cost: 40000, time: 5, dose: 4, healthImpact: -5 },
                        { id: 'excavate', name: 'Excavate wall for permanent access', desc: 'Create the clearance that should have been there from the start.', cost: 90000, time: 10, dose: 3 }
                    ]
                },
                '150mm': {
                    situation: 'In-Service Inspection of pipe welds required. The 150mm clearance provides full probe access.',
                    quote: "Weld inspections due. That 150mm clearance from 2025 - exactly what I need. Full coverage, all angles. Just need to know if you want standard or the enhanced approach.",
                    options: [
                        { id: 'standard', name: 'Standard UT examination', desc: '100% coverage achieved with standard equipment.', cost: 15000, time: 2, dose: 1 },
                        { id: 'phased', name: 'Phased array for enhanced detection', desc: 'Better defect characterisation and sizing.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld inspection required. The permanent scaffolding from 2025 partially blocks some probe angles.',
                    quote: "Good clearance overall, but that permanent scaffolding from 2025 is in my way for some of the shots. I can work around it, but it adds time. Or we can survey the scaffolding condition too while we're here.",
                    options: [
                        { id: 'workaround', name: 'Work around scaffolding', desc: 'Some awkward angles but achievable.', cost: 20000, time: 4, dose: 2 },
                        { id: 'survey', name: 'Include scaffolding contamination survey', desc: 'Check the scaffolding condition while doing the inspection.', cost: 30000, time: 5, dose: 2.5 }
                    ]
                }
            },
            stage4: {
                '50mm': {
                    checkTrigger: 'weldInspectionGap',
                    triggered: {
                        situation: 'Leak detected at a weld location. It is in the area that could not be fully inspected in 2055 due to the 50mm clearance limitation.',
                        quote: "We've got a leak - and it's at exactly the weld location we couldn't properly inspect in 2055 because of that 50mm clearance. If we'd had proper access, we'd have caught this developing. What now?",
                        options: [
                            { id: 'shutdown', name: 'Immediate shutdown and repair', desc: 'Fix it properly. Significant outage required.', cost: 200000, time: 14, dose: 5 },
                            { id: 'seal', name: 'Online leak sealing', desc: 'Temporary clamp seal. May not hold long-term.', cost: 50000, time: 2, dose: 2, risk: 40, healthImpact: -10 },
                            { id: 'reduce', name: 'Reduce power and monitor', desc: 'Lower pressure may slow the leak. Live with it until planned outage.', cost: 80000, time: 0, dose: 0, healthImpact: -5 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Weld operational review. No leaks detected, but the areas with limited inspection coverage remain a concern.',
                        quote: "No leaks yet, but that 50mm clearance from 2025 still limits what we could see in inspections. We're monitoring the areas we could check - but what we couldn't see still worries me.",
                        options: [
                            { id: 'monitor', name: 'Enhanced leak detection', desc: 'Additional monitoring equipment on high-risk areas.', cost: 25000, time: 1, dose: 0 },
                            { id: 'standard', name: 'Standard monitoring', desc: 'Continue with normal programme.', cost: 10000, time: 0, dose: 0 }
                        ]
                    }
                },
                '150mm': {
                    situation: 'Weld operational review. All welds were fully inspected at the 30-year mark. No concerns.',
                    quote: "All those welds we inspected properly in 2055 because of the 150mm clearance? Complete records, no surprises. Full confidence in the system. Just confirming monitoring approach.",
                    options: [
                        { id: 'maintain', name: 'Maintain inspection programme', desc: 'Continue the proven approach.', cost: 5000, time: 0, dose: 0 },
                        { id: 'extend', name: 'Extend coverage to additional welds', desc: 'Broaden the surveillance programme.', cost: 15000, time: 1, dose: 0.5 }
                    ]
                },
                '300mm': {
                    situation: 'Welds are fine but the permanent scaffolding contamination levels are increasing each year. Annual surveys now required.',
                    quote: "Welds are all okay, but that scaffolding from 2025 - the contamination keeps building up. We're now doing annual surveys just to track how hot it's getting. Want to deal with it now or keep monitoring?",
                    options: [
                        { id: 'survey', name: 'Continue annual scaffolding surveys', desc: 'Track the contamination build-up.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'remove', name: 'Remove scaffolding now', desc: 'Deal with it before it becomes ILW.', cost: 40000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                '50mm': {
                    situation: 'Pipe cutting required for removal. The 50mm clearance leaves no room for standard cutting equipment.',
                    quote: "Time to cut these pipes out. That 50mm clearance from 2025 - no room for our normal cutting gear. We're going to be doing this the hard way. Confined space work or bring in specialists?",
                    options: [
                        { id: 'manual', name: 'Manual cutting in confined space', desc: 'High dose, slow progress, contamination risk.', cost: 30000, time: 8, dose: 5, risk: 40 },
                        { id: 'specialist', name: 'Specialist confined-space contractor', desc: 'Experts with proper equipment for tight access.', cost: 100000, time: 5, dose: 2 }
                    ]
                },
                '150mm': {
                    situation: 'Pipe cutting for removal. Good access for standard cutting equipment.',
                    quote: "That 150mm clearance from 2025 - still paying dividends at the end. Standard cutting gear fits perfectly. Clean cuts, professional job. What's the approach?",
                    options: [
                        { id: 'standard', name: 'Standard cutting and removal', desc: 'Normal decommissioning procedures.', cost: 25000, time: 3, dose: 1 },
                        { id: 'segregate', name: 'Cut with material segregation', desc: 'Additional effort to separate materials for recycling.', cost: 35000, time: 4, dose: 1.5 }
                    ]
                },
                '300mm': {
                    situation: 'Weld cutting is easy with the clearance, but the permanent scaffolding has become ILW after 30 years of contamination accumulation.',
                    quote: "Easy access for the welds - that's the good news. The bad news? That scaffolding from 2025 has been accumulating activity for 60 years. It's now intermediate level waste. Another disposal headache.",
                    options: [
                        { id: 'both', name: 'Remove welds and scaffolding together', desc: 'Deal with the additional waste now.', cost: 85000, time: 8, dose: 3 },
                        { id: 'defer', name: 'Welds now, scaffolding later', desc: 'Split the work. Extends overall project.', cost: 50000, time: 5, dose: 2, healthImpact: -3 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 3: CONTROL PANEL
        // ==========================================
        controlPanel: {
            title: 'Control Panel Layout',
            stage1: {
                description: 'How should the control panel be organised?',
                options: [
                    { id: 'system', name: 'System-Based Layout', desc: 'Grouped by system (all pump controls together).', cost: 70000, quality: 'poor' },
                    { id: 'task', name: 'Task-Based Layout', desc: 'Grouped by workflow. Emergency sequence left-to-right.', cost: 100000, quality: 'good' },
                    { id: 'touch', name: 'Touchscreen Interface', desc: 'Modern digital displays. Impressive technology.', cost: 150000, quality: 'poor' }
                ]
            },
            stage2: {
                system: {
                    situation: 'Operators have submitted 15 human factors concern reports in 15 years. The system-based layout causes confusion during abnormal conditions - controls for related actions are scattered across different panels.',
                    quote: "We've had 15 formal complaints about the control panel since 2025. The system-based layout - when things go wrong, operators can't find what they need quickly. Controls for emergency sequences are all over the place. How do you want to address this?",
                    options: [
                        { id: 'redesign', name: 'Commission HF review and redesign', desc: 'Proper human factors assessment and panel modifications.', cost: 60000, time: 0, dose: 0, setFlag: 'panelRedesigned' },
                        { id: 'labels', name: 'Add labels and colour coding', desc: 'Cheap visual improvements. Limited real benefit.', cost: 15000, time: 0, dose: 0 },
                        { id: 'nothing', name: 'Issue training reminder', desc: 'Tell operators to try harder.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                task: {
                    situation: 'Control room operations review. The task-based layout from 2025 is working well - operators report intuitive workflow during both normal and abnormal conditions.',
                    quote: "The operators love the panel layout from 2025. Task-based design - emergency sequences flow left to right, everything's where they expect it. Just needs standard maintenance. Any enhancements you want to add?",
                    options: [
                        { id: 'maintain', name: 'Standard maintenance', desc: 'Keep it running as designed.', cost: 10000, time: 0, dose: 0 },
                        { id: 'enhance', name: 'Add status display enhancements', desc: 'Minor improvements to status indicators.', cost: 20000, time: 0, dose: 0 }
                    ]
                },
                touch: {
                    situation: 'Three touchscreen failures in 15 years. Operators report issues with gloves, low-light conditions, and response lag during high-activity periods.',
                    quote: "That touchscreen system from 2025 - we've had three complete failures already. Operators can't use it with gloves, it's hard to see in emergency lighting, and it lags when they need it most. I'm concerned about the next emergency. What do you want to do?",
                    options: [
                        { id: 'backup', name: 'Install hardwired backup panel', desc: 'Physical buttons as safety backup.', cost: 70000, time: 0, dose: 0, setFlag: 'backupPanel' },
                        { id: 'upgrade', name: 'Upgrade to industrial touchscreens', desc: 'Better screens, but still touchscreens.', cost: 50000, time: 0, dose: 0 },
                        { id: 'train', name: 'Additional operator training', desc: 'Train them to work around the limitations.', cost: 10000, time: 0, dose: 0 }
                    ]
                }
            },
            stage3: {
                system: {
                    situation: 'Regulatory safety review of control systems. Human-Machine Interface assessment is part of the inspection programme.',
                    quote: "Regulator is here for the HMI assessment. That system-based layout from 2025 - they're going to note the operator complaints. We should have the review documentation ready. How thorough do you want us to be?",
                    options: [
                        { id: 'review', name: 'Full HMI review with action plan', desc: 'Comprehensive assessment and improvement recommendations.', cost: 20000, time: 2, dose: 0 },
                        { id: 'minimal', name: 'Minimal compliance documentation', desc: 'Meet the minimum requirements.', cost: 8000, time: 1, dose: 0 }
                    ]
                },
                task: {
                    situation: 'Regulatory safety review of control systems. The task-based panel from 2025 receives consistently high human factors ratings.',
                    quote: "Regulator's reviewing our control systems. That task-based layout from 2025? Operators score it highly, incident response times are good. We're in good shape. Standard review or go above and beyond?",
                    options: [
                        { id: 'standard', name: 'Standard review', desc: 'Confirm continued good performance.', cost: 10000, time: 1, dose: 0 },
                        { id: 'benchmark', name: 'Benchmark against industry best practice', desc: 'Compare to leading facilities worldwide.', cost: 18000, time: 2, dose: 0 }
                    ]
                },
                touch: {
                    situation: 'Safety review identifies display artefacts and intermittent software glitches in the touchscreen system. System is showing its age.',
                    quote: "The touchscreens from 2025 - they're 30 years old and the software is getting flaky. Display glitches, slow response. The regulator wants to see our maintenance plan. What level of fix are we looking at?",
                    options: [
                        { id: 'software', name: 'Full software update and hardware refresh', desc: 'Comprehensive system update.', cost: 35000, time: 2, dose: 0 },
                        { id: 'patch', name: 'Critical patches only', desc: 'Fix the worst bugs. Hope for the best.', cost: 15000, time: 1, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                system: {
                    checkFlag: 'panelRedesigned',
                    hasFlag: {
                        situation: 'ALARM: Loss of Coolant Flow indication. The panel was redesigned after the 2040 review - improved layout helps operator response.',
                        quote: "LOCA indication! Good news - we fixed that panel layout after 2040. Operators are finding controls faster than before. Still not as good as it could have been from the start, but better. What's your call on the response?",
                        options: [
                            { id: 'respond', name: 'Standard emergency response', desc: 'Follow procedure with improved panel.', cost: 20000, time: 1, dose: 1 },
                            { id: 'senior', name: 'Call shift supervisor for support', desc: 'Extra verification for complex event.', cost: 5000, time: 1, dose: 0.5 }
                        ]
                    },
                    noFlag: {
                        situation: 'ALARM: Loss of Coolant Flow indication. The system-based panel layout from 2025 was never fixed. Operators are struggling to locate the correct controls.',
                        quote: "LOCA indication at 3am! Operators can't find the isolation valves - that system-based layout from 2025 has controls scattered everywhere. We never fixed it after the complaints. This is exactly the scenario we worried about!",
                        options: [
                            { id: 'search', name: 'Search for correct controls', desc: 'Delayed response while operators hunt for switches.', cost: 50000, time: 2, dose: 3, risk: 40, healthImpact: -10 },
                            { id: 'senior', name: 'Immediately call senior operator', desc: 'Get experienced help. Your failure is on record.', cost: 10000, time: 1, dose: 1, trigger: 'operatorFailure' },
                            { id: 'procedure', name: 'Follow procedure step by step', desc: 'Slow but systematic reduces error chance.', cost: 30000, time: 3, dose: 2 }
                        ]
                    }
                },
                task: {
                    situation: 'ALARM: Loss of Coolant Flow indication. The task-based panel layout from 2025 means emergency controls are exactly where operators expect them.',
                    quote: "LOCA indication - but watch this. Task-based layout from 2025: reactor trip here, safety injection there, isolation valves in sequence. Operators are executing the response exactly as trained. Textbook.",
                    options: [
                        { id: 'respond', name: 'Execute standard emergency response', desc: 'Smooth response using well-designed panel.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'verify', name: 'Execute with additional verification', desc: 'Extra checks at each step.', cost: 8000, time: 0, dose: 0.5 }
                    ]
                },
                touch: {
                    checkFlag: 'backupPanel',
                    hasFlag: {
                        situation: 'ALARM: System transient. Touchscreens are lagging under heavy demand, but the backup hardwired panel installed after 2040 is available.',
                        quote: "Transient in progress - touchscreens are struggling with the load. But that backup panel we installed after 2040 is right there. Physical switches, instant response. Thank God we put that in. Switching over?",
                        options: [
                            { id: 'backup', name: 'Switch to hardwired backup', desc: 'Reliable physical controls.', cost: 15000, time: 1, dose: 1 },
                            { id: 'wait', name: 'Wait for touchscreens to recover', desc: 'They might speed up. Risky delay.', cost: 0, time: 2, dose: 0, risk: 30, healthImpact: -5 }
                        ]
                    },
                    noFlag: {
                        situation: 'ALARM: System transient. Touchscreens are frozen. Gloved fingers not registering. No backup panel available.',
                        quote: "Touchscreens are frozen solid! Operators can't get any response - gloves don't work, the screens have locked up. We never installed that backup panel after 2040. We have no control interface. What do we do?!",
                        options: [
                            { id: 'reboot', name: 'Emergency system reboot', desc: 'Fast but everything goes dark during restart.', cost: 0, time: 2, dose: 0, risk: 50, healthImpact: -15 },
                            { id: 'manual', name: 'Send operators to local panels', desc: 'Manual operation from field locations.', cost: 30000, time: 4, dose: 4 },
                            { id: 'scram', name: 'Manual reactor trip', desc: 'Safe shutdown. Major investigation follows.', cost: 100000, time: 5, dose: 1 }
                        ]
                    }
                }
            },
            stage5: {
                system: {
                    situation: 'Control panel decommissioning. Standard electrical equipment removal.',
                    quote: "Taking out the control panels. That system-based layout from 2025 caused headaches for 60 years - at least it comes out easily. Standard removal or do you want it preserved for lessons learned?",
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning procedure.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'preserve', name: 'Preserve as training example', desc: 'Document what not to do for future projects.', cost: 20000, time: 3, dose: 0.5 }
                    ]
                },
                task: {
                    situation: 'Control panel decommissioning. The well-designed panel served operators well for 60 years.',
                    quote: "End of the line for the control panel. That task-based design from 2025 served us well - 60 years of reliable operation, operators loved it. Any interest in documenting this as a best practice example?",
                    options: [
                        { id: 'standard', name: 'Standard removal', desc: 'Normal decommissioning procedure.', cost: 10000, time: 2, dose: 0.5 },
                        { id: 'document', name: 'Document as best practice', desc: 'Capture the design principles for future projects.', cost: 15000, time: 2, dose: 0.5 }
                    ]
                },
                touch: {
                    situation: 'Touchscreen system decommissioning. Electronic waste requires specialist disposal.',
                    quote: "The touchscreen system from 2025 - finally taking it out. E-waste disposal requirements for all this electronics. Plus the usual radioactive contamination on the surfaces. Specialist handling needed.",
                    options: [
                        { id: 'ewaste', name: 'Specialist e-waste disposal', desc: 'Proper handling of contaminated electronics.', cost: 30000, time: 3, dose: 0 },
                        { id: 'strip', name: 'Strip valuable components first', desc: 'Recover materials before disposal.', cost: 20000, time: 4, dose: 0.5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 4: PIPE CONNECTIONS
        // ==========================================
        pipeConnections: {
            title: 'Pipe Connections',
            stage1: {
                description: 'How should pipe joints be designed?',
                options: [
                    { id: 'welded', name: 'All Welded', desc: 'Continuous welds throughout. No break points.', cost: 100000, quality: 'poor' },
                    { id: 'flanged', name: 'Flanged at Strategic Points', desc: 'Bolted flanges every 6m and at components.', cost: 130000, quality: 'good' },
                    { id: 'excessive', name: 'Flanges Everywhere', desc: 'Flanged every 2m. Maximum flexibility.', cost: 180000, quality: 'wasteful' }
                ]
            },
            stage2: {
                welded: {
                    situation: 'A pipe section needs replacement. The all-welded design from 2025 means there are no break points - must cut and re-weld.',
                    quote: "Need to replace a section of pipe. That all-welded design from 2025 - there's nowhere to unbolt. We have to cut it out and weld in the replacement. Time-consuming and high dose. How do you want to proceed?",
                    options: [
                        { id: 'replace', name: 'Cut, replace, and re-weld', desc: 'Proper repair but significant work.', cost: 65000, time: 8, dose: 5 },
                        { id: 'overlay', name: 'Weld overlay repair', desc: 'Temporary fix. Will need revisiting eventually.', cost: 25000, time: 3, dose: 3, healthImpact: -5, trigger: 'weldOverlay' }
                    ]
                },
                flanged: {
                    situation: 'A pipe section needs replacement. The flanged connections from the 2025 design allow easy section removal.',
                    quote: "Pipe section needs replacing. Good news - those flanged connections from 2025 mean we just unbolt, remove the section, and bolt in the new one. Clean and simple. Standard replacement or should we upgrade the gaskets while we're there?",
                    options: [
                        { id: 'standard', name: 'Standard flange replacement', desc: 'Unbolt, replace section, re-bolt.', cost: 30000, time: 3, dose: 1.5 },
                        { id: 'upgrade', name: 'Replace with upgraded gaskets', desc: 'Better gasket material for longer life.', cost: 40000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: 'Three gasket failures this outage. With flanges every 2m from the 2025 design, there are 47 potential leak paths.',
                    quote: "Third gasket failure this week. That design from 2025 with flanges every 2m - 47 flanges means 47 places to leak. We're chasing gaskets constantly. Do you want to replace all of them preventively or keep playing whack-a-mole?",
                    options: [
                        { id: 'replace', name: 'Replace all gaskets preventively', desc: 'Do them all now. No more surprises this outage.', cost: 45000, time: 5, dose: 2 },
                        { id: 'reactive', name: 'Keep replacing as they fail', desc: 'Fix what breaks. Hope it holds.', cost: 15000, time: 2, dose: 1, healthImpact: -3 }
                    ]
                }
            },
            stage3: {
                welded: {
                    situation: 'All welds require inspection. The all-welded design from 2025 means a large number of weld examinations are needed.',
                    quote: "Inspection programme time. That all-welded design from 2025 - every joint is a weld, every weld needs examining. It's a lot of coverage. Full programme or sample-based approach?",
                    options: [
                        { id: 'full', name: 'Full inspection of all welds', desc: 'Examine every weld in the system.', cost: 50000, time: 7, dose: 4 },
                        { id: 'sample', name: 'Sample 50% of welds', desc: 'Risk-based selection. May miss developing defects.', cost: 25000, time: 4, dose: 2, healthImpact: -5 }
                    ]
                },
                flanged: {
                    situation: 'Limited number of welds to inspect. Flanged joints from 2025 require visual and torque checks.',
                    quote: "Inspection time. That flanged design from 2025 means fewer welds to examine. Just need to UT the welds we have and verify the flange bolt torques. Straightforward. Any extras you want?",
                    options: [
                        { id: 'standard', name: 'Standard inspection programme', desc: 'UT on welds, visual and torque on flanges.', cost: 20000, time: 3, dose: 1.5 },
                        { id: 'torque', name: 'Add detailed bolt torque analysis', desc: 'Extra verification of flange integrity.', cost: 28000, time: 4, dose: 2 }
                    ]
                },
                excessive: {
                    situation: '47 flanged connections to inspect. Many gaskets from 2025 are showing wear after 30 years.',
                    quote: "47 flanges to check from that 2025 design. I'll be verifying bolts and gaskets all week. Some of these gaskets are 30 years old and looking tired. Full coverage or prioritise high-risk locations?",
                    options: [
                        { id: 'all', name: 'Inspect all 47 connections', desc: 'Thorough but time-consuming.', cost: 35000, time: 6, dose: 2.5 },
                        { id: 'sample', name: 'Prioritise high-risk locations', desc: 'Focus on problem areas. May miss issues elsewhere.', cost: 20000, time: 3, dose: 1.5, healthImpact: -3 }
                    ]
                }
            },
            stage4: {
                welded: {
                    situation: 'Online maintenance needed but the all-welded design from 2025 provides no isolation points.',
                    quote: "We need to do some maintenance, but that all-welded design from 2025 - there's nowhere to isolate. Can't do it online. We either wait for the outage or take a partial shutdown. Your call.",
                    options: [
                        { id: 'defer', name: 'Defer to next scheduled outage', desc: 'Wait for full shutdown. Work accumulates.', cost: 10000, time: 0, dose: 0 },
                        { id: 'partial', name: 'Partial shutdown for access', desc: 'Reduce power to create safe work window.', cost: 40000, time: 2, dose: 1 }
                    ]
                },
                flanged: {
                    situation: 'Online maintenance needed. The flanged design from 2025 allows isolation and work at power.',
                    quote: "Valve needs attention. That flanged design from 2025 - we can isolate the section and work while the plant runs. No shutdown needed. Do it now or schedule for the outage?",
                    options: [
                        { id: 'online', name: 'Isolate and work at power', desc: 'Use the flexibility of flanged design.', cost: 15000, time: 1, dose: 0.5 },
                        { id: 'defer', name: 'Defer to outage', desc: 'Not urgent. Can wait.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                excessive: {
                    situation: 'Two more gasket failures during this operating period. The 47-flange design from 2025 continues to cause problems.',
                    quote: "Two more gaskets gone. That 47-flange design from 2025 - we're still fighting it 45 years later. Every flange is an opportunity for a leak. Fix them during a mini-outage or try to manage through?",
                    options: [
                        { id: 'repair', name: 'Short outage to repair leakers', desc: 'Fix the immediate problems.', cost: 30000, time: 3, dose: 1 },
                        { id: 'monitor', name: 'Manage leakage and monitor', desc: 'Live with minor seepage. Not ideal.', cost: 10000, time: 0, dose: 0, healthImpact: -3 }
                    ]
                }
            },
            stage5: {
                welded: {
                    situation: 'Pipe removal for decommissioning. The all-welded design from 2025 means 12 welds to cut. Each cut risks contamination spread.',
                    quote: "Time to take these pipes out. That all-welded design from 2025 means 12 cuts to make. Each one sprays contamination if we're not careful. Slow and steady, or bring in the specialists?",
                    options: [
                        { id: 'careful', name: 'Careful in-house cutting programme', desc: 'Slow and controlled. Higher dose.', cost: 80000, time: 15, dose: 8, risk: 30 },
                        { id: 'specialist', name: 'Specialist cutting contractor', desc: 'Experts with containment equipment.', cost: 180000, time: 10, dose: 3 }
                    ]
                },
                flanged: {
                    situation: 'Pipe removal for decommissioning. The flanged design from 2025 means unbolt and remove in sections.',
                    quote: "Decommissioning the pipework. That flanged design from 2025 is paying off one last time - unbolt the flanges, lift out the sections. No cutting, minimal contamination. Standard removal or segregate for recycling?",
                    options: [
                        { id: 'standard', name: 'Standard flange disassembly', desc: 'Unbolt and remove. Clean and simple.', cost: 40000, time: 6, dose: 2 },
                        { id: 'segregate', name: 'Segregate materials for recycling', desc: 'Extra effort to separate materials.', cost: 55000, time: 8, dose: 2.5 }
                    ]
                },
                excessive: {
                    situation: '47 flange connections to disconnect. Many contaminated gaskets to dispose of as waste.',
                    quote: "47 flanges from that 2025 design - at least they unbolt easily. But every one of those gaskets is contaminated waste now. Lots of small waste packages. Deal with it systematically or cut corners?",
                    options: [
                        { id: 'full', name: 'Full systematic disassembly', desc: 'All 47 connections done properly.', cost: 55000, time: 10, dose: 3 },
                        { id: 'bulk', name: 'Cut into larger sections instead', desc: 'Fewer disconnections but larger packages.', cost: 45000, time: 8, dose: 2.5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 5: PIPE ROUTING
        // ==========================================
        pipeRouting: {
            title: 'Pipe Routing',
            stage1: {
                description: 'How should pipes run through concrete structure?',
                options: [
                    { id: 'embedded', name: 'Embedded in Concrete', desc: 'Cast directly into structural concrete.', cost: 90000, quality: 'poor' },
                    { id: 'ducted', name: 'Accessible Ducts', desc: 'Removable duct covers for access.', cost: 130000, quality: 'good' },
                    { id: 'tunnel', name: 'Walk-In Tunnel', desc: 'Large accessible service tunnel.', cost: 220000, quality: 'wasteful' }
                ]
            },
            stage2: {
                embedded: {
                    situation: 'Suspected leak somewhere in an embedded pipe section. The pipes are cast into concrete from the 2025 design - cannot visually confirm location.',
                    quote: "We've got activity readings suggesting a leak, but those embedded pipes from 2025 - they're buried in the concrete. I can't see where it's coming from. We either dig until we find it, route around it, or hope it stabilises. Your call.",
                    options: [
                        { id: 'excavate', name: 'Excavate concrete to find leak', desc: 'Dig until we locate the source.', cost: 70000, time: 12, dose: 4 },
                        { id: 'bypass', name: 'Install bypass line around section', desc: 'Route around the problem entirely.', cost: 90000, time: 8, dose: 2 },
                        { id: 'defer', name: 'Increase monitoring and defer', desc: 'Hope it stabilises. Monitor closely.', cost: 10000, time: 0, dose: 0, healthImpact: -10, trigger: 'embeddedLeak' }
                    ]
                },
                ducted: {
                    situation: 'Minor leak detected at a pipe joint. The accessible ducts from the 2025 design allow easy location and access.',
                    quote: "Found a small leak - pulled off the duct cover from that 2025 design and there it is, plain as day. Easy to see, easy to fix. Standard repair or should I check the neighbouring joints while I'm here?",
                    options: [
                        { id: 'repair', name: 'Standard repair', desc: 'Fix the leaking joint.', cost: 15000, time: 2, dose: 1 },
                        { id: 'inspect', name: 'Repair and inspect neighbours', desc: 'Check adjacent joints while access is open.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Leak repaired easily with walk-in access. However, the tunnel surfaces from 2025 are showing contamination migration.',
                    quote: "Easy access through the tunnel to fix the leak - that 2025 design makes repairs simple. But the tunnel walls themselves are picking up contamination. We should deal with that while we're here. Clean it or seal it?",
                    options: [
                        { id: 'repair', name: 'Repair and decontaminate tunnel', desc: 'Fix leak and clean surfaces.', cost: 35000, time: 4, dose: 2 },
                        { id: 'seal', name: 'Repair and seal contamination', desc: 'Contain it for now. Defer full decon.', cost: 25000, time: 3, dose: 1.5, healthImpact: -3 }
                    ]
                }
            },
            stage3: {
                embedded: {
                    situation: 'In-Service Inspection required. The embedded pipes from 2025 cannot be examined by conventional ultrasonic or visual methods.',
                    quote: "How do I inspect pipes that are buried in concrete from 2025? The short answer is: I can't. Not with conventional methods. We can document the limitation, try guided wave technology, or excavate samples. What's the approach?",
                    options: [
                        { id: 'accept', name: 'Document inspection gap', desc: 'Accept and document the limitation.', cost: 5000, time: 1, dose: 0, healthImpact: -10, trigger: 'embeddedInspectionGap' },
                        { id: 'guided', name: 'Install guided wave monitoring', desc: 'Some detection capability through concrete.', cost: 60000, time: 5, dose: 1 },
                        { id: 'excavate', name: 'Excavate sample locations', desc: 'Physically expose sections for examination.', cost: 100000, time: 14, dose: 5 }
                    ]
                },
                ducted: {
                    situation: 'Full pipe inspection via removable duct covers from the 2025 design. Complete access available.',
                    quote: "Inspection time. Those duct covers from 2025 - lift them off and I've got full access to every inch of pipe. Complete coverage, no limitations. Standard inspection or add coating condition assessment?",
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Full visual and UT coverage.', cost: 15000, time: 3, dose: 1.5 },
                        { id: 'coating', name: 'Include coating condition assessment', desc: 'Check protective coating integrity.', cost: 22000, time: 4, dose: 2 }
                    ]
                },
                tunnel: {
                    situation: 'Pipe inspection in the walk-in tunnel. Good access but the tunnel from 2025 is now contaminated, requiring full PPE.',
                    quote: "Easy pipe access through the tunnel, but 30 years of operation means it's contaminated now. Full suits required just to get in there. That 2025 tunnel design - easy access comes with dose penalty. Full inspection or remote camera?",
                    options: [
                        { id: 'suited', name: 'Full hands-on inspection in PPE', desc: 'Complete coverage but slower in suits.', cost: 25000, time: 5, dose: 3 },
                        { id: 'remote', name: 'Remote camera inspection', desc: 'Limited contact but lower dose.', cost: 30000, time: 4, dose: 1, healthImpact: -2 }
                    ]
                }
            },
            stage4: {
                embedded: {
                    checkTrigger: 'embeddedLeak',
                    triggered: {
                        situation: 'Groundwater monitoring detects radioactive contamination. The source is the embedded pipe leak that was deferred in 2040.',
                        quote: "Remember that leak we couldn't find in 2040? The one in the embedded pipes from 2025 that we decided to monitor? It's been leaking into the groundwater for 30 years. Environmental regulator is involved. This is serious.",
                        additionalCosts: { regulatory: 50000, environmental: 100000, healthImpact: -15 },
                        options: [
                            { id: 'excavate', name: 'Emergency excavation and repair', desc: 'Dig out the embedded section and fix it.', cost: 200000, time: 21, dose: 8 },
                            { id: 'treat', name: 'Groundwater treatment and isolation', desc: 'Treat the water, abandon the pipe section.', cost: 150000, time: 7, dose: 2 }
                        ]
                    },
                    notTriggered: {
                        situation: 'Monitoring of embedded pipe sections continues. No activity detected in groundwater so far.',
                        quote: "Still monitoring those embedded pipes from 2025. Groundwater sampling shows nothing... yet. But we're flying blind on actual pipe condition. Continue monitoring or enhance detection capability?",
                        options: [
                            { id: 'maintain', name: 'Continue current monitoring', desc: 'Keep watching the groundwater.', cost: 15000, time: 0, dose: 0 },
                            { id: 'enhance', name: 'Enhanced monitoring network', desc: 'More sampling points, faster detection.', cost: 30000, time: 1, dose: 0 }
                        ]
                    }
                },
                ducted: {
                    situation: 'Quick operational checks through duct access. The 2025 design continues to provide excellent accessibility.',
                    quote: "Running operational checks. That ducted design from 2025 - I can pop the covers and do a visual check in minutes. Want the standard check or add thermal imaging for early leak detection?",
                    options: [
                        { id: 'visual', name: 'Routine visual inspection', desc: 'Quick visual through duct covers.', cost: 5000, time: 0, dose: 0 },
                        { id: 'thermal', name: 'Add thermal imaging survey', desc: 'Infrared check for developing leaks.', cost: 15000, time: 1, dose: 0 }
                    ]
                },
                tunnel: {
                    situation: 'Tunnel access maintained. Contamination levels stable but requiring ongoing control.',
                    quote: "Tunnel from 2025 - still accessible, still contaminated. We're maintaining the contamination controls but it's an ongoing burden. Status quo or invest in reducing the source term?",
                    options: [
                        { id: 'maintain', name: 'Continue routine monitoring', desc: 'Maintain current controls.', cost: 10000, time: 0, dose: 0.5 },
                        { id: 'decon', name: 'Partial decontamination campaign', desc: 'Reduce hotspots in the tunnel.', cost: 35000, time: 3, dose: 2 }
                    ]
                }
            },
            stage5: {
                embedded: {
                    situation: 'Pipes cast into concrete from 2025 require major excavation. Contamination has migrated into the concrete matrix itself.',
                    quote: "The embedded pipes from 2025 - now the contamination has soaked into the surrounding concrete over 60 years. We're not just removing pipes, we're removing contaminated structural concrete. Huge job. In-house or specialists?",
                    options: [
                        { id: 'excavate', name: 'Full in-house excavation', desc: 'Our teams break out all the concrete.', cost: 350000, time: 40, dose: 20 },
                        { id: 'specialist', name: 'Specialist demolition contractor', desc: 'Controlled demolition with contamination management.', cost: 400000, time: 25, dose: 8 }
                    ]
                },
                ducted: {
                    situation: 'Pipe removal via duct access. The ducts from 2025 remain uncontaminated and can be demolished as clean concrete.',
                    quote: "Best news I've had all project. Those duct covers from 2025 - lift them off, pull out the pipes, and the duct structures themselves are clean concrete. Standard demolition for the ducts. Want to assess if they could be kept for other use?",
                    options: [
                        { id: 'standard', name: 'Standard pipe and duct removal', desc: 'Remove pipes, demolish clean ducts.', cost: 50000, time: 8, dose: 2 },
                        { id: 'reuse', name: 'Assess duct structures for reuse', desc: 'Check if ducts can serve future purpose.', cost: 40000, time: 6, dose: 1.5 }
                    ]
                },
                tunnel: {
                    situation: 'Pipes removed easily, but the tunnel from 2025 is contaminated infrastructure requiring disposal as intermediate level waste.',
                    quote: "Pipes came out clean - the tunnel gave us easy access right to the end. But the tunnel itself? 60 years of contamination buildup. It's ILW now. Large volume, complex disposal. Full decon or grout and entomb?",
                    options: [
                        { id: 'full', name: 'Full tunnel decommissioning', desc: 'Decontaminate and demolish.', cost: 220000, time: 25, dose: 8 },
                        { id: 'fill', name: 'Grout fill and entombment', desc: 'Seal in place with grout.', cost: 150000, time: 15, dose: 4, healthImpact: -5 }
                    ]
                }
            }
        },
        
        // ==========================================
        // ELEMENT 6: MATERIAL SPEC
        // ==========================================
        materialSpec: {
            title: 'Material Specification',
            stage1: {
                description: 'What material for primary circuit pipework?',
                options: [
                    { id: 'standard', name: 'Standard Stainless Steel', desc: '304/316 with ~2,500ppm cobalt. Industry standard.', cost: 110000, quality: 'poor' },
                    { id: 'lowCobalt', name: 'Low-Cobalt Stainless', desc: 'Cobalt <500ppm. Reduced activation.', cost: 170000, quality: 'good' },
                    { id: 'exotic', name: 'Exotic Nickel Alloy', desc: 'Premium aerospace-grade alloy. Top specification.', cost: 250000, quality: 'poor' }
                ]
            },
            stage2: {
                standard: {
                    situation: 'Dose rates around the primary circuit are higher than predicted. The standard stainless steel from 2025 contains ~2,500ppm cobalt, which is activating under neutron flux.',
                    quote: "Dose rates are running hot. That standard stainless from 2025 - 2,500ppm cobalt content. It's activating and making every maintenance job take longer because of ALARP controls. How do you want to approach this outage?",
                    isModifier: true,
                    options: [
                        { id: 'accept', name: 'Accept higher dose rates', desc: 'Work with what we have. Jobs take longer.', cost: 0, time: 2, dose: 3 },
                        { id: 'shield', name: 'Install temporary shielding', desc: 'Reduce dose exposure for this outage.', cost: 25000, time: 3, dose: 1.5 }
                    ]
                },
                lowCobalt: {
                    situation: 'Dose rates as predicted in the design basis. The low-cobalt stainless from 2025 is performing as expected with minimal activation.',
                    quote: "Dose rates exactly where we predicted. That low-cobalt steel from 2025 - worth every penny. Work areas are clean, jobs go smoothly. Just confirming the maintenance approach.",
                    options: [
                        { id: 'standard', name: 'Standard maintenance procedures', desc: 'Normal approach - no special measures needed.', cost: 0, time: 0, dose: 0.5 },
                        { id: 'optimise', name: 'Optimise future dose budgets', desc: 'Bank the dose savings for contingencies.', cost: 5000, time: 0, dose: 0.5 }
                    ]
                },
                exotic: {
                    situation: 'Dose rates significantly higher than predicted. The exotic nickel alloy from 2025 contains Nickel-59 which is creating unexpected activation products.',
                    quote: "Big problem. That exotic alloy from 2025 - it looked great on paper, but the nickel content is activating badly. Dose rates are twice what we planned for. Every job is a challenge. What's the strategy?",
                    isModifier: true,
                    options: [
                        { id: 'accept', name: 'Accept enhanced dose controls', desc: 'More restrictions, slower work, higher doses.', cost: 0, time: 4, dose: 5 },
                        { id: 'remote', name: 'Invest in remote tooling', desc: 'Reduce direct worker exposure.', cost: 40000, time: 5, dose: 3 }
                    ]
                }
            },
            stage3: {
                standard: {
                    situation: 'Elevated dose rates require stand-off inspection techniques. The activated standard steel from 2025 limits close-approach work.',
                    quote: "Inspection time, but that standard steel from 2025 is running hot. I need to keep my distance, which limits probe positioning. Extended reach equipment or accept the limitations?",
                    isModifier: true,
                    options: [
                        { id: 'standoff', name: 'Extended reach inspection', desc: 'Longer probe extensions, some accuracy loss.', cost: 15000, time: 3, dose: 4 },
                        { id: 'shielded', name: 'Invest in shielded inspection equipment', desc: 'Better equipment for close-approach work.', cost: 35000, time: 4, dose: 2 }
                    ]
                },
                lowCobalt: {
                    situation: 'Manageable dose rates allow standard inspection approaches. The low-cobalt specification from 2025 continues to pay dividends.',
                    quote: "Inspection programme running smoothly. That low-cobalt steel from 2025 - dose rates are low enough for normal close-approach work. No special equipment needed. Standard or enhanced baseline?",
                    options: [
                        { id: 'standard', name: 'Standard inspection', desc: 'Normal techniques, full coverage.', cost: 10000, time: 2, dose: 1 },
                        { id: 'baseline', name: 'Establish detailed baseline', desc: 'Extra measurements for future reference.', cost: 18000, time: 3, dose: 1.5 }
                    ]
                },
                exotic: {
                    situation: 'Very high dose rates make inspection extremely challenging. The exotic alloy from 2025 requires specialist contractors with high-dose experience.',
                    quote: "That exotic alloy from 2025 - it's so hot now our regular teams can't get near it safely. We need specialists who handle high-dose work. Or we accept limited inspection coverage.",
                    isModifier: true,
                    options: [
                        { id: 'specialist', name: 'Hire specialist high-dose contractor', desc: 'Experts with special shielding and experience.', cost: 50000, time: 5, dose: 3 },
                        { id: 'limited', name: 'Accept limited inspection coverage', desc: 'Do what we can safely. Document gaps.', cost: 20000, time: 3, dose: 4, healthImpact: -5 }
                    ]
                }
            },
            stage4: {
                standard: {
                    situation: 'Cumulative workforce dose approaching annual limits. The activated standard steel from 2025 constrains operational flexibility.',
                    quote: "We're running into dose limit problems. That standard steel from 2025 - 45 years of activation means we're burning through dose budget fast. Need to bring in more workers or slow down.",
                    options: [
                        { id: 'contractors', name: 'Bring in additional contractors', desc: 'More workers to share the dose burden.', cost: 80000, time: 0, dose: 0 },
                        { id: 'shielding', name: 'Install permanent shielding', desc: 'Long-term dose reduction investment.', cost: 50000, time: 5, dose: 0 },
                        { id: 'slow', name: 'Accept schedule extension', desc: 'Work slower to spread dose over time.', cost: 20000, time: 10, dose: 0 }
                    ]
                },
                lowCobalt: {
                    situation: 'Dose rates remain low. Full operational flexibility maintained thanks to the low-cobalt specification from 2025.',
                    quote: "Dose budgets looking healthy. That low-cobalt decision in 2025 gives us complete flexibility - no constraints on work planning, no limit problems. How do you want to manage the surplus?",
                    options: [
                        { id: 'maintain', name: 'Standard operations', desc: 'Continue normal working.', cost: 5000, time: 0, dose: 0.5 },
                        { id: 'bank', name: 'Bank dose margin for contingencies', desc: 'Reserve capacity for unexpected work.', cost: 5000, time: 0, dose: 0 }
                    ]
                },
                exotic: {
                    situation: 'Severe dose constraints limit work. The exotic alloy from 2025 has created extreme activation levels after 45 years.',
                    quote: "We can barely get near the primary circuit. That exotic alloy from 2025 - after 45 years of activation, work windows are measured in minutes. Major operational constraints. How do we manage this?",
                    options: [
                        { id: 'contractors', name: 'Rotating contractor teams', desc: 'Many workers, very short exposures each.', cost: 120000, time: 5, dose: 0 },
                        { id: 'remote', name: 'Remote operations only', desc: 'No direct human access to affected areas.', cost: 80000, time: 8, dose: 0 },
                        { id: 'restrict', name: 'Severely restrict operations', desc: 'Accept major operational limitations.', cost: 30000, time: 0, dose: 0, healthImpact: -10 }
                    ]
                }
            },
            stage5: {
                standard: {
                    situation: 'After the 5-year decay period, components with standard steel remain highly active. Remote handling required for most work.',
                    quote: "Five years of decay storage and that standard steel from 2025 is still too hot for hands-on work. 2,500ppm cobalt means decades more before it cools. Remote handling for everything. In-house or specialist?",
                    options: [
                        { id: 'remote', name: 'In-house remote handling', desc: 'Our teams with manipulators. Learning curve.', cost: 120000, time: 18, dose: 6, risk: 30 },
                        { id: 'specialist', name: 'Specialist remote handling contractor', desc: 'Experienced operators, proven techniques.', cost: 200000, time: 12, dose: 2 }
                    ]
                },
                lowCobalt: {
                    situation: 'After 5-year decay, the low-cobalt materials from 2025 allow hands-on work with standard PPE. Some components may qualify as LLW.',
                    quote: "Five years decay and that low-cobalt steel from 2025 is cool enough for hands-on work. Some of it might even go as low-level waste instead of ILW. This is exactly what we hoped for.",
                    options: [
                        { id: 'handson', name: 'Hands-on removal and segregation', desc: 'Direct handling with standard PPE.', cost: 60000, time: 8, dose: 2 },
                        { id: 'segregate', name: 'Detailed segregation for waste minimisation', desc: 'Maximum effort to classify materials correctly.', cost: 80000, time: 10, dose: 2.5 }
                    ]
                },
                exotic: {
                    situation: 'The exotic nickel alloy from 2025 contains Nickel-63 with a 100-year half-life. These components will remain highly active for centuries.',
                    quote: "That exotic alloy from 2025 - Nickel-63 has a hundred-year half-life. Five years of decay makes no difference. This stuff will be active long after everyone here is dead. Long-term storage or extreme remote handling?",
                    options: [
                        { id: 'extended', name: 'Extended remote decommissioning', desc: 'Very slow, very careful, very expensive.', cost: 250000, time: 30, dose: 15 },
                        { id: 'storage', name: 'Long-term interim storage', desc: 'Store for decades. Wait for decay. Pass to future.', cost: 200000, time: 10, dose: 3 },
                        { id: 'specialist', name: 'Specialist handling plus storage', desc: 'Expert removal then long-term storage.', cost: 300000, time: 20, dose: 5 }
                    ]
                }
            }
        }
    }
};

// ============================================
// GAME STATE
// ============================================
const STATE = {
    stage: 1,
    designChoices: {},     // Stage 1 choices
    stageChoices: {},      // Choices per stage per element
    completed: {},         // Elements completed per stage
    triggers: {},          // Active triggers
    flags: {},             // Boolean flags
    totals: { cost: 0, dose: 0, time: 0 },
    stageTotals: {},
    plantHealth: 100,
    injuries: 0
};

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatMoney(n) { return '¬£' + n.toLocaleString(); }

function getRemainingBudget() {
    // Only used for Stage 1
    const stage = GAME_DATA.stages[STATE.stage];
    return stage.budget - STATE.totals.cost;
}

// ============================================
// INTRO
// ============================================
let currentSlide = 1;
const totalSlides = 4;

function updateIntroSlide() {
    document.querySelectorAll('.intro-slide').forEach(s => s.classList.remove('active'));
    document.querySelector(`.intro-slide[data-slide="${currentSlide}"]`).classList.add('active');
    document.querySelectorAll('.intro-dot').forEach((d, i) => {
        d.classList.remove('active', 'done');
        if (i + 1 === currentSlide) d.classList.add('active');
        else if (i + 1 < currentSlide) d.classList.add('done');
    });
    document.getElementById('btnIntroNext').textContent = currentSlide === totalSlides ? 'Begin ‚Üí' : 'Continue ‚Üí';
}

document.getElementById('btnIntroNext').onclick = () => {
    if (currentSlide < totalSlides) { currentSlide++; updateIntroSlide(); }
    else endIntro();
};
document.getElementById('btnSkip').onclick = endIntro;
document.querySelectorAll('.intro-dot').forEach(d => {
    d.onclick = () => { currentSlide = parseInt(d.dataset.dot); updateIntroSlide(); };
});

function endIntro() {
    document.getElementById('cinematicIntro').classList.add('hidden');
    document.getElementById('gameScreen').classList.add('active');
    startStage(1);
}

// ============================================
// STAGE MANAGEMENT
// ============================================
function startStage(stageNum) {
    STATE.stage = stageNum;
    STATE.completed[stageNum] = {};
    STATE.stageTotals[stageNum] = { cost: 0, dose: 0, time: 0 };
    
    const stage = GAME_DATA.stages[stageNum];
    
    // Update timeline
    updateTimeline(stageNum);
    
    updateStatsDisplay();
    
    // Character banner
    const banner = document.getElementById('characterBanner');
    if (stageNum > 1 && stage.char) {
        const char = GAME_DATA.characters[stage.char];
        banner.className = `character-banner visible ${stage.char}`;
        document.getElementById('charPortrait').textContent = char.emoji;
        document.getElementById('charName').textContent = char.name;
        document.getElementById('charRole').textContent = char.role;
    } else {
        banner.classList.remove('visible');
    }
    
    // Reset hotspots
    document.querySelectorAll('.hotspot-dot').forEach(d => {
        d.classList.remove('done');
    });
    
    document.getElementById('btnNextStage').classList.remove('visible');
    
    updateProgressLabel();
}

function updateTimeline(currentStage) {
    document.querySelectorAll('.timeline-stage').forEach(stage => {
        const stageNum = parseInt(stage.dataset.stage);
        stage.classList.remove('completed', 'current', 'future');
        
        if (stageNum < currentStage) {
            stage.classList.add('completed');
        } else if (stageNum === currentStage) {
            stage.classList.add('current');
        } else {
            stage.classList.add('future');
        }
    });
    
    // Update progress bar (0% at stage 1, 100% at stage 5)
    const progressPercent = ((currentStage - 1) / 4) * 100;
    document.getElementById('timelineProgress').style.width = `${progressPercent}%`;
}

function updateStatsDisplay() {
    const stage = GAME_DATA.stages[STATE.stage];
    const remaining = getRemainingBudget();
    let html = '';
    
    if (STATE.stage === 1) {
        // Stage 1: Show remaining design budget
        const cls = remaining < 100000 ? (remaining < 0 ? 'danger' : 'warning') : '';
        html = `<div class="stat">üí∞ Design Budget: <span class="stat-value ${cls}">${formatMoney(remaining)}</span></div>`;
    } else {
        // Stages 2-5: Show accumulated costs
        const st = STATE.stageTotals[STATE.stage] || { cost: 0, dose: 0, time: 0 };
        html = `
            <div class="stat">üí∞ Cost: <span class="stat-value" style="color: var(--blue);">${formatMoney(st.cost)}</span></div>
            <div class="stat">‚ò¢Ô∏è <span class="stat-value">${st.dose.toFixed(1)} mSv</span></div>
            <div class="stat">‚è±Ô∏è <span class="stat-value">${st.time} days</span></div>
            <div class="stat">‚ù§Ô∏è <span class="stat-value ${STATE.plantHealth < 60 ? 'danger' : ''}">${STATE.plantHealth}%</span></div>
        `;
    }
    document.getElementById('topStats').innerHTML = html;
}

function updateProgressLabel() {
    const done = Object.keys(STATE.completed[STATE.stage] || {}).length;
    document.getElementById('progressLabel').textContent = `${done} of 6 complete`;
    if (done === 6) {
        document.getElementById('btnNextStage').classList.add('visible');
    }
}

// ============================================
// HOTSPOT CLICKS
// ============================================
document.querySelectorAll('.hotspot').forEach(h => {
    h.onclick = () => {
        const elId = h.dataset.element;
        
        // In Stage 1, can always click (to change decision)
        // In Stages 2-5, can only click if not completed (decisions are final)
        if (STATE.stage > 1 && STATE.completed[STATE.stage]?.[elId]) {
            return; // Decision already made, can't change
        }
        
        openElementModal(elId);
    };
});

// ============================================
// MODAL SYSTEM
// ============================================
function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

document.getElementById('modalClose').onclick = closeModal;
document.getElementById('modalOverlay').onclick = (e) => {
    if (e.target.id === 'modalOverlay') closeModal();
};

function openElementModal(elId) {
    const element = GAME_DATA.elements[elId];
    document.getElementById('modalTitle').textContent = element.title;
    
    if (STATE.stage === 1) {
        renderDesignModal(elId, element);
    } else {
        renderDecisionModal(elId, element);
    }
    
    openModal();
}

// ============================================
// STAGE 1: DESIGN
// ============================================
function renderDesignModal(elId, element) {
    const data = element.stage1;
    const remaining = getRemainingBudget();
    
    // Calculate what we'd have if we refund current choice
    let availableBudget = remaining;
    if (STATE.designChoices[elId]) {
        const currentChoice = data.options.find(o => o.id === STATE.designChoices[elId]);
        availableBudget += currentChoice.cost;
    }
    
    let html = `<div class="situation-box"><p>${data.description}</p></div>`;
    html += `<div style="margin-bottom: 15px; padding: 10px; background: var(--deep-navy); border-radius: 6px; display: flex; justify-content: space-between;">
        <span>Remaining Design Budget:</span>
        <span class="stat-value ${availableBudget < 150000 ? 'warning' : ''}">${formatMoney(availableBudget)}</span>
    </div>`;
    html += '<div class="options-list">';
    
    data.options.forEach(opt => {
        const sel = STATE.designChoices[elId] === opt.id ? 'selected' : '';
        const affordable = opt.cost <= availableBudget;
        const disabledClass = affordable ? '' : 'disabled';
        
        html += `
            <div class="option-card ${sel} ${disabledClass}" data-id="${opt.id}" data-cost="${opt.cost}">
                <div class="choice-image">[Image: ${opt.name}]</div>
                <div class="option-header">
                    <span class="option-name">${opt.name}</span>
                    <span class="option-cost">${formatMoney(opt.cost)}</span>
                </div>
                <p class="option-desc">${opt.desc}</p>
                ${!affordable ? '<div class="disabled-reason">‚ö†Ô∏è Insufficient budget</div>' : ''}
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = STATE.designChoices[elId] || null;
    document.querySelectorAll('.option-card:not(.disabled)').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    const hasExistingChoice = !!STATE.designChoices[elId];
    document.getElementById('modalFooter').innerHTML = `<button class="btn btn-primary" id="btnConfirm">${hasExistingChoice ? 'Update Selection' : 'Confirm Selection'}</button>`;
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        
        const opt = data.options.find(o => o.id === selected);
        
        // Refund old if changing
        if (STATE.designChoices[elId]) {
            const old = data.options.find(o => o.id === STATE.designChoices[elId]);
            STATE.totals.cost -= old.cost;
        }
        
        STATE.designChoices[elId] = selected;
        STATE.completed[1][elId] = true;
        STATE.totals.cost += opt.cost;
        
        document.querySelector(`[data-element="${elId}"] .hotspot-dot`).classList.add('done');
        
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}

// ============================================
// STAGES 2-5: DECISIONS (No budget, decisions are final)
// ============================================
function renderDecisionModal(elId, element) {
    const stageKey = `stage${STATE.stage}`;
    const designChoice = STATE.designChoices[elId];
    const designOpt = element.stage1.options.find(o => o.id === designChoice);
    
    let stageData = element[stageKey]?.[designChoice];
    
    if (!stageData) {
        document.getElementById('modalBody').innerHTML = '<p>No data for this element.</p>';
        document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" onclick="closeModal()">Close</button>';
        return;
    }
    
    // Handle conditional (trigger-based or flag-based)
    if (stageData.checkTrigger) {
        stageData = STATE.triggers[stageData.checkTrigger] ? stageData.triggered : stageData.notTriggered;
    } else if (stageData.checkFlag) {
        stageData = STATE.flags[stageData.checkFlag] ? stageData.hasFlag : stageData.noFlag;
    }
    
    const char = GAME_DATA.characters[GAME_DATA.stages[STATE.stage].char];
    const stageCost = STATE.stageTotals[STATE.stage]?.cost || 0;
    
    let html = '';
    
    // Design recall - just show what they chose, no judgment
    html += `
        <div class="design-recall">
            <strong>2025 Design:</strong> ${designOpt.name}
        </div>
    `;
    
    // Show accumulated stage cost (not budget remaining)
    html += `<div style="margin-bottom: 15px; padding: 10px; background: var(--deep-navy); border-radius: 6px; display: flex; justify-content: space-between;">
        <span>Stage Cost So Far:</span>
        <span class="stat-value" style="color: var(--blue);">${formatMoney(stageCost)}</span>
    </div>`;
    
    // Situation box - neutral styling, let content speak for itself
    html += `<div class="situation-box"><p>${stageData.situation}</p></div>`;
    
    // Character quote
    html += `
        <div class="char-quote">
            <div class="char-portrait">${char.emoji}</div>
            <div>
                <div class="char-quote-name">${char.name}</div>
                <p class="char-quote-text">"${stageData.quote}"</p>
            </div>
        </div>
    `;
    
    // Options - all available, no budget restrictions
    html += '<div class="options-list">';
    stageData.options.forEach(opt => {
        const cost = opt.cost || 0;
        
        html += `
            <div class="option-card" data-id="${opt.id}">
                <div class="option-header">
                    <span class="option-name">${opt.name}</span>
                    <span class="option-cost">${formatMoney(cost)}</span>
                </div>
                <p class="option-desc">${opt.desc}</p>
                <div class="option-impacts">
                    ${opt.time ? `<span class="impact negative">‚è±Ô∏è +${opt.time} days</span>` : ''}
                    ${opt.dose ? `<span class="impact negative">‚ò¢Ô∏è +${opt.dose} mSv</span>` : ''}
                    ${opt.healthImpact ? `<span class="impact ${opt.healthImpact > 0 ? 'positive' : 'negative'}">‚ù§Ô∏è ${opt.healthImpact > 0 ? '+' : ''}${opt.healthImpact}%</span>` : ''}
                    ${opt.risk ? `<span class="impact neutral">‚ö†Ô∏è ${opt.risk}% failure risk</span>` : ''}
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('modalBody').innerHTML = html;
    
    let selected = null;
    document.querySelectorAll('.option-card').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selected = card.dataset.id;
        };
    });
    
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-primary" id="btnConfirm" disabled>Select an Option</button>';
    
    const observer = new MutationObserver(() => {
        const hasSelection = document.querySelector('.option-card.selected');
        const btn = document.getElementById('btnConfirm');
        if (btn) {
            btn.disabled = !hasSelection;
            btn.textContent = hasSelection ? 'Confirm Decision' : 'Select an Option';
        }
    });
    observer.observe(document.getElementById('modalBody'), { subtree: true, attributes: true, attributeFilter: ['class'] });
    
    document.getElementById('btnConfirm').onclick = () => {
        if (!selected) return;
        
        const opt = stageData.options.find(o => o.id === selected);
        
        // Handle risk
        if (opt.risk && Math.random() * 100 < opt.risk) {
            showFailure(elId, opt, stageData);
            return;
        }
        
        applyDecision(elId, opt, stageData, null);
    };
}

function showFailure(elId, opt, stageData) {
    let html = `
        <div class="situation-box danger">
            <p><strong>Attempt Failed!</strong></p>
            <p>The risky approach didn't work. Consequences apply.</p>
        </div>
    `;
    
    const extraCost = opt.cost || 0;
    const extraDose = (opt.dose || 0) + 2;
    const extraTime = (opt.time || 0) + 5;
    
    html += `
        <div class="option-impacts" style="justify-content: center; padding: 20px;">
            <span class="impact negative">üí∞ ${formatMoney(extraCost + 50000)}</span>
            <span class="impact negative">‚è±Ô∏è +${extraTime} days</span>
            <span class="impact negative">‚ò¢Ô∏è +${extraDose} mSv</span>
            <span class="impact negative">‚ù§Ô∏è -10%</span>
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('modalFooter').innerHTML = '<button class="btn btn-danger" id="btnConfirm">Accept Consequences</button>';
    
    document.getElementById('btnConfirm').onclick = () => {
        // Apply failure
        STATE.stageTotals[STATE.stage].cost += extraCost + 50000;
        STATE.stageTotals[STATE.stage].dose += extraDose;
        STATE.stageTotals[STATE.stage].time += extraTime;
        STATE.totals.cost += extraCost + 50000;
        STATE.totals.dose += extraDose;
        STATE.totals.time += extraTime;
        STATE.plantHealth = Math.max(0, STATE.plantHealth - 10);
        
        STATE.completed[STATE.stage][elId] = true;
        document.querySelector(`[data-element="${elId}"] .hotspot-dot`).classList.add('issue');
        
        updateStatsDisplay();
        updateProgressLabel();
        closeModal();
    };
}

function applyDecision(elId, opt, stageData, previousChoice = null) {
    const cost = opt.cost || 0;
    const dose = opt.dose || 0;
    const time = opt.time || 0;
    const healthImpact = opt.healthImpact || 0;
    
    // Additional costs from triggered scenarios (e.g., environmental cleanup)
    if (stageData.additionalCosts) {
        STATE.stageTotals[STATE.stage].cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        STATE.totals.cost += (stageData.additionalCosts.regulatory || 0) + (stageData.additionalCosts.environmental || 0);
        if (stageData.additionalCosts.healthImpact) {
            STATE.plantHealth = Math.max(0, STATE.plantHealth + stageData.additionalCosts.healthImpact);
        }
    }
    
    STATE.stageTotals[STATE.stage].cost += cost;
    STATE.stageTotals[STATE.stage].dose += dose;
    STATE.stageTotals[STATE.stage].time += time;
    STATE.totals.cost += cost;
    STATE.totals.dose += dose;
    STATE.totals.time += time;
    
    if (healthImpact) {
        STATE.plantHealth = Math.max(0, Math.min(100, STATE.plantHealth + healthImpact));
    }
    
    if (opt.trigger) STATE.triggers[opt.trigger] = true;
    if (opt.setFlag) STATE.flags[opt.setFlag] = true;
    
    STATE.completed[STATE.stage][elId] = true;
    STATE.stageChoices[`${STATE.stage}_${elId}`] = opt.id;
    
    // Mark hotspot as done
    const dot = document.querySelector(`[data-element="${elId}"] .hotspot-dot`);
    dot.classList.add('done');
    
    updateStatsDisplay();
    updateProgressLabel();
    closeModal();
}

// ============================================
// STAGE COMPLETION
// ============================================
document.getElementById('btnNextStage').onclick = showStageSummary;

function showStageSummary() {
    const stage = GAME_DATA.stages[STATE.stage];
    const st = STATE.stageTotals[STATE.stage];
    
    document.getElementById('sumTitle').textContent = `${stage.name} Complete`;
    document.getElementById('sumSubtitle').textContent = `Year ${stage.year}`;
    
    let statsHtml = '';
    if (STATE.stage === 1) {
        const spent = STATE.totals.cost;
        const over = spent > stage.budget;
        const remaining = stage.budget - spent;
        statsHtml = `
            <div class="summary-stat"><div class="summary-stat-icon">üí∞</div><div class="summary-stat-value">${formatMoney(spent)}</div><div class="summary-stat-label">Design Spent</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">üìä</div><div class="summary-stat-value">${formatMoney(stage.budget)}</div><div class="summary-stat-label">Design Budget</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">${over ? '‚ö†Ô∏è' : '‚úì'}</div><div class="summary-stat-value ${over ? 'over' : ''}">${formatMoney(Math.abs(remaining))}</div><div class="summary-stat-label">${over ? 'Over Budget' : 'Under Budget'}</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ù§Ô∏è</div><div class="summary-stat-value">${STATE.plantHealth}%</div><div class="summary-stat-label">Health</div></div>
        `;
    } else {
        // Stages 2-5: Just show what was spent, no budget comparison
        statsHtml = `
            <div class="summary-stat"><div class="summary-stat-icon">üí∞</div><div class="summary-stat-value">${formatMoney(st.cost)}</div><div class="summary-stat-label">Stage Cost</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ò¢Ô∏è</div><div class="summary-stat-value">${st.dose.toFixed(1)} mSv</div><div class="summary-stat-label">Dose</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚è±Ô∏è</div><div class="summary-stat-value">${st.time} days</div><div class="summary-stat-label">Time</div></div>
            <div class="summary-stat"><div class="summary-stat-icon">‚ù§Ô∏è</div><div class="summary-stat-value">${STATE.plantHealth}%</div><div class="summary-stat-label">Health</div></div>
        `;
    }
    document.getElementById('sumStats').innerHTML = statsHtml;
    
    // Decisions summary - just list choices, no quality judgment yet
    let decHtml = '<h4>Your 2025 Decisions</h4>';
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const choice = STATE.designChoices[elId];
        const opt = el.stage1.options.find(o => o.id === choice);
        decHtml += `
            <div class="decision-row">
                <span class="decision-element">${el.title}</span>
                <span style="color: var(--white);">${opt.name}</span>
            </div>
        `;
    });
    document.getElementById('sumDecisions').innerHTML = decHtml;
    
    document.getElementById('btnNextPhase').textContent = STATE.stage === 5 ? 'View Final Results ‚Üí' : 'Next Stage ‚Üí';
    document.getElementById('summaryScreen').classList.add('active');
}

document.getElementById('btnNextPhase').onclick = () => {
    document.getElementById('summaryScreen').classList.remove('active');
    if (STATE.stage >= 5) showFinalResults();
    else showTransition();
};

function showTransition() {
    const nextStage = STATE.stage + 1;
    const trans = GAME_DATA.transitions[nextStage];
    
    document.getElementById('transYears').textContent = trans.years;
    document.getElementById('transYear').textContent = trans.year;
    document.getElementById('transText').innerHTML = trans.text.map(t => `<p>${t}</p>`).join('');
    
    document.getElementById('transitionScreen').classList.add('active');
}

document.getElementById('btnTransContinue').onclick = () => {
    document.getElementById('transitionScreen').classList.remove('active');
    startStage(STATE.stage + 1);
};

function showFinalResults() {
    let good = 0;
    let lessonsHtml = '';
    
    Object.keys(GAME_DATA.elements).forEach(elId => {
        const el = GAME_DATA.elements[elId];
        const opt = el.stage1.options.find(o => o.id === STATE.designChoices[elId]);
        if (opt.quality === 'good') good++;
        
        // Build lessons learned
        let lessonClass = opt.quality === 'good' ? 'good' : (opt.quality === 'wasteful' ? 'ok' : 'poor');
        let lessonText = '';
        if (opt.quality === 'good') lessonText = 'Good choice - minimised lifecycle costs';
        else if (opt.quality === 'wasteful') lessonText = 'Over-specified - unnecessary expense';
        else lessonText = 'Poor choice - caused problems throughout';
        
        lessonsHtml += `
            <div class="decision-row">
                <span class="decision-element">${el.title}: ${opt.name}</span>
                <span class="decision-tag ${lessonClass}">${lessonText}</span>
            </div>
        `;
    });
    
    let grade, verdict;
    if (good >= 5 && STATE.plantHealth >= 80 && STATE.totals.dose < 30) {
        grade = 'A'; verdict = 'Master Designer - Your choices made life easier for everyone';
    } else if (good >= 4 && STATE.plantHealth >= 60) {
        grade = 'B'; verdict = 'Competent Engineer - Mostly good decisions';
    } else if (good >= 2 && STATE.plantHealth >= 40) {
        grade = 'C'; verdict = 'Needs Improvement - Several choices caused problems';
    } else {
        grade = 'D'; verdict = 'Lessons Learned - Your design created decades of difficulties';
    }
    
    document.getElementById('resGrade').textContent = grade;
    document.getElementById('resGrade').className = `results-grade ${grade}`;
    document.getElementById('resVerdict').textContent = verdict;
    
    document.getElementById('resTotals').innerHTML = `
        <div class="results-total"><div class="results-total-value">${formatMoney(STATE.totals.cost)}</div><div class="results-total-label">Total Cost</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.totals.dose.toFixed(1)} mSv</div><div class="results-total-label">Total Dose</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.totals.time} days</div><div class="results-total-label">Total Time</div></div>
        <div class="results-total"><div class="results-total-value">${STATE.plantHealth}%</div><div class="results-total-label">Plant Health</div></div>
    `;
    
    // Add lessons learned section
    const lessonsSection = document.createElement('div');
    lessonsSection.className = 'summary-decisions';
    lessonsSection.innerHTML = '<h4>Lessons Learned</h4>' + lessonsHtml;
    document.getElementById('resTotals').after(lessonsSection);
    
    document.getElementById('resultsScreen').classList.add('active');
}
</script>
</body>
</html>
